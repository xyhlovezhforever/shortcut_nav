# 02 - 核心架构设计

> **文档版本**: v1.1
> **创建日期**: 2026-01-05
> **最后更新**: 2026-01-14
> **迁移优先级**: ⭐⭐⭐⭐⭐ (最高)

---

## 版本更新说明

### v1.1 (2026-01-14)
- **智能轮数管理**: 移除硬编码轮数限制，改为LLM智能决策
- **Plan-with-Files模式**: 执行历史作为单一真理来源的新模式
- **动态参数推断**: LLM运行时参数生成能力
- **新增模块**: 任务后评估器、继续规划器、单步修复
- **LLM模块扩展**: 提示词模块从7个扩展至12个
- 更新核心执行循环图，移除轮次限制说明

---

## 1. Reflective Planning 架构概述

### 1.1 核心理念

本项目基于 **Reflective Planning** (反思式规划) 架构设计，核心特点是：

1. **Plan (规划)**: 基于LLM生成执行计划
2. **Execute (执行)**: 调用工具服务执行步骤
3. **Evaluate (评估)**: 评估执行结果质量
4. **Reflect (反思)**: 失败时分析原因并提供改进建议
5. **Replan (重规划)**: 基于反思结果生成新计划
6. **智能迭代** ⭐ v1.1: 由LLM决定是否继续尝试，移除硬编码轮数限制

### 1.2 核心流程图

```
                            ┌─────────────────────────────────────┐
                            │           用户任务请求                │
                            └──────────────┬──────────────────────┘
                                           │
                                           ▼
                            ┌─────────────────────────────────────┐
                            │     Orchestrator (编排器)            │
                            │     - 协调各模块                     │
                            │     - 管理任务生命周期               │
                            └──────────────┬──────────────────────┘
                                           │
              ┌────────────────────────────┼────────────────────────────┐
              │                            │                            │
              ▼                            ▼                            ▼
    ┌─────────────────┐          ┌─────────────────┐          ┌─────────────────┐
    │    Planner      │          │    Executor     │          │   Evaluator     │
    │    (规划器)      │          │    (执行器)      │          │   (评估器)      │
    │                 │          │                 │          │                 │
    │ - 工具筛选      │          │ - 参数解析       │          │ - 结果评分      │
    │ - 任务分解      │          │ - 工具调用       │          │ - 成功判定      │
    │ - 计划生成      │          │ - 并行执行       │          │ - 需要反思?     │
    └─────────────────┘          └─────────────────┘          └─────────────────┘
              │                            │                            │
              │                            ▼                            │
              │                  ┌─────────────────┐                    │
              │                  │ Parameter       │                    │
              │                  │ Resolver        │                    │
              │                  │ (参数解析器)     │                    │
              │                  └─────────────────┘                    │
              │                                                         │
              │              ┌──────────────────────────────────────────┘
              │              │
              │              ▼  (如果评估失败)
              │    ┌─────────────────┐
              │    │   Reflector     │
              │    │   (反思器)       │
              │    │                 │
              │    │ - 失败分析       │
              │    │ - 改进建议       │
              │    │ - 决定动作       │
              │    └────────┬────────┘
              │             │
              └─────────────┘
                  (重新规划)
```

### 1.3 执行循环

```
┌──────────────────────────────────────────────────────────────────────┐
│                        Reflective Planning 循环                        │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│    ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     │
│    │  Plan   │ ──► │ Execute │ ──► │Evaluate │ ──► │ Reflect │     │
│    │  规划   │     │  执行   │     │  评估   │     │  反思   │     │
│    └─────────┘     └─────────┘     └─────────┘     └────┬────┘     │
│         ▲                                              │          │
│         │              ┌──────────────────┬───────────┘          │
│         │              │                  │                       │
│         │              ▼                  ▼                       │
│         │        ┌──────────┐      ┌──────────┐                  │
│         │        │  成功    │      │  失败    │                  │
│         │        │ 返回结果 │      │ 需重规划 │                  │
│         │        └──────────┘      └────┬─────┘                  │
│         │                               │                         │
│         └───────────────────────────────┘                         │
│              (由LLM智能决定是否继续 ⭐ v1.1)                        │
│              (统计数据：current_round, total_retries, replans)      │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

**v1.1 更新说明**:
- ❌ 移除: 硬编码的轮数限制（`max_rounds`, `max_step_retries`, `max_task_replanning_attempts`）
- ✅ 新增: LLM通过提示词中的软性指导决定是否继续
- ✅ 新增: 执行统计数据（`current_round`, `total_step_retries`, `total_task_replans`）作为决策参考
- 详见: [18-移除轮数限制机制.md](./18-移除轮数限制机制.md)

---

## 2. 核心模块依赖关系

### 2.1 模块依赖图

```
┌─────────────────────────────────────────────────────────────┐
│                     main.rs / main_grpc.rs                   │
│                    (服务入口，初始化所有组件)                    │
└────────────────┬────────────────────────────────────────────┘
                 │
      ┌──────────┴──────────┐
      ▼                     ▼
┌──────────┐          ┌──────────┐
│   API    │          │   gRPC   │
│ (HTTP)   │          │ (Server) │
└────┬─────┘          └────┬─────┘
     │                     │
     └──────────┬──────────┘
                ▼
      ┌─────────────────┐
      │  Orchestrator   │ ← State Manager
      │   (编排核心)     │ ← Kafka Logger
      └────┬────────────┘
           │
    ┌──────┴──────┬──────────┬──────────┐
    ▼             ▼          ▼          ▼
┌─────────┐  ┌─────────┐ ┌──────────┐ ┌──────────┐
│ Planner │  │Executor │ │Evaluator │ │Reflector │
└────┬────┘  └────┬────┘ └────┬─────┘ └────┬─────┘
     │            │           │             │
     ▼            ▼           ▼             ▼
┌──────────────────────────────────────────────┐
│             LLM Unified Client                │
│      (HTTP / gRPC / With Discovery)          │
└──────────────────────────────────────────────┘

Executor 内部依赖:
    ├─► Tool Unified Client
    ├─► Parameter Resolver
    │   └─► Execution Context
    └─► Parallel Executor

Planner 内部依赖:
    ├─► LLM Unified Client
    ├─► Tool Unified Client (获取工具列表)
    ├─► Workflow Manager (标准流程匹配)
    └─► Scene Guidance (场景指导)
```

### 2.2 模块职责说明 (v1.1 更新)

| 模块 | 文件 | 核心职责 | 版本 |
|------|------|---------|------|
| **Orchestrator** | `core/orchestrator.rs` | 协调整个执行流程，管理任务状态 | v1.0 |
| **Planner** | `core/planner.rs` | 调用LLM生成执行计划 | v1.0 |
| **Executor** | `core/executor.rs` | 执行计划步骤，调用工具，支持动态参数推断 | v1.0 / v1.1 |
| **Evaluator** | `core/evaluator.rs` | 评估执行结果 | v1.0 |
| **Reflector** | `core/reflector.rs` | 分析失败原因，提供改进建议，支持单步修复决策 | v1.0 / v1.1 |
| **ParameterResolver** | `core/parameter_resolver.rs` | 解析步骤参数，处理占位符 | v1.0 |
| **ExecutionContext** | `core/execution_context.rs` | 维护执行上下文，存储中间结果 | v1.0 |
| **ParallelExecutor** | `core/parallel_executor.rs` | 基于DAG并行执行步骤 | v1.0 |
| **PostTaskEvaluator** ⭐ | `core/post_task_evaluator.rs` | 任务完成后的经验提炼与评估 | v1.1 新增 |
| **ContinuePlanner** ⭐ | `core/continue_planner.rs` | 中断后继续规划 | v1.1 新增 |
| **ContextEngineeringEventBuilder** ⭐ | `context_engineering/event_builder.rs` | Plan-with-Files模式的核心，管理执行历史 | v1.1 新增 |

---

## 3. 两阶段规划架构

### 3.1 设计背景

当工具数量较多时（如50个工具），单阶段规划存在问题：
- Token消耗大（每次传递所有工具详情）
- LLM处理混乱（同时处理工具选择和任务分解）

### 3.2 两阶段流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                        两阶段规划架构                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  用户任务 ──► [工具数量 >= 阈值?]                                    │
│                    │                                                │
│          ┌────────┴────────┐                                       │
│          │ YES             │ NO                                    │
│          ▼                 ▼                                       │
│  ┌───────────────┐  ┌───────────────┐                              │
│  │ 两阶段规划    │  │ 单阶段规划    │                              │
│  └───────┬───────┘  └───────────────┘                              │
│          │                                                          │
│          ▼                                                          │
│  ┌─────────────────────────────────────────┐                       │
│  │ 阶段1: 工具筛选                          │                       │
│  │ - 简化工具信息 (ID + 名称 + 简介)        │                       │
│  │ - LLM筛选相关工具 + 识别任务类型         │                       │
│  │ - Token消耗: 工具数 × 50                │                       │
│  └─────────────────┬───────────────────────┘                       │
│                    │                                                │
│                    ▼                                                │
│  ┌─────────────────────────────────────────┐                       │
│  │ 流程匹配 (可选)                          │                       │
│  │ - 根据任务类型匹配标准流程               │                       │
│  │ - 提供流程提示给阶段2                    │                       │
│  └─────────────────┬───────────────────────┘                       │
│                    │                                                │
│                    ▼                                                │
│  ┌─────────────────────────────────────────┐                       │
│  │ 阶段2: 任务分解                          │                       │
│  │ - 详细工具信息 (完整参数定义)            │                       │
│  │ - LLM生成执行计划                        │                       │
│  │ - Token消耗: 筛选后工具数 × 500         │                       │
│  └─────────────────────────────────────────┘                       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 Token优化效果

| 场景 | 工具数 | 单阶段Token | 两阶段Token | 节省率 |
|------|--------|------------|------------|--------|
| 小型 | 10 | 5,000 | 5,000 | 0% |
| 中型 | 30 | 15,000 | 7,000 | **53%** |
| 大型 | 50 | 25,000 | 8,500 | **66%** |
| 超大 | 100 | 50,000 | 12,000 | **76%** |

---

## 4. 语义路由机制

### 4.1 设计目标

根据任务描述自动选择合适的场景，为不同场景注入不同的提示词指导。

### 4.2 路由流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                        语义路由流程                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  用户任务: "意图: 工具管理, 用户输入: 创建计算器工具"                │
│                    │                                                │
│                    ▼                                                │
│  ┌─────────────────────────────────────────┐                       │
│  │ 1. 意图提取                              │                       │
│  │    - 识别 "意图:" 标记                   │                       │
│  │    - 提取: "工具管理"                    │                       │
│  └─────────────────┬───────────────────────┘                       │
│                    │                                                │
│                    ▼                                                │
│  ┌─────────────────────────────────────────┐                       │
│  │ 2. 场景匹配 (SceneManager)               │                       │
│  │    - 精确匹配别名                        │                       │
│  │    - 模糊匹配关键词                      │                       │
│  │    - 默认返回 General                    │                       │
│  └─────────────────┬───────────────────────┘                       │
│                    │                                                │
│                    ▼                                                │
│  ┌─────────────────────────────────────────┐                       │
│  │ 3. 获取场景指导                          │                       │
│  │    - selection_guidance (筛选)           │                       │
│  │    - planning_guidance (规划)            │                       │
│  │    - evaluation_guidance (评估)          │                       │
│  │    - reflection_guidance (反思)          │                       │
│  │    - replanning_guidance (重规划)        │                       │
│  │    - message_guidance (消息)             │                       │
│  └─────────────────┬───────────────────────┘                       │
│                    │                                                │
│                    ▼                                                │
│  ┌─────────────────────────────────────────┐                       │
│  │ 4. 注入提示词                            │                       │
│  │    - 替换 {scene_guidance} 占位符        │                       │
│  │    - 场景专属规则优先级最高              │                       │
│  └─────────────────────────────────────────┘                       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.3 支持的场景类型

| 场景类型 | 中文名称 | 典型别名 |
|---------|---------|---------|
| `NaturalLanguageModeling` | 自然语言建模 | 自动建模、modeling、仿真 |
| `ToolManagement` | 工具管理 | 代码生成、工具、tool_management |
| `PlcController` | PLC控制器 | plc、控制器、controller |
| `ClientManagement` | 客户端管理 | 客户端操作、角色、role |
| `General` | 通用 | general、default |

---

## 5. 分层容错机制

### 5.1 三层恢复策略

```
┌─────────────────────────────────────────────────────────────────────┐
│                        分层容错机制                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  步骤执行失败                                                        │
│       │                                                             │
│       ▼                                                             │
│  ┌─────────────────────────────────────────┐                       │
│  │ 第1层: 步骤级重试                        │                       │
│  │ - 调整参数重试 (RetryWithAdjustedParams) │                       │
│  │ - 备选工具重试 (RetryWithAlternativeTool)│                       │
│  │ - 重试次数上限: 3次                      │                       │
│  └─────────────────┬───────────────────────┘                       │
│                    │ 重试失败                                       │
│                    ▼                                                │
│  ┌─────────────────────────────────────────┐                       │
│  │ 第2层: 单步修复                          │                       │
│  │ - 重新规划失败的单个步骤                 │                       │
│  │ - 保持其他步骤不变                       │                       │
│  │ - 修复次数上限: 1次                      │                       │
│  └─────────────────┬───────────────────────┘                       │
│                    │ 修复失败                                       │
│                    ▼                                                │
│  ┌─────────────────────────────────────────┐                       │
│  │ 第3层: 任务级重规划                      │                       │
│  │ - 重新规划整个任务                       │                       │
│  │ - 生成全新执行计划                       │                       │
│  │ - 重规划次数上限: 1次                    │                       │
│  └─────────────────┬───────────────────────┘                       │
│                    │ 重规划失败                                      │
│                    ▼                                                │
│  ┌─────────────────────────────────────────┐                       │
│  │ 任务失败                                 │                       │
│  │ - 返回失败结果和原因                     │                       │
│  └─────────────────────────────────────────┘                       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 失败计数器

| 计数器 | 作用 | 默认上限 | 配置项 |
|--------|------|---------|--------|
| `step_retry_count` | 当前步骤重试次数 | 3 | `max_step_retries` |
| `single_step_repair_count` | 单步修复次数 | 1 | `max_single_step_repairs` |
| `task_replan_count` | 任务重规划次数 | 1 | `max_task_replanning_attempts` |
| `consecutive_failures` | 连续失败次数 | 3 | - |

---

## 6. 数据流架构

### 6.1 三层数据存储

```
┌─────────────────────────────────────────────────────────────────────┐
│                     ExecutionContext (执行上下文)                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────────────────────┐             │
│  │ 1. initial_metadata (初始元数据)                   │             │
│  │    - 任务提交时的全局数据                          │             │
│  │    - 只读，不修改                                  │             │
│  │    - 示例: project_id, file_path, city_name       │             │
│  └───────────────────────────────────────────────────┘             │
│                                                                     │
│  ┌───────────────────────────────────────────────────┐             │
│  │ 2. runtime_metadata (运行时元数据)                 │             │
│  │    - 动态流转的关键参数                            │             │
│  │    - 从步骤输出中提取                              │             │
│  │    - 示例: datasource_id, model_id                │             │
│  └───────────────────────────────────────────────────┘             │
│                                                                     │
│  ┌───────────────────────────────────────────────────┐             │
│  │ 3. step_results (步骤执行结果)                     │             │
│  │    - 完整保留每个步骤的输出                        │             │
│  │    - 键: step_id, 值: StepExecutionResult         │             │
│  └───────────────────────────────────────────────────┘             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

数据流转优先级: runtime_metadata > initial_metadata > step_results
```

### 6.2 参数解析流程

```
步骤参数定义: {"datasource": "{{step_2.outputs.datasource_id}}"}
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│ ParameterResolver::resolve_parameters()                             │
│                                                                     │
│ 1. 解析JSON参数                                                      │
│ 2. 识别占位符:                                                       │
│    - {{{step_id.outputs.field}}} (三重大括号)                        │
│    - {{step_id.outputs.field}} (双大括号)                            │
│    - ${step_id.output.field} (模板格式)                              │
│ 3. 从 ExecutionContext 提取实际值                                    │
│ 4. 替换占位符为实际值                                                │
└─────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
解析后参数: {"datasource": "ds_001"}
```

---

## 7. 核心数据结构

### 7.1 执行计划 (ExecutionPlan)

```rust
pub struct ExecutionPlan {
    pub plan_id: String,           // 计划唯一ID
    pub plan_description: String,  // 计划描述
    pub steps: Vec<PlanStep>,      // 执行步骤列表
    pub expected_duration_sec: Option<u64>, // 预计耗时
}
```

### 7.2 计划步骤 (PlanStep)

```rust
pub struct PlanStep {
    pub step_id: String,           // 步骤ID (如 "step_1")
    pub step_name: String,         // 步骤名称
    pub tool: String,              // 工具ID
    pub parameters: String,        // 参数JSON字符串
    pub depends_on: Vec<String>,   // 依赖的步骤ID列表
}
```

### 7.3 步骤执行结果 (StepExecutionResult)

```rust
pub struct StepExecutionResult {
    pub step_id: String,
    pub step_name: String,
    pub tool_id: String,
    pub output: String,            // 工具返回的输出
    pub is_success: bool,
    pub error_message: Option<String>,
    pub duration_ms: u64,
}
```

### 7.4 任务状态 (TaskStatus)

```rust
pub enum TaskStatus {
    Pending,      // 等待中
    Planning,     // 规划中
    Executing,    // 执行中
    Evaluating,   // 评估中
    Reflecting,   // 反思中
    Completed,    // 已完成
    Failed,       // 失败
}
```

---

## 8. 模块实现优先级

### 8.1 迁移顺序建议

```
阶段1: 基础设施 (必须先完成)
├── config/mod.rs           # 配置加载
├── utils/errors.rs         # 错误定义
├── utils/debug_logger.rs   # 调试日志
└── state/task_state.rs     # 状态管理

阶段2: 数据流核心 (依赖阶段1)
├── core/execution_context.rs  # 执行上下文
└── core/parameter_resolver.rs # 参数解析器

阶段3: 客户端模块 (依赖阶段1)
├── llm/traits.rs           # LLM trait
├── llm/client.rs           # LLM HTTP客户端
├── llm/unified_client.rs   # 统一客户端
├── tool/client.rs          # 工具HTTP客户端
└── tool/unified_client.rs  # 统一客户端

阶段4: 提示词系统 (依赖阶段3)
├── llm/scene_guidance.rs      # 场景管理
├── llm/planning_prompts.rs    # 规划提示词
├── llm/selection_prompts.rs   # 筛选提示词
├── llm/evaluation_prompts.rs  # 评估提示词
├── llm/reflection_prompts.rs  # 反思提示词
└── llm/replanning_prompts.rs  # 重规划提示词

阶段5: 核心业务 (依赖阶段2-4)
├── core/executor.rs        # 执行器
├── core/planner.rs         # 规划器
├── core/evaluator.rs       # 评估器
├── core/reflector.rs       # 反思器
├── core/parallel_executor.rs # 并行执行器
└── core/orchestrator.rs    # 编排器 (最后)

阶段6: 服务接口 (依赖阶段5)
├── api/handlers.rs         # REST API
├── grpc/server.rs          # gRPC服务
├── main.rs                 # HTTP入口
└── main_grpc.rs            # gRPC入口
```

---

## 9. 关键设计原则

### 9.1 职责单一
- 每个模块只做一件事
- Planner只负责规划，Executor只负责执行

### 9.2 依赖注入
- 通过构造函数注入依赖
- 使用Arc共享状态
- 便于测试和替换实现

### 9.3 异步优先
- 所有IO操作使用async/await
- 利用Tokio运行时并发执行

### 9.4 错误传播
- 使用Result类型传播错误
- 定义完整的错误类型层次
- 提供有意义的错误信息

### 9.5 可观测性
- 结构化日志 (tracing)
- 详细的执行追踪
- 支持审计日志

---

## 下一步

### 推荐阅读顺序

1. **核心模块实现**: [03-核心模块实现详解.md](./03-核心模块实现详解.md) - 各核心模块的详细实现
2. **LLM交互系统**: [05-LLM交互与提示词系统.md](./05-LLM交互与提示词系统.md) - 12个提示词模块详解
3. **容错恢复机制**: [06-反思与重规划机制.md](./06-反思与重规划机制.md) - 反思与重规划详解

### v1.1 新特性文档

- [17-Plan-with-Files模式.md](./17-Plan-with-Files模式.md) - 执行历史作为单一真理来源
- [18-移除轮数限制机制.md](./18-移除轮数限制机制.md) - 智能轮数管理详解
- [19-动态参数推断功能.md](./19-动态参数推断功能.md) - LLM运行时参数生成
