//! ç”¨æˆ·å‹å¥½æ¶ˆæ¯æ¨¡æ¿æ¨¡å—
//!
//! åŒ…å«ç”¨äºç”Ÿæˆç”¨æˆ·å‹å¥½çš„è¿›åº¦æ¶ˆæ¯å’ŒçŠ¶æ€æ›´æ–°çš„æ¨¡æ¿
//!
//! # åŠŸèƒ½ç‰¹æ€§
//!
//! - è¾“å‡ºé£æ ¼è½¬æ¢ï¼ˆæŠ€æœ¯æ€§ â†’ ç”¨æˆ·å‹å¥½ï¼‰
//! - å„é˜¶æ®µè¿›åº¦æ¶ˆæ¯æ¨¡æ¿
//! - æ¶ˆæ¯æ¶¦è‰²åŠŸèƒ½
//! - æ”¯æŒå¤šæ ·åŒ–è¡¨è¾¾
//! - æ”¯æŒåœºæ™¯æ„ŸçŸ¥çš„æ¶ˆæ¯ç”Ÿæˆ

use super::scene_guidance::SceneManager;

/// è¾“å‡ºé£æ ¼æ¨¡æ¿ - ç”¨äºï¿½ï¿½æŠ€æœ¯æ€§å†…å®¹è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„å™äº‹é£æ ¼
pub const OUTPUT_STYLE_TEMPLATE: &str = r#"
è¯·å°†ä»¥ä¸‹å†…å®¹è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„å™äº‹é£æ ¼ï¼š

{content}

è¦æ±‚ï¼š
1. **å®Œæ•´ä¿ç•™æ‰€æœ‰ä¿¡æ¯**ï¼š
   - æ ¼å¼æ ‡è®°ï¼ˆå¦‚ã€Œã€åŒ…è£¹çš„åç§°ï¼‰å¿…é¡»ä¿ç•™
   - æ‰€æœ‰æ•°å­—æ•°æ®ï¼ˆè¯„ä¼°å¾—åˆ†ã€ç»Ÿè®¡ã€ç™¾åˆ†æ¯”ã€IDã€æ—¶é—´ç­‰ï¼‰ä¸€ä¸ªä¸èƒ½å°‘
   - æ‰€æœ‰å…³é”®å­—æ®µï¼ˆå¦‚report_idã€titleã€summaryã€highlightsã€file_urlç­‰ï¼‰éƒ½è¦ä½“ç°
   - åŸæ–‡æœ‰å‡ ä¸ªä¿¡æ¯ç‚¹ï¼Œè½¬æ¢åå¿…é¡»ä¹Ÿæœ‰å‡ ä¸ªä¿¡æ¯ç‚¹

2. **æ ¼å¼è¦æ±‚ - ä¸°å¯Œçš„Markdownæ ¼å¼**ï¼š
   - **ä¸»æ ‡é¢˜**ï¼šç”¨ ## å¼€å¤´ï¼Œemoji + ç®€çŸ­çŠ¶æ€ï¼Œä¸è¶…è¿‡20å­—
   - **ç« èŠ‚æ ‡é¢˜**ï¼šç”¨ ## å¼€å¤´ï¼ˆäºŒçº§æ ‡é¢˜ï¼‰ï¼Œå¿…é¡»ç”±AIæ ¹æ®å†…å®¹åŠ¨æ€ç”Ÿæˆï¼Œç¦æ­¢ç¡¬ç¼–ç å›ºå®šæ ‡é¢˜
   - **ç« èŠ‚æ•°é‡**ï¼šä¿¡æ¯å¤šæ—¶2-4ä¸ªï¼Œä¿¡æ¯å°‘æ—¶1-2ä¸ª
   - **å†…å®¹å‘ˆç°æ–¹å¼**ï¼šæ ¹æ®å†…å®¹ç±»å‹æ™ºèƒ½é€‰æ‹©
     * **ç»“æ„åŒ–æ•°æ®** â†’ ä¼˜å…ˆä½¿ç”¨è¡¨æ ¼ï¼ˆå‚æ•°ã€ç»Ÿè®¡ã€é…ç½®ç­‰ï¼‰
     * **å¤šé¡¹å†…å®¹** â†’ ä½¿ç”¨åˆ—è¡¨ï¼ˆæ–‡ä»¶åˆ—è¡¨ã€æˆæœåˆ—è¡¨ç­‰ï¼‰
     * **ç®€æ´æè¿°** â†’ ä½¿ç”¨ç®€çŸ­æ–‡æœ¬ï¼ˆ1-2å¥è¯è¯´æ˜ï¼‰
     * **ç¦æ­¢æ®µè½å™è¿°** - ä¸è¦å†™æˆæ®µè½æ–‡ç« 
   - **åˆ†éš”çº¿**ï¼šç« èŠ‚ä¹‹é—´å¯ä»¥ç”¨ `---` åˆ†éš”çº¿å¢å¼ºè§†è§‰æ•ˆæœ
   - **ç©ºè¡Œåˆ†éš”**ï¼šä¸»æ ‡é¢˜åç©ºè¡Œï¼Œè¡¨æ ¼/åˆ—è¡¨å‰åè¦æœ‰ç©ºè¡Œ
   - **ä¸¥æ ¼ç¦æ­¢è¾“å‡º**ï¼š
     * ç¦æ­¢ç”Ÿæˆ"æ­£åœ¨æ€è€ƒ"ã€"è¯·ç¨å€™"ã€"æ­£åœ¨å‡†å¤‡ä¸­"ã€"å¾ˆå¿«å°±èƒ½å¼€å§‹å•¦"ç­‰ä»»ä½•ç­‰å¾…æç¤ºæ–‡å­—
     * ç¦æ­¢å°†è¿™ç±»æç¤ºä½œä¸ºç« èŠ‚æ ‡é¢˜æˆ–ä¸»æ ‡é¢˜
     * åªè¾“å‡ºå®é™…çš„ç»“æœå†…å®¹ï¼Œä¸è¦è¾“å‡ºæ€è€ƒè¿‡ç¨‹
     * **ç¦æ­¢æ»¥ç”¨åˆ—è¡¨** - ä¸è¦æŠŠæ‰€æœ‰å†…å®¹éƒ½å¼ºè¡Œå¡è¿›åˆ—è¡¨ï¼Œç®€å•çš„è¯´æ˜ç”¨ç®€çŸ­æ–‡æœ¬å³å¯

3. **è¡¨æ ¼ vs åˆ—è¡¨ - æ™ºèƒ½é€‰æ‹©**ï¼š

   **âœ… ä½¿ç”¨è¡¨æ ¼çš„åœºæ™¯**ï¼š
   - ç»“æ„åŒ–çš„é”®å€¼å¯¹æ•°æ®ï¼ˆå¦‚é…ç½®ä¿¡æ¯ã€æŠ€æœ¯å‚æ•°ï¼‰
   - ç»Ÿè®¡æ•°æ®ã€æŒ‡æ ‡æ•°æ®ï¼ˆå¦‚é‡‡é›†ç‚¹æ•°ã€è¦†ç›–ç‡ã€è€—æ—¶ç­‰ï¼‰
   - æ–‡ä»¶å±æ€§ä¿¡æ¯ï¼ˆæ–‡ä»¶åã€æ ¼å¼ã€å¤§å°ã€è·¯å¾„ï¼‰
   - å¯¹æ¯”æ€§æ•°æ®ï¼ˆå¤šä¸ªç»´åº¦çš„å¯¹æ¯”ï¼‰
   - æ•°æ®é‡ â‰¥ 3ä¸ªå­—æ®µæ—¶

   **ç¤ºä¾‹**ï¼ˆé€‚åˆç”¨è¡¨æ ¼ï¼‰ï¼š
   ```
   | æŒ‡æ ‡ | æ•°å€¼ |
   |------|------|
   | é‡‡é›†ç‚¹æ•° | 456ä¸ª |
   | è¦†ç›–èŒƒå›´ | å…¨æ¥¼18å±‚ |
   | æ•°æ®å®Œæ•´æ€§ | 98% |
   | é‡‡é›†è€—æ—¶ | 2.3ç§’ |
   ```

   **âœ… ä½¿ç”¨åˆ—è¡¨çš„åœºæ™¯**ï¼š
   - è¦ç‚¹æ€»ç»“ã€å…³é”®ä¿¡æ¯ç½—åˆ—
   - æ­¥éª¤è¯´æ˜ã€æ“ä½œæµç¨‹
   - æˆæœæè¿°ï¼ˆå¸¦æœ‰è§£é‡Šè¯´æ˜çš„å†…å®¹ï¼‰
   - ä¸‹ä¸€æ­¥è®¡åˆ’ã€å¾…åŠäº‹é¡¹
   - é”™è¯¯æè¿°ã€å¤„ç†æ–¹æ¡ˆ
   - å†…å®¹éœ€è¦è¯¦ç»†æè¿°æ—¶ï¼ˆä¸æ˜¯ç®€å•çš„é”®å€¼å¯¹ï¼‰

   **ç¤ºä¾‹**ï¼ˆé€‚åˆç”¨åˆ—è¡¨ï¼‰ï¼š
   ```
   - å»ºç­‘æ¨¡å‹: 18å±‚å†™å­—æ¥¼ï¼ŒåŒ…å«1,250ä¸ªæˆ¿é—´
   - è®¾å¤‡èŠ‚ç‚¹: 125ä¸ªè®¾å¤‡ï¼Œå»ºç«‹äº†340æ¡è¿æ¥å…³ç³»
   - ä¸‹è½½é“¾æ¥: [building.ifc](/path/to/file)
   ```

4. **æ··åˆä½¿ç”¨åŸåˆ™**ï¼š
   - **ä¸€ä¸ªç« èŠ‚å†…ç»Ÿä¸€æ ¼å¼**ï¼šåŒä¸€ä¸ª ## ç« èŠ‚ä¸‹åªç”¨ä¸€ç§æ ¼å¼ï¼ˆè¦ä¹ˆè¡¨æ ¼ï¼Œè¦ä¹ˆåˆ—è¡¨ï¼‰
   - **ä¸åŒç« èŠ‚å¯ä»¥ä¸åŒ**ï¼šç¬¬ä¸€ä¸ªç« èŠ‚ç”¨è¡¨æ ¼ï¼Œç¬¬äºŒä¸ªç« èŠ‚ç”¨åˆ—è¡¨
   - **æ ¹æ®å†…å®¹æ€§è´¨å†³å®š**ï¼šæ•°æ®å‹ç”¨è¡¨æ ¼ï¼Œæè¿°å‹ç”¨åˆ—è¡¨
   - ç¦æ­¢ä½¿ç”¨"åˆšåˆš"ã€"å·²ç»"ã€"æ­£åœ¨å‡†å¤‡ä¸­"ã€"è¯·ç¨å€™"ç­‰å™è¿°æ€§è¿æ¥è¯

5. **å…¶ä»–Markdownå…ƒç´ **ï¼š
   - **åˆ†å‰²çº¿**ï¼šç« èŠ‚ä¹‹é—´ç”¨ `---` åˆ†éš”ï¼Œå¢å¼ºå±‚æ¬¡æ„Ÿ
   - **è¶…é“¾æ¥**ï¼šå¦‚æœ‰æ–‡ä»¶è·¯å¾„æˆ–URLï¼Œä½¿ç”¨ `[æ–‡ä»¶å](è·¯å¾„)` æ ¼å¼
   - **ç²—ä½“å¼ºè°ƒ**ï¼šé‡è¦å­—æ®µç”¨ `**ç²—ä½“**` æ ‡è®°
   - **ä»£ç æ ‡è®°**ï¼šæŠ€æœ¯æœ¯è¯­å¯ç”¨ `` `code` `` åŒ…è£¹

6. **è¯­æ°”è¦æ±‚**ï¼š
   - å†…å®¹è¦ç®€æ´ä¸“ä¸šï¼Œä¸è¦è¿‡äºå£è¯­åŒ–
   - é¿å…"åˆšåˆš"ã€"å·²ç»"ç­‰æ—¶é—´æ€§è¯æ±‡
   - æŠ€æœ¯æœ¯è¯­å¯ä»¥ä¿ç•™ï¼Œä½†åŠ ä¸Šç®€è¦è¯´æ˜

7. **ä¿¡æ¯å¤„ç†**ï¼š
   - å¦‚æœåŸæ–‡è¯´æŸå­—æ®µä¸ºç©ºï¼Œå†™æˆ"æš‚æœªå¡«å……"ã€"å¾…è¡¥å……"ç­‰
   - æ ¹æ®å†…å®¹æ€§è´¨é€‰æ‹©è¡¨æ ¼æˆ–åˆ—è¡¨
   - æ‰€æœ‰IDã€æ•°å­—ã€æ—¶é—´éƒ½è¦**å®Œæ•´å±•ç¤º**ï¼Œç»å¯¹ç¦æ­¢çœç•¥æˆ–ç¼©å†™
   - **ç¦æ­¢ä½¿ç”¨çœç•¥å·**ï¼šå¦‚ `2d4eff6e...` æ˜¯é”™è¯¯çš„ï¼Œå¿…é¡»å®Œæ•´æ˜¾ç¤ºä¸º `2d4eff6e-f4ca-4dc6-b776-1d838b8cefb5`
   - **ç¦æ­¢æˆªæ–­ä»»ä½•å­—æ®µ**ï¼šUUIDã€è·¯å¾„ã€URLç­‰å¿…é¡»å®Œæ•´æ˜¾ç¤º

8. **æ ¼å¼å¤šæ ·åŒ–è¦æ±‚**ï¼š
âš ï¸ **é‡è¦**: æ™ºèƒ½é€‰æ‹©æ ¼å¼ï¼Œè¡¨æ ¼å’Œåˆ—è¡¨æ··åˆä½¿ç”¨ï¼

**æ ¼å¼é€‰æ‹©å†³ç­–æ ‘**ï¼š
1. çœ‹æ•°æ®æ€§è´¨ï¼šæ˜¯é”®å€¼å¯¹? â†’ ç”¨è¡¨æ ¼
2. çœ‹å†…å®¹å¤æ‚åº¦ï¼šéœ€è¦è¯¦ç»†æè¿°? â†’ ç”¨åˆ—è¡¨
3. çœ‹æ•°æ®é‡ï¼šâ‰¥3ä¸ªå­—æ®µ? â†’ ç”¨è¡¨æ ¼
4. çœ‹è¡¨è¾¾éœ€æ±‚ï¼šéœ€è¦å¯¹æ¯”? â†’ ç”¨è¡¨æ ¼
5. çœ‹å†…å®¹ç±»å‹ï¼šæ­¥éª¤/æˆæœ/æ–¹æ¡ˆ? â†’ ç”¨åˆ—è¡¨

**ç« èŠ‚æ ‡é¢˜è¦çµæ´»å˜åŒ–**ï¼ˆæ ¹æ®å†…å®¹é€‰æ‹©åˆé€‚çš„æ ‡é¢˜ï¼‰ï¼š
- æ ¸å¿ƒæˆæœ / æ‰§è¡Œç»“æœ / å®Œæˆæƒ…å†µ / ä¸»è¦å†…å®¹
- è¯¦ç»†ä¿¡æ¯ / å…·ä½“æ•°æ® / å…³é”®æŒ‡æ ‡ / æŠ€æœ¯ç»†èŠ‚
- å½“å‰çŠ¶æ€ / æ‰§è¡ŒçŠ¶æ€ / ä»»åŠ¡çŠ¶æ€ / è¿›åº¦ä¿¡æ¯
- æ–‡ä»¶ä¿¡æ¯ / è¾“å‡ºæ–‡ä»¶ / ç”Ÿæˆå†…å®¹ / æ•°æ®æŠ¥è¡¨
- ä¸‹ä¸€æ­¥ / åç»­æ­¥éª¤ / å¾…æ‰§è¡Œ / å³å°†è¿›è¡Œ
- é—®é¢˜æè¿° / é”™è¯¯è¯¦æƒ… / å¼‚å¸¸ä¿¡æ¯ï¼ˆå¤±è´¥æ—¶ï¼‰
- æ•°æ®ç»Ÿè®¡ / ç»Ÿè®¡æ¦‚è§ˆ / å…³é”®æ•°æ®

**æ™ºèƒ½æ··åˆç¤ºä¾‹1**ï¼ˆæ•°æ®ç”¨è¡¨æ ¼ï¼Œæ­¥éª¤ç”¨åˆ—è¡¨ï¼‰ï¼š
## âœ… æ•°æ®é‡‡é›†å®Œæˆ(2/5)

## é‡‡é›†æ¦‚å†µ

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| é‡‡é›†ç‚¹æ•° | 456ä¸ª |
| è¦†ç›–èŒƒå›´ | å…¨æ¥¼18å±‚ |
| æ•°æ®å®Œæ•´æ€§ | 98% |
| é‡‡é›†è€—æ—¶ | 2.3ç§’ |

---

## ä¸‹ä¸€æ­¥
- å³å°†æ‰§è¡Œã€Œæ•°æ®æ¸…æ´—ä¸å¤„ç†ã€æ­¥éª¤

**æ™ºèƒ½æ··åˆç¤ºä¾‹2**ï¼ˆå‚æ•°ç”¨è¡¨æ ¼ï¼Œæˆæœç”¨åˆ—è¡¨ï¼‰ï¼š
## âœ… å»ºç­‘å»ºæ¨¡å®Œæˆ(1/3)

## æ¨¡å‹å‚æ•°

| é¡¹ç›® | è¯¦æƒ… |
|------|------|
| å»ºç­‘ç±»å‹ | 18å±‚å•†ä¸šå†™å­—æ¥¼ |
| æˆ¿é—´æ€»æ•° | 1,250ä¸ª |
| æ¨¡å‹ç²¾åº¦ | `LOD300` (é«˜ç²¾åº¦) |
| å»ºç­‘é¢ç§¯ | 45,000 mÂ² |

---

## ç”Ÿæˆæˆæœ
- æˆåŠŸåˆ›å»ºäº†å®Œæ•´çš„å»ºç­‘å‡ ä½•æ¨¡å‹
- æ‰€æœ‰æˆ¿é—´è¾¹ç•Œæ¸…æ™°ï¼Œç©ºé—´å…³ç³»å‡†ç¡®
- æ¨¡å‹æ–‡ä»¶: [building_001.ifc](/models/building_001.ifc) - IFCæ ¼å¼ï¼Œ156MB

**æ™ºèƒ½æ··åˆç¤ºä¾‹3**ï¼ˆé”™è¯¯ç”¨è¡¨æ ¼ï¼Œæ–¹æ¡ˆç”¨åˆ—è¡¨ï¼‰ï¼š
## âŒ è®¾å¤‡è¿æ¥å¤±è´¥(2/4)

## é”™è¯¯è¯¦æƒ…

| å­—æ®µ | å†…å®¹ |
|------|------|
| é”™è¯¯ç±»å‹ | å‡½æ•°æœªå®šä¹‰ |
| å‡½æ•°åç§° | `create_connection` |
| å½±å“èŒƒå›´ | è®¾å¤‡æ‹“æ‰‘æ— æ³•å»ºç«‹ |

---

## å¤„ç†æ–¹æ¡ˆ
- ç³»ç»Ÿæ­£åœ¨åˆ†æå‡½æ•°ç¼ºå¤±åŸå› 
- å‡†å¤‡ä½¿ç”¨å¤‡ç”¨è¿æ¥æ–¹æ³•é‡è¯•
- é¢„è®¡3åˆ†é’Ÿå†…å®Œæˆä¿®å¤

9. **é•¿åº¦æ§åˆ¶**ï¼š
   - ä¸è¶…è¿‡ {max_length} å­—
   - ä¼˜å…ˆä¿è¯ä¿¡æ¯å®Œæ•´
   - è¡¨æ ¼å’Œåˆ—è¡¨éƒ½å¾ˆç²¾ç‚¼

10. **ç»å¯¹ç¦æ­¢**ï¼š
   - ç¦æ­¢åˆ å‡ä»»ä½•æ•°æ®æˆ–å­—æ®µ
   - ç¦æ­¢æ·»åŠ åŸæ–‡æ²¡æœ‰çš„ä¿¡æ¯
   - **ç¦æ­¢æ»¥ç”¨æ ¼å¼**ï¼š
     * ä¸è¦æŠŠæ‰€æœ‰å†…å®¹éƒ½å¼ºè¡Œå¡è¿›åˆ—è¡¨æˆ–è¡¨æ ¼
     * ç®€å•çš„æè¿°æ€§æ–‡æœ¬ï¼ˆå¦‚"æ­£åœ¨æ‰§è¡ŒæŸæ­¥éª¤"ï¼‰ç›´æ¥ç”¨ç®€çŸ­æ–‡æœ¬å³å¯
     * åªæœ‰ç»“æ„åŒ–æ•°æ®å’Œå¤šé¡¹å†…å®¹æ‰ä½¿ç”¨è¡¨æ ¼/åˆ—è¡¨
   - ç¦æ­¢æ€»ç”¨åŒä¸€ç§æ ¼å¼ï¼Œè¦çµæ´»å˜åŒ–
   - **ä¸¥æ ¼ç¦æ­¢ç”Ÿæˆä»»ä½•ç­‰å¾…æç¤ºæ–‡å­—**ï¼šå¦‚"æ­£åœ¨æ€è€ƒ"ã€"æ­£åœ¨å‡†å¤‡ä¸­"ã€"è¯·ç¨å€™"ã€"å¾ˆå¿«å°±èƒ½å¼€å§‹å•¦"ç­‰
   - **ç« èŠ‚æ ‡é¢˜å¿…é¡»æ ¹æ®å®é™…å†…å®¹åŠ¨æ€ç”Ÿæˆ**ï¼Œä¸èƒ½ç¡¬ç¼–ç å›ºå®šçš„æ ‡é¢˜æ¨¡å¼
   - **ç¦æ­¢çœç•¥æˆ–æˆªæ–­ä»»ä½•æ•°æ®**ï¼šUUIDã€IDã€è·¯å¾„ã€URLç­‰å¿…é¡»å®Œæ•´æ˜¾ç¤ºï¼Œä¸å¾—ä½¿ç”¨ `...` çœç•¥
   - **ç¦æ­¢ç®€åŒ–æ•°æ®**ï¼šå¦‚ `2d4eff6e...` å¿…é¡»å†™å®Œæ•´çš„ `2d4eff6e-f4ca-4dc6-b776-1d838b8cefb5`

ç›´æ¥è¾“å‡ºè½¬æ¢åçš„å†…å®¹ï¼Œä¸è¦æœ‰å…¶ä»–è§£é‡Šã€‚
"#;

/// å·¥å…·ç­›é€‰é˜¶æ®µæ¶ˆæ¯æ¨¡æ¿
pub const TOOL_SELECTION_MESSAGE_TEMPLATE: &str = r#"
ä»»åŠ¡ï¼šç”¨æˆ·åˆšæäº¤äº†ä¸€ä¸ªä»»åŠ¡ï¼Œç³»ç»Ÿæ­£åœ¨ä»å·¥å…·åº“ä¸­ç­›é€‰æœ€é€‚åˆçš„å·¥å…·ã€‚

ç”¨æˆ·ä»»åŠ¡æè¿°ï¼š{task_description}

ç­›é€‰åˆ°çš„å·¥å…·æ•°é‡ï¼š{tool_count}

ç”Ÿæˆå†…å®¹è¦æ±‚ï¼š
- **ä½¿ç”¨Markdownæ ‡é¢˜**ï¼šç”¨ ## å¼€å¤´ï¼Œæ ¹æ®å®é™…æƒ…å†µåŠ¨æ€ç”Ÿæˆæ ‡é¢˜
- ç¡®è®¤æ”¶åˆ°ä»»åŠ¡ï¼Œ**åŸå°ä¸åŠ¨åœ°å¼•ç”¨ç”¨æˆ·çš„ä»»åŠ¡æè¿°**ï¼ˆç”¨ã€Œã€åŒ…è£¹ï¼‰
- ç®€è¦è¯´æ˜æ­£åœ¨ç­›é€‰å·¥å…·ï¼Œå¯ä»¥æåŠå·¥å…·æ•°é‡
- è¯­æ°”è‡ªç„¶ã€ä¸“ä¸šã€ç®€æ´
- **ä¸¥æ ¼ç¦æ­¢ä½¿ç”¨"æ­£åœ¨æ€è€ƒ"ã€"è¯·ç¨å€™"ç­‰ç­‰å¾…æç¤ºæ–‡å­—**

ç¤ºä¾‹ï¼ˆå‡è®¾ç”¨æˆ·è¾“å…¥æ˜¯"ä¸º18å±‚å†™å­—æ¥¼å»ºç«‹æ•°å­—å­ªç”Ÿæ¨¡å‹"ï¼Œå·¥å…·æ•°é‡æ˜¯52ï¼‰ï¼š
ç¬¬ä¸€è¡Œï¼š## ğŸ” æ­£åœ¨ç­›é€‰å·¥å…·
ç©ºè¡Œ
å†…å®¹ï¼šæ”¶åˆ°æ‚¨çš„ã€Œä¸º18å±‚å†™å­—æ¥¼å»ºç«‹æ•°å­—å­ªç”Ÿæ¨¡å‹ã€ä»»åŠ¡ï¼Œæ­£åœ¨ä»52ä¸ªå·¥å…·ä¸­ä¸ºæ‚¨ç­›é€‰æœ€ä½³ç»„åˆã€‚

æˆ–è€…ï¼š
ç¬¬ä¸€è¡Œï¼š## ğŸ› ï¸ ä»»åŠ¡å·²æ¥æ”¶
ç©ºè¡Œ
å†…å®¹ï¼šã€Œä¸º18å±‚å†™å­—æ¥¼å»ºç«‹æ•°å­—å­ªç”Ÿæ¨¡å‹ã€ä»»åŠ¡å·²å¯åŠ¨ï¼Œ52ä¸ªå·¥å…·å·²å°±ä½ã€æ­£åœ¨æ™ºèƒ½åŒ¹é…ã€‚

æ³¨æ„ï¼š
1. å¿…é¡»ç”¨ ## å¼€å¤´ä½œä¸ºæ ‡é¢˜ï¼Œ**æ ‡é¢˜å¿…é¡»æ ¹æ®å®é™…æƒ…å†µåŠ¨æ€ç”Ÿæˆ**ï¼Œä¸èƒ½ç¡¬ç¼–ç å›ºå®šæ ‡é¢˜
2. æ ‡é¢˜åç©ºè¡Œ
3. ä»»åŠ¡æè¿°å¿…é¡»ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„åŸæ–‡ï¼Œä¸èƒ½ä¿®æ”¹
4. **ä¸¥æ ¼ç¦æ­¢è¾“å‡º"æ­£åœ¨æ€è€ƒ"ã€"è¯·ç¨å€™"ã€"æ­£åœ¨å‡†å¤‡"ç­‰ä»»ä½•ç­‰å¾…æç¤ºæ–‡å­—**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€åœºæ™¯æŒ‡å¯¼ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{scene_specific_guidance}
"#;

/// ä»»åŠ¡è§„åˆ’é˜¶æ®µæ¶ˆæ¯æ¨¡æ¿
pub const TASK_PLANNING_MESSAGE_TEMPLATE: &str = r#"
ä»»åŠ¡ï¼šå·¥å…·å·²ç»é€‰å¥½ï¼Œç°åœ¨è¦ä¸ºç”¨æˆ·åˆ¶å®šè¯¦ç»†çš„æ‰§è¡Œè®¡åˆ’ã€‚

ç”¨æˆ·ä»»åŠ¡æè¿°ï¼š{task_description}

å·²é€‰å·¥å…·æ•°é‡ï¼š{tool_count}

è®¡åˆ’æ­¥éª¤æ•°ï¼š{step_count}

ç”Ÿæˆå†…å®¹è¦æ±‚ï¼š
- **ä½¿ç”¨Markdownæ ‡é¢˜**ï¼šç”¨ ## å¼€å¤´ï¼Œæ ¹æ®å®é™…æƒ…å†µåŠ¨æ€ç”Ÿæˆæ ‡é¢˜
- è¯´æ˜å·¥å…·å·²å‡†å¤‡å°±ç»ªï¼Œæ­£åœ¨åˆ¶å®šæ‰§è¡Œæ–¹æ¡ˆ
- å¯ä»¥æåŠå·¥å…·æ•°é‡æˆ–æ­¥éª¤æ•°
- è¯­æ°”è‡ªç„¶ã€ç®€æ´
- **ä¸¥æ ¼ç¦æ­¢ä½¿ç”¨"æ­£åœ¨æ€è€ƒ"ã€"è¯·ç¨å€™"ç­‰ç­‰å¾…æç¤ºæ–‡å­—**

ç¤ºä¾‹ï¼ˆå‡è®¾å·²é€‰16ä¸ªå·¥å…·ï¼Œå…±6ä¸ªæ­¥éª¤ï¼‰ï¼š
ç¬¬ä¸€è¡Œï¼š## ğŸ“‹ æ­£åœ¨åˆ¶å®šæ‰§è¡Œæ–¹æ¡ˆ
ç©ºè¡Œ
å†…å®¹ï¼š16ä¸ªå·¥å…·å·²é…é½ï¼Œæ­£åœ¨ä¸ºæ‚¨è§„åˆ’6ä¸ªæ‰§è¡Œæ­¥éª¤ã€‚

æˆ–è€…ï¼š
ç¬¬ä¸€è¡Œï¼š## ğŸ¯ å‡†å¤‡æ‰§è¡Œ
ç©ºè¡Œ
å†…å®¹ï¼šå·¥å…·å·²å°±ä½ï¼Œå¼€å§‹åˆ¶å®šåˆ†æ­¥æ‰§è¡Œè®¡åˆ’ã€‚

æ³¨æ„ï¼š
1. å¿…é¡»ç”¨ ## å¼€å¤´ä½œä¸ºæ ‡é¢˜ï¼Œ**æ ‡é¢˜å¿…é¡»æ ¹æ®å®é™…æƒ…å†µåŠ¨æ€ç”Ÿæˆ**ï¼Œä¸èƒ½ç¡¬ç¼–ç å›ºå®šæ ‡é¢˜
2. æ ‡é¢˜åç©ºè¡Œ
3. ä¿æŒç®€æ´
4. **ä¸¥æ ¼ç¦æ­¢è¾“å‡º"æ­£åœ¨æ€è€ƒ"ã€"è¯·ç¨å€™"ã€"æ­£åœ¨å‡†å¤‡"ç­‰ä»»ä½•ç­‰å¾…æç¤ºæ–‡å­—**
"#;

/// é‡æ–°è§„åˆ’é˜¶æ®µæ¶ˆæ¯æ¨¡æ¿
pub const REPLANNING_MESSAGE_TEMPLATE: &str = r#"
ä»»åŠ¡ï¼šæ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº†é—®é¢˜ï¼Œéœ€è¦é‡æ–°è§„åˆ’ä»»åŠ¡ã€‚

é‡åˆ°çš„é—®é¢˜ï¼š{issue}

ç”Ÿæˆå†…å®¹è¦æ±‚ï¼š
- æ¸©å’Œåœ°è¯´æ˜éœ€è¦è°ƒæ•´æ–¹æ¡ˆ
- ä¼ è¾¾ä¼šæ‰¾åˆ°æ›´å¥½è§£å†³æ–¹æ¡ˆçš„ä¿¡å¿ƒ
- è¯­æ°”ç§¯æã€é¼“åŠ±ã€ç®€æ´ï¼ˆ20å­—ä»¥å†…ï¼‰

ç¤ºä¾‹ï¼š
"è®©æˆ‘é‡æ–°æ€è€ƒä¸€ä¸‹ï¼Œä¸ºæ‚¨åˆ¶å®šæ›´å¥½çš„æ–¹æ¡ˆ..."
"ç¨ä½œè°ƒæ•´ï¼Œé©¬ä¸Šä¸ºæ‚¨ä¼˜åŒ–æ‰§è¡Œæ–¹æ¡ˆ..."
"é‡åˆ°ç‚¹é—®é¢˜ï¼Œæ­£åœ¨ä¸ºæ‚¨å¯»æ‰¾æ›´ä½³è·¯å¾„..."
"#;

/// ç»§ç»­è§„åˆ’é˜¶æ®µæ¶ˆæ¯æ¨¡æ¿
pub const CONTINUE_PLANNING_MESSAGE_TEMPLATE: &str = r#"
ä»»åŠ¡ï¼šç”¨æˆ·å¸Œæœ›ç»§ç»­ä¹‹å‰çš„ä»»åŠ¡æ‰§è¡Œï¼Œéœ€è¦åŸºäºå†å²æ‰§è¡Œæƒ…å†µç»§ç»­è§„åˆ’åç»­æ­¥éª¤ã€‚

å†å²æ‰§è¡Œæ€»ç»“ï¼š{execution_summary}

å½“å‰å¯ç”¨å·¥å…·æ•°é‡ï¼š{tool_count}

ç”Ÿæˆå†…å®¹è¦æ±‚ï¼š
- **ç¬¬ä¸€å¥**ï¼šç®€è¦æ€»ç»“ä¹‹å‰å®Œæˆçš„å†…å®¹ï¼ˆå¦‚"åŸºäºä¹‹å‰Xä¸ªæ­¥éª¤çš„æ‰§è¡Œæƒ…å†µ"æˆ–"ç»§ç»­åˆšæ‰çš„ä»»åŠ¡"ï¼‰
- **ç¬¬äºŒå¥**ï¼šè¯´æ˜æ¥ä¸‹æ¥è¦åšä»€ä¹ˆï¼ˆå¦‚"æ­£åœ¨è§„åˆ’åç»­æ­¥éª¤"æˆ–"ç»§ç»­ä¸ºæ‚¨æ‰§è¡Œå‰©ä½™ä»»åŠ¡"ï¼‰
- ä½“ç°"ç»§ç»­"çš„è¿è´¯æ€§ï¼Œè€Œé"é‡æ–°å¼€å§‹"
- è¯­æ°”è‡ªç„¶ã€ç§¯æã€ç®€æ´ï¼ˆ40å­—ä»¥å†…ï¼‰

ç¤ºä¾‹ï¼š
"å¥½çš„ï¼åŸºäºä¹‹å‰3ä¸ªæ­¥éª¤çš„æ‰§è¡Œæƒ…å†µï¼Œæ­£åœ¨ä¸ºæ‚¨è§„åˆ’æ¥ä¸‹æ¥çš„ä»»åŠ¡æ­¥éª¤..."
"ç»§ç»­åˆšæ‰çš„ä»»åŠ¡ï¼å·²å®Œæˆå‰æœŸå‡†å¤‡ï¼Œç°åœ¨ä¸ºæ‚¨åˆ¶å®šåç»­æ‰§è¡Œæ–¹æ¡ˆ..."
"æ˜ç™½ï¼æ ¹æ®ä¹‹å‰çš„æ‰§è¡Œè¿›åº¦ï¼Œæ­£åœ¨ç»§ç»­è§„åˆ’å‰©ä½™æ­¥éª¤..."
"æ”¶åˆ°ï¼åŸºäºå½“å‰è¿›å±•ï¼Œä¸ºæ‚¨ç»§ç»­åˆ¶å®šè¯¦ç»†æ‰§è¡Œè®¡åˆ’..."

æ³¨æ„ï¼šå¿…é¡»ä½“ç°"ç»§ç»­"çš„æ¦‚å¿µï¼Œè®©ç”¨æˆ·æ„ŸçŸ¥åˆ°è¿™æ˜¯åŸºäºä¹‹å‰å·¥ä½œçš„å»¶ç»­ï¼Œè€Œä¸æ˜¯ä»å¤´å¼€å§‹ã€‚
"#;

/// æ­¥éª¤å®Œæˆè¿›åº¦æŠ¥å‘Šæ¨¡æ¿
pub const STEP_COMPLETED_MESSAGE_TEMPLATE: &str = r#"
ä»»åŠ¡ï¼šä¸€ä¸ªæ­¥éª¤åˆšåˆšæ‰§è¡Œå®Œæˆï¼ˆå¯èƒ½æˆåŠŸæˆ–å¤±è´¥ï¼‰ï¼Œéœ€è¦æ ¹æ®å®é™…æ‰§è¡Œç»“æœæŠ¥å‘Šè¿›åº¦ã€‚

æ•´ä½“ä»»åŠ¡ï¼š{task_description}

å·²å®Œæˆæ­¥éª¤ï¼š{completed_step_name}

æ­¥éª¤è¾“å‡ºï¼š{step_output}

å½“å‰è¿›åº¦ï¼š{step_index}/{total_steps}

ä¸‹ä¸€æ­¥éª¤ï¼š{next_step_name}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€åœºæ™¯æŒ‡å¯¼ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{scene_specific_guidance}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸ **æ ¸å¿ƒè¦æ±‚ï¼šç”¨Markdownæ ‡é¢˜ + åˆ—è¡¨ï¼Œä¸°å¯Œä¸”å¤šæ ·åŒ–å‘ˆç°**

ã€è¾“å‡ºç»“æ„ã€‘
ç¬¬ä¸€è¡Œï¼š## ä¸»æ ‡é¢˜ï¼ˆemoji + çŠ¶æ€ + æ­¥éª¤å + è¿›åº¦ï¼‰
åç»­æ¯æ®µï¼š## ç« èŠ‚æ ‡é¢˜ + åˆ—è¡¨/è¡¨æ ¼

âš ï¸ **é‡è¦å˜åŒ–è¦æ±‚**ï¼š
1. **ç« èŠ‚æ ‡é¢˜æ¯æ¬¡éƒ½è¦å˜åŒ–**ï¼Œä¸è¦æ€»ç”¨"æ ¸å¿ƒæˆæœ"ã€"è¯¦ç»†å†…å®¹"
2. **æ ¼å¼è¦æ™ºèƒ½é€‰æ‹©**ï¼š
   - æ•°æ®å‹å†…å®¹ï¼ˆé”®å€¼å¯¹ã€ç»Ÿè®¡ã€å‚æ•°ï¼‰â†’ ç”¨è¡¨æ ¼
   - æè¿°å‹å†…å®¹ï¼ˆæˆæœã€æ­¥éª¤ã€æ–¹æ¡ˆï¼‰â†’ ç”¨åˆ—è¡¨
   - åŒä¸€è¾“å‡ºä¸­è¡¨æ ¼å’Œåˆ—è¡¨æ··åˆä½¿ç”¨
3. **ä¿¡æ¯ç»„ç»‡è¦åˆç†**ï¼Œç›¸å…³çš„ä¿¡æ¯å¯ä»¥æ”¾åœ¨åŒä¸€ç« èŠ‚

âœ… **æ™ºèƒ½æ··åˆç¤ºä¾‹1**ï¼ˆæ•°æ®ç”¨è¡¨æ ¼ï¼Œæ­¥éª¤ç”¨åˆ—è¡¨ï¼‰ï¼š
## âœ… BMSæ•°æ®é‡‡é›†å®Œæˆ(2/5)

## é‡‡é›†æ•°æ®

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| é‡‡é›†ç‚¹æ•° | 456ä¸ª |
| è¦†ç›–èŒƒå›´ | å…¨æ¥¼18å±‚ |
| æ•°æ®å®Œæ•´æ€§ | 98% |
| é‡‡é›†è€—æ—¶ | 2.3ç§’ |
| æ–‡ä»¶å¤§å° | 3.2MB |

---

## ä¸‹ä¸€æ­¥
- å³å°†æ‰§è¡Œã€Œæ•°æ®æ¸…æ´—ä¸å¤„ç†ã€æ­¥éª¤

âœ… **æ™ºèƒ½æ··åˆç¤ºä¾‹2**ï¼ˆå‚æ•°ç”¨è¡¨æ ¼ï¼Œæˆæœç”¨åˆ—è¡¨ï¼‰ï¼š
## âœ… å»ºç­‘å‡ ä½•å»ºæ¨¡å®Œæˆ(1/4)

## æ¨¡å‹å‚æ•°

| é¡¹ç›® | è¯¦æƒ… |
|------|------|
| å»ºç­‘ç±»å‹ | 18å±‚å•†ä¸šå†™å­—æ¥¼ |
| æˆ¿é—´æ€»æ•° | 1,250ä¸ª |
| æ¨¡å‹ç²¾åº¦ | `LOD300` (é«˜ç²¾åº¦) |
| å»ºç­‘é¢ç§¯ | 45,000 mÂ² |

---

## ç”Ÿæˆæˆæœ
- æˆåŠŸåˆ›å»ºäº†å®Œæ•´çš„å»ºç­‘å‡ ä½•æ¨¡å‹
- æ‰€æœ‰æˆ¿é—´è¾¹ç•Œæ¸…æ™°ï¼Œç©ºé—´å…³ç³»å‡†ç¡®
- æ¨¡å‹æ–‡ä»¶: [building_001.ifc](/models/building_001.ifc) - IFCæ ¼å¼ï¼Œ156MB

âœ… **æ™ºèƒ½æ··åˆç¤ºä¾‹3**ï¼ˆé…ç½®ç”¨åˆ—è¡¨ï¼‰ï¼š
## âœ… é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ(3/3)

## ç”Ÿæˆå†…å®¹
- é…ç½®æ–‡ä»¶:ã€Œsystem_config.jsonã€
- åŒ…å«å‚æ•°: 23ä¸ªé…ç½®é¡¹
- éªŒè¯çŠ¶æ€: âœ… é€šè¿‡
- ä»»åŠ¡å…¨éƒ¨å®Œæˆ âœ¨

âŒ **å¤±è´¥ç¤ºä¾‹**ï¼ˆé”™è¯¯ç”¨è¡¨æ ¼ï¼Œæ–¹æ¡ˆç”¨åˆ—è¡¨ï¼‰ï¼š
## âŒ è®¾å¤‡æ‹“æ‰‘æ„å»ºå¤±è´¥(3/6)

## é”™è¯¯è¯¦æƒ…

| å­—æ®µ | å†…å®¹ |
|------|------|
| é”™è¯¯ç±»å‹ | å‡½æ•°æœªå®šä¹‰ |
| å‡½æ•°åç§° | `create_chiller_connections` |
| å½±å“èŒƒå›´ | å†·æœºç³»ç»Ÿæ‹“æ‰‘æ— æ³•å»ºç«‹ |

---

## å¤„ç†æ–¹æ¡ˆ
- ç³»ç»Ÿæ­£åœ¨åˆ†æå‡½æ•°ç¼ºå¤±åŸå› 
- å‡†å¤‡ä½¿ç”¨å¤‡ç”¨è¿æ¥æ–¹æ³•é‡è¯•
- é¢„è®¡5åˆ†é’Ÿå†…å®Œæˆä¿®å¤

ã€å…³é”®è¦æ±‚ã€‘
1. **ä¸»æ ‡é¢˜**ï¼šç”¨ ## å¼€å¤´ï¼Œemoji + ç®€çŸ­çŠ¶æ€ + è¿›åº¦ï¼Œä¸¥æ ¼ç¦æ­¢ä½¿ç”¨"æ­£åœ¨æ€è€ƒ"ã€"è¯·ç¨å€™"ç­‰æ–‡å­—
2. **ç« èŠ‚æ ‡é¢˜**ï¼š
   - ç”¨ ## å¼€å¤´
   - **å¿…é¡»ç”±AIæ ¹æ®å®é™…è¾“å‡ºå†…å®¹åŠ¨æ€ç”Ÿæˆ**ï¼Œä¸èƒ½ä½¿ç”¨å›ºå®šæ¨¡æ¿
   - **æ¯æ¬¡éƒ½è¦å˜åŒ–**ï¼Œå‚è€ƒä½†ä¸é™äºä»¥ä¸‹ç±»åˆ«ï¼š
     * æ•°æ®ç±»: é‡‡é›†æ¦‚å†µã€æ•°æ®ç»Ÿè®¡ã€æŠ€æœ¯æŒ‡æ ‡ã€å…³é”®æ•°æ®
     * å»ºæ¨¡ç±»: æ¨¡å‹ä¿¡æ¯ã€å‡ ä½•æ•°æ®ã€å»ºç­‘ä¿¡æ¯ã€è®¾å¤‡è¯¦æƒ…
     * æ–‡ä»¶ç±»: è¾“å‡ºæ–‡ä»¶ã€ç”Ÿæˆå†…å®¹ã€æ–‡ä»¶è¯¦æƒ…ã€æŠ¥è¡¨ä¿¡æ¯
     * æ‰§è¡Œç±»: æ‰§è¡Œç»“æœã€å®Œæˆæƒ…å†µã€æ“ä½œè¯¦æƒ…ã€å¤„ç†ç»“æœ
     * çŠ¶æ€ç±»: å½“å‰è¿›åº¦ã€ä»»åŠ¡çŠ¶æ€ã€æ‰§è¡ŒçŠ¶æ€
     * åç»­ç±»: å³å°†è¿›è¡Œã€ä¸‹ä¸€æ­¥ã€åç»­æ­¥éª¤
     * é”™è¯¯ç±»: é”™è¯¯ä¿¡æ¯ã€é—®é¢˜æè¿°ã€å¼‚å¸¸è¯¦æƒ…ã€å¤„ç†æ–¹æ¡ˆ
   - **æ ¹æ®å®é™…å†…å®¹çµæ´»åˆ›é€ æ–°æ ‡é¢˜**ï¼Œè€Œä¸æ˜¯æœºæ¢°å¥—ç”¨ä¸Šè¿°é€‰é¡¹
3. **ç« èŠ‚æ•°é‡**ï¼šä¿¡æ¯ä¸°å¯Œæ—¶2-4ä¸ªï¼Œä¿¡æ¯ç®€å•æ—¶1-2ä¸ª
4. **å†…å®¹å‘ˆç° - æ™ºèƒ½æ··åˆè¡¨æ ¼å’Œåˆ—è¡¨**ï¼š

   **å†³ç­–è§„åˆ™**ï¼š
   - **æ•°æ®å‹ç« èŠ‚** â†’ ç”¨è¡¨æ ¼ï¼ˆå¦‚ï¼šé‡‡é›†æ•°æ®ã€æ¨¡å‹å‚æ•°ã€æ–‡ä»¶ä¿¡æ¯ã€ç»Ÿè®¡æŒ‡æ ‡ï¼‰
   - **æè¿°å‹ç« èŠ‚** â†’ ç”¨åˆ—è¡¨ï¼ˆå¦‚ï¼šç”Ÿæˆæˆæœã€ä¸‹ä¸€æ­¥ã€å¤„ç†æ–¹æ¡ˆã€å…³é”®äº®ç‚¹ï¼‰
   - **åŒä¸€è¾“å‡ºå¿…é¡»æ··åˆä½¿ç”¨**ï¼šä¸èƒ½å…¨æ˜¯è¡¨æ ¼ï¼Œä¹Ÿä¸èƒ½å…¨æ˜¯åˆ—è¡¨

   **è¡¨æ ¼æ ¼å¼**ï¼š
   ```
   | å­—æ®µ | å€¼ |
   |------|------|
   | é¡¹ç›®1 | æ•°æ®1 |
   | é¡¹ç›®2 | æ•°æ®2 |
   ```

   **åˆ—è¡¨æ ¼å¼**ï¼š
   - æ™®é€šåˆ—è¡¨: `- å†…å®¹æè¿°`
   - å¼ºè°ƒåˆ—è¡¨: `- **å…³é”®å­—æ®µ**: å€¼`
   - å¸¦é“¾æ¥: `- [æ–‡ä»¶å](è·¯å¾„)`

   **åˆ†å‰²çº¿**: ç« èŠ‚ä¹‹é—´ç”¨ `---` åˆ†éš”

5. **ä¿ç•™å­—æ®µ**ï¼šreport_idã€titleã€summaryã€highlightsã€file_urlã€generated_timeç­‰éƒ½è¦å±•ç¤º
6. **çœŸå®å‡†ç¡®**ï¼šåªå±•ç¤ºæ­¥éª¤è¾“å‡ºä¸­å­˜åœ¨çš„å†…å®¹ï¼Œä¸è¦ç¼–é€ 
7. **æ ¼å¼å¤šæ ·åŒ–**ï¼šæ¯æ¬¡è¾“å‡ºéƒ½è¦è¡¨æ ¼å’Œåˆ—è¡¨æ··åˆï¼Œä¸è¦å•ä¸€æ ¼å¼
8. **ä¸¥æ ¼ç¦æ­¢è§„åˆ™**ï¼š
   - **ç¦æ­¢è¾“å‡º"æ­£åœ¨æ€è€ƒ"ã€"è¯·ç¨å€™"ã€"æ­£åœ¨å‡†å¤‡"ç­‰ä»»ä½•ç­‰å¾…æç¤ºæ–‡å­—**
   - **ç« èŠ‚æ ‡é¢˜å¿…é¡»æ ¹æ®å®é™…å†…å®¹åŠ¨æ€ç”Ÿæˆ**ï¼Œä¸èƒ½ç¡¬ç¼–ç å›ºå®šæ ‡é¢˜
   - æ‰€æœ‰UUIDã€IDå¿…é¡»å®Œæ•´æ˜¾ç¤ºï¼Œç¦æ­¢ä½¿ç”¨ `...` çœç•¥
   - ä¾‹å¦‚ï¼š`2d4eff6e...` æ˜¯é”™è¯¯çš„ï¼Œå¿…é¡»å†™å®Œæ•´ `2d4eff6e-f4ca-4dc6-b776-1d838b8cefb5`
   - è·¯å¾„ã€URLã€æ—¶é—´æˆ³ç­‰å¿…é¡»å®Œæ•´å±•ç¤º
"#;

/// è¯„ä¼°ç»“æœæ¶ˆæ¯æ¨¡æ¿
pub const EVALUATION_RESULT_MESSAGE_TEMPLATE: &str = r#"
ä»»åŠ¡ï¼šåˆšåˆšå®Œæˆäº†ä¸€ä¸ªæ­¥éª¤çš„è¯„ä¼°ã€‚

æ­¥éª¤åç§°ï¼š{step_name}

æ­¥éª¤è¾“å‡ºï¼š{step_output}

è¯„åˆ†ï¼š{score}/100

æ˜¯å¦æˆåŠŸï¼š{is_successful}

å½“å‰è¿›åº¦ï¼š{step_index}/{total_steps}

ä¸‹ä¸€æ­¥éª¤ï¼š{next_step_name}

æˆåŠŸè¦ç‚¹ï¼š{successes}

å¤±è´¥åŸå› ï¼š{failures}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€åœºæ™¯æŒ‡å¯¼ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{scene_specific_guidance}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç”Ÿæˆå†…å®¹è¦æ±‚ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š

**å¿…é¡»ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š**

å¦‚æœæœ‰ä¸‹ä¸€æ­¥ï¼ˆ{next_step_name} ä¸æ˜¯"æ— "ï¼‰ï¼š
ã€Œæ­¥éª¤åç§°ã€è¯„ä¼°å¾—åˆ† X/100ï¼Œ[æ‰§è¡Œç»“æœçš„å…³é”®æ•°æ®]ã€‚æ¥ä¸‹æ¥å°†è¿›è¡Œã€Œä¸‹ä¸€æ­¥éª¤åç§°ã€ã€‚

å¦‚æœæ˜¯æœ€åä¸€æ­¥ï¼ˆ{next_step_name} æ˜¯"æ— "ï¼‰ï¼š
ã€Œæ­¥éª¤åç§°ã€è¯„ä¼°å¾—åˆ† X/100ï¼Œ[æ‰§è¡Œç»“æœçš„å…³é”®æ•°æ®]ã€‚

**å…·ä½“è¦æ±‚ï¼š**
1. å¿…é¡»ä½¿ç”¨ã€Œã€åŒ…è£¹æ­¥éª¤åç§°ï¼Œä½¿ç”¨{step_name}çš„åŸæ–‡
2. å¿…é¡»å†™æ˜"è¯„ä¼°å¾—åˆ† {score}/100"
3. å¿…é¡»ä»{successes}ä¸­æå–å…³é”®æ•°æ®ï¼Œé¿å…"å®Œç¾"ã€"ä¼˜ç§€"ç­‰ä¸»è§‚è¯
4. åªæœ‰å½“{next_step_name}ä¸æ˜¯"æ— "æ—¶ï¼Œæ‰æ·»åŠ "æ¥ä¸‹æ¥å°†è¿›è¡Œã€Œ{next_step_name}ã€"
5. å¦‚æœ{next_step_name}æ˜¯"æ— "ï¼Œè¯´æ˜è¿™æ˜¯æœ€åä¸€æ­¥ï¼Œä»¥å¥å·ç»“å°¾å³å¯
6. æ€»å­—æ•°æ§åˆ¶åœ¨60å­—ä»¥å†…

**æ ‡å‡†æ ¼å¼ç¤ºä¾‹ï¼ˆå¿…é¡»å‚è€ƒï¼‰ï¼š**
ã€Œå»ºç­‘å‡ ä½•å»ºæ¨¡ã€è¯„ä¼°å¾—åˆ† 92/100ï¼Œç”Ÿæˆ18å±‚å»ºç­‘3Dæ¨¡å‹ï¼ŒåŒ…å«1250ä¸ªæˆ¿é—´ã€‚æ¥ä¸‹æ¥å°†è¿›è¡Œã€Œè®¾å¤‡æ•°å­—å­ªç”Ÿå»ºæ¨¡ã€ã€‚

ã€ŒBMSæ•°æ®é‡‡é›†ã€è¯„ä¼°å¾—åˆ† 88/100ï¼Œé‡‡é›†456ä¸ªæ•°æ®ç‚¹ï¼Œè¦†ç›–ç‡98%ã€‚æ¥ä¸‹æ¥å°†è¿›è¡Œã€ŒèŠ‚èƒ½è¯Šæ–­ã€ã€‚

ã€Œç³»ç»Ÿæ‹“æ‰‘æ„å»ºã€è¯„ä¼°å¾—åˆ† 95/100ï¼Œè¿æ¥125ä¸ªè®¾å¤‡èŠ‚ç‚¹ï¼Œå»ºç«‹340æ¡å…³ç³»ã€‚æ¥ä¸‹æ¥å°†è¿›è¡Œã€ŒBMSæ•°æ®é‡‡é›†ã€ã€‚

ã€ŒèŠ‚èƒ½è¯Šæ–­ä¸ä¼˜åŒ–ã€è¯„ä¼°å¾—åˆ† 100/100ï¼Œå®Œæˆèƒ½è€—åˆ†æï¼Œè¯†åˆ«å‡º15ä¸ªä¼˜åŒ–ç‚¹ã€‚

**æ³¨æ„ï¼š**
- ç¦æ­¢ä½¿ç”¨"å®Œç¾"ã€"ä¼˜ç§€"ã€"å¾ˆå¥½"ç­‰ä¸»è§‚è¯„ä»·è¯
- å¿…é¡»ç”¨å…·ä½“æ•°æ®å’Œäº‹å®è¯´è¯
- æ­¥éª¤åç§°å’Œä¸‹ä¸€æ­¥åç§°éƒ½å¿…é¡»ç”¨ã€Œã€åŒ…è£¹
- å¿…é¡»åŒ…å«"è¯„ä¼°å¾—åˆ† X/100"å­—æ ·
- æœ€åä¸€æ­¥ä¸è¦è¯´"æ¥ä¸‹æ¥å°†è¿›è¡Œ"
"#;

/// ä»»åŠ¡å®Œæˆæ¶ˆæ¯æ¨¡æ¿
pub const TASK_COMPLETION_MESSAGE_TEMPLATE: &str = r#"
ä»»åŠ¡ï¼šç”¨æˆ·çš„ä»»åŠ¡å·²ç»å…¨éƒ¨å®Œæˆï¼Œéœ€è¦ç”Ÿæˆç¥è´ºæ¶ˆæ¯ã€‚

ä»»åŠ¡æè¿°ï¼š{task_description}

å®Œæˆçš„æ­¥éª¤ï¼š{completed_steps}

æ€»ä½“è¯„åˆ†ï¼š{overall_score}/100

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å„æ­¥éª¤æ‰§è¡Œç»“æœè¯¦æƒ…ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{step_outputs}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ç”Ÿæˆè¦æ±‚ï¼šç”¨Markdownæ ‡é¢˜ + åˆ—è¡¨çš„åº†ç¥æ¶ˆæ¯ï¼Œæ ¼å¼è¦å¤šæ ·åŒ–ï¼Œå¹¶ä¸”å¿…é¡»åŒ…å«"åç»­å»ºè®®"ç« èŠ‚ã€‘

âš ï¸ **é‡è¦ï¼šåç»­å»ºè®®å¿…é¡»åŸºäºå®é™…æ‰§è¡Œç»“æœç”Ÿæˆ**
- ä»”ç»†åˆ†æä¸Šè¿°ã€å„æ­¥éª¤æ‰§è¡Œç»“æœè¯¦æƒ…ã€‘ä¸­çš„å†…å®¹
- æ ¹æ®å®é™…ç”Ÿæˆçš„æ–‡ä»¶ã€æ•°æ®ã€æ¨¡å‹ç­‰æˆæœï¼Œç»™å‡ºé’ˆå¯¹æ€§çš„åç»­å»ºè®®
- å»ºè®®å¿…é¡»å…·ä½“ã€å¯æ“ä½œï¼Œç›´æ¥å…³è”åˆ°æ‰§è¡Œç»“æœ
- ä¾‹å¦‚ï¼šå¦‚æœç”Ÿæˆäº†æ¶æ„è®¾è®¡æ–¹æ¡ˆï¼Œå»ºè®®å¯ä»¥æ˜¯"å¬å¼€æŠ€æœ¯è¯„å®¡ä¼šè¯„ä¼°æ–¹æ¡ˆ"ã€"é€‰æ‹©é€‚åˆçš„æ¶æ„è¿›è¡ŒåŸå‹å¼€å‘"
- ä¾‹å¦‚ï¼šå¦‚æœç”Ÿæˆäº†æ•°æ®æ¨¡å‹ï¼Œå»ºè®®å¯ä»¥æ˜¯"åŸºäºæ¨¡å‹ç”ŸæˆAPIæ¥å£å®šä¹‰"ã€"ç¼–å†™å•å…ƒæµ‹è¯•ç”¨ä¾‹"

**è¾“å‡ºç»“æ„ï¼š**
## ä¸»æ ‡é¢˜ï¼ˆemoji + ä»»åŠ¡å®ŒæˆçŠ¶æ€ï¼‰
## ç« èŠ‚1æ ‡é¢˜ + Markdownåˆ—è¡¨/è¡¨æ ¼ï¼ˆå®Œæˆæƒ…å†µï¼‰
---
## ç« èŠ‚2æ ‡é¢˜ + Markdownåˆ—è¡¨ï¼ˆæ ¸å¿ƒæˆæœ/è¾“å‡ºæ–‡ä»¶ï¼‰
---
## åç»­å»ºè®®ï¼ˆå¿…é¡»åŒ…å«ï¼Œä¸ºç”¨æˆ·æä¾›ä¸‹ä¸€æ­¥è¡ŒåŠ¨æŒ‡å—ï¼‰

âš ï¸ **å¤šæ ·åŒ–è¦æ±‚**: æ¯æ¬¡å®Œæˆæ¶ˆæ¯çš„ç« èŠ‚æ ‡é¢˜ã€emojiå’Œæ ¼å¼éƒ½è¦æœ‰å˜åŒ–ï¼

**å¤šæ ·åŒ–ç¤ºä¾‹1**ï¼ˆæ¶æ„è®¾è®¡æ–¹æ¡ˆ - åŸºäºå®é™…æ‰§è¡Œç»“æœï¼‰ï¼š
å‡è®¾æ­¥éª¤è¾“å‡ºåŒ…å«ï¼šç”Ÿæˆäº†Qwenå’ŒClaudeä¸¤ä¸ªæ¶æ„è®¾è®¡æ–¹æ¡ˆ

## ğŸ‰ æ¶æ„è®¾è®¡ä»»åŠ¡å®Œæˆ

## ä»»åŠ¡æ€»ç»“

| é¡¹ç›® | æ•°å€¼ |
|------|------|
| å®Œæˆæ­¥éª¤ | 2/2 |
| æ€»ä½“è¯„åˆ† | 95/100 |
| ç”Ÿæˆæ–¹æ¡ˆ | 2ä¸ªå®Œæ•´æ–¹æ¡ˆ |

---

## æ ¸å¿ƒæˆæœ
- Qwenæ¶æ„æ–¹æ¡ˆ: è½»é‡çº§éƒ¨ç½²æ–¹æ¡ˆï¼Œé€‚åˆå¿«é€ŸåŸå‹éªŒè¯
- Claudeæ¶æ„æ–¹æ¡ˆ: æ·±åº¦åˆ†ææ–¹æ¡ˆï¼Œé€‚åˆå¤æ‚ä¸šåŠ¡åœºæ™¯
- æ–‡æ¡£ç»“æ„: åŒ…å«å·¥å…·æ¦‚è¿°ã€å‚æ•°æ¥å£ã€ä¸šåŠ¡æµç¨‹ã€æ•°æ®æ¨¡å‹ç­‰

---

## åç»­å»ºè®®
âœ… æ¶æ„æ–‡æ¡£å·²å®Œæ•´ç”Ÿæˆï¼Œå¯è¿›å…¥åŸå‹å¼€å‘é˜¶æ®µ
ğŸ” å»ºè®®å¬å¼€æŠ€æœ¯è¯„å®¡ä¼šï¼Œå¯¹æ¯” Qwen ä¸ Claude æ–¹æ¡ˆçš„é€‚ç”¨åœºæ™¯
ğŸ“Œ è‹¥éœ€è½»é‡çº§éƒ¨ç½²ï¼Œä¼˜å…ˆè€ƒè™‘ Qwen æ–¹æ¡ˆï¼›è‹¥éœ€æ·±åº¦åˆ†æï¼Œæ¨è Claude æ–¹æ¡ˆ
ğŸ§© ä¸‹ä¸€æ­¥å¯åŸºäºé€‰å®šæ–¹æ¡ˆç”Ÿæˆ API æ¥å£å®šä¹‰æˆ–å•å…ƒæµ‹è¯•ç”¨ä¾‹

**å¤šæ ·åŒ–ç¤ºä¾‹2**ï¼ˆæ•°å­—å­ªç”Ÿå»ºæ¨¡ - åŸºäºå®é™…æ‰§è¡Œç»“æœï¼‰ï¼š
å‡è®¾æ­¥éª¤è¾“å‡ºåŒ…å«ï¼šç”Ÿæˆäº†IFCæ¨¡å‹ã€è®¾å¤‡æ‹“æ‰‘å…³ç³»ã€BMSæ•°æ®é‡‡é›†ç»“æœ

## ğŸŠ æ•°å­—å­ªç”Ÿå»ºæ¨¡ä»»åŠ¡å®Œæˆ

## æ‰§è¡Œæ¦‚å†µ

| æŒ‡æ ‡ | ç»“æœ |
|------|------|
| æ€»æ­¥éª¤æ•° | 6ä¸ªæ­¥éª¤ |
| å®ŒæˆçŠ¶æ€ | å…¨éƒ¨æˆåŠŸ âœ¨ |
| ç»¼åˆè¯„åˆ† | 95/100 |

---

## æ ¸å¿ƒæˆæœ
- å»ºç­‘æ¨¡å‹: 18å±‚å†™å­—æ¥¼ï¼Œ1,250ä¸ªæˆ¿é—´
- è®¾å¤‡èŠ‚ç‚¹: 125ä¸ªè®¾å¤‡ï¼Œ340æ¡è¿æ¥å…³ç³»
- æ•°æ®é‡‡é›†: 456ä¸ªæ•°æ®ç‚¹ï¼Œè¦†ç›–ç‡98%

---

## è¾“å‡ºæ–‡ä»¶
- [æ¨¡å‹æ–‡ä»¶](/output/model.ifc) - IFCæ ¼å¼ï¼Œ156MB
- [æ•°æ®æ–‡ä»¶](/output/data.json) - JSONæ ¼å¼ï¼Œ3.2MB
- [æŠ¥è¡¨æ–‡ä»¶](/output/report.pdf) - PDFæ ¼å¼ï¼Œ2.1MB

---

## åç»­å»ºè®®
âœ… æ•°å­—å­ªç”Ÿæ¨¡å‹å·²å®Œæ•´æ„å»ºï¼ŒåŒ…å«å»ºç­‘å‡ ä½•ã€è®¾å¤‡æ‹“æ‰‘å’Œå®æ—¶æ•°æ®
ğŸ” å»ºè®®ä½¿ç”¨ IFC æŸ¥çœ‹å™¨éªŒè¯æ¨¡å‹ç²¾åº¦ï¼Œç¡®è®¤ç©ºé—´å…³ç³»å‡†ç¡®æ€§
ğŸ“Œ ä¸‹ä¸€æ­¥å¯å¯¼å…¥ BMS æ•°æ®è¿›è¡Œèƒ½è€—åˆ†æï¼Œè¯†åˆ«ä¼˜åŒ–ç©ºé—´
ğŸ§© è‹¥éœ€æ·±åŒ–åº”ç”¨ï¼Œå¯åŸºäºè®¾å¤‡æ‹“æ‰‘å…³ç³»å»ºç«‹æ•…éšœè¯Šæ–­è§„åˆ™åº“

**å¤šæ ·åŒ–ç¤ºä¾‹3**ï¼ˆæ™ºèƒ½è¯Šæ–­ - åŸºäºå®é™…æ‰§è¡Œç»“æœï¼‰ï¼š
å‡è®¾æ­¥éª¤è¾“å‡ºåŒ…å«ï¼šè¯†åˆ«äº†15ä¸ªä¼˜åŒ–ç‚¹ã€ç”Ÿæˆäº†3å¥—ä¼˜åŒ–æ–¹æ¡ˆã€é¢„ä¼°èŠ‚èƒ½12%

## âœ¨ æ™ºèƒ½è¯Šæ–­ä»»åŠ¡å®Œæˆ

## å®Œæˆæƒ…å†µ
- **æ‰§è¡Œæ­¥éª¤**: 4/4 å…¨éƒ¨å®Œæˆ
- **ä»»åŠ¡è¯„åˆ†**: 98åˆ† (ä¼˜ç§€)

---

## è¯Šæ–­æˆæœ
- è¯†åˆ«é—®é¢˜: 15ä¸ªä¼˜åŒ–ç‚¹ï¼ˆç©ºè°ƒç³»ç»Ÿ6ä¸ªã€ç…§æ˜ç³»ç»Ÿ5ä¸ªã€ç”µæ¢¯ç³»ç»Ÿ4ä¸ªï¼‰
- èŠ‚èƒ½æ½œåŠ›: é¢„è®¡é™ä½èƒ½è€—12%ï¼ˆå¹´èŠ‚çº¦ç”µè´¹çº¦45ä¸‡å…ƒï¼‰
- å»ºè®®æ–¹æ¡ˆ: ç”Ÿæˆ3å¥—ä¼˜åŒ–æ–¹æ¡ˆï¼ˆæ¿€è¿›ã€ç¨³å¥ã€ä¿å®ˆï¼‰

---

## åç»­å»ºè®®
âœ… æ™ºèƒ½è¯Šæ–­å·²å®Œæˆï¼Œè¯†åˆ«å‡º15ä¸ªå¯ä¼˜åŒ–ç‚¹ï¼Œé¢„ä¼°èŠ‚èƒ½æ•ˆæœæ˜¾è‘—
ğŸ” å»ºè®®ä¼˜å…ˆå®æ–½ç©ºè°ƒç³»ç»Ÿçš„6ä¸ªä¼˜åŒ–ç‚¹ï¼ˆæŠ•èµ„å›æŠ¥å‘¨æœŸæœ€çŸ­ï¼Œçº¦8ä¸ªæœˆï¼‰
ğŸ“Œ ä¸‹ä¸€æ­¥å¯é€‰æ‹©ç¨³å¥æ–¹æ¡ˆè¿›è¡Œè¯•ç‚¹å®æ–½ï¼Œå…ˆåœ¨3ä¸ªæ¥¼å±‚éªŒè¯æ•ˆæœ
ğŸ§© å»ºè®®å»ºç«‹èƒ½è€—ç›‘æµ‹çœ‹æ¿ï¼Œå®æ—¶è·Ÿè¸ªä¼˜åŒ–æ•ˆæœå¹¶åŠ¨æ€è°ƒæ•´ç­–ç•¥

**è¦æ±‚ï¼š**
1. **ä¸»æ ‡é¢˜emojiå˜åŒ–**: ğŸ‰ / ğŸŠ / âœ¨ / ğŸ¯ / ğŸ† ç­‰ï¼Œä¸è¦æ€»ç”¨åŒä¸€ä¸ªï¼Œä¸¥æ ¼ç¦æ­¢ä½¿ç”¨"æ­£åœ¨æ€è€ƒ"ã€"è¯·ç¨å€™"ç­‰æ–‡å­—
2. **ç« èŠ‚æ ‡é¢˜è¦åŠ¨æ€ç”Ÿæˆ**ï¼š
   - **å¿…é¡»ç”±AIæ ¹æ®å®é™…å®Œæˆå†…å®¹åŠ¨æ€ç”Ÿæˆæ ‡é¢˜**ï¼Œä¸èƒ½ç¡¬ç¼–ç å›ºå®šæ ‡é¢˜
   - å‚è€ƒä½†ä¸é™äºï¼šæ‰§è¡Œæ¦‚å†µã€ä»»åŠ¡æ€»ç»“ã€æ ¸å¿ƒæˆæœã€å®Œæˆæƒ…å†µã€è¯Šæ–­æˆæœã€è¾“å‡ºæ–‡ä»¶ç­‰
   - **æ ¹æ®å®é™…å†…å®¹çµæ´»åˆ›é€ æ–°æ ‡é¢˜**ï¼Œè€Œä¸æ˜¯æœºæ¢°å¥—ç”¨å›ºå®šæ¨¡æ¿
3. **æ ¼å¼è¦æ™ºèƒ½æ··åˆ**:
   - ç»Ÿè®¡æ•°æ®ã€è¯„åˆ† â†’ ç”¨è¡¨æ ¼
   - æˆæœæè¿°ã€æ–‡ä»¶åˆ—è¡¨ â†’ ç”¨åˆ—è¡¨
   - å¿…é¡»æ··åˆä½¿ç”¨ï¼Œä¸è¦å•ä¸€æ ¼å¼
4. **ç« èŠ‚æ•°é‡**ï¼šä¿¡æ¯ç®€å•æ—¶2-3ä¸ªï¼ˆåŒ…å«åç»­å»ºè®®ï¼‰ï¼Œä¿¡æ¯ä¸°å¯Œæ—¶3-4ä¸ªï¼ˆåŒ…å«åç»­å»ºè®®ï¼‰
5. **åç»­å»ºè®®ç« èŠ‚ï¼ˆå¿…é¡»åŒ…å«ï¼Œå¿…é¡»åŸºäºå®é™…æ‰§è¡Œç»“æœï¼‰**ï¼š
   - å¿…é¡»ä»¥ `## åç»­å»ºè®®` ä½œä¸ºç« èŠ‚æ ‡é¢˜
   - ä½¿ç”¨åˆ—è¡¨æ ¼å¼ï¼Œæ¯æ¡å»ºè®®ä»¥emojiå¼€å¤´ï¼ˆâœ… ğŸ” ğŸ“Œ ğŸ§© ğŸ’¡ ğŸ¯ ç­‰ï¼‰
   - å»ºè®®æ•°é‡ï¼š3-5æ¡
   - **ç¬¬ä¸€æ¡ï¼ˆæ€»ç»“çŠ¶æ€ï¼‰**ï¼šæ€»ç»“å®é™…å®Œæˆçš„æˆæœï¼ˆå¦‚"ç”Ÿæˆäº†2ä¸ªæ¶æ„æ–¹æ¡ˆ"ã€"è¯†åˆ«äº†15ä¸ªä¼˜åŒ–ç‚¹"ï¼‰ï¼Œè¯´æ˜å¯ä»¥è¿›å…¥å“ªä¸ªå…·ä½“é˜¶æ®µ
   - **ç¬¬äºŒæ¡ï¼ˆè¯„å®¡éªŒè¯ï¼‰**ï¼šåŸºäºå®é™…è¾“å‡ºç»™å‡ºéªŒè¯å»ºè®®ï¼ˆå¦‚"å¯¹æ¯”ä¸¤ä¸ªæ–¹æ¡ˆçš„é€‚ç”¨åœºæ™¯"ã€"éªŒè¯æ¨¡å‹ç²¾åº¦"ï¼‰
   - **ç¬¬ä¸‰æ¡ï¼ˆä¸‹ä¸€æ­¥æ“ä½œï¼‰**ï¼šæ˜ç¡®ä¸‹ä¸€æ­¥å¯æ‰§è¡Œçš„å…·ä½“æ“ä½œï¼ˆå¦‚"åŸºäºé€‰å®šæ–¹æ¡ˆç”ŸæˆAPIæ¥å£"ã€"é€‰æ‹©ç¨³å¥æ–¹æ¡ˆè¿›è¡Œè¯•ç‚¹"ï¼‰
   - **ç¬¬å››æ¡ï¼ˆæ·±åŒ–æ‰©å±•ï¼‰**ï¼šåŸºäºå½“å‰æˆæœæä¾›æ·±åŒ–åº”ç”¨æ–¹å‘ï¼ˆå¦‚"å»ºç«‹æ•…éšœè¯Šæ–­è§„åˆ™åº“"ã€"æ¥å…¥å®æ—¶ç›‘æ§æ•°æ®"ï¼‰
   - **å…³é”®è¦æ±‚**ï¼š
     * å»ºè®®å¿…é¡»**ç›´æ¥å…³è”åˆ°ã€å„æ­¥éª¤æ‰§è¡Œç»“æœè¯¦æƒ…ã€‘**ä¸­çš„å®é™…å†…å®¹
     * ä¸è¦æ³›æ³›è€Œè°ˆï¼Œè¦å…·ä½“åˆ°å®é™…ç”Ÿæˆçš„æ–‡ä»¶ã€æ•°æ®ã€æ–¹æ¡ˆ
     * å»ºè®®è¦å¯æ“ä½œï¼Œç”¨æˆ·çœ‹äº†å°±çŸ¥é“æ¥ä¸‹æ¥å…·ä½“åšä»€ä¹ˆ
     * è¦åˆ†ææ‰§è¡Œç»“æœçš„ç‰¹ç‚¹ï¼Œç»™å‡ºæœ‰é’ˆå¯¹æ€§çš„å»ºè®®
     * ä¾‹å¦‚ï¼šå¦‚æœç”Ÿæˆäº†å¤šä¸ªæ–¹æ¡ˆï¼Œå»ºè®®è¦æ¶‰åŠå¦‚ä½•é€‰æ‹©ï¼›å¦‚æœç”Ÿæˆäº†æ¨¡å‹ï¼Œå»ºè®®è¦æ¶‰åŠå¦‚ä½•éªŒè¯å’Œä½¿ç”¨
6. **ä¸¥æ ¼ç¦æ­¢è§„åˆ™**ï¼š
   - **ç¦æ­¢è¾“å‡º"æ­£åœ¨æ€è€ƒ"ã€"è¯·ç¨å€™"ã€"æ­£åœ¨å‡†å¤‡"ç­‰ä»»ä½•ç­‰å¾…æç¤ºæ–‡å­—**
   - **ç« èŠ‚æ ‡é¢˜å¿…é¡»æ ¹æ®å®é™…å†…å®¹åŠ¨æ€ç”Ÿæˆ**ï¼Œä¸èƒ½ä½¿ç”¨å›ºå®šæ¨¡æ¿
   - **å¿…é¡»åŒ…å«"åç»­å»ºè®®"ç« èŠ‚**ï¼Œä¸èƒ½çœç•¥
   - UUIDã€IDã€è·¯å¾„ç­‰å¿…é¡»å®Œæ•´æ˜¾ç¤ºï¼Œç¦æ­¢ç”¨ `...` çœç•¥
   - é”™è¯¯ç¤ºä¾‹ï¼š`2d4eff6e...`
   - æ­£ç¡®ç¤ºä¾‹ï¼š`2d4eff6e-f4ca-4dc6-b776-1d838b8cefb5`
"#;

/// æ¶ˆæ¯æ¶¦è‰²ç³»ç»Ÿæç¤ºè¯ - ç”¨äºå°†æŠ€æœ¯æ€§å†…å®¹è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„è¡¨è¾¾
pub const MESSAGE_POLISH_SYSTEM_PROMPT: &str = "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡æœ¬æ¶¦è‰²åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†æŠ€æœ¯æ€§çš„è¾“å‡ºå†…å®¹è½¬æ¢ä¸ºæ›´äººæ€§åŒ–ã€æ›´æµç•…çš„è¡¨è¾¾ï¼ŒåŒæ—¶ä¿æŒä¿¡æ¯çš„å‡†ç¡®æ€§ã€‚";

/// æ¶ˆæ¯æ¶¦è‰²ç”¨æˆ·æç¤ºè¯æ¨¡æ¿
pub const MESSAGE_POLISH_USER_TEMPLATE: &str = r#"è¯·å°†ä»¥ä¸‹{message_type}å†…å®¹æ¶¦è‰²ä¸ºæ›´äººæ€§åŒ–ã€æ›´æµç•…çš„è¡¨è¾¾ï¼š

åŸå§‹å†…å®¹ï¼š
{raw_message}

æ¶¦è‰²è¦æ±‚ï¼š
1. ä¿æŒæ‰€æœ‰å…³é”®ä¿¡æ¯å’Œæ•°æ®çš„å‡†ç¡®æ€§
2. ä½¿ç”¨æ›´è‡ªç„¶ã€å‹å¥½çš„è¯­è¨€
3. æ·»åŠ é€‚å½“çš„è¿‡æ¸¡è¯ï¼Œè®©å†…å®¹æ›´æµç•…
4. ä¿æŒç®€æ´ï¼Œä¸è¦è¿‡åº¦å†—é•¿ï¼Œæ§åˆ¶åœ¨2-3å¥è¯ä»¥å†…
5. å¯ä»¥ä½¿ç”¨é€‚å½“çš„ emoji å¢å¼ºè¡¨ç°åŠ›ï¼ˆä½†ä¸è¦è¿‡åº¦ï¼Œæœ€å¤š2-3ä¸ªï¼‰
6. ç›´æ¥è¾“å‡ºæ¶¦è‰²åçš„å†…å®¹ï¼Œä¸è¦æœ‰å…¶ä»–è§£é‡Š
7. **ä¸¥æ ¼ç¦æ­¢ä½¿ç”¨ä»¥ä¸‹è¯æ±‡å’Œè¡¨è¾¾æ–¹å¼**ï¼š
   - **"æ­£åœ¨æ€è€ƒ"ã€"è¯·ç¨å€™"ã€"æ­£åœ¨å‡†å¤‡ä¸­"ã€"å¾ˆå¿«å°±èƒ½å¼€å§‹"**ç­‰ä»»ä½•ç­‰å¾…æç¤ºæ–‡å­—
   - "ä»»åŠ¡æ­£åœ¨æ’é˜Ÿä¸­"ã€"æ’é˜Ÿ"ã€"è¯·ç¨ç­‰ç‰‡åˆ»"ç­‰ç­‰å¾…ç±»è¯æ±‡
   - "å½“ç„¶ï¼ä»¥ä¸‹æ˜¯"ã€"å¥½çš„ï¼è¿™æ˜¯"ç­‰å®¢å¥—å¼€åœºç™½
   - "æ¶¦è‰²"ã€"ä¼˜åŒ–"ç­‰å…ƒè¯­è¨€è¯æ±‡
   - ä½¿ç”¨æ›´ç›´æ¥ã€æ›´è‡ªç„¶çš„è¡¨è¾¾ï¼Œä¾‹å¦‚ï¼š
     * "æ­£åœ¨åˆ†æ..." è€Œä¸æ˜¯ "æ­£åœ¨æ€è€ƒï¼Œè¯·ç¨å€™"
     * "å¼€å§‹å¤„ç†..." è€Œä¸æ˜¯ "å½“ç„¶ï¼ä»¥ä¸‹æ˜¯åˆ†æç»“æœ"
     * ç›´æ¥è¯´æ˜æ­£åœ¨åšä»€ä¹ˆï¼Œè€Œä¸æ˜¯æè¿°è¿‡ç¨‹æœ¬èº«
8. **è¾“å‡ºæ ¼å¼è¦æ±‚**ï¼š
   - **ç®€å•æè¿°** â†’ ç›´æ¥ç”¨ç®€çŸ­æ–‡æœ¬ï¼ˆ1-2å¥è¯ï¼‰ï¼Œä¸è¦å¼ºè¡Œç”¨åˆ—è¡¨
   - **ç»“æ„åŒ–æ•°æ®** â†’ ä½¿ç”¨è¡¨æ ¼ï¼ˆå‚æ•°ã€é…ç½®ã€ç»Ÿè®¡ç­‰ï¼‰
   - **å¤šé¡¹å†…å®¹** â†’ ä½¿ç”¨åˆ—è¡¨ï¼ˆå¤šä¸ªæ–‡ä»¶ã€å¤šä¸ªæˆæœç­‰ï¼‰
   - **ç¦æ­¢æ»¥ç”¨åˆ—è¡¨** - ä¸è¦æŠŠç®€å•çš„æ‰§è¡Œæè¿°ä¹Ÿå¡è¿›åˆ—è¡¨
9. ç´§å‡‘ç®€æ´ï¼Œé¿å…ä½¿ç”¨è¿‡å¤šæ¢è¡Œç¬¦ï¼Œå¤šä¸ªçŸ­å¥ç”¨é¡¿å·æˆ–é€—å·è¿æ¥è€Œä¸æ˜¯æ¢è¡Œ

æ¶¦è‰²åçš„å†…å®¹ï¼š
"#;

/// æ¶ˆæ¯æ¨¡æ¿æ„å»ºå™¨
pub struct MessageTemplateBuilder {
    /// ç»Ÿä¸€çš„åœºæ™¯ç®¡ç†å™¨
    scene_manager: SceneManager,
}

impl Default for MessageTemplateBuilder {
    fn default() -> Self {
        Self::new()
    }
}

impl MessageTemplateBuilder {
    /// åˆ›å»ºæ–°çš„æ¶ˆæ¯æ¨¡æ¿æ„å»ºå™¨
    pub fn new() -> Self {
        Self {
            scene_manager: SceneManager::new(),
        }
    }
    /// æ„å»ºè¾“å‡ºé£æ ¼è½¬æ¢æç¤ºè¯
    pub fn build_output_style_prompt(content: &str, max_length: usize) -> String {
        OUTPUT_STYLE_TEMPLATE
            .replace("{content}", content)
            .replace("{max_length}", &max_length.to_string())
    }

    /// æ„å»ºå·¥å…·ç­›é€‰é˜¶æ®µæ¶ˆæ¯æç¤ºè¯
    ///
    /// # å‚æ•°
    /// - `task_description`: ä»»åŠ¡æè¿°
    /// - `tool_count`: å·¥å…·æ•°é‡
    /// - `task_type`: ä»»åŠ¡ç±»å‹ï¼ˆç”¨äºåœºæ™¯åŒ¹é…ï¼‰
    pub fn build_tool_selection_message(
        &self,
        task_description: &str,
        tool_count: usize,
        task_type: Option<&str>,
    ) -> String {
        let scene_guidance = self.scene_manager.get_message_guidance(task_type);

        TOOL_SELECTION_MESSAGE_TEMPLATE
            .replace("{task_description}", task_description)
            .replace("{tool_count}", &tool_count.to_string())
            .replace("{scene_specific_guidance}", scene_guidance)
    }

    /// æ„å»ºä»»åŠ¡è§„åˆ’é˜¶æ®µæ¶ˆæ¯æç¤ºè¯
    pub fn build_task_planning_message(
        task_description: &str,
        tool_count: usize,
        step_count: usize,
    ) -> String {
        TASK_PLANNING_MESSAGE_TEMPLATE
            .replace("{task_description}", task_description)
            .replace("{tool_count}", &tool_count.to_string())
            .replace("{step_count}", &step_count.to_string())
    }

    /// æ„å»ºé‡æ–°è§„åˆ’é˜¶æ®µæ¶ˆæ¯æç¤ºè¯
    pub fn build_replanning_message(issue: &str) -> String {
        REPLANNING_MESSAGE_TEMPLATE.replace("{issue}", issue)
    }

    /// æ„å»ºæ­¥éª¤å®Œæˆè¿›åº¦æŠ¥å‘Šæç¤ºè¯
    ///
    /// # å‚æ•°
    /// - `task_description`: ä»»åŠ¡æè¿°
    /// - `completed_step_name`: å·²å®Œæˆçš„æ­¥éª¤åç§°
    /// - `step_output`: æ­¥éª¤è¾“å‡º
    /// - `step_index`: å½“å‰æ­¥éª¤ç´¢å¼•
    /// - `total_steps`: æ€»æ­¥éª¤æ•°
    /// - `next_step_name`: ä¸‹ä¸€æ­¥éª¤åç§°
    /// - `task_type`: ä»»åŠ¡ç±»å‹ï¼ˆç”¨äºåœºæ™¯åŒ¹é…ï¼‰
    pub fn build_step_completed_message(
        &self,
        task_description: &str,
        completed_step_name: &str,
        step_output: &str,
        step_index: usize,
        total_steps: usize,
        next_step_name: &str,
        task_type: Option<&str>,
    ) -> String {
        let scene_guidance = self.scene_manager.get_message_guidance(task_type);

        STEP_COMPLETED_MESSAGE_TEMPLATE
            .replace("{task_description}", task_description)
            .replace("{completed_step_name}", completed_step_name)
            .replace("{step_output}", step_output)
            .replace("{step_index}", &step_index.to_string())
            .replace("{total_steps}", &total_steps.to_string())
            .replace("{next_step_name}", next_step_name)
            .replace("{scene_specific_guidance}", scene_guidance)
    }

    /// æ„å»ºè¯„ä¼°ç»“æœæ¶ˆæ¯æç¤ºè¯
    ///
    /// # å‚æ•°
    /// - `step_name`: æ­¥éª¤åç§°
    /// - `step_output`: æ­¥éª¤è¾“å‡º
    /// - `score`: è¯„åˆ†
    /// - `is_successful`: æ˜¯å¦æˆåŠŸ
    /// - `step_index`: å½“å‰æ­¥éª¤ç´¢å¼•
    /// - `total_steps`: æ€»æ­¥éª¤æ•°
    /// - `next_step_name`: ä¸‹ä¸€æ­¥éª¤åç§°
    /// - `successes`: æˆåŠŸè¦ç‚¹
    /// - `failures`: å¤±è´¥åŸå› 
    /// - `task_type`: ä»»åŠ¡ç±»å‹ï¼ˆç”¨äºåœºæ™¯åŒ¹é…ï¼‰
    pub fn build_evaluation_result_message(
        &self,
        step_name: &str,
        step_output: &str,
        score: u32,
        is_successful: bool,
        step_index: usize,
        total_steps: usize,
        next_step_name: &str,
        successes: &str,
        failures: &str,
        task_type: Option<&str>,
    ) -> String {
        let scene_guidance = self.scene_manager.get_message_guidance(task_type);

        EVALUATION_RESULT_MESSAGE_TEMPLATE
            .replace("{step_name}", step_name)
            .replace("{step_output}", step_output)
            .replace("{score}", &score.to_string())
            .replace("{is_successful}", &is_successful.to_string())
            .replace("{step_index}", &step_index.to_string())
            .replace("{total_steps}", &total_steps.to_string())
            .replace("{next_step_name}", next_step_name)
            .replace("{successes}", successes)
            .replace("{failures}", failures)
            .replace("{scene_specific_guidance}", scene_guidance)
    }

    /// æ„å»ºä»»åŠ¡å®Œæˆæ¶ˆæ¯æç¤ºè¯
    pub fn build_task_completion_message(
        task_description: &str,
        completed_steps: &str,
        overall_score: u32,
    ) -> String {
        TASK_COMPLETION_MESSAGE_TEMPLATE
            .replace("{task_description}", task_description)
            .replace("{completed_steps}", completed_steps)
            .replace("{overall_score}", &overall_score.to_string())
    }

    /// æ„å»ºæ¶ˆæ¯æ¶¦è‰²æç¤ºè¯
    pub fn build_message_polish_prompt(
        message_type: &str,
        raw_message: &str,
    ) -> (String, String) {
        let user_prompt = MESSAGE_POLISH_USER_TEMPLATE
            .replace("{message_type}", message_type)
            .replace("{raw_message}", raw_message);

        (MESSAGE_POLISH_SYSTEM_PROMPT.to_string(), user_prompt)
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_build_output_style_prompt() {
        let prompt = MessageTemplateBuilder::build_output_style_prompt("æµ‹è¯•å†…å®¹", 50);
        assert!(prompt.contains("æµ‹è¯•å†…å®¹"));
        assert!(prompt.contains("50"));
    }

    #[test]
    fn test_build_tool_selection_message() {
        let builder = MessageTemplateBuilder::new();
        let message = builder.build_tool_selection_message("åˆ›å»ºæ¨¡å‹", 10, None);
        assert!(message.contains("åˆ›å»ºæ¨¡å‹"));
        assert!(message.contains("10"));
        assert!(message.contains("åœºæ™¯æŒ‡å¯¼"));
    }

    #[test]
    fn test_build_task_planning_message() {
        let message = MessageTemplateBuilder::build_task_planning_message("æµ‹è¯•ä»»åŠ¡", 5, 3);
        assert!(message.contains("æµ‹è¯•ä»»åŠ¡"));
        assert!(message.contains("5"));
        assert!(message.contains("3"));
    }

    #[test]
    fn test_build_replanning_message() {
        let message = MessageTemplateBuilder::build_replanning_message("å·¥å…·æœªæ‰¾åˆ°");
        assert!(message.contains("å·¥å…·æœªæ‰¾åˆ°"));
    }

    #[test]
    fn test_message_template_builder_new() {
        let _builder = MessageTemplateBuilder::new();
        // åªéªŒè¯å¯ä»¥æˆåŠŸåˆ›å»º
    }

    #[test]
    fn test_build_step_completed_message() {
        let builder = MessageTemplateBuilder::new();
        let message = builder.build_step_completed_message(
            "æ•´ä½“ä»»åŠ¡",
            "æ­¥éª¤1",
            "æˆåŠŸ",
            1,
            3,
            "æ­¥éª¤2",
            None,
        );
        assert!(message.contains("æ•´ä½“ä»»åŠ¡"));
        assert!(message.contains("æ­¥éª¤1"));
        assert!(message.contains("æˆåŠŸ"));
        assert!(message.contains("1"));
        assert!(message.contains("3"));
        assert!(message.contains("æ­¥éª¤2"));
        assert!(message.contains("åœºæ™¯æŒ‡å¯¼"));
    }

    #[test]
    fn test_build_evaluation_result_message() {
        let builder = MessageTemplateBuilder::new();
        let message = builder.build_evaluation_result_message(
            "æµ‹è¯•æ­¥éª¤",
            "è¾“å‡ºç»“æœ",
            95,
            true,
            2,
            5,
            "ä¸‹ä¸€æ­¥",
            "æˆåŠŸè¦ç‚¹",
            "å¤±è´¥åŸå› ",
            None,
        );
        assert!(message.contains("æµ‹è¯•æ­¥éª¤"));
        assert!(message.contains("95"));
        assert!(message.contains("true"));
        assert!(message.contains("åœºæ™¯æŒ‡å¯¼"));
    }

    #[test]
    fn test_build_task_completion_message() {
        let message =
            MessageTemplateBuilder::build_task_completion_message("å®Œæˆçš„ä»»åŠ¡", "æ­¥éª¤åˆ—è¡¨", 90);
        assert!(message.contains("å®Œæˆçš„ä»»åŠ¡"));
        assert!(message.contains("æ­¥éª¤åˆ—è¡¨"));
        assert!(message.contains("90"));
    }

    #[test]
    fn test_build_message_polish_prompt() {
        let (system, user) =
            MessageTemplateBuilder::build_message_polish_prompt("è¿›åº¦æŠ¥å‘Š", "åŸå§‹æ¶ˆæ¯");
        assert!(system.contains("æ¶¦è‰²åŠ©æ‰‹"));
        assert!(user.contains("è¿›åº¦æŠ¥å‘Š"));
        assert!(user.contains("åŸå§‹æ¶ˆæ¯"));
    }

    #[test]
    fn test_message_templates_constants() {
        assert!(!OUTPUT_STYLE_TEMPLATE.is_empty());
        assert!(!TOOL_SELECTION_MESSAGE_TEMPLATE.is_empty());
        assert!(!TASK_PLANNING_MESSAGE_TEMPLATE.is_empty());
        assert!(!REPLANNING_MESSAGE_TEMPLATE.is_empty());
        assert!(!STEP_COMPLETED_MESSAGE_TEMPLATE.is_empty());
        assert!(!EVALUATION_RESULT_MESSAGE_TEMPLATE.is_empty());
        assert!(!TASK_COMPLETION_MESSAGE_TEMPLATE.is_empty());
        assert!(!MESSAGE_POLISH_SYSTEM_PROMPT.is_empty());
        assert!(!MESSAGE_POLISH_USER_TEMPLATE.is_empty());
    }

    #[test]
    fn test_tool_selection_message_with_scene_guidance() {
        let builder = MessageTemplateBuilder::new();
        let message = builder.build_tool_selection_message(
            "åˆ›å»ºå·¥å…·",
            15,
            Some("å·¥å…·ç®¡ç†"),
        );
        assert!(message.contains("åˆ›å»ºå·¥å…·"));
        assert!(message.contains("15"));
        assert!(message.contains("åœºæ™¯æŒ‡å¯¼"));
        // éªŒè¯åŒ…å«å·¥å…·ç®¡ç†åœºæ™¯çš„ç‰¹å®šæŒ‡å¯¼
        assert!(message.contains("å·¥å…·ç®¡ç†") || message.contains("åœºæ™¯"));
    }

    #[test]
    fn test_step_completed_message_with_scene_guidance() {
        let builder = MessageTemplateBuilder::new();
        let message = builder.build_step_completed_message(
            "æ•°å­—å­ªç”Ÿå»ºæ¨¡",
            "BMSæ•°æ®é‡‡é›†",
            "{\"success\": true, \"msg\": \"é‡‡é›†æˆåŠŸ\"}",
            1,
            5,
            "å‡ ä½•å»ºæ¨¡",
            Some("è‡ªç„¶è¯­è¨€å»ºæ¨¡"),
        );
        assert!(message.contains("æ•°å­—å­ªç”Ÿå»ºæ¨¡"));
        assert!(message.contains("BMSæ•°æ®é‡‡é›†"));
        assert!(message.contains("åœºæ™¯æŒ‡å¯¼"));
    }

    #[test]
    fn test_evaluation_result_message_with_scene_guidance() {
        let builder = MessageTemplateBuilder::new();
        let message = builder.build_evaluation_result_message(
            "æ•°æ®é‡‡é›†",
            "é‡‡é›†å®Œæˆ",
            92,
            true,
            1,
            3,
            "æ•°æ®åˆ†æ",
            "æˆåŠŸé‡‡é›†æ•°æ®",
            "æ— ",
            Some("æ•°æ®åˆ†æ"),
        );
        assert!(message.contains("æ•°æ®é‡‡é›†"));
        assert!(message.contains("92"));
        assert!(message.contains("åœºæ™¯æŒ‡å¯¼"));
    }
}
