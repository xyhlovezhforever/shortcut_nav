# 01 - 项目概述与技术栈

> **文档版本**: v1.0
> **创建日期**: 2026-01-05
> **迁移优先级**: ⭐⭐⭐⭐⭐ (最高)

---

## 1. 项目定位

### 1.1 项目名称
**Task Orchestration Service** (任务编排服务)

### 1.2 核心定位
基于 **Reflective Planning** (反思式规划) 架构的智能任务编排服务，能够：
- 接收用户的自然语言任务描述
- 自动规划执行步骤
- 调用外部工具服务执行
- 智能评估执行结果
- 失败时自动反思并重新规划

### 1.3 核心价值
```
用户任务 → 智能规划 → 自动执行 → 结果评估 → (失败)反思重规划 → 最终结果
```

---

## 2. 核心功能清单

### 2.1 任务编排能力
| 功能 | 描述 |
|------|------|
| **LLM规划** | 基于大语言模型自动分解任务为执行步骤 |
| **两阶段规划** | 先筛选工具，再详细规划，优化Token消耗 |
| **工具调用** | 调用外部工具服务执行具体任务 |
| **参数流转** | 步骤间数据自动传递，支持占位符引用 |
| **并行执行** | 基于DAG分析，无依赖步骤并行执行 |

### 2.2 智能容错能力
| 功能 | 描述 |
|------|------|
| **执行评估** | LLM评估任务执行质量，判断是否成功 |
| **失败反思** | 分析失败原因，提供改进建议 |
| **分层恢复** | 参数调整 → 工具替换 → 单步修复 → 整体重规划 |
| **智能重规划** | 根据反思结果生成新的执行计划 |

### 2.3 场景感知能力
| 功能 | 描述 |
|------|------|
| **意图识别** | 从任务描述中提取明确意图 |
| **语义路由** | 根据意图自动匹配场景类型 |
| **场景提示词** | 不同场景使用不同的专属提示词指导 |
| **标准流程匹配** | 自动匹配预定义的标准任务流程 |

### 2.4 服务能力
| 功能 | 描述 |
|------|------|
| **REST API** | HTTP接口，支持任务创建、查询、取消 |
| **gRPC服务** | 高性能RPC接口，支持流式事件推送 |
| **服务发现** | Consul集成，动态服务注册与发现 |
| **审计日志** | Kafka持久化关键事件 |

---

## 3. 技术栈

### 3.1 编程语言
- **Rust** (Edition 2021)
- 异步编程模型 (async/await)
- 强类型系统保障

### 3.2 核心框架

| 类别 | 框架/库 | 版本 | 用途 |
|------|--------|------|------|
| **Web框架** | Axum | 0.7 | HTTP服务器，REST API |
| **gRPC框架** | Tonic | 0.11 | gRPC服务端/客户端 |
| **异步运行时** | Tokio | 1.35 | 异步任务调度 |
| **中间件** | Tower | 0.4 | HTTP中间件 |
| **HTTP客户端** | Reqwest | 0.11 | 调用外部HTTP服务 |

### 3.3 序列化与配置

| 类别 | 框架/库 | 版本 | 用途 |
|------|--------|------|------|
| **序列化** | Serde | 1.0 | JSON/TOML序列化 |
| **JSON处理** | serde_json | 1.0 | JSON解析与生成 |
| **TOML处理** | toml | 0.8 | 配置文件解析 |
| **配置管理** | config | 0.14 | 多源配置加载 |
| **Proto编译** | Prost | 0.12 | Protocol Buffers |

### 3.4 并发与状态管理

| 类别 | 框架/库 | 版本 | 用途 |
|------|--------|------|------|
| **并发HashMap** | DashMap | 5.5 | 线程安全的HashMap |
| **高效锁** | parking_lot | 0.12 | 比std更高效的锁 |
| **异步trait** | async-trait | 0.1 | 异步trait支持 |
| **流处理** | futures-util | 0.3 | Future组合器 |

### 3.5 日志与监控

| 类别 | 框架/库 | 版本 | 用途 |
|------|--------|------|------|
| **结构化日志** | tracing | 0.1 | 日志记录 |
| **日志订阅** | tracing-subscriber | 0.3 | 日志输出配置 |
| **日志追加** | tracing-appender | 0.2 | 文件日志滚动 |

### 3.6 其他依赖

| 类别 | 框架/库 | 版本 | 用途 |
|------|--------|------|------|
| **时间处理** | chrono | 0.4 | 日期时间 |
| **UUID生成** | uuid | 1.6 | 唯一标识生成 |
| **正则表达式** | regex | 1.10 | 字符串模式匹配 |
| **终端颜色** | colored | 2.1 | 彩色日志输出 |
| **随机数** | rand | 0.8 | 随机数生成 |

### 3.7 可选依赖

| 类别 | 框架/库 | 版本 | 用途 | Feature |
|------|--------|------|------|---------|
| **消息队列** | rdkafka | 0.36 | Kafka客户端 | `kafka` |

---

## 4. Cargo.toml 模板

```toml
[package]
name = "task-orchestration-service"
version = "0.1.0"
edition = "2021"
authors = ["Task Orchestration Team"]
description = "A production-grade task orchestration service with Reflective Planning"

[dependencies]
# Web 框架
axum = "0.7"
tokio = { version = "1.35", features = ["full"] }
tokio-stream = "0.1"
tower = "0.4"
tower-http = { version = "0.5", features = ["trace", "cors", "timeout", "limit"] }

# gRPC
tonic = "0.11"
prost = "0.12"
prost-types = "0.12"

# HTTP 客户端
reqwest = { version = "0.11", features = ["json"] }

# 序列化/反序列化
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
toml = "0.8"

# 配置管理
config = "0.14"

# 日志和追踪
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["env-filter", "json"] }
tracing-appender = "0.2"

# 错误处理
thiserror = "1.0"
anyhow = "1.0"

# 时间处理
chrono = { version = "0.4", features = ["serde"] }

# 静态变量
lazy_static = "1.4"

# UUID 生成
uuid = { version = "1.6", features = ["v4", "serde"] }

# 并发控制
dashmap = "5.5"
parking_lot = "0.12"

# 异步 trait
async-trait = "0.1"

# 随机数生成
rand = "0.8"

# 流处理
futures-util = "0.3"

# 终端颜色输出
colored = "2.1"

# 正则表达式
regex = "1.10"

# Kafka 支持（可选）
rdkafka = { version = "0.36", optional = true, features = ["cmake-build"] }

[build-dependencies]
tonic-build = "0.11"

[features]
default = []
kafka = ["rdkafka"]

[profile.release]
opt-level = 3
lto = true
codegen-units = 1
strip = true

# 可执行文件配置
[[bin]]
name = "task-orchestration-service"
path = "src/main.rs"

[[bin]]
name = "task-orchestration-service-grpc"
path = "src/main_grpc.rs"
```

---

## 5. 项目目录结构

```
task-orchestration-service/
├── src/
│   ├── main.rs                 # HTTP服务入口
│   ├── main_grpc.rs            # gRPC服务入口
│   ├── lib.rs                  # 库入口
│   │
│   ├── core/                   # 核心业务模块 (~10,000行)
│   │   ├── mod.rs
│   │   ├── orchestrator.rs     # 编排器核心 (~2,500行)
│   │   ├── planner.rs          # 任务规划器 (~2,200行)
│   │   ├── executor.rs         # 任务执行器 (~2,200行)
│   │   ├── evaluator.rs        # 结果评估器 (~600行)
│   │   ├── reflector.rs        # 反思分析器 (~1,200行)
│   │   ├── parameter_resolver.rs # 参数解析器 (~1,300行)
│   │   ├── execution_context.rs  # 执行上下文 (~550行)
│   │   └── parallel_executor.rs  # 并行执行器 (~900行)
│   │
│   ├── llm/                    # LLM交互模块 (~5,000行)
│   │   ├── mod.rs
│   │   ├── client.rs           # HTTP LLM客户端
│   │   ├── grpc_client.rs      # gRPC LLM客户端
│   │   ├── unified_client.rs   # 统一客户端
│   │   ├── traits.rs           # 客户端trait
│   │   ├── prompts.rs          # 提示词入口
│   │   ├── planning_prompts.rs # 规划提示词
│   │   ├── selection_prompts.rs # 工具筛选提示词
│   │   ├── evaluation_prompts.rs # 评估提示词
│   │   ├── reflection_prompts.rs # 反思提示词
│   │   ├── replanning_prompts.rs # 重规划提示词
│   │   ├── scene_guidance.rs   # 场景管理
│   │   └── message_templates.rs # 消息模板
│   │
│   ├── tool/                   # 工具服务模块 (~1,600行)
│   │   ├── mod.rs
│   │   ├── client.rs           # HTTP工具客户端
│   │   ├── grpc_client.rs      # gRPC工具客户端
│   │   └── unified_client.rs   # 统一客户端
│   │
│   ├── api/                    # REST API模块 (~400行)
│   │   ├── mod.rs
│   │   ├── handlers.rs         # 请求处理器
│   │   ├── models.rs           # 数据模型
│   │   └── health.rs           # 健康检查
│   │
│   ├── grpc/                   # gRPC服务模块 (~1,400行)
│   │   ├── mod.rs
│   │   └── server.rs           # gRPC服务实现
│   │
│   ├── state/                  # 状态管理模块 (~400行)
│   │   ├── mod.rs
│   │   └── task_state.rs       # 任务状态管理
│   │
│   ├── config/                 # 配置模块 (~600行)
│   │   └── mod.rs              # 配置定义与加载
│   │
│   ├── workflow/               # 工作流模块 (~400行)
│   │   └── mod.rs              # 标准流程管理
│   │
│   ├── consul/                 # Consul模块 (~600行)
│   │   ├── mod.rs
│   │   ├── registry.rs         # 服务注册
│   │   └── discovery.rs        # 服务发现
│   │
│   ├── kafka/                  # Kafka模块 (~800行)
│   │   ├── mod.rs
│   │   ├── producer.rs         # 生产者
│   │   ├── consumer.rs         # 消费者
│   │   └── audit.rs            # 审计日志
│   │
│   ├── database/               # 数据库模块 (~450行)
│   │   ├── mod.rs
│   │   ├── client.rs           # 数据库客户端
│   │   └── service.rs          # 数据库服务
│   │
│   ├── logging/                # 日志模块 (~500行)
│   │   ├── mod.rs              # 日志初始化
│   │   └── kafka_logger.rs     # Kafka日志
│   │
│   ├── utils/                  # 工具模块 (~800行)
│   │   ├── mod.rs
│   │   ├── errors.rs           # 错误类型
│   │   ├── debug_logger.rs     # 调试日志
│   │   └── string_utils.rs     # 字符串工具
│   │
│   ├── message_formatter.rs    # 消息格式化 (~600行)
│   └── ai_reporter.rs          # AI报告生成 (~220行)
│
├── proto/                      # Proto定义文件
│   ├── task_orchestrator_service.proto
│   ├── tool_service.proto
│   ├── llm_service.proto
│   ├── database.proto
│   └── kafka_service.proto
│
├── config/                     # 配置文件目录
│   └── task_workflows.toml     # 标准工作流定义
│
├── examples/                   # 示例代码
│   ├── load_prediction_test.rs
│   ├── auto_modeling_test.rs
│   └── ...
│
├── Cargo.toml                  # 项目配置
├── build.rs                    # 构建脚本
├── config.toml                 # 默认配置
├── config.dev.toml             # 开发配置
└── config.prod.toml            # 生产配置
```

---

## 6. 代码规模统计

### 6.1 按模块统计

| 模块 | 代码行数 | 占比 | 核心程度 |
|------|---------|------|---------|
| **core/** | ~10,430行 | 35% | ⭐⭐⭐⭐⭐ |
| **llm/** | ~5,000行 | 17% | ⭐⭐⭐⭐⭐ |
| **tool/** | ~1,600行 | 5% | ⭐⭐⭐⭐ |
| **grpc/** | ~1,400行 | 5% | ⭐⭐⭐⭐ |
| **kafka/** | ~800行 | 3% | ⭐⭐⭐ |
| **consul/** | ~600行 | 2% | ⭐⭐⭐ |
| **其他** | ~8,600行 | 29% | ⭐⭐ |
| **总计** | ~29,500行 | 100% | - |

### 6.2 核心文件 TOP 10

| 排名 | 文件 | 代码行数 | 功能 |
|------|------|---------|------|
| 1 | core/orchestrator.rs | ~2,500行 | 编排核心 |
| 2 | core/executor.rs | ~2,200行 | 执行器 |
| 3 | core/planner.rs | ~2,200行 | 规划器 |
| 4 | grpc/server.rs | ~1,400行 | gRPC服务 |
| 5 | core/parameter_resolver.rs | ~1,300行 | 参数解析 |
| 6 | core/reflector.rs | ~1,200行 | 反思器 |
| 7 | llm/message_templates.rs | ~900行 | 消息模板 |
| 8 | core/parallel_executor.rs | ~900行 | 并行执行 |
| 9 | tool/grpc_client.rs | ~750行 | 工具客户端 |
| 10 | llm/planning_prompts.rs | ~700行 | 规划提示词 |

---

## 7. 外部服务依赖

### 7.1 必须依赖

| 服务 | 用途 | 接口类型 |
|------|------|---------|
| **LLM服务** | 任务规划、评估、反思 | HTTP/gRPC |
| **Tool Service** | 工具定义查询、工具执行 | HTTP/gRPC |

### 7.2 可选依赖

| 服务 | 用途 | 接口类型 | 配置开关 |
|------|------|---------|---------|
| **Consul** | 服务发现 | HTTP | `consul.enabled` |
| **Kafka** | 审计日志 | Kafka协议 | feature `kafka` |
| **Database Service** | 数据存储 | gRPC | 按需 |

---

## 8. 迁移检查项

- [ ] Rust工具链安装 (Edition 2021)
- [ ] 创建Cargo.toml
- [ ] 配置Proto编译 (build.rs)
- [ ] 创建目录结构
- [ ] 配置外部服务连接
- [ ] 编写配置文件

---

## 下一步

阅读 [02-核心架构设计.md](./02-核心架构设计.md) 了解系统的核心架构设计。
