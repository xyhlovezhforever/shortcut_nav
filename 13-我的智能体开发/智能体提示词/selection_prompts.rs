//! å·¥å…·ç­›é€‰æç¤ºè¯æ¨¡å—
//!
//! åŒ…å«ç”¨äºä¸¤é˜¶æ®µè§„åˆ’çš„å·¥å…·ç­›é€‰é˜¶æ®µçš„æç¤ºè¯æ¨¡æ¿å’Œæ„å»ºå™¨
//!
//! # åŠŸèƒ½ç‰¹æ€§
//!
//! - æ”¯æŒåŠ¨æ€ç›¸ä¼¼åº¦é˜ˆå€¼é…ç½®
//! - æ”¯æŒæ„å›¾è¯†åˆ«ä¼˜å…ˆçº§
//! - æ”¯æŒä¸¥æ ¼åº¦æ¨¡å¼åˆ‡æ¢(æä¸¥æ ¼/ä¸¥æ ¼/é€‚ä¸­/å®½æ¾)
//! - æ”¯æŒå…ƒæ•°æ®æ³¨å…¥
//! - æ”¯æŒåœºæ™¯æ„ŸçŸ¥çš„ç­›é€‰æŒ‡å¯¼
//! - ğŸ†• æ”¯æŒåŒæ¨¡å¼å·¥å…·ç­›é€‰ï¼ˆé¦–æ¬¡è§„åˆ’ vs é‡æ–°è§„åˆ’ï¼‰

use super::scene_guidance::SceneManager;
use serde::{Deserialize, Serialize};

// ==================== å·¥å…·ç­›é€‰åœºæ™¯ç±»å‹ ====================

/// å·¥å…·ç­›é€‰çš„åœºæ™¯ç±»å‹
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum ToolSelectionScenario {
    /// é¦–æ¬¡è§„åˆ’ï¼šåŸºäºéœ€æ±‚é¢„æµ‹å·¥å…·
    InitialPlanning,
    /// é‡æ–°è§„åˆ’ï¼šåŸºäºæ‰§è¡Œåé¦ˆä¿®æ­£å·¥å…·é€‰æ‹©
    Replanning,
    /// ç»§ç»­è§„åˆ’ï¼šåŸºäºæ‰§è¡Œå†å²å’Œå‰©ä½™ä»»åŠ¡ç­›é€‰å·¥å…·
    ContinuePlanning,
}

/// é‡æ–°è§„åˆ’æ—¶çš„å·¥å…·ç­›é€‰ä¸Šä¸‹æ–‡
#[derive(Debug, Clone)]
pub struct ReplanningToolSelectionContext {
    /// ä¹‹å‰ç­›é€‰çš„å·¥å…·åˆ—è¡¨ï¼ˆå·¥å…·ID -> å·¥å…·ä¿¡æ¯ï¼‰
    pub previous_tools: Vec<PreviousToolInfo>,
    /// æ‰§è¡Œå†å²
    pub execution_history: String,
    /// åæ€åˆ†æç»“æœ
    pub reflection_analysis: String,
    /// æ•´ä½“åæ€æŒ‡å¯¼
    pub overall_reflection_guidance: Option<String>,
}

/// ä¹‹å‰ä½¿ç”¨çš„å·¥å…·ä¿¡æ¯
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct PreviousToolInfo {
    /// å·¥å…·ID
    pub tool_id: String,
    /// å·¥å…·åç§°
    pub tool_name: String,
    /// æ‰§è¡ŒçŠ¶æ€ï¼ˆSuccess / Failed / NotUsedï¼‰
    pub execution_status: String,
    /// å¤±è´¥åŸå› ï¼ˆå¦‚æœå¤±è´¥ï¼‰
    pub failure_reason: Option<String>,
    /// æ‰§è¡Œæ•ˆæœæ‘˜è¦
    pub execution_summary: Option<String>,
}

impl ReplanningToolSelectionContext {
    /// åˆ›å»ºæ–°çš„é‡æ–°è§„åˆ’å·¥å…·ç­›é€‰ä¸Šä¸‹æ–‡
    pub fn new(
        previous_tools: Vec<PreviousToolInfo>,
        execution_history: String,
        reflection_analysis: String,
    ) -> Self {
        Self {
            previous_tools,
            execution_history,
            reflection_analysis,
            overall_reflection_guidance: None,
        }
    }

    /// è®¾ç½®æ•´ä½“åæ€æŒ‡å¯¼
    pub fn set_overall_reflection_guidance(&mut self, guidance: String) {
        self.overall_reflection_guidance = Some(guidance);
    }
}

/// ç»§ç»­è§„åˆ’æ—¶çš„å·¥å…·ç­›é€‰ä¸Šä¸‹æ–‡
#[derive(Debug, Clone)]
pub struct ContinuePlanningToolSelectionContext {
    /// ä¹‹å‰ç­›é€‰çš„å·¥å…·åˆ—è¡¨
    pub previous_tools: Vec<PreviousToolInfo>,
    /// æ‰§è¡Œå†å²ï¼ˆå·²å®Œæˆçš„æ­¥éª¤ï¼‰
    pub execution_history: String,
    /// ç»§ç»­è§„åˆ’çš„åŸå› /ä¸Šä¸‹æ–‡è¯´æ˜
    pub continue_reason: Option<String>,
    /// å‰©ä½™ä»»åŠ¡æè¿°
    pub remaining_tasks: Option<String>,
}

impl ContinuePlanningToolSelectionContext {
    /// åˆ›å»ºæ–°çš„ç»§ç»­è§„åˆ’å·¥å…·ç­›é€‰ä¸Šä¸‹æ–‡
    pub fn new(
        previous_tools: Vec<PreviousToolInfo>,
        execution_history: String,
    ) -> Self {
        Self {
            previous_tools,
            execution_history,
            continue_reason: None,
            remaining_tasks: None,
        }
    }

    /// è®¾ç½®ç»§ç»­è§„åˆ’çš„åŸå› 
    pub fn set_continue_reason(&mut self, reason: String) {
        self.continue_reason = Some(reason);
    }

    /// è®¾ç½®å‰©ä½™ä»»åŠ¡æè¿°
    pub fn set_remaining_tasks(&mut self, tasks: String) {
        self.remaining_tasks = Some(tasks);
    }
}

/// å·¥å…·ç­›é€‰æç¤ºè¯ï¼ˆé˜¶æ®µ1ï¼šå·¥å…·ç­›é€‰ï¼‰
/// æ³¨æ„ï¼šæ­¤æç¤ºè¯ç”¨äºä¸¤é˜¶æ®µè§„åˆ’çš„ç¬¬ä¸€é˜¶æ®µï¼Œä»æ‰€æœ‰å·¥å…·ä¸­å¿«é€Ÿç­›é€‰å‡ºä¸ä»»åŠ¡ç›¸å…³çš„å·¥å…·
pub const TOOL_SELECTION_SYSTEM_PROMPT: &str = r#"ä½ æ˜¯å·¥å…·ç­›é€‰ä¸“å®¶ï¼Œä»å¤§é‡å·¥å…·ä¸­å¿«é€Ÿè¯†åˆ«ä¸ä»»åŠ¡ç›¸å…³çš„å·¥å…·ã€‚

ã€æ ¸å¿ƒä»»åŠ¡ã€‘
**ä¸¥æ ¼åŸºäºä»»åŠ¡æè¿°å’Œå…ƒæ•°æ®**ç­›é€‰å®Œæˆä»»åŠ¡æ‰€éœ€çš„å·¥å…·ï¼Œè¯†åˆ«ä»»åŠ¡ç±»å‹ã€‚
è¿™æ˜¯ä¸¤é˜¶æ®µè§„åˆ’çš„ç¬¬ä¸€æ­¥ï¼Œç»“æœç”¨äºåç»­ä»»åŠ¡åˆ†è§£ã€‚

âš ï¸ **å…³é”®åŸåˆ™ï¼šä¸¥æ ¼åŒ¹é…ï¼Œæ‹’ç»æ¨¡ç³Šä»»åŠ¡**
- åªåŸºäºä»»åŠ¡æè¿°å’Œå…ƒæ•°æ®ä¸­çš„æ˜ç¡®ä¿¡æ¯ç­›é€‰
- ç¦æ­¢é€šè¿‡å·¥å…·åº“ç»„æˆæ¨æ–­ä»»åŠ¡ç±»å‹
- ç¦æ­¢åœ¨ä»»åŠ¡ä¸æ˜ç¡®æ—¶çŒœæµ‹
- ç›¸ä¼¼åº¦ < 30% åº”è¯¥æ‹’ç»

ã€ç­›é€‰èŒè´£ã€‘
1. éªŒè¯ä»»åŠ¡æ¸…æ™°åº¦
2. **ä¼˜å…ˆä»ä»»åŠ¡æè¿°ä¸­æå–æ˜ç¡®çš„æ„å›¾**ï¼ˆå¦‚"æ„å›¾: XXX"ï¼‰
3. ä»ä»»åŠ¡æè¿°å’Œå…ƒæ•°æ®æå–ç›®æ ‡ã€é¢†åŸŸå’Œç±»å‹
4. æ ¹æ®å·¥å…·åˆ†ç±»ã€èƒ½åŠ›åˆ¤æ–­ä¸ä»»åŠ¡çš„ç›¸å…³æ€§
5. å¿«é€ŸåŒ¹é…é«˜åº¦ç›¸å…³å·¥å…·ï¼Œæ’é™¤æ— å…³å·¥å…·
6. ç¡®ä¿è¦†ç›–ä»»åŠ¡æ‰€æœ‰ç¯èŠ‚

ã€ç­›é€‰ç­–ç•¥ - ä¸‰ç§æ¨¡å¼ã€‘

âš ï¸âš ï¸âš ï¸ **æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™ï¼šæ„å›¾è¯†åˆ«å†³å®šç­›é€‰æ¨¡å¼ï¼**

**ç¬¬ä¸€æ­¥ï¼ˆå¼ºåˆ¶ï¼‰ï¼šæ£€æŸ¥ä»»åŠ¡æè¿°ä¸­çš„æ„å›¾æ ‡è®°ï¼Œå†³å®šç­›é€‰æ¨¡å¼**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”´ **æ¨¡å¼Aï¼šæ„å›¾æ˜ç¡® â†’ åˆ†ç±»ä¼˜å…ˆ + è¯­ä¹‰è¡¥å……ï¼ˆæ··åˆç­›é€‰ï¼‰**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å¦‚æœä»»åŠ¡æè¿°åŒ…å«"æ„å›¾: XXX"æ ¼å¼ï¼ˆå¦‚"æ„å›¾: å·¥å…·ç®¡ç†, ç”¨æˆ·è¾“å…¥: ..."ï¼‰ï¼š

**é˜¶æ®µ1ï¼šä¼˜å…ˆæŒ‰åˆ†ç±»ç­›é€‰ï¼ˆä¸»å·¥å…·é›†ï¼‰**
  âœ… **å¿…é¡»**å°† XXX ç›´æ¥ä½œä¸º task_type
  âœ… **ä¼˜å…ˆ**é€‰æ‹©ã€Œåˆ†ç±»ã€å­—æ®µç­‰äº XXX çš„æ‰€æœ‰ç›¸å…³å·¥å…·
  âœ… è¿™æ˜¯ä¸»å·¥å…·é›†ï¼Œç”¨äºæ»¡è¶³æ„å›¾åˆ†ç±»çš„æ ¸å¿ƒéœ€æ±‚

**é˜¶æ®µ2ï¼šè¯­ä¹‰ç›¸ä¼¼åº¦è¡¥å……ï¼ˆè¡¥å……å·¥å…·é›†ï¼‰**
  âš ï¸ **å…³é”®åˆ¤æ–­**ï¼šè¯„ä¼°é˜¶æ®µ1é€‰å‡ºçš„å·¥å…·æ˜¯å¦è¶³ä»¥å®Œæˆç”¨æˆ·è¾“å…¥ä¸­çš„å®é™…ä»»åŠ¡

  å¦‚æœåˆ†ç±»å·¥å…·ä¸è¶³ä»¥è§£å†³å®é™…é—®é¢˜ï¼š
  âœ… ä»**å…¶ä»–åˆ†ç±»**ä¸­é€‰æ‹©ä¸ç”¨æˆ·è¾“å…¥å†…å®¹**è¯­ä¹‰é«˜åº¦ç›¸ä¼¼**çš„å·¥å…·ï¼ˆç›¸ä¼¼åº¦ â‰¥ 75%ï¼‰
  âœ… è¿™äº›æ˜¯è¡¥å……å·¥å…·ï¼Œç”¨äºå¼¥è¡¥åˆ†ç±»å·¥å…·çš„èƒ½åŠ›ç¼ºå£
  âœ… åœ¨ brief_reasoning ä¸­æ˜ç¡®è¯´æ˜å“ªäº›æ˜¯åˆ†ç±»å·¥å…·ã€å“ªäº›æ˜¯è¯­ä¹‰è¡¥å……å·¥å…·

  å¦‚æœåˆ†ç±»å·¥å…·å·²ç»è¶³å¤Ÿï¼š
  âŒ ä¸éœ€è¦æ·»åŠ å…¶ä»–åˆ†ç±»çš„å·¥å…·
  âŒ é¿å…è¿‡åº¦ç­›é€‰

ğŸ”´ **æ ¸å¿ƒåŸåˆ™ï¼šåˆ†ç±»å·¥å…·ä¼˜å…ˆï¼Œè¯­ä¹‰å·¥å…·è¡¥å……ï¼Œç¡®ä¿æ—¢æ»¡è¶³æ„å›¾åˆè§£å†³å®é™…é—®é¢˜ï¼**

âœ… æ­£ç¡®ç¤ºä¾‹ï¼š
  - ä»»åŠ¡ï¼š"æ„å›¾: å·¥å…·ç®¡ç†, ç”¨æˆ·è¾“å…¥: åˆ›å»ºä¸€ä¸ªBIMæ•°å­—å­ªç”Ÿå·¥å…·"
  - é˜¶æ®µ1ï¼šé€‰æ‹©åˆ†ç±»="å·¥å…·ç®¡ç†"çš„å·¥å…·ï¼ˆå¦‚ genesis_document_generate, genesis_tool_registerï¼‰
  - é˜¶æ®µ2åˆ¤æ–­ï¼šå·¥å…·ç®¡ç†çš„å·¥å…·åªèƒ½åˆ›å»ºå·¥å…·é…ç½®æ–‡ä»¶ï¼Œæ— æ³•æä¾›BIMæ•°å­—å­ªç”Ÿçš„å®é™…åŠŸèƒ½
  - é˜¶æ®µ2è¡¥å……ï¼šæ·»åŠ åˆ†ç±»="BIMæ•°æ®å¤„ç†"ã€åŠŸèƒ½="BIMæ•°å­—å­ªç”Ÿç”Ÿæˆ"çš„å·¥å…·ï¼ˆè¯­ä¹‰ç›¸ä¼¼åº¦ > 75%ï¼‰
  - æœ€ç»ˆå·¥å…·é›†ï¼šåˆ†ç±»å·¥å…·ï¼ˆåˆ›å»ºå·¥å…·å¤–å£³ï¼‰ + è¯­ä¹‰å·¥å…·ï¼ˆæä¾›å®é™…åŠŸèƒ½ï¼‰

âœ… æ­£ç¡®ç¤ºä¾‹ï¼š
  - ä»»åŠ¡ï¼š"æ„å›¾: å·¥å…·ç®¡ç†, ç”¨æˆ·è¾“å…¥: æµ‹è¯•è®¾å¤‡å‘Šè­¦è§£æå™¨"
  - é˜¶æ®µ1ï¼šé€‰æ‹©åˆ†ç±»="å·¥å…·ç®¡ç†"çš„å·¥å…·ï¼ˆå¦‚ genesis_tool_testï¼‰
  - é˜¶æ®µ2åˆ¤æ–­ï¼šå·¥å…·ç®¡ç†çš„æµ‹è¯•å·¥å…·è¶³ä»¥æ»¡è¶³æµ‹è¯•éœ€æ±‚
  - é˜¶æ®µ2è¡¥å……ï¼šå¯é€‰æ‹©æ·»åŠ åˆ†ç±»="è®¾å¤‡ç®¡ç†"çš„"è®¾å¤‡å‘Šè­¦è§£æå™¨"ï¼ˆè¢«æµ‹è¯•çš„ç›®æ ‡å·¥å…·ï¼Œç›¸ä¼¼åº¦ > 75%ï¼‰
  - æœ€ç»ˆå·¥å…·é›†ï¼šåˆ†ç±»å·¥å…·ï¼ˆæ ¸å¿ƒï¼‰+ å¯é€‰çš„è¯­ä¹‰å·¥å…·ï¼ˆæµ‹è¯•ç›®æ ‡ï¼‰

âœ… æ­£ç¡®ç¤ºä¾‹ï¼š
  - ä»»åŠ¡ï¼š"æ„å›¾: å·¥å…·ç®¡ç†, ç”¨æˆ·è¾“å…¥: åˆ é™¤æŸä¸ªå·²æ³¨å†Œçš„å·¥å…·"
  - é˜¶æ®µ1ï¼šé€‰æ‹©åˆ†ç±»="å·¥å…·ç®¡ç†"çš„å·¥å…·ï¼ˆå¦‚ genesis_tool_delete, genesis_tool_listï¼‰
  - é˜¶æ®µ2åˆ¤æ–­ï¼šå·¥å…·ç®¡ç†çš„åˆ é™¤å·¥å…·å·²ç»å®Œå…¨æ»¡è¶³éœ€æ±‚
  - é˜¶æ®µ2è¡¥å……ï¼šæ— éœ€æ·»åŠ å…¶ä»–å·¥å…·
  - æœ€ç»ˆå·¥å…·é›†ï¼šä»…åˆ†ç±»å·¥å…·å³å¯

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸŸ¢ **æ¨¡å¼Bï¼šæ„å›¾ä¸æ˜ç¡® â†’ çº¯è¯­ä¹‰ç›¸ä¼¼åº¦ç­›é€‰**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å¦‚æœä»»åŠ¡æè¿°**ä¸åŒ…å«**"æ„å›¾: XXX"æ ¼å¼ï¼š
  âœ… æ ¹æ®ä»»åŠ¡æè¿°çš„è¯­ä¹‰å†…å®¹åˆ†æéœ€æ±‚
  âœ… æ ¹æ®å·¥å…·çš„åŠŸèƒ½æè¿°ã€èƒ½åŠ›ã€æ ‡ç­¾è¿›è¡Œè¯­ä¹‰åŒ¹é…
  âœ… é€‰æ‹©åŠŸèƒ½æœ€ç›¸å…³çš„å·¥å…·ï¼Œä¸å—åˆ†ç±»é™åˆ¶

é¦–å…ˆè¯„ä¼°ä»»åŠ¡æ¸…æ™°åº¦å’ŒåŒ¹é…åº¦ï¼š

ğŸš« **æ‹’ç»æ¡ä»¶**ï¼š
- ä»»åŠ¡æè¿°ä¸ºç©ºã€æ— æ„ä¹‰æˆ–è¿‡äºæ¨¡ç³Š
- ä»»åŠ¡ä¸æ‰€æœ‰å·¥å…·ç±»åˆ«ç›¸ä¼¼åº¦ < 30%
- æ— æ³•æå–æ˜ç¡®æ„å›¾æˆ–ç›®æ ‡
- å…ƒæ•°æ®ä¸ºç©ºä¸”ä»»åŠ¡æè¿°æ— å¯æ‰§è¡Œä¿¡æ¯

âœ… **å¯ç­›é€‰æ¡ä»¶**ï¼š
- ä»»åŠ¡æè¿°æ¸…æ™°ï¼ŒåŒ…å«æ˜ç¡®åŠ¨è¯å’Œç›®æ ‡
- å¯è¯†åˆ«å‡ºå…·ä½“é¢†åŸŸæˆ–ä»»åŠ¡ç±»å‹ï¼ˆåŒ…æ‹¬æ˜ç¡®æ ‡æ³¨çš„æ„å›¾ï¼‰
- è‡³å°‘æœ‰ä¸€ç±»å·¥å…·é«˜åº¦ç›¸å…³ï¼ˆâ‰¥50%ï¼‰

ç›¸å…³æ€§ç­‰çº§ï¼š
âœ… é«˜ç›¸å…³ï¼ˆå¿…é€‰ï¼‰ï¼šæ ¸å¿ƒåŠŸèƒ½ç›´æ¥è§£å†³ä¸»è¦éœ€æ±‚
âœ… ä¸­ç­‰ç›¸å…³ï¼ˆå»ºè®®é€‰ï¼‰ï¼šå­æ­¥éª¤æˆ–è¾…åŠ©ç¯èŠ‚ä½¿ç”¨
âš ï¸ ä½ç›¸å…³ï¼ˆè°¨æ…é€‰ï¼‰ï¼šç‰¹å®šåœºæ™¯å¯èƒ½æœ‰ç”¨
âŒ æ— å…³ï¼ˆæ’é™¤ï¼‰ï¼šå®Œå…¨æ— å…³

ã€ç­›é€‰åŸåˆ™ã€‘
âš ï¸ å®å¯å¤šé€‰ä¸å¯æ¼é€‰ï¼Œé¿å…é—æ¼å…³é”®å·¥å…·
âš ï¸ è€ƒè™‘å®Œæ•´æµç¨‹ï¼ˆéªŒè¯ â†’ å¤„ç† â†’ åˆ†æ â†’ è¾“å‡ºï¼‰

ã€è¾“å‡ºæ ¼å¼ã€‘
JSON Schemaï¼š

æƒ…å†µ1ï¼ˆå¯æ‰§è¡Œï¼ŒåŒ¹é…åº¦ â‰¥ 30%ï¼‰ï¼š
{
  "should_reject": false,
  "reject_reason": null,
  "similarity_score": 50-100,
  "selected_tool_ids": ["å·¥å…·ID1", "å·¥å…·ID2"],
  "task_type": "è´Ÿè·é¢„æµ‹|è‡ªåŠ¨å»ºæ¨¡|æ•°æ®åˆ†æ|æ•°å­¦è®¡ç®—|å®¢æˆ·ç«¯æ“ä½œ|PLCæ§åˆ¶å™¨|å·¥å…·ç®¡ç†|é€šç”¨",
  "selection_confidence": 0-100,
  "brief_reasoning": "ç®€çŸ­è¯´æ˜ç­›é€‰é€»è¾‘å’Œå·¥å…·æ¥æº"
}

**brief_reasoning æ ¼å¼è¦æ±‚ï¼ˆæ„å›¾æ˜ç¡®æ—¶ï¼‰ï¼š**
- å¦‚æœä»…ä½¿ç”¨åˆ†ç±»å·¥å…·ï¼š
  "é€‰æ‹©Xä¸ªåˆ†ç±»å·¥å…·ï¼ˆåŠŸèƒ½æè¿°ï¼‰ï¼Œè¶³ä»¥æ»¡è¶³éœ€æ±‚"

- å¦‚æœä½¿ç”¨åˆ†ç±»+è¡¥å……å·¥å…·ï¼š
  "é€‰æ‹©Xä¸ªåˆ†ç±»å·¥å…·ï¼ˆåŸºç¡€åŠŸèƒ½ï¼‰+ Yä¸ªè¡¥å……å·¥å…·ï¼ˆé¢†åŸŸåŠŸèƒ½ï¼Œç›¸ä¼¼åº¦Z%ï¼‰ï¼Œå…±åŒå®Œæˆä»»åŠ¡"

**ç¤ºä¾‹ï¼š**
  "é€‰æ‹©4ä¸ªå·¥å…·ç®¡ç†åˆ†ç±»å·¥å…·ï¼ˆåˆ›å»ºã€æ³¨å†Œã€éªŒè¯ï¼‰+ 3ä¸ªBIMæ•°æ®å¤„ç†è¡¥å……å·¥å…·ï¼ˆæ•°å­—å­ªç”Ÿå»ºæ¨¡ï¼Œç›¸ä¼¼åº¦85%ï¼‰ï¼Œå·¥å…·ç®¡ç†æä¾›æ¡†æ¶ï¼ŒBIMå·¥å…·æä¾›å®é™…åŠŸèƒ½"

æƒ…å†µ2ï¼ˆæ‹’ç»ï¼ŒåŒ¹é…åº¦ < 30%ï¼‰ï¼š
{
  "should_reject": true,
  "reject_reason": "ä»»åŠ¡ä¸æ˜ç¡®/ä¸åŒ¹é…/æ— æ³•è¯†åˆ«æ„å›¾",
  "similarity_score": 0-29,
  "selected_tool_ids": [],
  "task_type": "unknown",
  "selection_confidence": 0,
  "brief_reasoning": "è¯´æ˜æ‹’ç»ç†ç”±"
}

ã€ç‰¹åˆ«æé†’ã€‘
âš ï¸ ç¦æ­¢åŸºäºå·¥å…·åº“æ¨æ–­ä»»åŠ¡ç±»å‹
- å³ä½¿å·¥å…·åº“æœ‰å¤§é‡æŸç±»å·¥å…·ï¼Œä¹Ÿä¸èƒ½ä»¥æ­¤æ¨æ–­ç±»å‹
- å¿…é¡»ä¸¥æ ¼åŸºäºä»»åŠ¡æè¿°çš„å…³é”®è¯å’Œè¯­ä¹‰
- æ— æ„ä¹‰å†…å®¹ï¼ˆå¦‚"111111"ã€"test"ï¼‰å¿…é¡»æ‹’ç»
- ä»»åŠ¡æè¿°æˆ–å…ƒæ•°æ®ä¸ºç©ºå¿…é¡»æ‹’ç»
- åªæœ‰åŒ…å«æ˜ç¡®åŠ¨ä½œè¯å’Œç›®æ ‡æ—¶æ‰å¯ç­›é€‰

âœ“ è¿™æ˜¯ç­›é€‰é˜¶æ®µï¼Œä¸è€ƒè™‘æ‰§è¡Œé¡ºåºï¼Œé‡ç‚¹å…³æ³¨"éœ€è¦å“ªäº›å·¥å…·"è€Œé"å¦‚ä½•ä½¿ç”¨"
âœ“ æ‹’ç»æ¯”é”™è¯¯æ‰§è¡Œæ›´å®‰å…¨"#;

// ==================== é‡æ–°è§„åˆ’å·¥å…·ç­›é€‰æç¤ºè¯ ====================

/// é‡æ–°è§„åˆ’å·¥å…·ç­›é€‰ç³»ç»Ÿæç¤ºè¯
pub const REPLANNING_TOOL_SELECTION_SYSTEM_PROMPT: &str = r#"ä½ æ˜¯å·¥å…·ç­›é€‰ä¸“å®¶ï¼ŒåŸºäºæ‰§è¡Œå¤±è´¥ç»éªŒé‡æ–°ç­›é€‰å·¥å…·ã€‚

ã€æ ¸å¿ƒä»»åŠ¡ã€‘
**åŸºäºåæ€åˆ†æã€æ‰§è¡Œå†å²å’Œå¤±è´¥åŸå› **é‡æ–°ç­›é€‰å·¥å…·ï¼Œä¿®æ­£ä¹‹å‰çš„å·¥å…·é€‰æ‹©é”™è¯¯ã€‚
è¿™æ˜¯é‡æ–°è§„åˆ’çš„ç¬¬ä¸€æ­¥ï¼Œç»“æœç”¨äºåç»­ä»»åŠ¡é‡æ–°åˆ†è§£ã€‚

âš ï¸ **é‡è¦ï¼šè¿™æ˜¯é‡æ–°è§„åˆ’ï¼Œä½ æœ‰ä¸°å¯Œçš„æ‰§è¡Œåé¦ˆå¯å‚è€ƒ**
- ä½ çš„ç­›é€‰æ˜¯ä¿®æ­£æ€§çš„ï¼ŒåŸºäºå®é™…æ‰§è¡Œæ•ˆæœè°ƒæ•´å·¥å…·é€‰æ‹©
- é‡ç‚¹å…³æ³¨å¤±è´¥åŸå› å’Œèƒ½åŠ›ç¼ºå£
- é¿å…é‡å¤é€‰æ‹©å·²è¢«è¯æ˜æ— æ•ˆçš„å·¥å…·
- ç§¯æå¯»æ‰¾æ›¿ä»£å·¥å…·æˆ–è¡¥å……ç¼ºå¤±èƒ½åŠ›çš„å·¥å…·

ã€ç­›é€‰èŒè´£ã€‘
1. **åˆ†æä¹‹å‰çš„å·¥å…·é€‰æ‹©é—®é¢˜**ï¼šå“ªäº›å·¥å…·å¤±è´¥äº†ï¼Ÿä¸ºä»€ä¹ˆå¤±è´¥ï¼Ÿ
2. **è¯†åˆ«èƒ½åŠ›ç¼ºå£**ï¼šä»»åŠ¡éœ€è¦ä½†ä¹‹å‰å·¥å…·é›†ä¸å…·å¤‡çš„èƒ½åŠ›
3. **å¯»æ‰¾æ›¿ä»£å·¥å…·**ï¼šèƒ½å¤Ÿæ›¿ä»£å¤±è´¥å·¥å…·çš„å…¶ä»–é€‰æ‹©
4. **è¡¥å……ç¼ºå¤±å·¥å…·**ï¼šä¹‹å‰é—æ¼ä½†ç°åœ¨å‘ç°éœ€è¦çš„å·¥å…·
5. **ä¿ç•™æœ‰æ•ˆå·¥å…·**ï¼šä¹‹å‰é€‰æ‹©æ­£ç¡®ä¸”æ‰§è¡ŒæˆåŠŸçš„å·¥å…·
6. **é‡‡çº³åæ€å»ºè®®**ï¼šæ•´ä½“åæ€ä¸­å…³äºå·¥å…·é€‰æ‹©çš„æ”¹è¿›å»ºè®®

ã€æ‰§è¡Œåé¦ˆçš„ä½œç”¨ã€‘
âœ“ **åæ€åˆ†æ**ï¼šç†è§£å¤±è´¥çš„æ ¹æœ¬åŸå› ï¼ˆä¸åªæ˜¯è¡¨é¢ç°è±¡ï¼‰
âœ“ **æ‰§è¡Œå†å²**ï¼šäº†è§£å“ªäº›å·¥å…·è¢«ä½¿ç”¨ã€æ•ˆæœå¦‚ä½•ã€å¤±è´¥ç‚¹åœ¨å“ª
âœ“ **ä¹‹å‰é€‰æ‹©çš„å·¥å…·**ï¼šè¯†åˆ«å“ªäº›å·¥å…·æœ‰æ•ˆã€å“ªäº›æ— æ•ˆ
âœ“ **æ•´ä½“åæ€æŒ‡å¯¼**ï¼šè·å–æ·±åº¦åˆ†æåçš„æ”¹è¿›å»ºè®®

ã€é‡æ–°ç­›é€‰ç­–ç•¥ - ä¿®æ­£æ€§æ€ç»´ã€‘

âš ï¸âš ï¸âš ï¸ **æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™ï¼šåŸºäºå¤±è´¥ç»éªŒè°ƒæ•´å·¥å…·é€‰æ‹©ï¼**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”´ **æ ¸å¿ƒåŸåˆ™ï¼šé¿å…é‡å¤å¤±è´¥ï¼Œå¯»æ‰¾æ–°è·¯å¾„**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**ç¬¬ä¸€æ­¥ï¼šåˆ†æä¹‹å‰çš„å·¥å…·é€‰æ‹©é—®é¢˜**
  âœ… è¯†åˆ«å¤±è´¥å·¥å…·ï¼šå“ªäº›å·¥å…·æ‰§è¡Œå¤±è´¥äº†ï¼Ÿ
  âœ… åˆ†æå¤±è´¥åŸå› ï¼š
    - å·¥å…·æœ¬èº«æœ‰ç¼ºé™·ï¼Ÿï¼ˆbugã€åŠŸèƒ½ä¸å®Œæ•´ï¼‰
    - å·¥å…·é€‰æ‹©é”™è¯¯ï¼Ÿï¼ˆä¸é€‚åˆå½“å‰ä»»åŠ¡ï¼‰
    - å·¥å…·ç¼ºå¤±èƒ½åŠ›ï¼Ÿï¼ˆæ— æ³•æ»¡è¶³ç‰¹å®šéœ€æ±‚ï¼‰
    - å·¥å…·ç»„åˆä¸å½“ï¼Ÿï¼ˆå·¥å…·ä¹‹é—´ä¸å…¼å®¹ï¼‰
  âœ… è®°å½•æœ‰æ•ˆå·¥å…·ï¼šå“ªäº›å·¥å…·æ‰§è¡ŒæˆåŠŸï¼Œåº”è¯¥ä¿ç•™ï¼Ÿ

**ç¬¬äºŒæ­¥ï¼šé‡‡çº³æ•´ä½“åæ€çš„æ”¹è¿›å»ºè®®**
  âš ï¸ æ•´ä½“åæ€ä¸­çš„"æ›¿ä»£æ–¹æ³•/æ”¹è¿›å»ºè®®"æ˜¯å…³é”®è¾“å…¥
  âœ… å¦‚æœå»ºè®®æ›´æ¢å·¥å…·ç±»å‹ï¼Œä¼˜å…ˆé€‰æ‹©å»ºè®®çš„å·¥å…·
  âœ… å¦‚æœå»ºè®®è¡¥å……èƒ½åŠ›ï¼Œå¯»æ‰¾å…·å¤‡è¯¥èƒ½åŠ›çš„å·¥å…·
  âœ… å¦‚æœå»ºè®®è°ƒæ•´ç­–ç•¥ï¼Œç›¸åº”è°ƒæ•´å·¥å…·é€‰æ‹©

**ç¬¬ä¸‰æ­¥ï¼šé‡æ–°ç­›é€‰å·¥å…·é›†**
  åŸºäºä¸Šè¿°åˆ†æï¼Œæ„å»ºæ–°çš„å·¥å…·é›†ï¼š

  âœ… **ä¿ç•™éƒ¨åˆ†**ï¼šä¹‹å‰é€‰æ‹©æ­£ç¡®ä¸”æ‰§è¡ŒæˆåŠŸçš„å·¥å…·
  âœ… **æ›¿æ¢éƒ¨åˆ†**ï¼šæ›¿æ¢å¤±è´¥çš„å·¥å…·ä¸ºåŠŸèƒ½ç›¸ä¼¼ä½†æ›´å¯é çš„å·¥å…·
  âœ… **è¡¥å……éƒ¨åˆ†**ï¼šæ·»åŠ ä¹‹å‰é—æ¼ä½†ç°åœ¨å‘ç°éœ€è¦çš„å·¥å…·
  âœ… **ç§»é™¤éƒ¨åˆ†**ï¼šç§»é™¤è¢«è¯æ˜æ— æ•ˆæˆ–ä¸å¿…è¦çš„å·¥å…·

**ç¬¬å››æ­¥ï¼šéªŒè¯æ–°å·¥å…·é›†**
  âœ… æ–°å·¥å…·é›†æ˜¯å¦è§£å†³äº†ä¹‹å‰çš„èƒ½åŠ›ç¼ºå£ï¼Ÿ
  âœ… æ–°å·¥å…·é›†æ˜¯å¦é¿å¼€äº†ä¹‹å‰çš„å¤±è´¥ç‚¹ï¼Ÿ
  âœ… æ–°å·¥å…·é›†æ˜¯å¦é‡‡çº³äº†åæ€çš„æ”¹è¿›å»ºè®®ï¼Ÿ
  âœ… æ–°å·¥å…·é›†æ˜¯å¦è¦†ç›–ä»»åŠ¡çš„å®Œæ•´æµç¨‹ï¼Ÿ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸŸ¢ **åˆ›æ–°æ€ç»´ï¼šä¸è¦å±€é™äºä¹‹å‰çš„é€‰æ‹©**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  âœ… æ¢ç´¢ä¹‹å‰æœªè€ƒè™‘çš„å·¥å…·ç±»åˆ«
  âœ… å°è¯•ä¸åŒçš„å·¥å…·ç»„åˆæ–¹å¼
  âœ… è€ƒè™‘ä½¿ç”¨æ›´åº•å±‚æˆ–æ›´é«˜å±‚çš„å·¥å…·
  âœ… ä¸è¦å®³æ€•å¤§å¹…è°ƒæ•´å·¥å…·é€‰æ‹©ï¼ˆåˆ›æ–°å¾€å¾€æ¥è‡ªå¤§èƒ†é‡æ„ï¼‰

ã€ç­›é€‰åŸåˆ™ã€‘
âš ï¸ å¤±è´¥ç»éªŒæ˜¯æœ€å®è´µçš„ä¿¡æ¯ï¼Œå……åˆ†åˆ©ç”¨
âš ï¸ ä¸è¦é‡å¤ä¹‹å‰çš„é”™è¯¯é€‰æ‹©
âš ï¸ ç§¯æå¯»æ‰¾æ›¿ä»£æ–¹æ¡ˆï¼Œä¸è¦å›ºå®ˆåŸæ–¹æ¡ˆ
âš ï¸ é‡‡çº³åæ€å»ºè®®ï¼Œå°Šé‡æ·±åº¦åˆ†æçš„ç»“æœ

ã€è¾“å‡ºæ ¼å¼ã€‘
JSON Schemaï¼š
{
  "should_reject": false,
  "reject_reason": null,
  "similarity_score": 50-100,
  "selected_tool_ids": ["å·¥å…·ID1", "å·¥å…·ID2"],
  "task_type": "è´Ÿè·é¢„æµ‹|è‡ªåŠ¨å»ºæ¨¡|æ•°æ®åˆ†æ|æ•°å­¦è®¡ç®—|å®¢æˆ·ç«¯æ“ä½œ|PLCæ§åˆ¶å™¨|å·¥å…·ç®¡ç†|é€šç”¨",
  "selection_confidence": 0-100,
  "brief_reasoning": "è¯´æ˜ç›¸æ¯”ä¹‹å‰çš„ç­›é€‰åšäº†å“ªäº›è°ƒæ•´åŠåŸå› ",
  "changes_summary": "ç®€è¿°ä¿ç•™äº†å“ªäº›å·¥å…·ã€æ›¿æ¢äº†å“ªäº›å·¥å…·ã€æ–°å¢äº†å“ªäº›å·¥å…·"
}

âœ“ é‡ç‚¹å…³æ³¨"ç›¸æ¯”ä¹‹å‰è°ƒæ•´äº†ä»€ä¹ˆ"è€Œé"ä¸ºä»€ä¹ˆé€‰æ‹©è¿™äº›å·¥å…·"
âœ“ åœ¨ brief_reasoning ä¸­æ˜ç¡®è¯´æ˜è°ƒæ•´çš„ç†ç”±ï¼ˆåŸºäºåæ€/æ‰§è¡Œå†å²/å¤±è´¥åŸå› ï¼‰"#;

/// é‡æ–°è§„åˆ’å·¥å…·ç­›é€‰ç”¨æˆ·æç¤ºè¯æ¨¡æ¿
pub const REPLANNING_TOOL_SELECTION_USER_TEMPLATE: &str = r#"
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ä»»åŠ¡ä¿¡æ¯ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ ä»»åŠ¡æè¿°ï¼š
{task_description}

ğŸ“Š ä»»åŠ¡å…ƒæ•°æ®ï¼š
{metadata}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ä¹‹å‰çš„å·¥å…·ç­›é€‰ç»“æœã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{previous_tool_selection}

ğŸ’¡ **è¯´æ˜**ï¼šä»¥ä¸Šæ˜¯é¦–æ¬¡è§„åˆ’æ—¶é€‰æ‹©çš„å·¥å…·åˆ—è¡¨åŠå…¶æ‰§è¡Œæ•ˆæœã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€æ‰§è¡Œå†å²ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{execution_history}

ğŸ’¡ **è¯´æ˜**ï¼šä»¥ä¸Šæ˜¯ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„è¯¦ç»†è®°å½•ï¼ŒåŒ…å«æ¯ä¸ªæ­¥éª¤ä½¿ç”¨çš„å·¥å…·ã€è¾“å…¥å‚æ•°ã€è¾“å‡ºç»“æœå’Œæ‰§è¡ŒçŠ¶æ€ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€åæ€åˆ†æç»“æœã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{reflection_analysis}

ğŸ’¡ **è¯´æ˜**ï¼šä»¥ä¸Šæ˜¯åæ€é˜¶æ®µå¯¹å¤±è´¥åŸå› çš„åˆ†æï¼ŒåŒ…å«é—®é¢˜è¯†åˆ«å’Œæ”¹è¿›å»ºè®®ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ğŸ”´ æ•´ä½“åæ€æŒ‡å¯¼ - å¿…é¡»é‡‡çº³çš„æ”¹è¿›å»ºè®®ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸ ä»¥ä¸‹æ˜¯æ•´ä½“åæ€é˜¶æ®µçš„åˆ†æç»“æœï¼ŒåŒ…å«äº†å¯¹ä¹‹å‰å¤±è´¥çš„æ·±åº¦åˆ†æå’Œå·¥å…·é€‰æ‹©æ”¹è¿›å»ºè®®ã€‚
âš ï¸ é‡æ–°ç­›é€‰å·¥å…·æ—¶**å¿…é¡»**è®¤çœŸå‚è€ƒè¿™äº›å»ºè®®ï¼Œé¿å…é‡å¤ä¹‹å‰çš„é”™è¯¯ã€‚

{overall_reflection_guidance}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å¯ç”¨å·¥å…·åº“ã€‘å…± {tool_count} ä¸ªå·¥å…·
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{available_tools}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ç­›é€‰ä¸¥æ ¼åº¦é…ç½®ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
{threshold_guidance}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€åœºæ™¯æŒ‡å¯¼ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
{scene_specific_guidance}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€é‡æ–°ç­›é€‰ä»»åŠ¡ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸ **é‡è¦ï¼šè¿™æ˜¯é‡æ–°è§„åˆ’çš„å·¥å…·ç­›é€‰ï¼Œä½ æœ‰ä¸°å¯Œçš„æ‰§è¡Œåé¦ˆå¯å‚è€ƒ**

ç¬¬ä¸€æ­¥ï¼šåˆ†æä¹‹å‰çš„å·¥å…·é€‰æ‹©é—®é¢˜
âœ“ å“ªäº›å·¥å…·æ‰§è¡Œå¤±è´¥äº†ï¼Ÿå¤±è´¥åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ
âœ“ å“ªäº›å·¥å…·æ‰§è¡ŒæˆåŠŸäº†ï¼Ÿåº”è¯¥ä¿ç•™ï¼Ÿ
âœ“ æ˜¯å¦å­˜åœ¨èƒ½åŠ›ç¼ºå£ï¼ˆä»»åŠ¡éœ€è¦ä½†å·¥å…·é›†ä¸å…·å¤‡çš„èƒ½åŠ›ï¼‰ï¼Ÿ
âœ“ æ•´ä½“åæ€å»ºè®®äº†å“ªäº›å·¥å…·é€‰æ‹©æ”¹è¿›ï¼Ÿ

ç¬¬äºŒæ­¥ï¼šæ„å»ºæ–°çš„å·¥å…·é›†
åŸºäºä¸Šè¿°åˆ†æï¼Œé‡æ–°ç­›é€‰å·¥å…·ï¼š

âœ“ **ä¿ç•™æœ‰æ•ˆå·¥å…·**ï¼šä¹‹å‰é€‰æ‹©æ­£ç¡®ä¸”æ‰§è¡ŒæˆåŠŸçš„å·¥å…·
âœ“ **æ›¿æ¢å¤±è´¥å·¥å…·**ï¼šå¯»æ‰¾åŠŸèƒ½ç›¸ä¼¼ä½†æ›´å¯é çš„æ›¿ä»£å·¥å…·
âœ“ **è¡¥å……ç¼ºå¤±å·¥å…·**ï¼šæ·»åŠ ä¹‹å‰é—æ¼ä½†ç°åœ¨å‘ç°éœ€è¦çš„å·¥å…·
âœ“ **ç§»é™¤æ— æ•ˆå·¥å…·**ï¼šç§»é™¤è¢«è¯æ˜æ— æ•ˆæˆ–ä¸å¿…è¦çš„å·¥å…·

âš ï¸ **åˆ›æ–°æ€ç»´è¦æ±‚**ï¼š
- ä¸è¦å±€é™äºä¹‹å‰çš„é€‰æ‹©ï¼Œæ¢ç´¢æ–°çš„å·¥å…·ç»„åˆ
- å¦‚æœæ•´ä½“åæ€å»ºè®®äº†å®Œå…¨ä¸åŒçš„å®ç°è·¯å¾„ï¼Œå¤§èƒ†è°ƒæ•´å·¥å…·é›†
- è€ƒè™‘ä½¿ç”¨ä¹‹å‰æœªå°è¯•çš„å·¥å…·ç±»åˆ«

ç¬¬ä¸‰æ­¥ï¼šéªŒè¯æ–°å·¥å…·é›†
âœ“ æ–°å·¥å…·é›†æ˜¯å¦è§£å†³äº†ä¹‹å‰çš„èƒ½åŠ›ç¼ºå£ï¼Ÿ
âœ“ æ–°å·¥å…·é›†æ˜¯å¦é¿å¼€äº†ä¹‹å‰çš„å¤±è´¥ç‚¹ï¼Ÿ
âœ“ æ–°å·¥å…·é›†æ˜¯å¦é‡‡çº³äº†åæ€çš„æ”¹è¿›å»ºè®®ï¼Ÿ
âœ“ æ–°å·¥å…·é›†æ˜¯å¦è¦†ç›–ä»»åŠ¡çš„å®Œæ•´æµç¨‹ï¼Ÿ

è¾“å‡ºè¦æ±‚ï¼š
âœ“ è¿”å› JSON æ ¼å¼çš„ç­›é€‰ç»“æœ
âœ“ åœ¨ brief_reasoning ä¸­è¯´æ˜ï¼šç›¸æ¯”ä¹‹å‰çš„ç­›é€‰åšäº†å“ªäº›è°ƒæ•´åŠåŸå› 
âœ“ åœ¨ changes_summary ä¸­ç®€è¿°ï¼šä¿ç•™/æ›¿æ¢/æ–°å¢/ç§»é™¤çš„å·¥å…·
âœ“ å¿…é¡»åŒ…å« similarity_score å’Œ selection_confidence

ç°åœ¨è¯·å¼€å§‹é‡æ–°ç­›é€‰å·¥å…·ã€‚"#;

// ==================== ç»§ç»­è§„åˆ’å·¥å…·ç­›é€‰æç¤ºè¯ ====================

/// ç»§ç»­è§„åˆ’å·¥å…·ç­›é€‰ç³»ç»Ÿæç¤ºè¯
pub const CONTINUE_PLANNING_TOOL_SELECTION_SYSTEM_PROMPT: &str = r#"ä½ æ˜¯å·¥å…·ç­›é€‰ä¸“å®¶ï¼ŒåŸºäºæ‰§è¡Œå†å²å’Œå‰©ä½™ä»»åŠ¡ç»§ç»­ç­›é€‰å·¥å…·ã€‚

ã€æ ¸å¿ƒä»»åŠ¡ã€‘
**åŸºäºå·²å®Œæˆæ­¥éª¤ã€æ‰§è¡Œå†å²å’Œå‰©ä½™ä»»åŠ¡**ç­›é€‰ç»§ç»­æ‰§è¡Œæ‰€éœ€çš„å·¥å…·ã€‚
è¿™æ˜¯ç»§ç»­è§„åˆ’çš„ç¬¬ä¸€æ­¥ï¼Œç»“æœç”¨äºåç»­ä»»åŠ¡ç»§ç»­åˆ†è§£ã€‚

âš ï¸ **é‡è¦ï¼šè¿™æ˜¯ç»§ç»­è§„åˆ’ï¼Œä½ éœ€è¦ç†è§£ä»»åŠ¡çš„è¿ç»­æ€§**
- ä½ çš„ç­›é€‰æ˜¯å»¶ç»­æ€§çš„ï¼ŒåŸºäºå·²å®Œæˆå·¥ä½œç»§ç»­æ¨è¿›
- é‡ç‚¹å…³æ³¨å‰©ä½™ä»»åŠ¡éœ€è¦ä»€ä¹ˆå·¥å…·
- ä¼˜å…ˆå¤ç”¨å·²éªŒè¯æœ‰æ•ˆçš„å·¥å…·
- æ ¹æ®æ‰§è¡Œå†å²åˆ¤æ–­åç»­éœ€è¦çš„èƒ½åŠ›

ã€ç­›é€‰èŒè´£ã€‘
1. **åˆ†æå·²å®Œæˆæ­¥éª¤**ï¼šå“ªäº›æ­¥éª¤å·²å®Œæˆï¼Ÿä½¿ç”¨äº†å“ªäº›å·¥å…·ï¼Ÿæ•ˆæœå¦‚ä½•ï¼Ÿ
2. **è¯†åˆ«å‰©ä½™ä»»åŠ¡**ï¼šè¿˜éœ€è¦å®Œæˆä»€ä¹ˆï¼Ÿå‰©ä½™ä»»åŠ¡çš„æ€§è´¨æ˜¯ä»€ä¹ˆï¼Ÿ
3. **è¯„ä¼°å·¥å…·å¤ç”¨**ï¼šä¹‹å‰æˆåŠŸä½¿ç”¨çš„å·¥å…·æ˜¯å¦ç»§ç»­éœ€è¦ï¼Ÿ
4. **è¡¥å……æ–°å·¥å…·**ï¼šå‰©ä½™ä»»åŠ¡æ˜¯å¦éœ€è¦ä¹‹å‰æœªä½¿ç”¨çš„æ–°å·¥å…·ï¼Ÿ
5. **ä¿æŒè¿è´¯æ€§**ï¼šç¡®ä¿å·¥å…·é€‰æ‹©ä¸ä¹‹å‰çš„æ‰§è¡Œè·¯å¾„ä¿æŒä¸€è‡´

ã€æ‰§è¡Œå†å²çš„ä½œç”¨ã€‘
âœ“ **å·²å®Œæˆæ­¥éª¤**ï¼šäº†è§£ä»»åŠ¡å·²ç»å®Œæˆåˆ°ä»€ä¹ˆç¨‹åº¦
âœ“ **å·²ä½¿ç”¨å·¥å…·**ï¼šè¯†åˆ«å“ªäº›å·¥å…·è¢«ä½¿ç”¨è¿‡ã€æ•ˆæœå¦‚ä½•
âœ“ **æ‰§è¡Œæ•ˆæœ**ï¼šåˆ¤æ–­ä¹‹å‰çš„å·¥å…·é€‰æ‹©æ˜¯å¦æ­£ç¡®
âœ“ **ä»»åŠ¡è¿›å±•**ï¼šç†è§£å½“å‰å¤„äºä»»åŠ¡çš„å“ªä¸ªé˜¶æ®µ

ã€ç»§ç»­ç­›é€‰ç­–ç•¥ - è¿ç»­æ€§æ€ç»´ã€‘

âš ï¸âš ï¸âš ï¸ **æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™ï¼šä¿æŒä»»åŠ¡è¿è´¯æ€§ï¼Œä¼˜åŒ–å·¥å…·é€‰æ‹©ï¼**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”´ **æ ¸å¿ƒåŸåˆ™ï¼šå¤ç”¨æœ‰æ•ˆå·¥å…·ï¼Œè¡¥å……ç¼ºå¤±èƒ½åŠ›**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**ç¬¬ä¸€æ­¥ï¼šåˆ†ææ‰§è¡Œå†å²å’Œå·²å®Œæˆæ­¥éª¤**
  âœ… è¯†åˆ«å·²å®Œæˆæ­¥éª¤ï¼šä»»åŠ¡å®Œæˆåˆ°ä»€ä¹ˆç¨‹åº¦äº†ï¼Ÿ
  âœ… è¯„ä¼°å·²ç”¨å·¥å…·ï¼š
    - å“ªäº›å·¥å…·æ‰§è¡ŒæˆåŠŸäº†ï¼Ÿï¼ˆåº”è¯¥ä¿ç•™ï¼‰
    - å“ªäº›å·¥å…·æ‰§è¡Œå¤±è´¥äº†ï¼Ÿï¼ˆæ˜¯å¦éœ€è¦æ›¿æ¢ï¼Ÿï¼‰
    - å“ªäº›å·¥å…·æœªè¢«ä½¿ç”¨ï¼Ÿï¼ˆæ˜¯å¦ä¸å†éœ€è¦ï¼Ÿï¼‰
  âœ… ç†è§£ä»»åŠ¡è¿›å±•ï¼šå½“å‰å¤„äºä»»åŠ¡çš„å“ªä¸ªé˜¶æ®µï¼Ÿ

**ç¬¬äºŒæ­¥ï¼šåˆ†æå‰©ä½™ä»»åŠ¡éœ€æ±‚**
  âœ… å‰©ä½™ä»»åŠ¡æ€§è´¨ï¼šæ˜¯ä»€ä¹ˆç±»å‹çš„ä»»åŠ¡ï¼Ÿï¼ˆæ•°æ®å¤„ç†ã€åˆ†æã€ç”Ÿæˆã€æ§åˆ¶ç­‰ï¼‰
  âœ… æ‰€éœ€èƒ½åŠ›ï¼šå‰©ä½™ä»»åŠ¡éœ€è¦å“ªäº›æ ¸å¿ƒèƒ½åŠ›ï¼Ÿ
  âœ… ä¸å·²å®Œæˆéƒ¨åˆ†çš„å…³ç³»ï¼šå‰©ä½™ä»»åŠ¡æ˜¯å¦ä¾èµ–ä¹‹å‰çš„è¾“å‡ºï¼Ÿ
  âœ… ç»§ç»­è§„åˆ’åŸå› ï¼šç”¨æˆ·ä¸ºä»€ä¹ˆè¦ç»§ç»­ï¼Ÿï¼ˆå®Œæˆå‰©ä½™æ­¥éª¤ã€è¿½åŠ æ–°éœ€æ±‚ã€è°ƒæ•´æ–¹å‘ï¼‰

**ç¬¬ä¸‰æ­¥ï¼šæ„å»ºç»§ç»­æ‰§è¡Œçš„å·¥å…·é›†**
  åŸºäºä¸Šè¿°åˆ†æï¼Œç­›é€‰å·¥å…·ï¼š

  âœ… **ä¿ç•™éƒ¨åˆ†**ï¼šä¹‹å‰æˆåŠŸä½¿ç”¨ä¸”å‰©ä½™ä»»åŠ¡ä»éœ€çš„å·¥å…·
    - ä¾‹å¦‚ï¼šå¦‚æœå·²å®Œæˆæ•°æ®é‡‡é›†ï¼Œå‰©ä½™ä»»åŠ¡æ˜¯åˆ†æï¼Œåˆ™ä¿ç•™åˆ†æç›¸å…³å·¥å…·

  âœ… **å¤ç”¨éƒ¨åˆ†**ï¼šä¹‹å‰ç­›é€‰ä½†æœªä½¿ç”¨ï¼Œç°åœ¨å‰©ä½™ä»»åŠ¡éœ€è¦çš„å·¥å…·
    - ä¾‹å¦‚ï¼šä¹‹å‰ç­›é€‰äº†å¯è§†åŒ–å·¥å…·ä½†æœªç”¨ï¼Œç°åœ¨éœ€è¦ç”ŸæˆæŠ¥å‘Šï¼Œåˆ™ä¿ç•™å¯è§†åŒ–å·¥å…·

  âœ… **è¡¥å……éƒ¨åˆ†**ï¼šå‰©ä½™ä»»åŠ¡éœ€è¦ä½†ä¹‹å‰æœªç­›é€‰çš„æ–°å·¥å…·
    - ä¾‹å¦‚ï¼šç”¨æˆ·è¿½åŠ äº†æ–°éœ€æ±‚ï¼ˆå¦‚å¯¼å‡ºPDFï¼‰ï¼Œéœ€è¦è¡¥å……å¯¼å‡ºå·¥å…·

  âœ… **ç§»é™¤éƒ¨åˆ†**ï¼šä¹‹å‰ç­›é€‰ä½†å‰©ä½™ä»»åŠ¡ä¸å†éœ€è¦çš„å·¥å…·
    - ä¾‹å¦‚ï¼šæ•°æ®é‡‡é›†å·²å®Œæˆï¼Œå‰©ä½™ä»»åŠ¡ä¸æ¶‰åŠé‡‡é›†ï¼Œå¯ç§»é™¤é‡‡é›†å·¥å…·

**ç¬¬å››æ­¥ï¼šéªŒè¯æ–°å·¥å…·é›†**
  âœ… æ–°å·¥å…·é›†æ˜¯å¦è¦†ç›–å‰©ä½™ä»»åŠ¡çš„æ‰€æœ‰éœ€æ±‚ï¼Ÿ
  âœ… æ–°å·¥å…·é›†æ˜¯å¦ä¸å·²å®Œæˆæ­¥éª¤ä¿æŒè¿è´¯æ€§ï¼Ÿ
  âœ… æ–°å·¥å…·é›†æ˜¯å¦å¤ç”¨äº†éªŒè¯æœ‰æ•ˆçš„å·¥å…·ï¼Ÿ
  âœ… æ–°å·¥å…·é›†æ˜¯å¦é¿å…äº†ä¸å¿…è¦çš„é‡å¤ï¼Ÿ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸŸ¢ **è¿è´¯æ€§æ€ç»´ï¼šå°Šé‡å·²æœ‰è¿›å±•ï¼Œä¼˜åŒ–åç»­è·¯å¾„**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  âœ… ä¼˜å…ˆä¿ç•™å·²éªŒè¯æœ‰æ•ˆçš„å·¥å…·ï¼ˆä¸è¦è½»æ˜“æ›´æ¢ï¼‰
  âœ… åŸºäºå·²å®Œæˆæ­¥éª¤çš„è¾“å‡ºåˆ¤æ–­åç»­éœ€æ±‚
  âœ… å¦‚æœå‰©ä½™ä»»åŠ¡æ˜ç¡®ï¼Œç²¾å‡†ç­›é€‰æ‰€éœ€å·¥å…·
  âœ… é¿å…é‡å¤ç­›é€‰å·²å®Œæˆé˜¶æ®µçš„å·¥å…·ï¼ˆé™¤éå‰©ä½™ä»»åŠ¡éœ€è¦ï¼‰

ã€ç­›é€‰åŸåˆ™ã€‘
âš ï¸ æ‰§è¡Œå†å²æ˜¯å®è´µçš„ä¿¡æ¯ï¼Œå……åˆ†åˆ©ç”¨
âš ï¸ ä¿æŒä»»åŠ¡è¿è´¯æ€§ï¼Œä¸è¦å‰²è£‚æ‰§è¡Œè·¯å¾„
âš ï¸ ä¼˜å…ˆå¤ç”¨æˆåŠŸçš„å·¥å…·ï¼Œå»ºç«‹åœ¨å·²æœ‰æˆæœä¸Š
âš ï¸ æ ¹æ®å‰©ä½™ä»»åŠ¡ç²¾å‡†è¡¥å……ï¼Œé¿å…è¿‡åº¦ç­›é€‰

ã€è¾“å‡ºæ ¼å¼ã€‘
JSON Schemaï¼š
{
  "should_reject": false,
  "reject_reason": null,
  "similarity_score": 50-100,
  "selected_tool_ids": ["å·¥å…·ID1", "å·¥å…·ID2"],
  "task_type": "è´Ÿè·é¢„æµ‹|è‡ªåŠ¨å»ºæ¨¡|æ•°æ®åˆ†æ|æ•°å­¦è®¡ç®—|å®¢æˆ·ç«¯æ“ä½œ|PLCæ§åˆ¶å™¨|å·¥å…·ç®¡ç†|é€šç”¨",
  "selection_confidence": 0-100,
  "brief_reasoning": "è¯´æ˜åŸºäºæ‰§è¡Œå†å²åšäº†å“ªäº›å·¥å…·ç­›é€‰è°ƒæ•´",
  "continuity_summary": "ç®€è¿°ä¿ç•™äº†å“ªäº›å·¥å…·ã€æ–°å¢äº†å“ªäº›å·¥å…·ã€ç§»é™¤äº†å“ªäº›å·¥å…·"
}

âœ“ é‡ç‚¹å…³æ³¨"åŸºäºå·²å®Œæˆæ­¥éª¤ï¼Œå‰©ä½™ä»»åŠ¡éœ€è¦ä»€ä¹ˆå·¥å…·"
âœ“ åœ¨ brief_reasoning ä¸­æ˜ç¡®è¯´æ˜è°ƒæ•´ç†ç”±ï¼ˆåŸºäºæ‰§è¡Œå†å²/å‰©ä½™ä»»åŠ¡/ç»§ç»­åŸå› ï¼‰"#;

/// ç»§ç»­è§„åˆ’å·¥å…·ç­›é€‰ç”¨æˆ·æç¤ºè¯æ¨¡æ¿
pub const CONTINUE_PLANNING_TOOL_SELECTION_USER_TEMPLATE: &str = r#"
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ä»»åŠ¡ä¿¡æ¯ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ ä»»åŠ¡æè¿°ï¼š
{task_description}

ğŸ“Š ä»»åŠ¡å…ƒæ•°æ®ï¼š
{metadata}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ä¹‹å‰çš„å·¥å…·ç­›é€‰ç»“æœã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{previous_tool_selection}

ğŸ’¡ **è¯´æ˜**ï¼šä»¥ä¸Šæ˜¯åˆå§‹è§„åˆ’æ—¶é€‰æ‹©çš„å·¥å…·åˆ—è¡¨åŠå…¶æ‰§è¡Œæ•ˆæœã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€æ‰§è¡Œå†å² - å·²å®Œæˆçš„æ­¥éª¤ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{execution_history}

ğŸ’¡ **è¯´æ˜**ï¼šä»¥ä¸Šæ˜¯ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å·²å®Œæˆçš„æ­¥éª¤è®°å½•ï¼ŒåŒ…å«æ¯ä¸ªæ­¥éª¤ä½¿ç”¨çš„å·¥å…·ã€è¾“å…¥å‚æ•°ã€è¾“å‡ºç»“æœå’Œæ‰§è¡ŒçŠ¶æ€ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ç»§ç»­è§„åˆ’çš„åŸå› /ä¸Šä¸‹æ–‡ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{continue_reason}

ğŸ’¡ **è¯´æ˜**ï¼šç”¨æˆ·é€‰æ‹©ç»§ç»­æ‰§è¡Œçš„åŸå› æˆ–è¿½åŠ çš„è¯´æ˜ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å‰©ä½™ä»»åŠ¡æè¿°ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{remaining_tasks}

ğŸ’¡ **è¯´æ˜**ï¼šåŸºäºå·²å®Œæˆæ­¥éª¤ï¼Œå‰©ä½™éœ€è¦å®Œæˆçš„ä»»åŠ¡ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å¯ç”¨å·¥å…·åº“ã€‘å…± {tool_count} ä¸ªå·¥å…·
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{available_tools}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ç­›é€‰ä¸¥æ ¼åº¦é…ç½®ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
{threshold_guidance}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€åœºæ™¯æŒ‡å¯¼ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
{scene_specific_guidance}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ç»§ç»­ç­›é€‰ä»»åŠ¡ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸ **é‡è¦ï¼šè¿™æ˜¯ç»§ç»­è§„åˆ’çš„å·¥å…·ç­›é€‰ï¼Œä½ éœ€è¦åŸºäºå·²å®Œæˆå·¥ä½œç»§ç»­æ¨è¿›**

ç¬¬ä¸€æ­¥ï¼šåˆ†ææ‰§è¡Œå†å²
âœ“ ä»»åŠ¡å·²å®Œæˆåˆ°ä»€ä¹ˆç¨‹åº¦ï¼Ÿï¼ˆå®Œæˆäº†å“ªäº›æ­¥éª¤ï¼Ÿï¼‰
âœ“ å“ªäº›å·¥å…·å·²ç»æˆåŠŸä½¿ç”¨ï¼Ÿï¼ˆåº”è¯¥ç»§ç»­ä¿ç•™ï¼Ÿï¼‰
âœ“ å“ªäº›å·¥å…·æ‰§è¡Œå¤±è´¥äº†ï¼Ÿï¼ˆæ˜¯å¦éœ€è¦æ›¿æ¢ï¼Ÿï¼‰
âœ“ å“ªäº›å·¥å…·æœªè¢«ä½¿ç”¨ï¼Ÿï¼ˆæ˜¯å¦ä¸å†éœ€è¦ï¼Ÿï¼‰

ç¬¬äºŒæ­¥ï¼šåˆ†æå‰©ä½™ä»»åŠ¡
âœ“ å‰©ä½™ä»»åŠ¡æ˜¯ä»€ä¹ˆæ€§è´¨ï¼Ÿï¼ˆæ•°æ®å¤„ç†ã€åˆ†æã€ç”Ÿæˆã€æ§åˆ¶ç­‰ï¼‰
âœ“ å‰©ä½™ä»»åŠ¡éœ€è¦å“ªäº›æ ¸å¿ƒèƒ½åŠ›ï¼Ÿ
âœ“ å‰©ä½™ä»»åŠ¡æ˜¯å¦ä¾èµ–ä¹‹å‰æ­¥éª¤çš„è¾“å‡ºï¼Ÿ
âœ“ ç”¨æˆ·ç»§ç»­æ‰§è¡Œçš„æ„å›¾æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå®ŒæˆåŸå®šè®¡åˆ’ vs è¿½åŠ æ–°éœ€æ±‚ï¼‰

ç¬¬ä¸‰æ­¥ï¼šæ„å»ºç»§ç»­æ‰§è¡Œçš„å·¥å…·é›†
åŸºäºä¸Šè¿°åˆ†æï¼Œé‡æ–°ç­›é€‰å·¥å…·ï¼š

âœ“ **ä¿ç•™æœ‰æ•ˆå·¥å…·**ï¼šä¹‹å‰æˆåŠŸä½¿ç”¨ä¸”å‰©ä½™ä»»åŠ¡ä»éœ€çš„å·¥å…·
âœ“ **å¤ç”¨æœªç”¨å·¥å…·**ï¼šä¹‹å‰ç­›é€‰ä½†æœªä½¿ç”¨ï¼Œç°åœ¨å‰©ä½™ä»»åŠ¡éœ€è¦çš„å·¥å…·
âœ“ **è¡¥å……æ–°å·¥å…·**ï¼šå‰©ä½™ä»»åŠ¡éœ€è¦ä½†ä¹‹å‰æœªç­›é€‰çš„æ–°å·¥å…·
âœ“ **ç§»é™¤æ— å…³å·¥å…·**ï¼šä¹‹å‰ç­›é€‰ä½†å‰©ä½™ä»»åŠ¡ä¸å†éœ€è¦çš„å·¥å…·

âš ï¸ **è¿è´¯æ€§è¦æ±‚**ï¼š
- ä¼˜å…ˆä¿ç•™å·²éªŒè¯æœ‰æ•ˆçš„å·¥å…·ï¼ˆä¸è¦è½»æ˜“æ›´æ¢æˆåŠŸè·¯å¾„ï¼‰
- åŸºäºå·²å®Œæˆæ­¥éª¤çš„è¾“å‡ºåˆ¤æ–­åç»­éœ€æ±‚
- å¦‚æœå‰©ä½™ä»»åŠ¡æ˜ç¡®ï¼Œç²¾å‡†ç­›é€‰æ‰€éœ€å·¥å…·
- é¿å…é‡å¤ç­›é€‰å·²å®Œæˆé˜¶æ®µçš„å·¥å…·ï¼ˆé™¤éå‰©ä½™ä»»åŠ¡ç¡®å®éœ€è¦ï¼‰

ç¬¬å››æ­¥ï¼šéªŒè¯æ–°å·¥å…·é›†
âœ“ æ–°å·¥å…·é›†æ˜¯å¦è¦†ç›–å‰©ä½™ä»»åŠ¡çš„æ‰€æœ‰éœ€æ±‚ï¼Ÿ
âœ“ æ–°å·¥å…·é›†æ˜¯å¦ä¸å·²å®Œæˆæ­¥éª¤ä¿æŒè¿è´¯æ€§ï¼Ÿ
âœ“ æ–°å·¥å…·é›†æ˜¯å¦å¤ç”¨äº†éªŒè¯æœ‰æ•ˆçš„å·¥å…·ï¼Ÿ
âœ“ æ–°å·¥å…·é›†æ˜¯å¦é¿å…äº†ä¸å¿…è¦çš„é‡å¤ï¼Ÿ

è¾“å‡ºè¦æ±‚ï¼š
âœ“ è¿”å› JSON æ ¼å¼çš„ç­›é€‰ç»“æœ
âœ“ åœ¨ brief_reasoning ä¸­è¯´æ˜ï¼šåŸºäºæ‰§è¡Œå†å²ï¼Œä¸ºå‰©ä½™ä»»åŠ¡ç­›é€‰äº†å“ªäº›å·¥å…·åŠåŸå› 
âœ“ åœ¨ continuity_summary ä¸­ç®€è¿°ï¼šä¿ç•™/å¤ç”¨/æ–°å¢/ç§»é™¤çš„å·¥å…·
âœ“ å¿…é¡»åŒ…å« similarity_score å’Œ selection_confidence

ç°åœ¨è¯·å¼€å§‹ç»§ç»­ç­›é€‰å·¥å…·ã€‚"#;

// ==================== é¦–æ¬¡è§„åˆ’å·¥å…·ç­›é€‰æç¤ºè¯ï¼ˆä¿æŒå…¼å®¹ï¼‰ ====================

pub const TOOL_SELECTION_USER_TEMPLATE: &str = r#"
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ä»»åŠ¡ä¿¡æ¯ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ ä»»åŠ¡æè¿°ï¼š
{task_description}

ğŸ“Š ä»»åŠ¡å…ƒæ•°æ®ï¼š
{metadata}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å¯ç”¨å·¥å…·åº“ã€‘å…± {tool_count} ä¸ªå·¥å…·
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{available_tools}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
threshold_guidance
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
{threshold_guidance}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€åœºæ™¯æŒ‡å¯¼ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{scene_specific_guidance}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ç­›é€‰ä»»åŠ¡ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸ **é‡è¦ï¼šè¯·å…ˆè¯„ä¼°ä»»åŠ¡çš„å¯æ‰§è¡Œæ€§å’Œæ˜ç¡®æ„å›¾**

âš ï¸âš ï¸âš ï¸ ç¬¬ä¸€æ­¥ï¼šè¯†åˆ«ä»»åŠ¡æ„å›¾ï¼Œå†³å®šç­›é€‰æ¨¡å¼ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ - å¼ºåˆ¶æ‰§è¡Œï¼ï¼‰
âœ“ ä»»åŠ¡æè¿°ä¸­æ˜¯å¦åŒ…å«"æ„å›¾: XXX"æ ¼å¼ï¼Ÿ

**å¦‚æœåŒ…å«"æ„å›¾: XXX"æ ¼å¼ â†’ ä½¿ç”¨ã€åˆ†ç±»ä¼˜å…ˆ + è¯­ä¹‰è¡¥å……æ¨¡å¼ã€‘**

  ğŸ”´ **é˜¶æ®µ1ï¼šåˆ†ç±»ç­›é€‰ï¼ˆä¸»å·¥å…·é›†ï¼‰**
  âœ… å°† XXX ç›´æ¥ä½œä¸º task_typeï¼ˆå¦‚"å·¥å…·ç®¡ç†"ã€"PLCæ§åˆ¶å™¨"ï¼‰
  âœ… **ä¼˜å…ˆ**é€‰æ‹©å·¥å…·ã€Œåˆ†ç±»ã€å­—æ®µ = XXX çš„æ‰€æœ‰ç›¸å…³å·¥å…·
  âœ… è¿™æ˜¯æ ¸å¿ƒå·¥å…·é›†ï¼Œç”¨äºæ»¡è¶³æ„å›¾åˆ†ç±»çš„åŸºæœ¬éœ€æ±‚

  ğŸŸ¡ **é˜¶æ®µ2ï¼šè¯­ä¹‰è¡¥å……ï¼ˆè¡¥å……å·¥å…·é›†ï¼‰**
  âš ï¸ **å…³é”®åˆ¤æ–­**ï¼šè¯„ä¼°é˜¶æ®µ1çš„åˆ†ç±»å·¥å…·æ˜¯å¦è¶³ä»¥å®Œæˆç”¨æˆ·è¾“å…¥ä¸­çš„å®é™…ä»»åŠ¡

  **åˆ¤æ–­æ ‡å‡†ï¼š**
  - åˆ†ç±»å·¥å…·èƒ½å¦æä¾›ç”¨æˆ·è¾“å…¥æ‰€éœ€çš„**æ ¸å¿ƒåŠŸèƒ½**ï¼Ÿ
  - åˆ†ç±»å·¥å…·èƒ½å¦å¤„ç†ç”¨æˆ·è¾“å…¥ä¸­çš„**é¢†åŸŸç‰¹å®šéœ€æ±‚**ï¼Ÿ

  **å¦‚æœä¸è¶³**ï¼ˆåˆ†ç±»å·¥å…·åªèƒ½æä¾›æ¡†æ¶/æµç¨‹ï¼Œæ— æ³•æä¾›å®é™…åŠŸèƒ½ï¼‰ï¼š
    âœ… ä»å…¶ä»–åˆ†ç±»ä¸­å¯»æ‰¾ä¸ç”¨æˆ·è¾“å…¥**è¯­ä¹‰é«˜åº¦ç›¸ä¼¼**çš„å·¥å…·ï¼ˆç›¸ä¼¼åº¦ â‰¥ 75%ï¼‰
    âœ… ä¼˜å…ˆæ·»åŠ èƒ½å¼¥è¡¥åŠŸèƒ½ç¼ºå£çš„é¢†åŸŸä¸“ç”¨å·¥å…·
    âœ… åœ¨ brief_reasoning ä¸­è¯´æ˜ï¼š"åˆ†ç±»å·¥å…·Xä¸ªï¼ˆåŠŸèƒ½ï¼‰+ è¡¥å……å·¥å…·Yä¸ªï¼ˆåŠŸèƒ½ï¼‰"

  **å¦‚æœå·²è¶³å¤Ÿ**ï¼ˆåˆ†ç±»å·¥å…·å·²åŒ…å«å®Œæˆä»»åŠ¡æ‰€éœ€çš„æ‰€æœ‰èƒ½åŠ›ï¼‰ï¼š
    âŒ ä¸æ·»åŠ å…¶ä»–åˆ†ç±»çš„å·¥å…·
    âœ… åœ¨ brief_reasoning ä¸­è¯´æ˜ï¼š"ä»…ä½¿ç”¨Xä¸ªåˆ†ç±»å·¥å…·å³å¯æ»¡è¶³éœ€æ±‚"

  ç¤ºä¾‹åˆ¤æ–­ï¼š
  - æ„å›¾="å·¥å…·ç®¡ç†"ï¼Œç”¨æˆ·æƒ³"åˆ›å»ºBIMæ•°å­—å­ªç”Ÿå·¥å…·"
    â†’ é˜¶æ®µ1ï¼šé€‰æ‹© genesis_document_generateã€genesis_tool_registerï¼ˆåˆ›å»ºå·¥å…·é…ç½®ï¼‰
    â†’ é˜¶æ®µ2åˆ¤æ–­ï¼šè¿™äº›å·¥å…·åªèƒ½åˆ›å»ºç©ºå£³ï¼Œæ— æ³•æä¾›BIMæ•°å­—å­ªç”Ÿçš„å®é™…åŠŸèƒ½ âš ï¸ ä¸è¶³
    â†’ é˜¶æ®µ2è¡¥å……ï¼šæ·»åŠ åˆ†ç±»="BIMæ•°æ®å¤„ç†"çš„BIMå·¥å…·ï¼ˆæä¾›å®é™…åŠŸèƒ½ï¼Œç›¸ä¼¼åº¦>75%ï¼‰
    â†’ æœ€ç»ˆï¼šåˆ†ç±»å·¥å…·4ä¸ªï¼ˆåˆ›å»ºæ³¨å†Œæµç¨‹ï¼‰+ BIMå·¥å…·3ä¸ªï¼ˆå®é™…åŠŸèƒ½ï¼‰

  - æ„å›¾="å·¥å…·ç®¡ç†"ï¼Œç”¨æˆ·æƒ³"åˆ é™¤æŸä¸ªå·¥å…·"
    â†’ é˜¶æ®µ1ï¼šé€‰æ‹© genesis_tool_deleteã€genesis_tool_listï¼ˆåˆ é™¤å’ŒæŸ¥è¯¢ï¼‰
    â†’ é˜¶æ®µ2åˆ¤æ–­ï¼šåˆ é™¤å·¥å…·å·²ç»å®Œå…¨æ»¡è¶³éœ€æ±‚ âœ… è¶³å¤Ÿ
    â†’ é˜¶æ®µ2è¡¥å……ï¼šæ— éœ€æ·»åŠ 
    â†’ æœ€ç»ˆï¼šä»…2ä¸ªåˆ†ç±»å·¥å…·

**å¦‚æœä¸åŒ…å«"æ„å›¾: XXX"æ ¼å¼ â†’ ä½¿ç”¨ã€çº¯è¯­ä¹‰ç­›é€‰æ¨¡å¼ã€‘**
  âœ… æ ¹æ®ä»»åŠ¡æè¿°è¯­ä¹‰åˆ†æéœ€æ±‚
  âœ… æ ¹æ®å·¥å…·åŠŸèƒ½ã€æè¿°ã€æ ‡ç­¾è¿›è¡Œè¯­ä¹‰åŒ¹é…
  âœ… ä¸å—åˆ†ç±»é™åˆ¶

ç¬¬äºŒæ­¥ï¼šè¯„ä¼°ä»»åŠ¡æè¿°
âœ“ ä»»åŠ¡æè¿°æ˜¯å¦æ¸…æ™°æ˜ç¡®ï¼Ÿ
âœ“ ä»»åŠ¡æè¿°æ˜¯å¦åŒ…å«å…·ä½“çš„åŠ¨ä½œè¯å’Œç›®æ ‡ï¼Ÿ
âœ“ ä»»åŠ¡æè¿°ä¸å·¥å…·åº“çš„ç›¸ä¼¼åº¦æ˜¯å¤šå°‘ï¼Ÿï¼ˆ0-100åˆ†ï¼‰
âœ“ å¦‚æœç›¸ä¼¼åº¦ < 30%ï¼Œåº”è¯¥æ‹’ç»ä»»åŠ¡

ç¬¬ä¸‰æ­¥ï¼šæ ¹æ®ç¬¬ä¸€æ­¥ç¡®å®šçš„æ¨¡å¼ç­›é€‰å·¥å…·
è¯·ä»ä¸Šè¿° {tool_count} ä¸ªå·¥å…·ä¸­ç­›é€‰å‡ºå®Œæˆä»»åŠ¡æ‰€éœ€çš„æ‰€æœ‰å·¥å…·ã€‚

ç­›é€‰è¦æ±‚ï¼š
âœ“ **å¦‚æœæœ‰æ˜ç¡®æ„å›¾**ï¼š
  - é˜¶æ®µ1ï¼šä¼˜å…ˆé€‰æ‹©ã€Œåˆ†ç±»ã€= æ„å›¾çš„æ‰€æœ‰ç›¸å…³å·¥å…·ï¼ˆä¸»å·¥å…·é›†ï¼‰
  - é˜¶æ®µ2ï¼šè¯„ä¼°ä¸»å·¥å…·é›†æ˜¯å¦è¶³å¤Ÿ
    - å¦‚æœä¸è¶³ï¼šè¡¥å……ä¸ç”¨æˆ·è¾“å…¥è¯­ä¹‰é«˜åº¦ç›¸ä¼¼çš„å…¶ä»–åˆ†ç±»å·¥å…·ï¼ˆâ‰¥75%ç›¸ä¼¼åº¦ï¼‰
    - å¦‚æœè¶³å¤Ÿï¼šæ— éœ€è¡¥å……ï¼Œé¿å…è¿‡åº¦ç­›é€‰
  - åœ¨ brief_reasoning ä¸­æ˜ç¡®è¯´æ˜å·¥å…·æ¥æºï¼ˆåˆ†ç±»å·¥å…· + è¡¥å……å·¥å…·ï¼‰

âœ“ **å¦‚æœæ— æ˜ç¡®æ„å›¾**ï¼šæ ¹æ®è¯­ä¹‰ç›¸ä¼¼åº¦é€‰æ‹©æœ€ç›¸å…³çš„å·¥å…·ï¼Œä¸å—åˆ†ç±»é™åˆ¶
âœ“ ç¦æ­¢åŸºäºå·¥å…·åº“ç»„æˆæ¨æ–­ä»»åŠ¡ç±»å‹

è¾“å‡ºè¦æ±‚ï¼š
âœ“ è¿”å› JSON æ ¼å¼çš„ç­›é€‰ç»“æœï¼ˆåŒ…å« should_reject å­—æ®µï¼‰
âœ“ å¦‚æœåº”è¯¥æ‹’ç»ï¼Œè®¾ç½® should_reject=true å¹¶æä¾› reject_reason
âœ“ å¦‚æœå¯ä»¥æ‰§è¡Œï¼Œè®¾ç½® should_reject=false å¹¶æä¾›ç­›é€‰çš„å·¥å…·IDåˆ—è¡¨
âœ“ å¿…é¡»åŒ…å« similarity_scoreï¼ˆä»»åŠ¡æè¿°ä¸å·¥å…·åº“çš„ç›¸ä¼¼åº¦ï¼‰
âœ“ ç®€è¦è¯´æ˜ç­›é€‰æˆ–æ‹’ç»çš„ç†ç”±

ç°åœ¨è¯·å¼€å§‹è¯„ä¼°å’Œç­›é€‰ã€‚"#;

/// å·¥å…·ç­›é€‰æç¤ºè¯æ„å»ºå™¨
pub struct SelectionPromptBuilder {
    /// ç»Ÿä¸€çš„åœºæ™¯ç®¡ç†å™¨
    scene_manager: SceneManager,
}

impl Default for SelectionPromptBuilder {
    fn default() -> Self {
        Self::new()
    }
}

impl SelectionPromptBuilder {
    /// åˆ›å»ºæ–°çš„ç­›é€‰æç¤ºè¯æ„å»ºå™¨
    pub fn new() -> Self {
        Self {
            scene_manager: SceneManager::new(),
        }
    }

    /// æ„å»ºå·¥å…·é€‰æ‹©æç¤ºè¯ï¼ˆä¸¤é˜¶æ®µè§„åˆ’çš„ç¬¬ä¸€é˜¶æ®µï¼‰
    ///
    /// # å‚æ•°
    /// - `task_description`: ä»»åŠ¡æè¿°
    /// - `available_tools`: å¯ç”¨å·¥å…·åˆ—è¡¨
    /// - `tool_count`: å·¥å…·æ•°é‡
    /// - `metadata`: ä»»åŠ¡å…ƒæ•°æ®
    /// - `selection_threshold`: ç­›é€‰é˜ˆå€¼
    /// - `task_type`: ä»»åŠ¡ç±»å‹ï¼ˆç”¨äºåœºæ™¯åŒ¹é…ï¼‰
    pub fn build_tool_selection_prompt(
        &self,
        task_description: &str,
        available_tools: &str,
        tool_count: usize,
        metadata: &std::collections::HashMap<String, String>,
        selection_threshold: f32,
        task_type: Option<&str>,
    ) -> (String, String) {
        // æ ¼å¼åŒ–å…ƒæ•°æ®
        let metadata_str = if metadata.is_empty() {
            "æ— ".to_string()
        } else {
            metadata
                .iter()
                .map(|(k, v)| format!("  - {}: {}", k, v))
                .collect::<Vec<_>>()
                .join("\n")
        };

        // æ ¹æ®é˜ˆå€¼ç”Ÿæˆç­›é€‰ä¸¥æ ¼åº¦è¯´æ˜
        let threshold_guidance = Self::format_threshold_guidance(selection_threshold);

        // è·å–åœºæ™¯ç‰¹å®šçš„ç­›é€‰æŒ‡å¯¼
        let scene_guidance = self.scene_manager.get_selection_guidance(task_type);

        let user_prompt = TOOL_SELECTION_USER_TEMPLATE
            .replace("{task_description}", task_description)
            .replace("{available_tools}", available_tools)
            .replace("{tool_count}", &tool_count.to_string())
            .replace("{metadata}", &metadata_str)
            .replace("{threshold_guidance}", &threshold_guidance)
            .replace("{scene_specific_guidance}", scene_guidance);

        (TOOL_SELECTION_SYSTEM_PROMPT.to_string(), user_prompt)
    }

    /// ğŸ†• æ„å»ºé‡æ–°è§„åˆ’çš„å·¥å…·ç­›é€‰æç¤ºè¯
    ///
    /// # å‚æ•°
    /// - `task_description`: ä»»åŠ¡æè¿°
    /// - `available_tools`: å¯ç”¨å·¥å…·åˆ—è¡¨
    /// - `tool_count`: å·¥å…·æ•°é‡
    /// - `metadata`: ä»»åŠ¡å…ƒæ•°æ®
    /// - `selection_threshold`: ç­›é€‰é˜ˆå€¼
    /// - `replanning_context`: é‡æ–°è§„åˆ’ä¸Šä¸‹æ–‡ï¼ˆåŒ…å«æ‰§è¡Œå†å²ã€åæ€åˆ†æç­‰ï¼‰
    /// - `task_type`: ä»»åŠ¡ç±»å‹ï¼ˆç”¨äºåœºæ™¯åŒ¹é…ï¼‰
    pub fn build_replanning_tool_selection_prompt(
        &self,
        task_description: &str,
        available_tools: &str,
        tool_count: usize,
        metadata: &std::collections::HashMap<String, String>,
        selection_threshold: f32,
        replanning_context: &ReplanningToolSelectionContext,
        task_type: Option<&str>,
    ) -> (String, String) {
        // æ ¼å¼åŒ–å…ƒæ•°æ®
        let metadata_str = if metadata.is_empty() {
            "æ— ".to_string()
        } else {
            metadata
                .iter()
                .map(|(k, v)| format!("  - {}: {}", k, v))
                .collect::<Vec<_>>()
                .join("\n")
        };

        // æ ¼å¼åŒ–ä¹‹å‰çš„å·¥å…·é€‰æ‹©ç»“æœ
        let previous_tools_text = Self::format_previous_tools(&replanning_context.previous_tools);

        // æ ¼å¼åŒ–æ•´ä½“åæ€æŒ‡å¯¼
        let overall_reflection_text = replanning_context
            .overall_reflection_guidance
            .as_deref()
            .unwrap_or("(æœªè§¦å‘æ•´ä½“åæ€)");

        // æ ¹æ®é˜ˆå€¼ç”Ÿæˆç­›é€‰ä¸¥æ ¼åº¦è¯´æ˜
        let threshold_guidance = Self::format_threshold_guidance(selection_threshold);

        // è·å–åœºæ™¯ç‰¹å®šçš„ç­›é€‰æŒ‡å¯¼
        let scene_guidance = self.scene_manager.get_selection_guidance(task_type);

        // æ„å»ºç”¨æˆ·æç¤ºè¯
        let user_prompt = REPLANNING_TOOL_SELECTION_USER_TEMPLATE
            .replace("{task_description}", task_description)
            .replace("{metadata}", &metadata_str)
            .replace("{previous_tool_selection}", &previous_tools_text)
            .replace("{execution_history}", &replanning_context.execution_history)
            .replace("{reflection_analysis}", &replanning_context.reflection_analysis)
            .replace("{overall_reflection_guidance}", overall_reflection_text)
            .replace("{available_tools}", available_tools)
            .replace("{tool_count}", &tool_count.to_string())
            .replace("{threshold_guidance}", &threshold_guidance)
            .replace("{scene_specific_guidance}", scene_guidance);

        (REPLANNING_TOOL_SELECTION_SYSTEM_PROMPT.to_string(), user_prompt)
    }

    /// ğŸ†• æ„å»ºç»§ç»­è§„åˆ’çš„å·¥å…·ç­›é€‰æç¤ºè¯
    ///
    /// # å‚æ•°
    /// - `task_description`: ä»»åŠ¡æè¿°
    /// - `available_tools`: å¯ç”¨å·¥å…·åˆ—è¡¨
    /// - `tool_count`: å·¥å…·æ•°é‡
    /// - `metadata`: ä»»åŠ¡å…ƒæ•°æ®
    /// - `selection_threshold`: ç­›é€‰é˜ˆå€¼
    /// - `continue_context`: ç»§ç»­è§„åˆ’ä¸Šä¸‹æ–‡ï¼ˆåŒ…å«æ‰§è¡Œå†å²ã€å‰©ä½™ä»»åŠ¡ç­‰ï¼‰
    /// - `task_type`: ä»»åŠ¡ç±»å‹ï¼ˆç”¨äºåœºæ™¯åŒ¹é…ï¼‰
    pub fn build_continue_planning_tool_selection_prompt(
        &self,
        task_description: &str,
        available_tools: &str,
        tool_count: usize,
        metadata: &std::collections::HashMap<String, String>,
        selection_threshold: f32,
        continue_context: &ContinuePlanningToolSelectionContext,
        task_type: Option<&str>,
    ) -> (String, String) {
        // æ ¼å¼åŒ–å…ƒæ•°æ®
        let metadata_str = if metadata.is_empty() {
            "æ— ".to_string()
        } else {
            metadata
                .iter()
                .map(|(k, v)| format!("  - {}: {}", k, v))
                .collect::<Vec<_>>()
                .join("\n")
        };

        // æ ¼å¼åŒ–ä¹‹å‰çš„å·¥å…·é€‰æ‹©ç»“æœ
        let previous_tools_text = Self::format_previous_tools(&continue_context.previous_tools);

        // æ ¼å¼åŒ–ç»§ç»­è§„åˆ’åŸå› 
        let continue_reason_text = continue_context
            .continue_reason
            .as_deref()
            .unwrap_or("(ç”¨æˆ·é€‰æ‹©ç»§ç»­æ‰§è¡Œ)");

        // æ ¼å¼åŒ–å‰©ä½™ä»»åŠ¡
        let remaining_tasks_text = continue_context
            .remaining_tasks
            .as_deref()
            .unwrap_or("(åŸºäºå·²å®Œæˆæ­¥éª¤ï¼Œç»§ç»­å®Œæˆå‰©ä½™å·¥ä½œ)");

        // æ ¹æ®é˜ˆå€¼ç”Ÿæˆç­›é€‰ä¸¥æ ¼åº¦è¯´æ˜
        let threshold_guidance = Self::format_threshold_guidance(selection_threshold);

        // è·å–åœºæ™¯ç‰¹å®šçš„ç­›é€‰æŒ‡å¯¼
        let scene_guidance = self.scene_manager.get_selection_guidance(task_type);

        // æ„å»ºç”¨æˆ·æç¤ºè¯
        let user_prompt = CONTINUE_PLANNING_TOOL_SELECTION_USER_TEMPLATE
            .replace("{task_description}", task_description)
            .replace("{metadata}", &metadata_str)
            .replace("{previous_tool_selection}", &previous_tools_text)
            .replace("{execution_history}", &continue_context.execution_history)
            .replace("{continue_reason}", continue_reason_text)
            .replace("{remaining_tasks}", remaining_tasks_text)
            .replace("{available_tools}", available_tools)
            .replace("{tool_count}", &tool_count.to_string())
            .replace("{threshold_guidance}", &threshold_guidance)
            .replace("{scene_specific_guidance}", scene_guidance);

        (CONTINUE_PLANNING_TOOL_SELECTION_SYSTEM_PROMPT.to_string(), user_prompt)
    }

    /// æ ¼å¼åŒ–ä¹‹å‰çš„å·¥å…·é€‰æ‹©ç»“æœ
    fn format_previous_tools(tools: &[PreviousToolInfo]) -> String {
        if tools.is_empty() {
            return "(ä¹‹å‰æœªè¿›è¡Œå·¥å…·ç­›é€‰)".to_string();
        }

        let mut result = String::new();
        result.push_str("ã€å·¥å…·åˆ—è¡¨åŠæ‰§è¡Œæ•ˆæœã€‘\n\n");

        for tool in tools {
            let status_icon = match tool.execution_status.as_str() {
                "Success" => "âœ…",
                "Failed" => "âŒ",
                "NotUsed" => "âšª",
                _ => "â“",
            };

            result.push_str(&format!(
                "{} **{}** (ID: {})\n",
                status_icon, tool.tool_name, tool.tool_id
            ));
            result.push_str(&format!("   çŠ¶æ€: {}\n", tool.execution_status));

            if let Some(summary) = &tool.execution_summary {
                result.push_str(&format!("   æ‰§è¡Œæ‘˜è¦: {}\n", summary));
            }

            if let Some(reason) = &tool.failure_reason {
                result.push_str(&format!("   å¤±è´¥åŸå› : {}\n", reason));
            }

            result.push('\n');
        }

        result
    }

    /// æ ¼å¼åŒ–é˜ˆå€¼æŒ‡å¯¼è¯´æ˜
    fn format_threshold_guidance(selection_threshold: f32) -> String {
        format!(
            r#"
ã€ğŸ¯ ç­›é€‰ä¸¥æ ¼åº¦é…ç½®ã€‘
å½“å‰ç›¸ä¼¼åº¦é˜ˆå€¼è®¾ç½®ä¸º: {:.0}ï¼ˆæ»¡åˆ†100åˆ†ï¼‰

æ ¹æ®æ­¤é˜ˆå€¼ï¼Œä½ åº”è¯¥éµå¾ªä»¥ä¸‹ç­›é€‰æ ‡å‡†ï¼š
{}"#,
            selection_threshold,
            if selection_threshold >= 85.0 {
                r#"
âœ… **æåº¦ä¸¥æ ¼æ¨¡å¼ï¼ˆé˜ˆå€¼ â‰¥ 85ï¼‰**
   - åªé€‰æ‹©ä¸ä»»åŠ¡æè¿°**æ ¸å¿ƒéœ€æ±‚**ç›´æ¥ç›¸å…³çš„å·¥å…·
   - æ’é™¤æ‰€æœ‰"å¯èƒ½ç”¨åˆ°"ã€"è¾…åŠ©æ€§"çš„å·¥å…·
   - æ¯ä¸ªå·¥å…·å¿…é¡»åœ¨ä»»åŠ¡æè¿°ä¸­æœ‰æ˜ç¡®å¯¹åº”çš„éœ€æ±‚
   - é¢„æœŸä¿ç•™å·¥å…·æ•°é‡ï¼šåŸå§‹æ•°é‡çš„ 15-25%
   - ç¤ºä¾‹ï¼šå¦‚æœä»»åŠ¡æ˜¯"æ•°å­—å­ªç”Ÿå»ºæ¨¡"ï¼Œåªä¿ç•™ bms_data_collector, geometry_modeler, equipment_modeler ç­‰æ ¸å¿ƒå·¥å…·
     æ’é™¤é€šç”¨çš„æ•°æ®å¤„ç†ã€å¯è§†åŒ–ã€æŠ¥å‘Šç”Ÿæˆç­‰è¾…åŠ©å·¥å…·"#
            } else if selection_threshold >= 75.0 {
                r#"
âœ… **ä¸¥æ ¼æ¨¡å¼ï¼ˆ75 â‰¤ é˜ˆå€¼ < 85ï¼‰**
   - ä¼˜å…ˆé€‰æ‹©é«˜åº¦ç›¸å…³çš„å·¥å…·ï¼Œè°¨æ…é€‰æ‹©ä¸­ç­‰ç›¸å…³çš„å·¥å…·
   - æ’é™¤ä½ç›¸å…³æ€§å’Œå¯é€‰çš„è¾…åŠ©å·¥å…·
   - é¢„æœŸä¿ç•™å·¥å…·æ•°é‡ï¼šåŸå§‹æ•°é‡çš„ 30-40%
   - ç¤ºä¾‹ï¼šé€‰æ‹©æ ¸å¿ƒä¸šåŠ¡å·¥å…·å’Œå¿…è¦çš„æ•°æ®å¤„ç†å·¥å…·ï¼Œæ’é™¤é€šç”¨åˆ†æå’Œå¯é€‰çš„å¯è§†åŒ–å·¥å…·"#
            } else if selection_threshold >= 65.0 {
                r#"
âœ… **é€‚ä¸­æ¨¡å¼ï¼ˆ65 â‰¤ é˜ˆå€¼ < 75ï¼‰**
   - é€‰æ‹©é«˜åº¦ç›¸å…³å’Œä¸­ç­‰ç›¸å…³çš„å·¥å…·
   - å¯ä»¥ä¿ç•™éƒ¨åˆ†å¯èƒ½æœ‰ç”¨çš„è¾…åŠ©å·¥å…·
   - é¢„æœŸä¿ç•™å·¥å…·æ•°é‡ï¼šåŸå§‹æ•°é‡çš„ 45-55%
   - ç¤ºä¾‹ï¼šä¿ç•™æ ¸å¿ƒå·¥å…·ã€å¸¸ç”¨æ•°æ®å¤„ç†å·¥å…·å’Œéƒ¨åˆ†è¾…åŠ©å·¥å…·"#
            } else {
                r#"
âœ… **å®½æ¾æ¨¡å¼ï¼ˆé˜ˆå€¼ < 65ï¼‰**
   - ä¿ç•™æ‰€æœ‰å¯èƒ½ç›¸å…³çš„å·¥å…·
   - å®å¯å¤šé€‰ä¸å¯æ¼é€‰
   - é¢„æœŸä¿ç•™å·¥å…·æ•°é‡ï¼šåŸå§‹æ•°é‡çš„ 60%ä»¥ä¸Š
   - ç¤ºä¾‹ï¼šä¿ç•™å¤§éƒ¨åˆ†å¯èƒ½ç”¨åˆ°çš„å·¥å…·ï¼Œç¡®ä¿ä»»åŠ¡æ‰§è¡Œçš„å®Œæ•´æ€§"#
            }
        )
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_build_tool_selection_prompt() {
        let builder = SelectionPromptBuilder::new();
        let metadata = std::collections::HashMap::new();
        let (system, user) = builder.build_tool_selection_prompt(
            "åˆ›å»ºè®¡ç®—å™¨å·¥å…·",
            "å·¥å…·1\nå·¥å…·2",
            2,
            &metadata,
            75.0,
            Some("å·¥å…·ç®¡ç†"),
        );

        assert!(system.contains("å·¥å…·ç­›é€‰ä¸“å®¶"));
        assert!(user.contains("åˆ›å»ºè®¡ç®—å™¨å·¥å…·"));
        assert!(user.contains("å·¥å…·1"));
        assert!(user.contains("ä¸¥æ ¼æ¨¡å¼"));
        assert!(user.contains("åœºæ™¯æŒ‡å¯¼"));
    }

    #[test]
    fn test_threshold_guidance_strict() {
        let guidance = SelectionPromptBuilder::format_threshold_guidance(85.0);
        assert!(guidance.contains("æåº¦ä¸¥æ ¼æ¨¡å¼"));
        assert!(guidance.contains("15-25%"));
    }

    #[test]
    fn test_threshold_guidance_loose() {
        let guidance = SelectionPromptBuilder::format_threshold_guidance(60.0);
        assert!(guidance.contains("å®½æ¾æ¨¡å¼"));
        assert!(guidance.contains("60%ä»¥ä¸Š"));
    }
}
