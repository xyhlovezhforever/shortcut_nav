# 反思输出结构化优化

## 📋 优化背景

### 问题描述
原始的反思输出缺乏结构化,呈现混乱无序的状态:

**原始反思内容示例:**
```
错误发生在 请求发送阶段（非服务返回业务错误）; 目标 URL 为内网地址 http://192.168.0.141:9885; 所有可用工具（包括 genesis_tool_test）均依赖同一后端服务; 单步反思已明确归类为 external_error，置信度 95%; 后端服务未运行（进程崩溃或未启动）; 目标 IP 或端口不可达（防火墙、路由、Docker 网络隔离等）; 服务过载或死锁，无法响应新连接; 思路：不依赖远程服务，改用本地 Python 脚本动态生成符合 pytest 规范的测试文件。; 实施：使用内置代码生成能力（如 f-string 模板）直接输出 test_auspicious_phrase_generator.py，覆盖主要功能场景。; 优势：完全绕过后端服务依赖，自主可控。; 前提：系统允许执行本地代码生成（非仅限调用预定义工具）。; ...
```

**主要问题:**
1. ❌ 内容混乱,没有清晰的章节划分
2. ❌ 缺乏逻辑层次,难以快速定位关键信息
3. ❌ 证据、推理、结论混在一起,不易理解
4. ❌ 改进建议没有结构化呈现,难以选择最佳方案
5. ❌ 决策理由不清晰,无法理解为何做出某个决定

---

## 🎯 优化目标

1. **结构化输出**: 明确的章节划分和层级结构
2. **逻辑清晰**: 遵循"证据→推理→结论"的逻辑链条
3. **易于阅读**: 使用 Markdown 格式,清晰的标题和列表
4. **方案对比**: 提供多个不同思路的改进方案,便于选择
5. **决策透明**: 清晰展示决策流程和理由

---

## 🔧 优化方案

### 1. 整体反思输出结构

修改后的输出结构包含5个主要章节:

```markdown
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
## 📋 1. 执行情况概览
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【当前状态】
- 轮次：第 X 轮
- 问题是否重复：[是/否]
- 任务完成度：X%

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
## 🔍 2. 问题诊断
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【问题描述】
- 发生了什么：[用1-2句话描述核心问题]

【证据链条】
- 证据1：[引用具体的错误信息/执行结果]
- 证据2：[引用执行历史中的关键信息]
- 证据3：[其他支撑证据]

【根本原因分析】
1. 直接原因：[表面现象]
   └─ 深层原因：[根本原因]
      └─ 证据支持：[对应证据]

【问题分类】
- 类型：[参数问题/工具问题/服务端问题/外部问题]
- 可恢复性：[可/不可]
- 影响范围：[单步骤/多步骤/全局]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
## 💡 3. 改进方案（多思路）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【方案A：保守修复】
- 核心思路：[在原方案基础上针对性修复]
- 具体步骤：
  1. [步骤1]
  2. [步骤2]
- 预期效果：[解决什么问题]
- 风险评估：[潜在风险]

【方案B：优化调整】
- 核心思路：[调整步骤/工具/并行策略]
- 具体步骤：
  1. [步骤1]
  2. [步骤2]
- 预期效果：[解决什么问题]
- 风险评估：[潜在风险]

【方案C：创新重构】（可选）
- 核心思路：[完全不同的实现思路]
- 具体步骤：
  1. [步骤1]
  2. [步骤2]
- 预期效果：[解决什么问题]
- 风险评估：[潜在风险]

【推荐方案】
- 优先级排序：[A > B > C 或其他]
- 推荐理由：[为什么选这个]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
## 📌 4. 决策结论
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【决策流程】
- ✓ 步骤1：重复检测 → [结果]
- ✓ 步骤2：完成度评估 → [结果]
- ✓ 步骤3：问题性质判断 → [结果]

【最终决策】
[建议重新规划 / 任务已完成，无需重新规划 / 建议停止反思 / 服务端错误，建议停止反思]

【决策理由】
- [说明为什么做出这个决策]
- [是否有新见解支持继续]
- [或为什么应该停止]

【重新规划策略】（仅当决策为"建议重新规划"时填写）
- 策略类型：[完整重规划/从指定步骤开始重规划/跳过指定步骤/添加补救步骤/调整依赖关系]
- 具体建议：[详细说明]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
## 📚 5. 经验总结
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【错误假设】（如有）
- [之前的错误假设1]
- [之前的错误假设2]

【经验教训】
- [可复用的经验1]
- [可复用的经验2]

【注意事项】
- [未来应该避免的陷阱]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 2. 单步反思输出结构

单步反思输出也进行了结构化优化:

```markdown
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
## 📋 1. 执行历史审查（最高优先级）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【重复错误检测】
- 相同工具失败次数：X 次
- 错误信息是否相同：[是/否]
- 历史尝试方案：
  1. [方案1及结果]
  2. [方案2及结果]

【判定结果】
- 是否重复错误：[是/否]
- 如果是，为什么必须停止单步修复：[理由]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
## 🔍 2. 错误分析
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【证据收集】
- HTTP状态码：[如有]
- 错误类型：[从错误信息中提取]
- 错误描述：[具体描述]
- 相关参数：[从元数据中提取]

【因果推理】
1. 观察：[具体的错误表现]
   └─ 证据：[对应的错误信息/日志]
   └─ 推断：[基于证据的推理]
   └─ 结论：[根本原因]

【排除分析】
- 排除原因1：[为什么不是这个原因]
- 排除原因2：[为什么不是这个原因]

【最终结论】
- 根本原因分类：[parameter_error/tool_error/server_error/external_error等]
- 根本原因描述：[一句话概括]
- 可恢复性：[可/不可]
- 可信度：X%

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
## 💡 3. 建议方案
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【主要方案】
- 方案类型：[retry_with_params/retry_with_tool/replan/trigger_overall_reflection]
- 具体内容：[...]
- 预期效果：[解决什么问题]

【备选方案】（如有）
1. [备选方案1]
2. [备选方案2]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## ✅ 优化效果

### 改进前后对比

| 维度 | 改进前 | 改进后 |
|------|--------|--------|
| **可读性** | ❌ 混乱无序,难以阅读 | ✅ 结构清晰,易于理解 |
| **逻辑性** | ❌ 证据、推理、结论混杂 | ✅ 遵循"证据→推理→结论" |
| **信息定位** | ❌ 难以快速找到关键信息 | ✅ 清晰的章节划分 |
| **方案对比** | ❌ 改进建议堆砌在一起 | ✅ 多方案结构化对比 |
| **决策透明** | ❌ 决策理由不清晰 | ✅ 完整的决策流程展示 |

### 优化后的优势

1. **快速定位问题**: 通过章节标题可以快速跳转到感兴趣的部分
2. **逻辑清晰**: 证据、推理、结论分层呈现,易于理解
3. **方案对比**: 多个改进方案并列展示,便于选择最佳方案
4. **决策透明**: 完整展示决策流程,便于理解和审查
5. **易于维护**: 结构化格式便于后续修改和扩展

---

## 📝 实现细节

### 1. 提示词修改

修改了两个核心提示词文件:

- **整体反思提示词** ([reflection_prompts.rs:308-422](d:\code\task-orchestration-service\src\llm\reflection_prompts.rs#L308-L422))
  - 添加了详细的结构化输出模板
  - 强制要求按照5个章节输出
  - 明确了每个章节的必填内容

- **单步反思提示词** ([reflection_prompts.rs:940-1011](d:\code\task-orchestration-service\src\llm\reflection_prompts.rs#L940-L1011))
  - 添加了3个章节的结构化模板
  - 强调执行历史审查的最高优先级
  - 规范了错误分析的逻辑链条

### 2. 用户提示词优化

同时更新了用户提示模板,引导大模型按照新格式输出:

- **整体反思用户提示** ([reflection_prompts.rs:589-676](d:\code\task-orchestration-service\src\llm\reflection_prompts.rs#L589-L676))
  - 明确的决策流程说明
  - 完整的模板示例
  - 强制要求四选一的决策表述

- **单步反思用户提示** ([reflection_prompts.rs:1192-1293](d:\code\task-orchestration-service\src\llm\reflection_prompts.rs#L1192-L1293))
  - 详细的诊断流程指导
  - 结构化分析模板
  - 关键检查点提醒

---

## 🚀 使用建议

### 1. 阅读反思结果

使用结构化输出后,建议按照以下顺序阅读:

1. **先看概览** (第1章) - 了解当前状态
2. **再看结论** (第4章) - 了解最终决策
3. **然后看诊断** (第2章) - 理解问题根源
4. **最后看方案** (第3章) - 评估改进方案

### 2. 评估改进方案

新格式提供了多个改进方案,建议:

1. 阅读每个方案的核心思路
2. 评估预期效果和风险
3. 参考推荐方案的优先级排序
4. 根据实际情况选择最合适的方案

### 3. 审查决策过程

决策结论章节提供了完整的决策流程:

1. 检查每个决策步骤的结果
2. 评估决策理由是否充分
3. 如果有重新规划策略,评估其合理性

---

## 📊 后续优化方向

1. **自动化验证**: 开发工具自动检查反思输出是否符合格式要求
2. **可视化展示**: 考虑将结构化内容转换为图表或流程图
3. **模板定制**: 允许用户根据场景定制输出模板
4. **历史对比**: 支持多轮反思的结构化对比分析

---

## 🔗 相关文档

- [核心逻辑文档索引](../核心逻辑文档索引.md)
- [单步反思触发整体反思与细粒度重规划策略](./21-单步反思触发整体反思与细粒度重规划策略.md)
- [重新规划策略设计](./重新规划策略设计.md)

---

## 📅 更新历史

- **2026-01-15**: 初始版本,完成整体反思和单步反思的结构化优化
