# å•æ­¥åæ€è§¦å‘æ•´ä½“åæ€ä¸ç»†ç²’åº¦é‡è§„åˆ’ç­–ç•¥

> **æœ€åæ›´æ–°æ—¶é—´**: 2026-01-14
> **ç‰ˆæœ¬**: v1.0
> **ç›¸å…³ä»£ç **: `src/core/reflector.rs`, `src/core/orchestrator.rs`, `src/llm/reflection_prompts.rs`, `src/llm/replanning_prompts.rs`

---

## ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ¶æ„å˜æ›´](#æ¶æ„å˜æ›´)
3. [å•æ­¥åæ€è§¦å‘æ•´ä½“åæ€](#å•æ­¥åæ€è§¦å‘æ•´ä½“åæ€)
4. [ç»†ç²’åº¦é‡æ–°è§„åˆ’ç­–ç•¥](#ç»†ç²’åº¦é‡æ–°è§„åˆ’ç­–ç•¥)
5. [æ•´ä½“åæ€æŒ‡å¯¼ä¿¡æ¯ä¼ é€’](#æ•´ä½“åæ€æŒ‡å¯¼ä¿¡æ¯ä¼ é€’)
6. [ä»£ç å®ç°æ˜ å°„](#ä»£ç å®ç°æ˜ å°„)
7. [æ•°æ®ç»“æ„å®šä¹‰](#æ•°æ®ç»“æ„å®šä¹‰)
8. [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)

---

## æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°å¯¹åæ€ä¸é‡æ–°è§„åˆ’æœºåˆ¶è¿›è¡Œäº†ä¸¤é¡¹é‡è¦ä¼˜åŒ–ï¼š

1. **å•æ­¥åæ€åªèƒ½é€šè¿‡æ•´ä½“åæ€è§¦å‘é‡æ–°è§„åˆ’**: å•æ­¥åæ€ä¸èƒ½ç›´æ¥è§¦å‘é‡æ–°è§„åˆ’ï¼Œæ‰€æœ‰é‡æ–°è§„åˆ’çš„å†³ç­–éƒ½å¿…é¡»ç”±æ•´ä½“åæ€æ¥åšå‡ºã€‚å½“å•æ­¥åæ€åˆ¤æ–­éœ€è¦é‡æ–°è§„åˆ’æ—¶ï¼Œå¿…é¡»è§¦å‘æ•´ä½“åæ€(TriggerOverallReflection)ï¼Œç”±æ•´ä½“åæ€ç»¼åˆè¯„ä¼°åå†³å®šæ˜¯åœæ­¢ä»»åŠ¡è¿˜æ˜¯é‡æ–°è§„åˆ’ã€‚

2. **ç»†ç²’åº¦é‡æ–°è§„åˆ’ç­–ç•¥**: æ•´ä½“åæ€ä¸å†åªæœ‰"é‡æ–°è§„åˆ’"æˆ–"åœæ­¢"ä¸¤ä¸ªé€‰é¡¹ï¼Œè€Œæ˜¯å¯ä»¥å»ºè®®å…·ä½“çš„é‡æ–°è§„åˆ’ç­–ç•¥ï¼ˆå¦‚ä»æŸä¸ªæ­¥éª¤å¼€å§‹é‡æ–°è§„åˆ’ã€è·³è¿‡æŸäº›æ­¥éª¤ã€æ·»åŠ è¡¥æ•‘æ­¥éª¤ç­‰ï¼‰ã€‚

---

## æ¶æ„å˜æ›´

### å˜æ›´å‰çš„æµç¨‹

```
å•æ­¥åæ€å¤±è´¥ â†’ StopExecution â†’ ä»»åŠ¡ç›´æ¥åœæ­¢
```

### å˜æ›´åçš„æµç¨‹

```
å•æ­¥åæ€è¾¾åˆ°é™åˆ¶ â†’ TriggerOverallReflection â†’ æ•´ä½“åæ€
                                                    â†“
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â†“                               â†“
                            should_replan=true              should_replan=false
                                    â†“                               â†“
                        é‡æ–°è§„åˆ’ï¼ˆå¸¦ç­–ç•¥å»ºè®®ï¼‰                   åœæ­¢ä»»åŠ¡
```

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

1. **èŒè´£åˆ†ç¦»**: å•æ­¥åæ€è´Ÿè´£å±€éƒ¨é—®é¢˜è¯Šæ–­ï¼Œæ•´ä½“åæ€è´Ÿè´£å…¨å±€å†³ç­–
2. **é¿å…è¿‡æ—©ç»ˆæ­¢**: å•æ­¥åæ€æ— æ³•ç›´æ¥ç»ˆæ­¢ä»»åŠ¡ï¼Œéœ€è¦æ•´ä½“åæ€ç»¼åˆè¯„ä¼°
3. **ç­–ç•¥ç²¾ç»†åŒ–**: æ•´ä½“åæ€å¯ä»¥æä¾›å…·ä½“çš„é‡æ–°è§„åˆ’ç­–ç•¥å»ºè®®

---

## å•æ­¥åæ€è§¦å‘æ•´ä½“åæ€

### StepAction æšä¸¾å˜æ›´

**æ–‡ä»¶**: [src/core/reflector.rs:52-63](../../../src/core/reflector.rs#L52-L63)

```rust
/// å•æ­¥æ‰§è¡Œå†³ç­–
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]
pub enum StepAction {
    /// ä½¿ç”¨è°ƒæ•´åçš„å‚æ•°é‡æ–°æ‰§è¡Œæœ¬æ­¥
    RetryWithAdjustedParams(HashMap<String, String>),
    /// ä½¿ç”¨å¤‡é€‰å·¥å…·é‡æ–°æ‰§è¡Œæœ¬æ­¥
    RetryWithAlternativeTool(String),
    /// é‡æ–°è§„åˆ’æ•´ä¸ªä»»åŠ¡ï¼ˆæ³¨æ„ï¼šæ­¤é€‰é¡¹ä»…ä¾›ç¼–æ’å™¨å†…éƒ¨ä½¿ç”¨ï¼Œç”±æ•´ä½“åæ€è½¬æ¢è€Œæ¥ï¼Œå•æ­¥åæ€ä¸èƒ½ç›´æ¥è¿”å›æ­¤é€‰é¡¹ï¼‰
    ReplanEntireTask,
    /// è§¦å‘æ•´ä½“åæ€ï¼ˆå•æ­¥åæ€é€šå‘é‡æ–°è§„åˆ’çš„å”¯ä¸€è·¯å¾„ï¼Œäº¤ç”±æ•´ä½“åæ€å†³å®šæ˜¯å¦åœæ­¢æˆ–é‡æ–°è§„åˆ’ï¼‰
    TriggerOverallReflection(String), // æºå¸¦å•æ­¥åæ€çš„æ‘˜è¦ä¿¡æ¯
}
```

**å˜æ›´è¯´æ˜**:
- ä¿ç•™ `ReplanEntireTask` ä½†ä»…ä¾›ç¼–æ’å™¨å†…éƒ¨ä½¿ç”¨ï¼ˆç”±æ•´ä½“åæ€è½¬æ¢ï¼‰
- å•æ­¥åæ€ä¸èƒ½ç›´æ¥è¿”å› `ReplanEntireTask`
- å•æ­¥åæ€åªèƒ½è¿”å› `TriggerOverallReflection` æ¥é—´æ¥è§¦å‘é‡æ–°è§„åˆ’
- æ‰€æœ‰é‡æ–°è§„åˆ’çš„å†³ç­–å¿…é¡»ç”±æ•´ä½“åæ€åšå‡º

### å•æ­¥åæ€æç¤ºè¯å˜æ›´

**æ–‡ä»¶**: [src/llm/reflection_prompts.rs](../../../src/llm/reflection_prompts.rs)

å•æ­¥åæ€æç¤ºè¯çš„é‡è¦å˜æ›´:

1. **ç§»é™¤ `replan` é€‰é¡¹**: å•æ­¥åæ€ä¸å†æ”¯æŒç›´æ¥è¿”å› `replan` ç±»å‹
2. **å¼ºåˆ¶ä½¿ç”¨ `trigger_overall_reflection`**: æ‰€æœ‰éœ€è¦é‡æ–°è§„åˆ’çš„åœºæ™¯éƒ½å¿…é¡»é€šè¿‡è§¦å‘æ•´ä½“åæ€
3. **æ–°å¢å¼ºåˆ¶è§„åˆ™**:
   ```
   ğŸš¨ å¼ºåˆ¶è§„åˆ™ï¼š
   - å•æ­¥åæ€ä¸èƒ½ç›´æ¥è§¦å‘é‡æ–°è§„åˆ’
   - å¿…é¡»é€šè¿‡ trigger_overall_reflection è®©æ•´ä½“åæ€å†³å®š
   - æ‰€æœ‰éœ€è¦é‡æ–°è§„åˆ’çš„æƒ…å†µéƒ½å¿…é¡»ä½¿ç”¨ trigger_overall_reflection
   ```

å•æ­¥åæ€çš„ä¸‰ç§å†³ç­–ç±»å‹:
```json
// 1. å‚æ•°ä¿®æ­£é‡è¯•
{
  "suggested_action": {
    "type": "retry_with_params",
    "data": {"param_name": "corrected_value"}
  }
}

// 2. å·¥å…·æ›¿æ¢é‡è¯•
{
  "suggested_action": {
    "type": "retry_with_tool",
    "data": "alternative_tool_id"
  }
}

// 3. è§¦å‘æ•´ä½“åæ€ï¼ˆé€šå‘é‡æ–°è§„åˆ’çš„å”¯ä¸€è·¯å¾„ï¼‰
{
  "suggested_action": {
    "type": "trigger_overall_reflection",
    "data": "å•æ­¥åæ€æ‘˜è¦ä¿¡æ¯ï¼Œæè¿°å¤±è´¥åŸå› å’Œå·²å°è¯•çš„æ–¹æ¡ˆ"
  }
}
```

### ç¼–æ’å™¨å¤„ç†é€»è¾‘

**æ–‡ä»¶**: [src/core/orchestrator.rs:2580-2673](../../../src/core/orchestrator.rs#L2580-L2673)

å½“å•æ­¥åæ€è¿”å› `TriggerOverallReflection` æ—¶ï¼Œç¼–æ’å™¨ä¼šï¼š

1. è®°å½•è§¦å‘æ•´ä½“åæ€çš„äº‹ä»¶åˆ° Kafka
2. è°ƒç”¨æ•´ä½“åæ€è¿›è¡Œå…¨å±€åˆ†æ
3. æ ¹æ®æ•´ä½“åæ€çš„ `should_replan` å†³å®šåç»­è¡ŒåŠ¨ï¼š
   - `should_replan = true`: è§¦å‘é‡æ–°è§„åˆ’
   - `should_replan = false`: åœæ­¢ä»»åŠ¡å¹¶è¿”å›ç”¨æˆ·ä»‹å…¥é”™è¯¯

```rust
StepAction::TriggerOverallReflection(summary) => {
    info!(
        task_id = task_id,
        summary = %summary,
        "ğŸ”„ å•æ­¥åæ€å»ºè®®è§¦å‘æ•´ä½“åæ€"
    );

    // ... è°ƒç”¨æ•´ä½“åæ€ ...

    if overall_reflection.should_replan {
        // ä¿å­˜æ•´ä½“åæ€çš„æŒ‡å¯¼ä¿¡æ¯ï¼Œç”¨äºä¼ é€’ç»™é‡æ–°è§„åˆ’
        overall_reflection_guidance = Some(OverallReflectionGuidance {
            root_causes: overall_reflection.root_causes.clone(),
            incorrect_assumptions: overall_reflection.incorrect_assumptions.clone(),
            alternative_approaches: overall_reflection.alternative_approaches.clone(),
            lessons_learned: overall_reflection.lessons_learned.clone(),
            replanning_strategy: overall_reflection.replanning_strategy.clone(),
        });

        // è®¾ç½® suggested_action ä¸º ReplanEntireTask
        step_reflection.suggested_action = StepAction::ReplanEntireTask;
    } else {
        // æ•´ä½“åæ€å†³å®šåœæ­¢ï¼Œè¿”å›ç”¨æˆ·ä»‹å…¥é”™è¯¯
        return Err(ServiceError::UserInterventionRequired(stop_reason).into());
    }
}
```

---

## ç»†ç²’åº¦é‡æ–°è§„åˆ’ç­–ç•¥

### ReplanningStrategy æšä¸¾

**æ–‡ä»¶**: [src/llm/replanning_prompts.rs:23-43](../../../src/llm/replanning_prompts.rs#L23-L43)

```rust
/// é‡æ–°è§„åˆ’ç­–ç•¥
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum ReplanningStrategy {
    /// å®Œæ•´é‡æ–°è§„åˆ’æ•´ä¸ªä»»åŠ¡
    FullReplan,

    /// ä»æŒ‡å®šæ­¥éª¤å¼€å§‹é‡æ–°è§„åˆ’ï¼ˆä¿ç•™ä¹‹å‰æˆåŠŸçš„æ­¥éª¤ï¼‰
    ReplanFromStep {
        step_id: String,
        reason: String
    },

    /// è·³è¿‡æŒ‡å®šçš„æ­¥éª¤ï¼ˆè¿™äº›æ­¥éª¤è¢«è®¤ä¸ºä¸å¿…è¦æˆ–å·²å®Œæˆï¼‰
    SkipSteps {
        step_ids: Vec<String>,
        reason: String
    },

    /// æ·»åŠ è¡¥æ•‘æ­¥éª¤ï¼ˆåœ¨ç°æœ‰è®¡åˆ’åŸºç¡€ä¸Šæ·»åŠ ä¿®å¤æ­¥éª¤ï¼‰
    AddRemediationSteps {
        suggestions: Vec<String>
    },

    /// è°ƒæ•´æ­¥éª¤é—´ä¾èµ–å…³ç³»
    AdjustDependencies {
        adjustments: Vec<String>
    },
}
```

### ç­–ç•¥è¯´æ˜

| ç­–ç•¥ | é€‚ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|------|---------|------|
| `FullReplan` | æ•´ä½“æ–¹æ¡ˆæœ‰æ ¹æœ¬æ€§é—®é¢˜ï¼Œéœ€è¦å®Œå…¨é‡æ–°è®¾è®¡ | å·¥å…·é€‰æ‹©å®Œå…¨é”™è¯¯ï¼Œä»»åŠ¡ç†è§£æœ‰åå·® |
| `ReplanFromStep` | å‰é¢çš„æ­¥éª¤æˆåŠŸï¼Œåªéœ€è¦ä»å¤±è´¥ç‚¹å¼€å§‹é‡æ–°è§„åˆ’ | æ­¥éª¤3å¤±è´¥ï¼Œæ­¥éª¤1-2çš„ç»“æœå¯ä»¥å¤ç”¨ |
| `SkipSteps` | æŸäº›æ­¥éª¤è¢«è¯æ˜æ˜¯ä¸å¿…è¦çš„æˆ–å·²ç»é€šè¿‡å…¶ä»–æ–¹å¼å®Œæˆ | éªŒè¯æ­¥éª¤å‘ç°ç›®æ ‡å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºæ­¥éª¤ |
| `AddRemediationSteps` | éœ€è¦æ·»åŠ é¢å¤–æ­¥éª¤æ¥ä¿®å¤å½“å‰é—®é¢˜ | éœ€è¦å…ˆæ¸…ç†æ—§æ•°æ®æ‰èƒ½ç»§ç»­ |
| `AdjustDependencies` | æ­¥éª¤æœ¬èº«æ²¡é—®é¢˜ï¼Œä½†ä¾èµ–å…³ç³»éœ€è¦è°ƒæ•´ | æ­¥éª¤Aå’ŒBåº”è¯¥å¹¶è¡Œè€Œä¸æ˜¯ä¸²è¡Œ |

### æ•´ä½“åæ€æç¤ºè¯ä¸­çš„ç­–ç•¥æŒ‡å¯¼

**æ–‡ä»¶**: [src/llm/reflection_prompts.rs](../../../src/llm/reflection_prompts.rs)

æ•´ä½“åæ€æç¤ºè¯ä¸­å¢åŠ äº†é‡æ–°è§„åˆ’ç­–ç•¥æŒ‡å¯¼éƒ¨åˆ†ï¼š

```
ã€é‡æ–°è§„åˆ’ç­–ç•¥å»ºè®®ã€‘
å½“å†³å®š should_replan = true æ—¶ï¼Œè¯·æä¾›å…·ä½“çš„é‡æ–°è§„åˆ’ç­–ç•¥å»ºè®®ï¼š

1. full_replan - å®Œæ•´é‡æ–°è§„åˆ’
   é€‚ç”¨ï¼šæ•´ä½“æ–¹æ¡ˆæœ‰æ ¹æœ¬æ€§é—®é¢˜

2. replan_from_step - ä»æŒ‡å®šæ­¥éª¤å¼€å§‹é‡æ–°è§„åˆ’
   é€‚ç”¨ï¼šå‰é¢æ­¥éª¤æˆåŠŸï¼Œåªéœ€è¦é‡æ–°è§„åˆ’åç»­æ­¥éª¤
   æ ¼å¼ï¼š{ "strategy_type": "replan_from_step", "step_id": "step_X", "reason": "åŸå› " }

3. skip_steps - è·³è¿‡æŒ‡å®šæ­¥éª¤
   é€‚ç”¨ï¼šæŸäº›æ­¥éª¤è¢«è¯æ˜ä¸å¿…è¦
   æ ¼å¼ï¼š{ "strategy_type": "skip_steps", "step_ids": ["step_X", "step_Y"], "reason": "åŸå› " }

4. add_remediation - æ·»åŠ è¡¥æ•‘æ­¥éª¤
   é€‚ç”¨ï¼šéœ€è¦é¢å¤–æ­¥éª¤ä¿®å¤é—®é¢˜
   æ ¼å¼ï¼š{ "strategy_type": "add_remediation", "suggestions": ["å»ºè®®1", "å»ºè®®2"] }

5. adjust_dependencies - è°ƒæ•´ä¾èµ–å…³ç³»
   é€‚ç”¨ï¼šæ­¥éª¤é—´ä¾èµ–å…³ç³»éœ€è¦è°ƒæ•´
   æ ¼å¼ï¼š{ "strategy_type": "adjust_dependencies", "adjustments": ["è°ƒæ•´1", "è°ƒæ•´2"] }
```

### ç­–ç•¥è§£æé€»è¾‘

**æ–‡ä»¶**: [src/core/reflector.rs:648-836](../../../src/core/reflector.rs#L648-L836)

```rust
/// ä»æ•´ä½“åæ€å“åº”ä¸­è§£æé‡æ–°è§„åˆ’ç­–ç•¥
fn parse_replanning_strategy(response: &str) -> Option<ReplanningStrategy> {
    // 1. å°è¯•ä» JSON ä¸­è§£æ
    if let Some(json_start) = response.find("\"replanning_strategy\"") {
        // è§£æå„ç§ç­–ç•¥ç±»å‹...
    }

    // 2. ä»è‡ªç„¶è¯­è¨€ä¸­æ¨æ–­ç­–ç•¥
    if response_lower.contains("å®Œå…¨é‡æ–°è§„åˆ’") {
        return Some(ReplanningStrategy::FullReplan);
    }

    if response_lower.contains("ä»æ­¥éª¤") && response_lower.contains("å¼€å§‹é‡æ–°è§„åˆ’") {
        // æå–æ­¥éª¤ ID...
    }

    // ... å…¶ä»–ç­–ç•¥æ¨æ–­ ...

    // 3. é»˜è®¤è¿”å› None
    None
}
```

---

## æ•´ä½“åæ€æŒ‡å¯¼ä¿¡æ¯ä¼ é€’

### OverallReflectionGuidance ç»“æ„

**æ–‡ä»¶**: [src/llm/replanning_prompts.rs:45-57](../../../src/llm/replanning_prompts.rs#L45-L57)

```rust
/// æ•´ä½“åæ€æŒ‡å¯¼ä¿¡æ¯ï¼ˆä¼ é€’ç»™é‡æ–°è§„åˆ’é˜¶æ®µï¼‰
#[derive(Debug, Clone, Default)]
pub struct OverallReflectionGuidance {
    /// æ ¹æœ¬åŸå› åˆ†æ
    pub root_causes: Vec<String>,
    /// é”™è¯¯å‡è®¾
    pub incorrect_assumptions: Vec<String>,
    /// æ›¿ä»£æ–¹æ³•å»ºè®®
    pub alternative_approaches: Vec<String>,
    /// ç»éªŒæ•™è®­
    pub lessons_learned: Vec<String>,
    /// é‡æ–°è§„åˆ’ç­–ç•¥å»ºè®®
    pub replanning_strategy: Option<ReplanningStrategy>,
}
```

### ä¿¡æ¯ä¼ é€’æµç¨‹

```
æ•´ä½“åæ€å®Œæˆ
    â†“
åˆ›å»º OverallReflectionGuidance
    â†“
è®¾ç½®åˆ° ReplanningContext.overall_reflection_guidance
    â†“
é‡æ–°è§„åˆ’æ—¶è°ƒç”¨ format_overall_reflection_guidance()
    â†“
æ ¼å¼åŒ–ä¸ºæ–‡æœ¬æ’å…¥åˆ°é‡æ–°è§„åˆ’æç¤ºè¯ä¸­
```

### ReplanningContext ä¸­çš„ä½¿ç”¨

**æ–‡ä»¶**: [src/llm/replanning_prompts.rs:75-90](../../../src/llm/replanning_prompts.rs#L75-L90)

```rust
impl ReplanningContext {
    /// è®¾ç½®æ•´ä½“åæ€æŒ‡å¯¼ä¿¡æ¯
    pub fn set_overall_reflection_guidance(&mut self, guidance: OverallReflectionGuidance) {
        self.overall_reflection_guidance = Some(guidance);
    }

    /// æ ¼å¼åŒ–æ•´ä½“åæ€æŒ‡å¯¼ä¿¡æ¯ä¸ºæ–‡æœ¬
    pub fn format_overall_reflection_guidance(&self) -> String {
        match &self.overall_reflection_guidance {
            Some(guidance) => {
                let mut result = String::new();

                // æ ¼å¼åŒ–æ ¹æœ¬åŸå› ã€é”™è¯¯å‡è®¾ã€æ›¿ä»£æ–¹æ³•ã€ç»éªŒæ•™è®­
                // ...

                // æ ¼å¼åŒ–é‡æ–°è§„åˆ’ç­–ç•¥å»ºè®®
                if let Some(strategy) = &guidance.replanning_strategy {
                    result.push_str("ã€é‡æ–°è§„åˆ’ç­–ç•¥å»ºè®®ã€‘\n");
                    match strategy {
                        ReplanningStrategy::FullReplan => {
                            result.push_str("ç­–ç•¥: å®Œæ•´é‡æ–°è§„åˆ’æ•´ä¸ªä»»åŠ¡\n");
                        }
                        ReplanningStrategy::ReplanFromStep { step_id, reason } => {
                            result.push_str(&format!(
                                "ç­–ç•¥: ä»æ­¥éª¤ {} å¼€å§‹é‡æ–°è§„åˆ’\nåŸå› : {}\n",
                                step_id, reason
                            ));
                        }
                        // ... å…¶ä»–ç­–ç•¥ ...
                    }
                }

                result
            }
            None => String::new(),
        }
    }
}
```

### ç¼–æ’å™¨ä¸­çš„ä¼ é€’

**æ–‡ä»¶**: [src/core/orchestrator.rs:2630-2638](../../../src/core/orchestrator.rs#L2630-L2638)

```rust
// ä¿å­˜æ•´ä½“åæ€çš„æŒ‡å¯¼ä¿¡æ¯ï¼Œç”¨äºä¼ é€’ç»™é‡æ–°è§„åˆ’
overall_reflection_guidance = Some(OverallReflectionGuidance {
    root_causes: overall_reflection.root_causes.clone(),
    incorrect_assumptions: overall_reflection.incorrect_assumptions.clone(),
    alternative_approaches: overall_reflection.alternative_approaches.clone(),
    lessons_learned: overall_reflection.lessons_learned.clone(),
    // ä»æ•´ä½“åæ€ç»“æœä¸­è·å–é‡æ–°è§„åˆ’ç­–ç•¥å»ºè®®
    replanning_strategy: overall_reflection.replanning_strategy.clone(),
});
```

**æ–‡ä»¶**: [src/core/orchestrator.rs:2947-2958](../../../src/core/orchestrator.rs#L2947-L2958)

```rust
// æ„å»ºé‡æ–°è§„åˆ’ä¸Šä¸‹æ–‡æ—¶ï¼Œä¼ å…¥æ•´ä½“åæ€çš„æŒ‡å¯¼ä¿¡æ¯
if let Some(guidance) = overall_reflection_guidance.take() {
    replanning_context.set_overall_reflection_guidance(guidance);
}
```

---

## ä»£ç å®ç°æ˜ å°„

### æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶ | åŠŸèƒ½ | å…³é”®æ–¹æ³•/ç»“æ„ |
|------|------|-------------|
| `src/core/reflector.rs` | åæ€æ‰§è¡Œå™¨ | `StepAction`, `ReflectionResult`, `parse_replanning_strategy()` |
| `src/core/orchestrator.rs` | ä»»åŠ¡ç¼–æ’å™¨ | `TriggerOverallReflection` å¤„ç†, `overall_reflection_guidance` ä¼ é€’ |
| `src/llm/reflection_prompts.rs` | åæ€æç¤ºè¯ | å•æ­¥åæ€å†³ç­–é€‰é¡¹, æ•´ä½“åæ€ç­–ç•¥æŒ‡å¯¼ |
| `src/llm/replanning_prompts.rs` | é‡æ–°è§„åˆ’æç¤ºè¯ | `ReplanningStrategy`, `OverallReflectionGuidance`, `format_overall_reflection_guidance()` |
| `src/grpc/server.rs` | gRPC æœåŠ¡ | `TriggerOverallReflection` äº‹ä»¶å¤„ç† |

### è°ƒç”¨é“¾è·¯

#### å•æ­¥åæ€è§¦å‘æ•´ä½“åæ€

```
æ­¥éª¤æ‰§è¡Œå¤±è´¥
    â†“
Reflector::reflect_on_step_with_events()
    [src/core/reflector.rs:846-909]
    â†“
parse_step_reflection_response() â†’ StepAction::TriggerOverallReflection
    [src/core/reflector.rs:912-1019]
    â†“
Orchestrator å¤„ç† TriggerOverallReflection
    [src/core/orchestrator.rs:2580-2673]
    â†“
è°ƒç”¨æ•´ä½“åæ€ Reflector::reflect_with_context()
    [src/core/reflector.rs:440-511]
    â†“
æ ¹æ® should_replan å†³å®šåç»­è¡ŒåŠ¨
```

#### æ•´ä½“åæ€æŒ‡å¯¼ä¿¡æ¯ä¼ é€’åˆ°é‡æ–°è§„åˆ’

```
æ•´ä½“åæ€å®Œæˆ
    â†“
ä¿å­˜ OverallReflectionGuidance
    [src/core/orchestrator.rs:2630-2638]
    â†“
åˆ›å»º ReplanningContext
    [src/core/orchestrator.rs:2920-2944]
    â†“
è®¾ç½® overall_reflection_guidance
    [src/core/orchestrator.rs:2947-2953]
    â†“
ReplanningPromptBuilder::build_replanning_prompt()
    [src/llm/replanning_prompts.rs:450-531]
    â†“
format_overall_reflection_guidance() æ ¼å¼åŒ–ä¸ºæ–‡æœ¬
    [src/llm/replanning_prompts.rs:91-160]
    â†“
æ’å…¥åˆ°é‡æ–°è§„åˆ’æç¤ºè¯çš„ {overall_reflection_guidance} å ä½ç¬¦
```

### æ•°æ®æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ•°æ®æµå‘                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ StepReflectionâ”‚ â”€â”€â†’ â”‚ TriggerOverall-  â”‚ â”€â”€â†’ â”‚ ReflectionResult â”‚      â”‚
â”‚  â”‚              â”‚      â”‚ Reflection(æ‘˜è¦) â”‚      â”‚ + replanning_    â”‚      â”‚
â”‚  â”‚ suggested_   â”‚      â”‚                  â”‚      â”‚   strategy       â”‚      â”‚
â”‚  â”‚ action       â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚                â”‚
â”‚                                                           â†“                â”‚
â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                                              â”‚ OverallReflection-   â”‚      â”‚
â”‚                                              â”‚ Guidance             â”‚      â”‚
â”‚                                              â”‚ - root_causes        â”‚      â”‚
â”‚                                              â”‚ - alternative_       â”‚      â”‚
â”‚                                              â”‚   approaches         â”‚      â”‚
â”‚                                              â”‚ - replanning_        â”‚      â”‚
â”‚                                              â”‚   strategy           â”‚      â”‚
â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                         â”‚                  â”‚
â”‚                                                         â†“                  â”‚
â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                                              â”‚ ReplanningContext    â”‚      â”‚
â”‚                                              â”‚ .overall_reflection_ â”‚      â”‚
â”‚                                              â”‚  guidance            â”‚      â”‚
â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                         â”‚                  â”‚
â”‚                                                         â†“                  â”‚
â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                                              â”‚ format_overall_      â”‚      â”‚
â”‚                                              â”‚ reflection_guidance()â”‚      â”‚
â”‚                                              â”‚ â†’ æ–‡æœ¬æ ¼å¼           â”‚      â”‚
â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                         â”‚                  â”‚
â”‚                                                         â†“                  â”‚
â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                                              â”‚ é‡æ–°è§„åˆ’æç¤ºè¯       â”‚      â”‚
â”‚                                              â”‚ {overall_reflection_ â”‚      â”‚
â”‚                                              â”‚  guidance}           â”‚      â”‚
â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°æ®ç»“æ„å®šä¹‰

### ReflectionResult

**æ–‡ä»¶**: [src/core/reflector.rs:32-50](../../../src/core/reflector.rs#L32-L50)

```rust
/// åæ€ç»“æœ
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ReflectionResult {
    /// åæ€ ID
    pub reflection_id: String,
    /// æ ¹æœ¬åŸå› åˆ†æ
    pub root_causes: Vec<String>,
    /// é”™è¯¯å‡è®¾
    pub incorrect_assumptions: Vec<String>,
    /// æ›¿ä»£æ–¹æ³•
    pub alternative_approaches: Vec<String>,
    /// ä¼˜åŒ–å»ºè®®
    pub optimization_suggestions: Vec<OptimizationSuggestion>,
    /// ç»éªŒæ•™è®­
    pub lessons_learned: Vec<String>,
    /// æ˜¯å¦éœ€è¦é‡æ–°è§„åˆ’
    pub should_replan: bool,
    /// é‡æ–°è§„åˆ’ç­–ç•¥å»ºè®®ï¼ˆå½“ should_replan = true æ—¶ï¼‰
    pub replanning_strategy: Option<ReplanningStrategy>,  // æ–°å¢å­—æ®µ
}
```

### StepReflection

**æ–‡ä»¶**: [src/core/reflector.rs:83-104](../../../src/core/reflector.rs#L83-L104)

```rust
/// å•æ­¥åæ€ç»“æœ
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct StepReflection {
    /// åæ€ ID
    pub reflection_id: String,
    /// æ­¥éª¤ ID
    pub step_id: String,
    /// æ ¹æœ¬åŸå› 
    pub root_cause: String,
    /// æ ¹æœ¬åŸå› åˆ†ç±»
    pub root_cause_category: String,
    /// å»ºè®®çš„æ‰§è¡Œè¡ŒåŠ¨
    pub suggested_action: StepAction,  // å¯èƒ½ä¸º TriggerOverallReflection
    /// å¯ä¿¡åº¦è¯„åˆ†
    pub confidence: f32,
    /// è¯¦ç»†åˆ†æ
    pub analysis: String,
    /// å¤‡é€‰æ–¹æ¡ˆåˆ—è¡¨
    pub alternative_solutions: Vec<String>,
    /// æ˜¯å¦å¯æ¢å¤
    pub is_recoverable: bool,
}
```

---

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: å•æ­¥åæ€è§¦å‘æ•´ä½“åæ€

**åœºæ™¯**: æ­¥éª¤æ‰§è¡Œå¤±è´¥å¤šæ¬¡ï¼Œå•æ­¥åæ€å†³å®šè§¦å‘æ•´ä½“åæ€

```yaml
è¾“å…¥:
  æ­¥éª¤ID: step_3
  å·¥å…·ID: create_client_tool
  é”™è¯¯ä¿¡æ¯: "Connection timeout after 3 retries"
  é‡è¯•æ¬¡æ•°: 3

å•æ­¥åæ€è¾“å‡º:
  {
    "root_cause_category": "external_error",
    "root_cause": "ç½‘ç»œè¿æ¥è¶…æ—¶ï¼Œå·²é‡è¯•3æ¬¡å‡å¤±è´¥",
    "is_recoverable": false,
    "confidence": 85,
    "analysis": "è¿ç»­3æ¬¡é‡è¯•å‡è¶…æ—¶ï¼Œé—®é¢˜å¯èƒ½ä¸åœ¨å‚æ•°æˆ–å·¥å…·é€‰æ‹©ï¼Œéœ€è¦æ•´ä½“è¯„ä¼°",
    "suggested_action": {
      "type": "trigger_overall_reflection",
      "data": "æ­¥éª¤3è¿ç»­3æ¬¡æ‰§è¡Œè¶…æ—¶ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æœåŠ¡ç«¯é—®é¢˜ï¼Œå»ºè®®è¿›è¡Œæ•´ä½“åæ€è¯„ä¼°"
    }
  }

æ•´ä½“åæ€è¾“å‡º:
  {
    "should_replan": true,
    "root_causes": ["ç½‘ç»œè¿æ¥ä¸ç¨³å®š", "ç›®æ ‡æœåŠ¡å“åº”ç¼“æ…¢"],
    "alternative_approaches": ["ä½¿ç”¨å¼‚æ­¥è°ƒç”¨æ–¹å¼", "å¢åŠ é‡è¯•é—´éš”"],
    "replanning_strategy": {
      "strategy_type": "add_remediation",
      "suggestions": ["æ·»åŠ ç½‘ç»œå¥åº·æ£€æŸ¥æ­¥éª¤", "è°ƒæ•´è¶…æ—¶é…ç½®"]
    }
  }
```

### ç¤ºä¾‹ 2: ç»†ç²’åº¦é‡è§„åˆ’ç­–ç•¥ - ä»æŒ‡å®šæ­¥éª¤å¼€å§‹

**åœºæ™¯**: å‰ä¸¤ä¸ªæ­¥éª¤æˆåŠŸï¼Œç¬¬ä¸‰ä¸ªæ­¥éª¤å¤±è´¥ï¼Œæ•´ä½“åæ€å»ºè®®ä»ç¬¬ä¸‰æ­¥å¼€å§‹é‡æ–°è§„åˆ’

```yaml
æ‰§è¡Œå†å²:
  - step_1: è·å–é…ç½® âœ…
  - step_2: éªŒè¯æƒé™ âœ…
  - step_3: åˆ›å»ºèµ„æº âŒ (å‚æ•°æ ¼å¼é”™è¯¯)

æ•´ä½“åæ€è¾“å‡º:
  {
    "should_replan": true,
    "root_causes": ["æ­¥éª¤3çš„å‚æ•°æ ¼å¼ä¸ç¬¦åˆæ–°ç‰ˆAPIè¦æ±‚"],
    "alternative_approaches": ["æ›´æ–°å‚æ•°æ ¼å¼ä»¥ç¬¦åˆæ–°ç‰ˆAPIè§„èŒƒ"],
    "replanning_strategy": {
      "strategy_type": "replan_from_step",
      "step_id": "step_3",
      "reason": "å‰ä¸¤ä¸ªæ­¥éª¤å·²æˆåŠŸå®Œæˆï¼Œåªéœ€è¦ä»æ­¥éª¤3å¼€å§‹é‡æ–°è§„åˆ’"
    }
  }

ä¼ é€’ç»™é‡æ–°è§„åˆ’çš„æŒ‡å¯¼ä¿¡æ¯:
  ã€æ ¹æœ¬åŸå› åˆ†æã€‘
  1. æ­¥éª¤3çš„å‚æ•°æ ¼å¼ä¸ç¬¦åˆæ–°ç‰ˆAPIè¦æ±‚

  ã€æ”¹è¿›å»ºè®® - è¯·åœ¨é‡æ–°è§„åˆ’æ—¶é‡‡çº³ã€‘
  1. æ›´æ–°å‚æ•°æ ¼å¼ä»¥ç¬¦åˆæ–°ç‰ˆAPIè§„èŒƒ

  ã€é‡æ–°è§„åˆ’ç­–ç•¥å»ºè®®ã€‘
  ç­–ç•¥: ä»æ­¥éª¤ step_3 å¼€å§‹é‡æ–°è§„åˆ’
  åŸå› : å‰ä¸¤ä¸ªæ­¥éª¤å·²æˆåŠŸå®Œæˆï¼Œåªéœ€è¦ä»æ­¥éª¤3å¼€å§‹é‡æ–°è§„åˆ’
```

### ç¤ºä¾‹ 3: ç»†ç²’åº¦é‡è§„åˆ’ç­–ç•¥ - è·³è¿‡æ­¥éª¤

**åœºæ™¯**: å‘ç°æŸäº›æ­¥éª¤æ˜¯ä¸å¿…è¦çš„

```yaml
æ‰§è¡Œå†å²:
  - step_1: æ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨ âœ… (ç»“æœ: èµ„æºå·²å­˜åœ¨)
  - step_2: åˆ›å»ºèµ„æº âŒ (é”™è¯¯: èµ„æºå·²å­˜åœ¨)

æ•´ä½“åæ€è¾“å‡º:
  {
    "should_replan": true,
    "root_causes": ["æ­¥éª¤1å·²ç¡®è®¤èµ„æºå­˜åœ¨ï¼Œæ­¥éª¤2çš„åˆ›å»ºæ“ä½œæ˜¯å¤šä½™çš„"],
    "replanning_strategy": {
      "strategy_type": "skip_steps",
      "step_ids": ["step_2"],
      "reason": "èµ„æºå·²å­˜åœ¨ï¼Œæ— éœ€åˆ›å»ºï¼Œç›´æ¥è¿›å…¥åç»­é…ç½®æ­¥éª¤"
    }
  }
```

---

## ç›¸å…³æ–‡æ¡£

- [19-åæ€æœºåˆ¶è®¾è®¡ä¸å®ç°æ–‡æ¡£.md](./19-åæ€æœºåˆ¶è®¾è®¡ä¸å®ç°æ–‡æ¡£.md) - åæ€æœºåˆ¶æ•´ä½“è®¾è®¡
- [17-ç§»é™¤è½®æ•°é™åˆ¶-ç”±å¤§æ¨¡å‹å†³å®šåæ€ä¸é‡è§„åˆ’.md](./17-ç§»é™¤è½®æ•°é™åˆ¶-ç”±å¤§æ¨¡å‹å†³å®šåæ€ä¸é‡è§„åˆ’.md) - æ™ºèƒ½å†³ç­–æœºåˆ¶
- [18-åæ€ä¸è§„åˆ’å®ç°é€»è¾‘ä¸ä»£ç æ˜ å°„è¯¦è§£.md](./18-åæ€ä¸è§„åˆ’å®ç°é€»è¾‘ä¸ä»£ç æ˜ å°„è¯¦è§£.md) - ä»£ç æ˜ å°„è¯¦è§£

---

## æ›´æ–°å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | æ›´æ–°å†…å®¹ |
|------|------|---------|
| 2026-01-14 | v1.0 | åˆå§‹ç‰ˆæœ¬ï¼šå•æ­¥åæ€è§¦å‘æ•´ä½“åæ€ã€ç»†ç²’åº¦é‡è§„åˆ’ç­–ç•¥ |

---

**æ–‡æ¡£ç»´æŠ¤**: å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚
