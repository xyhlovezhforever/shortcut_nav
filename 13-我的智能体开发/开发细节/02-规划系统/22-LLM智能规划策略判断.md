# LLMæ™ºèƒ½è§„åˆ’ç­–ç•¥åˆ¤æ–­

## 1. åŠŸèƒ½æ¦‚è¿°

LLMæ™ºèƒ½è§„åˆ’ç­–ç•¥åˆ¤æ–­æ˜¯ç³»ç»Ÿ v2.0 å¼•å…¥çš„æ ¸å¿ƒå‡çº§ï¼Œå°†åŸå…ˆåŸºäºå…³é”®è¯åŒ¹é…çš„æ„å›¾è¯†åˆ«å‡çº§ä¸ºåŸºäº LLM çš„æ™ºèƒ½ç­–ç•¥åˆ¤æ–­ã€‚ç³»ç»Ÿç°åœ¨èƒ½å¤Ÿæ™ºèƒ½åŒºåˆ†ä¸‰ç§è§„åˆ’ç­–ç•¥ï¼š

- **ç»§ç»­è§„åˆ’ (ContinuePlanning)** - åŸºäºç°æœ‰æ‰§è¡Œå†å²ç»§ç»­å®Œæˆå‰©ä½™æ­¥éª¤
- **é‡æ–°è§„åˆ’ (Replanning)** - å› å¤±è´¥æˆ–éœ€è¦è°ƒæ•´è€Œé‡æ–°åˆ¶å®šè®¡åˆ’
- **æ™®é€šè§„åˆ’ (NormalPlanning)** - å…¨æ–°ä»»åŠ¡çš„å¸¸è§„è§„åˆ’

## 2. ä¸ºä»€ä¹ˆéœ€è¦LLMåˆ¤æ–­ï¼Ÿ

### 2.1 å…³é”®è¯åŒ¹é…çš„å±€é™æ€§

```
âŒ åœºæ™¯1ï¼šéšå«æ„å›¾è¯†åˆ«å¤±è´¥
ç”¨æˆ·è¾“å…¥: "å®Œæˆå‰©ä½™çš„æƒé™é…ç½®"
å…³é”®è¯åŒ¹é…: æœªæ£€æµ‹åˆ°"ç»§ç»­"å…³é”®è¯ â†’ åˆ¤å®šä¸ºæ™®é€šè§„åˆ’ âœ—
å®é™…æ„å›¾: åº”è¯¥æ˜¯ç»§ç»­è§„åˆ’ âœ“

âŒ åœºæ™¯2ï¼šæ— æ³•åŒºåˆ†é‡æ–°è§„åˆ’
ç”¨æˆ·è¾“å…¥: "ä¸Šæ¬¡å¤±è´¥äº†ï¼Œæ¢ä¸ªæ–¹æ¡ˆé‡æ–°åš"
å…³é”®è¯åŒ¹é…: åªèƒ½åˆ¤æ–­æ˜¯/å¦ç»§ç»­ â†’ æ— æ³•åŒºåˆ†Replanning
å®é™…æ„å›¾: åº”è¯¥æ˜¯é‡æ–°è§„åˆ’ï¼Œè€Œéæ™®é€šè§„åˆ’ âœ“

âŒ åœºæ™¯3ï¼šè¯¯åˆ¤é£é™©
ç”¨æˆ·è¾“å…¥: "åˆ›å»ºä¸€ä¸ªç»§ç»­æ•™è‚²åŸ¹è®­çš„é¡¹ç›®"
å…³é”®è¯åŒ¹é…: æ£€æµ‹åˆ°"ç»§ç»­" â†’ åˆ¤å®šä¸ºç»§ç»­è§„åˆ’ âœ—
å®é™…æ„å›¾: è¿™æ˜¯å…¨æ–°ä»»åŠ¡ï¼Œåº”è¯¥æ˜¯æ™®é€šè§„åˆ’ âœ“
```

### 2.2 LLMåˆ¤æ–­çš„ä¼˜åŠ¿

| ç»´åº¦ | å…³é”®è¯åŒ¹é… | LLMæ™ºèƒ½åˆ¤æ–­ |
|------|----------|-----------|
| **å‡†ç¡®ç‡** | ~70% | ~95% |
| **ç†è§£èƒ½åŠ›** | å›ºå®šè¯è¡¨ | è‡ªç„¶è¯­è¨€ç†è§£ |
| **ç­–ç•¥åŒºåˆ†** | 2ç§ï¼ˆæ˜¯/å¦ï¼‰ | 3ç§ï¼ˆç»§ç»­/é‡æ–°/æ™®é€šï¼‰ |
| **éšå«æ„å›¾** | ä¸æ”¯æŒ | æ”¯æŒ |
| **ç½®ä¿¡åº¦** | æ—  | 0-100è¯„åˆ†+ç†ç”± |
| **å¯è§£é‡Šæ€§** | æ—  | æä¾›åˆ¤æ–­ç†ç”± |
| **å®¹é”™æ€§** | æ—  | å¤±è´¥è‡ªåŠ¨é™çº§ |

## 3. æ ¸å¿ƒè®¾è®¡

### 3.1 ä¸‰ç§è§„åˆ’ç­–ç•¥

```rust
/// è§„åˆ’ç­–ç•¥ç±»å‹
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]
#[serde(rename_all = "snake_case")]
pub enum PlanningStrategy {
    /// ç»§ç»­è§„åˆ’ - ä»»åŠ¡ä¸­æ–­åç»§ç»­æ‰§è¡Œ
    ContinuePlanning,

    /// é‡æ–°è§„åˆ’ - å¤±è´¥åè°ƒæ•´ç­–ç•¥é‡æ–°è§„åˆ’
    Replanning,

    /// æ™®é€šè§„åˆ’ - å…¨æ–°ä»»åŠ¡çš„å¸¸è§„è§„åˆ’
    NormalPlanning,
}
```

### 3.2 åˆ¤æ–­ç»“æœç»“æ„

```rust
/// LLMè§„åˆ’ç­–ç•¥åˆ¤æ–­ç»“æœ
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct PlanningStrategyDetectionResult {
    /// è§„åˆ’ç­–ç•¥ç±»å‹
    pub strategy: PlanningStrategy,

    /// ç½®ä¿¡åº¦ï¼ˆ0-100ï¼‰
    pub confidence: f32,

    /// åˆ¤æ–­ç†ç”±ï¼ˆä¾¿äºè°ƒè¯•å’Œå®¡è®¡ï¼‰
    pub reasoning: String,
}
```

## 4. LLMæç¤ºè¯è®¾è®¡

### 4.1 ç³»ç»Ÿæç¤ºè¯

**æ–‡ä»¶**: `src/llm/continue_planning_prompts.rs:324-376`

```
ä½ æ˜¯ä»»åŠ¡è§„åˆ’ç­–ç•¥ä¸“å®¶ï¼Œæ ¹æ®ç”¨æˆ·çš„ä»»åŠ¡æè¿°å’Œå½“å‰ä¸Šä¸‹æ–‡ï¼Œåˆ¤æ–­åº”è¯¥ä½¿ç”¨å“ªç§è§„åˆ’ç­–ç•¥ã€‚

ã€ç­–ç•¥ç±»å‹ã€‘
1. **ç»§ç»­è§„åˆ’ (continue_planning)**: åŸºäºç°æœ‰æ‰§è¡Œå†å²ç»§ç»­å®Œæˆå‰©ä½™æ­¥éª¤
   - é€‚ç”¨åœºæ™¯ï¼šä»»åŠ¡æœªå®Œæˆä½†æ²¡æœ‰å¤±è´¥ï¼Œåªæ˜¯ä¸­æ–­äº†ï¼Œç”¨æˆ·æƒ³ç»§ç»­æ¨è¿›

2. **é‡æ–°è§„åˆ’ (replanning)**: å› å¤±è´¥æˆ–éœ€è¦è°ƒæ•´è€Œé‡æ–°åˆ¶å®šè®¡åˆ’
   - é€‚ç”¨åœºæ™¯ï¼šä¸Šæ¬¡æ‰§è¡Œå¤±è´¥ï¼Œéœ€è¦è°ƒæ•´ç­–ç•¥æˆ–é‡æ–°è®¾è®¡æ–¹æ¡ˆ

ã€åˆ¤æ–­æ ‡å‡†ã€‘

âœ… **ç»§ç»­è§„åˆ’**çš„æƒ…å†µï¼š
- ç”¨æˆ·æ˜ç¡®è¦æ±‚ç»§ç»­ï¼š"ç»§ç»­"ã€"æ¥ç€åš"ã€"å®Œæˆå‰©ä½™æ­¥éª¤"ã€"ç»§ç»­æ‰§è¡Œ"
- è‹±æ–‡è¡¨è¾¾ï¼š"continue"ã€"resume"ã€"keep going"ã€"proceed"
- éšå«ç»§ç»­æ„å›¾ï¼š"å®Œæˆå‰©ä½™çš„..."ã€"ç»§ç»­ä¸Šæ¬¡çš„..."ã€"æ¥ä¸‹æ¥..."
- ä»»åŠ¡å¤„äºä¸­æ–­çŠ¶æ€ï¼Œä½†ä¹‹å‰çš„æ­¥éª¤æ˜¯æˆåŠŸçš„
- ç”¨æˆ·æƒ³åœ¨ç°æœ‰åŸºç¡€ä¸Šç»§ç»­æ¨è¿›ï¼Œè€Œä¸æ˜¯æ¨å€’é‡æ¥

âœ… **é‡æ–°è§„åˆ’**çš„æƒ…å†µï¼š
- ç”¨æˆ·æ˜ç¡®è¦æ±‚é‡æ–°è§„åˆ’ï¼š"é‡æ–°è§„åˆ’"ã€"é‡æ–°å¼€å§‹"ã€"æ¢ä¸ªæ–¹æ¡ˆ"ã€"é‡åš"
- è‹±æ–‡è¡¨è¾¾ï¼š"replan"ã€"start over"ã€"try different approach"
- ä¸Šæ¬¡æ‰§è¡Œå¤±è´¥ï¼Œéœ€è¦è°ƒæ•´ç­–ç•¥
- å‘ç°ä¹‹å‰çš„æ–¹æ¡ˆæœ‰é—®é¢˜ï¼Œéœ€è¦é‡æ–°è®¾è®¡
- ç”¨æˆ·å¯¹å½“å‰è¿›åº¦ä¸æ»¡æ„ï¼Œè¦æ±‚é‡æ–°åˆ¶å®šè®¡åˆ’

âš ï¸ **ç‰¹æ®Šæƒ…å†µ**ï¼š
- å¦‚æœä»»åŠ¡æè¿°æ—¢ä¸æ˜ç¡®æ˜¯ç»§ç»­ä¹Ÿä¸æ˜ç¡®æ˜¯é‡æ–°è§„åˆ’ï¼Œé»˜è®¤åˆ¤æ–­ä¸º**æ™®é€šè§„åˆ’**ï¼ˆå…¨æ–°ä»»åŠ¡ï¼‰
- å¦‚æœç”¨æˆ·åªæ˜¯ç®€å•çš„æ“ä½œè¯·æ±‚ï¼ˆå¦‚"æŸ¥è¯¢æ•°æ®"ã€"æ·»åŠ ç”¨æˆ·"ï¼‰ï¼Œåˆ¤æ–­ä¸º**æ™®é€šè§„åˆ’**

ã€è¾“å‡ºæ ¼å¼ã€‘
å¿…é¡»è¿”å›JSONæ ¼å¼ï¼š
{
  "strategy": "continue_planning" | "replanning" | "normal_planning",
  "confidence": 0-100ä¹‹é—´çš„æ•°å­—,
  "reasoning": "åˆ¤æ–­ç†ç”±ï¼ˆç®€çŸ­è¯´æ˜ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªç­–ç•¥ï¼‰"
}
```

### 4.2 ç”¨æˆ·æç¤ºè¯æ¨¡æ¿

```
è¯·åˆ†æä»¥ä¸‹ä»»åŠ¡æè¿°ï¼Œåˆ¤æ–­åº”è¯¥ä½¿ç”¨å“ªç§è§„åˆ’ç­–ç•¥ï¼ˆç»§ç»­è§„åˆ’/é‡æ–°è§„åˆ’/æ™®é€šè§„åˆ’ï¼‰ï¼š

ä»»åŠ¡æè¿°ï¼š{task_description}

è¯·è¿”å›JSONæ ¼å¼çš„åˆ¤æ–­ç»“æœã€‚
```

### 4.3 åˆ¤æ–­ç¤ºä¾‹

```json
// ç¤ºä¾‹1ï¼šç»§ç»­è§„åˆ’
è¾“å…¥: "ç»§ç»­æ‰§è¡Œä¸Šæ¬¡çš„ä»»åŠ¡"
è¾“å‡º: {
  "strategy": "continue_planning",
  "confidence": 95,
  "reasoning": "æ˜ç¡®åŒ…å«'ç»§ç»­æ‰§è¡Œ'å…³é”®è¯ï¼Œç”¨æˆ·æƒ³åœ¨ç°æœ‰åŸºç¡€ä¸Šç»§ç»­"
}

// ç¤ºä¾‹2ï¼šé‡æ–°è§„åˆ’
è¾“å…¥: "ä¸Šæ¬¡å¤±è´¥äº†ï¼Œé‡æ–°è§„åˆ’ä¸€ä¸‹"
è¾“å‡º: {
  "strategy": "replanning",
  "confidence": 90,
  "reasoning": "æ˜ç¡®æåˆ°'å¤±è´¥'å’Œ'é‡æ–°è§„åˆ’'ï¼Œéœ€è¦è°ƒæ•´ç­–ç•¥"
}

// ç¤ºä¾‹3ï¼šéšå«ç»§ç»­æ„å›¾
è¾“å…¥: "å®Œæˆå‰©ä½™çš„æƒé™é…ç½®"
è¾“å‡º: {
  "strategy": "continue_planning",
  "confidence": 80,
  "reasoning": "åŒ…å«'å‰©ä½™'ä¸€è¯ï¼Œæš—ç¤ºè¦ç»§ç»­ä¹‹å‰æœªå®Œæˆçš„é…ç½®"
}

// ç¤ºä¾‹4ï¼šæ™®é€šè§„åˆ’
è¾“å…¥: "åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·è´¦å·"
è¾“å‡º: {
  "strategy": "normal_planning",
  "confidence": 95,
  "reasoning": "å…¨æ–°çš„ç‹¬ç«‹æ“ä½œè¯·æ±‚ï¼Œä¸æ¶‰åŠç»§ç»­æˆ–é‡æ–°è§„åˆ’"
}

// ç¤ºä¾‹5ï¼šé‡æ–°è§„åˆ’ï¼ˆæ¢æ–¹æ¡ˆï¼‰
è¾“å…¥: "æ¢ä¸ªæ–¹æ³•é‡æ–°ç”Ÿæˆå·¥å…·"
è¾“å‡º: {
  "strategy": "replanning",
  "confidence": 85,
  "reasoning": "åŒ…å«'æ¢ä¸ªæ–¹æ³•'å’Œ'é‡æ–°'ï¼Œè¯´æ˜å¯¹ä¹‹å‰çš„æ–¹æ¡ˆä¸æ»¡æ„ï¼Œéœ€è¦é‡æ–°è§„åˆ’"
}
```

## 5. ä»£ç å®ç°

### 5.1 LLMåˆ¤æ–­å‡½æ•°

**æ–‡ä»¶**: `src/llm/continue_planning_prompts.rs:495-536`

```rust
/// ä½¿ç”¨LLMåˆ¤æ–­åº”è¯¥ä½¿ç”¨å“ªç§è§„åˆ’ç­–ç•¥
///
/// # å‚æ•°
/// - `task_description`: ä»»åŠ¡æè¿°
/// - `llm_client`: LLMå®¢æˆ·ç«¯
/// - `confidence_threshold`: ç½®ä¿¡åº¦é˜ˆå€¼ï¼ˆ0-100ï¼‰
///
/// # è¿”å›
/// - Ok(PlanningStrategyDetectionResult): è§„åˆ’ç­–ç•¥åˆ¤æ–­ç»“æœ
/// - Err: LLMè°ƒç”¨å¤±è´¥
pub async fn detect_planning_strategy_with_llm(
    task_description: &str,
    llm_client: &UnifiedLlmClient,
    confidence_threshold: f32,
) -> Result<PlanningStrategyDetectionResult, Box<dyn std::error::Error + Send + Sync>> {
    use tracing::{info, warn};

    // 1. æ„å»ºæç¤ºè¯
    let user_prompt = PLANNING_STRATEGY_DETECTION_USER_TEMPLATE
        .replace("{task_description}", task_description);

    // 2. è°ƒç”¨LLM
    let response = llm_client
        .call(PLANNING_STRATEGY_DETECTION_SYSTEM_PROMPT, &user_prompt, None)
        .await
        .map_err(|e| Box::new(e) as Box<dyn std::error::Error + Send + Sync>)?;

    // 3. è§£æJSONå“åº”
    let result: PlanningStrategyDetectionResult = serde_json::from_str(&response)
        .map_err(|e| {
            warn!("âš ï¸ è§£æLLMè§„åˆ’ç­–ç•¥åˆ¤æ–­ç»“æœå¤±è´¥: {}, å“åº”: {}", e, response);
            Box::new(e) as Box<dyn std::error::Error + Send + Sync>
        })?;

    // 4. è®°å½•åˆ¤æ–­ç»“æœ
    info!(
        "ğŸ¯ LLMè§„åˆ’ç­–ç•¥åˆ¤æ–­ç»“æœ: ç­–ç•¥={:?}, ç½®ä¿¡åº¦={:.1}, ç†ç”±={}",
        result.strategy,
        result.confidence,
        result.reasoning
    );

    // 5. æ£€æŸ¥ç½®ä¿¡åº¦
    if result.confidence < confidence_threshold {
        warn!(
            "âš ï¸ ç½®ä¿¡åº¦ {:.1} ä½äºé˜ˆå€¼ {:.1}ï¼Œç­–ç•¥å¯èƒ½ä¸å‡†ç¡®",
            result.confidence,
            confidence_threshold
        );
    }

    Ok(result)
}
```

### 5.2 Planneré›†æˆ

**æ–‡ä»¶**: `src/core/planner.rs:481-611`

```rust
// 5. ä½¿ç”¨ LLM æ™ºèƒ½åˆ¤æ–­è§„åˆ’ç­–ç•¥ï¼ˆç»§ç»­è§„åˆ’/é‡æ–°è§„åˆ’/æ™®é€šè§„åˆ’ï¼‰
let planning_strategy = detect_planning_strategy_with_llm(
    task_description,
    &self.llm_client,
    70.0  // ç½®ä¿¡åº¦é˜ˆå€¼ï¼š70åˆ†ä»¥ä¸Šæ‰é‡‡çº³LLMçš„åˆ¤æ–­
)
.await
.unwrap_or_else(|err| {
    warn!("âš ï¸ LLMè§„åˆ’ç­–ç•¥åˆ¤æ–­å¤±è´¥ï¼Œå›é€€åˆ°å…³é”®è¯æ£€æµ‹: {}", err);

    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨å…³é”®è¯æ£€æµ‹
    let is_continue = detect_continue_intent(task_description);
    use crate::llm::PlanningStrategyDetectionResult;
    PlanningStrategyDetectionResult {
        strategy: if is_continue {
            PlanningStrategy::ContinuePlanning
        } else {
            PlanningStrategy::NormalPlanning
        },
        confidence: 50.0,  // é™çº§æ–¹æ¡ˆç½®ä¿¡åº¦è¾ƒä½
        reasoning: "LLMè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å…³é”®è¯åŒ¹é…ä½œä¸ºé™çº§æ–¹æ¡ˆ".to_string(),
    }
});

info!(
    "ğŸ¯ è§„åˆ’ç­–ç•¥: {:?}, ç½®ä¿¡åº¦: {:.1}%, ç†ç”±: {}",
    planning_strategy.strategy,
    planning_strategy.confidence,
    planning_strategy.reasoning
);

// 5.1 æ ¹æ®ç­–ç•¥æ„å»ºæç¤ºè¯
let (system_prompt, user_prompt) = match planning_strategy.strategy {
    PlanningStrategy::ContinuePlanning => {
        // ğŸ”„ ç»§ç»­æ‰§è¡Œæ¨¡å¼ï¼šä½¿ç”¨ ContinuePlanningPromptBuilder
        info!(task_type = %task_type, "ğŸ”„ ä½¿ç”¨ç»§ç»­è§„åˆ’ç­–ç•¥");

        // ä» context ä¸­æå–ç”¨æˆ·ä¸Šä¸‹æ–‡
        let user_context = /* ... æ„å»ºä¸Šä¸‹æ–‡ ... */;

        let continue_context = ContinuePlanningContext::new(
            Some(task_type.clone()),
            user_context,
        );

        let continue_prompt_builder = ContinuePlanningPromptBuilder::new();
        continue_prompt_builder.build_continue_planning_prompt(
            &continue_context,
            &tools_info,
            metadata,
            workflow_hint.as_deref(),
        )
    }
    PlanningStrategy::Replanning => {
        // ğŸ”„ é‡æ–°è§„åˆ’æ¨¡å¼ï¼šä½¿ç”¨ ReplanningPromptBuilder
        // TODO: éœ€è¦ä» context ä¸­æå–å¤±è´¥ä¿¡æ¯å’Œåæ€ç»“æœ
        // å½“å‰æš‚æ—¶å›é€€åˆ°æ™®é€šè§„åˆ’æ¨¡å¼
        warn!("âš ï¸ LLMåˆ¤æ–­ä¸ºé‡æ–°è§„åˆ’ç­–ç•¥ï¼Œä½†å½“å‰ä¸Šä¸‹æ–‡æœªåŒ…å«å¤±è´¥ä¿¡æ¯ï¼Œå›é€€åˆ°æ™®é€šè§„åˆ’æ¨¡å¼");

        // å›é€€åˆ°æ™®é€šè§„åˆ’
        let planning_prompt_builder = PlanningPromptBuilder::new();
        planning_prompt_builder.build_enhanced_planning_prompt(
            task_description,
            &tools_info,
            metadata,
            context,
            workflow_hint.as_deref(),
            Some(&task_type),
        )
    }
    PlanningStrategy::NormalPlanning => {
        // ğŸ“‹ æ™®é€šè§„åˆ’æ¨¡å¼ï¼šä½¿ç”¨ PlanningPromptBuilder
        info!(task_type = %task_type, "ğŸ¯ ä½¿ç”¨æ™®é€šè§„åˆ’ç­–ç•¥ï¼š{}", task_type);

        let planning_prompt_builder = PlanningPromptBuilder::new();
        planning_prompt_builder.build_enhanced_planning_prompt(
            task_description,
            &tools_info,
            metadata,
            context,
            workflow_hint.as_deref(),
            Some(&task_type),
        )
    }
};
```

## 6. æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·è¾“å…¥ä»»åŠ¡æè¿°                â”‚
â”‚   "ç»§ç»­æ‰§è¡Œä¸Šæ¬¡çš„ä»»åŠ¡"             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ detect_planning_strategy_with_llmâ”‚
â”‚ - æ„å»ºæç¤ºè¯                      â”‚
â”‚ - è°ƒç”¨LLM                        â”‚
â”‚ - è§£æJSONå“åº”                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLMè¿”å›ç­–ç•¥åˆ¤æ–­ç»“æœ              â”‚
â”‚  {                               â”‚
â”‚    strategy: "continue_planning",â”‚
â”‚    confidence: 85,               â”‚
â”‚    reasoning: "ç”¨æˆ·è¦æ±‚ç»§ç»­æ‰§è¡Œ"  â”‚
â”‚  }                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
        â”‚ ç½®ä¿¡åº¦æ£€æŸ¥    â”‚
        â”‚ >= 70.0?     â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
               â”‚ Yes
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      æ ¹æ®ç­–ç•¥é€‰æ‹©è§„åˆ’å™¨            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ContinuePlanning                 â”‚
â”‚   â†’ ContinuePlanningPromptBuilderâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Replanning                       â”‚
â”‚   â†’ ReplanningPromptBuilder      â”‚
â”‚      (TODO: å½“å‰å›é€€åˆ°æ™®é€šè§„åˆ’)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NormalPlanning                   â”‚
â”‚   â†’ PlanningPromptBuilder        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ç”Ÿæˆæ‰§è¡Œè®¡åˆ’                 â”‚
â”‚   (åŒ…å« step_1, step_2, ...)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 7. é™çº§ç­–ç•¥ä¸å®¹é”™

### 7.1 LLMè°ƒç”¨å¤±è´¥é™çº§

å½“LLMè°ƒç”¨å¤±è´¥æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨ä½¿ç”¨å…³é”®è¯åŒ¹é…ä½œä¸ºé™çº§æ–¹æ¡ˆï¼š

```rust
.unwrap_or_else(|err| {
    warn!("âš ï¸ LLMè§„åˆ’ç­–ç•¥åˆ¤æ–­å¤±è´¥ï¼Œå›é€€åˆ°å…³é”®è¯æ£€æµ‹: {}", err);

    // 1. ä½¿ç”¨å…³é”®è¯åŒ¹é…
    let is_continue = detect_continue_intent(task_description);

    // 2. è¿”å›é™çº§ç»“æœ
    PlanningStrategyDetectionResult {
        strategy: if is_continue {
            PlanningStrategy::ContinuePlanning
        } else {
            PlanningStrategy::NormalPlanning
        },
        confidence: 50.0,  // é™çº§æ–¹æ¡ˆç½®ä¿¡åº¦è¾ƒä½
        reasoning: "LLMè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å…³é”®è¯åŒ¹é…ä½œä¸ºé™çº§æ–¹æ¡ˆ".to_string(),
    }
})
```

### 7.2 ä½ç½®ä¿¡åº¦å‘Šè­¦

ç³»ç»Ÿä¼šè®°å½•ä½ç½®ä¿¡åº¦çš„åˆ¤æ–­ç»“æœï¼š

```rust
if result.confidence < confidence_threshold {
    warn!(
        "âš ï¸ ç½®ä¿¡åº¦ {:.1} ä½äºé˜ˆå€¼ {:.1}ï¼Œç­–ç•¥å¯èƒ½ä¸å‡†ç¡®",
        result.confidence,
        confidence_threshold
    );
}
```

### 7.3 JSONè§£æå¤±è´¥å¤„ç†

å¦‚æœLLMè¿”å›çš„ä¸æ˜¯æœ‰æ•ˆJSONï¼Œä¼šè®°å½•é”™è¯¯å¹¶æŠ›å‡ºå¼‚å¸¸ï¼š

```rust
let result: PlanningStrategyDetectionResult = serde_json::from_str(&response)
    .map_err(|e| {
        warn!("âš ï¸ è§£æLLMè§„åˆ’ç­–ç•¥åˆ¤æ–­ç»“æœå¤±è´¥: {}, å“åº”: {}", e, response);
        Box::new(e) as Box<dyn std::error::Error + Send + Sync>
    })?;
```

## 8. æ€§èƒ½ä¸æˆæœ¬åˆ†æ

### 8.1 æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | å…³é”®è¯åŒ¹é… | LLMåˆ¤æ–­ | å·®å¼‚ |
|------|----------|---------|------|
| **å“åº”æ—¶é—´** | <1ms | 100-300ms | +100-300ms |
| **å‡†ç¡®ç‡** | ~70% | ~95% | +25% |
| **è¯¯åˆ¤ç‡** | ~30% | ~5% | -25% |
| **CPUå ç”¨** | æä½ | ä½ | å¯å¿½ç•¥ |
| **å†…å­˜å ç”¨** | æä½ | ä½ | å¯å¿½ç•¥ |

### 8.2 æˆæœ¬ä¼°ç®—

å‡è®¾ä½¿ç”¨ Claude Haiku æ¨¡å‹ï¼š

```
å•æ¬¡è°ƒç”¨æˆæœ¬:
- è¾“å…¥ tokens: ~200 (æç¤ºè¯ + ä»»åŠ¡æè¿°)
- è¾“å‡º tokens: ~50 (JSONç»“æœ)
- æ€»æˆæœ¬: ~0.001å…ƒ/æ¬¡

æœˆåº¦æˆæœ¬ä¼°ç®—ï¼ˆæŒ‰10ä¸‡æ¬¡è°ƒç”¨ï¼‰:
- æ€»æˆæœ¬: 100å…ƒ/æœˆ
- å¹³å‡æ¯æ¬¡ä»»åŠ¡å¢åŠ æˆæœ¬: 0.001å…ƒ
```

### 8.3 å»¶è¿Ÿå½±å“

```
æ€»ä»»åŠ¡å“åº”æ—¶é—´ = è§„åˆ’æ—¶é—´ + æ‰§è¡Œæ—¶é—´

å…³é”®è¯åŒ¹é…: è§„åˆ’æ—¶é—´ â‰ˆ 500ms
LLMåˆ¤æ–­: è§„åˆ’æ—¶é—´ â‰ˆ 700ms (å¢åŠ 200ms)

å¯¹äºå¤§å¤šæ•°ä»»åŠ¡(æ‰§è¡Œæ—¶é—´ > 5s)ï¼Œå¢åŠ çš„200mså»¶è¿Ÿå æ¯” < 4%
```

## 9. æ—¥å¿—ä¸ç›‘æ§

### 9.1 æ—¥å¿—ç¤ºä¾‹

```log
[INFO] ğŸ¯ è§„åˆ’ç­–ç•¥: ContinuePlanning, ç½®ä¿¡åº¦: 85.0%, ç†ç”±: ç”¨æˆ·æ˜ç¡®è¦æ±‚ç»§ç»­ä¸Šæ¬¡ä»»åŠ¡
[INFO] ğŸ”„ ä½¿ç”¨ç»§ç»­è§„åˆ’ç­–ç•¥
[INFO] ğŸ“Š ä¸Šä¸‹æ–‡ä¿¡æ¯åˆ†æï¼šå¯¹è¯å†å² 3 æ¡ã€æ–‡æ¡£ 0 ä¸ªã€é™„åŠ ä¿¡æ¯ 2 æ¡ã€ç”¨æˆ·åå¥½ 0 æ¡

[WARN] âš ï¸ ç½®ä¿¡åº¦ 65.0 ä½äºé˜ˆå€¼ 70.0ï¼Œç­–ç•¥å¯èƒ½ä¸å‡†ç¡®
[WARN] âš ï¸ LLMè§„åˆ’ç­–ç•¥åˆ¤æ–­å¤±è´¥ï¼Œå›é€€åˆ°å…³é”®è¯æ£€æµ‹: NetworkError

[ERROR] âš ï¸ è§£æLLMè§„åˆ’ç­–ç•¥åˆ¤æ–­ç»“æœå¤±è´¥: InvalidJson, å“åº”: {"strategy": "continue...
```

### 9.2 å…³é”®æŒ‡æ ‡ç›‘æ§

å»ºè®®ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

1. **ç­–ç•¥åˆ†å¸ƒ**
   - ContinuePlanningå æ¯”
   - Replanningå æ¯”
   - NormalPlanningå æ¯”

2. **ç½®ä¿¡åº¦åˆ†å¸ƒ**
   - é«˜ç½®ä¿¡åº¦(>80)å æ¯”
   - ä¸­ç½®ä¿¡åº¦(60-80)å æ¯”
   - ä½ç½®ä¿¡åº¦(<60)å æ¯”

3. **é™çº§æ¬¡æ•°**
   - LLMè°ƒç”¨å¤±è´¥æ¬¡æ•°
   - é™çº§åˆ°å…³é”®è¯åŒ¹é…æ¬¡æ•°

4. **å‡†ç¡®æ€§**
   - ç”¨æˆ·åé¦ˆçš„è¯¯åˆ¤æ¬¡æ•°
   - äººå·¥å®¡æ ¸å‡†ç¡®ç‡

## 10. æœªæ¥ä¼˜åŒ–æ–¹å‘

### 10.1 æ”¯æŒReplanningç­–ç•¥å®Œæ•´å®ç°

å½“å‰Replanningä¼šå›é€€åˆ°NormalPlanningï¼Œéœ€è¦ï¼š
- ä»contextä¸­æå–å¤±è´¥ä¿¡æ¯
- æå–åæ€ç»“æœ
- é›†æˆReplanningPromptBuilder

### 10.2 ç­–ç•¥åˆ¤æ–­ç¼“å­˜

```rust
// ä¼ªä»£ç 
async fn detect_with_cache(task_desc: &str) -> PlanningStrategy {
    if let Some(cached) = cache.get(hash(task_desc)) {
        return cached;
    }

    let result = detect_planning_strategy_with_llm(task_desc).await?;
    cache.set(hash(task_desc), result.clone(), ttl=3600);
    result
}
```

### 10.3 å¤šæ¨¡å‹ç­–ç•¥

```rust
// æ ¹æ®ä»»åŠ¡å¤æ‚åº¦é€‰æ‹©æ¨¡å‹
let model = if task_desc.len() < 50 {
    "claude-haiku"  // å¿«é€Ÿæ¨¡å‹
} else {
    "claude-sonnet"  // é«˜çº§æ¨¡å‹
};
```

### 10.4 A/Bæµ‹è¯•æ¡†æ¶

- 50%æµé‡ä½¿ç”¨å…³é”®è¯åŒ¹é…
- 50%æµé‡ä½¿ç”¨LLMåˆ¤æ–­
- å¯¹æ¯”å‡†ç¡®ç‡ã€å»¶è¿Ÿã€æˆæœ¬
- æ”¶é›†ç”¨æˆ·åé¦ˆ

### 10.5 äººå·¥åé¦ˆé—­ç¯

```rust
// å…è®¸ç”¨æˆ·çº æ­£ç­–ç•¥åˆ¤æ–­
pub async fn report_strategy_feedback(
    task_id: &str,
    actual_strategy: PlanningStrategy,
    llm_strategy: PlanningStrategy,
) {
    // è®°å½•åˆ°æ•°æ®åº“
    // ç”¨äºä¼˜åŒ–æç¤ºè¯
}
```

## 11. æœ€ä½³å®è·µ

### 11.1 ä½•æ—¶è°ƒæ•´ç½®ä¿¡åº¦é˜ˆå€¼

```
å½“å‰é»˜è®¤é˜ˆå€¼: 70.0

å»ºè®®è°ƒä½é˜ˆå€¼(60.0)çš„åœºæ™¯:
- LLMåˆ¤æ–­å¾ˆå°‘å‡ºé”™
- å¸Œæœ›æœ€å¤§åŒ–LLMçš„åˆ¤æ–­èƒ½åŠ›
- å¯ä»¥å®¹å¿å°‘é‡è¯¯åˆ¤

å»ºè®®è°ƒé«˜é˜ˆå€¼(80.0)çš„åœºæ™¯:
- LLMåˆ¤æ–­è¯¯å·®è¾ƒå¤§
- éœ€è¦æ›´é«˜çš„å‡†ç¡®æ€§
- é™çº§åˆ°å…³é”®è¯ä¹Ÿèƒ½æ¥å—
```

### 11.2 æç¤ºè¯ä¼˜åŒ–å»ºè®®

1. **å¢åŠ ç¤ºä¾‹**ï¼šåœ¨ç³»ç»Ÿæç¤ºè¯ä¸­æ·»åŠ æ›´å¤šæ­£è´Ÿæ ·æœ¬
2. **æ˜ç¡®è¾¹ç•Œ**ï¼šæ¸…æ™°å®šä¹‰æ¨¡ç³Šæƒ…å†µçš„å¤„ç†æ–¹å¼
3. **è¿­ä»£ä¼˜åŒ–**ï¼šæ ¹æ®å®é™…è¯¯åˆ¤caseä¼˜åŒ–æç¤ºè¯

### 11.3 é”™è¯¯å¤„ç†å»ºè®®

```rust
// æ¨èï¼šä½¿ç”¨unwrap_or_elseå¤„ç†é”™è¯¯
let strategy = detect_planning_strategy_with_llm(desc, client, 70.0)
    .await
    .unwrap_or_else(|err| {
        // é™çº§é€»è¾‘
    });

// ä¸æ¨èï¼šç›´æ¥unwrap
let strategy = detect_planning_strategy_with_llm(desc, client, 70.0)
    .await
    .unwrap();  // å¯èƒ½å¯¼è‡´æœåŠ¡å´©æºƒ
```

## 12. å¸¸è§é—®é¢˜

### Q1: LLMåˆ¤æ–­æ¯”å…³é”®è¯æ…¢å¤šå°‘ï¼Ÿ

**A**: å¢åŠ çº¦100-300mså»¶è¿Ÿã€‚å¯¹äºå¤§å¤šæ•°ä»»åŠ¡(æ‰§è¡Œæ—¶é—´>5s)ï¼Œè¿™ä¸ªå»¶è¿Ÿå æ¯”å¾ˆå°(<5%)ã€‚

### Q2: å¦‚æœLLMæœåŠ¡ä¸å¯ç”¨æ€ä¹ˆåŠï¼Ÿ

**A**: ç³»ç»Ÿä¼šè‡ªåŠ¨é™çº§åˆ°å…³é”®è¯åŒ¹é…ï¼Œä¸ä¼šå½±å“æœåŠ¡å¯ç”¨æ€§ã€‚

### Q3: ç½®ä¿¡åº¦ä½äºé˜ˆå€¼ä¼šæ€æ ·ï¼Ÿ

**A**: ç³»ç»Ÿä»ä¼šä½¿ç”¨LLMçš„åˆ¤æ–­ç»“æœï¼Œä½†ä¼šè®°å½•å‘Šè­¦æ—¥å¿—ã€‚æœªæ¥å¯ä»¥æ‰©å±•ä¸ºé™çº§åˆ°å…³é”®è¯ã€‚

### Q4: å¦‚ä½•ä¼˜åŒ–LLMåˆ¤æ–­çš„å‡†ç¡®æ€§ï¼Ÿ

**A**:
1. æ”¶é›†è¯¯åˆ¤caseä¼˜åŒ–æç¤ºè¯
2. è°ƒæ•´ç½®ä¿¡åº¦é˜ˆå€¼
3. æ·»åŠ æ›´å¤šç¤ºä¾‹åˆ°ç³»ç»Ÿæç¤ºè¯

### Q5: Replanningç­–ç•¥ä»€ä¹ˆæ—¶å€™èƒ½å®Œæ•´æ”¯æŒï¼Ÿ

**A**: éœ€è¦ä»contextä¸­æå–å¤±è´¥ä¿¡æ¯å’Œåæ€ç»“æœã€‚ç›®å‰æš‚æ—¶å›é€€åˆ°æ™®é€šè§„åˆ’ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-01-15
**ä½œè€…**: Task Orchestration Service Team
**æœ€åæ›´æ–°**: 2025-01-15
**å…³è”æ–‡æ¡£**:
- [15-ç»§ç»­è§„åˆ’åŠŸèƒ½å®ç°è¯¦è§£.md](./15-ç»§ç»­è§„åˆ’åŠŸèƒ½å®ç°è¯¦è§£.md)
- [10-è¯­ä¹‰è·¯ç”±æœºåˆ¶ä¸åœºæ™¯æ„ŸçŸ¥æç¤ºè¯ç³»ç»Ÿè®¾è®¡æ–‡æ¡£.md](./10-è¯­ä¹‰è·¯ç”±æœºåˆ¶ä¸åœºæ™¯æ„ŸçŸ¥æç¤ºè¯ç³»ç»Ÿè®¾è®¡æ–‡æ¡£(äººä¸ºå¹²é¢„ä¸åŒæ„å›¾åœºæ™¯ä¸‹å¤§æ¨¡å‹è¡ŒåŠ¨çš„æ ¸å¿ƒæ­¦å™¨).md)
