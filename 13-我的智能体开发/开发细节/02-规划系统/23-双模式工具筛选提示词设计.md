# åŒæ¨¡å¼å·¥å…·ç­›é€‰æç¤ºè¯è®¾è®¡æ–‡æ¡£

> **åˆ›å»ºæ—¶é—´**: 2026-01-15
> **æœ€åæ›´æ–°**: 2026-01-15
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®ç°
> **å…³è”æ–‡ä»¶**: [src/llm/selection_prompts.rs](../../../src/llm/selection_prompts.rs)
> **ç›¸å…³æ–‡æ¡£**: [10-è¯­ä¹‰è·¯ç”±æœºåˆ¶ä¸åœºæ™¯æ„ŸçŸ¥æç¤ºè¯ç³»ç»Ÿè®¾è®¡æ–‡æ¡£.md](./10-è¯­ä¹‰è·¯ç”±æœºåˆ¶ä¸åœºæ™¯æ„ŸçŸ¥æç¤ºè¯ç³»ç»Ÿè®¾è®¡æ–‡æ¡£(äººä¸ºå¹²é¢„ä¸åŒæ„å›¾åœºæ™¯ä¸‹å¤§æ¨¡å‹è¡ŒåŠ¨çš„æ ¸å¿ƒæ­¦å™¨).md)

## ğŸ¯ æ ¸å¿ƒä»·å€¼

åŒæ¨¡å¼å·¥å…·ç­›é€‰æ˜¯ä»»åŠ¡ç¼–æ’ç³»ç»Ÿæ™ºèƒ½æ¢å¤æœºåˆ¶çš„å…³é”®ç»„æˆéƒ¨åˆ†ï¼Œé€šè¿‡åŒºåˆ†**é¦–æ¬¡è§„åˆ’**å’Œ**é‡æ–°è§„åˆ’**ä¸¤ç§åœºæ™¯ï¼Œå®ç°ï¼š
- âœ… **é¦–æ¬¡è§„åˆ’**ï¼šåŸºäºéœ€æ±‚é¢„æµ‹å·¥å…·ï¼ˆè¦†ç›–å®Œæ•´æµç¨‹ï¼‰
- âœ… **é‡æ–°è§„åˆ’**ï¼šåŸºäºæ‰§è¡Œåé¦ˆä¿®æ­£å·¥å…·ï¼ˆé¿å…é‡å¤å¤±è´¥ï¼‰

è¿™ç§è®¾è®¡è®©ç³»ç»Ÿèƒ½å¤Ÿä»å¤±è´¥ä¸­å­¦ä¹ ï¼Œä¸æ–­ä¼˜åŒ–å·¥å…·é€‰æ‹©ç­–ç•¥ã€‚

## ğŸ“‹ ç›®å½•
- [è®¾è®¡èƒŒæ™¯](#è®¾è®¡èƒŒæ™¯)
- [ä¸¤ç§å·¥å…·ç­›é€‰åœºæ™¯å¯¹æ¯”](#ä¸¤ç§å·¥å…·ç­›é€‰åœºæ™¯å¯¹æ¯”)
- [é¦–æ¬¡è§„åˆ’å·¥å…·ç­›é€‰æç¤ºè¯](#é¦–æ¬¡è§„åˆ’å·¥å…·ç­›é€‰æç¤ºè¯)
- [é‡æ–°è§„åˆ’å·¥å…·ç­›é€‰æç¤ºè¯](#é‡æ–°è§„åˆ’å·¥å…·ç­›é€‰æç¤ºè¯)
- [å®ç°è®¾è®¡](#å®ç°è®¾è®¡)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)

---

## è®¾è®¡èƒŒæ™¯

### ä¸ºä»€ä¹ˆéœ€è¦ä¸¤å¥—å·¥å…·ç­›é€‰æç¤ºè¯ï¼Ÿ

å½“å‰ç³»ç»Ÿåªæœ‰ä¸€å¥—å·¥å…·ç­›é€‰æç¤ºè¯ï¼Œç”¨äº**é¦–æ¬¡è§„åˆ’æ—¶çš„å·¥å…·ç­›é€‰**ã€‚ä½†åœ¨**é‡æ–°è§„åˆ’åœºæ™¯**ä¸‹ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†ï¼š
- âŒ ä¹‹å‰é€‰æ‹©çš„å·¥å…·åŠå…¶æ‰§è¡Œæ•ˆæœ
- âŒ åæ€åˆ†æç»“æœï¼ˆå¤±è´¥åŸå› ã€æ ¹æœ¬åŸå› ï¼‰
- âŒ æ‰§è¡Œå†å²ï¼ˆå“ªäº›æ­¥éª¤æˆåŠŸã€å“ªäº›å¤±è´¥ï¼‰
- âŒ æ•´ä½“åæ€çš„æ”¹è¿›å»ºè®®

**é—®é¢˜**ï¼šé‡æ–°è§„åˆ’æ—¶ä»ç„¶ä½¿ç”¨é¦–æ¬¡ç­›é€‰çš„æç¤ºè¯ï¼Œæ— æ³•å……åˆ†åˆ©ç”¨è¿™äº›å®è´µçš„**æ‰§è¡Œåé¦ˆä¿¡æ¯**ï¼Œå¯¼è‡´ï¼š
1. ğŸ”´ å¯èƒ½å†æ¬¡é€‰æ‹©å·²è¢«è¯æ˜æ— æ•ˆçš„å·¥å…·
2. ğŸ”´ æ— æ³•æ ¹æ®å¤±è´¥ç»éªŒè°ƒæ•´å·¥å…·é€‰æ‹©ç­–ç•¥
3. ğŸ”´ æµªè´¹äº†åæ€é˜¶æ®µæ”¶é›†çš„å®è´µä¿¡æ¯

**è§£å†³æ–¹æ¡ˆ**ï¼šè®¾è®¡**ä¸¤å¥—ç‹¬ç«‹çš„å·¥å…·ç­›é€‰æç¤ºè¯**ï¼Œåˆ†åˆ«é’ˆå¯¹é¦–æ¬¡è§„åˆ’å’Œé‡æ–°è§„åˆ’åœºæ™¯ã€‚

---

## ä¸¤ç§å·¥å…·ç­›é€‰åœºæ™¯å¯¹æ¯”

| ç»´åº¦ | é¦–æ¬¡è§„åˆ’å·¥å…·ç­›é€‰ | é‡æ–°è§„åˆ’å·¥å…·ç­›é€‰ |
|------|-----------------|-----------------|
| **è¾“å…¥ä¸Šä¸‹æ–‡** | â€¢ ä»»åŠ¡æè¿°<br>â€¢ TaskContextï¼ˆå¯¹è¯/æ–‡æ¡£/åå¥½ï¼‰<br>â€¢ å…ƒæ•°æ® | â€¢ ä»»åŠ¡æè¿°<br>â€¢ åæ€åˆ†æç»“æœ<br>â€¢ æ‰§è¡Œå†å²<br>â€¢ ä¹‹å‰é€‰æ‹©çš„å·¥å…·åŠæ•ˆæœ<br>â€¢ æ•´ä½“åæ€æŒ‡å¯¼ |
| **æ ¸å¿ƒç›®æ ‡** | åŸºäºéœ€æ±‚**é¢„æµ‹**éœ€è¦å“ªäº›å·¥å…· | åŸºäº**å¤±è´¥ç»éªŒ**è°ƒæ•´å·¥å…·é€‰æ‹© |
| **ç­›é€‰ç­–ç•¥** | é¢„æµ‹æ€§ç­›é€‰ï¼š<br>â€¢ è¯­ä¹‰åŒ¹é…<br>â€¢ æ„å›¾è¯†åˆ«<br>â€¢ è¦†ç›–å®Œæ•´æµç¨‹ | ä¿®æ­£æ€§ç­›é€‰ï¼š<br>â€¢ é¿å…å¤±è´¥å·¥å…·<br>â€¢ å¯»æ‰¾æ›¿ä»£å·¥å…·<br>â€¢ è¡¥å……ç¼ºå¤±èƒ½åŠ› |
| **å†³ç­–ä¾æ®** | â€¢ ä»»åŠ¡è¯­ä¹‰ç›¸ä¼¼åº¦<br>â€¢ å·¥å…·åŠŸèƒ½è¦†ç›–åº¦<br>â€¢ æ„å›¾åˆ†ç±»åŒ¹é… | â€¢ æ‰§è¡Œå¤±è´¥åŸå› <br>â€¢ å·¥å…·å®é™…æ•ˆæœ<br>â€¢ åæ€æ”¹è¿›å»ºè®®<br>â€¢ èƒ½åŠ›ç¼ºå£åˆ†æ |
| **æ€ç»´æ–¹å¼** | æ­£å‘æ¨ç†ï¼š<br>"å®Œæˆè¿™ä¸ªä»»åŠ¡éœ€è¦ä»€ä¹ˆå·¥å…·ï¼Ÿ" | é€†å‘ä¿®æ­£ï¼š<br>"ä¹‹å‰å¤±è´¥äº†ï¼Œå“ªäº›å·¥å…·éœ€è¦æ›¿æ¢/è¡¥å……ï¼Ÿ" |

---

## é¦–æ¬¡è§„åˆ’å·¥å…·ç­›é€‰æç¤ºè¯

### ç³»ç»Ÿæç¤ºè¯ï¼ˆINITIAL_TOOL_SELECTION_SYSTEM_PROMPTï¼‰

```text
ä½ æ˜¯å·¥å…·ç­›é€‰ä¸“å®¶ï¼Œä»å¤§é‡å·¥å…·ä¸­å¿«é€Ÿè¯†åˆ«ä¸ä»»åŠ¡ç›¸å…³çš„å·¥å…·ã€‚

ã€æ ¸å¿ƒä»»åŠ¡ã€‘
**ä¸¥æ ¼åŸºäºä»»åŠ¡æè¿°ã€ä¸Šä¸‹æ–‡ä¿¡æ¯å’Œå…ƒæ•°æ®**ç­›é€‰å®Œæˆä»»åŠ¡æ‰€éœ€çš„å·¥å…·ï¼Œè¯†åˆ«ä»»åŠ¡ç±»å‹ã€‚
è¿™æ˜¯ä¸¤é˜¶æ®µè§„åˆ’çš„ç¬¬ä¸€æ­¥ï¼Œç»“æœç”¨äºåç»­ä»»åŠ¡åˆ†è§£ã€‚

âš ï¸ **é‡è¦ï¼šè¿™æ˜¯é¦–æ¬¡è§„åˆ’ï¼Œä½ æ²¡æœ‰æ‰§è¡Œå†å²å¯å‚è€ƒ**
- ä½ çš„ç­›é€‰æ˜¯é¢„æµ‹æ€§çš„ï¼ŒåŸºäºä»»åŠ¡éœ€æ±‚æ¨æ–­æ‰€éœ€å·¥å…·
- é‡ç‚¹å…³æ³¨ä»»åŠ¡çš„å®Œæ•´æµç¨‹è¦†ç›–
- å®å¯å¤šé€‰ä¸å¯æ¼é€‰ï¼ˆåç»­è§„åˆ’é˜¶æ®µä¼šä¼˜åŒ–ï¼‰

ã€ç­›é€‰èŒè´£ã€‘
1. éªŒè¯ä»»åŠ¡æ¸…æ™°åº¦
2. **ä¼˜å…ˆä»ä»»åŠ¡æè¿°ä¸­æå–æ˜ç¡®çš„æ„å›¾**ï¼ˆå¦‚"æ„å›¾: XXX"ï¼‰
3. ä»ä»»åŠ¡æè¿°ã€ä¸Šä¸‹æ–‡ä¿¡æ¯å’Œå…ƒæ•°æ®æå–ç›®æ ‡ã€é¢†åŸŸå’Œç±»å‹
4. æ ¹æ®å·¥å…·åˆ†ç±»ã€èƒ½åŠ›åˆ¤æ–­ä¸ä»»åŠ¡çš„ç›¸å…³æ€§
5. å¿«é€ŸåŒ¹é…é«˜åº¦ç›¸å…³å·¥å…·ï¼Œæ’é™¤æ— å…³å·¥å…·
6. ç¡®ä¿è¦†ç›–ä»»åŠ¡æ‰€æœ‰ç¯èŠ‚ï¼ˆéªŒè¯ â†’ å¤„ç† â†’ åˆ†æ â†’ è¾“å‡ºï¼‰

ã€ä¸Šä¸‹æ–‡ä¿¡æ¯çš„ä½œç”¨ã€‘
âœ“ **å¯¹è¯å†å²**ï¼šç†è§£ç”¨æˆ·çœŸå®æ„å›¾å’Œéšå«éœ€æ±‚
âœ“ **ç›¸å…³æ–‡æ¡£**ï¼šè·å–é¢†åŸŸçŸ¥è¯†å’ŒæŠ€æœ¯çº¦æŸ
âœ“ **ç”¨æˆ·åå¥½**ï¼šäº†è§£ç”¨æˆ·å€¾å‘çš„å®ç°æ–¹å¼
âœ“ **é™„åŠ ä¿¡æ¯**ï¼šè¡¥å……ä»»åŠ¡æè¿°ä¸­æœªæ˜ç¡®çš„ç»†èŠ‚

ã€ç­›é€‰ç­–ç•¥ - ä¸‰ç§æ¨¡å¼ã€‘

âš ï¸âš ï¸âš ï¸ **æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™ï¼šæ„å›¾è¯†åˆ«å†³å®šç­›é€‰æ¨¡å¼ï¼**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”´ **æ¨¡å¼Aï¼šæ„å›¾æ˜ç¡® â†’ åˆ†ç±»ä¼˜å…ˆ + è¯­ä¹‰è¡¥å……ï¼ˆæ··åˆç­›é€‰ï¼‰**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å¦‚æœä»»åŠ¡æè¿°åŒ…å«"æ„å›¾: XXX"æ ¼å¼ï¼ˆå¦‚"æ„å›¾: å·¥å…·ç®¡ç†, ç”¨æˆ·è¾“å…¥: ..."ï¼‰ï¼š

**é˜¶æ®µ1ï¼šä¼˜å…ˆæŒ‰åˆ†ç±»ç­›é€‰ï¼ˆä¸»å·¥å…·é›†ï¼‰**
  âœ… **å¿…é¡»**å°† XXX ç›´æ¥ä½œä¸º task_type
  âœ… **ä¼˜å…ˆ**é€‰æ‹©ã€Œåˆ†ç±»ã€å­—æ®µç­‰äº XXX çš„æ‰€æœ‰ç›¸å…³å·¥å…·
  âœ… è¿™æ˜¯ä¸»å·¥å…·é›†ï¼Œç”¨äºæ»¡è¶³æ„å›¾åˆ†ç±»çš„æ ¸å¿ƒéœ€æ±‚

**é˜¶æ®µ2ï¼šè¯­ä¹‰ç›¸ä¼¼åº¦è¡¥å……ï¼ˆè¡¥å……å·¥å…·é›†ï¼‰**
  âš ï¸ **å…³é”®åˆ¤æ–­**ï¼šè¯„ä¼°é˜¶æ®µ1é€‰å‡ºçš„å·¥å…·æ˜¯å¦è¶³ä»¥å®Œæˆç”¨æˆ·è¾“å…¥ä¸­çš„å®é™…ä»»åŠ¡

  å¦‚æœåˆ†ç±»å·¥å…·ä¸è¶³ä»¥è§£å†³å®é™…é—®é¢˜ï¼š
  âœ… ä»**å…¶ä»–åˆ†ç±»**ä¸­é€‰æ‹©ä¸ç”¨æˆ·è¾“å…¥å†…å®¹**è¯­ä¹‰é«˜åº¦ç›¸ä¼¼**çš„å·¥å…·ï¼ˆç›¸ä¼¼åº¦ â‰¥ 75%ï¼‰
  âœ… è¿™äº›æ˜¯è¡¥å……å·¥å…·ï¼Œç”¨äºå¼¥è¡¥åˆ†ç±»å·¥å…·çš„èƒ½åŠ›ç¼ºå£
  âœ… åœ¨ brief_reasoning ä¸­æ˜ç¡®è¯´æ˜å“ªäº›æ˜¯åˆ†ç±»å·¥å…·ã€å“ªäº›æ˜¯è¯­ä¹‰è¡¥å……å·¥å…·

  å¦‚æœåˆ†ç±»å·¥å…·å·²ç»è¶³å¤Ÿï¼š
  âŒ ä¸éœ€è¦æ·»åŠ å…¶ä»–åˆ†ç±»çš„å·¥å…·
  âŒ é¿å…è¿‡åº¦ç­›é€‰

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸŸ¢ **æ¨¡å¼Bï¼šæ„å›¾ä¸æ˜ç¡® â†’ çº¯è¯­ä¹‰ç›¸ä¼¼åº¦ç­›é€‰**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å¦‚æœä»»åŠ¡æè¿°**ä¸åŒ…å«**"æ„å›¾: XXX"æ ¼å¼ï¼š
  âœ… æ ¹æ®ä»»åŠ¡æè¿°å’Œä¸Šä¸‹æ–‡çš„è¯­ä¹‰å†…å®¹åˆ†æéœ€æ±‚
  âœ… æ ¹æ®å·¥å…·çš„åŠŸèƒ½æè¿°ã€èƒ½åŠ›ã€æ ‡ç­¾è¿›è¡Œè¯­ä¹‰åŒ¹é…
  âœ… é€‰æ‹©åŠŸèƒ½æœ€ç›¸å…³çš„å·¥å…·ï¼Œä¸å—åˆ†ç±»é™åˆ¶

ã€æ‹’ç»æ¡ä»¶ã€‘
ğŸš« ä»¥ä¸‹æƒ…å†µåº”è¯¥æ‹’ç»ç­›é€‰ï¼ˆshould_reject = trueï¼‰ï¼š
- ä»»åŠ¡æè¿°ä¸ºç©ºã€æ— æ„ä¹‰æˆ–è¿‡äºæ¨¡ç³Š
- ä»»åŠ¡ä¸æ‰€æœ‰å·¥å…·ç±»åˆ«ç›¸ä¼¼åº¦ < 30%
- æ— æ³•æå–æ˜ç¡®æ„å›¾æˆ–ç›®æ ‡
- å…ƒæ•°æ®ä¸ºç©ºä¸”ä»»åŠ¡æè¿°æ— å¯æ‰§è¡Œä¿¡æ¯

ã€ç­›é€‰åŸåˆ™ã€‘
âš ï¸ å®å¯å¤šé€‰ä¸å¯æ¼é€‰ï¼Œé¿å…é—æ¼å…³é”®å·¥å…·
âš ï¸ è€ƒè™‘å®Œæ•´æµç¨‹ï¼ˆéªŒè¯ â†’ å¤„ç† â†’ åˆ†æ â†’ è¾“å‡ºï¼‰
âš ï¸ å……åˆ†åˆ©ç”¨ä¸Šä¸‹æ–‡ä¿¡æ¯ç†è§£ç”¨æˆ·çœŸå®éœ€æ±‚

ã€è¾“å‡ºæ ¼å¼ã€‘
JSON Schemaï¼š
{
  "should_reject": false,
  "reject_reason": null,
  "similarity_score": 50-100,
  "selected_tool_ids": ["å·¥å…·ID1", "å·¥å…·ID2"],
  "task_type": "è´Ÿè·é¢„æµ‹|è‡ªåŠ¨å»ºæ¨¡|æ•°æ®åˆ†æ|æ•°å­¦è®¡ç®—|å®¢æˆ·ç«¯æ“ä½œ|PLCæ§åˆ¶å™¨|å·¥å…·ç®¡ç†|é€šç”¨",
  "selection_confidence": 0-100,
  "brief_reasoning": "ç®€çŸ­è¯´æ˜ç­›é€‰é€»è¾‘å’Œå·¥å…·æ¥æº"
}
```

### ç”¨æˆ·æç¤ºè¯æ¨¡æ¿ï¼ˆINITIAL_TOOL_SELECTION_USER_TEMPLATEï¼‰

```text
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ä»»åŠ¡ä¿¡æ¯ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ ä»»åŠ¡æè¿°ï¼š
{task_description}

ğŸ“Š ä»»åŠ¡å…ƒæ•°æ®ï¼š
{metadata}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ä»»åŠ¡ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{task_context}

ğŸ’¡ **ä¸Šä¸‹æ–‡è¯´æ˜**ï¼š
ä»¥ä¸Šä¿¡æ¯æ¥è‡ªç”¨æˆ·æäº¤ä»»åŠ¡æ—¶çš„ä¸Šä¸‹æ–‡ï¼ˆå¯¹è¯å†å²ã€ç›¸å…³æ–‡æ¡£ã€ç”¨æˆ·åå¥½ç­‰ï¼‰ã€‚
è¯·å……åˆ†åˆ©ç”¨è¿™äº›ä¿¡æ¯ç†è§£ç”¨æˆ·çš„çœŸå®éœ€æ±‚å’Œéšå«è¦æ±‚ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å¯ç”¨å·¥å…·åº“ã€‘å…± {tool_count} ä¸ªå·¥å…·
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{available_tools}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ç­›é€‰ä¸¥æ ¼åº¦é…ç½®ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
{threshold_guidance}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€åœºæ™¯æŒ‡å¯¼ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
{scene_specific_guidance}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ç­›é€‰ä»»åŠ¡ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸ **é‡è¦ï¼šè¿™æ˜¯é¦–æ¬¡è§„åˆ’çš„å·¥å…·ç­›é€‰ï¼Œä½ æ²¡æœ‰æ‰§è¡Œå†å²å¯å‚è€ƒ**

ç¬¬ä¸€æ­¥ï¼šè¯†åˆ«ä»»åŠ¡æ„å›¾ï¼Œå†³å®šç­›é€‰æ¨¡å¼
âœ“ ä»»åŠ¡æè¿°ä¸­æ˜¯å¦åŒ…å«"æ„å›¾: XXX"æ ¼å¼ï¼Ÿ
  - å¦‚æœåŒ…å«ï¼šä½¿ç”¨ã€åˆ†ç±»ä¼˜å…ˆ + è¯­ä¹‰è¡¥å……æ¨¡å¼ã€‘
  - å¦‚æœä¸åŒ…å«ï¼šä½¿ç”¨ã€çº¯è¯­ä¹‰ç­›é€‰æ¨¡å¼ã€‘

ç¬¬äºŒæ­¥ï¼šè¯„ä¼°ä»»åŠ¡æè¿°å’Œä¸Šä¸‹æ–‡
âœ“ ä»»åŠ¡æè¿°æ˜¯å¦æ¸…æ™°æ˜ç¡®ï¼Ÿ
âœ“ ä¸Šä¸‹æ–‡ä¿¡æ¯æ˜¯å¦æä¾›äº†é¢å¤–çš„éœ€æ±‚çº¿ç´¢ï¼Ÿ
âœ“ ä»»åŠ¡æè¿°ä¸å·¥å…·åº“çš„ç›¸ä¼¼åº¦æ˜¯å¤šå°‘ï¼Ÿï¼ˆ0-100åˆ†ï¼‰
âœ“ å¦‚æœç›¸ä¼¼åº¦ < 30%ï¼Œåº”è¯¥æ‹’ç»ä»»åŠ¡

ç¬¬ä¸‰æ­¥ï¼šæ ¹æ®ç¬¬ä¸€æ­¥ç¡®å®šçš„æ¨¡å¼ç­›é€‰å·¥å…·
è¯·ä»ä¸Šè¿° {tool_count} ä¸ªå·¥å…·ä¸­ç­›é€‰å‡ºå®Œæˆä»»åŠ¡æ‰€éœ€çš„æ‰€æœ‰å·¥å…·ã€‚

ç­›é€‰è¦æ±‚ï¼š
âœ“ å……åˆ†åˆ©ç”¨ä¸Šä¸‹æ–‡ä¿¡æ¯ç†è§£ç”¨æˆ·çœŸå®éœ€æ±‚
âœ“ å®å¯å¤šé€‰ä¸å¯æ¼é€‰ï¼ˆåç»­è§„åˆ’é˜¶æ®µä¼šä¼˜åŒ–å·¥å…·ä½¿ç”¨ï¼‰
âœ“ ç¡®ä¿è¦†ç›–ä»»åŠ¡çš„å®Œæ•´æµç¨‹
âœ“ åœ¨ brief_reasoning ä¸­è¯´æ˜ï¼š
  - åŸºäºå“ªäº›ä¿¡æ¯åšå‡ºç­›é€‰å†³ç­–ï¼ˆä»»åŠ¡æè¿° / ä¸Šä¸‹æ–‡ä¿¡æ¯ / å…ƒæ•°æ®ï¼‰
  - å¦‚æœä½¿ç”¨æ„å›¾æ¨¡å¼ï¼Œè¯´æ˜åˆ†ç±»å·¥å…·å’Œè¡¥å……å·¥å…·çš„æ¥æº

è¾“å‡ºè¦æ±‚ï¼š
âœ“ è¿”å› JSON æ ¼å¼çš„ç­›é€‰ç»“æœ
âœ“ å¦‚æœåº”è¯¥æ‹’ç»ï¼Œè®¾ç½® should_reject=true å¹¶æä¾› reject_reason
âœ“ å¦‚æœå¯ä»¥æ‰§è¡Œï¼Œè®¾ç½® should_reject=false å¹¶æä¾›ç­›é€‰çš„å·¥å…·IDåˆ—è¡¨
âœ“ å¿…é¡»åŒ…å« similarity_scoreï¼ˆä»»åŠ¡æè¿°ä¸å·¥å…·åº“çš„ç›¸ä¼¼åº¦ï¼‰

ç°åœ¨è¯·å¼€å§‹è¯„ä¼°å’Œç­›é€‰ã€‚
```

---

## é‡æ–°è§„åˆ’å·¥å…·ç­›é€‰æç¤ºè¯

### ç³»ç»Ÿæç¤ºè¯ï¼ˆREPLANNING_TOOL_SELECTION_SYSTEM_PROMPTï¼‰

```text
ä½ æ˜¯å·¥å…·ç­›é€‰ä¸“å®¶ï¼ŒåŸºäºæ‰§è¡Œå¤±è´¥ç»éªŒé‡æ–°ç­›é€‰å·¥å…·ã€‚

ã€æ ¸å¿ƒä»»åŠ¡ã€‘
**åŸºäºåæ€åˆ†æã€æ‰§è¡Œå†å²å’Œå¤±è´¥åŸå› **é‡æ–°ç­›é€‰å·¥å…·ï¼Œä¿®æ­£ä¹‹å‰çš„å·¥å…·é€‰æ‹©é”™è¯¯ã€‚
è¿™æ˜¯é‡æ–°è§„åˆ’çš„ç¬¬ä¸€æ­¥ï¼Œç»“æœç”¨äºåç»­ä»»åŠ¡é‡æ–°åˆ†è§£ã€‚

âš ï¸ **é‡è¦ï¼šè¿™æ˜¯é‡æ–°è§„åˆ’ï¼Œä½ æœ‰ä¸°å¯Œçš„æ‰§è¡Œåé¦ˆå¯å‚è€ƒ**
- ä½ çš„ç­›é€‰æ˜¯ä¿®æ­£æ€§çš„ï¼ŒåŸºäºå®é™…æ‰§è¡Œæ•ˆæœè°ƒæ•´å·¥å…·é€‰æ‹©
- é‡ç‚¹å…³æ³¨å¤±è´¥åŸå› å’Œèƒ½åŠ›ç¼ºå£
- é¿å…é‡å¤é€‰æ‹©å·²è¢«è¯æ˜æ— æ•ˆçš„å·¥å…·
- ç§¯æå¯»æ‰¾æ›¿ä»£å·¥å…·æˆ–è¡¥å……ç¼ºå¤±èƒ½åŠ›çš„å·¥å…·

ã€ç­›é€‰èŒè´£ã€‘
1. **åˆ†æä¹‹å‰çš„å·¥å…·é€‰æ‹©é—®é¢˜**ï¼šå“ªäº›å·¥å…·å¤±è´¥äº†ï¼Ÿä¸ºä»€ä¹ˆå¤±è´¥ï¼Ÿ
2. **è¯†åˆ«èƒ½åŠ›ç¼ºå£**ï¼šä»»åŠ¡éœ€è¦ä½†ä¹‹å‰å·¥å…·é›†ä¸å…·å¤‡çš„èƒ½åŠ›
3. **å¯»æ‰¾æ›¿ä»£å·¥å…·**ï¼šèƒ½å¤Ÿæ›¿ä»£å¤±è´¥å·¥å…·çš„å…¶ä»–é€‰æ‹©
4. **è¡¥å……ç¼ºå¤±å·¥å…·**ï¼šä¹‹å‰é—æ¼ä½†ç°åœ¨å‘ç°éœ€è¦çš„å·¥å…·
5. **ä¿ç•™æœ‰æ•ˆå·¥å…·**ï¼šä¹‹å‰é€‰æ‹©æ­£ç¡®ä¸”æ‰§è¡ŒæˆåŠŸçš„å·¥å…·
6. **é‡‡çº³åæ€å»ºè®®**ï¼šæ•´ä½“åæ€ä¸­å…³äºå·¥å…·é€‰æ‹©çš„æ”¹è¿›å»ºè®®

ã€æ‰§è¡Œåé¦ˆçš„ä½œç”¨ã€‘
âœ“ **åæ€åˆ†æ**ï¼šç†è§£å¤±è´¥çš„æ ¹æœ¬åŸå› ï¼ˆä¸åªæ˜¯è¡¨é¢ç°è±¡ï¼‰
âœ“ **æ‰§è¡Œå†å²**ï¼šäº†è§£å“ªäº›å·¥å…·è¢«ä½¿ç”¨ã€æ•ˆæœå¦‚ä½•ã€å¤±è´¥ç‚¹åœ¨å“ª
âœ“ **ä¹‹å‰é€‰æ‹©çš„å·¥å…·**ï¼šè¯†åˆ«å“ªäº›å·¥å…·æœ‰æ•ˆã€å“ªäº›æ— æ•ˆ
âœ“ **æ•´ä½“åæ€æŒ‡å¯¼**ï¼šè·å–æ·±åº¦åˆ†æåçš„æ”¹è¿›å»ºè®®

ã€é‡æ–°ç­›é€‰ç­–ç•¥ - ä¿®æ­£æ€§æ€ç»´ã€‘

âš ï¸âš ï¸âš ï¸ **æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™ï¼šåŸºäºå¤±è´¥ç»éªŒè°ƒæ•´å·¥å…·é€‰æ‹©ï¼**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”´ **æ ¸å¿ƒåŸåˆ™ï¼šé¿å…é‡å¤å¤±è´¥ï¼Œå¯»æ‰¾æ–°è·¯å¾„**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**ç¬¬ä¸€æ­¥ï¼šåˆ†æä¹‹å‰çš„å·¥å…·é€‰æ‹©é—®é¢˜**
  âœ… è¯†åˆ«å¤±è´¥å·¥å…·ï¼šå“ªäº›å·¥å…·æ‰§è¡Œå¤±è´¥äº†ï¼Ÿ
  âœ… åˆ†æå¤±è´¥åŸå› ï¼š
    - å·¥å…·æœ¬èº«æœ‰ç¼ºé™·ï¼Ÿï¼ˆbugã€åŠŸèƒ½ä¸å®Œæ•´ï¼‰
    - å·¥å…·é€‰æ‹©é”™è¯¯ï¼Ÿï¼ˆä¸é€‚åˆå½“å‰ä»»åŠ¡ï¼‰
    - å·¥å…·ç¼ºå¤±èƒ½åŠ›ï¼Ÿï¼ˆæ— æ³•æ»¡è¶³ç‰¹å®šéœ€æ±‚ï¼‰
    - å·¥å…·ç»„åˆä¸å½“ï¼Ÿï¼ˆå·¥å…·ä¹‹é—´ä¸å…¼å®¹ï¼‰
  âœ… è®°å½•æœ‰æ•ˆå·¥å…·ï¼šå“ªäº›å·¥å…·æ‰§è¡ŒæˆåŠŸï¼Œåº”è¯¥ä¿ç•™ï¼Ÿ

**ç¬¬äºŒæ­¥ï¼šé‡‡çº³æ•´ä½“åæ€çš„æ”¹è¿›å»ºè®®**
  âš ï¸ æ•´ä½“åæ€ä¸­çš„"æ›¿ä»£æ–¹æ³•/æ”¹è¿›å»ºè®®"æ˜¯å…³é”®è¾“å…¥
  âœ… å¦‚æœå»ºè®®æ›´æ¢å·¥å…·ç±»å‹ï¼Œä¼˜å…ˆé€‰æ‹©å»ºè®®çš„å·¥å…·
  âœ… å¦‚æœå»ºè®®è¡¥å……èƒ½åŠ›ï¼Œå¯»æ‰¾å…·å¤‡è¯¥èƒ½åŠ›çš„å·¥å…·
  âœ… å¦‚æœå»ºè®®è°ƒæ•´ç­–ç•¥ï¼Œç›¸åº”è°ƒæ•´å·¥å…·é€‰æ‹©

**ç¬¬ä¸‰æ­¥ï¼šé‡æ–°ç­›é€‰å·¥å…·é›†**
  åŸºäºä¸Šè¿°åˆ†æï¼Œæ„å»ºæ–°çš„å·¥å…·é›†ï¼š

  âœ… **ä¿ç•™éƒ¨åˆ†**ï¼šä¹‹å‰é€‰æ‹©æ­£ç¡®ä¸”æ‰§è¡ŒæˆåŠŸçš„å·¥å…·
  âœ… **æ›¿æ¢éƒ¨åˆ†**ï¼šæ›¿æ¢å¤±è´¥çš„å·¥å…·ä¸ºåŠŸèƒ½ç›¸ä¼¼ä½†æ›´å¯é çš„å·¥å…·
  âœ… **è¡¥å……éƒ¨åˆ†**ï¼šæ·»åŠ ä¹‹å‰é—æ¼ä½†ç°åœ¨å‘ç°éœ€è¦çš„å·¥å…·
  âœ… **ç§»é™¤éƒ¨åˆ†**ï¼šç§»é™¤è¢«è¯æ˜æ— æ•ˆæˆ–ä¸å¿…è¦çš„å·¥å…·

**ç¬¬å››æ­¥ï¼šéªŒè¯æ–°å·¥å…·é›†**
  âœ… æ–°å·¥å…·é›†æ˜¯å¦è§£å†³äº†ä¹‹å‰çš„èƒ½åŠ›ç¼ºå£ï¼Ÿ
  âœ… æ–°å·¥å…·é›†æ˜¯å¦é¿å¼€äº†ä¹‹å‰çš„å¤±è´¥ç‚¹ï¼Ÿ
  âœ… æ–°å·¥å…·é›†æ˜¯å¦é‡‡çº³äº†åæ€çš„æ”¹è¿›å»ºè®®ï¼Ÿ
  âœ… æ–°å·¥å…·é›†æ˜¯å¦è¦†ç›–ä»»åŠ¡çš„å®Œæ•´æµç¨‹ï¼Ÿ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸŸ¢ **åˆ›æ–°æ€ç»´ï¼šä¸è¦å±€é™äºä¹‹å‰çš„é€‰æ‹©**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  âœ… æ¢ç´¢ä¹‹å‰æœªè€ƒè™‘çš„å·¥å…·ç±»åˆ«
  âœ… å°è¯•ä¸åŒçš„å·¥å…·ç»„åˆæ–¹å¼
  âœ… è€ƒè™‘ä½¿ç”¨æ›´åº•å±‚æˆ–æ›´é«˜å±‚çš„å·¥å…·
  âœ… ä¸è¦å®³æ€•å¤§å¹…è°ƒæ•´å·¥å…·é€‰æ‹©ï¼ˆåˆ›æ–°å¾€å¾€æ¥è‡ªå¤§èƒ†é‡æ„ï¼‰

ã€ç­›é€‰åŸåˆ™ã€‘
âš ï¸ å¤±è´¥ç»éªŒæ˜¯æœ€å®è´µçš„ä¿¡æ¯ï¼Œå……åˆ†åˆ©ç”¨
âš ï¸ ä¸è¦é‡å¤ä¹‹å‰çš„é”™è¯¯é€‰æ‹©
âš ï¸ ç§¯æå¯»æ‰¾æ›¿ä»£æ–¹æ¡ˆï¼Œä¸è¦å›ºå®ˆåŸæ–¹æ¡ˆ
âš ï¸ é‡‡çº³åæ€å»ºè®®ï¼Œå°Šé‡æ·±åº¦åˆ†æçš„ç»“æœ

ã€è¾“å‡ºæ ¼å¼ã€‘
JSON Schemaï¼š
{
  "should_reject": false,
  "reject_reason": null,
  "similarity_score": 50-100,
  "selected_tool_ids": ["å·¥å…·ID1", "å·¥å…·ID2"],
  "task_type": "è´Ÿè·é¢„æµ‹|è‡ªåŠ¨å»ºæ¨¡|æ•°æ®åˆ†æ|æ•°å­¦è®¡ç®—|å®¢æˆ·ç«¯æ“ä½œ|PLCæ§åˆ¶å™¨|å·¥å…·ç®¡ç†|é€šç”¨",
  "selection_confidence": 0-100,
  "brief_reasoning": "è¯´æ˜ç›¸æ¯”ä¹‹å‰çš„ç­›é€‰åšäº†å“ªäº›è°ƒæ•´åŠåŸå› ",
  "changes_from_previous": {
    "kept_tools": ["ä¿ç•™çš„å·¥å…·ID"],
    "replaced_tools": [{"old": "æ—§å·¥å…·ID", "new": "æ–°å·¥å…·ID", "reason": "æ›¿æ¢åŸå› "}],
    "added_tools": [{"tool_id": "æ–°å¢å·¥å…·ID", "reason": "æ–°å¢åŸå› "}],
    "removed_tools": [{"tool_id": "ç§»é™¤å·¥å…·ID", "reason": "ç§»é™¤åŸå› "}]
  }
}
```

### ç”¨æˆ·æç¤ºè¯æ¨¡æ¿ï¼ˆREPLANNING_TOOL_SELECTION_USER_TEMPLATEï¼‰

```text
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ä»»åŠ¡ä¿¡æ¯ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ ä»»åŠ¡æè¿°ï¼š
{task_description}

ğŸ“Š ä»»åŠ¡å…ƒæ•°æ®ï¼š
{metadata}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ä¹‹å‰çš„å·¥å…·ç­›é€‰ç»“æœã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{previous_tool_selection}

ğŸ’¡ **è¯´æ˜**ï¼šä»¥ä¸Šæ˜¯é¦–æ¬¡è§„åˆ’æ—¶é€‰æ‹©çš„å·¥å…·åˆ—è¡¨åŠå…¶æ‰§è¡Œæ•ˆæœã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€æ‰§è¡Œå†å²ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{execution_history}

ğŸ’¡ **è¯´æ˜**ï¼šä»¥ä¸Šæ˜¯ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„è¯¦ç»†è®°å½•ï¼ŒåŒ…å«æ¯ä¸ªæ­¥éª¤ä½¿ç”¨çš„å·¥å…·ã€è¾“å…¥å‚æ•°ã€è¾“å‡ºç»“æœå’Œæ‰§è¡ŒçŠ¶æ€ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€åæ€åˆ†æç»“æœã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{reflection_analysis}

ğŸ’¡ **è¯´æ˜**ï¼šä»¥ä¸Šæ˜¯åæ€é˜¶æ®µå¯¹å¤±è´¥åŸå› çš„åˆ†æï¼ŒåŒ…å«é—®é¢˜è¯†åˆ«å’Œæ”¹è¿›å»ºè®®ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ğŸ”´ æ•´ä½“åæ€æŒ‡å¯¼ - å¿…é¡»é‡‡çº³çš„æ”¹è¿›å»ºè®®ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸ ä»¥ä¸‹æ˜¯æ•´ä½“åæ€é˜¶æ®µçš„åˆ†æç»“æœï¼ŒåŒ…å«äº†å¯¹ä¹‹å‰å¤±è´¥çš„æ·±åº¦åˆ†æå’Œå·¥å…·é€‰æ‹©æ”¹è¿›å»ºè®®ã€‚
âš ï¸ é‡æ–°ç­›é€‰å·¥å…·æ—¶**å¿…é¡»**è®¤çœŸå‚è€ƒè¿™äº›å»ºè®®ï¼Œé¿å…é‡å¤ä¹‹å‰çš„é”™è¯¯ã€‚

{overall_reflection_guidance}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å¯ç”¨å·¥å…·åº“ã€‘å…± {tool_count} ä¸ªå·¥å…·
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{available_tools}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ç­›é€‰ä¸¥æ ¼åº¦é…ç½®ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
{threshold_guidance}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€åœºæ™¯æŒ‡å¯¼ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
{scene_specific_guidance}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€é‡æ–°ç­›é€‰ä»»åŠ¡ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸ **é‡è¦ï¼šè¿™æ˜¯é‡æ–°è§„åˆ’çš„å·¥å…·ç­›é€‰ï¼Œä½ æœ‰ä¸°å¯Œçš„æ‰§è¡Œåé¦ˆå¯å‚è€ƒ**

ç¬¬ä¸€æ­¥ï¼šåˆ†æä¹‹å‰çš„å·¥å…·é€‰æ‹©é—®é¢˜
âœ“ å“ªäº›å·¥å…·æ‰§è¡Œå¤±è´¥äº†ï¼Ÿå¤±è´¥åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ
âœ“ å“ªäº›å·¥å…·æ‰§è¡ŒæˆåŠŸäº†ï¼Ÿåº”è¯¥ä¿ç•™ï¼Ÿ
âœ“ æ˜¯å¦å­˜åœ¨èƒ½åŠ›ç¼ºå£ï¼ˆä»»åŠ¡éœ€è¦ä½†å·¥å…·é›†ä¸å…·å¤‡çš„èƒ½åŠ›ï¼‰ï¼Ÿ
âœ“ æ•´ä½“åæ€å»ºè®®äº†å“ªäº›å·¥å…·é€‰æ‹©æ”¹è¿›ï¼Ÿ

ç¬¬äºŒæ­¥ï¼šæ„å»ºæ–°çš„å·¥å…·é›†
åŸºäºä¸Šè¿°åˆ†æï¼Œé‡æ–°ç­›é€‰å·¥å…·ï¼š

âœ“ **ä¿ç•™æœ‰æ•ˆå·¥å…·**ï¼šä¹‹å‰é€‰æ‹©æ­£ç¡®ä¸”æ‰§è¡ŒæˆåŠŸçš„å·¥å…·
âœ“ **æ›¿æ¢å¤±è´¥å·¥å…·**ï¼šå¯»æ‰¾åŠŸèƒ½ç›¸ä¼¼ä½†æ›´å¯é çš„æ›¿ä»£å·¥å…·
âœ“ **è¡¥å……ç¼ºå¤±å·¥å…·**ï¼šæ·»åŠ ä¹‹å‰é—æ¼ä½†ç°åœ¨å‘ç°éœ€è¦çš„å·¥å…·
âœ“ **ç§»é™¤æ— æ•ˆå·¥å…·**ï¼šç§»é™¤è¢«è¯æ˜æ— æ•ˆæˆ–ä¸å¿…è¦çš„å·¥å…·

âš ï¸ **åˆ›æ–°æ€ç»´è¦æ±‚**ï¼š
- ä¸è¦å±€é™äºä¹‹å‰çš„é€‰æ‹©ï¼Œæ¢ç´¢æ–°çš„å·¥å…·ç»„åˆ
- å¦‚æœæ•´ä½“åæ€å»ºè®®äº†å®Œå…¨ä¸åŒçš„å®ç°è·¯å¾„ï¼Œå¤§èƒ†è°ƒæ•´å·¥å…·é›†
- è€ƒè™‘ä½¿ç”¨ä¹‹å‰æœªå°è¯•çš„å·¥å…·ç±»åˆ«

ç¬¬ä¸‰æ­¥ï¼šéªŒè¯æ–°å·¥å…·é›†
âœ“ æ–°å·¥å…·é›†æ˜¯å¦è§£å†³äº†ä¹‹å‰çš„èƒ½åŠ›ç¼ºå£ï¼Ÿ
âœ“ æ–°å·¥å…·é›†æ˜¯å¦é¿å¼€äº†ä¹‹å‰çš„å¤±è´¥ç‚¹ï¼Ÿ
âœ“ æ–°å·¥å…·é›†æ˜¯å¦é‡‡çº³äº†åæ€çš„æ”¹è¿›å»ºè®®ï¼Ÿ
âœ“ æ–°å·¥å…·é›†æ˜¯å¦è¦†ç›–ä»»åŠ¡çš„å®Œæ•´æµç¨‹ï¼Ÿ

è¾“å‡ºè¦æ±‚ï¼š
âœ“ è¿”å› JSON æ ¼å¼çš„ç­›é€‰ç»“æœ
âœ“ åœ¨ brief_reasoning ä¸­è¯´æ˜ï¼šç›¸æ¯”ä¹‹å‰çš„ç­›é€‰åšäº†å“ªäº›è°ƒæ•´åŠåŸå› 
âœ“ åœ¨ changes_from_previous ä¸­è¯¦ç»†åˆ—å‡ºï¼š
  - ä¿ç•™äº†å“ªäº›å·¥å…·ï¼ˆkept_toolsï¼‰
  - æ›¿æ¢äº†å“ªäº›å·¥å…·ï¼ˆreplaced_toolsï¼‰
  - æ–°å¢äº†å“ªäº›å·¥å…·ï¼ˆadded_toolsï¼‰
  - ç§»é™¤äº†å“ªäº›å·¥å…·ï¼ˆremoved_toolsï¼‰
âœ“ å¿…é¡»åŒ…å« similarity_score å’Œ selection_confidence

ç°åœ¨è¯·å¼€å§‹é‡æ–°ç­›é€‰å·¥å…·ã€‚
```

---

## å®ç°è®¾è®¡

### 1. ä¿®æ”¹ `SelectionPromptBuilder` ç»“æ„

```rust
// src/llm/selection_prompts.rs

/// å·¥å…·ç­›é€‰çš„åœºæ™¯ç±»å‹
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum ToolSelectionScenario {
    /// é¦–æ¬¡è§„åˆ’ï¼šåŸºäºéœ€æ±‚é¢„æµ‹å·¥å…·
    InitialPlanning,
    /// é‡æ–°è§„åˆ’ï¼šåŸºäºæ‰§è¡Œåé¦ˆä¿®æ­£å·¥å…·é€‰æ‹©
    Replanning,
}

/// é‡æ–°è§„åˆ’æ—¶çš„å·¥å…·ç­›é€‰ä¸Šä¸‹æ–‡
#[derive(Debug, Clone)]
pub struct ReplanningToolSelectionContext {
    /// ä¹‹å‰ç­›é€‰çš„å·¥å…·åˆ—è¡¨ï¼ˆå·¥å…·ID -> å·¥å…·ä¿¡æ¯ï¼‰
    pub previous_tools: Vec<PreviousToolInfo>,
    /// æ‰§è¡Œå†å²
    pub execution_history: String,
    /// åæ€åˆ†æç»“æœ
    pub reflection_analysis: String,
    /// æ•´ä½“åæ€æŒ‡å¯¼
    pub overall_reflection_guidance: Option<String>,
}

/// ä¹‹å‰ä½¿ç”¨çš„å·¥å…·ä¿¡æ¯
#[derive(Debug, Clone)]
pub struct PreviousToolInfo {
    /// å·¥å…·ID
    pub tool_id: String,
    /// å·¥å…·åç§°
    pub tool_name: String,
    /// æ‰§è¡ŒçŠ¶æ€ï¼ˆSuccess / Failed / NotUsedï¼‰
    pub execution_status: String,
    /// å¤±è´¥åŸå› ï¼ˆå¦‚æœå¤±è´¥ï¼‰
    pub failure_reason: Option<String>,
    /// æ‰§è¡Œæ•ˆæœæ‘˜è¦
    pub execution_summary: Option<String>,
}

impl SelectionPromptBuilder {
    /// æ„å»ºé¦–æ¬¡è§„åˆ’çš„å·¥å…·ç­›é€‰æç¤ºè¯
    pub fn build_initial_tool_selection_prompt(
        &self,
        task_description: &str,
        available_tools: &str,
        tool_count: usize,
        metadata: &HashMap<String, String>,
        selection_threshold: f32,
        task_context: Option<&str>, // ğŸ†• ä»»åŠ¡ä¸Šä¸‹æ–‡ï¼ˆå¯¹è¯/æ–‡æ¡£/åå¥½ï¼‰
        task_type: Option<&str>,
    ) -> (String, String) {
        // ... ä½¿ç”¨ INITIAL_TOOL_SELECTION_SYSTEM_PROMPT
        // ... ä½¿ç”¨ INITIAL_TOOL_SELECTION_USER_TEMPLATE
    }

    /// æ„å»ºé‡æ–°è§„åˆ’çš„å·¥å…·ç­›é€‰æç¤ºè¯
    pub fn build_replanning_tool_selection_prompt(
        &self,
        task_description: &str,
        available_tools: &str,
        tool_count: usize,
        metadata: &HashMap<String, String>,
        selection_threshold: f32,
        replanning_context: &ReplanningToolSelectionContext, // ğŸ†• é‡æ–°è§„åˆ’ä¸Šä¸‹æ–‡
        task_type: Option<&str>,
    ) -> (String, String) {
        // ... ä½¿ç”¨ REPLANNING_TOOL_SELECTION_SYSTEM_PROMPT
        // ... ä½¿ç”¨ REPLANNING_TOOL_SELECTION_USER_TEMPLATE

        // æ ¼å¼åŒ–ä¹‹å‰çš„å·¥å…·é€‰æ‹©ç»“æœ
        let previous_tools_text = self.format_previous_tools(&replanning_context.previous_tools);

        // æ„å»ºç”¨æˆ·æç¤ºè¯
        let user_prompt = REPLANNING_TOOL_SELECTION_USER_TEMPLATE
            .replace("{task_description}", task_description)
            .replace("{metadata}", &format_metadata(metadata))
            .replace("{previous_tool_selection}", &previous_tools_text)
            .replace("{execution_history}", &replanning_context.execution_history)
            .replace("{reflection_analysis}", &replanning_context.reflection_analysis)
            .replace("{overall_reflection_guidance}",
                     &replanning_context.overall_reflection_guidance.as_deref().unwrap_or("(æœªè§¦å‘æ•´ä½“åæ€)"))
            .replace("{available_tools}", available_tools)
            .replace("{tool_count}", &tool_count.to_string())
            .replace("{threshold_guidance}", &Self::format_threshold_guidance(selection_threshold))
            .replace("{scene_specific_guidance}", &self.scene_manager.get_selection_guidance(task_type));

        (REPLANNING_TOOL_SELECTION_SYSTEM_PROMPT.to_string(), user_prompt)
    }

    /// æ ¼å¼åŒ–ä¹‹å‰çš„å·¥å…·é€‰æ‹©ç»“æœ
    fn format_previous_tools(&self, tools: &[PreviousToolInfo]) -> String {
        if tools.is_empty() {
            return "(ä¹‹å‰æœªè¿›è¡Œå·¥å…·ç­›é€‰)".to_string();
        }

        let mut result = String::new();
        result.push_str("ã€å·¥å…·åˆ—è¡¨åŠæ‰§è¡Œæ•ˆæœã€‘\n\n");

        for tool in tools {
            let status_icon = match tool.execution_status.as_str() {
                "Success" => "âœ…",
                "Failed" => "âŒ",
                _ => "âšª",
            };

            result.push_str(&format!("{} **{}** (ID: {})\n", status_icon, tool.tool_name, tool.tool_id));
            result.push_str(&format!("   çŠ¶æ€: {}\n", tool.execution_status));

            if let Some(summary) = &tool.execution_summary {
                result.push_str(&format!("   æ‰§è¡Œæ‘˜è¦: {}\n", summary));
            }

            if let Some(reason) = &tool.failure_reason {
                result.push_str(&format!("   å¤±è´¥åŸå› : {}\n", reason));
            }

            result.push('\n');
        }

        result
    }
}
```

### 2. ä¿®æ”¹ `Planner` è°ƒç”¨é€»è¾‘

```rust
// src/core/planner.rs

impl Planner {
    /// é¦–æ¬¡è§„åˆ’æ—¶çš„å·¥å…·ç­›é€‰
    pub async fn select_tools_for_initial_planning(
        &self,
        task_description: &str,
        all_tools: &[ToolInfo],
        metadata: &HashMap<String, String>,
        task_context: Option<&TaskContext>, // ğŸ†• ä¼ å…¥ä¸Šä¸‹æ–‡
    ) -> Result<Vec<ToolInfo>> {
        // æ ¼å¼åŒ–å·¥å…·åˆ—è¡¨
        let tools_summary = self.format_tools_for_selection(all_tools);

        // æ ¼å¼åŒ–ä»»åŠ¡ä¸Šä¸‹æ–‡
        let context_text = self.format_task_context_for_selection(task_context);

        // æ„å»ºé¦–æ¬¡ç­›é€‰æç¤ºè¯
        let builder = SelectionPromptBuilder::new();
        let (system_prompt, user_prompt) = builder.build_initial_tool_selection_prompt(
            task_description,
            &tools_summary,
            all_tools.len(),
            metadata,
            self.tool_selection_threshold,
            Some(&context_text), // ğŸ†• ä¼ å…¥ä¸Šä¸‹æ–‡æ–‡æœ¬
            None,
        );

        // è°ƒç”¨ LLM è¿›è¡Œå·¥å…·ç­›é€‰
        // ...
    }

    /// é‡æ–°è§„åˆ’æ—¶çš„å·¥å…·ç­›é€‰
    pub async fn select_tools_for_replanning(
        &self,
        task_description: &str,
        all_tools: &[ToolInfo],
        metadata: &HashMap<String, String>,
        previous_tools: Vec<PreviousToolInfo>, // ğŸ†• ä¹‹å‰çš„å·¥å…·ä¿¡æ¯
        execution_history: &str,                // ğŸ†• æ‰§è¡Œå†å²
        reflection_analysis: &str,              // ğŸ†• åæ€åˆ†æ
        overall_reflection_guidance: Option<&str>, // ğŸ†• æ•´ä½“åæ€æŒ‡å¯¼
    ) -> Result<Vec<ToolInfo>> {
        // æ ¼å¼åŒ–å·¥å…·åˆ—è¡¨
        let tools_summary = self.format_tools_for_selection(all_tools);

        // æ„å»ºé‡æ–°è§„åˆ’ä¸Šä¸‹æ–‡
        let replanning_context = ReplanningToolSelectionContext {
            previous_tools,
            execution_history: execution_history.to_string(),
            reflection_analysis: reflection_analysis.to_string(),
            overall_reflection_guidance: overall_reflection_guidance.map(|s| s.to_string()),
        };

        // æ„å»ºé‡æ–°ç­›é€‰æç¤ºè¯
        let builder = SelectionPromptBuilder::new();
        let (system_prompt, user_prompt) = builder.build_replanning_tool_selection_prompt(
            task_description,
            &tools_summary,
            all_tools.len(),
            metadata,
            self.tool_selection_threshold,
            &replanning_context, // ğŸ†• ä¼ å…¥é‡æ–°è§„åˆ’ä¸Šä¸‹æ–‡
            None,
        );

        // è°ƒç”¨ LLM è¿›è¡Œå·¥å…·é‡æ–°ç­›é€‰
        // ...
    }

    /// æ ¼å¼åŒ–ä»»åŠ¡ä¸Šä¸‹æ–‡ç”¨äºå·¥å…·ç­›é€‰
    fn format_task_context_for_selection(&self, context: Option<&TaskContext>) -> String {
        if let Some(ctx) = context {
            // å¤ç”¨ PromptBuilder::format_task_context çš„é€»è¾‘
            // ...
        } else {
            "æ— ".to_string()
        }
    }
}
```

---

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šé¦–æ¬¡è§„åˆ’æ—¶çš„å·¥å…·ç­›é€‰

```rust
// ç”¨æˆ·æäº¤ä»»åŠ¡
let task_context = TaskContext {
    conversation_history: vec!["ç”¨æˆ·: æˆ‘éœ€è¦ä¸ºBIMæ¨¡å‹æ·»åŠ æ•°å­—å­ªç”ŸåŠŸèƒ½".to_string()],
    documents: vec![/* BIMç›¸å…³æ–‡æ¡£ */],
    user_preferences: vec!["å¸Œæœ›ä½¿ç”¨Revitå·¥å…·".to_string()],
    additional_info: HashMap::new(),
};

// è°ƒç”¨é¦–æ¬¡å·¥å…·ç­›é€‰
let selected_tools = planner.select_tools_for_initial_planning(
    "æ„å›¾: å·¥å…·ç®¡ç†, ç”¨æˆ·è¾“å…¥: åˆ›å»ºä¸€ä¸ªBIMæ•°å­—å­ªç”Ÿå·¥å…·",
    &all_tools,
    &metadata,
    Some(&task_context), // ğŸ†• ä¼ å…¥ä¸Šä¸‹æ–‡
).await?;

// LLM è¾“å‡ºï¼š
// {
//   "selected_tool_ids": [
//     "genesis_document_generate",   // åˆ†ç±»å·¥å…·ï¼šåˆ›å»ºå·¥å…·æ–‡æ¡£
//     "genesis_tool_register",        // åˆ†ç±»å·¥å…·ï¼šæ³¨å†Œå·¥å…·
//     "bim_geometry_modeler",         // è¡¥å……å·¥å…·ï¼šBIMå»ºæ¨¡ï¼ˆç›¸ä¼¼åº¦88%ï¼‰
//     "bim_equipment_modeler",        // è¡¥å……å·¥å…·ï¼šè®¾å¤‡å»ºæ¨¡ï¼ˆç›¸ä¼¼åº¦82%ï¼‰
//   ],
//   "brief_reasoning": "é€‰æ‹©4ä¸ªå·¥å…·ç®¡ç†åˆ†ç±»å·¥å…·ï¼ˆåˆ›å»ºã€æ³¨å†Œã€éªŒè¯ï¼‰+ 2ä¸ªBIMæ•°æ®å¤„ç†è¡¥å……å·¥å…·ï¼ˆå‡ ä½•å»ºæ¨¡ã€è®¾å¤‡å»ºæ¨¡ï¼Œç›¸ä¼¼åº¦85%ï¼‰ï¼Œå·¥å…·ç®¡ç†æä¾›æ¡†æ¶ï¼ŒBIMå·¥å…·æä¾›å®é™…åŠŸèƒ½"
// }
```

### ç¤ºä¾‹2ï¼šé‡æ–°è§„åˆ’æ—¶çš„å·¥å…·ç­›é€‰

```rust
// é¦–æ¬¡æ‰§è¡Œå¤±è´¥åï¼Œè¿›è¡Œåæ€
let reflection_analysis = "
å¤±è´¥åŸå› ï¼šbim_geometry_modeler å·¥å…·ç‰ˆæœ¬è¿‡æ—§ï¼Œä¸æ”¯æŒRevit 2024æ ¼å¼ã€‚
å»ºè®®ï¼šæ›´æ¢ä¸ºæ”¯æŒæœ€æ–°Revitæ ¼å¼çš„ bim_advanced_modeler å·¥å…·ã€‚
";

let overall_reflection_guidance = "
ã€æ ¹æœ¬åŸå› åˆ†æã€‘
1. å·¥å…·ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜å¯¼è‡´BIMæ¨¡å‹å¯¼å…¥å¤±è´¥

ã€æ”¹è¿›å»ºè®® - è¯·åœ¨é‡æ–°è§„åˆ’æ—¶é‡‡çº³ã€‘
1. æ›¿æ¢ bim_geometry_modeler ä¸º bim_advanced_modelerï¼ˆæ”¯æŒRevit 2024ï¼‰
2. æ·»åŠ  revit_format_validator å·¥å…·è¿›è¡Œæ ¼å¼é¢„æ£€æŸ¥
";

// æ„å»ºä¹‹å‰çš„å·¥å…·ä¿¡æ¯
let previous_tools = vec![
    PreviousToolInfo {
        tool_id: "genesis_document_generate".to_string(),
        tool_name: "åˆ›ä¸–æ–‡æ¡£ç”Ÿæˆå™¨".to_string(),
        execution_status: "Success".to_string(),
        failure_reason: None,
        execution_summary: Some("æˆåŠŸç”Ÿæˆå·¥å…·æ–‡æ¡£".to_string()),
    },
    PreviousToolInfo {
        tool_id: "bim_geometry_modeler".to_string(),
        tool_name: "BIMå‡ ä½•å»ºæ¨¡å™¨".to_string(),
        execution_status: "Failed".to_string(),
        failure_reason: Some("ä¸æ”¯æŒRevit 2024æ ¼å¼".to_string()),
        execution_summary: Some("å¯¼å…¥æ¨¡å‹å¤±è´¥".to_string()),
    },
];

// è°ƒç”¨é‡æ–°è§„åˆ’çš„å·¥å…·ç­›é€‰
let selected_tools = planner.select_tools_for_replanning(
    "æ„å›¾: å·¥å…·ç®¡ç†, ç”¨æˆ·è¾“å…¥: åˆ›å»ºä¸€ä¸ªBIMæ•°å­—å­ªç”Ÿå·¥å…·",
    &all_tools,
    &metadata,
    previous_tools,              // ğŸ†• ä¹‹å‰çš„å·¥å…·ä¿¡æ¯
    execution_history,            // ğŸ†• æ‰§è¡Œå†å²
    reflection_analysis,          // ğŸ†• åæ€åˆ†æ
    Some(overall_reflection_guidance), // ğŸ†• æ•´ä½“åæ€æŒ‡å¯¼
).await?;

// LLM è¾“å‡ºï¼š
// {
//   "selected_tool_ids": [
//     "genesis_document_generate",   // ä¿ç•™ï¼šä¹‹å‰æ‰§è¡ŒæˆåŠŸ
//     "genesis_tool_register",        // ä¿ç•™ï¼šä¹‹å‰æœªä½¿ç”¨ä½†éœ€è¦
//     "bim_advanced_modeler",         // æ›¿æ¢ï¼šæ”¯æŒRevit 2024ï¼ˆæ›¿ä»£ bim_geometry_modelerï¼‰
//     "revit_format_validator",       // æ–°å¢ï¼šåæ€å»ºè®®æ·»åŠ çš„æ ¼å¼é¢„æ£€æŸ¥
//     "bim_equipment_modeler",        // ä¿ç•™ï¼šä¹‹å‰é€‰æ‹©æ­£ç¡®
//   ],
//   "brief_reasoning": "åŸºäºåæ€å»ºè®®è°ƒæ•´å·¥å…·é€‰æ‹©ï¼šä¿ç•™æˆåŠŸå·¥å…·2ä¸ªï¼Œæ›¿æ¢å¤±è´¥å·¥å…·1ä¸ªï¼ˆbim_geometry_modeler â†’ bim_advanced_modelerï¼Œæ”¯æŒRevit 2024ï¼‰ï¼Œæ–°å¢æ ¼å¼éªŒè¯å·¥å…·1ä¸ª",
//   "changes_from_previous": {
//     "kept_tools": ["genesis_document_generate", "bim_equipment_modeler"],
//     "replaced_tools": [
//       {
//         "old": "bim_geometry_modeler",
//         "new": "bim_advanced_modeler",
//         "reason": "æ—§å·¥å…·ä¸æ”¯æŒRevit 2024æ ¼å¼ï¼Œå¯¼è‡´å¯¼å…¥å¤±è´¥"
//       }
//     ],
//     "added_tools": [
//       {
//         "tool_id": "revit_format_validator",
//         "reason": "é‡‡çº³åæ€å»ºè®®ï¼Œæ·»åŠ æ ¼å¼é¢„æ£€æŸ¥é¿å…é‡å¤å¤±è´¥"
//       },
//       {
//         "tool_id": "genesis_tool_register",
//         "reason": "ä¹‹å‰é—æ¼ï¼Œç°åœ¨è¡¥å……"
//       }
//     ],
//     "removed_tools": []
//   }
// }
```

---

## æ€»ç»“

### å…³é”®å·®å¼‚ç‚¹

| ç»´åº¦ | é¦–æ¬¡ç­›é€‰ | é‡æ–°ç­›é€‰ |
|------|---------|---------|
| **è¾“å…¥** | ä»»åŠ¡æè¿° + ä¸Šä¸‹æ–‡ + å…ƒæ•°æ® | ä»»åŠ¡æè¿° + åæ€ + æ‰§è¡Œå†å² + ä¹‹å‰å·¥å…· |
| **æ€ç»´** | é¢„æµ‹æ€§ï¼ˆéœ€è¦ä»€ä¹ˆå·¥å…·ï¼Ÿï¼‰ | ä¿®æ­£æ€§ï¼ˆå“ªäº›å·¥å…·éœ€è¦è°ƒæ•´ï¼Ÿï¼‰ |
| **ç­–ç•¥** | å®å¯å¤šé€‰ä¸å¯æ¼é€‰ | ç²¾å‡†æ›¿æ¢å’Œè¡¥å…… |
| **è¾“å‡º** | å·¥å…·åˆ—è¡¨ + ç­›é€‰ç†ç”± | å·¥å…·åˆ—è¡¨ + å˜æ›´è¯´æ˜ï¼ˆä¿ç•™/æ›¿æ¢/æ–°å¢/ç§»é™¤ï¼‰ |

### å®ç°ä¼˜åŠ¿

1. âœ… **æé«˜é‡æ–°è§„åˆ’çš„æˆåŠŸç‡**ï¼šåŸºäºå¤±è´¥ç»éªŒè°ƒæ•´å·¥å…·é€‰æ‹©
2. âœ… **å……åˆ†åˆ©ç”¨åæ€ç»“æœ**ï¼šåæ€çš„æ”¹è¿›å»ºè®®ç›´æ¥ç”¨äºå·¥å…·ç­›é€‰
3. âœ… **é¿å…é‡å¤å¤±è´¥**ï¼šæ˜ç¡®è¯†åˆ«å’Œæ›¿æ¢å¤±è´¥å·¥å…·
4. âœ… **æå‡LLMå†³ç­–è´¨é‡**ï¼šæä¾›æ›´ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯

---

## åç»­å·¥ä½œ

1. åœ¨ `selection_prompts.rs` ä¸­å®ç°è¿™ä¸¤å¥—æç¤ºè¯
2. ä¿®æ”¹ `Planner::select_tools_for_task` åˆ¤æ–­å½“å‰åœºæ™¯ï¼ˆé¦–æ¬¡ vs é‡æ–°è§„åˆ’ï¼‰
3. åœ¨ `Orchestrator::replan_task` ä¸­è°ƒç”¨é‡æ–°è§„åˆ’çš„å·¥å…·ç­›é€‰
4. æ·»åŠ æµ‹è¯•ç”¨ä¾‹éªŒè¯ä¸¤å¥—æç¤ºè¯çš„æœ‰æ•ˆæ€§
