# ç»§ç»­è§„åˆ’åŠŸèƒ½å®ç°è¯¦è§£

## 1. åŠŸèƒ½æ¦‚è¿°

ç»§ç»­è§„åˆ’åŠŸèƒ½å…è®¸ç³»ç»Ÿåœ¨ä»»åŠ¡ä¸­æ–­åï¼ŒåŸºäºå†å²æ‰§è¡Œè®°å½•ç»§ç»­è§„åˆ’å¹¶æ‰§è¡Œå‰©ä½™ä»»åŠ¡ã€‚è¿™ä¸ªåŠŸèƒ½ç‰¹åˆ«é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š

- **ä»»åŠ¡ä¸­æ–­æ¢å¤**ï¼šå½“ä»»åŠ¡å› æŸç§åŸå› ä¸­æ–­åï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡"ç»§ç»­æ‰§è¡Œ"æŒ‡ä»¤æ¢å¤ä»»åŠ¡
- **å¤šè½®å¯¹è¯åœºæ™¯**ï¼šç”¨æˆ·å¯ä»¥åœ¨å¤šè½®å¯¹è¯ä¸­é€æ­¥å®Œæˆå¤æ‚ä»»åŠ¡
- **å¢é‡å¼ä»»åŠ¡æ‰§è¡Œ**ï¼šå…ˆæ‰§è¡Œéƒ¨åˆ†æ­¥éª¤ï¼Œç„¶åæ ¹æ®ç»“æœå†³å®šæ˜¯å¦ç»§ç»­

## 2. æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 2.1 æ„å›¾è¯†åˆ«é©±åŠ¨

ç³»ç»Ÿæ”¯æŒ**ä¸¤çº§æ„å›¾è¯†åˆ«ç­–ç•¥**ï¼ˆå¯é€šè¿‡é…ç½®é€‰æ‹©ï¼‰ï¼š

#### ç­–ç•¥1ï¼šå…³é”®è¯åŒ¹é…ï¼ˆé»˜è®¤ï¼Œå¿«é€Ÿï¼‰

æ£€æµ‹ä»»åŠ¡æè¿°ä¸­çš„å…³é”®è¯ï¼š
- ä¸­æ–‡ï¼š`ç»§ç»­`ã€`æ¥ç€`ã€`ç»§ç»­æ‰§è¡Œ`ã€`ç»§ç»­åš`ã€`ç»§ç»­å®Œæˆ`ç­‰
- è‹±æ–‡ï¼š`continue`ã€`resume`ã€`keep going`ã€`carry on`ç­‰

æ”¯æŒæ ‡å‡†çš„æ„å›¾æ ‡è®°æ ¼å¼ï¼š
- `æ„å›¾: ç»§ç»­æ‰§è¡Œ, ç”¨æˆ·è¾“å…¥: XXX`
- `Intent: continue, User input: XXX`

#### ç­–ç•¥2ï¼šLLMæ™ºèƒ½åˆ¤æ–­ï¼ˆå¯é€‰ï¼Œæ›´å‡†ç¡®ï¼‰

é€šè¿‡é…ç½®å¯ç”¨åï¼Œç³»ç»Ÿä¼šï¼š
1. å…ˆä½¿ç”¨å…³é”®è¯åŒ¹é…è¿›è¡Œå¿«é€Ÿåˆåˆ¤
2. ç„¶åè°ƒç”¨LLMè¿›è¡Œæ™ºèƒ½åˆ†æå’ŒäºŒæ¬¡ç¡®è®¤
3. åŸºäºé…ç½®çš„ç½®ä¿¡åº¦é˜ˆå€¼åšæœ€ç»ˆåˆ¤æ–­

**é…ç½®å‚æ•°**ï¼š
```toml
[orchestrator]
# æ˜¯å¦å¯ç”¨LLMè¿›è¡Œç»§ç»­æ‰§è¡Œæ„å›¾è¯†åˆ«
enable_llm_continue_intent_detection = false  # é»˜è®¤false

# LLMåˆ¤æ–­çš„ç½®ä¿¡åº¦é˜ˆå€¼ï¼ˆ0-100ï¼‰
continue_intent_confidence_threshold = 75.0  # é»˜è®¤75.0
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¯è¯†åˆ«éšå«çš„ç»§ç»­æ„å›¾ï¼ˆå¦‚"å®Œæˆå‰©ä½™é…ç½®"ï¼‰
- âœ… å‡å°‘è¯¯åˆ¤ï¼ˆé¿å…å°†æ— å…³ä»»åŠ¡è¯†åˆ«ä¸ºç»§ç»­æ‰§è¡Œï¼‰
- âœ… æä¾›åˆ¤æ–­ç†ç”±ï¼Œä¾¿äºè°ƒè¯•

**æƒè¡¡**ï¼š
- âš ï¸ å¢åŠ ä¸€æ¬¡LLMè°ƒç”¨ï¼ˆçº¦å¢åŠ 100-300mså»¶è¿Ÿï¼‰
- âš ï¸ ä¾èµ–LLMæœåŠ¡å¯ç”¨æ€§

### 2.2 å†å²ä¸Šä¸‹æ–‡æ„ŸçŸ¥

ç»§ç»­è§„åˆ’åŸºäºå®Œæ•´çš„å†å²æ‰§è¡Œä¸Šä¸‹æ–‡ï¼š

- **å†å²æ‰§è¡Œæ­¥éª¤**ï¼šåŒ…å«å·²æ‰§è¡Œæ­¥éª¤çš„è¯¦ç»†ä¿¡æ¯ï¼ˆå·¥å…·IDã€å‚æ•°ã€è¾“å‡ºã€çŠ¶æ€ï¼‰
- **åŸå§‹ä»»åŠ¡æè¿°**ï¼šç”¨æˆ·æœ€åˆæäº¤çš„ä»»åŠ¡ç›®æ ‡
- **ç”¨æˆ·è¡¥å……è¯´æ˜**ï¼šç”¨æˆ·åœ¨ç»§ç»­æ‰§è¡Œæ—¶çš„é¢å¤–è¯´æ˜
- **ä¸­æ–­åŸå› **ï¼ˆå¯é€‰ï¼‰ï¼šä»»åŠ¡ä¸­æ–­çš„å…·ä½“åŸå› 
- **æœªå®Œæˆä»»åŠ¡**ï¼ˆå¯é€‰ï¼‰ï¼šæ˜ç¡®å°šæœªå®Œæˆçš„ä»»åŠ¡é¡¹

### 2.3 æ™ºèƒ½è§„åˆ’ç­–ç•¥

ç»§ç»­è§„åˆ’é‡‡ç”¨ä¸“é—¨çš„æç¤ºè¯æ¨¡æ¿ï¼Œç¡®ä¿ï¼š

- **é¿å…é‡å¤æ‰§è¡Œ**ï¼šä¸é‡å¤å·²æˆåŠŸçš„å†å²æ­¥éª¤
- **æ­¥éª¤IDè¿ç»­æ€§**ï¼šæ–°æ­¥éª¤ä»å†å²æ­¥éª¤ä¹‹åç»§ç»­ç¼–å·
- **ä¾èµ–å…³ç³»æ­£ç¡®æ€§**ï¼šæ–°æ­¥éª¤å¯ä»¥å¼•ç”¨å†å²æ­¥éª¤çš„è¾“å‡º
- **ä»»åŠ¡é€»è¾‘è¿è´¯æ€§**ï¼šä¿æŒä¸å†å²æ‰§è¡Œé€»è¾‘çš„ä¸€è‡´æ€§

## 3. ä»£ç ç»“æ„ä¸æ˜ å°„

### 3.1 æ ¸å¿ƒæ¨¡å—

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|------|---------|------|
| ç»§ç»­è§„åˆ’æç¤ºè¯æ¨¡æ¿ | `src/llm/continue_planning_prompts.rs` | å®šä¹‰ç»§ç»­è§„åˆ’çš„æç¤ºè¯æ¨¡æ¿å’Œä¸Šä¸‹æ–‡ç»“æ„ |
| æ„å›¾è¯†åˆ«ä¸è§„åˆ’æµç¨‹ | `src/core/planner.rs` | å®ç°æ„å›¾æ£€æµ‹å’Œç»§ç»­è§„åˆ’çš„ä¸»æµç¨‹ |
| LLMæ¨¡å—å¯¼å‡º | `src/llm/mod.rs` | å¯¼å‡ºç»§ç»­è§„åˆ’ç›¸å…³çš„å…¬å…±æ¥å£ |

### 3.2 å…³é”®æ•°æ®ç»“æ„

#### 3.2.1 `HistoricalStep` - å†å²æ‰§è¡Œæ­¥éª¤

```rust
// æ–‡ä»¶: src/llm/continue_planning_prompts.rs
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct HistoricalStep {
    /// æ­¥éª¤åç§°
    pub step_name: String,
    /// æ­¥éª¤ID
    pub step_id: String,
    /// å·¥å…·ID
    pub tool_id: String,
    /// å·¥å…·å‚æ•°
    pub parameters: String,
    /// æ‰§è¡Œç»“æœ
    pub output: String,
    /// æ‰§è¡ŒçŠ¶æ€(æˆåŠŸ/å¤±è´¥)
    pub status: String,
    /// æ‰§è¡Œæ—¶é—´æˆ³
    pub timestamp: Option<String>,
}
```

**ç”¨é€”**ï¼šè®°å½•å•ä¸ªå†å²æ‰§è¡Œæ­¥éª¤çš„å®Œæ•´ä¿¡æ¯

#### 3.2.2 `ContinuePlanningContext` - ç»§ç»­è§„åˆ’ä¸Šä¸‹æ–‡

```rust
// æ–‡ä»¶: src/llm/continue_planning_prompts.rs
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ContinuePlanningContext {
    /// ä»»åŠ¡ç±»å‹ï¼ˆå¦‚ï¼šè‡ªåŠ¨å»ºæ¨¡ã€ä»£ç ç”Ÿæˆç­‰ï¼‰
    pub task_type: Option<String>,
    /// ç”¨æˆ·åŸå§‹ä»»åŠ¡æè¿°
    pub original_task_description: String,
    /// å†å²æ‰§è¡Œæ­¥éª¤åˆ—è¡¨
    pub historical_steps: Vec<HistoricalStep>,
    /// ä¸­æ–­åŸå› ï¼ˆå¯é€‰ï¼‰
    pub interruption_reason: Option<String>,
    /// æœªå®Œæˆä»»åŠ¡æè¿°ï¼ˆå¯é€‰ï¼‰
    pub incomplete_tasks: Option<String>,
    /// ç”¨æˆ·è¡¥å……è¯´æ˜ï¼ˆå¯é€‰ï¼‰
    pub user_continuation_note: Option<String>,
}
```

**ç”¨é€”**ï¼šå°è£…ç»§ç»­è§„åˆ’æ‰€éœ€çš„æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯

**æ ¸å¿ƒæ–¹æ³•**ï¼š
- `new()`: åˆ›å»ºæ–°çš„ä¸Šä¸‹æ–‡
- `set_interruption_reason()`: è®¾ç½®ä¸­æ–­åŸå› 
- `set_incomplete_tasks()`: è®¾ç½®æœªå®Œæˆä»»åŠ¡
- `set_user_continuation_note()`: è®¾ç½®ç”¨æˆ·è¡¥å……è¯´æ˜
- `format_historical_steps()`: æ ¼å¼åŒ–å†å²æ­¥éª¤ä¸ºæ–‡æœ¬
- `format_interruption_reason()`: æ ¼å¼åŒ–ä¸­æ–­åŸå› 
- `format_incomplete_tasks()`: æ ¼å¼åŒ–æœªå®Œæˆä»»åŠ¡
- `format_user_continuation_note()`: æ ¼å¼åŒ–ç”¨æˆ·è¡¥å……è¯´æ˜

### 3.3 æ ¸å¿ƒå‡½æ•°

#### 3.3.1 æ„å›¾è¯†åˆ«å‡½æ•°

##### `detect_continue_intent()` - æ£€æµ‹ç»§ç»­æ‰§è¡Œæ„å›¾ï¼ˆå…³é”®è¯åŒ¹é…ï¼‰

```rust
// æ–‡ä»¶: src/llm/continue_planning_prompts.rs
// è¡Œå·: çº¦ 570-610

pub fn detect_continue_intent(task_description: &str) -> bool
```

**åŠŸèƒ½**ï¼šä½¿ç”¨å…³é”®è¯åŒ¹é…æ£€æµ‹ä»»åŠ¡æè¿°æ˜¯å¦åŒ…å«"ç»§ç»­æ‰§è¡Œ"çš„æ„å›¾

**è¯†åˆ«ç­–ç•¥**ï¼š
1. æ£€æŸ¥æ„å›¾æ ‡è®°æ ¼å¼ï¼ˆ`æ„å›¾: ç»§ç»­æ‰§è¡Œ` æˆ– `Intent: continue`ï¼‰
2. æ£€æŸ¥å¸¸è§çš„ç»§ç»­æ‰§è¡Œå…³é”®è¯ï¼ˆ`ç»§ç»­`ã€`æ¥ç€`ã€`continue`ã€`resume`ç­‰ï¼‰

**è¿”å›å€¼**ï¼š
- `true`: åŒ…å«ç»§ç»­æ‰§è¡Œæ„å›¾
- `false`: ä¸åŒ…å«ç»§ç»­æ‰§è¡Œæ„å›¾

**ä½¿ç”¨ä½ç½®**ï¼š`src/core/planner.rs::detect_continue_intent_smart()` (è¡Œå·: ~80)

##### `detect_continue_intent_with_llm()` - LLMæ™ºèƒ½æ„å›¾è¯†åˆ«

```rust
// æ–‡ä»¶: src/llm/continue_planning_prompts.rs
// è¡Œå·: çº¦ 515-556

pub async fn detect_continue_intent_with_llm(
    task_description: &str,
    llm_client: &UnifiedLlmClient,
    confidence_threshold: f32,
) -> Result<bool, Box<dyn std::error::Error + Send + Sync>>
```

**åŠŸèƒ½**ï¼šä½¿ç”¨LLMè¿›è¡Œæ™ºèƒ½æ„å›¾è¯†åˆ«

**å‚æ•°**ï¼š
- `task_description`: ä»»åŠ¡æè¿°
- `llm_client`: LLMå®¢æˆ·ç«¯
- `confidence_threshold`: ç½®ä¿¡åº¦é˜ˆå€¼ï¼ˆ0-100ï¼‰

**è¿”å›å€¼**ï¼š
- `Ok(true)`: åŒ…å«ç»§ç»­æ‰§è¡Œæ„å›¾ä¸”ç½®ä¿¡åº¦>=é˜ˆå€¼
- `Ok(false)`: ä¸åŒ…å«ç»§ç»­æ‰§è¡Œæ„å›¾æˆ–ç½®ä¿¡åº¦<é˜ˆå€¼
- `Err`: LLMè°ƒç”¨å¤±è´¥

**å·¥ä½œæµç¨‹**ï¼š
1. æ„å»ºLLMæç¤ºè¯ï¼ˆä½¿ç”¨ä¸“é—¨çš„æ„å›¾è¯†åˆ«æ¨¡æ¿ï¼‰
2. è°ƒç”¨LLMè·å–åˆ¤æ–­ç»“æœï¼ˆJSONæ ¼å¼ï¼‰
3. è§£æç»“æœï¼š`{is_continue_intent, confidence, reasoning}`
4. æ ¹æ®ç½®ä¿¡åº¦é˜ˆå€¼è¿”å›æœ€ç»ˆåˆ¤æ–­

**LLMå“åº”ç¤ºä¾‹**ï¼š
```json
{
  "is_continue_intent": true,
  "confidence": 85,
  "reasoning": "ä»»åŠ¡æè¿°ä¸­åŒ…å«'å®Œæˆå‰©ä½™'ï¼Œæš—ç¤ºè¦ç»§ç»­ä¹‹å‰æœªå®Œæˆçš„å·¥ä½œ"
}
```

**ä½¿ç”¨ä½ç½®**ï¼š`src/core/planner.rs::detect_continue_intent_smart()` (è¡Œå·: ~100)

##### `detect_continue_intent_smart()` - æ™ºèƒ½æ„å›¾æ£€æµ‹ï¼ˆé…ç½®é©±åŠ¨ï¼‰

```rust
// æ–‡ä»¶: src/core/planner.rs
// è¡Œå·: 78-120

async fn detect_continue_intent_smart(&self, task_description: &str) -> bool
```

**åŠŸèƒ½**ï¼šé…ç½®é©±åŠ¨çš„æ™ºèƒ½æ„å›¾æ£€æµ‹ï¼ˆPlannerçš„å†…éƒ¨æ–¹æ³•ï¼‰

**ç­–ç•¥**ï¼š
1. å§‹ç»ˆå…ˆæ‰§è¡Œå…³é”®è¯åŒ¹é…ï¼ˆå¿«é€Ÿï¼‰
2. è¯»å–é…ç½®å†³å®šæ˜¯å¦å¯ç”¨LLMåˆ¤æ–­
3. å¦‚æœå¯ç”¨LLMï¼Œåˆ™è°ƒç”¨LLMè¿›è¡ŒäºŒæ¬¡ç¡®è®¤
4. å¤„ç†LLMè°ƒç”¨å¤±è´¥çš„æƒ…å†µï¼ˆå›é€€åˆ°å…³é”®è¯åŒ¹é…ç»“æœï¼‰

**é…ç½®ä¾èµ–**ï¼š
- `orchestrator.enable_llm_continue_intent_detection`: æ˜¯å¦å¯ç”¨LLMåˆ¤æ–­
- `orchestrator.continue_intent_confidence_threshold`: ç½®ä¿¡åº¦é˜ˆå€¼

**é”™è¯¯å¤„ç†**ï¼š
- é…ç½®åŠ è½½å¤±è´¥ï¼šå›é€€åˆ°å…³é”®è¯åŒ¹é…
- LLMè°ƒç”¨å¤±è´¥ï¼šå›é€€åˆ°å…³é”®è¯åŒ¹é…
- ç¡®ä¿ç³»ç»Ÿåœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½èƒ½è¿”å›ç»“æœ

**æ—¥å¿—è¾“å‡º**ï¼š
```
ğŸ“‹ ä½¿ç”¨å…³é”®è¯åŒ¹é…è¿›è¡Œæ„å›¾è¯†åˆ«: true
ğŸ¤– å¯ç”¨LLMæ™ºèƒ½æ„å›¾è¯†åˆ«ï¼ˆå…³é”®è¯åŒ¹é…ç»“æœ: trueï¼‰
ğŸ” LLMæ„å›¾è¯†åˆ«ç»“æœ: æ˜¯å¦ç»§ç»­=true, ç½®ä¿¡åº¦=85, ç†ç”±=åŒ…å«'å‰©ä½™'ä¸€è¯...
âš ï¸ LLMåˆ¤æ–­ç»“æœ(true)ä¸å…³é”®è¯åŒ¹é…(false)ä¸ä¸€è‡´ï¼Œé‡‡ç”¨LLMç»“æœ
```

**ä½¿ç”¨ä½ç½®**ï¼š`src/core/planner.rs::generate_plan_with_sender()` (è¡Œå·: ~386)

##### `extract_continuation_note()` - æå–ç”¨æˆ·è¡¥å……è¯´æ˜

```rust
// æ–‡ä»¶: src/llm/continue_planning_prompts.rs
// è¡Œå·: çº¦ 610-640

pub fn extract_continuation_note(task_description: &str) -> Option<String>
```

**åŠŸèƒ½**ï¼šä»ä»»åŠ¡æè¿°ä¸­æå–ç”¨æˆ·çš„è¡¥å……è¯´æ˜

**æå–ç­–ç•¥**ï¼š
- å¦‚æœä»»åŠ¡æè¿°æ ¼å¼ä¸º `"æ„å›¾: ç»§ç»­æ‰§è¡Œ, ç”¨æˆ·è¾“å…¥: XXX"`ï¼Œæå–"XXX"éƒ¨åˆ†
- å¦‚æœæ²¡æœ‰ç‰¹æ®Šæ ¼å¼ä½†æ£€æµ‹åˆ°ç»§ç»­æ„å›¾ï¼Œè¿”å›æ•´ä¸ªä»»åŠ¡æè¿°

**è¿”å›å€¼**ï¼š
- `Some(String)`: ç”¨æˆ·è¡¥å……è¯´æ˜
- `None`: æ— è¡¥å……è¯´æ˜

**ä½¿ç”¨ä½ç½®**ï¼š`src/core/planner.rs::generate_continue_plan()` (è¡Œå·: ~1413)

#### 3.3.2 è§„åˆ’æµç¨‹å‡½æ•°

##### `generate_plan_with_sender()` - ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼ˆå…¥å£ï¼‰

```rust
// æ–‡ä»¶: src/core/planner.rs
// è¡Œå·: 374-900

pub async fn generate_plan_with_sender(
    &self,
    task_description: &str,
    reflection_history: Option<&str>,
    metadata: &HashMap<String, String>,
    context: Option<&crate::grpc::orchestrator::TaskContext>,
    temp_event_sender: Option<Arc<dyn EventSender>>,
) -> Result<ExecutionPlan>
```

**åŠŸèƒ½**ï¼šç”Ÿæˆæ‰§è¡Œè®¡åˆ’çš„ä¸»å…¥å£ï¼Œé›†æˆäº†ç»§ç»­è§„åˆ’æ£€æµ‹

**å…³é”®é€»è¾‘**ï¼ˆè¡Œå·: 384-396ï¼‰ï¼š
```rust
// ğŸ” æ£€æµ‹æ˜¯å¦ä¸ºç»§ç»­è§„åˆ’æ„å›¾
let is_continue_intent = detect_continue_intent(task_description);
if is_continue_intent {
    info!("ğŸ”„ æ£€æµ‹åˆ°ç»§ç»­è§„åˆ’æ„å›¾ï¼Œå°†ä½¿ç”¨ç»§ç»­è§„åˆ’æµç¨‹");

    // ğŸ¯ è°ƒç”¨ä¸“é—¨çš„ç»§ç»­è§„åˆ’æ–¹æ³•
    return self.generate_continue_plan(
        task_description,
        metadata,
        context,
        temp_event_sender,
    ).await;
}
```

**æµç¨‹å›¾**ï¼š
```
ç”¨æˆ·ä»»åŠ¡æè¿°
    â†“
æ£€æµ‹ç»§ç»­æ„å›¾ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ generate_continue_plan()ï¼ˆç»§ç»­è§„åˆ’ï¼‰
    â””â”€ å¦ â†’ å¸¸è§„è§„åˆ’æµç¨‹
```

##### `generate_continue_plan()` - ç”Ÿæˆç»§ç»­è§„åˆ’æ‰§è¡Œè®¡åˆ’

```rust
// æ–‡ä»¶: src/core/planner.rs
// è¡Œå·: 1403-1592

pub async fn generate_continue_plan(
    &self,
    task_description: &str,
    metadata: &HashMap<String, String>,
    context: Option<&crate::grpc::orchestrator::TaskContext>,
    temp_event_sender: Option<Arc<dyn EventSender>>,
) -> Result<ExecutionPlan>
```

**åŠŸèƒ½**ï¼šä¸“é—¨å¤„ç†ç»§ç»­æ‰§è¡Œæ„å›¾çš„è§„åˆ’æµç¨‹

**æ ¸å¿ƒæ­¥éª¤**ï¼š

1. **æå–ç”¨æˆ·è¡¥å……è¯´æ˜**ï¼ˆè¡Œå·: ~1413ï¼‰
   ```rust
   let user_continuation_note = extract_continuation_note(task_description);
   ```

2. **ä»ä¸Šä¸‹æ–‡ä¸­æå–å†å²æ‰§è¡Œæ­¥éª¤**ï¼ˆè¡Œå·: ~1420ï¼‰
   ```rust
   let historical_steps = self.extract_historical_steps_from_context(context);
   ```
   - å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œè¿”å›éªŒè¯é”™è¯¯
   - è¦æ±‚ä¸Šä¸‹æ–‡ä¸­å¿…é¡»æä¾› `execution_history` å­—æ®µ

3. **æå–ä»»åŠ¡ç±»å‹**ï¼ˆè¡Œå·: ~1434ï¼‰
   ```rust
   let task_type = Self::extract_intent_from_task(task_description);
   ```

4. **æ„å»ºç»§ç»­è§„åˆ’ä¸Šä¸‹æ–‡**ï¼ˆè¡Œå·: ~1437-1446ï¼‰
   ```rust
   let mut continue_context = ContinuePlanningContext::new(
       task_type.clone(),
       task_description.to_string(),
       historical_steps,
   );

   if let Some(note) = user_continuation_note {
       continue_context.set_user_continuation_note(note);
   }
   ```

5. **æŸ¥è¯¢å¯ç”¨å·¥å…·**ï¼ˆè¡Œå·: ~1453ï¼‰
   ```rust
   let all_tools = self.query_available_tools().await?;
   ```

6. **ä¸¤é˜¶æ®µè§„åˆ’ï¼ˆå¦‚æœå¯ç”¨ï¼‰**ï¼ˆè¡Œå·: ~1456-1487ï¼‰
   - ä¸å¸¸è§„è§„åˆ’ä¸€æ ·ï¼Œæ”¯æŒå·¥å…·ç­›é€‰

7. **åŒ¹é…æ ‡å‡†ä»»åŠ¡æµç¨‹**ï¼ˆè¡Œå·: ~1493-1518ï¼‰
   - ä¸å¸¸è§„è§„åˆ’ä¸€æ ·ï¼Œæ”¯æŒå·¥ä½œæµåŒ¹é…

8. **æ„å»ºç»§ç»­è§„åˆ’æç¤ºè¯**ï¼ˆè¡Œå·: ~1543-1549ï¼‰
   ```rust
   let continue_prompt_builder = ContinuePlanningPromptBuilder::new();
   let (system_prompt, user_prompt) = continue_prompt_builder.build_continue_planning_prompt(
       &continue_context,
       &tools_info,
       metadata,
       workflow_hint.as_deref(),
   );
   ```

9. **è°ƒç”¨LLMç”Ÿæˆç»§ç»­æ‰§è¡Œè®¡åˆ’**ï¼ˆè¡Œå·: ~1575-1580ï¼‰
   ```rust
   let llm_response = self.call_llm(
       &system_prompt,
       &user_prompt,
       "ç»§ç»­è§„åˆ’",
       temp_event_sender.as_ref().or(self.event_sender.as_ref()),
   ).await?;
   ```

10. **è§£ææ‰§è¡Œè®¡åˆ’**ï¼ˆè¡Œå·: ~1583ï¼‰
    ```rust
    let plan = Self::parse_plan_response(&llm_response)?;
    ```

##### `extract_historical_steps_from_context()` - æå–å†å²æ‰§è¡Œæ­¥éª¤

```rust
// æ–‡ä»¶: src/core/planner.rs
// è¡Œå·: 1606-1646

fn extract_historical_steps_from_context(
    &self,
    context: Option<&crate::grpc::orchestrator::TaskContext>,
) -> Vec<HistoricalStep>
```

**åŠŸèƒ½**ï¼šä»TaskContextä¸­æå–å†å²æ‰§è¡Œè®°å½•

**æå–ç­–ç•¥**ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š

1. **ä» additional_info ä¸­æå–**ï¼ˆè¡Œå·: ~1614-1624ï¼‰
   ```rust
   if let Some(history_json) = ctx.additional_info.get("execution_history") {
       match serde_json::from_str::<Vec<HistoricalStep>>(history_json) {
           Ok(parsed_steps) => {
               info!("âœ… æˆåŠŸä» additional_info ä¸­è§£æ {} ä¸ªå†å²æ­¥éª¤", parsed_steps.len());
               steps = parsed_steps;
           }
           Err(e) => {
               warn!("âš ï¸ è§£æ execution_history JSON å¤±è´¥: {}", e);
           }
       }
   }
   ```

2. **ä» documents ä¸­æå–**ï¼ˆè¡Œå·: ~1627-1642ï¼‰
   ```rust
   for doc in &ctx.documents {
       if doc.name == "execution_history" || doc.doc_type.as_deref() == Some("execution_history") {
           match serde_json::from_str::<Vec<HistoricalStep>>(&doc.content) {
               Ok(parsed_steps) => {
                   info!("âœ… æˆåŠŸä» documents ä¸­è§£æ {} ä¸ªå†å²æ­¥éª¤", parsed_steps.len());
                   steps = parsed_steps;
                   break;
               }
               // ...
           }
       }
   }
   ```

**è¿”å›å€¼**ï¼š`Vec<HistoricalStep>` - å†å²æ‰§è¡Œæ­¥éª¤åˆ—è¡¨ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰

### 3.4 æç¤ºè¯æ¨¡æ¿

#### 3.4.1 ç³»ç»Ÿæç¤ºè¯

```rust
// æ–‡ä»¶: src/llm/continue_planning_prompts.rs
// è¡Œå·: çº¦ 120-230

const CONTINUE_PLANNING_SYSTEM_PROMPT: &str = r#"ä½ æ˜¯ä»»åŠ¡è§„åˆ’ä¸“å®¶ï¼Œæ“…é•¿åŸºäºå†å²æ‰§è¡Œæµç¨‹ç»§ç»­è§„åˆ’ä»»åŠ¡ã€‚

ã€æ ¸å¿ƒèŒè´£ã€‘
åŸºäºç”¨æˆ·çš„å†å²æ‰§è¡Œæµç¨‹ã€å½“å‰çŠ¶æ€å’Œç”¨æˆ·æ„å›¾ï¼Œç”Ÿæˆåç»­æ‰§è¡Œè®¡åˆ’ï¼Œç¡®ä¿ä»»åŠ¡çš„è¿ç»­æ€§å’Œå®Œæ•´æ€§ã€‚

ã€è´¨é‡è¦æ±‚ã€‘
- å……åˆ†ç†è§£å†å²æ‰§è¡Œä¸Šä¸‹æ–‡
- è¯†åˆ«å·²å®Œæˆçš„æ­¥éª¤å’Œæœªå®Œæˆçš„ä»»åŠ¡
- é¿å…é‡å¤æ‰§è¡Œå·²æˆåŠŸçš„æ­¥éª¤
- ä¿æŒä»»åŠ¡é€»è¾‘çš„è¿è´¯æ€§
- åˆç†åˆ©ç”¨å†å²æ­¥éª¤çš„è¾“å‡ºç»“æœ

ã€ç»§ç»­è§„åˆ’ç­–ç•¥ã€‘
1. **å·²å®Œæˆæ­¥éª¤å¤„ç†**:
   - ä¸è¦é‡å¤æ‰§è¡Œå·²æˆåŠŸçš„æ­¥éª¤
   - å¯ä»¥å¼•ç”¨å†å²æ­¥éª¤çš„è¾“å‡ºç»“æœ(ä½¿ç”¨{{history_step_id.output}}æ ¼å¼)
   - å¦‚æœå†å²æ­¥éª¤å¤±è´¥ï¼Œéœ€è¦é‡æ–°è§„åˆ’è¯¥æ­¥éª¤

2. **ä»»åŠ¡è¿ç»­æ€§**:
   - æ–°æ­¥éª¤çš„step_idåº”ä»å†å²æ­¥éª¤ä¹‹åç»§ç»­ç¼–å·
   - æ–°æ­¥éª¤çš„dependenciesåº”æ­£ç¡®å¼•ç”¨å†å²æ­¥éª¤å’Œæ–°æ­¥éª¤
   - ä¿æŒä¸å†å²æ‰§è¡Œé€»è¾‘çš„ä¸€è‡´æ€§

3. **ä¸Šä¸‹æ–‡åˆ©ç”¨**:
   - å……åˆ†åˆ©ç”¨å†å²æ­¥éª¤çš„è¾“å‡ºä½œä¸ºåç»­æ­¥éª¤çš„è¾“å…¥
   - ç†è§£åŸå§‹ä»»åŠ¡çš„æ•´ä½“ç›®æ ‡
   - æ ¹æ®ç”¨æˆ·çš„è¡¥å……è¯´æ˜è°ƒæ•´è§„åˆ’æ–¹å‘

ã€å…³é”®çº¦æŸã€‘
- æ–°æ­¥éª¤çš„step_idå¿…é¡»ä»å†å²æ­¥éª¤ä¹‹åç»§ç»­ç¼–å·
- æ­£ç¡®è®¾ç½®dependenciesï¼Œå¼•ç”¨å†å²æ­¥éª¤æ—¶ä½¿ç”¨å†å²çš„step_id
...
"#;
```

**å…³é”®è¦ç‚¹**ï¼š
- å¼ºè°ƒé¿å…é‡å¤æ‰§è¡Œå·²æˆåŠŸçš„æ­¥éª¤
- æ˜ç¡®æ–°æ­¥éª¤IDéœ€è¦ä»å†å²æ­¥éª¤ä¹‹åç»§ç»­
- æ”¯æŒå¼•ç”¨å†å²æ­¥éª¤çš„è¾“å‡º
- åŒ…å«å¹¶è¡Œæ‰§è¡Œå’ŒActionsæ ¼å¼çš„æŒ‡å¯¼

#### 3.4.2 ç”¨æˆ·æç¤ºè¯æ¨¡æ¿

```rust
// æ–‡ä»¶: src/llm/continue_planning_prompts.rs
// è¡Œå·: çº¦ 232-330

const CONTINUE_PLANNING_USER_TEMPLATE: &str = r#"
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€åŸå§‹ä»»åŠ¡æè¿°ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{original_task_description}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å†å²æ‰§è¡Œæµç¨‹ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{historical_steps}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ä¸­æ–­åŸå› ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{interruption_reason}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€æœªå®Œæˆä»»åŠ¡ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{incomplete_tasks}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ç”¨æˆ·è¡¥å……è¯´æ˜ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{user_continuation_note}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å¯ç”¨å·¥å…·åˆ—è¡¨ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{available_tools}

...

âš ï¸ é‡è¦æé†’ï¼š
1. **ä¸è¦é‡å¤æ‰§è¡Œå·²æˆåŠŸçš„å†å²æ­¥éª¤**
2. **æ–°æ­¥éª¤çš„step_idä»å†å²æ­¥éª¤ä¹‹åç»§ç»­ç¼–å·**
3. **å¯ä»¥å¼•ç”¨å†å²æ­¥éª¤çš„è¾“å‡º**
4. **ç¡®ä¿æ–°æ­¥éª¤çš„dependenciesæ­£ç¡®å¼•ç”¨å†å²æ­¥éª¤å’Œæ–°æ­¥éª¤**
...
"#;
```

**æ¨¡æ¿å˜é‡**ï¼š
- `{original_task_description}`: åŸå§‹ä»»åŠ¡æè¿°
- `{historical_steps}`: æ ¼å¼åŒ–çš„å†å²æ‰§è¡Œæ­¥éª¤
- `{interruption_reason}`: ä¸­æ–­åŸå› 
- `{incomplete_tasks}`: æœªå®Œæˆä»»åŠ¡
- `{user_continuation_note}`: ç”¨æˆ·è¡¥å……è¯´æ˜
- `{available_tools}`: å¯ç”¨å·¥å…·åˆ—è¡¨
- `{workflow_hint}`: å·¥ä½œæµæç¤º
- `{metadata}`: å…ƒæ•°æ®
- `{scene_guidance}`: åœºæ™¯ä¸“å±æŒ‡å¯¼

#### 3.4.3 `ContinuePlanningPromptBuilder` - æç¤ºè¯æ„å»ºå™¨

```rust
// æ–‡ä»¶: src/llm/continue_planning_prompts.rs
// è¡Œå·: çº¦ 360-410

pub struct ContinuePlanningPromptBuilder {
    scene_manager: SceneManager,
}

impl ContinuePlanningPromptBuilder {
    pub fn new() -> Self { ... }

    pub fn build_continue_planning_prompt(
        &self,
        context: &ContinuePlanningContext,
        available_tools: &str,
        metadata: &HashMap<String, String>,
        workflow_hint: Option<&str>,
    ) -> (String, String) { ... }

    pub fn supported_task_types(&self) -> Vec<String> { ... }
}
```

**æ ¸å¿ƒæ–¹æ³•**ï¼š
- `build_continue_planning_prompt()`: æ„å»ºç»§ç»­è§„åˆ’çš„ç³»ç»Ÿå’Œç”¨æˆ·æç¤ºè¯

## 4. ä½¿ç”¨æŒ‡å—

### 4.1 å®¢æˆ·ç«¯è°ƒç”¨ç¤ºä¾‹

#### 4.1.1 é€šè¿‡gRPCæ¥å£è°ƒç”¨

```rust
// 1. å‡†å¤‡å†å²æ‰§è¡Œè®°å½•
let execution_history = vec![
    HistoricalStep {
        step_name: "æ·»åŠ è§’è‰²".to_string(),
        step_id: "step_1".to_string(),
        tool_id: "add_role".to_string(),
        parameters: r#"{"role_name": "admin"}"#.to_string(),
        output: "è§’è‰²æ·»åŠ æˆåŠŸ".to_string(),
        status: "æˆåŠŸ".to_string(),
        timestamp: Some("2025-01-07T10:00:00Z".to_string()),
    },
    HistoricalStep {
        step_name: "é…ç½®æƒé™".to_string(),
        step_id: "step_2".to_string(),
        tool_id: "set_permissions".to_string(),
        parameters: r#"{"role": "admin", "permissions": ["read", "write"]}"#.to_string(),
        output: "æƒé™é…ç½®æˆåŠŸ".to_string(),
        status: "æˆåŠŸ".to_string(),
        timestamp: Some("2025-01-07T10:01:00Z".to_string()),
    },
];

// 2. åºåˆ—åŒ–ä¸ºJSON
let history_json = serde_json::to_string(&execution_history)?;

// 3. æ„å»ºTaskContext
let task_context = TaskContext {
    conversation_history: vec![],
    documents: vec![],
    additional_info: HashMap::from([
        ("execution_history".to_string(), history_json),
    ]),
    user_preferences: vec![],
};

// 4. æ„å»ºä»»åŠ¡æè¿°ï¼ˆåŒ…å«ç»§ç»­æ‰§è¡Œæ„å›¾ï¼‰
let task_description = "æ„å›¾: ç»§ç»­æ‰§è¡Œ, ç”¨æˆ·è¾“å…¥: ç»§ç»­æ·»åŠ æ›´å¤šæƒé™é…ç½®";

// 5. è°ƒç”¨ExecuteTaskæ¥å£
let request = ExecuteTaskRequest {
    task_description: task_description.to_string(),
    metadata: HashMap::new(),
    context: Some(task_context),
};

let response = client.execute_task(request).await?;
```

#### 4.1.2 é€šè¿‡HTTPæ¥å£è°ƒç”¨

```bash
curl -X POST http://localhost:8084/api/v1/tasks/execute \
  -H "Content-Type: application/json" \
  -d '{
    "task_description": "æ„å›¾: ç»§ç»­æ‰§è¡Œ, ç”¨æˆ·è¾“å…¥: ç»§ç»­æ·»åŠ æ›´å¤šæƒé™é…ç½®",
    "metadata": {},
    "context": {
      "conversation_history": [],
      "documents": [],
      "additional_info": {
        "execution_history": "[{\"step_name\":\"æ·»åŠ è§’è‰²\",\"step_id\":\"step_1\",\"tool_id\":\"add_role\",\"parameters\":\"{\\\"role_name\\\":\\\"admin\\\"}\",\"output\":\"è§’è‰²æ·»åŠ æˆåŠŸ\",\"status\":\"æˆåŠŸ\",\"timestamp\":\"2025-01-07T10:00:00Z\"}]"
      },
      "user_preferences": []
    }
  }'
```

### 4.2 å†å²è®°å½•æ ¼å¼è¦æ±‚

#### 4.2.1 æ–¹å¼1ï¼šé€šè¿‡ additional_info ä¼ é€’

```rust
additional_info: HashMap::from([
    ("execution_history".to_string(), history_json_string),
])
```

- **å­—æ®µå**ï¼š`execution_history`
- **æ ¼å¼**ï¼šJSONå­—ç¬¦ä¸²ï¼ŒåŒ…å« `Vec<HistoricalStep>`

#### 4.2.2 æ–¹å¼2ï¼šé€šè¿‡ documents ä¼ é€’

```rust
documents: vec![
    Document {
        name: "execution_history".to_string(),
        doc_type: Some("execution_history".to_string()),
        content: history_json_string,
        description: Some("å†å²æ‰§è¡Œè®°å½•".to_string()),
    },
]
```

- **æ–‡æ¡£å**ï¼š`execution_history`
- **æ–‡æ¡£ç±»å‹**ï¼š`execution_history`
- **å†…å®¹**ï¼šJSONå­—ç¬¦ä¸²ï¼ŒåŒ…å« `Vec<HistoricalStep>`

### 4.3 æ„å›¾è¯†åˆ«è§¦å‘æ–¹å¼

#### 4.3.1 æ–¹å¼1ï¼šä½¿ç”¨æ„å›¾æ ‡è®°ï¼ˆæ¨èï¼‰

```rust
// ä¸­æ–‡æ ¼å¼
task_description = "æ„å›¾: ç»§ç»­æ‰§è¡Œ, ç”¨æˆ·è¾“å…¥: å®Œæˆå‰©ä½™é…ç½®";

// è‹±æ–‡æ ¼å¼
task_description = "Intent: continue, User input: finish remaining configuration";
```

#### 4.3.2 æ–¹å¼2ï¼šä½¿ç”¨å…³é”®è¯

```rust
// ä¸­æ–‡å…³é”®è¯
task_description = "ç»§ç»­æ‰§è¡Œä¸Šæ¬¡çš„ä»»åŠ¡";
task_description = "æ¥ç€åš";
task_description = "ç»§ç»­å®Œæˆé…ç½®";

// è‹±æ–‡å…³é”®è¯
task_description = "continue the task";
task_description = "resume previous work";
task_description = "keep going";
```

### 4.4 é”™è¯¯å¤„ç†

#### 4.4.1 ç¼ºå°‘å†å²è®°å½•

**é”™è¯¯**ï¼š
```
ServiceError::ValidationError("ç»§ç»­è§„åˆ’éœ€è¦å†å²æ‰§è¡Œè®°å½•ï¼Œä½†åœ¨ä¸Šä¸‹æ–‡ä¸­æœªæ‰¾åˆ°ã€‚è¯·ç¡®ä¿åœ¨ TaskContext çš„ additional_info æˆ– documents ä¸­æä¾› execution_history å­—æ®µã€‚")
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿åœ¨ `TaskContext` ä¸­æä¾› `execution_history` å­—æ®µ
- ä½¿ç”¨ `additional_info` æˆ– `documents` ä¼ é€’å†å²è®°å½•
- æ£€æŸ¥JSONåºåˆ—åŒ–æ˜¯å¦æ­£ç¡®

#### 4.4.2 å†å²è®°å½•æ ¼å¼é”™è¯¯

**æ—¥å¿—è­¦å‘Š**ï¼š
```
âš ï¸ è§£æ execution_history JSON å¤±è´¥: expected value at line 1 column 1
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥JSONæ ¼å¼æ˜¯å¦æ­£ç¡®
- ç¡®ä¿ `HistoricalStep` çš„æ‰€æœ‰å¿…å¡«å­—æ®µéƒ½å­˜åœ¨
- éªŒè¯JSONå­—ç¬¦ä¸²çš„è½¬ä¹‰æ˜¯å¦æ­£ç¡®

## 5. æ‰§è¡Œæµç¨‹å›¾

### 5.1 æ•´ä½“æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·æäº¤ä»»åŠ¡ (task_description)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   generate_plan_with_sender()       â”‚
â”‚   (planner.rs:374)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ æ£€æµ‹æ„å›¾ï¼Ÿ   â”‚
        â”‚ (è¡Œå·:385)   â”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
       â”‚             â”‚
    ç»§ç»­æ„å›¾      å¸¸è§„æ„å›¾
       â”‚             â”‚
       â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ generate_    â”‚  â”‚ å¸¸è§„è§„åˆ’æµç¨‹ â”‚
â”‚ continue_    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ plan()       â”‚
â”‚ (è¡Œå·:1403)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æå–ç”¨æˆ·è¡¥å……è¯´æ˜                  â”‚
â”‚    extract_continuation_note()       â”‚
â”‚    (è¡Œå·:1413)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æå–å†å²æ‰§è¡Œæ­¥éª¤                  â”‚
â”‚    extract_historical_steps_...()    â”‚
â”‚    (è¡Œå·:1420)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
        â”‚             â”‚
   å†å²è®°å½•å­˜åœ¨  å†å²è®°å½•ä¸ºç©º
        â”‚             â”‚
        â”‚             â–¼
        â”‚      è¿”å›ValidationError
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æå–ä»»åŠ¡ç±»å‹                      â”‚
â”‚    extract_intent_from_task()        â”‚
â”‚    (è¡Œå·:1434)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ„å»ºç»§ç»­è§„åˆ’ä¸Šä¸‹æ–‡                â”‚
â”‚    ContinuePlanningContext::new()    â”‚
â”‚    (è¡Œå·:1437)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æŸ¥è¯¢å¯ç”¨å·¥å…·                      â”‚
â”‚    query_available_tools()           â”‚
â”‚    (è¡Œå·:1453)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ä¸¤é˜¶æ®µè§„åˆ’ï¼ˆå¦‚å¯ç”¨ï¼‰              â”‚
â”‚    select_relevant_tools()           â”‚
â”‚    (è¡Œå·:1461-1487)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. åŒ¹é…æ ‡å‡†ä»»åŠ¡æµç¨‹                  â”‚
â”‚    workflow_manager.match_workflow() â”‚
â”‚    (è¡Œå·:1493-1518)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. æ ¼å¼åŒ–å·¥å…·ä¿¡æ¯                    â”‚
â”‚    format_tools_for_reflection()     â”‚
â”‚    (è¡Œå·:1521)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. æ„å»ºç»§ç»­è§„åˆ’æç¤ºè¯                â”‚
â”‚    build_continue_planning_prompt()  â”‚
â”‚    (è¡Œå·:1544)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. è°ƒç”¨LLMç”Ÿæˆè®¡åˆ’                  â”‚
â”‚     call_llm()                       â”‚
â”‚     (è¡Œå·:1575)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. è§£ææ‰§è¡Œè®¡åˆ’                     â”‚
â”‚     parse_plan_response()            â”‚
â”‚     (è¡Œå·:1583)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ è¿”å›æ‰§è¡Œè®¡åˆ’  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å†å²è®°å½•æå–æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ extract_historical_steps_from_      â”‚
â”‚ context(context)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ context?  â”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
       â”‚             â”‚
      None         Some(ctx)
       â”‚             â”‚
       â–¼             â–¼
   è¿”å›ç©ºæ•°ç»„   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ ä»additional_infoæå–ï¼Ÿ â”‚
               â”‚ (è¡Œå·:1614)             â”‚
               â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
              â”‚             â”‚
           æˆåŠŸæå–      æœªæ‰¾åˆ°
              â”‚             â”‚
              â”‚             â–¼
              â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚     â”‚ ä»documentsæå–ï¼Ÿ   â”‚
              â”‚     â”‚ (è¡Œå·:1627)         â”‚
              â”‚     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚           â”‚
              â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
              â”‚    â”‚             â”‚
              â”‚  æˆåŠŸæå–      æœªæ‰¾åˆ°
              â”‚    â”‚             â”‚
              â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”
                                     â”‚
                                     â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ è¿”å›æ­¥éª¤åˆ—è¡¨ â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 6. æœ€ä½³å®è·µ

### 6.1 å†å²è®°å½•ç®¡ç†

1. **è®°å½•å®Œæ•´æ€§**ï¼šç¡®ä¿å†å²è®°å½•åŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ
   ```rust
   HistoricalStep {
       step_name: "æ˜ç¡®çš„æ­¥éª¤åç§°",
       step_id: "å”¯ä¸€çš„æ­¥éª¤ID",
       tool_id: "å·¥å…·ID",
       parameters: "å®Œæ•´çš„å‚æ•°JSON",
       output: "è¯¦ç»†çš„è¾“å‡ºä¿¡æ¯",
       status: "æˆåŠŸ/å¤±è´¥",
       timestamp: Some("ISO 8601æ ¼å¼æ—¶é—´æˆ³"),
   }
   ```

2. **çŠ¶æ€æ ‡è®°**ï¼šæ¸…æ™°æ ‡è®°æ¯ä¸ªæ­¥éª¤çš„æ‰§è¡ŒçŠ¶æ€
   - æˆåŠŸï¼š`"æˆåŠŸ"` æˆ– `"success"`
   - å¤±è´¥ï¼š`"å¤±è´¥"` æˆ– `"failed"`

3. **è¾“å‡ºä¿ç•™**ï¼šä¿ç•™æ­¥éª¤è¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤å¼•ç”¨
   - ç¡®ä¿è¾“å‡ºä¿¡æ¯è¶³å¤Ÿè¯¦ç»†
   - é¿å…è¾“å‡ºä¿¡æ¯è¿‡é•¿ï¼ˆå»ºè®®<1000å­—ç¬¦ï¼‰

### 6.2 æ„å›¾æè¿°è§„èŒƒ

1. **ä½¿ç”¨æ„å›¾æ ‡è®°æ ¼å¼**ï¼ˆæ¨èï¼‰
   ```
   æ„å›¾: ç»§ç»­æ‰§è¡Œ, ç”¨æˆ·è¾“å…¥: å®Œæˆå‰©ä½™çš„æƒé™é…ç½®
   ```

2. **è¡¥å……è¯´æ˜æ¸…æ™°**
   - æ˜ç¡®è¯´æ˜è¦ç»§ç»­å®Œæˆä»€ä¹ˆ
   - é¿å…æ¨¡ç³Šçš„æè¿°å¦‚"ç»§ç»­"

3. **ä»»åŠ¡ç›®æ ‡æ˜ç¡®**
   - è¯´æ˜ç»§ç»­æ‰§è¡Œçš„å…·ä½“ç›®æ ‡
   - æä¾›å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯

### 6.3 é”™è¯¯å¤„ç†

1. **éªŒè¯å†å²è®°å½•**
   ```rust
   if historical_steps.is_empty() {
       return Err(ServiceError::ValidationError("éœ€è¦å†å²è®°å½•".to_string()));
   }
   ```

2. **æ—¥å¿—è®°å½•**
   ```rust
   info!("ğŸ“Š æå–åˆ° {} ä¸ªå†å²æ‰§è¡Œæ­¥éª¤", historical_steps.len());
   warn!("âš ï¸ æœªæ‰¾åˆ°å†å²æ‰§è¡Œè®°å½•");
   ```

3. **å‹å¥½æç¤º**
   - åœ¨useræ¨¡å¼ä¸‹æä¾›ç”¨æˆ·å‹å¥½çš„æç¤º
   - åœ¨developeræ¨¡å¼ä¸‹æä¾›æŠ€æœ¯ç»†èŠ‚

## 7. æµ‹è¯•ç¤ºä¾‹

### 7.1 å•å…ƒæµ‹è¯•

```rust
#[test]
fn test_detect_continue_intent_with_keywords() {
    assert!(detect_continue_intent("ç»§ç»­æ‰§è¡Œä¸Šæ¬¡çš„ä»»åŠ¡"));
    assert!(detect_continue_intent("æ¥ç€åš"));
    assert!(detect_continue_intent("continue the task"));
}

#[test]
fn test_detect_continue_intent_with_intent_format() {
    assert!(detect_continue_intent("æ„å›¾: ç»§ç»­æ‰§è¡Œ, ç”¨æˆ·è¾“å…¥: å®Œæˆå‰©ä½™æ­¥éª¤"));
    assert!(detect_continue_intent("intent: continue, user input: finish remaining"));
}

#[test]
fn test_extract_continuation_note() {
    let result = extract_continuation_note("æ„å›¾: ç»§ç»­æ‰§è¡Œ, ç”¨æˆ·è¾“å…¥: å®Œæˆæ•°æ®åˆ†æ");
    assert_eq!(result, Some("å®Œæˆæ•°æ®åˆ†æ".to_string()));
}
```

### 7.2 é›†æˆæµ‹è¯•

```rust
#[tokio::test]
async fn test_continue_planning_flow() {
    // 1. å‡†å¤‡æµ‹è¯•æ•°æ®
    let historical_steps = vec![
        HistoricalStep {
            step_name: "æ­¥éª¤1".to_string(),
            step_id: "step_1".to_string(),
            tool_id: "tool_1".to_string(),
            parameters: "{}".to_string(),
            output: "æˆåŠŸ".to_string(),
            status: "æˆåŠŸ".to_string(),
            timestamp: None,
        },
    ];

    // 2. æ„å»ºä¸Šä¸‹æ–‡
    let context = ContinuePlanningContext::new(
        Some("å·¥å…·ç®¡ç†".to_string()),
        "åŸå§‹ä»»åŠ¡æè¿°".to_string(),
        historical_steps,
    );

    // 3. æ„å»ºæç¤ºè¯
    let builder = ContinuePlanningPromptBuilder::new();
    let (system, user) = builder.build_continue_planning_prompt(
        &context,
        "å·¥å…·åˆ—è¡¨",
        &HashMap::new(),
        None,
    );

    // 4. éªŒè¯
    assert!(system.contains("ç»§ç»­è§„åˆ’"));
    assert!(user.contains("åŸå§‹ä»»åŠ¡æè¿°"));
}
```

## 8. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 8.1 å†å²è®°å½•å¤§å°æ§åˆ¶

- **é™åˆ¶è®°å½•æ•°é‡**ï¼šå»ºè®®æœ€å¤šä¿ç•™æœ€è¿‘10-20æ¡å†å²è®°å½•
- **è¾“å‡ºä¿¡æ¯å‹ç¼©**ï¼šå¯¹äºè¾“å‡ºä¿¡æ¯è¾ƒé•¿çš„æ­¥éª¤ï¼Œå¯ä»¥åªä¿ç•™æ‘˜è¦
- **JSONåºåˆ—åŒ–ä¼˜åŒ–**ï¼šä½¿ç”¨é«˜æ•ˆçš„åºåˆ—åŒ–åº“

### 8.2 æç¤ºè¯ä¼˜åŒ–

- **å†å²æ­¥éª¤æ ¼å¼åŒ–**ï¼šåªåŒ…å«å¿…è¦ä¿¡æ¯ï¼Œé¿å…å†—ä½™
- **åœºæ™¯æ„ŸçŸ¥**ï¼šæ ¹æ®ä»»åŠ¡ç±»å‹ä½¿ç”¨ä¸åŒçš„è§„åˆ’ç­–ç•¥
- **å·¥å…·ç­›é€‰**ï¼šå¯ç”¨ä¸¤é˜¶æ®µè§„åˆ’ï¼Œå‡å°‘æç¤ºè¯é•¿åº¦

## 9. æ‰©å±•ä¸æœªæ¥æ”¹è¿›

### 9.1 è®¡åˆ’ä¸­çš„åŠŸèƒ½

1. **æ™ºèƒ½ä¸­æ–­åŸå› æ¨æ–­**
   - è‡ªåŠ¨åˆ†æå†å²è®°å½•ï¼Œæ¨æ–­ä¸­æ–­åŸå› 
   - åŸºäºä¸­æ–­åŸå› è°ƒæ•´ç»§ç»­è§„åˆ’ç­–ç•¥

2. **æœªå®Œæˆä»»åŠ¡è‡ªåŠ¨è¯†åˆ«**
   - å¯¹æ¯”åŸå§‹ä»»åŠ¡å’Œå†å²æ‰§è¡Œï¼Œè¯†åˆ«æœªå®Œæˆéƒ¨åˆ†
   - è‡ªåŠ¨ç”Ÿæˆæœªå®Œæˆä»»åŠ¡æ¸…å•

3. **å¤šä¼šè¯å†å²ç®¡ç†**
   - æ”¯æŒè·¨ä¼šè¯çš„å†å²è®°å½•ç®¡ç†
   - æŒä¹…åŒ–å­˜å‚¨å†å²æ‰§è¡Œæµç¨‹

### 9.2 å¯èƒ½çš„ä¼˜åŒ–æ–¹å‘

1. **å†å²è®°å½•å‹ç¼©**
   - å¯¹å†å²è®°å½•è¿›è¡Œæ™ºèƒ½å‹ç¼©
   - åªä¿ç•™å…³é”®æ­¥éª¤å’Œè¾“å‡º

2. **ç»§ç»­è§„åˆ’ç­–ç•¥ä¼˜åŒ–**
   - åŸºäºå†å²æˆåŠŸç‡è°ƒæ•´è§„åˆ’ç­–ç•¥
   - å­¦ä¹ ç”¨æˆ·çš„ç»§ç»­æ‰§è¡Œæ¨¡å¼

3. **æ›´æ™ºèƒ½çš„æ„å›¾è¯†åˆ«**
   - ä½¿ç”¨LLMè¿›è¡Œæ„å›¾è¯†åˆ«
   - æ”¯æŒæ›´å¤æ‚çš„ç»§ç»­æ‰§è¡Œåœºæ™¯

## 10. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### Q1: å¦‚ä½•ä¼ é€’å†å²æ‰§è¡Œè®°å½•ï¼Ÿ

**A**: æœ‰ä¸¤ç§æ–¹å¼ï¼š

1. é€šè¿‡ `TaskContext.additional_info`ï¼š
   ```rust
   additional_info: HashMap::from([
       ("execution_history".to_string(), history_json),
   ])
   ```

2. é€šè¿‡ `TaskContext.documents`ï¼š
   ```rust
   documents: vec![
       Document {
           name: "execution_history".to_string(),
           doc_type: Some("execution_history".to_string()),
           content: history_json,
           ...
       },
   ]
   ```

### Q2: ç»§ç»­è§„åˆ’ä¼šé‡å¤æ‰§è¡Œå·²æˆåŠŸçš„æ­¥éª¤å—ï¼Ÿ

**A**: ä¸ä¼šã€‚ç»§ç»­è§„åˆ’çš„æç¤ºè¯æ¨¡æ¿æ˜ç¡®æŒ‡ç¤ºï¼š
- ä¸è¦é‡å¤æ‰§è¡Œå·²æˆåŠŸçš„æ­¥éª¤
- æ–°æ­¥éª¤ä»å†å²æ­¥éª¤ä¹‹åç»§ç»­ç¼–å·
- å¯ä»¥å¼•ç”¨å†å²æ­¥éª¤çš„è¾“å‡º

### Q3: å¦‚æœæ²¡æœ‰æä¾›å†å²è®°å½•ä¼šæ€æ ·ï¼Ÿ

**A**: ç³»ç»Ÿä¼šè¿”å› `ValidationError`ï¼Œæç¤ºéœ€è¦æä¾›å†å²æ‰§è¡Œè®°å½•ã€‚

### Q4: ç»§ç»­è§„åˆ’æ”¯æŒå“ªäº›æ„å›¾æ ¼å¼ï¼Ÿ

**A**: æ”¯æŒä»¥ä¸‹æ ¼å¼ï¼š
1. æ„å›¾æ ‡è®°ï¼š`"æ„å›¾: ç»§ç»­æ‰§è¡Œ, ç”¨æˆ·è¾“å…¥: XXX"`
2. å…³é”®è¯ï¼š`"ç»§ç»­"`ã€`"æ¥ç€"`ã€`"continue"`ã€`"resume"`ç­‰

### Q5: å†å²è®°å½•çš„æ ¼å¼è¦æ±‚æ˜¯ä»€ä¹ˆï¼Ÿ

**A**: å¿…é¡»æ˜¯ JSON æ ¼å¼çš„ `Vec<HistoricalStep>`ï¼ŒåŒ…å«ä»¥ä¸‹å¿…å¡«å­—æ®µï¼š
- `step_name`: æ­¥éª¤åç§°
- `step_id`: æ­¥éª¤ID
- `tool_id`: å·¥å…·ID
- `parameters`: å·¥å…·å‚æ•°ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰
- `output`: æ‰§è¡Œè¾“å‡º
- `status`: æ‰§è¡ŒçŠ¶æ€ï¼ˆ"æˆåŠŸ"/"å¤±è´¥"ï¼‰

### Q6: ç»§ç»­è§„åˆ’æ˜¯å¦æ”¯æŒå¹¶è¡Œæ‰§è¡Œï¼Ÿ

**A**: æ˜¯çš„ã€‚ç»§ç»­è§„åˆ’ä½¿ç”¨ä¸å¸¸è§„è§„åˆ’ç›¸åŒçš„å¹¶è¡Œæ‰§è¡Œæœºåˆ¶ï¼ŒåŒ…æ‹¬ï¼š
- åŸºäºDAGçš„æ­¥éª¤é—´å¹¶è¡Œ
- Actionsæ ¼å¼çš„æ­¥éª¤å†…å¹¶è¡Œ

---

## 11. ğŸ†• LLMæ™ºèƒ½è§„åˆ’ç­–ç•¥åˆ¤æ–­ï¼ˆv2.0æ–°å¢ï¼‰

### 11.1 åŠŸèƒ½æ¦‚è¿°

ä» **v2.0** å¼€å§‹ï¼Œç³»ç»Ÿå°†æ„å›¾è¯†åˆ«å‡çº§ä¸º **LLMæ™ºèƒ½è§„åˆ’ç­–ç•¥åˆ¤æ–­**ï¼Œä¸ä»…èƒ½åˆ¤æ–­æ˜¯å¦ç»§ç»­æ‰§è¡Œï¼Œè¿˜èƒ½æ™ºèƒ½åŒºåˆ†ä¸‰ç§è§„åˆ’ç­–ç•¥ï¼š

1. **ç»§ç»­è§„åˆ’ (ContinuePlanning)** - åŸºäºç°æœ‰æ‰§è¡Œå†å²ç»§ç»­å®Œæˆå‰©ä½™æ­¥éª¤
2. **é‡æ–°è§„åˆ’ (Replanning)** - å› å¤±è´¥æˆ–éœ€è¦è°ƒæ•´è€Œé‡æ–°åˆ¶å®šè®¡åˆ’
3. **æ™®é€šè§„åˆ’ (NormalPlanning)** - å…¨æ–°ä»»åŠ¡çš„å¸¸è§„è§„åˆ’

### 11.2 æ ¸å¿ƒä¼˜åŠ¿

#### ç›¸æ¯”å…³é”®è¯åŒ¹é…çš„ä¼˜åŠ¿

| ç»´åº¦ | å…³é”®è¯åŒ¹é… (v1.0) | LLMæ™ºèƒ½åˆ¤æ–­ (v2.0) |
|------|------------------|-------------------|
| **å‡†ç¡®æ€§** | ä»…è¯†åˆ«å›ºå®šå…³é”®è¯ | ç†è§£è‡ªç„¶è¯­è¨€å’Œéšå«æ„å›¾ |
| **çµæ´»æ€§** | ä¾èµ–é¢„å®šä¹‰è¯è¡¨ | æ”¯æŒä»»æ„è¡¨è¾¾æ–¹å¼ |
| **åŒºåˆ†èƒ½åŠ›** | åªèƒ½åˆ¤æ–­æ˜¯/å¦ | åŒºåˆ†ä¸‰ç§ç­–ç•¥ |
| **ç½®ä¿¡åº¦** | æ—  | æä¾› 0-100 è¯„åˆ† + ç†ç”± |
| **é™çº§æ–¹æ¡ˆ** | - | LLMå¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°å…³é”®è¯ |

#### å…¸å‹åœºæ™¯ç¤ºä¾‹

```
è¾“å…¥ï¼š"ç»§ç»­æ‰§è¡Œä¸Šæ¬¡çš„ä»»åŠ¡"
â†’ ç­–ç•¥ï¼šContinuePlanning, ç½®ä¿¡åº¦ï¼š95
â†’ ç†ç”±ï¼šæ˜ç¡®åŒ…å«'ç»§ç»­æ‰§è¡Œ'å…³é”®è¯ï¼Œç”¨æˆ·æƒ³åœ¨ç°æœ‰åŸºç¡€ä¸Šç»§ç»­

è¾“å…¥ï¼š"ä¸Šæ¬¡å¤±è´¥äº†ï¼Œé‡æ–°è§„åˆ’ä¸€ä¸‹"
â†’ ç­–ç•¥ï¼šReplanning, ç½®ä¿¡åº¦ï¼š90
â†’ ç†ç”±ï¼šæ˜ç¡®æåˆ°'å¤±è´¥'å’Œ'é‡æ–°è§„åˆ’'ï¼Œéœ€è¦è°ƒæ•´ç­–ç•¥

è¾“å…¥ï¼š"å®Œæˆå‰©ä½™çš„æƒé™é…ç½®"
â†’ ç­–ç•¥ï¼šContinuePlanning, ç½®ä¿¡åº¦ï¼š80
â†’ ç†ç”±ï¼šåŒ…å«'å‰©ä½™'ä¸€è¯ï¼Œæš—ç¤ºè¦ç»§ç»­ä¹‹å‰æœªå®Œæˆçš„é…ç½®

è¾“å…¥ï¼š"åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·è´¦å·"
â†’ ç­–ç•¥ï¼šNormalPlanning, ç½®ä¿¡åº¦ï¼š95
â†’ ç†ç”±ï¼šå…¨æ–°çš„ç‹¬ç«‹æ“ä½œè¯·æ±‚ï¼Œä¸æ¶‰åŠç»§ç»­æˆ–é‡æ–°è§„åˆ’

è¾“å…¥ï¼š"æ¢ä¸ªæ–¹æ³•é‡æ–°ç”Ÿæˆå·¥å…·"
â†’ ç­–ç•¥ï¼šReplanning, ç½®ä¿¡åº¦ï¼š85
â†’ ç†ç”±ï¼šåŒ…å«'æ¢ä¸ªæ–¹æ³•'å’Œ'é‡æ–°'ï¼Œè¯´æ˜å¯¹ä¹‹å‰çš„æ–¹æ¡ˆä¸æ»¡æ„
```

### 11.3 ä»£ç å®ç°

#### 11.3.1 æ–°å¢æ•°æ®ç»“æ„

**æ–‡ä»¶**: `src/llm/continue_planning_prompts.rs`

```rust
/// è§„åˆ’ç­–ç•¥ç±»å‹
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]
#[serde(rename_all = "snake_case")]
pub enum PlanningStrategy {
    /// ç»§ç»­è§„åˆ’
    ContinuePlanning,
    /// é‡æ–°è§„åˆ’
    Replanning,
    /// æ™®é€šè§„åˆ’ï¼ˆå…¨æ–°ä»»åŠ¡ï¼‰
    NormalPlanning,
}

/// LLMè§„åˆ’ç­–ç•¥åˆ¤æ–­ç»“æœ
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct PlanningStrategyDetectionResult {
    /// è§„åˆ’ç­–ç•¥ç±»å‹
    pub strategy: PlanningStrategy,
    /// ç½®ä¿¡åº¦ï¼ˆ0-100ï¼‰
    pub confidence: f32,
    /// åˆ¤æ–­ç†ç”±
    pub reasoning: String,
}
```

#### 11.3.2 LLMåˆ¤æ–­å‡½æ•°

**æ–‡ä»¶**: `src/llm/continue_planning_prompts.rs:495-536`

```rust
/// ä½¿ç”¨LLMåˆ¤æ–­åº”è¯¥ä½¿ç”¨å“ªç§è§„åˆ’ç­–ç•¥
pub async fn detect_planning_strategy_with_llm(
    task_description: &str,
    llm_client: &UnifiedLlmClient,
    confidence_threshold: f32,
) -> Result<PlanningStrategyDetectionResult, Box<dyn std::error::Error + Send + Sync>> {
    // æ„å»ºæç¤ºè¯
    let user_prompt = PLANNING_STRATEGY_DETECTION_USER_TEMPLATE
        .replace("{task_description}", task_description);

    // è°ƒç”¨LLM
    let response = llm_client
        .call(PLANNING_STRATEGY_DETECTION_SYSTEM_PROMPT, &user_prompt, None)
        .await?;

    // è§£æJSONå“åº”
    let result: PlanningStrategyDetectionResult = serde_json::from_str(&response)?;

    info!(
        "ğŸ¯ LLMè§„åˆ’ç­–ç•¥åˆ¤æ–­ç»“æœ: ç­–ç•¥={:?}, ç½®ä¿¡åº¦={:.1}, ç†ç”±={}",
        result.strategy,
        result.confidence,
        result.reasoning
    );

    Ok(result)
}
```

#### 11.3.3 Planneré›†æˆ

**æ–‡ä»¶**: `src/core/planner.rs:481-611`

```rust
// 5. ä½¿ç”¨ LLM æ™ºèƒ½åˆ¤æ–­è§„åˆ’ç­–ç•¥
let planning_strategy = detect_planning_strategy_with_llm(
    task_description,
    &self.llm_client,
    70.0  // ç½®ä¿¡åº¦é˜ˆå€¼
)
.await
.unwrap_or_else(|err| {
    warn!("âš ï¸ LLMè§„åˆ’ç­–ç•¥åˆ¤æ–­å¤±è´¥ï¼Œå›é€€åˆ°å…³é”®è¯æ£€æµ‹: {}", err);
    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨å…³é”®è¯æ£€æµ‹
    let is_continue = detect_continue_intent(task_description);
    PlanningStrategyDetectionResult {
        strategy: if is_continue {
            PlanningStrategy::ContinuePlanning
        } else {
            PlanningStrategy::NormalPlanning
        },
        confidence: 50.0,
        reasoning: "LLMè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å…³é”®è¯åŒ¹é…ä½œä¸ºé™çº§æ–¹æ¡ˆ".to_string(),
    }
});

// 5.1 æ ¹æ®ç­–ç•¥æ„å»ºæç¤ºè¯
let (system_prompt, user_prompt) = match planning_strategy.strategy {
    PlanningStrategy::ContinuePlanning => {
        // ç»§ç»­è§„åˆ’é€»è¾‘
        /* ... */
    }
    PlanningStrategy::Replanning => {
        // é‡æ–°è§„åˆ’é€»è¾‘ï¼ˆå½“å‰å›é€€åˆ°æ™®é€šè§„åˆ’ï¼‰
        warn!("âš ï¸ LLMåˆ¤æ–­ä¸ºé‡æ–°è§„åˆ’ç­–ç•¥ï¼Œä½†å½“å‰ä¸Šä¸‹æ–‡æœªåŒ…å«å¤±è´¥ä¿¡æ¯ï¼Œå›é€€åˆ°æ™®é€šè§„åˆ’æ¨¡å¼");
        /* ... */
    }
    PlanningStrategy::NormalPlanning => {
        // æ™®é€šè§„åˆ’é€»è¾‘
        /* ... */
    }
};
```

### 11.4 LLMæç¤ºè¯è®¾è®¡

#### 11.4.1 ç³»ç»Ÿæç¤ºè¯

**æ–‡ä»¶**: `src/llm/continue_planning_prompts.rs:324-376`

```
ä½ æ˜¯ä»»åŠ¡è§„åˆ’ç­–ç•¥ä¸“å®¶ï¼Œæ ¹æ®ç”¨æˆ·çš„ä»»åŠ¡æè¿°å’Œå½“å‰ä¸Šä¸‹æ–‡ï¼Œåˆ¤æ–­åº”è¯¥ä½¿ç”¨å“ªç§è§„åˆ’ç­–ç•¥ã€‚

ã€ç­–ç•¥ç±»å‹ã€‘
1. **ç»§ç»­è§„åˆ’ (continue_planning)**: åŸºäºç°æœ‰æ‰§è¡Œå†å²ç»§ç»­å®Œæˆå‰©ä½™æ­¥éª¤
2. **é‡æ–°è§„åˆ’ (replanning)**: å› å¤±è´¥æˆ–éœ€è¦è°ƒæ•´è€Œé‡æ–°åˆ¶å®šè®¡åˆ’

ã€åˆ¤æ–­æ ‡å‡†ã€‘

âœ… **ç»§ç»­è§„åˆ’**çš„æƒ…å†µï¼š
- ç”¨æˆ·æ˜ç¡®è¦æ±‚ç»§ç»­ï¼š"ç»§ç»­"ã€"æ¥ç€åš"ã€"å®Œæˆå‰©ä½™æ­¥éª¤"
- éšå«ç»§ç»­æ„å›¾ï¼š"å®Œæˆå‰©ä½™çš„..."ã€"ç»§ç»­ä¸Šæ¬¡çš„..."
- ä»»åŠ¡å¤„äºä¸­æ–­çŠ¶æ€ï¼Œä½†ä¹‹å‰çš„æ­¥éª¤æ˜¯æˆåŠŸçš„

âœ… **é‡æ–°è§„åˆ’**çš„æƒ…å†µï¼š
- ç”¨æˆ·æ˜ç¡®è¦æ±‚é‡æ–°è§„åˆ’ï¼š"é‡æ–°è§„åˆ’"ã€"æ¢ä¸ªæ–¹æ¡ˆ"ã€"é‡åš"
- ä¸Šæ¬¡æ‰§è¡Œå¤±è´¥ï¼Œéœ€è¦è°ƒæ•´ç­–ç•¥
- å‘ç°ä¹‹å‰çš„æ–¹æ¡ˆæœ‰é—®é¢˜ï¼Œéœ€è¦é‡æ–°è®¾è®¡

ã€è¾“å‡ºæ ¼å¼ã€‘
{
  "strategy": "continue_planning" | "replanning" | "normal_planning",
  "confidence": 0-100ä¹‹é—´çš„æ•°å­—,
  "reasoning": "åˆ¤æ–­ç†ç”±"
}
```

### 11.5 æ‰§è¡Œæµç¨‹

```
ç”¨æˆ·è¾“å…¥ä»»åŠ¡æè¿°
  â†“
è°ƒç”¨ detect_planning_strategy_with_llm()
  â†“
LLMåˆ†æå¹¶è¿”å›ç­–ç•¥åˆ¤æ–­
  {
    "strategy": "continue_planning",
    "confidence": 85,
    "reasoning": "ç”¨æˆ·è¦æ±‚å®Œæˆå‰©ä½™æ­¥éª¤"
  }
  â†“
æ£€æŸ¥ç½®ä¿¡åº¦ >= é˜ˆå€¼(70.0)?
  â†“ Yes
æ ¹æ®ç­–ç•¥é€‰æ‹©å¯¹åº”çš„è§„åˆ’å™¨
  â”œâ”€ ContinuePlanning â†’ ContinuePlanningPromptBuilder
  â”œâ”€ Replanning â†’ ReplanningPromptBuilder (TODO)
  â””â”€ NormalPlanning â†’ PlanningPromptBuilder
  â†“
ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
```

### 11.6 é™çº§ç­–ç•¥

å½“LLMè°ƒç”¨å¤±è´¥æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨é™çº§ï¼š

```rust
.unwrap_or_else(|err| {
    warn!("âš ï¸ LLMè§„åˆ’ç­–ç•¥åˆ¤æ–­å¤±è´¥ï¼Œå›é€€åˆ°å…³é”®è¯æ£€æµ‹");

    // 1. ä½¿ç”¨å…³é”®è¯åŒ¹é…
    let is_continue = detect_continue_intent(task_description);

    // 2. è¿”å›é™çº§ç»“æœ
    PlanningStrategyDetectionResult {
        strategy: if is_continue {
            PlanningStrategy::ContinuePlanning
        } else {
            PlanningStrategy::NormalPlanning
        },
        confidence: 50.0,  // é™çº§æ–¹æ¡ˆç½®ä¿¡åº¦è¾ƒä½
        reasoning: "LLMè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å…³é”®è¯åŒ¹é…ä½œä¸ºé™çº§æ–¹æ¡ˆ".to_string(),
    }
})
```

### 11.7 é…ç½®å‚æ•°

è™½ç„¶å½“å‰ç‰ˆæœ¬é»˜è®¤å¯ç”¨LLMåˆ¤æ–­ï¼Œä½†å¯é€šè¿‡ä»¥ä¸‹å‚æ•°è°ƒæ•´è¡Œä¸ºï¼š

```rust
// planner.rs:485
let confidence_threshold = 70.0;  // ç½®ä¿¡åº¦é˜ˆå€¼

// æœªæ¥å¯æ‰©å±•ä¸ºé…ç½®é¡¹ï¼š
// [orchestrator.planning_strategy]
// enable_llm_detection = true
// confidence_threshold = 70.0
// fallback_to_keyword = true
```

### 11.8 æ—¥å¿—ç¤ºä¾‹

```
[INFO] ğŸ¯ è§„åˆ’ç­–ç•¥: ContinuePlanning, ç½®ä¿¡åº¦: 85.0%, ç†ç”±: ç”¨æˆ·æ˜ç¡®è¦æ±‚ç»§ç»­ä¸Šæ¬¡ä»»åŠ¡
[INFO] ğŸ”„ ä½¿ç”¨ç»§ç»­è§„åˆ’ç­–ç•¥
[INFO] ğŸ“Š ä¸Šä¸‹æ–‡ä¿¡æ¯åˆ†æï¼šå¯¹è¯å†å² 3 æ¡ã€æ–‡æ¡£ 0 ä¸ªã€é™„åŠ ä¿¡æ¯ 2 æ¡ã€ç”¨æˆ·åå¥½ 0 æ¡
```

### 11.9 æ€§èƒ½å½±å“

| æŒ‡æ ‡ | å…³é”®è¯åŒ¹é… | LLMåˆ¤æ–­ |
|------|----------|---------|
| **å“åº”æ—¶é—´** | <1ms | 100-300ms |
| **å‡†ç¡®ç‡** | ~70% | ~95% |
| **æˆæœ¬** | æ—  | çº¦0.001å…ƒ/æ¬¡ |
| **ä¾èµ–** | æ—  | LLMæœåŠ¡å¯ç”¨æ€§ |

### 11.10 æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **æ”¯æŒReplanningç­–ç•¥**
   - å½“å‰Replanningä¼šå›é€€åˆ°NormalPlanning
   - éœ€è¦ä»contextä¸­æå–å¤±è´¥ä¿¡æ¯å’Œåæ€ç»“æœ
   - é›†æˆReplanningPromptBuilder

2. **ç­–ç•¥åˆ¤æ–­ç¼“å­˜**
   - å¯¹ç›¸ä¼¼ä»»åŠ¡æè¿°ç¼“å­˜åˆ¤æ–­ç»“æœ
   - å‡å°‘é‡å¤LLMè°ƒç”¨

3. **å¤šæ¨¡å‹ç­–ç•¥**
   - ç®€å•ä»»åŠ¡ç”¨å¿«é€Ÿæ¨¡å‹
   - å¤æ‚ä»»åŠ¡ç”¨é«˜çº§æ¨¡å‹

4. **A/Bæµ‹è¯•æ¡†æ¶**
   - å¯¹æ¯”å…³é”®è¯ vs LLMåˆ¤æ–­æ•ˆæœ
   - æ”¶é›†ç”¨æˆ·åé¦ˆä¼˜åŒ–æç¤ºè¯

---

## 12. æœ€ä½³å®è·µå»ºè®®

### 12.1 ä½•æ—¶ä½¿ç”¨ç»§ç»­è§„åˆ’

**âœ… é€‚åˆä½¿ç”¨çš„åœºæ™¯**ï¼š
- å¤šæ­¥éª¤ä»»åŠ¡éœ€è¦åˆ†é˜¶æ®µæ‰§è¡Œ
- ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦ç­‰å¾…å¤–éƒ¨æ¡ä»¶
- ç”¨æˆ·éœ€è¦æŸ¥çœ‹ä¸­é—´ç»“æœåå†å†³å®šæ˜¯å¦ç»§ç»­
- ä»»åŠ¡å› ä¸´æ—¶ä¸­æ–­éœ€è¦æ¢å¤

**âŒ ä¸é€‚åˆä½¿ç”¨çš„åœºæ™¯**ï¼š
- å•æ­¥éª¤ç‹¬ç«‹ä»»åŠ¡
- ä»»åŠ¡å·²å®Œå…¨æ‰§è¡Œå¤±è´¥éœ€è¦é‡æ–°è§„åˆ’ï¼ˆåº”ä½¿ç”¨Replanningï¼‰
- å…¨æ–°çš„ä»»åŠ¡è¯·æ±‚ï¼ˆåº”ä½¿ç”¨NormalPlanningï¼‰

### 12.2 å¦‚ä½•æä¾›é«˜è´¨é‡çš„ä¸Šä¸‹æ–‡

1. **è¯¦ç»†è®°å½•æ‰§è¡Œå†å²**
   - åŒ…å«æ‰€æœ‰æ­¥éª¤çš„å®Œæ•´ä¿¡æ¯
   - è®°å½•å·¥å…·IDã€å‚æ•°ã€è¾“å‡º
   - æ ‡æ³¨æ¯ä¸ªæ­¥éª¤çš„æ‰§è¡ŒçŠ¶æ€

2. **è¡¥å……ç”¨æˆ·è¯´æ˜**
   - åœ¨ç»§ç»­æ‰§è¡Œæ—¶æ˜ç¡®æŒ‡å‡ºç»§ç»­çš„åŸå› 
   - è¯´æ˜æœŸæœ›å®Œæˆä»€ä¹ˆä»»åŠ¡
   - æä¾›å¿…è¦çš„è¡¥å……ä¿¡æ¯

3. **åˆ©ç”¨conversation_history**
   - å°†æ‰§è¡Œå†å²æ”¾å…¥å¯¹è¯å†å²ä¸­
   - ä¿æŒä¸Šä¸‹æ–‡çš„å®Œæ•´æ€§å’Œè¿è´¯æ€§

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**åˆ›å»ºæ—¥æœŸ**: 2025-01-07
**ä½œè€…**: Task Orchestration Service Team
**æœ€åæ›´æ–°**: 2025-01-15
**æ›´æ–°å†…å®¹**: æ–°å¢ç¬¬11ç«  LLMæ™ºèƒ½è§„åˆ’ç­–ç•¥åˆ¤æ–­
