# åŒæ¨¡å¼å·¥å…·ç­›é€‰é›†æˆå®ç°è¯´æ˜

> **åˆ›å»ºæ—¶é—´**: 2026-01-15
> **æœ€åæ›´æ–°**: 2026-01-15
> **å®ç°çŠ¶æ€**: âœ… å·²å®Œæ•´å®ç°å¹¶é›†æˆ
> **å…³è”æ–‡ä»¶**:
> - [src/llm/selection_prompts.rs](../../../src/llm/selection_prompts.rs) - æç¤ºè¯å®ç°
> - [src/core/planner.rs](../../../src/core/planner.rs) - å·¥å…·ç­›é€‰é€»è¾‘
> - [src/core/orchestrator.rs](../../../src/core/orchestrator.rs) - ç¼–æ’å™¨é›†æˆ

## ğŸ“‹ å·²å®Œæˆçš„å·¥ä½œ

### 1. âœ… æç¤ºè¯ç³»ç»Ÿæ‰©å±• ([selection_prompts.rs](../../../src/llm/selection_prompts.rs))

å·²æ·»åŠ ï¼š
- `ToolSelectionScenario` æšä¸¾ï¼šåŒºåˆ†é¦–æ¬¡è§„åˆ’å’Œé‡æ–°è§„åˆ’åœºæ™¯
- `ReplanningToolSelectionContext` ç»“æ„ï¼šé‡æ–°è§„åˆ’çš„ä¸Šä¸‹æ–‡
- `PreviousToolInfo` ç»“æ„ï¼šä¹‹å‰å·¥å…·çš„æ‰§è¡Œæ•ˆæœ
- `REPLANNING_TOOL_SELECTION_SYSTEM_PROMPT`ï¼šé‡æ–°è§„åˆ’å·¥å…·ç­›é€‰ç³»ç»Ÿæç¤ºè¯
- `REPLANNING_TOOL_SELECTION_USER_TEMPLATE`ï¼šé‡æ–°è§„åˆ’å·¥å…·ç­›é€‰ç”¨æˆ·æç¤ºè¯æ¨¡æ¿
- `SelectionPromptBuilder::build_replanning_tool_selection_prompt()`ï¼šæ„å»ºé‡æ–°è§„åˆ’å·¥å…·ç­›é€‰æç¤ºè¯

### 2. âœ… Planner æ–¹æ³•æ‰©å±• ([planner.rs](../../../src/core/planner.rs))

å·²æ·»åŠ ï¼š
- `Planner::select_tools_for_replanning()`ï¼šé‡æ–°è§„åˆ’æ—¶çš„å·¥å…·ç­›é€‰æ–¹æ³•
- å¯¼å…¥æ–°çš„å·¥å…·ç­›é€‰ç±»å‹ï¼ˆ`ReplanningToolSelectionContext`, `PreviousToolInfo`ï¼‰

### 3. âœ… æ¨¡å—å¯¼å‡º ([llm/mod.rs](../../../src/llm/mod.rs))

å·²å¯¼å‡ºï¼š
- `ReplanningToolSelectionContext`
- `PreviousToolInfo`

---

## ğŸš§ å¾…å®Œæˆçš„é›†æˆå·¥ä½œ

### âœ… ç®€åŒ–æ–¹æ¡ˆï¼šåˆ©ç”¨ç°æœ‰çš„ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶

**å…³é”®æ´å¯Ÿ**ï¼š
- âœ… æ‰§è¡Œå†å²å·²ç»é€šè¿‡**ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶æ„å»ºå™¨**æ”¶é›†ï¼ˆçº¦ç¬¬2916-2924è¡Œï¼‰
- âœ… ä¹‹å‰ä½¿ç”¨çš„å·¥å…·ä¿¡æ¯ä¹Ÿåœ¨ `step_results` ä¸­
- âœ… åæ€åˆ†æç»“æœå°±æ˜¯ `replanning_prompt`ï¼ˆå¤±è´¥åŸå› ï¼‰

å› æ­¤ï¼Œ**ä¸éœ€è¦é¢å¤–çš„æ•°æ®æ”¶é›†**ï¼Œåªéœ€è¦åœ¨è°ƒç”¨å·¥å…·ç­›é€‰æ—¶ä¼ é€’è¿™äº›å·²æœ‰çš„ä¿¡æ¯ï¼

### ç¬¬ä¸€æ­¥ï¼šåœ¨ Orchestrator ä¸­æ”¶é›†å·¥å…·æ‰§è¡Œä¿¡æ¯ï¼ˆç®€åŒ–ç‰ˆï¼‰

**ä½ç½®**: [orchestrator.rs](../../../src/core/orchestrator.rs) - é‡æ–°è§„åˆ’å‡†å¤‡é˜¶æ®µï¼ˆçº¦ç¬¬2916è¡Œï¼‰

**åœ¨è®¾ç½®æ‰§è¡Œå†å²ä¹‹åæ·»åŠ **ï¼š

```rust
// ğŸ” è®¾ç½®æ‰§è¡Œå†å²(ä»ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶æ„å»ºå™¨è·å–)
if let Some(builder_lock) = self.context_engineering_builders.get(task_id) {
    let builder = builder_lock.read().await;
    let execution_history = builder.format_to_file();
    replanning_context.set_execution_history(execution_history);
    info!("ğŸ“ å·²è®¾ç½®é‡æ–°è§„åˆ’çš„æ‰§è¡Œå†å²");
} else {
    warn!("âš ï¸ æœªæ‰¾åˆ°ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶æ„å»ºå™¨,æ— æ³•è®¾ç½®æ‰§è¡Œå†å²");
}

// ğŸ†• æ”¶é›†ä¹‹å‰ä½¿ç”¨çš„å·¥å…·ä¿¡æ¯ï¼ˆç”¨äºé‡æ–°è§„åˆ’å·¥å…·ç­›é€‰ï¼‰
let mut previous_tools: Vec<crate::llm::PreviousToolInfo> = Vec::new();

for result in &step_results {
    let execution_status = if result.is_success {
        "Success".to_string()
    } else {
        "Failed".to_string()
    };

    let failure_reason = if !result.is_success {
        result.error_message.clone()
    } else {
        None
    };

    let execution_summary = Some(if result.output.len() > 200 {
        format!("{}...", &result.output[..200])
    } else {
        result.output.clone()
    });

    // æŸ¥æ‰¾å·¥å…·åç§°ï¼ˆä» available_tools ä¸­ï¼‰
    let tool_name = available_tools
        .iter()
        .find(|t| t.id == result.tool_id)
        .map(|t| t.name.clone())
        .unwrap_or_else(|| result.tool_id.clone());

    previous_tools.push(crate::llm::PreviousToolInfo {
        tool_id: result.tool_id.clone(),
        tool_name,
        execution_status,
        failure_reason,
        execution_summary,
    });
}

info!(
    previous_tools_count = previous_tools.len(),
    "ğŸ”§ å·²æ”¶é›†ä¹‹å‰ä½¿ç”¨çš„ {} ä¸ªå·¥å…·çš„æ‰§è¡Œä¿¡æ¯",
    previous_tools.len()
);
```

### ç¬¬äºŒæ­¥ï¼šä¿®æ”¹ `replan_task` æ–¹æ³•è°ƒç”¨å·¥å…·ç­›é€‰ï¼ˆç®€åŒ–ç‰ˆï¼‰

**ä½ç½®**: [planner.rs](../../../src/core/planner.rs#L1732) - `replan_task` æ–¹æ³•

**å…³é”®ç®€åŒ–**ï¼š
- âœ… æ‰§è¡Œå†å²å·²ç»åœ¨ `replanning_context.execution_history` ä¸­
- âœ… åªéœ€è¦ä¼ é€’ `previous_tools`ï¼ˆä» Orchestrator ä¼ å…¥ï¼‰
- âœ… æ•´ä½“åæ€æŒ‡å¯¼å·²ç»åœ¨ `replanning_context.overall_reflection_guidance` ä¸­

**æ­¥éª¤2.1ï¼šæ‰©å±• `replan_task` æ–¹æ³•ç­¾åï¼Œæ¥æ”¶ `previous_tools`**

```rust
pub async fn replan_task(
    &self,
    original_task_description: &str,
    replanning_prompt: &str,
    metadata: HashMap<String, String>,
    temp_event_sender: Option<Arc<dyn EventSender>>,
    replanning_context: Option<ReplanningContext>,
    previous_tools: Vec<crate::llm::PreviousToolInfo>, // ğŸ†• æ–°å¢å‚æ•°
) -> Result<ExecutionPlan> {
    // ...
}
```

**æ­¥éª¤2.2ï¼šä¿®æ”¹å·¥å…·ç­›é€‰é€»è¾‘ï¼ˆç¬¬1762è¡Œï¼‰**

**å½“å‰å®ç°**ï¼š
```rust
// é˜¶æ®µ1: ç­›é€‰ç›¸å…³å·¥å…·ï¼ˆåŸºäºåŸå§‹ä»»åŠ¡æè¿°ï¼‰å¹¶è¯†åˆ«ä»»åŠ¡ç±»å‹å’Œæµç¨‹
self.select_relevant_tools(original_task_description, &all_tools, &metadata, temp_event_sender.clone()).await?
```

**ä¿®æ”¹ä¸º**ï¼š
```rust
// ğŸ†• é˜¶æ®µ1: æ ¹æ®åœºæ™¯é€‰æ‹©å·¥å…·ç­›é€‰æ–¹æ³•
let (selected_tools, task_type, workflow_id) = if let Some(ref context) = replanning_context {
    // ğŸ”„ é‡æ–°è§„åˆ’åœºæ™¯ï¼šä½¿ç”¨é‡æ–°è§„åˆ’å·¥å…·ç­›é€‰
    info!("ğŸ”„ é‡æ–°è§„åˆ’åœºæ™¯ï¼šä½¿ç”¨åŸºäºæ‰§è¡Œåé¦ˆçš„å·¥å…·ç­›é€‰");

    // ä» context ä¸­æå–æ‰§è¡Œå†å²ï¼ˆå·²æœ‰ï¼‰
    let execution_history = context.execution_history.as_deref().unwrap_or("");

    // åæ€åˆ†æç»“æœå°±æ˜¯ replanning_prompt
    let reflection_analysis = replanning_prompt;

    // æå–æ•´ä½“åæ€æŒ‡å¯¼ï¼ˆå·²æœ‰ï¼‰
    let overall_reflection_guidance = context
        .overall_reflection_guidance
        .as_ref()
        .map(|g| context.format_overall_reflection_guidance());

    self.select_tools_for_replanning(
        original_task_description,
        &all_tools,
        &metadata,
        previous_tools, // ğŸ†• ä½¿ç”¨ä¼ å…¥çš„ previous_tools
        execution_history,
        reflection_analysis,
        overall_reflection_guidance.as_deref(),
        temp_event_sender.clone(),
    ).await?
} else {
    // âœ¨ é¦–æ¬¡è§„åˆ’åœºæ™¯ï¼šä½¿ç”¨é¢„æµ‹æ€§å·¥å…·ç­›é€‰
    info!("âœ¨ é¦–æ¬¡è§„åˆ’åœºæ™¯ï¼šä½¿ç”¨åŸºäºéœ€æ±‚é¢„æµ‹çš„å·¥å…·ç­›é€‰");
    self.select_relevant_tools(
        original_task_description,
        &all_tools,
        &metadata,
        temp_event_sender.clone(),
    ).await?
};
```

### ç¬¬ä¸‰æ­¥ï¼šåœ¨ Orchestrator ä¸­è°ƒç”¨ `replan_task` æ—¶ä¼ é€’ `previous_tools`

**ä½ç½®**: [orchestrator.rs](../../../src/core/orchestrator.rs) - è°ƒç”¨ `replan_task` æ—¶ï¼ˆçº¦ç¬¬2965è¡Œï¼‰

**å½“å‰è°ƒç”¨**ï¼š
```rust
match self.planner.replan_task(
    task_description,
    &replanning_prompt,
    metadata.clone(),
    Some(event_sender.clone()),
    Some(replanning_context),
).await {
    // ...
}
```

**ä¿®æ”¹ä¸º**ï¼š
```rust
match self.planner.replan_task(
    task_description,
    &replanning_prompt,
    metadata.clone(),
    Some(event_sender.clone()),
    Some(replanning_context),
    previous_tools, // ğŸ†• ä¼ é€’ä¹‹å‰æ”¶é›†çš„å·¥å…·ä¿¡æ¯
).await {
    // ...
}
```

**å°±è¿™ä¹ˆç®€å•ï¼** ä¸éœ€è¦ä¿®æ”¹ `ReplanningContext` ç»“æ„ï¼Œå› ä¸ºï¼š
- âœ… `previous_tools` ä½œä¸ºå‚æ•°ç›´æ¥ä¼ é€’ç»™ `replan_task`
- âœ… `replan_task` å†…éƒ¨ä¼ é€’ç»™ `select_tools_for_replanning`
- âœ… ä¸æ±¡æŸ“ `ReplanningContext`ï¼ˆä¿æŒèŒè´£å•ä¸€ï¼‰

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯1ï¼šé¦–æ¬¡è§„åˆ’å·¥å…·ç­›é€‰

```bash
# æäº¤ä»»åŠ¡ï¼ŒéªŒè¯é¦–æ¬¡è§„åˆ’æ—¶çš„å·¥å…·ç­›é€‰
# é¢„æœŸï¼šä½¿ç”¨ TOOL_SELECTION_SYSTEM_PROMPTï¼ˆé¦–æ¬¡è§„åˆ’æç¤ºè¯ï¼‰
```

### æµ‹è¯•åœºæ™¯2ï¼šé‡æ–°è§„åˆ’å·¥å…·ç­›é€‰

```bash
# 1. æäº¤ä¸€ä¸ªä¼šå¤±è´¥çš„ä»»åŠ¡
# 2. è§¦å‘é‡æ–°è§„åˆ’
# 3. éªŒè¯é‡æ–°è§„åˆ’æ—¶çš„å·¥å…·ç­›é€‰

# é¢„æœŸï¼š
# - ä½¿ç”¨ REPLANNING_TOOL_SELECTION_SYSTEM_PROMPTï¼ˆé‡æ–°è§„åˆ’æç¤ºè¯ï¼‰
# - æç¤ºè¯ä¸­åŒ…å«ï¼šä¹‹å‰çš„å·¥å…·é€‰æ‹©ã€æ‰§è¡Œå†å²ã€åæ€åˆ†æ
# - LLM è¾“å‡ºåŒ…å« changes_summary å­—æ®µ
```

### éªŒè¯è¦ç‚¹

1. **æ—¥å¿—éªŒè¯**ï¼š
   - é¦–æ¬¡è§„åˆ’ï¼š`ğŸ” é˜¶æ®µ1ï¼šå¼€å§‹ç­›é€‰ç›¸å…³å·¥å…·å’Œä»»åŠ¡æµç¨‹`
   - é‡æ–°è§„åˆ’ï¼š`ğŸ”„ é‡æ–°è§„åˆ’ï¼šå¼€å§‹é‡æ–°ç­›é€‰å·¥å…·`

2. **Kafka æ—¥å¿—éªŒè¯**ï¼š
   - é¦–æ¬¡ï¼š`phase: "tool_selection"`
   - é‡æ–°è§„åˆ’ï¼š`phase: "replanning_tool_selection"`, `replanning: "true"`

3. **æç¤ºè¯éªŒè¯**ï¼š
   - é¦–æ¬¡ï¼šåŒ…å«"è¿™æ˜¯é¦–æ¬¡è§„åˆ’çš„å·¥å…·ç­›é€‰ï¼Œä½ æ²¡æœ‰æ‰§è¡Œå†å²å¯å‚è€ƒ"
   - é‡æ–°è§„åˆ’ï¼šåŒ…å«"è¿™æ˜¯é‡æ–°è§„åˆ’çš„å·¥å…·ç­›é€‰ï¼Œä½ æœ‰ä¸°å¯Œçš„æ‰§è¡Œåé¦ˆå¯å‚è€ƒ"

---

## ğŸ“Š å½±å“åˆ†æ

### ä¼˜åŠ¿

1. âœ… **æé«˜é‡æ–°è§„åˆ’æˆåŠŸç‡**ï¼šåŸºäºå¤±è´¥ç»éªŒè°ƒæ•´å·¥å…·é€‰æ‹©
2. âœ… **å……åˆ†åˆ©ç”¨åæ€ç»“æœ**ï¼šåæ€çš„æ”¹è¿›å»ºè®®ç›´æ¥ç”¨äºå·¥å…·ç­›é€‰
3. âœ… **é¿å…é‡å¤å¤±è´¥**ï¼šæ˜ç¡®è¯†åˆ«å’Œæ›¿æ¢å¤±è´¥å·¥å…·
4. âœ… **æå‡LLMå†³ç­–è´¨é‡**ï¼šæä¾›æ›´ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯

### å‘åå…¼å®¹æ€§

- âœ… ä¿æŒç°æœ‰ `select_relevant_tools` æ–¹æ³•ä¸å˜
- âœ… æ–°å¢ `select_tools_for_replanning` æ–¹æ³•ä½œä¸ºæ‰©å±•
- âœ… åœ¨ `replan_task` ä¸­é€šè¿‡æ¡ä»¶åˆ¤æ–­é€‰æ‹©ä½¿ç”¨å“ªä¸ªæ–¹æ³•
- âœ… å¦‚æœ `replanning_context` ä¸º Noneï¼Œä»ä½¿ç”¨é¦–æ¬¡è§„åˆ’çš„å·¥å…·ç­›é€‰

### æ€§èƒ½å½±å“

- **LLM è°ƒç”¨æ¬¡æ•°**ï¼šä¸å˜ï¼ˆä»ç„¶æ˜¯å·¥å…·ç­›é€‰ + è§„åˆ’ï¼‰
- **æç¤ºè¯é•¿åº¦**ï¼šå¢åŠ ï¼ˆé‡æ–°è§„åˆ’æ—¶åŒ…å«æ‰§è¡Œå†å²å’Œåæ€åˆ†æï¼‰
- **å†…å­˜å ç”¨**ï¼šè½»å¾®å¢åŠ ï¼ˆéœ€è¦ä¿å­˜ `previous_tools`ï¼‰

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [23-åŒæ¨¡å¼å·¥å…·ç­›é€‰æç¤ºè¯è®¾è®¡.md](./23-åŒæ¨¡å¼å·¥å…·ç­›é€‰æç¤ºè¯è®¾è®¡.md)
- [10-è¯­ä¹‰è·¯ç”±æœºåˆ¶ä¸åœºæ™¯æ„ŸçŸ¥æç¤ºè¯ç³»ç»Ÿè®¾è®¡æ–‡æ¡£.md](./10-è¯­ä¹‰è·¯ç”±æœºåˆ¶ä¸åœºæ™¯æ„ŸçŸ¥æç¤ºè¯ç³»ç»Ÿè®¾è®¡æ–‡æ¡£(äººä¸ºå¹²é¢„ä¸åŒæ„å›¾åœºæ™¯ä¸‹å¤§æ¨¡å‹è¡ŒåŠ¨çš„æ ¸å¿ƒæ­¦å™¨).md)
- [04-ä¸¤é˜¶æ®µè§„åˆ’æ¶æ„ä¸å®ç°.md](./4-ä¸¤é˜¶æ®µè§„åˆ’æ¶æ„ä¸å®ç°.md)

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **å·¥å…·æˆåŠŸç‡ç»Ÿè®¡**ï¼šè®°å½•æ¯ä¸ªå·¥å…·çš„å†å²æˆåŠŸç‡ï¼Œç”¨äºç­›é€‰æ—¶çš„æƒé‡è°ƒæ•´
2. **å·¥å…·æ›¿ä»£å»ºè®®**ï¼šåŸºäºå†å²æ•°æ®ï¼Œä¸ºå¤±è´¥å·¥å…·è‡ªåŠ¨æ¨èæ›¿ä»£å·¥å…·
3. **å¢é‡å·¥å…·ç­›é€‰**ï¼šä¸æ˜¯å®Œå…¨é‡æ–°ç­›é€‰ï¼Œè€Œæ˜¯åœ¨åŸæœ‰åŸºç¡€ä¸Šå¢å‡å·¥å…·
4. **å·¥å…·ç»„åˆä¼˜åŒ–**ï¼šè¯†åˆ«å“ªäº›å·¥å…·ç»„åˆæ•ˆæœæ›´å¥½
