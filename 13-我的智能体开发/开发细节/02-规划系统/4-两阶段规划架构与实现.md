# ä¸¤é˜¶æ®µè§„åˆ’æ¶æ„ä¸å®ç°

## æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ä»»åŠ¡ç¼–æ’æœåŠ¡çš„**ä¸¤é˜¶æ®µè§„åˆ’ï¼ˆTwo-Stage Planningï¼‰**æ¶æ„ï¼Œè¿™æ˜¯ä¸€ä¸ªé‡è¦çš„æ€§èƒ½ä¼˜åŒ–å’Œæ™ºèƒ½åŒ–å‡çº§ï¼Œå°†è§„åˆ’è¿‡ç¨‹åˆ†ä¸º"å·¥å…·ç­›é€‰"å’Œ"ä»»åŠ¡åˆ†è§£"ä¸¤ä¸ªé˜¶æ®µï¼Œæ˜¾è‘—æå‡äº†è§„åˆ’æ•ˆç‡å’Œå‡†ç¡®æ€§ã€‚

**æœ€åæ›´æ–°**: 2024-11-27
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**ç›¸å…³PR**: Two-Stage Planning Implementation

---

## ç›®å½•

1. [è®¾è®¡èƒŒæ™¯](#è®¾è®¡èƒŒæ™¯)
2. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
3. [æ ¸å¿ƒå®ç°](#æ ¸å¿ƒå®ç°)
4. [å·¥ä½œæµç¨‹](#å·¥ä½œæµç¨‹)
5. [å…³é”®ä»£ç ä½ç½®](#å…³é”®ä»£ç ä½ç½®)
6. [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
7. [æ€§èƒ½å¯¹æ¯”](#æ€§èƒ½å¯¹æ¯”)
8. [æµå¼æ¨é€](#æµå¼æ¨é€)
9. [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
10. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## è®¾è®¡èƒŒæ™¯

### æ—§ç‰ˆå•é˜¶æ®µè§„åˆ’çš„é—®é¢˜

åœ¨å¼•å…¥ä¸¤é˜¶æ®µè§„åˆ’ä¹‹å‰ï¼Œç³»ç»Ÿä½¿ç”¨å•é˜¶æ®µè§„åˆ’æ–¹å¼ï¼š

```
ç”¨æˆ·ä»»åŠ¡ â†’ [LLM] â†’ æ‰§è¡Œè®¡åˆ’
          â†‘
    æ‰€æœ‰å·¥å…·çš„è¯¦ç»†ä¿¡æ¯ï¼ˆ50ä¸ªå·¥å…· Ã— 500 tokens = 25,000 tokensï¼‰
```

**å­˜åœ¨çš„é—®é¢˜**ï¼š

1. **Tokenæ¶ˆè€—è¿‡å¤§**ï¼š
   - æ¯æ¬¡è§„åˆ’éƒ½è¦ä¼ é€’æ‰€æœ‰å·¥å…·çš„å®Œæ•´ä¿¡æ¯
   - 50ä¸ªå·¥å…·çº¦æ¶ˆè€— 25,000 tokens
   - æˆæœ¬é«˜ï¼Œå“åº”æ…¢

2. **ä¸Šä¸‹æ–‡æ··æ‚**ï¼š
   - LLMéœ€è¦åŒæ—¶å¤„ç†"å·¥å…·é€‰æ‹©"å’Œ"ä»»åŠ¡åˆ†è§£"ä¸¤ä¸ªä»»åŠ¡
   - å¤§é‡æ— å…³å·¥å…·ä¿¡æ¯å¹²æ‰°è§„åˆ’è´¨é‡
   - å®¹æ˜“é€‰é”™å·¥å…·æˆ–é—æ¼å…³é”®æ­¥éª¤

3. **èŒè´£æ··æ·†**ï¼š
   - ä¸€ä¸ªæç¤ºè¯æ‰¿æ‹…å¤šä¸ªèŒè´£
   - éš¾ä»¥é’ˆå¯¹æ€§ä¼˜åŒ–

### ä¸¤é˜¶æ®µè§„åˆ’çš„ä¼˜åŠ¿

```
ç”¨æˆ·ä»»åŠ¡ â†’ [é˜¶æ®µ1: å·¥å…·ç­›é€‰] â†’ ç­›é€‰åçš„å·¥å…· â†’ [é˜¶æ®µ2: ä»»åŠ¡åˆ†è§£] â†’ æ‰§è¡Œè®¡åˆ’
          â†‘                      â†“
    ç®€åŒ–å·¥å…·ä¿¡æ¯              è¯¦ç»†å·¥å…·ä¿¡æ¯
    (50 Ã— 50 = 2,500 tokens)  (12 Ã— 500 = 6,000 tokens)

    æ€»è®¡: 8,500 tokens (èŠ‚çœ 66%)
```

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š

âœ… **Tokenä¼˜åŒ–**ï¼šæ€»tokenæ¶ˆè€—å‡å°‘ 50-76%
âœ… **èŒè´£åˆ†ç¦»**ï¼šå·¥å…·ç­›é€‰å’Œä»»åŠ¡åˆ†è§£å„å¸å…¶èŒ
âœ… **è´¨é‡æå‡**ï¼šæ›´ç²¾å‡†çš„å·¥å…·é€‰æ‹©ï¼Œæ›´èšç„¦çš„ä»»åŠ¡è§„åˆ’
âœ… **çµæ´»é…ç½®**ï¼šå¯æ ¹æ®å·¥å…·æ•°é‡åŠ¨æ€å†³å®šæ˜¯å¦å¯ç”¨
âœ… **æµå¼åé¦ˆ**ï¼šå®¢æˆ·ç«¯å®æ—¶æ”¶åˆ°å·¥å…·ç­›é€‰ç»“æœ
âœ… **åœºæ™¯é€‚é…**ï¼šåˆå§‹è§„åˆ’å’Œä»»åŠ¡é‡æ–°è§„åˆ’ä½¿ç”¨ä¸¤é˜¶æ®µï¼Œå•æ­¥ä¿®å¤å¤ç”¨åŸå·¥å…·é›†
âœ… **æ ‡å‡†æµç¨‹åŒ¹é…**ï¼šåŸºäºä»»åŠ¡ç±»å‹è‡ªåŠ¨åŒ¹é…æ ‡å‡†æµç¨‹æ¨¡æ¿ï¼Œæå‡è§„åˆ’è´¨é‡å’Œä¸€è‡´æ€§

---

## æ¶æ„æ¦‚è§ˆ

### æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    A[ç”¨æˆ·æäº¤ä»»åŠ¡] --> B{å·¥å…·æ•°é‡ >= é˜ˆå€¼?}
    B -->|æ˜¯| C[ä¸¤é˜¶æ®µè§„åˆ’]
    B -->|å¦| D[å•é˜¶æ®µè§„åˆ’]

    C --> C1[é˜¶æ®µ1: å·¥å…·ç­›é€‰]
    C1 --> C2[ç®€åŒ–å·¥å…·ä¿¡æ¯ â†’ LLM]
    C2 --> C3[ç­›é€‰å·¥å…·IDåˆ—è¡¨ + ä»»åŠ¡ç±»å‹]
    C3 --> C4[ä»åŸåˆ—è¡¨æå–å®Œæ•´ä¿¡æ¯]
    C4 --> C5[æµå¼æ¨é€ç­›é€‰ç»“æœ]
    C5 --> C6[åŒ¹é…æ ‡å‡†ä»»åŠ¡æµç¨‹]
    C6 --> C7{æ‰¾åˆ°åŒ¹é…æµç¨‹?}
    C7 -->|æ˜¯| C8[é˜¶æ®µ2: ä»»åŠ¡åˆ†è§£<br/>è¯¦ç»†å·¥å…·ä¿¡æ¯ + æ ‡å‡†æµç¨‹æç¤º â†’ LLM]
    C7 -->|å¦| C9[é˜¶æ®µ2: ä»»åŠ¡åˆ†è§£<br/>è¯¦ç»†å·¥å…·ä¿¡æ¯ â†’ LLM]
    C8 --> C10[ç”Ÿæˆæ‰§è¡Œè®¡åˆ’]
    C9 --> C10

    D --> D1[ä¼ ç»Ÿè§„åˆ’æµç¨‹]
    D1 --> D2[æ‰€æœ‰å·¥å…·è¯¦ç»†ä¿¡æ¯ â†’ LLM]
    D2 --> C10

    C10 --> E[å¼€å§‹æ‰§è¡Œ]
```

### ä¸‰ç§è§„åˆ’åœºæ™¯

ç³»ç»Ÿæ”¯æŒä¸‰ç§è§„åˆ’åœºæ™¯ï¼Œ**ä¸¤é˜¶æ®µè§„åˆ’é€‚ç”¨äºå‰ä¸¤ç§**ï¼š

1. **åˆå§‹è§„åˆ’**ï¼ˆ`generate_plan`ï¼‰âœ… ä½¿ç”¨ä¸¤é˜¶æ®µè§„åˆ’
   - ç”¨æˆ·é¦–æ¬¡æäº¤ä»»åŠ¡
   - ä»£ç ä½ç½®: [planner.rs:57-132](../../src/core/planner.rs#L57-L132)

2. **ä»»åŠ¡é‡æ–°è§„åˆ’**ï¼ˆ`replan_task`ï¼‰âœ… ä½¿ç”¨ä¸¤é˜¶æ®µè§„åˆ’
   - ä»»åŠ¡æ‰§è¡Œå¤±è´¥åçš„å®Œæ•´é‡æ–°è§„åˆ’
   - ä»£ç ä½ç½®: [planner.rs:518-658](../../src/core/planner.rs#L518-L658)

3. **å•æ­¥ä¿®å¤**ï¼ˆ`replan_single_step`ï¼‰âŒ ä¸ä½¿ç”¨ä¸¤é˜¶æ®µè§„åˆ’
   - åªä¿®å¤å¤±è´¥çš„å•ä¸ªæ­¥éª¤
   - ç›´æ¥ä½¿ç”¨åŸè®¡åˆ’ä¸­å·²ç­›é€‰çš„å·¥å…·é›†
   - ä»£ç ä½ç½®: [planner.rs:661-767](../../src/core/planner.rs#L661-L767)

**è®¾è®¡è¯´æ˜**ï¼š
- å•æ­¥ä¿®å¤ä¸è¿›è¡Œå·¥å…·ç­›é€‰ï¼Œå› ä¸ºåªæ˜¯æ›¿æ¢ä¸€ä¸ªå¤±è´¥æ­¥éª¤ï¼Œåº”è¯¥å¤ç”¨åŸè®¡åˆ’ä¸­å·²ç­›é€‰å¥½çš„å·¥å…·
- åªæœ‰æ•´ä¸ªä»»åŠ¡é‡æ–°è§„åˆ’æ—¶æ‰éœ€è¦é‡æ–°ç­›é€‰å·¥å…·

---

## æ ¸å¿ƒå®ç°

### 1. Planner ç»“æ„æ‰©å±•

**æ–‡ä»¶**: `src/core/planner.rs`
**ä½ç½®**: L18-34

```rust
pub struct Planner {
    llm_client: UnifiedLlmClient,
    tool_client: UnifiedToolServiceClient,
    kafka_logger: Arc<KafkaLogger>,

    // ä¸¤é˜¶æ®µè§„åˆ’é…ç½®
    enable_two_stage_planning: bool,      // æ˜¯å¦å¯ç”¨
    two_stage_tool_threshold: usize,      // å·¥å…·æ•°é‡é˜ˆå€¼

    // äº‹ä»¶å‘é€å™¨ï¼ˆç”¨äºæµå¼æ¨é€ï¼‰
    event_sender: Option<Arc<dyn EventSender>>,

    // ä»»åŠ¡æµç¨‹ç®¡ç†å™¨ï¼ˆç”¨äºæ ‡å‡†æµç¨‹åŒ¹é…ï¼‰
    workflow_manager: Option<Arc<TaskWorkflowManager>>,
}
```

**å…³é”®å­—æ®µè¯´æ˜**ï¼š

- `enable_two_stage_planning`: å…¨å±€å¼€å…³ï¼Œé»˜è®¤ `true`
- `two_stage_tool_threshold`: å·¥å…·æ•°é‡é˜ˆå€¼ï¼Œé»˜è®¤ `10`
  - å·¥å…·æ•° >= é˜ˆå€¼æ—¶å¯ç”¨ä¸¤é˜¶æ®µè§„åˆ’
  - å·¥å…·æ•° < é˜ˆå€¼æ—¶ä½¿ç”¨å•é˜¶æ®µè§„åˆ’
- `event_sender`: ç”¨äºæµå¼æ¨é€å·¥å…·ç­›é€‰ç»“æœç»™å®¢æˆ·ç«¯
- `workflow_manager`: ä»»åŠ¡æµç¨‹ç®¡ç†å™¨ï¼Œç”¨äºåŒ¹é…æ ‡å‡†ä»»åŠ¡æµç¨‹æ¨¡æ¿

---

### 2. é˜¶æ®µ1ï¼šå·¥å…·ç­›é€‰ä¸æµç¨‹åŒ¹é…å®ç°

#### 2.1 ç­›é€‰æ–¹æ³•ï¼ˆåŒ…å«æµç¨‹ç­›é€‰ï¼‰

**æ–‡ä»¶**: `src/core/planner.rs`
**æ–¹æ³•**: `select_relevant_tools`
**ä½ç½®**: L944-1079

```rust
pub async fn select_relevant_tools(
    &self,
    task_description: &str,
    all_tools: &[ToolInfo],
    metadata: &HashMap<String, String>,
) -> Result<(Vec<ToolInfo>, String, Option<String>)> {  // ğŸ†• è¿”å›å·¥å…·åˆ—è¡¨ã€ä»»åŠ¡ç±»å‹å’Œæµç¨‹ID
    // 1. æ ¼å¼åŒ–å·¥å…·ç®€è¦ä¿¡æ¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
    let tools_summary = self.format_tools_summary(all_tools);

    // 2. æ ¼å¼åŒ–ä»»åŠ¡æµç¨‹ç®€è¦ä¿¡æ¯ï¼ˆå¦‚æœæœ‰æµç¨‹ç®¡ç†å™¨ï¼‰
    let workflows_summary = if let Some(wf_manager) = &self.workflow_manager {
        Some(wf_manager.format_workflows_summary())
    } else {
        None
    };

    // 3. æ„å»ºå·¥å…·ç­›é€‰æç¤ºè¯ï¼ˆåŒ…å«æµç¨‹åˆ—è¡¨ï¼‰
    let (system_prompt, user_prompt) = PromptBuilder::build_tool_selection_prompt(
        task_description,
        &tools_summary,
        all_tools.len(),
        metadata,
        workflows_summary.as_deref(),  // ğŸ†• ä¼ é€’æµç¨‹æ‘˜è¦
    );

    // 4. è°ƒç”¨ LLM è¿›è¡Œå·¥å…·ç­›é€‰å’Œæµç¨‹ç­›é€‰
    let llm_response = self.llm_client.call(...).await?;

    // 5. è§£æ LLM å“åº”ï¼Œå¾—åˆ°å·¥å…·IDåˆ—è¡¨ã€ä»»åŠ¡ç±»å‹å’Œæµç¨‹ID
    let (selected_tool_ids, task_type, workflow_id) = Self::parse_tool_selection_response(&llm_response)?;

    // 6. ä»åŸå§‹å·¥å…·åˆ—è¡¨ä¸­æå–å®Œæ•´çš„å·¥å…·ä¿¡æ¯
    let selected_tools: Vec<ToolInfo> = all_tools
        .iter()
        .filter(|tool| selected_tool_ids.contains(&tool.id))
        .cloned()
        .collect();

    // 7. æµå¼æ¨é€ç­›é€‰ç»“æœç»™å®¢æˆ·ç«¯
    if let Some(event_sender) = &self.event_sender {
        event_sender.send_tool_selection_completed(
            all_tools.len(),
            selected_tools.len(),
            &selected_tool_ids,
        );
    }

    Ok((selected_tools, task_type, workflow_id))  // ğŸ†• è¿”å›å·¥å…·åˆ—è¡¨ã€ä»»åŠ¡ç±»å‹å’Œæµç¨‹ID
}
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… è¿”å›å€¼ä» `(Vec<ToolInfo>, String)` æ”¹ä¸º `(Vec<ToolInfo>, String, Option<String>)`
- âœ… åŒæ—¶è¿”å›ç­›é€‰çš„å·¥å…·åˆ—è¡¨ã€è¯†åˆ«çš„ä»»åŠ¡ç±»å‹å’ŒåŒ¹é…çš„æµç¨‹ID
- âœ… **LLMè´Ÿè´£æµç¨‹åŒ¹é…**ï¼šä¸å†ä½¿ç”¨å…³é”®è¯åŒ¹é…ï¼Œè€Œæ˜¯è®©LLMæ ¹æ®è¯­ä¹‰é€‰æ‹©æœ€åŒ¹é…çš„æµç¨‹
- âœ… æµç¨‹IDç”¨äºåç»­è·å–å®Œæ•´æµç¨‹ä¿¡æ¯

---

### 3. æ ‡å‡†ä»»åŠ¡æµç¨‹åŒ¹é…å®ç°ï¼ˆLLM-Basedï¼‰

#### 3.1 ä»»åŠ¡æµç¨‹æ•°æ®ç»“æ„

**æ–‡ä»¶**: `src/workflow/mod.rs`
**ä½ç½®**: L10-38

```rust
/// ä»»åŠ¡æµç¨‹æ­¥éª¤
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct WorkflowStep {
    pub name: String,
    pub tool_id: String,
    pub description: String,
}

/// ä»»åŠ¡æµç¨‹å®šä¹‰
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct TaskWorkflow {
    pub name: String,
    pub description: String,
    pub keywords: Vec<String>,  // ä¿ç•™ç”¨äºæ–‡æ¡£è¯´æ˜ï¼Œä½†ä¸å†ç”¨äºåŒ¹é…
    pub steps: Vec<WorkflowStep>,
    pub notes: Option<String>,
    pub tool_categories: Option<Vec<String>>,
}

impl TaskWorkflow {
    /// æ ¼å¼åŒ–ä¸ºå¯è¯»æ–‡æœ¬ï¼Œç”¨äºä¼ é€’ç»™LLM
    pub fn format_for_llm(&self) -> String {
        let mut text = String::new();
        text.push_str(&format!("ã€æ ‡å‡†æµç¨‹ã€‘{}\n\n", self.name));
        text.push_str(&format!("ğŸ“ æµç¨‹æè¿°ï¼š{}\n\n", self.description));
        text.push_str("ğŸ“‹ æ ‡å‡†æ­¥éª¤ï¼ˆæŒ‰é¡ºåºï¼‰ï¼š\n");
        for (i, step) in self.steps.iter().enumerate() {
            text.push_str(&format!(
                "{}. {} â†’ {}\n   å·¥å…·: {} | è¯´æ˜: {}\n",
                i + 1, step.name, step.tool_id,
                step.tool_id, step.description
            ));
        }
        // ... æ·»åŠ æ³¨æ„äº‹é¡¹å’Œçµæ´»æ€§æé†’
        text
    }
}
```

#### 3.2 ä»»åŠ¡æµç¨‹ç®¡ç†å™¨ï¼ˆæ”¯æŒLLMç­›é€‰ï¼‰

**æ–‡ä»¶**: `src/workflow/mod.rs`
**ä½ç½®**: L81-233

```rust
pub struct TaskWorkflowManager {
    workflows: Arc<HashMap<String, TaskWorkflow>>,
}

impl TaskWorkflowManager {
    /// ä»é…ç½®æ–‡ä»¶åŠ è½½ä»»åŠ¡æµç¨‹
    pub fn from_file(config_path: &str) -> Result<Self, Box<dyn std::error::Error>> {
        let content = std::fs::read_to_string(config_path)?;
        let config: WorkflowsConfig = toml::from_str(&content)?;
        Ok(Self {
            workflows: Arc::new(config.workflows),
        })
    }

    /// ğŸ†• æ ¹æ®æµç¨‹IDè·å–æ ‡å‡†æµç¨‹ï¼ˆç”¨äºLLMç­›é€‰åè·å–å®Œæ•´ä¿¡æ¯ï¼‰
    ///
    /// # å‚æ•°
    /// - `workflow_id`: æµç¨‹IDï¼ˆç”±LLMåœ¨å·¥å…·ç­›é€‰é˜¶æ®µè¿”å›ï¼‰
    ///
    /// # è¿”å›
    /// - Some(workflow): åŒ¹é…åˆ°çš„æ ‡å‡†æµç¨‹
    /// - None: æœªæ‰¾åˆ°è¯¥æµç¨‹ID
    pub fn get_workflow(&self, workflow_id: &str) -> Option<TaskWorkflow> {
        self.workflows.get(workflow_id).cloned()
    }

    /// ğŸ†• æ ¼å¼åŒ–æ‰€æœ‰æµç¨‹ä¸ºç®€åŒ–ä¿¡æ¯ï¼ˆç”¨äºLLMç­›é€‰ï¼‰
    ///
    /// è¿”å›æ ¼å¼ï¼š
    /// ```
    /// 1. ID: load_prediction | åç§°: è´Ÿè·é¢„æµ‹ | æè¿°: è´Ÿè·é¢„æµ‹å®Œæ•´æµç¨‹...
    /// 2. ID: auto_modeling | åç§°: è‡ªåŠ¨å»ºæ¨¡ | æè¿°: è‡ªåŠ¨å»ºæ¨¡æµç¨‹...
    /// ```
    pub fn format_workflows_summary(&self) -> String {
        let mut summary = String::new();
        for (i, (id, workflow)) in self.workflows.iter().enumerate() {
            summary.push_str(&format!(
                "{}. ID: {} | åç§°: {} | æè¿°: {}\n",
                i + 1, id, workflow.name, workflow.description
            ));
        }
        summary
    }

    /// âš ï¸ å·²åºŸå¼ƒï¼šå…³é”®è¯åŒ¹é…æ–¹æ³•ï¼ˆä¿ç•™ç”¨äºå‘åå…¼å®¹ï¼‰
    ///
    /// æ–°æ¶æ„ä¸­ï¼Œæµç¨‹åŒ¹é…ç”±LLMåœ¨å·¥å…·ç­›é€‰é˜¶æ®µå®Œæˆã€‚
    /// æ­¤æ–¹æ³•ä»…ç”¨äºå‘åå…¼å®¹ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚
    #[deprecated(note = "ä½¿ç”¨ LLM-based æµç¨‹ç­›é€‰æ›¿ä»£")]
    pub fn match_workflow(
        &self,
        task_type: &str,
        task_description: &str,
    ) -> Option<TaskWorkflow> {
        // ... ä¿ç•™åŸæœ‰å…³é”®è¯åŒ¹é…é€»è¾‘
    }
}
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… **æ–°å¢ `get_workflow()`**ï¼šæ ¹æ®LLMè¿”å›çš„æµç¨‹IDè·å–å®Œæ•´æµç¨‹ä¿¡æ¯
- âœ… **æ–°å¢ `format_workflows_summary()`**ï¼šæ ¼å¼åŒ–æµç¨‹åˆ—è¡¨ä¾›LLMç­›é€‰
- âœ… **åºŸå¼ƒ `match_workflow()`**ï¼šä¸å†ä½¿ç”¨å…³é”®è¯åŒ¹é…ï¼Œæ”¹ä¸ºLLMè¯­ä¹‰åŒ¹é…
- âœ… **ä¿ç•™å‘åå…¼å®¹**ï¼šæ—§æ–¹æ³•æ ‡è®°ä¸ºdeprecatedä½†ä»å¯ä½¿ç”¨

#### 3.3 ä»»åŠ¡æµç¨‹é…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `config/task_workflows.toml`

```toml
[workflows.load_prediction]
name = "è´Ÿè·é¢„æµ‹"
description = "è´Ÿè·é¢„æµ‹å®Œæ•´æµç¨‹ï¼ŒåŒ…å«æ•°æ®å‡†å¤‡ã€é¢„å¤„ç†ã€ç‰¹å¾å·¥ç¨‹ã€æ¨¡å‹è®­ç»ƒå’Œé¢„æµ‹"
# keywords å­—æ®µä¿ç•™ç”¨äºæ–‡æ¡£è¯´æ˜ï¼Œä½†LLMç­›é€‰æ—¶ä¼šåŸºäºnameå’Œdescriptionè¿›è¡Œè¯­ä¹‰åŒ¹é…
keywords = ["è´Ÿè·é¢„æµ‹", "è´Ÿè·", "é¢„æµ‹", "load prediction", "load forecasting", "å†·è´Ÿè·"]
steps = [
    { name = "æ ¡éªŒCSVæ–‡ä»¶", tool_id = "check_csv_file", description = "æ ¡éªŒCSVæ–‡ä»¶æ ¼å¼å’Œå†…å®¹" },
    { name = "æ³¨å†Œæ•°æ®æº", tool_id = "add_datasource", description = "æ³¨å†Œæ•°æ®æºåˆ°ç³»ç»Ÿ" },
    # ... å…±12ä¸ªæ­¥éª¤
]
notes = """
âš ï¸ é‡è¦æé†’ï¼š
1. æ­¥éª¤é¡ºåºå¿…é¡»ä¸¥æ ¼éµå®ˆï¼Œå­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»
2. weather_data å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œä¸ä¾èµ–å‰é¢çš„æ•°æ®å¤„ç†æ­¥éª¤
3. æœ€ç»ˆé¢„æµ‹æ­¥éª¤éœ€è¦æ‰€æœ‰å‰ç½®æ­¥éª¤çš„è¾“å‡º
"""

[workflows.auto_modeling]
name = "è‡ªåŠ¨å»ºæ¨¡"
# ... ç±»ä¼¼ç»“æ„

[workflows.data_analysis]
name = "æ•°æ®åˆ†æ"
# ... ç±»ä¼¼ç»“æ„
```

**é…ç½®ç‰¹ç‚¹**ï¼š
- TOMLæ ¼å¼ï¼Œæ˜“äºé˜…è¯»å’Œç»´æŠ¤
- keywordså­—æ®µä¿ç•™ç”¨äºæ–‡æ¡£è¯´æ˜ï¼ˆå‘åå…¼å®¹ï¼‰
- **LLMåŸºäºnameå’Œdescriptionè¿›è¡Œè¯­ä¹‰åŒ¹é…**ï¼Œä¸å†ä¾èµ–keywords
- åŒ…å«æ­¥éª¤é¡ºåºå’Œæ³¨æ„äº‹é¡¹
- æ˜“äºæ‰©å±•æ–°çš„æ ‡å‡†æµç¨‹

**åŒ¹é…æœºåˆ¶å˜æ›´**ï¼š
- âŒ **æ—§æ–¹æ³•**ï¼šåŸºäºkeywordsçš„å…³é”®è¯åŒ¹é…è¯„åˆ†ç³»ç»Ÿ
- âœ… **æ–°æ–¹æ³•**ï¼šLLMæ ¹æ®ä»»åŠ¡æè¿°ä¸æµç¨‹çš„nameã€descriptionè¿›è¡Œè¯­ä¹‰ç†è§£å’ŒåŒ¹é…
- âœ… **ä¼˜åŠ¿**ï¼š
  - æ›´å‡†ç¡®çš„è¯­ä¹‰ç†è§£ï¼ˆå¦‚"é¢„æµ‹èƒ½è€—"å¯ä»¥åŒ¹é…åˆ°"è´Ÿè·é¢„æµ‹"ï¼‰
  - æ”¯æŒå¤šè¯­è¨€å’Œä¸åŒè¡¨è¿°æ–¹å¼
  - æ— éœ€ç»´æŠ¤å¤æ‚çš„å…³é”®è¯åˆ—è¡¨

---

### 4. é˜¶æ®µ2ï¼šä»»åŠ¡åˆ†è§£å®ç°

#### 4.1 è§„åˆ’æ–¹æ³•ï¼ˆåŸºäºLLMç­›é€‰çš„æµç¨‹ï¼‰

**æ–‡ä»¶**: `src/core/planner.rs`
**æ–¹æ³•**: `generate_plan`
**ä½ç½®**: L76-235

```rust
pub async fn generate_plan(
    &self,
    task_description: &str,
    reflection_history: Option<&str>,
    metadata: &HashMap<String, String>,
) -> Result<ExecutionPlan> {
    // 1. æŸ¥è¯¢æ‰€æœ‰å¯ç”¨å·¥å…·
    let all_tools = self.query_available_tools().await?;

    // 2. å†³å®šæ˜¯å¦ä½¿ç”¨ä¸¤é˜¶æ®µè§„åˆ’
    let should_use_two_stage = self.enable_two_stage_planning
        && all_tools.len() >= self.two_stage_tool_threshold;

    // 3. æ ¹æ®å†³ç­–é€‰æ‹©å·¥å…·é›†ï¼ŒåŒæ—¶è·å–ä»»åŠ¡ç±»å‹å’Œæµç¨‹ID
    let (available_tools, task_type, workflow_id) = if should_use_two_stage {
        info!("ğŸ”€ ä½¿ç”¨ä¸¤é˜¶æ®µè§„åˆ’æ¨¡å¼");
        // é˜¶æ®µ1: ç­›é€‰ç›¸å…³å·¥å…·ã€è¯†åˆ«ä»»åŠ¡ç±»å‹å¹¶ç”±LLMé€‰æ‹©åŒ¹é…çš„æµç¨‹
        self.select_relevant_tools(task_description, &all_tools, metadata).await?
    } else {
        info!("ğŸ“‹ ä½¿ç”¨ä¼ ç»Ÿå•é˜¶æ®µè§„åˆ’æ¨¡å¼");
        (all_tools, "é€šç”¨".to_string(), None)
    };

    // ğŸ†• 4. æ ¹æ®LLMè¿”å›çš„æµç¨‹IDè·å–å®Œæ•´æµç¨‹ä¿¡æ¯
    let workflow_hint = if let Some(ref wf_id) = workflow_id {
        if let Some(wf_manager) = &self.workflow_manager {
            match wf_manager.get_workflow(wf_id) {
                Some(workflow) => {
                    info!(
                        workflow_id = %wf_id,
                        workflow_name = %workflow.name,
                        steps_count = workflow.steps.len(),
                        "âœ… è·å–åˆ°LLMç­›é€‰çš„æ ‡å‡†ä»»åŠ¡æµç¨‹"
                    );
                    Some(workflow.format_for_llm())
                }
                None => {
                    warn!(
                        workflow_id = %wf_id,
                        "âš ï¸  LLMè¿”å›çš„æµç¨‹IDåœ¨é…ç½®ä¸­ä¸å­˜åœ¨"
                    );
                    None
                }
            }
        } else {
            None
        }
    } else {
        info!("âŒ LLMæœªç­›é€‰å‡ºåŒ¹é…çš„ä»»åŠ¡æµç¨‹ï¼Œå°†ç”±LLMè‡ªè¡Œè§„åˆ’");
        None
    };

    // 5. æ ¼å¼åŒ–å·¥å…·ä¿¡æ¯ï¼ˆè¯¦ç»†ç‰ˆï¼‰
    let tools_info = self.format_tools_info(&available_tools);

    // 6. æ„å»ºæç¤ºè¯ï¼ˆåŒ…å«å…ƒæ•°æ®å’Œæµç¨‹æç¤ºï¼‰
    let (system_prompt, user_prompt) =
        PromptBuilder::build_planning_prompt(
            task_description,
            &tools_info,
            reflection_history,
            metadata,
            workflow_hint.as_deref()  // ä¼ é€’LLMç­›é€‰çš„æµç¨‹æç¤º
        );

    // 7. è°ƒç”¨ LLM ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼ˆé˜¶æ®µ2ï¼šä»»åŠ¡åˆ†è§£ï¼‰
    info!("ğŸ“‹ é˜¶æ®µ2ï¼šè°ƒç”¨ LLM ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼ˆåŸºäº {} ä¸ªå·¥å…·ï¼‰",
          available_tools.len());
    let llm_response = self.llm_client.call(...).await?;

    // 8. è§£æä¸ºæ‰§è¡Œè®¡åˆ’
    let plan = Self::parse_plan_response(&llm_response)?;

    Ok(plan)
}
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… æ¥æ”¶LLMè¿”å›çš„workflow_idï¼ˆè€ŒéåŸºäºtask_typeåŒ¹é…ï¼‰
- âœ… ä½¿ç”¨`get_workflow()`æ ¹æ®IDç›´æ¥è·å–æµç¨‹ä¿¡æ¯
- âœ… å¦‚æœLLMè¿”å›çš„æµç¨‹IDæ— æ•ˆï¼Œä¼˜é›…é™çº§ï¼ˆå‘å‡ºè­¦å‘Šä½†ç»§ç»­æ‰§è¡Œï¼‰
- âœ… å¦‚æœLLMæœªé€‰æ‹©æµç¨‹ï¼ŒLLMå°†è‡ªè¡Œè§„åˆ’
- âœ… **æ ¸å¿ƒå˜åŒ–**ï¼šæµç¨‹é€‰æ‹©æƒå®Œå…¨äº¤ç»™LLMï¼Œä¸å†ä¾èµ–ç¡¬ç¼–ç çš„åŒ¹é…é€»è¾‘

#### 4.2 å·¥å…·ä¿¡æ¯æ ¼å¼åŒ–ï¼ˆè¯¦ç»†ç‰ˆï¼‰

**æ–‡ä»¶**: `src/core/planner.rs`
**æ–¹æ³•**: `format_tools_info`
**ä½ç½®**: L186-262

```rust
fn format_tools_info(&self, tools: &[ToolInfo]) -> String {
    let mut info = String::new();
    info.push_str("å¯ç”¨å·¥å…·è¯¦ç»†ä¿¡æ¯ï¼š\n\n");

    for (i, tool) in tools.iter().enumerate() {
        info.push_str(&format!(
            "{}. å·¥å…·ID: {}\n   åç§°: {}\n   æè¿°: {}\n   åˆ†ç±»: {}\n   æ ‡ç­¾: {}\n   èƒ½åŠ›: {}\n",
            i + 1, tool.id, tool.name, tool.description,
            tool.category, tool.tags.join(", "), tool.capabilities.join(", ")
        ));

        // åŒ…å«è¯¦ç»†çš„å‚æ•°å®šä¹‰
        if let Some(input_params) = &tool.input_params {
            info.push_str(&format!("   è¾“å…¥å‚æ•°å®šä¹‰: {}\n", input_params));
        }
        if let Some(output_params) = &tool.output_params {
            info.push_str(&format!("   è¾“å‡ºå‚æ•°å®šä¹‰: {}\n", output_params));
        }
        // ... å…¶ä»–è¯¦ç»†ä¿¡æ¯
    }
    info
}
```

**ç‰¹ç‚¹**ï¼š
- åŒ…å«å®Œæ•´çš„å·¥å…·ä¿¡æ¯
- è¾“å…¥å‚æ•°ã€è¾“å‡ºå‚æ•°ã€é”™è¯¯ç å®šä¹‰
- æ¯ä¸ªå·¥å…·çº¦ 500 tokens

#### 3.3 ä»»åŠ¡åˆ†è§£æç¤ºè¯

**æ–‡ä»¶**: `src/llm/prompts.rs`
**ä½ç½®**: L77-229

**ç³»ç»Ÿæç¤ºè¯ç‰¹ç‚¹**ï¼š
- è§’è‰²å®šä½ï¼šä»»åŠ¡è§„åˆ’ä¸“å®¶
- æ ¸å¿ƒä»»åŠ¡ï¼šåŸºäºç­›é€‰åçš„å·¥å…·è®¾è®¡æ‰§è¡Œè®¡åˆ’
- æ˜ç¡®è¯´æ˜ï¼šå·¥å…·å·²ç»è¿‡ç¬¬ä¸€é˜¶æ®µç­›é€‰

**ç”¨æˆ·æç¤ºè¯ç»“æ„**ï¼š
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ä»»åŠ¡ä¿¡æ¯ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä»»åŠ¡æè¿°ã€ä»»åŠ¡å…ƒæ•°æ®ã€å†å²åæ€

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å¯ç”¨å·¥å…·ã€‘ï¼ˆå·²ç­›é€‰ï¼Œä¸ä»»åŠ¡é«˜åº¦ç›¸å…³ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è¯¦ç»†çš„å·¥å…·ä¿¡æ¯ï¼ˆåªåŒ…å«ç­›é€‰åçš„å·¥å…·ï¼‰

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€é¢†åŸŸçŸ¥è¯†ï¼šæ ‡å‡†æµç¨‹è§„èŒƒã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è´Ÿè·é¢„æµ‹æ ‡å‡†æµç¨‹ã€è‡ªåŠ¨å»ºæ¨¡æ ‡å‡†æµç¨‹ç­‰

#### 4.3 ä»»åŠ¡åˆ†è§£æç¤ºè¯ï¼ˆåŒ…å«æµç¨‹æ³¨å…¥ï¼‰

**æ–‡ä»¶**: `src/llm/prompts.rs`
**ä½ç½®**: L77-229

**ç³»ç»Ÿæç¤ºè¯ç‰¹ç‚¹**ï¼š
- è§’è‰²å®šä½ï¼šä»»åŠ¡è§„åˆ’ä¸“å®¶
- æ ¸å¿ƒä»»åŠ¡ï¼šåŸºäºç­›é€‰åçš„å·¥å…·è®¾è®¡æ‰§è¡Œè®¡åˆ’
- æ˜ç¡®è¯´æ˜ï¼šå·¥å…·å·²ç»è¿‡ç¬¬ä¸€é˜¶æ®µç­›é€‰

**ç”¨æˆ·æç¤ºè¯ç»“æ„**ï¼š
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ä»»åŠ¡ä¿¡æ¯ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä»»åŠ¡æè¿°ã€ä»»åŠ¡å…ƒæ•°æ®ã€å†å²åæ€

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å¯ç”¨å·¥å…·ã€‘ï¼ˆå·²ç­›é€‰ï¼Œä¸ä»»åŠ¡é«˜åº¦ç›¸å…³ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è¯¦ç»†çš„å·¥å…·ä¿¡æ¯ï¼ˆåªåŒ…å«ç­›é€‰åçš„å·¥å…·ï¼‰

ğŸ†•â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ†•ã€åŒ¹é…çš„æ ‡å‡†ä»»åŠ¡æµç¨‹ã€‘ï¼ˆå¦‚æœæœ‰åŒ¹é…ï¼‰
ğŸ†•â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ†•ã€æ ‡å‡†æµç¨‹ã€‘è´Ÿè·é¢„æµ‹
ğŸ†•
ğŸ†•ğŸ“ æµç¨‹æè¿°ï¼šè´Ÿè·é¢„æµ‹å®Œæ•´æµç¨‹...
ğŸ†•
ğŸ†•ğŸ“‹ æ ‡å‡†æ­¥éª¤ï¼ˆæŒ‰é¡ºåºï¼‰ï¼š
ğŸ†•1. æ ¡éªŒCSVæ–‡ä»¶ â†’ check_csv_file
ğŸ†•   å·¥å…·: check_csv_file | è¯´æ˜: æ ¡éªŒCSVæ–‡ä»¶æ ¼å¼å’Œå†…å®¹
ğŸ†•2. æ³¨å†Œæ•°æ®æº â†’ add_datasource
ğŸ†•   ...
ğŸ†•
ğŸ†•âš ï¸ æé†’ï¼šä»¥ä¸Šæ˜¯æ ‡å‡†å‚è€ƒæµç¨‹ï¼Œä½ å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚ï¼š
ğŸ†•  â€¢ è°ƒæ•´æ­¥éª¤é¡ºåºï¼ˆå¦‚æœä¸å½±å“æ•°æ®ä¾èµ–ï¼‰
ğŸ†•  â€¢ å¢åŠ æˆ–åˆ é™¤æ­¥éª¤ï¼ˆå¦‚æœç”¨æˆ·éœ€æ±‚ç‰¹æ®Šï¼‰
ğŸ†•  â€¢ ä¿®æ”¹å‚æ•°é…ç½®ï¼ˆæ ¹æ®ç”¨æˆ·æä¾›çš„å…·ä½“ä¿¡æ¯ï¼‰
ğŸ†•  â€¢ ä½†è¯·å°½é‡éµå¾ªæ ‡å‡†æµç¨‹ï¼Œç¡®ä¿ä»»åŠ¡æ‰§è¡Œçš„ç¨³å®šæ€§

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€é¢†åŸŸçŸ¥è¯†ï¼šæ ‡å‡†æµç¨‹è§„èŒƒã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è´Ÿè·é¢„æµ‹æ ‡å‡†æµç¨‹ã€è‡ªåŠ¨å»ºæ¨¡æ ‡å‡†æµç¨‹ç­‰

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å‚æ•°é…ç½®å‚è€ƒã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å¸¸ç”¨å‚æ•°å’Œé»˜è®¤å€¼

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ä»»åŠ¡è¦æ±‚ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å…³é”®è¦æ±‚æ¸…å•
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… æ–°å¢"åŒ¹é…çš„æ ‡å‡†ä»»åŠ¡æµç¨‹"éƒ¨åˆ†ï¼ˆå¯é€‰ï¼‰
- âœ… æµç¨‹ä¿¡æ¯ç”± `workflow.format_for_llm()` åŠ¨æ€ç”Ÿæˆ
- âœ… å¼ºè°ƒçµæ´»æ€§ï¼šæ ‡å‡†æµç¨‹æ˜¯å‚è€ƒï¼Œä¸æ˜¯å¼ºåˆ¶
- âœ… å¦‚æœæœªåŒ¹é…åˆ°æµç¨‹ï¼Œè¯¥éƒ¨åˆ†ä¸æ˜¾ç¤º

**æç¤ºè¯æ„å»ºå™¨ç­¾åæ›´æ–°**ï¼š

**æ–‡ä»¶**: `src/llm/prompts.rs`
**æ–¹æ³•**: `build_planning_prompt`
**ä½ç½®**: L488-521

```rust
pub fn build_planning_prompt(
    task_description: &str,
    available_tools: &str,
    reflection_history: Option<&str>,
    metadata: &std::collections::HashMap<String, String>,
    workflow_hint: Option<&str>,  // ğŸ†• æ–°å¢å‚æ•°
) -> (String, String) {
    // æ ¼å¼åŒ–å·¥ä½œæµç¨‹æç¤º
    let workflow_str = if let Some(hint) = workflow_hint {
        format!("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nã€åŒ¹é…çš„æ ‡å‡†ä»»åŠ¡æµç¨‹ã€‘\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n{}\n", hint)
    } else {
        String::new()
    };

    let user_prompt = PLANNING_USER_TEMPLATE
        .replace("{task_description}", task_description)
        .replace("{available_tools}", available_tools)
        .replace("{reflection_history}", reflection_history.unwrap_or("æ— "))
        .replace("{metadata}", &metadata_str)
        .replace("{workflow_hint}", &workflow_str);  // ğŸ†• æ³¨å…¥æµç¨‹æç¤º

    (PLANNING_SYSTEM_PROMPT.to_string(), user_prompt)
}
```

---

### 5. é‡æ–°è§„åˆ’ä¸­çš„æµç¨‹åŒ¹é…æ”¯æŒ

#### 5.1 ä»»åŠ¡é‡æ–°è§„åˆ’ï¼ˆåŒ…å«æµç¨‹åŒ¹é…ï¼‰

**æ–‡ä»¶**: `src/core/planner.rs`
**æ–¹æ³•**: `replan_task`
**ä½ç½®**: L558-669

```rust
pub async fn replan_task(
    &self,
    replanning_prompt: &str,
    metadata: HashMap<String, String>,
) -> Result<ExecutionPlan> {
    // 1. æŸ¥è¯¢æ‰€æœ‰å¯ç”¨å·¥å…·
    let all_tools = self.query_available_tools().await?;

    // 2. å†³å®šæ˜¯å¦ä½¿ç”¨ä¸¤é˜¶æ®µè§„åˆ’ï¼ˆé‡æ–°è§„åˆ’æ—¶ä¹Ÿä½¿ç”¨ï¼‰
    let should_use_two_stage = self.enable_two_stage_planning
        && all_tools.len() >= self.two_stage_tool_threshold;

    // 3. ç­›é€‰å·¥å…·å¹¶è¯†åˆ«ä»»åŠ¡ç±»å‹
    let (available_tools, task_type) = if should_use_two_stage {
        info!("ğŸ”€ é‡æ–°è§„åˆ’ï¼šä½¿ç”¨ä¸¤é˜¶æ®µè§„åˆ’æ¨¡å¼");
        // é˜¶æ®µ1: ç­›é€‰ç›¸å…³å·¥å…·ï¼ˆåŸºäºé‡æ–°è§„åˆ’çš„ä¸Šä¸‹æ–‡ï¼‰
        self.select_relevant_tools(replanning_prompt, &all_tools, &metadata).await?
    } else {
        info!("ğŸ“‹ é‡æ–°è§„åˆ’ï¼šä½¿ç”¨ä¼ ç»Ÿå•é˜¶æ®µè§„åˆ’æ¨¡å¼");
        (all_tools, "é€šç”¨".to_string())
    };

    // ğŸ†• 4. å°è¯•åŒ¹é…æ ‡å‡†ä»»åŠ¡æµç¨‹
    let workflow_hint = if let Some(wf_manager) = &self.workflow_manager {
        info!(task_type = %task_type, "ğŸ” é‡æ–°è§„åˆ’æ—¶å°è¯•åŒ¹é…æ ‡å‡†ä»»åŠ¡æµç¨‹");
        match wf_manager.match_workflow(&task_type, replanning_prompt) {
            Some(workflow) => {
                info!(
                    workflow_name = %workflow.name,
                    steps_count = workflow.steps.len(),
                    "âœ… åŒ¹é…åˆ°æ ‡å‡†ä»»åŠ¡æµç¨‹"
                );
                Some(workflow.format_for_llm())
            }
            None => {
                info!("âŒ æœªåŒ¹é…åˆ°æ ‡å‡†ä»»åŠ¡æµç¨‹ï¼Œå°†ç”±LLMè‡ªè¡Œè§„åˆ’");
                None
            }
        }
    } else {
        None
    };

    // 5. æ ¼å¼åŒ–å·¥å…·ä¿¡æ¯å’Œå…ƒæ•°æ®
    let tools_info = self.format_tools_info(&available_tools);

    // 6. æ„å»ºé‡æ–°è§„åˆ’çš„æç¤ºè¯ï¼ˆåŒ…å«æµç¨‹æç¤ºï¼‰
    let workflow_str = if let Some(hint) = workflow_hint {
        format!("\n\nã€åŒ¹é…çš„æ ‡å‡†ä»»åŠ¡æµç¨‹ã€‘\n{}", hint)
    } else {
        String::new()
    };

    let user_prompt = format!(
        "å¯ç”¨å·¥å…·åˆ—è¡¨ï¼š\n{}\n{}\n\n\
        å½“å‰å…ƒæ•°æ®ï¼š\n{}\n\n\
        è¯·åŸºäºä¸Šè¿°å¤±è´¥åŸå› é‡æ–°è§„åˆ’ä»»åŠ¡ï¼Œè¿”å›ç¬¦åˆè¦æ±‚æ ¼å¼çš„æ–°æ‰§è¡Œè®¡åˆ’ã€‚\n\
        é‡ç‚¹ï¼š\n\
        1. ç¡®ä¿æ¯ä¸ªæ­¥éª¤çš„ step_name éƒ½æœ‰æ˜ç¡®çš„ã€æœ‰æ„ä¹‰çš„åç§°\n\
        2. æ‰€æœ‰ tool_id å¿…é¡»ä»ä¸Šè¿°å¯ç”¨å·¥å…·åˆ—è¡¨ä¸­é€‰æ‹©\n\
        3. é¿å…å¯¼è‡´å¤±è´¥çš„åŒæ ·é—®é¢˜\n\
        4. å¦‚æœæœ‰æ ‡å‡†æµç¨‹æç¤ºï¼Œå¯ä»¥å‚è€ƒä½†ä¸å¿…å®Œå…¨éµå¾ª",
        tools_info, workflow_str, metadata_str
    );

    // 7-8. è°ƒç”¨ LLM å¹¶è§£ææ–°è®¡åˆ’
    ...
}
```

**å…³é”®ç‰¹ç‚¹**ï¼š
- âœ… é‡æ–°è§„åˆ’æ—¶ä¹Ÿæ‰§è¡Œä¸¤é˜¶æ®µæµç¨‹
- âœ… æ”¯æŒæ ‡å‡†æµç¨‹åŒ¹é…
- âœ… æµç¨‹æç¤ºæ³¨å…¥åˆ°ç”¨æˆ·æç¤ºè¯
- âœ… å¼ºè°ƒçµæ´»æ€§ï¼šå¯å‚è€ƒä½†ä¸å¼ºåˆ¶

#### 5.2 å•æ­¥ä¿®å¤ï¼ˆä¸ä½¿ç”¨æµç¨‹åŒ¹é…ï¼‰
**æ–¹æ³•**: `replan_task`
**ä½ç½®**: L518-658

```rust
pub async fn replan_task(
    &self,
    replanning_prompt: &str,
    metadata: HashMap<String, String>,
) -> Result<ExecutionPlan> {
    // 1. æŸ¥è¯¢æ‰€æœ‰å¯ç”¨å·¥å…·
    let all_tools = self.query_available_tools().await?;

    // 2. å†³å®šæ˜¯å¦ä½¿ç”¨ä¸¤é˜¶æ®µè§„åˆ’ï¼ˆé‡æ–°è§„åˆ’æ—¶ä¹Ÿä½¿ç”¨ï¼‰
    let should_use_two_stage = self.enable_two_stage_planning
        && all_tools.len() >= self.two_stage_tool_threshold;

    let available_tools = if should_use_two_stage {
        info!("ğŸ”€ é‡æ–°è§„åˆ’ï¼šä½¿ç”¨ä¸¤é˜¶æ®µè§„åˆ’æ¨¡å¼");
        // é˜¶æ®µ1: ç­›é€‰ç›¸å…³å·¥å…·ï¼ˆåŸºäºé‡æ–°è§„åˆ’çš„ä¸Šä¸‹æ–‡ï¼‰
        self.select_relevant_tools(replanning_prompt, &all_tools, &metadata).await?
    } else {
        info!("ğŸ“‹ é‡æ–°è§„åˆ’ï¼šä½¿ç”¨ä¼ ç»Ÿå•é˜¶æ®µè§„åˆ’æ¨¡å¼");
        all_tools
    };

    // 3-7. åç»­æµç¨‹ä¸åˆå§‹è§„åˆ’ç›¸åŒ
    ...
}
```

#### 4.2 å•æ­¥ä¿®å¤

**æ–‡ä»¶**: `src/core/planner.rs`
**æ–¹æ³•**: `replan_single_step`
**ä½ç½®**: L661-767

```rust
pub async fn replan_single_step(
    &self,
    failed_step_id: &str,
    failed_step: &PlanStep,
    error_message: &str,
    all_tools: &[ToolInfo],
) -> Result<PlanStep> {
    info!("ğŸ”§ å¼€å§‹å•æ­¥é‡æ–°è§„åˆ’ï¼ˆä¸è¿›è¡Œå·¥å…·ç­›é€‰ï¼‰");

    // å•æ­¥ä¿®å¤ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„å·¥å…·é›†ï¼Œä¸è¿›è¡Œé‡æ–°ç­›é€‰
    // å› ä¸ºå•æ­¥ä¿®å¤åªæ˜¯æ›¿æ¢ä¸€ä¸ªå¤±è´¥çš„æ­¥éª¤ï¼Œåº”è¯¥ä½¿ç”¨åŸè®¡åˆ’ä¸­å·²ç»ç­›é€‰å¥½çš„å·¥å…·
    let available_tools = all_tools;

    // æ ¼å¼åŒ–å·¥å…·ä¿¡æ¯ï¼ˆè¯¦ç»†ç‰ˆï¼‰
    let tools_info = self.format_tools_info(available_tools);

    // æ„å»ºå•æ­¥ä¿®å¤çš„ç³»ç»Ÿæç¤ºè¯
    let system_prompt = format!(...);

    // è°ƒç”¨ LLM ç”Ÿæˆä¿®å¤åçš„æ­¥éª¤
    let llm_response = self.llm_client.call(...).await?;

    // è§£æä¿®å¤åçš„æ­¥éª¤
    let repaired_step = Self::parse_single_step_response(&llm_response, ...)?;

    Ok(repaired_step)
}
```

**å…³é”®è®¾è®¡**ï¼š
- âŒ **ä¸ä½¿ç”¨ä¸¤é˜¶æ®µè§„åˆ’**ï¼šå•æ­¥ä¿®å¤ä¸è¿›è¡Œå·¥å…·ç­›é€‰
- ğŸ“¦ **å¤ç”¨åŸå·¥å…·é›†**ï¼šç›´æ¥ä½¿ç”¨ä¼ å…¥çš„å·¥å…·é›†ï¼ˆé€šå¸¸æ˜¯åŸè®¡åˆ’ä¸­å·²ç­›é€‰çš„å·¥å…·ï¼‰
- ğŸ¯ **åªä¿®å¤å•æ­¥**ï¼šä¸“æ³¨äºæ›¿æ¢å¤±è´¥çš„æ­¥éª¤ï¼Œä¸å½±å“å…¶ä»–æ­¥éª¤
- ğŸ’¡ **è®¾è®¡ç†ç”±**ï¼šå•æ­¥ä¿®å¤æ˜¯å±€éƒ¨è°ƒæ•´ï¼Œä¸éœ€è¦é‡æ–°è¯„ä¼°æ•´ä¸ªä»»åŠ¡çš„å·¥å…·éœ€æ±‚

---

## å·¥ä½œæµç¨‹

### å®Œæ•´æµç¨‹å›¾ï¼ˆLLM-Basedæµç¨‹åŒ¹é…ï¼‰

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Orch as Orchestrator
    participant Planner as Planner
    participant WfMgr as WorkflowManager
    participant LLM as LLMæœåŠ¡
    participant Client as å®¢æˆ·ç«¯(gRPCæµ)

    User->>Orch: æäº¤ä»»åŠ¡
    Orch->>Planner: generate_plan()

    Planner->>Planner: æŸ¥è¯¢æ‰€æœ‰å·¥å…· (50ä¸ª)
    Planner->>Planner: åˆ¤æ–­: å·¥å…·æ•° >= 10?

    alt ä¸¤é˜¶æ®µè§„åˆ’
        Note over Planner,LLM: é˜¶æ®µ1: å·¥å…·ç­›é€‰ + æµç¨‹ç­›é€‰
        Planner->>WfMgr: format_workflows_summary()
        WfMgr-->>Planner: è¿”å›æµç¨‹æ‘˜è¦åˆ—è¡¨
        Planner->>Planner: format_tools_summary() <br/> ç®€åŒ–å·¥å…·ä¿¡æ¯
        Planner->>LLM: ç­›é€‰æç¤ºè¯ + ç®€åŒ–ä¿¡æ¯ + ğŸ†•æµç¨‹åˆ—è¡¨ <br/> (2,500 tokens + æµç¨‹ä¿¡æ¯)
        LLM-->>Planner: ğŸ†• å·¥å…·IDåˆ—è¡¨ + ä»»åŠ¡ç±»å‹ + æµç¨‹ID
        Planner->>Planner: ä»åŸåˆ—è¡¨æå–å®Œæ•´ä¿¡æ¯ <br/> (12ä¸ªå·¥å…·)
        Planner->>Client: æµå¼æ¨é€ç­›é€‰ç»“æœ

        Note over Planner,WfMgr: ğŸ†• æ ¹æ®LLMé€‰æ‹©çš„æµç¨‹IDè·å–è¯¦æƒ…
        Planner->>WfMgr: get_workflow(workflow_id)
        WfMgr-->>Planner: è¿”å›å®Œæ•´æµç¨‹ä¿¡æ¯ï¼ˆæˆ–Noneï¼‰
        alt æµç¨‹IDæœ‰æ•ˆ
            Planner->>Planner: workflow.format_for_llm()
            Note right of Planner: æ ¼å¼åŒ–æµç¨‹ä¸ºLLMæç¤ºæ–‡æœ¬
        else æµç¨‹IDæ— æ•ˆæˆ–æœªé€‰æ‹©
            Note right of Planner: ä¸ä½¿ç”¨æµç¨‹æç¤ºï¼ŒLLMè‡ªè¡Œè§„åˆ’
        end

        Note over Planner,LLM: é˜¶æ®µ2: ä»»åŠ¡åˆ†è§£
        Planner->>Planner: format_tools_info() <br/> è¯¦ç»†å·¥å…·ä¿¡æ¯
        Planner->>LLM: è§„åˆ’æç¤ºè¯ + è¯¦ç»†ä¿¡æ¯ + ğŸ†•æµç¨‹æç¤º <br/> (6,000 tokens)
        LLM-->>Planner: æ‰§è¡Œè®¡åˆ’
    else å•é˜¶æ®µè§„åˆ’
        Planner->>Planner: format_tools_info() <br/> æ‰€æœ‰å·¥å…·è¯¦ç»†ä¿¡æ¯
        Planner->>LLM: è§„åˆ’æç¤ºè¯ + è¯¦ç»†ä¿¡æ¯ <br/> (25,000 tokens)
        LLM-->>Planner: æ‰§è¡Œè®¡åˆ’
    end

    Planner-->>Orch: è¿”å›æ‰§è¡Œè®¡åˆ’
    Orch->>Client: æµå¼æ¨é€è®¡åˆ’è¯¦æƒ…
    Orch->>Orch: å¼€å§‹æ‰§è¡Œè®¡åˆ’
```

### å†³ç­–æµç¨‹ï¼ˆLLM-Basedæµç¨‹åŒ¹é…ï¼‰

```mermaid
flowchart TD
    A[å¼€å§‹è§„åˆ’] --> B{é…ç½®å¯ç”¨?}
    B -->|enable_two_stage_planning = false| C[å•é˜¶æ®µè§„åˆ’]
    B -->|enable_two_stage_planning = true| D{å·¥å…·æ•°é‡æ£€æŸ¥}

    D -->|å·¥å…·æ•° < é˜ˆå€¼| C
    D -->|å·¥å…·æ•° >= é˜ˆå€¼| E[ä¸¤é˜¶æ®µè§„åˆ’]

    E --> E1[é˜¶æ®µ1: å·¥å…·ç­›é€‰ + æµç¨‹ç­›é€‰]
    E1 --> E2[ğŸ†• LLMåŒæ—¶ç­›é€‰:<br/>- ç›¸å…³å·¥å…·<br/>- ä»»åŠ¡ç±»å‹<br/>- åŒ¹é…çš„æµç¨‹ID]
    E2 --> E3{ğŸ†• æµç¨‹IDæ˜¯å¦æœ‰æ•ˆ?}
    E3 -->|æµç¨‹IDå­˜åœ¨| E4[get_workflowè·å–å®Œæ•´æµç¨‹]
    E3 -->|æµç¨‹IDä¸å­˜åœ¨æˆ–æœªé€‰æ‹©| E5[ä¸ä½¿ç”¨æµç¨‹æç¤º]
    E4 --> E6[é˜¶æ®µ2: ä»»åŠ¡åˆ†è§£<br/>å·¥å…·ä¿¡æ¯ + æµç¨‹æç¤º]
    E5 --> E7[é˜¶æ®µ2: ä»»åŠ¡åˆ†è§£<br/>ä»…å·¥å…·ä¿¡æ¯]
    E6 --> F[ç”Ÿæˆæ‰§è¡Œè®¡åˆ’]
    E7 --> F

    C --> C1[ä½¿ç”¨æ‰€æœ‰å·¥å…·]
    C1 --> C2[ç”Ÿæˆæ‰§è¡Œè®¡åˆ’]
    C2 --> F

    F --> G[ç»“æŸ]

    style E2 fill:#e1f5ff
    style E3 fill:#fff4e1
    style E4 fill:#e8f5e9
```

**å…³é”®å˜åŒ–**ï¼š
- âœ… **LLMç»Ÿä¸€å†³ç­–**ï¼šå·¥å…·ç­›é€‰å’Œæµç¨‹åŒ¹é…åœ¨åŒä¸€ä¸ªLLMè°ƒç”¨ä¸­å®Œæˆ
- âœ… **æµç¨‹IDéªŒè¯**ï¼šç³»ç»ŸéªŒè¯LLMè¿”å›çš„æµç¨‹IDæ˜¯å¦å­˜åœ¨
- âœ… **ä¼˜é›…é™çº§**ï¼šæµç¨‹IDæ— æ•ˆæ—¶ä¸ä¼šå½±å“æ­£å¸¸æ‰§è¡Œï¼Œåªæ˜¯ç¼ºå°‘æµç¨‹æç¤º
- âœ… **å»é™¤ç¡¬ç¼–ç åŒ¹é…**ï¼šä¸å†æœ‰åŸºäºå…³é”®è¯çš„è¯„åˆ†ç³»ç»Ÿ

---

## å…³é”®ä»£ç ä½ç½®

### æ ¸å¿ƒæ–‡ä»¶æ¸…å•

```
src/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ planner.rs              # è§„åˆ’æ ¸å¿ƒé€»è¾‘
â”‚   â”‚   â”œâ”€â”€ L18-34             # Planner ç»“æ„å®šä¹‰ï¼ˆåŒ…å«workflow_managerï¼‰
â”‚   â”‚   â”œâ”€â”€ L56-60             # set_workflow_managerï¼ˆè®¾ç½®æµç¨‹ç®¡ç†å™¨ï¼‰
â”‚   â”‚   â”œâ”€â”€ L76-198            # generate_planï¼ˆåˆå§‹è§„åˆ’ + æµç¨‹åŒ¹é…ï¼‰
â”‚   â”‚   â”œâ”€â”€ L186-262           # format_tools_infoï¼ˆè¯¦ç»†ç‰ˆï¼‰
â”‚   â”‚   â”œâ”€â”€ L264-282           # format_tools_summaryï¼ˆç®€åŒ–ç‰ˆï¼‰
â”‚   â”‚   â”œâ”€â”€ L558-669           # replan_taskï¼ˆä»»åŠ¡é‡æ–°è§„åˆ’ + æµç¨‹åŒ¹é…ï¼‰
â”‚   â”‚   â”œâ”€â”€ L579-767           # replan_single_stepï¼ˆå•æ­¥ä¿®å¤ï¼‰
â”‚   â”‚   â”œâ”€â”€ L778-888           # select_relevant_toolsï¼ˆå·¥å…·ç­›é€‰ + ä»»åŠ¡ç±»å‹ï¼‰
â”‚   â”‚   â””â”€â”€ L891-948           # parse_tool_selection_responseï¼ˆè§£æä»»åŠ¡ç±»å‹ï¼‰
â”‚   â”‚
â”‚   â””â”€â”€ orchestrator.rs         # ç¼–æ’å™¨
â”‚       â”œâ”€â”€ L54-84             # EventSender trait å®šä¹‰
â”‚       â””â”€â”€ L152-163           # set_event_sender æ–¹æ³•
â”‚
â”œâ”€â”€ workflow/                   # ğŸ†• ä»»åŠ¡æµç¨‹æ¨¡å—
â”‚   â””â”€â”€ mod.rs                  # æµç¨‹ç®¡ç†æ ¸å¿ƒé€»è¾‘
â”‚       â”œâ”€â”€ L10-20             # WorkflowStep ç»“æ„
â”‚       â”œâ”€â”€ L22-71             # TaskWorkflow ç»“æ„ + format_for_llm()
â”‚       â”œâ”€â”€ L73-78             # WorkflowsConfig ç»“æ„
â”‚       â””â”€â”€ L81-199            # TaskWorkflowManagerï¼ˆåŠ è½½å’ŒåŒ¹é…ï¼‰
â”‚
â”œâ”€â”€ llm/
â”‚   â””â”€â”€ prompts.rs              # æç¤ºè¯æ¨¡æ¿
â”‚       â”œâ”€â”€ L77-229            # é˜¶æ®µ2ï¼šä»»åŠ¡åˆ†è§£æç¤ºè¯ï¼ˆåŒ…å«{workflow_hint}ï¼‰
â”‚       â”œâ”€â”€ L231-367           # é˜¶æ®µ1ï¼šå·¥å…·ç­›é€‰æç¤ºè¯
â”‚       â””â”€â”€ L488-521           # build_planning_promptï¼ˆæ–°å¢workflow_hintå‚æ•°ï¼‰
â”‚
â”œâ”€â”€ grpc/
â”‚   â””â”€â”€ server.rs               # gRPC æœåŠ¡å™¨
â”‚       â””â”€â”€ L436-468           # å·¥å…·ç­›é€‰äº‹ä»¶æµå¼æ¨é€
â”‚
â””â”€â”€ main_grpc.rs                # ğŸ†• å¯åŠ¨æ—¶åŠ è½½æµç¨‹ç®¡ç†å™¨
    â””â”€â”€ L129-143               # åŠ è½½ task_workflows.toml

config/
â””â”€â”€ task_workflows.toml         # ğŸ†• æ ‡å‡†ä»»åŠ¡æµç¨‹é…ç½®æ–‡ä»¶
```

### è°ƒç”¨é“¾è·¯ï¼ˆLLM-Basedæµç¨‹åŒ¹é…ï¼‰

```
ç”¨æˆ·è¯·æ±‚
  â†“
gRPC æœåŠ¡å™¨ (src/grpc/server.rs)
  â†“
Orchestrator::orchestrate_with_id_and_metadata (src/core/orchestrator.rs:184)
  â†“
Planner::generate_plan (src/core/planner.rs:76)
  â”œâ”€ query_available_tools() â†’ è·å–æ‰€æœ‰å·¥å…·
  â”œâ”€ åˆ¤æ–­æ˜¯å¦å¯ç”¨ä¸¤é˜¶æ®µ
  â”œâ”€ [ä¸¤é˜¶æ®µ] select_relevant_tools() â†’ å·¥å…·ç­›é€‰ + ä»»åŠ¡ç±»å‹ + æµç¨‹ID
  â”‚   â”œâ”€ workflow_manager.format_workflows_summary() â†’ ğŸ†• æ ¼å¼åŒ–æµç¨‹åˆ—è¡¨
  â”‚   â”œâ”€ format_tools_summary() â†’ ç®€åŒ–ä¿¡æ¯
  â”‚   â”œâ”€ LLM è°ƒç”¨ â†’ ğŸ†• ç­›é€‰å·¥å…· + è¯†åˆ«ä»»åŠ¡ç±»å‹ + é€‰æ‹©æµç¨‹ID
  â”‚   â”œâ”€ parse_tool_selection_response() â†’ è§£æå·¥å…·IDã€ä»»åŠ¡ç±»å‹å’Œæµç¨‹ID
  â”‚   â”œâ”€ filter æå–å®Œæ•´ä¿¡æ¯
  â”‚   â””â”€ send_tool_selection_completed() â†’ æµå¼æ¨é€
  â”œâ”€ ğŸ†• [æµç¨‹è·å–] workflow_manager.get_workflow(workflow_id) â†’ æ ¹æ®IDè·å–å®Œæ•´æµç¨‹
  â”‚   â”œâ”€ å¦‚æœæµç¨‹IDæœ‰æ•ˆ â†’ workflow.format_for_llm() â†’ æ ¼å¼åŒ–ä¸ºLLMæç¤º
  â”‚   â””â”€ å¦‚æœæµç¨‹IDæ— æ•ˆæˆ–æœªé€‰æ‹© â†’ ä¸ä½¿ç”¨æµç¨‹æç¤º
  â””â”€ format_tools_info() â†’ è¯¦ç»†ä¿¡æ¯
      â””â”€ LLM è°ƒç”¨ï¼ˆåŒ…å«æµç¨‹æç¤ºï¼‰â†’ ç”Ÿæˆè®¡åˆ’
```

**å…³é”®å˜åŒ–**ï¼š
- âœ… `select_relevant_tools()` ç°åœ¨è¿”å› `(tools, task_type, workflow_id)`
- âœ… æ–°å¢ `workflow_manager.format_workflows_summary()` è°ƒç”¨
- âœ… æ–°å¢ `workflow_manager.get_workflow()` è°ƒç”¨ï¼Œæ›¿ä»£ `match_workflow()`
- âœ… æµç¨‹ç­›é€‰ç”±LLMå®Œæˆï¼Œä¸å†æœ‰å…³é”®è¯åŒ¹é…æ­¥éª¤

---
â”‚   â”‚
â”‚   â””â”€â”€ orchestrator.rs         # ç¼–æ’å™¨
â”‚       â”œâ”€â”€ L54-84             # EventSender trait å®šä¹‰
â”‚       â””â”€â”€ L152-163           # set_event_sender æ–¹æ³•
â”‚
â”œâ”€â”€ llm/
â”‚   â””â”€â”€ prompts.rs              # æç¤ºè¯æ¨¡æ¿
â”‚       â”œâ”€â”€ L77-229            # é˜¶æ®µ2ï¼šä»»åŠ¡åˆ†è§£æç¤ºè¯
â”‚       â””â”€â”€ L231-367           # é˜¶æ®µ1ï¼šå·¥å…·ç­›é€‰æç¤ºè¯
â”‚
â”œâ”€â”€ grpc/
â”‚   â””â”€â”€ server.rs               # gRPC æœåŠ¡å™¨
â”‚       â””â”€â”€ L436-468           # å·¥å…·ç­›é€‰äº‹ä»¶æµå¼æ¨é€
â”‚
â””â”€â”€ config/
    â””â”€â”€ mod.rs                  # é…ç½®å®šä¹‰
        â””â”€â”€ L216-241           # OrchestratorConfig
```

### è°ƒç”¨é“¾è·¯

```
ç”¨æˆ·è¯·æ±‚
  â†“
gRPC æœåŠ¡å™¨ (src/grpc/server.rs)
  â†“
Orchestrator::orchestrate_with_id_and_metadata (src/core/orchestrator.rs:184)
  â†“
Planner::generate_plan (src/core/planner.rs:57)
  â”œâ”€ query_available_tools() â†’ è·å–æ‰€æœ‰å·¥å…·
  â”œâ”€ åˆ¤æ–­æ˜¯å¦å¯ç”¨ä¸¤é˜¶æ®µ
  â”œâ”€ [ä¸¤é˜¶æ®µ] select_relevant_tools() â†’ å·¥å…·ç­›é€‰
  â”‚   â”œâ”€ format_tools_summary() â†’ ç®€åŒ–ä¿¡æ¯
  â”‚   â”œâ”€ LLM è°ƒç”¨ â†’ ç­›é€‰å·¥å…·
  â”‚   â”œâ”€ parse_tool_selection_response() â†’ è§£æå·¥å…·ID
  â”‚   â”œâ”€ filter æå–å®Œæ•´ä¿¡æ¯
  â”‚   â””â”€ send_tool_selection_completed() â†’ æµå¼æ¨é€
  â””â”€ format_tools_info() â†’ è¯¦ç»†ä¿¡æ¯
      â””â”€ LLM è°ƒç”¨ â†’ ç”Ÿæˆè®¡åˆ’
```

---

## é…ç½®è¯´æ˜

### é…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `config.dev.toml`
**ä½ç½®**: L88-91

```toml
[orchestrator]
# æ˜¯å¦å¯ç”¨ä¸¤é˜¶æ®µè§„åˆ’ï¼ˆå…ˆç­›é€‰å·¥å…·ï¼Œå†ç”Ÿæˆè®¡åˆ’ï¼‰
enable_two_stage_planning = true

# å¯ç”¨ä¸¤é˜¶æ®µè§„åˆ’çš„æœ€å°å·¥å…·æ•°é‡é˜ˆå€¼ï¼ˆå½“å·¥å…·æ•° >= é˜ˆå€¼æ—¶æ‰å¯ç”¨ï¼‰
two_stage_tool_threshold = 10
```

### é…ç½®ç»“æ„

**æ–‡ä»¶**: `src/config/mod.rs`
**ä½ç½®**: L216-241

```rust
#[derive(Debug, Clone, Deserialize)]
pub struct OrchestratorConfig {
    pub max_reflection_rounds: u32,
    pub task_timeout_secs: u64,
    pub enable_auto_reflection: bool,
    pub success_threshold: f32,
    pub max_concurrent_tasks: usize,

    // ä¸¤é˜¶æ®µè§„åˆ’é…ç½®
    #[serde(default = "default_enable_two_stage_planning")]
    pub enable_two_stage_planning: bool,

    #[serde(default = "default_two_stage_tool_threshold")]
    pub two_stage_tool_threshold: usize,
}

fn default_enable_two_stage_planning() -> bool {
    true
}

fn default_two_stage_tool_threshold() -> usize {
    10
}
```

### é…ç½®å»ºè®®

| åœºæ™¯ | enable_two_stage_planning | two_stage_tool_threshold | è¯´æ˜ |
|------|---------------------------|--------------------------|------|
| **ç”Ÿäº§ç¯å¢ƒ** | `true` | `10` | æ¨èé…ç½®ï¼Œå¹³è¡¡æ€§èƒ½å’Œæˆæœ¬ |
| **å·¥å…·è¾ƒå°‘** | `false` æˆ– `true` | `20-30` | å·¥å…·å°‘äº20ä¸ªæ—¶ï¼Œå•é˜¶æ®µæ›´å¿« |
| **å·¥å…·è¾ƒå¤š** | `true` | `5-10` | å·¥å…·è¶…è¿‡30ä¸ªæ—¶ï¼Œä¸¤é˜¶æ®µä¼˜åŠ¿æ˜æ˜¾ |
| **è°ƒè¯•æ¨¡å¼** | `false` | - | æ–¹ä¾¿æŸ¥çœ‹å®Œæ•´æç¤ºè¯ |

---

## æ€§èƒ½å¯¹æ¯”

### Token æ¶ˆè€—å¯¹æ¯”

| åœºæ™¯ | å·¥å…·æ•° | å•é˜¶æ®µ Token | ä¸¤é˜¶æ®µ Token | èŠ‚çœç‡ |
|------|--------|--------------|--------------|--------|
| å°å‹ä»»åŠ¡ | 10 | 5,000 | 5,000 | 0% (ä¸è§¦å‘) |
| ä¸­å‹ä»»åŠ¡ | 30 | 15,000 | 7,000 | **53%** |
| å¤§å‹ä»»åŠ¡ | 50 | 25,000 | 8,500 | **66%** |
| è¶…å¤§ä»»åŠ¡ | 100 | 50,000 | 12,000 | **76%** |

### Token è®¡ç®—å…¬å¼

**å•é˜¶æ®µ**:
```
æ€»Token = å·¥å…·æ•° Ã— 500 (è¯¦ç»†ä¿¡æ¯)
```

**ä¸¤é˜¶æ®µ**:
```
é˜¶æ®µ1 Token = å·¥å…·æ•° Ã— 50 (ç®€åŒ–ä¿¡æ¯)
é˜¶æ®µ2 Token = ç­›é€‰åå·¥å…·æ•° Ã— 500 (è¯¦ç»†ä¿¡æ¯)
æ€»Token = é˜¶æ®µ1 Token + é˜¶æ®µ2 Token

å‡è®¾ç­›é€‰ç‡ä¸º 70-80%:
æ€»Token â‰ˆ å·¥å…·æ•° Ã— 50 + å·¥å…·æ•° Ã— 0.25 Ã— 500
       â‰ˆ å·¥å…·æ•° Ã— 175
èŠ‚çœç‡ â‰ˆ 65%
```

### å®é™…æ¡ˆä¾‹

#### æ¡ˆä¾‹1ï¼šè´Ÿè·é¢„æµ‹ä»»åŠ¡

- **å·¥å…·æ€»æ•°**: 50
- **ç›¸å…³å·¥å…·**: 12 (ç­›é€‰ç‡ 76%)

| é˜¶æ®µ | Tokenæ¶ˆè€— | è¯´æ˜ |
|------|-----------|------|
| å•é˜¶æ®µ | 25,000 | 50 Ã— 500 |
| ä¸¤é˜¶æ®µ-é˜¶æ®µ1 | 2,500 | 50 Ã— 50 |
| ä¸¤é˜¶æ®µ-é˜¶æ®µ2 | 6,000 | 12 Ã— 500 |
| **ä¸¤é˜¶æ®µæ€»è®¡** | **8,500** | **èŠ‚çœ 66%** |

#### æ¡ˆä¾‹2ï¼šè‡ªåŠ¨å»ºæ¨¡ä»»åŠ¡

- **å·¥å…·æ€»æ•°**: 50
- **ç›¸å…³å·¥å…·**: 8 (ç­›é€‰ç‡ 84%)

| é˜¶æ®µ | Tokenæ¶ˆè€— | è¯´æ˜ |
|------|-----------|------|
| å•é˜¶æ®µ | 25,000 | 50 Ã— 500 |
| ä¸¤é˜¶æ®µ-é˜¶æ®µ1 | 2,500 | 50 Ã— 50 |
| ä¸¤é˜¶æ®µ-é˜¶æ®µ2 | 4,000 | 8 Ã— 500 |
| **ä¸¤é˜¶æ®µæ€»è®¡** | **6,500** | **èŠ‚çœ 74%** |

---

## æµå¼æ¨é€

### EventSender æ¥å£æ‰©å±•ï¼ˆåŒ…å«å·¥ä½œæµä¿¡æ¯ï¼‰

**æ–‡ä»¶**: `src/core/orchestrator.rs`
**ä½ç½®**: L54-84
**æœ€åæ›´æ–°**: 2024-11-27 - æ·»åŠ å·¥ä½œæµä¿¡æ¯å‚æ•°

```rust
pub trait EventSender: Send + Sync {
    // åŸæœ‰äº‹ä»¶æ–¹æ³•...

    /// å‘é€å·¥å…·ç­›é€‰å®Œæˆäº‹ä»¶ï¼ˆä¸¤é˜¶æ®µè§„åˆ’çš„é˜¶æ®µ1ï¼‰
    ///
    /// # å‚æ•°
    /// - `total_tools`: åŸå§‹å·¥å…·æ€»æ•°
    /// - `selected_tools`: ç­›é€‰åçš„å·¥å…·æ•°
    /// - `selected_tool_ids`: ç­›é€‰å‡ºçš„å·¥å…·IDåˆ—è¡¨
    /// - `workflow_id`: ğŸ†• LLMç­›é€‰å‡ºçš„åŒ¹é…ä»»åŠ¡æµç¨‹IDï¼ˆå¯é€‰ï¼‰
    /// - `workflow_name`: ğŸ†• åŒ¹é…ä»»åŠ¡æµç¨‹çš„åç§°ï¼ˆå¯é€‰ï¼‰
    #[allow(unused_variables)]
    fn send_tool_selection_completed(
        &self,
        total_tools: usize,
        selected_tools: usize,
        selected_tool_ids: &[String],
        workflow_id: Option<&str>,
        workflow_name: Option<&str>,
    ) {}

    // å…¶ä»–äº‹ä»¶æ–¹æ³•...
}
```

**å…³é”®å˜åŒ–**:
- âœ… æ–°å¢ `workflow_id` å‚æ•°ï¼šLLMç­›é€‰å‡ºçš„æµç¨‹ID
- âœ… æ–°å¢ `workflow_name` å‚æ•°ï¼šæµç¨‹çš„å¯è¯»åç§°
- âœ… å‡ä¸º `Option` ç±»å‹ï¼šæ”¯æŒæœªåŒ¹é…åˆ°æµç¨‹çš„æƒ…å†µ

### gRPC æµå¼å®ç°ï¼ˆåŒ…å«å·¥ä½œæµä¿¡æ¯ï¼‰

**æ–‡ä»¶**: `src/grpc/server.rs`
**æ–¹æ³•**: `StreamEventSender::send_tool_selection_completed`
**ä½ç½®**: L436-487

```rust
fn send_tool_selection_completed(
    &self,
    total_tools: usize,
    selected_tools: usize,
    selected_tool_ids: &[String],
    workflow_id: Option<&str>,
    workflow_name: Option<&str>,
) {
    let reduction_rate = (1.0 - selected_tools as f64 / total_tools as f64) * 100.0;

    let mut message = String::new();
    message.push_str("ğŸ” å·¥å…·ç­›é€‰å®Œæˆ\n\n");
    message.push_str(&format!("åŸå§‹å·¥å…·æ•°: {}\n", total_tools));
    message.push_str(&format!("ç­›é€‰åå·¥å…·æ•°: {}\n", selected_tools));
    message.push_str(&format!("ç­›é€‰ç‡: {:.1}%\n\n", reduction_rate));

    // ğŸ†• æ·»åŠ å·¥ä½œæµä¿¡æ¯
    if let (Some(wf_id), Some(wf_name)) = (workflow_id, workflow_name) {
        message.push_str("âœ… åŒ¹é…çš„ä»»åŠ¡æµç¨‹:\n");
        message.push_str(&format!("  æµç¨‹ID: {}\n", wf_id));
        message.push_str(&format!("  æµç¨‹åç§°: {}\n\n", wf_name));
    } else {
        message.push_str("âŒ æœªåŒ¹é…åˆ°æ ‡å‡†ä»»åŠ¡æµç¨‹\n\n");
    }

    message.push_str("ç­›é€‰å‡ºçš„å·¥å…·:\n");
    for (i, tool_id) in selected_tool_ids.iter().enumerate() {
        message.push_str(&format!("  {}. {}\n", i + 1, tool_id));
    }

    // å¼‚æ­¥å‘é€äº‹ä»¶
    let event = TaskExecutionEvent {
        task_id: self.task_id.clone(),
        event_type: EventType::StatusUpdate as i32,
        timestamp: Utc::now().to_rfc3339(),
        event_data: Some(EventData::StatusUpdate(...)),
    };

    let _ = self.tx.send(Ok(event)).await;
}
```

### Planner è°ƒç”¨ç‚¹ï¼ˆä¼ é€’å·¥ä½œæµä¿¡æ¯ï¼‰

**æ–‡ä»¶**: `src/core/planner.rs`
**æ–¹æ³•**: `select_relevant_tools`
**ä½ç½®**: L1025-1045

```rust
// 8. è·å–å·¥ä½œæµåç§°ï¼ˆå¦‚æœæœ‰åŒ¹é…çš„å·¥ä½œæµï¼‰
let workflow_name = if let Some(ref wf_id) = workflow_id {
    if let Some(wf_manager) = &self.workflow_manager {
        wf_manager.get_workflow(wf_id).map(|wf| wf.name)
    } else {
        None
    }
} else {
    None
};

// 9. å‘é€å·¥å…·ç­›é€‰å®Œæˆäº‹ä»¶ï¼ˆæµå¼æ¨é€ç»™å®¢æˆ·ç«¯ï¼ŒåŒ…å«å·¥ä½œæµä¿¡æ¯ï¼‰
if let Some(event_sender) = &self.event_sender {
    event_sender.send_tool_selection_completed(
        all_tools.len(),
        selected_tools.len(),
        &selected_tool_ids,
        workflow_id.as_deref(),      // ğŸ†• ä¼ é€’æµç¨‹ID
        workflow_name.as_deref(),    // ğŸ†• ä¼ é€’æµç¨‹åç§°
    );
}
```

**å…³é”®é€»è¾‘**:
1. ä» `workflow_id` è·å–å®Œæ•´çš„å·¥ä½œæµå¯¹è±¡
2. æå– `workflow.name` ä½œä¸ºå¯è¯»åç§°
3. å°† `workflow_id` å’Œ `workflow_name` ä¸€èµ·å‘é€ç»™å®¢æˆ·ç«¯
4. å¦‚æœæµç¨‹IDæ— æ•ˆæˆ–æœªåŒ¹é…ï¼Œä¸¤è€…å‡ä¸º `None`

### å®¢æˆ·ç«¯æ”¶åˆ°çš„æ¶ˆæ¯ï¼ˆåŒ…å«å·¥ä½œæµä¿¡æ¯ï¼‰

**åœºæ™¯1ï¼šåŒ¹é…åˆ°æ ‡å‡†æµç¨‹**
```
1. ğŸ” å·¥å…·ç­›é€‰
   åŸå§‹å·¥å…·æ•°: 50
   ç­›é€‰åå·¥å…·æ•°: 12
   ç­›é€‰ç‡: 76.0%

   âœ… åŒ¹é…çš„ä»»åŠ¡æµç¨‹:
     æµç¨‹ID: load_prediction
     æµç¨‹åç§°: è´Ÿè·é¢„æµ‹

   ç­›é€‰å‡ºçš„å·¥å…·:
     1. check_csv_file
     2. add_datasource
     3. data_upload
     4. get_data
     5. data_validation
     ... (å…±12ä¸ª)

2. ğŸ“‹ æ™ºèƒ½è§„åˆ’
   è®¡åˆ’ID: plan_xxx
   è®¡åˆ’æè¿°: è´Ÿè·é¢„æµ‹å®Œæ•´æµç¨‹æ‰§è¡Œè®¡åˆ’
   æ€»æ­¥éª¤æ•°: 12
   é¢„è®¡è€—æ—¶: 300 ç§’

   æ‰§è¡Œæ­¥éª¤:
     1. æ­¥éª¤ID: step_1
        æ­¥éª¤åç§°: æ ¡éªŒCSVæ–‡ä»¶
        å·¥å…·ID: check_csv_file
        ...
```

**åœºæ™¯2ï¼šæœªåŒ¹é…åˆ°æ ‡å‡†æµç¨‹**
```
1. ğŸ” å·¥å…·ç­›é€‰
   åŸå§‹å·¥å…·æ•°: 50
   ç­›é€‰åå·¥å…·æ•°: 8
   ç­›é€‰ç‡: 84.0%

   âŒ æœªåŒ¹é…åˆ°æ ‡å‡†ä»»åŠ¡æµç¨‹

   ç­›é€‰å‡ºçš„å·¥å…·:
     1. tool_a
     2. tool_b
     ... (å…±8ä¸ª)

2. ğŸ“‹ æ™ºèƒ½è§„åˆ’
   è®¡åˆ’ID: plan_xxx
   è®¡åˆ’æè¿°: è‡ªå®šä¹‰ä»»åŠ¡æ‰§è¡Œè®¡åˆ’
   æ€»æ­¥éª¤æ•°: 5
   é¢„è®¡è€—æ—¶: 120 ç§’
   ...
```

**å¯¹æ¯”åˆ†æ**:

| åœºæ™¯ | å·¥ä½œæµä¿¡æ¯ | LLMè§„åˆ’æ–¹å¼ | ç‰¹ç‚¹ |
|------|-----------|------------|------|
| **åŒ¹é…åˆ°æ ‡å‡†æµç¨‹** | æ˜¾ç¤ºæµç¨‹IDå’Œåç§° | å‚è€ƒæ ‡å‡†æµç¨‹æç¤º + çµæ´»è°ƒæ•´ | æ›´è§„èŒƒã€æ›´ç¨³å®š |
| **æœªåŒ¹é…æ ‡å‡†æµç¨‹** | æ˜¾ç¤º"æœªåŒ¹é…" | LLMå®Œå…¨è‡ªç”±è§„åˆ’ | æ›´çµæ´»ã€æ›´åˆ›æ–° |

---

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šè´Ÿè·é¢„æµ‹ä»»åŠ¡

**ä»»åŠ¡æè¿°**:
```
è¿›è¡Œè´Ÿè·é¢„æµ‹ï¼Œæ–‡ä»¶è·¯å¾„: /data/load.csv
```

**å·¥ä½œæµç¨‹**:

1. **é˜¶æ®µ1ï¼šå·¥å…·ç­›é€‰**
   - è¾“å…¥ï¼š50ä¸ªå·¥å…·çš„ç®€åŒ–ä¿¡æ¯
   - LLMåˆ†æï¼šè¿™æ˜¯è´Ÿè·é¢„æµ‹ä»»åŠ¡
   - è¾“å‡ºï¼šç­›é€‰å‡º12ä¸ªç›¸å…³å·¥å…·

2. **é˜¶æ®µ2ï¼šä»»åŠ¡åˆ†è§£**
   - è¾“å…¥ï¼š12ä¸ªå·¥å…·çš„è¯¦ç»†ä¿¡æ¯
   - LLMè§„åˆ’ï¼šç”Ÿæˆ12æ­¥æ‰§è¡Œè®¡åˆ’
   - è¾“å‡ºï¼šå®Œæ•´çš„æ‰§è¡Œè®¡åˆ’

**Tokenå¯¹æ¯”**:
- å•é˜¶æ®µï¼š25,000 tokens
- ä¸¤é˜¶æ®µï¼š8,500 tokens
- **èŠ‚çœ66%**

### ç¤ºä¾‹2ï¼šä»»åŠ¡é‡æ–°è§„åˆ’

**åœºæ™¯**: æ­¥éª¤3æ‰§è¡Œå¤±è´¥ï¼Œéœ€è¦é‡æ–°è§„åˆ’æ•´ä¸ªä»»åŠ¡

**å·¥ä½œæµç¨‹**:

1. **å¤±è´¥åˆ†æ**
   - Reflector åˆ†æå¤±è´¥åŸå› 
   - å†³å®šéœ€è¦é‡æ–°è§„åˆ’æ•´ä¸ªä»»åŠ¡

2. **é‡æ–°è§„åˆ’ï¼ˆä¸¤é˜¶æ®µï¼‰**
   - é˜¶æ®µ1ï¼šæ ¹æ®å¤±è´¥åŸå› å’Œä»»åŠ¡æè¿°ç­›é€‰å·¥å…·
   - é˜¶æ®µ2ï¼šåŸºäºç­›é€‰åçš„å·¥å…·ç”Ÿæˆæ–°è®¡åˆ’

**ä¼˜åŠ¿**:
- é‡æ–°è§„åˆ’æ—¶ä¹Ÿäº«å—Tokenä¼˜åŒ–
- ç­›é€‰æ—¶ä¼šè€ƒè™‘å¤±è´¥åŸå› ï¼Œé¿å…é€‰æ‹©å¯èƒ½å¯¼è‡´å¤±è´¥çš„å·¥å…·

### ç¤ºä¾‹3ï¼šå•æ­¥ä¿®å¤

**åœºæ™¯**: æ­¥éª¤5æ‰§è¡Œå¤±è´¥ï¼Œå°è¯•ä¿®å¤è¯¥æ­¥éª¤

**å·¥ä½œæµç¨‹**:

1. **å•æ­¥åæ€**
   - Reflector åˆ†ææ­¥éª¤å¤±è´¥åŸå› 
   - åˆ¤æ–­æ­¥éª¤æ˜¯å¯æ¢å¤çš„

2. **å•æ­¥ä¿®å¤ï¼ˆä¸ä½¿ç”¨ä¸¤é˜¶æ®µè§„åˆ’ï¼‰**
   - ç›´æ¥ä½¿ç”¨åŸè®¡åˆ’ä¸­å·²ç­›é€‰çš„å·¥å…·é›†
   - LLMåŸºäºå¤±è´¥æ­¥éª¤å’Œé”™è¯¯ä¿¡æ¯ç”Ÿæˆä¿®å¤æ­¥éª¤
   - ä¸é‡æ–°ç­›é€‰å·¥å…·ï¼Œä¿æŒè®¡åˆ’çš„ä¸€è‡´æ€§

**ä¼˜åŠ¿**:
- å¤ç”¨åŸå·¥å…·é›†ï¼Œä¿æŒè®¡åˆ’è¿è´¯æ€§
- å¿«é€Ÿä¿®å¤ï¼Œä¸éœ€è¦é¢å¤–çš„å·¥å…·ç­›é€‰å¼€é”€
- èšç„¦é—®é¢˜ï¼Œåªè°ƒæ•´å¤±è´¥çš„æ­¥éª¤

**è®¾è®¡ç†ç”±**:
- å•æ­¥ä¿®å¤æ˜¯å±€éƒ¨è°ƒæ•´ï¼Œä¸éœ€è¦é‡æ–°è¯„ä¼°æ•´ä¸ªä»»åŠ¡çš„å·¥å…·éœ€æ±‚
- åŸè®¡åˆ’çš„å·¥å…·é›†å·²ç»è¿‡ç­›é€‰ï¼Œèƒ½æ»¡è¶³ä»»åŠ¡éœ€æ±‚
- é¿å…ä¸å¿…è¦çš„LLMè°ƒç”¨ï¼Œæé«˜ä¿®å¤æ•ˆç‡

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¸æ˜¯æ‰€æœ‰ä»»åŠ¡éƒ½ä½¿ç”¨ä¸¤é˜¶æ®µè§„åˆ’ï¼Ÿ

**A**: ä¸¤é˜¶æ®µè§„åˆ’é€‚ç”¨äºå·¥å…·æ•°é‡è¾ƒå¤šçš„åœºæ™¯ã€‚å½“å·¥å…·æ•°é‡è¾ƒå°‘æ—¶ï¼ˆå¦‚ < 10ä¸ªï¼‰ï¼Œå•é˜¶æ®µè§„åˆ’æ›´å¿«ï¼š
- é¿å…äº†é¢å¤–çš„LLMè°ƒç”¨å¼€é”€
- ç®€åŒ–å·¥å…·ä¿¡æ¯ä¸è¯¦ç»†ä¿¡æ¯å·®å¼‚ä¸å¤§
- é€šè¿‡é…ç½® `two_stage_tool_threshold` åŠ¨æ€å†³ç­–

### Q2: å¦‚ä½•ç¡®ä¿å·¥å…·ç­›é€‰ä¸ä¼šé—æ¼å…³é”®å·¥å…·ï¼Ÿ

**A**: å¤šé‡ä¿éšœæœºåˆ¶ï¼š
1. **æç¤ºè¯ç­–ç•¥**: æ˜ç¡®è¦æ±‚"å®å¯å¤šé€‰ä¸å¯æ¼é€‰"
2. **å†…ç½®é¢†åŸŸçŸ¥è¯†**: æä¾›è´Ÿè·é¢„æµ‹ã€è‡ªåŠ¨å»ºæ¨¡ç­‰æ ‡å‡†æµç¨‹
3. **å®Œæ•´æµç¨‹è€ƒè™‘**: å¼ºè°ƒä¸åªé€‰æ ¸å¿ƒå·¥å…·ï¼Œè¦è€ƒè™‘å®Œæ•´å·¥ä½œæµ
4. **ç­›é€‰ç½®ä¿¡åº¦**: LLMè¿”å›ç½®ä¿¡åº¦ï¼Œå¯ç”¨äºç›‘æ§

### Q3: ä¸¤é˜¶æ®µè§„åˆ’æ˜¯å¦ä¼šå¢åŠ å“åº”æ—¶é—´ï¼Ÿ

**A**: è™½ç„¶å¢åŠ äº†ä¸€æ¬¡LLMè°ƒç”¨ï¼Œä½†æ€»ä½“å¯èƒ½æ›´å¿«ï¼š
- **Tokenå‡å°‘**: æ›´å°‘çš„tokenæ„å‘³ç€æ›´å¿«çš„æ¨ç†é€Ÿåº¦
- **å¹¶è¡Œæœºä¼š**: å¯ä»¥å¹¶è¡Œå¤„ç†ç­›é€‰å’Œå…¶ä»–å‡†å¤‡å·¥ä½œ
- **å®æµ‹æ•°æ®**:
  - å•é˜¶æ®µï¼š~8-10ç§’
  - ä¸¤é˜¶æ®µï¼š~6-9ç§’ï¼ˆé˜¶æ®µ1: 2-3ç§’ + é˜¶æ®µ2: 4-6ç§’ï¼‰
- **æµå¼ä½“éªŒ**: å®¢æˆ·ç«¯æ›´æ—©æ”¶åˆ°ç­›é€‰ç»“æœï¼Œæ„ŸçŸ¥æ›´å¿«

### Q4: å¦‚ä½•è°ƒæ•´å·¥å…·æ•°é‡é˜ˆå€¼ï¼Ÿ

**A**: æ ¹æ®å®é™…å·¥å…·é›†å¤§å°è°ƒæ•´ï¼š
```toml
[orchestrator]
# å·¥å…·æ•° < 20: å»ºè®®é˜ˆå€¼ 15-20
two_stage_tool_threshold = 15

# å·¥å…·æ•° 20-50: å»ºè®®é˜ˆå€¼ 10-15
two_stage_tool_threshold = 10

# å·¥å…·æ•° > 50: å»ºè®®é˜ˆå€¼ 5-10
two_stage_tool_threshold = 5
```

### Q5: é‡æ–°è§„åˆ’æ—¶å¦‚ä½•åˆ©ç”¨å†å²ä¿¡æ¯ï¼Ÿ

**A**: ç³»ç»Ÿæ™ºèƒ½åˆ©ç”¨å†å²ä¸Šä¸‹æ–‡ï¼š
- **ä»»åŠ¡é‡æ–°è§„åˆ’**: å°†å¤±è´¥åŸå› ä½œä¸ºä»»åŠ¡æè¿°çš„ä¸€éƒ¨åˆ†ä¼ å…¥å·¥å…·ç­›é€‰
- **å•æ­¥ä¿®å¤**: æ„å»ºä¸“é—¨çš„ä¿®å¤ä¸Šä¸‹æ–‡ï¼ŒåŒ…å«å¤±è´¥æ­¥éª¤ä¿¡æ¯å’Œé”™è¯¯è¯¦æƒ…
- **å…ƒæ•°æ®ä¼ é€’**: å°†å…³é”®ä¿¡æ¯ï¼ˆå¦‚åŸå·¥å…·IDã€é”™è¯¯ç±»å‹ï¼‰é€šè¿‡metadataä¼ é€’

### Q6: å¦‚ä½•ç›‘æ§ä¸¤é˜¶æ®µè§„åˆ’çš„æ•ˆæœï¼Ÿ

**A**: å¤šç»´åº¦ç›‘æ§ï¼š

1. **æ—¥å¿—ç›‘æ§**:
   ```
   ğŸ”€ ä½¿ç”¨ä¸¤é˜¶æ®µè§„åˆ’æ¨¡å¼
   ğŸ” é˜¶æ®µ1ï¼šå¼€å§‹ç­›é€‰ç›¸å…³å·¥å…·
   âœ… å·¥å…·ç­›é€‰å®Œæˆ (selected: 12, total: 50, reduction: 76%)
   ğŸ“‹ é˜¶æ®µ2ï¼šè°ƒç”¨ LLM ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼ˆåŸºäº 12 ä¸ªå·¥å…·ï¼‰
   ```

2. **Kafkaæ—¥å¿—**:
   - `planner_tool_selection`: å·¥å…·ç­›é€‰çš„LLMäº¤äº’
   - `planner`: ä»»åŠ¡åˆ†è§£çš„LLMäº¤äº’
   - å­—æ®µ `used_two_stage_planning`: æ˜¯å¦ä½¿ç”¨äº†ä¸¤é˜¶æ®µ

3. **æŒ‡æ ‡ç»Ÿè®¡**:
   - Tokenæ¶ˆè€—å¯¹æ¯”
   - è§„åˆ’æˆåŠŸç‡
   - å¹³å‡å“åº”æ—¶é—´

### Q7: æç¤ºè¯å¦‚ä½•ä¼˜åŒ–ï¼Ÿ

**A**: æç¤ºè¯ä¼˜åŒ–å»ºè®®ï¼š

1. **é˜¶æ®µ1ä¼˜åŒ–** (prompts.rs L231-367):
   - è°ƒæ•´ç­›é€‰ç­–ç•¥ç­‰çº§
   - æ·»åŠ æ–°çš„é¢†åŸŸçŸ¥è¯†
   - ä¼˜åŒ–è¾“å‡ºæ ¼å¼

2. **é˜¶æ®µ2ä¼˜åŒ–** (prompts.rs L77-229):
   - è°ƒæ•´è§„åˆ’åŸåˆ™
   - æ›´æ–°æ ‡å‡†æµç¨‹è§„èŒƒ
   - ä¼˜åŒ–å‚æ•°é…ç½®å‚è€ƒ

3. **æµ‹è¯•éªŒè¯**:
   - ä½¿ç”¨çœŸå®ä»»åŠ¡æµ‹è¯•
   - å¯¹æ¯”å•é˜¶æ®µå’Œä¸¤é˜¶æ®µçš„è§„åˆ’è´¨é‡
   - ç›‘æ§ç­›é€‰å‡†ç¡®ç‡

---

## æ€»ç»“

### æ ¸å¿ƒä»·å€¼

âœ… **æ˜¾è‘—çš„æ€§èƒ½æå‡**: Tokenæ¶ˆè€—å‡å°‘ 50-76%
âœ… **æ›´å¥½çš„è§„åˆ’è´¨é‡**: èŒè´£åˆ†ç¦»ï¼Œæ›´èšç„¦çš„è§„åˆ’
âœ… **æ™ºèƒ½çš„åŠ¨æ€å†³ç­–**: æ ¹æ®å·¥å…·æ•°é‡è‡ªåŠ¨é€‰æ‹©æ¨¡å¼
âœ… **åˆç†çš„åœºæ™¯è¦†ç›–**: åˆå§‹è§„åˆ’å’Œä»»åŠ¡é‡æ–°è§„åˆ’ä½¿ç”¨ä¸¤é˜¶æ®µï¼Œå•æ­¥ä¿®å¤å¤ç”¨åŸå·¥å…·é›†
âœ… **å®Œå–„çš„æµå¼ä½“éªŒ**: å®¢æˆ·ç«¯å®æ—¶çœ‹åˆ°ç­›é€‰è¿›åº¦
âœ… **ğŸ†• æ™ºèƒ½æµç¨‹åŒ¹é…**: LLMåŸºäºè¯­ä¹‰ç†è§£é€‰æ‹©æœ€åŒ¹é…çš„ä»»åŠ¡æµç¨‹

### æŠ€æœ¯äº®ç‚¹

1. **æ¸è¿›å¼ä¿¡æ¯å‘ˆç°**: ä»ç®€åŒ–åˆ°è¯¦ç»†ï¼Œé€æ­¥æä¾›ä¿¡æ¯
2. **æ™ºèƒ½ä¸Šä¸‹æ–‡æ„å»º**: ä¸åŒåœºæ™¯æ„å»ºä¸åŒçš„ç­›é€‰ä¸Šä¸‹æ–‡
3. **æ•°æ®æµä¼˜åŒ–**: å®Œæ•´å·¥å…·ä¿¡æ¯åªåœ¨ç¬¬äºŒé˜¶æ®µä¼ é€’ä¸€æ¬¡
4. **äº‹ä»¶é©±åŠ¨æ¶æ„**: é€šè¿‡EventSenderè§£è€¦plannerå’Œgrpcå±‚
5. **ğŸ†• LLM-BasedåŒ¹é…**: æµç¨‹é€‰æ‹©ç”±LLMåŸºäºè¯­ä¹‰ç†è§£å®Œæˆï¼Œå–ä»£ç¡¬ç¼–ç åŒ¹é…é€»è¾‘

### LLM-Basedæµç¨‹åŒ¹é…çš„ä¼˜åŠ¿

#### ä¸å…³é”®è¯åŒ¹é…çš„å¯¹æ¯”

| ç‰¹æ€§ | å…³é”®è¯åŒ¹é…ï¼ˆæ—§ï¼‰ | LLM-BasedåŒ¹é…ï¼ˆæ–°ï¼‰ |
|------|------------------|---------------------|
| **åŒ¹é…æ–¹å¼** | å…³é”®è¯è¯„åˆ†ç³»ç»Ÿ | è¯­ä¹‰ç†è§£ |
| **çµæ´»æ€§** | éœ€è¦é¢„å®šä¹‰å…³é”®è¯ | è‡ªåŠ¨ç†è§£ä¸åŒè¡¨è¿° |
| **å¤šè¯­è¨€æ”¯æŒ** | éœ€è¦æ·»åŠ æ‰€æœ‰ç¿»è¯‘ | è‡ªç„¶æ”¯æŒå¤šè¯­è¨€ |
| **ç»´æŠ¤æˆæœ¬** | éœ€è¦ç»´æŠ¤å…³é”®è¯åˆ—è¡¨ | æ— éœ€ç»´æŠ¤ |
| **åŒ¹é…å‡†ç¡®æ€§** | ä¾èµ–å…³é”®è¯è¦†ç›–åº¦ | åŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦ |
| **æ‰©å±•æ€§** | æ·»åŠ æ–°æµç¨‹éœ€è¦æ›´æ–°å…³é”®è¯ | æ·»åŠ æ–°æµç¨‹æ— éœ€ä¿®æ”¹ä»£ç  |

**ç¤ºä¾‹å¯¹æ¯”**ï¼š

```
ç”¨æˆ·ä»»åŠ¡: "æˆ‘æƒ³é¢„æµ‹ä¸€ä¸‹æ˜å¤©çš„èƒ½è€—"

å…³é”®è¯åŒ¹é…:
- éœ€è¦åœ¨keywordsä¸­æ·»åŠ "èƒ½è€—"ã€"é¢„æµ‹èƒ½è€—"ç­‰å¤šä¸ªå˜ä½“
- å¦‚æœç”¨æˆ·è¯´"ä¼°ç®—ç”µåŠ›æ¶ˆè€—"å¯èƒ½åŒ¹é…å¤±è´¥

LLMåŒ¹é…:
- è‡ªåŠ¨ç†è§£"é¢„æµ‹èƒ½è€—" â‰ˆ "è´Ÿè·é¢„æµ‹"
- è‡ªåŠ¨ç†è§£"ä¼°ç®—ç”µåŠ›æ¶ˆè€—" â‰ˆ "è´Ÿè·é¢„æµ‹"
- æ— éœ€é¢„å®šä¹‰æ‰€æœ‰å¯èƒ½çš„è¡¨è¿°æ–¹å¼
```

#### æ¶æ„ä¼˜åŠ¿

1. **ç»Ÿä¸€å†³ç­–ç‚¹**: å·¥å…·ç­›é€‰å’Œæµç¨‹åŒ¹é…åœ¨åŒä¸€ä¸ªLLMè°ƒç”¨ä¸­å®Œæˆï¼Œå‡å°‘å¾€è¿”æ¬¡æ•°
2. **ID-Basedæ£€ç´¢**: LLMè¿”å›æµç¨‹IDï¼Œç³»ç»Ÿé€šè¿‡HashMapå¿«é€Ÿæ£€ç´¢ï¼ŒO(1)å¤æ‚åº¦
3. **ä¼˜é›…é™çº§**: æµç¨‹IDæ— æ•ˆæ—¶ä¸å½±å“æ­£å¸¸æ‰§è¡Œï¼Œåªæ˜¯ç¼ºå°‘æµç¨‹æç¤º
4. **å‘åå…¼å®¹**: ä¿ç•™æ—§çš„`match_workflow()`æ–¹æ³•ä½†æ ‡è®°ä¸ºdeprecated

### è®¾è®¡åŸåˆ™

1. **å•ä¸€èŒè´£**: æ¯ä¸ªé˜¶æ®µåªåšä¸€ä»¶äº‹
2. **æ¸è¿›å¢å¼º**: å¯é…ç½®å¼€å…³ï¼Œå‘åå…¼å®¹
3. **ç”¨æˆ·ä½“éªŒ**: æµå¼æ¨é€ï¼Œå®æ—¶åé¦ˆ
4. **å¯è§‚æµ‹æ€§**: å®Œæ•´çš„æ—¥å¿—å’Œç›‘æ§
5. **ğŸ†• æ™ºèƒ½åŒ–ä¼˜å…ˆ**: ä¼˜å…ˆä½¿ç”¨LLMèƒ½åŠ›è€Œéç¡¬ç¼–ç è§„åˆ™

---

**ç›¸å…³æ–‡æ¡£**:
- [æç¤ºè¯ç³»ç»Ÿä¸æ ¸å¿ƒå·¥ä½œæµç¨‹](./3-æç¤ºè¯ç³»ç»Ÿä¸æ ¸å¿ƒå·¥ä½œæµç¨‹.md)
- [å•æ­¥æ‰§è¡Œå¤±è´¥åçš„è¯„ä¼°åæ€ä¸é‡æ–°è§„åˆ’](./2-å•æ­¥æ‰§è¡Œå¤±è´¥åçš„è¯„ä¼°åæ€ä¸é‡æ–°è§„åˆ’.md)
- [ä¸¤é˜¶æ®µè§„åˆ’æç¤ºè¯è®¾è®¡è¯´æ˜](../æ–°çš„æ€è€ƒ/ä¸¤é˜¶æ®µè§„åˆ’æç¤ºè¯è®¾è®¡.md)

**ä»£ç ç¤ºä¾‹**:
- [src/core/planner.rs](../../src/core/planner.rs) - è§„åˆ’æ ¸å¿ƒå®ç°
- [src/llm/prompts.rs](../../src/llm/prompts.rs) - æç¤ºè¯æ¨¡æ¿
- [config.dev.toml](../../config.dev.toml) - é…ç½®ç¤ºä¾‹
