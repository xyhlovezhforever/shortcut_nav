# 任务编排服务 - 核心模块代码映射文档

> 文档版本: 2025-12-29
> 分支版本: parallel_execution_version
> 对应流程文档: [当前项目流程_2025_12_29.md](./当前项目流程_2025_12_29.md)

---

## 目录

1. [核心编排模块](#1-核心编排模块)
2. [规划器模块](#2-规划器模块)
3. [执行器模块](#3-执行器模块)
4. [评估器模块](#4-评估器模块)
5. [反思器模块](#5-反思器模块)
6. [并行执行模块](#6-并行执行模块)
7. [LLM集成模块](#7-llm集成模块)
8. [工具服务集成](#8-工具服务集成)
9. [服务发现模块](#9-服务发现模块)
10. [配置与状态管理](#10-配置与状态管理)
11. [API接口层](#11-api接口层)
12. [工具类与辅助模块](#12-工具类与辅助模块)

---

## 1. 核心编排模块

### 1.1 Orchestrator（编排器）

**主文件**: [src/core/orchestrator.rs](../../src/core/orchestrator.rs)

#### 核心结构定义

```rust
// 位置: src/core/orchestrator.rs:35-55
pub struct Orchestrator {
    planner: Arc<Planner>,
    executor: Arc<Executor>,
    evaluator: Arc<Evaluator>,
    reflector: Arc<Reflector>,
    state_manager: Arc<TaskStateManager>,
    config: Arc<OrchestratorConfig>,
    // ...
}
```

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [orchestrator.rs:85-120](../../src/core/orchestrator.rs#L85-L120) | 创建编排器实例 |
| `orchestrate()` | [orchestrator.rs:135-150](../../src/core/orchestrator.rs#L135-L150) | 简化版编排入口 |
| `orchestrate_with_id()` | [orchestrator.rs:165-180](../../src/core/orchestrator.rs#L165-L180) | 带任务ID的编排入口 |
| `orchestrate_with_id_and_metadata()` | [orchestrator.rs:291-850](../../src/core/orchestrator.rs#L291-L850) | 完整编排核心逻辑（主循环） |
| `set_task_event_sender()` | [orchestrator.rs:195-210](../../src/core/orchestrator.rs#L195-L210) | 设置任务事件发送器 |

#### 主循环执行流程

**代码位置**: [orchestrator.rs:450-720](../../src/core/orchestrator.rs#L450-L720)

```rust
// Reflective Planning 主循环
for round in 1..=max_reflection_rounds {
    // 1. 规划阶段 (Line ~470-520)
    // 2. 执行阶段 (Line ~530-600)
    // 3. 评估阶段 (Line ~610-650)
    // 4. 反思阶段 (Line ~660-710)
    // 5. 决策是否重新规划 (Line ~715-720)
}
```

#### 事件发送机制

**代码位置**: [orchestrator.rs:860-1050](../../src/core/orchestrator.rs#L860-L1050)

**关键事件**:
- `send_round_started()`: Line ~870
- `send_llm_call_started()`: Line ~890
- `send_tools_selected()`: Line ~920
- `send_plan_generated()`: Line ~940
- `send_step_started()`: Line ~965
- `send_step_completed()`: Line ~985
- `send_evaluation_completed()`: Line ~1010
- `send_reflection_completed()`: Line ~1030

---

## 2. 规划器模块

### 2.1 Planner（规划器）

**主文件**: [src/core/planner.rs](../../src/core/planner.rs)

#### 核心结构定义

```rust
// 位置: src/core/planner.rs:45-65
pub struct Planner {
    llm_client: Arc<dyn LlmClient>,
    config: Arc<PlannerConfig>,
    debug_logger: Option<Arc<DebugLogger>>,
    builtin_workflows: Vec<WorkflowTemplate>,
}
```

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [planner.rs:75-95](../../src/core/planner.rs#L75-L95) | 创建规划器实例 |
| `plan()` | [planner.rs:150-280](../../src/core/planner.rs#L150-L280) | 主规划入口（含两阶段判断） |
| `select_tools_for_task()` | [planner.rs:320-480](../../src/core/planner.rs#L320-L480) | 两阶段规划 - 工具筛选 |
| `generate_plan_with_tools()` | [planner.rs:520-680](../../src/core/planner.rs#L520-L680) | 两阶段规划 - 生成计划 |
| `parse_execution_plan()` | [planner.rs:780-920](../../src/core/planner.rs#L780-L920) | 解析LLM返回的执行计划JSON |
| `validate_plan()` | [planner.rs:950-1050](../../src/core/planner.rs#L950-L1050) | 验证计划合法性 |

#### 两阶段规划流程

**阶段1: 工具筛选**
- **入口**: `select_tools_for_task()` - Line 320
- **提示词构建**: `build_tool_selection_prompt()` - Line 1120
- **结果解析**: `parse_tool_selection_result()` - Line 1250

**阶段2: 计划生成**
- **入口**: `generate_plan_with_tools()` - Line 520
- **提示词构建**: 调用 `PlanningPromptBuilder` - Line 550
- **结果解析**: `parse_execution_plan()` - Line 780

#### 内置工作流匹配

**代码位置**: [planner.rs:1380-1480](../../src/core/planner.rs#L1380-L1480)

```rust
fn match_builtin_workflow(
    &self,
    task_description: &str,
) -> Option<&WorkflowTemplate>
```

### 2.2 提示词管理

**主文件**: [src/llm/planning_prompts.rs](../../src/llm/planning_prompts.rs)

#### 核心组件

| 组件 | 代码位置 | 功能说明 |
|------|---------|---------|
| `PlanningPromptBuilder` | [planning_prompts.rs:35-120](../../src/llm/planning_prompts.rs#L35-L120) | 规划提示词构建器 |
| `build_system_prompt()` | [planning_prompts.rs:180-250](../../src/llm/planning_prompts.rs#L180-L250) | 构建系统提示词 |
| `build_user_prompt()` | [planning_prompts.rs:280-420](../../src/llm/planning_prompts.rs#L280-L420) | 构建用户提示词 |
| `build_tool_selection_prompt()` | [planning_prompts.rs:480-580](../../src/llm/planning_prompts.rs#L480-L580) | 构建工具筛选提示词 |
| `build_replanning_prompt()` | [planning_prompts.rs:650-780](../../src/llm/planning_prompts.rs#L650-L780) | 构建重新规划提示词 |

#### 场景引导系统

**文件**: [src/llm/scene_guidance.rs](../../src/llm/scene_guidance.rs)

**代码位置**: [scene_guidance.rs:1-450](../../src/llm/scene_guidance.rs#L1-L450)

**功能**: 根据任务类型提供场景化规划指导

---

## 3. 执行器模块

### 3.1 Executor（主执行器）

**主文件**: [src/core/executor.rs](../../src/core/executor.rs)

#### 核心结构定义

```rust
// 位置: src/core/executor.rs:55-75
pub struct Executor {
    tool_client: Arc<dyn ToolClient>,
    parallel_executor: Option<Arc<ParallelExecutor>>,
    config: Arc<ExecutorConfig>,
    debug_logger: Option<Arc<DebugLogger>>,
    // ...
}
```

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [executor.rs:95-125](../../src/core/executor.rs#L95-L125) | 创建执行器实例 |
| `execute_plan()` | [executor.rs:180-220](../../src/core/executor.rs#L180-L220) | 主执行入口（简化版） |
| `execute_plan_with_context()` | [executor.rs:265-330](../../src/core/executor.rs#L265-L330) | 完整执行入口（含并行判断） |
| `should_use_parallel_execution()` | [executor.rs:1797-1870](../../src/core/executor.rs#L1797-L1870) | 判断是否使用并行执行 |
| `execute_plan_serial_with_context()` | [executor.rs:450-780](../../src/core/executor.rs#L450-L780) | 串行执行流程 |
| `execute_plan_parallel_with_context()` | [executor.rs:850-980](../../src/core/executor.rs#L850-L980) | 并行执行流程（调用ParallelExecutor） |

#### 串行执行核心逻辑

**代码位置**: [executor.rs:450-780](../../src/core/executor.rs#L450-L780)

**执行流程**:
```rust
// 1. 依赖检查 (Line ~520-550)
// 2. 参数解析 (Line ~570-600, 调用 ParameterResolver)
// 3. 工具调用 (Line ~620-680)
// 4. 结果保存 (Line ~690-720)
// 5. 输出流转 (Line ~730-760)
```

#### 步骤内并行执行（Actions）

**代码位置**: [executor.rs:1992-2180](../../src/core/executor.rs#L1992-L2180)

```rust
async fn execute_step_with_actions(
    &self,
    step: &PlanStep,
    context: &ExecutionContext,
    tool_map: &HashMap<String, ToolInfo>,
) -> Result<StepResult>
```

**关键点**:
- Line ~2020: 并行执行所有actions
- Line ~2080: 聚合action结果
- Line ~2120: 支持占位符 `{{action_id.output}}`

#### 工具调用封装

**代码位置**: [executor.rs:1100-1250](../../src/core/executor.rs#L1100-L1250)

```rust
async fn execute_tool_call(
    &self,
    tool_id: &str,
    parameters: &HashMap<String, String>,
) -> Result<ToolResponse>
```

### 3.2 参数解析器

**主文件**: [src/core/parameter_resolver.rs](../../src/core/parameter_resolver.rs)

#### 核心功能

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `resolve_parameters()` | [parameter_resolver.rs:45-180](../../src/core/parameter_resolver.rs#L45-L180) | 解析并替换步骤参数 |
| `process_parameter_value()` | [parameter_resolver.rs:220-350](../../src/core/parameter_resolver.rs#L220-L350) | 处理单个参数值（占位符替换） |
| `extract_step_reference()` | [parameter_resolver.rs:380-450](../../src/core/parameter_resolver.rs#L380-L450) | 提取步骤引用（解析 `${step_id}`） |
| `inject_metadata_parameters()` | [parameter_resolver.rs:520-620](../../src/core/parameter_resolver.rs#L520-L620) | 从metadata注入缺失参数 |

#### 占位符支持模式

**代码位置**: [parameter_resolver.rs:680-820](../../src/core/parameter_resolver.rs#L680-L820)

**支持格式**:
- `${step_1}`: 引用步骤1的完整输出
- `${step_1.output}`: 引用步骤1的output字段
- `{{action_1_1.output}}`: 引用action的输出
- `${metadata.key_name}`: 引用元数据字段

### 3.3 执行上下文管理

**主文件**: [src/core/execution_context.rs](../../src/core/execution_context.rs)

#### 核心结构定义

```rust
// 位置: src/core/execution_context.rs:35-55
pub struct ExecutionContext {
    plan_id: String,
    metadata: Arc<DashMap<String, String>>,
    step_results: Arc<DashMap<String, StepResult>>,
    action_results: Arc<DashMap<String, ActionResult>>,
    reflection_history: Arc<DashMap<u32, ReflectionResult>>,
}
```

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [execution_context.rs:75-95](../../src/core/execution_context.rs#L75-L95) | 创建执行上下文 |
| `set_step_result()` | [execution_context.rs:120-145](../../src/core/execution_context.rs#L120-L145) | 保存步骤执行结果 |
| `get_step_output()` | [execution_context.rs:165-190](../../src/core/execution_context.rs#L165-L190) | 获取步骤输出 |
| `sync_step_output_to_runtime_metadata()` | [execution_context.rs:245-380](../../src/core/execution_context.rs#L245-L380) | 流转输出到metadata |
| `get_all_metadata()` | [execution_context.rs:420-445](../../src/core/execution_context.rs#L420-L445) | 获取所有元数据 |

#### 数据流转机制

**代码位置**: [execution_context.rs:245-380](../../src/core/execution_context.rs#L245-L380)

**流程**:
```rust
// 1. 获取步骤执行结果 (Line ~260)
// 2. 解析输出JSON (Line ~280)
// 3. 根据output_params提取字段 (Line ~310)
// 4. 写入runtime_metadata (Line ~340)
// 5. 供后续步骤引用 (Line ~370)
```

---

## 4. 评估器模块

### 4.1 Evaluator（评估器）

**主文件**: [src/core/evaluator.rs](../../src/core/evaluator.rs)

#### 核心结构定义

```rust
// 位置: src/core/evaluator.rs:35-50
pub struct Evaluator {
    llm_client: Arc<dyn LlmClient>,
    config: Arc<EvaluatorConfig>,
    debug_logger: Option<Arc<DebugLogger>>,
}
```

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [evaluator.rs:65-80](../../src/core/evaluator.rs#L65-L80) | 创建评估器实例 |
| `evaluate()` | [evaluator.rs:120-280](../../src/core/evaluator.rs#L120-L280) | 主评估入口 |
| `build_evaluation_prompt()` | [evaluator.rs:320-520](../../src/core/evaluator.rs#L320-L520) | 构建评估提示词 |
| `parse_evaluation_result()` | [evaluator.rs:580-750](../../src/core/evaluator.rs#L580-L750) | 解析评估结果JSON |
| `calculate_overall_score()` | [evaluator.rs:820-880](../../src/core/evaluator.rs#L820-L880) | 计算总体评分 |

#### 评估数据结构

**代码位置**: [evaluator.rs:950-1050](../../src/core/evaluator.rs#L950-L1050)

```rust
// 评估维度
pub struct EvaluationDimensions {
    pub completeness: f32,   // 完整性 (0-100)
    pub correctness: f32,    // 正确性 (0-100)
    pub efficiency: f32,     // 效率 (0-100)
    pub reliability: f32,    // 可靠性 (0-100)
}

// 评估结果
pub struct EvaluationResult {
    pub overall_score: f32,
    pub is_successful: bool,
    pub dimensions: EvaluationDimensions,
    pub successes: Vec<String>,
    pub failures: Vec<String>,
    pub improvement_suggestions: Vec<String>,
}
```

#### 评估提示词构建

**代码位置**: [evaluator.rs:320-520](../../src/core/evaluator.rs#L320-L520)

**内容包括**:
- 任务描述 (Line ~350)
- 执行计划 (Line ~380)
- 执行结果 (Line ~420)
- 评估维度定义 (Line ~460)
- 输出格式要求 (Line ~490)

---

## 5. 反思器模块

### 5.1 Reflector（反思器）

**主文件**: [src/core/reflector.rs](../../src/core/reflector.rs)

#### 核心结构定义

```rust
// 位置: src/core/reflector.rs:45-60
pub struct Reflector {
    llm_client: Arc<dyn LlmClient>,
    config: Arc<ReflectorConfig>,
    debug_logger: Option<Arc<DebugLogger>>,
}
```

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [reflector.rs:75-90](../../src/core/reflector.rs#L75-L90) | 创建反思器实例 |
| `reflect()` | [reflector.rs:130-320](../../src/core/reflector.rs#L130-L320) | 任务级反思 |
| `reflect_on_step_failure()` | [reflector.rs:380-680](../../src/core/reflector.rs#L380-L680) | 步骤级反思 |
| `build_reflection_prompt()` | [reflector.rs:750-920](../../src/core/reflector.rs#L750-L920) | 构建任务级反思提示词 |
| `build_step_reflection_prompt()` | [reflector.rs:980-1180](../../src/core/reflector.rs#L980-L1180) | 构建步骤级反思提示词 |
| `parse_reflection_result()` | [reflector.rs:1250-1420](../../src/core/reflector.rs#L1250-L1420) | 解析任务级反思结果 |
| `parse_step_reflection_result()` | [reflector.rs:1480-1680](../../src/core/reflector.rs#L1480-L1680) | 解析步骤级反思结果 |

#### 任务级反思流程

**代码位置**: [reflector.rs:130-320](../../src/core/reflector.rs#L130-L320)

**输入数据**:
```rust
// Line ~145-165
pub struct ReflectionContext {
    task_description: String,
    current_plan: ExecutionPlan,
    execution_result: PlanExecutionResult,
    evaluation: EvaluationResult,
    round: u32,
}
```

**反思输出**:
```rust
// Line ~1750-1780
pub struct ReflectionResult {
    pub root_causes: Vec<String>,                    // 根本原因
    pub incorrect_assumptions: Vec<String>,          // 错误假设
    pub alternative_approaches: Vec<String>,         // 替代方法
    pub optimization_suggestions: Vec<OptimizationSuggestion>,
    pub should_replan: bool,                         // 是否重新规划
}
```

#### 步骤级反思流程

**代码位置**: [reflector.rs:380-680](../../src/core/reflector.rs#L380-L680)

**失败原因分析**:
```rust
// Line ~1850-1920
pub enum FailureCauseCategory {
    ParameterError,       // 参数错误
    ToolNotFound,         // 工具不存在
    DependencyNotMet,     // 依赖未满足
    ToolExecutionFailed,  // 工具执行失败
    Timeout,              // 超时
    Unknown,              // 未知错误
}
```

**修复建议**:
```rust
// Line ~1980-2020
pub enum StepAction {
    RetryWithAdjustedParams(HashMap<String, String>),  // 调整参数重试
    RetryWithAlternativeTool(String),                  // 使用备选工具
    ReplanEntireTask,                                  // 重新规划任务
    StopExecution,                                     // 停止执行
}
```

#### 步骤重试机制

**代码位置**: [reflector.rs:2150-2350](../../src/core/reflector.rs#L2150-L2350)

**配置参数**:
- `max_step_retries`: 单个步骤最大重试次数（默认3）
- `max_task_replanning_attempts`: 任务最大重新规划次数（默认1）

---

## 6. 并行执行模块

### 6.1 ParallelExecutor（并行执行器）

**主文件**: [src/core/parallel_executor.rs](../../src/core/parallel_executor.rs)

#### 核心结构定义

```rust
// 位置: src/core/parallel_executor.rs:55-75
pub struct ParallelExecutor {
    tool_client: Arc<dyn ToolClient>,
    semaphore: Arc<Semaphore>,
    max_concurrent: usize,
    debug_logger: Option<Arc<DebugLogger>>,
}
```

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [parallel_executor.rs:95-120](../../src/core/parallel_executor.rs#L95-L120) | 创建并行执行器 |
| `execute_plan_parallel()` | [parallel_executor.rs:180-480](../../src/core/parallel_executor.rs#L180-L480) | 并行执行主流程 |
| `build_dependency_graph()` | [parallel_executor.rs:550-680](../../src/core/parallel_executor.rs#L550-L680) | 构建依赖图 |
| `topological_sort_batched()` | [parallel_executor.rs:750-920](../../src/core/parallel_executor.rs#L750-L920) | 拓扑排序分批 |
| `execute_batch_parallel()` | [parallel_executor.rs:980-1180](../../src/core/parallel_executor.rs#L980-L1180) | 并行执行单个批次 |
| `has_parallelizable_steps()` | [parallel_executor.rs:1320-1420](../../src/core/parallel_executor.rs#L1320-L1420) | 判断是否存在可并行步骤 |

#### 依赖图数据结构

**代码位置**: [parallel_executor.rs:1520-1680](../../src/core/parallel_executor.rs#L1520-L1680)

```rust
pub struct DependencyGraph {
    nodes: HashSet<String>,                      // 所有步骤节点
    edges: HashMap<String, Vec<String>>,         // 依赖边: step_id -> [dependent_steps]
    in_degrees: HashMap<String, usize>,          // 入度统计
}
```

#### 拓扑排序算法

**代码位置**: [parallel_executor.rs:750-920](../../src/core/parallel_executor.rs#L750-L920)

**算法流程**:
```rust
// 1. 初始化入度统计 (Line ~770-800)
// 2. 找出所有入度为0的步骤 (Line ~820-850)
// 3. 加入当前批次 (Line ~860-880)
// 4. 更新依赖步骤的入度 (Line ~890-910)
// 5. 重复直到所有步骤处理完毕 (Line ~750)
```

#### 并发控制机制

**代码位置**: [parallel_executor.rs:980-1180](../../src/core/parallel_executor.rs#L980-L1180)

**使用Semaphore限流**:
```rust
// Line ~1020-1050
let semaphore = self.semaphore.clone();
let _permit = semaphore.acquire().await?;  // 获取并发许可
// 执行步骤...
// permit自动释放
```

#### 批次执行详情

**代码位置**: [parallel_executor.rs:980-1180](../../src/core/parallel_executor.rs#L980-L1180)

**执行流程**:
```rust
// 1. 为批次内每个步骤创建异步任务 (Line ~1000-1050)
// 2. 使用join_all并行等待所有任务 (Line ~1080)
// 3. 收集并检查结果 (Line ~1100-1140)
// 4. 保存结果到执行上下文 (Line ~1150-1170)
```

---

## 7. LLM集成模块

### 7.1 统一LLM客户端

**主文件**: [src/llm/unified_client.rs](../../src/llm/unified_client.rs)

#### 核心结构定义

```rust
// 位置: src/llm/unified_client.rs:45-70
pub struct UnifiedLlmClient {
    grpc_client: Option<Arc<GrpcLlmClient>>,
    http_client: Option<Arc<HttpLlmClient>>,
    protocol: LlmProtocol,
    config: Arc<LlmConfig>,
}
```

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [unified_client.rs:95-160](../../src/llm/unified_client.rs#L95-L160) | 创建统一客户端（支持gRPC/HTTP） |
| `call()` | [unified_client.rs:220-320](../../src/llm/unified_client.rs#L220-L320) | 普通调用（根据协议路由） |
| `call_streaming()` | [unified_client.rs:380-580](../../src/llm/unified_client.rs#L380-L580) | 流式调用 |
| `call_with_streaming_callback()` | [unified_client.rs:650-850](../../src/llm/unified_client.rs#L650-L850) | 带回调的流式调用 |

#### 协议选择逻辑

**代码位置**: [unified_client.rs:95-160](../../src/llm/unified_client.rs#L95-L160)

```rust
// 根据配置决定使用哪个协议
match config.protocol.as_str() {
    "grpc" => {
        grpc_client = Some(Arc::new(GrpcLlmClient::new(config)));
    }
    "http" => {
        http_client = Some(Arc::new(HttpLlmClient::new(config)));
    }
    _ => // 默认使用gRPC
}
```

### 7.2 gRPC LLM客户端

**主文件**: [src/llm/grpc_client.rs](../../src/llm/grpc_client.rs)

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [grpc_client.rs:65-95](../../src/llm/grpc_client.rs#L65-L95) | 创建gRPC客户端 |
| `call()` | [grpc_client.rs:150-280](../../src/llm/grpc_client.rs#L150-L280) | gRPC同步调用 |
| `call_streaming()` | [grpc_client.rs:350-620](../../src/llm/grpc_client.rs#L350-L620) | gRPC流式调用 |
| `build_request()` | [grpc_client.rs:720-820](../../src/llm/grpc_client.rs#L720-L820) | 构建gRPC请求 |

#### 流式响应处理

**代码位置**: [grpc_client.rs:450-580](../../src/llm/grpc_client.rs#L450-L580)

```rust
// 1. 发起流式请求 (Line ~470)
// 2. 循环接收流式响应 (Line ~490-550)
// 3. 拼接delta内容 (Line ~520)
// 4. 调用回调函数 (Line ~540)
// 5. 返回完整结果 (Line ~570)
```

### 7.3 HTTP LLM客户端

**主文件**: [src/llm/client.rs](../../src/llm/client.rs)

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [client.rs:55-80](../../src/llm/client.rs#L55-L80) | 创建HTTP客户端 |
| `call()` | [client.rs:130-280](../../src/llm/client.rs#L130-L280) | HTTP同步调用 |
| `call_streaming()` | [client.rs:350-650](../../src/llm/client.rs#L350-L650) | HTTP流式调用（SSE） |

### 7.4 LLM客户端 Trait

**主文件**: [src/llm/traits.rs](../../src/llm/traits.rs)

**代码位置**: [traits.rs:1-180](../../src/llm/traits.rs#L1-L180)

```rust
#[async_trait]
pub trait LlmClient: Send + Sync {
    async fn call(
        &self,
        system_prompt: &str,
        user_prompt: &str,
        metadata: Option<&HashMap<String, String>>,
    ) -> Result<String>;

    async fn call_streaming(
        &self,
        system_prompt: &str,
        user_prompt: &str,
        metadata: Option<&HashMap<String, String>>,
    ) -> Result<String>;

    async fn call_with_streaming_callback<F>(
        &self,
        system_prompt: &str,
        user_prompt: &str,
        metadata: Option<&HashMap<String, String>>,
        callback: F,
    ) -> Result<String>
    where
        F: Fn(&str) + Send + Sync;
}
```

### 7.5 服务发现集成

**主文件**: [src/llm/client_with_discovery.rs](../../src/llm/client_with_discovery.rs)

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [client_with_discovery.rs:75-120](../../src/llm/client_with_discovery.rs#L75-L120) | 创建支持服务发现的客户端 |
| `get_endpoint()` | [client_with_discovery.rs:220-320](../../src/llm/client_with_discovery.rs#L220-L320) | 获取服务端点（含降级逻辑） |

**降级策略** (Line ~250-300):
```rust
// 1. 尝试服务发现
// 2. 失败则使用 fallback_endpoint
// 3. 再失败则使用主 endpoint
```

---

## 8. 工具服务集成

### 8.1 统一工具客户端

**主文件**: [src/tool/unified_client.rs](../../src/tool/unified_client.rs)

#### 核心结构定义

```rust
// 位置: src/tool/unified_client.rs:45-65
pub struct UnifiedToolClient {
    grpc_client: Option<Arc<GrpcToolClient>>,
    http_client: Option<Arc<HttpToolClient>>,
    protocol: ToolProtocol,
    config: Arc<ToolServiceConfig>,
}
```

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [unified_client.rs:85-140](../../src/tool/unified_client.rs#L85-L140) | 创建统一工具客户端 |
| `list_tools()` | [unified_client.rs:200-280](../../src/tool/unified_client.rs#L200-L280) | 获取工具列表 |
| `execute_tool()` | [unified_client.rs:350-480](../../src/tool/unified_client.rs#L350-L480) | 执行工具 |
| `get_tool_info()` | [unified_client.rs:550-650](../../src/tool/unified_client.rs#L550-L650) | 获取工具信息 |

### 8.2 gRPC工具客户端

**主文件**: [src/tool/grpc_client.rs](../../src/tool/grpc_client.rs)

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [grpc_client.rs:55-85](../../src/tool/grpc_client.rs#L55-L85) | 创建gRPC工具客户端 |
| `execute_tool()` | [grpc_client.rs:150-320](../../src/tool/grpc_client.rs#L150-L320) | 执行工具（gRPC） |
| `list_tools()` | [grpc_client.rs:380-520](../../src/tool/grpc_client.rs#L380-L520) | 获取工具列表（gRPC） |

### 8.3 HTTP工具客户端

**主文件**: [src/tool/client.rs](../../src/tool/client.rs)

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [client.rs:45-70](../../src/tool/client.rs#L45-L70) | 创建HTTP工具客户端 |
| `execute_tool()` | [client.rs:120-280](../../src/tool/client.rs#L120-L280) | 执行工具（HTTP） |
| `list_tools()` | [client.rs:340-480](../../src/tool/client.rs#L340-L480) | 获取工具列表（HTTP） |

### 8.4 工具数据结构

**主文件**: [src/tool/mod.rs](../../src/tool/mod.rs)

**代码位置**: [mod.rs:150-250](../../src/tool/mod.rs#L150-L250)

```rust
// 工具信息
pub struct ToolInfo {
    pub id: String,
    pub name: String,
    pub description: String,
    pub input_params: Vec<ParameterInfo>,
    pub output_params: Vec<ParameterInfo>,
    pub category: String,
}

// 参数信息
pub struct ParameterInfo {
    pub name: String,
    pub param_type: String,
    pub description: String,
    pub required: bool,
    pub default_value: Option<String>,
}

// 工具响应
pub struct ToolResponse {
    pub status: String,      // "success" 或 "error"
    pub result: String,      // 执行结果（JSON格式）
    pub error_message: Option<String>,
}
```

---

## 9. 服务发现模块

### 9.1 Consul注册中心

**主文件**: [src/consul/registry.rs](../../src/consul/registry.rs)

#### 核心结构定义

```rust
// 位置: src/consul/registry.rs:35-55
pub struct ConsulRegistry {
    client: reqwest::Client,
    consul_addr: String,
    service_name: String,
    service_host: String,
    service_port: u16,
    health_check_url: String,
}
```

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [registry.rs:75-105](../../src/consul/registry.rs#L75-L105) | 创建Consul注册客户端 |
| `register()` | [registry.rs:150-320](../../src/consul/registry.rs#L150-L320) | 注册服务到Consul |
| `deregister()` | [registry.rs:380-450](../../src/consul/registry.rs#L380-L450) | 从Consul注销服务 |
| `send_heartbeat()` | [registry.rs:520-620](../../src/consul/registry.rs#L520-L620) | 发送心跳（更新TTL） |

#### 服务注册数据结构

**代码位置**: [registry.rs:720-820](../../src/consul/registry.rs#L720-L820)

```rust
pub struct ServiceRegistration {
    pub ID: String,
    pub Name: String,
    pub Address: String,
    pub Port: u16,
    pub Tags: Vec<String>,
    pub Check: HealthCheck,
}

pub struct HealthCheck {
    pub HTTP: String,
    pub Interval: String,
    pub Timeout: String,
}
```

### 9.2 服务发现

**主文件**: [src/consul/discovery.rs](../../src/consul/discovery.rs)

#### 核心结构定义

```rust
// 位置: src/consul/discovery.rs:45-70
pub struct ServiceDiscovery {
    consul_registry: Arc<ConsulRegistry>,
    load_balance_strategy: LoadBalanceStrategy,
    cache: Arc<DashMap<String, CachedServiceInstances>>,
    cache_ttl_secs: u64,
}
```

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [discovery.rs:95-115](../../src/consul/discovery.rs#L95-L115) | 创建服务发现客户端 |
| `discover()` | [discovery.rs:180-380](../../src/consul/discovery.rs#L180-L380) | 发现服务实例（含缓存） |
| `discover_from_consul()` | [discovery.rs:450-620](../../src/consul/discovery.rs#L450-L620) | 从Consul查询健康实例 |
| `select_instance()` | [discovery.rs:720-880](../../src/consul/discovery.rs#L720-L880) | 根据负载均衡策略选择实例 |

#### 负载均衡策略

**代码位置**: [discovery.rs:950-1150](../../src/consul/discovery.rs#L950-L1150)

```rust
pub enum LoadBalanceStrategy {
    RoundRobin,   // 轮询 (Line ~980-1020)
    Random,       // 随机 (Line ~1040-1070)
    Sticky,       // 粘性 (Line ~1090-1130)
}
```

#### 服务实例缓存

**代码位置**: [discovery.rs:1250-1350](../../src/consul/discovery.rs#L1250-L1350)

```rust
struct CachedServiceInstances {
    instances: Vec<ServiceInstance>,
    cached_at: Instant,
    ttl_secs: u64,
}

impl CachedServiceInstances {
    fn is_expired(&self) -> bool {
        self.cached_at.elapsed().as_secs() > self.ttl_secs
    }
}
```

---

## 10. 配置与状态管理

### 10.1 配置管理

**主文件**: [src/config/mod.rs](../../src/config/mod.rs)

#### 核心结构定义

**代码位置**: [config/mod.rs:35-250](../../src/config/mod.rs#L35-L250)

```rust
// 顶层配置
pub struct AppConfig {
    pub server: ServerConfig,
    pub llm: LlmConfig,
    pub tool_service: ToolServiceConfig,
    pub orchestrator: OrchestratorConfig,
    pub reflection: ReflectionConfig,
    pub response: ResponseConfig,
    pub debug: DebugConfig,
    pub logging: LoggingConfig,
    pub consul: Option<ConsulConfig>,
    pub database_service: Option<DatabaseServiceConfig>,
    pub kafka_service: Option<KafkaServiceConfig>,
}
```

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `load()` | [config/mod.rs:45-120](../../src/config/mod.rs#L45-L120) | 加载配置（多源合并） |
| `load_from_file()` | [config/mod.rs:150-210](../../src/config/mod.rs#L150-L210) | 从文件加载配置 |
| `merge_from_env()` | [config/mod.rs:250-350](../../src/config/mod.rs#L250-L350) | 从环境变量覆盖配置 |

#### 配置加载优先级

**代码位置**: [config/mod.rs:45-120](../../src/config/mod.rs#L45-L120)

```rust
// 优先级（从低到高）:
// 1. 默认配置文件 config.toml
// 2. 环境特定配置 config.{env}.toml
// 3. 环境变量 APP_*
```

#### 编排器配置

**代码位置**: [config/mod.rs:450-580](../../src/config/mod.rs#L450-L580)

```rust
pub struct OrchestratorConfig {
    pub max_reflection_rounds: u32,
    pub task_timeout_secs: u64,
    pub enable_auto_reflection: bool,
    pub success_threshold: f32,
    pub max_concurrent_tasks: usize,

    // 两阶段规划
    pub enable_two_stage_planning: bool,
    pub two_stage_tool_threshold: usize,
    pub enable_builtin_workflows: bool,
    pub tool_selection_threshold: f32,

    // 并行执行
    pub enable_parallel_execution: bool,
    pub parallel_max_concurrent: usize,
    pub parallel_min_steps: usize,
}
```

### 10.2 任务状态管理

**主文件**: [src/state/task_state.rs](../../src/state/task_state.rs)

#### 核心结构定义

```rust
// 位置: src/state/task_state.rs:35-65
pub struct TaskStateManager {
    tasks: Arc<DashMap<String, Task>>,
    max_tasks: usize,
}

pub struct Task {
    pub task_id: String,
    pub task_description: String,
    pub status: TaskStatus,
    pub metadata: HashMap<String, String>,
    pub context: TaskContext,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}
```

#### 任务状态定义

**代码位置**: [task_state.rs:150-180](../../src/state/task_state.rs#L150-L180)

```rust
pub enum TaskStatus {
    Planning,      // 规划中
    Executing,     // 执行中
    Evaluating,    // 评估中
    Reflecting,    // 反思中
    Completed,     // 已完成
    Failed,        // 已失败
}
```

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [task_state.rs:95-110](../../src/state/task_state.rs#L95-L110) | 创建状态管理器 |
| `register_task()` | [task_state.rs:150-210](../../src/state/task_state.rs#L150-L210) | 注册新任务 |
| `update_status()` | [task_state.rs:250-290](../../src/state/task_state.rs#L250-L290) | 更新任务状态 |
| `get_task()` | [task_state.rs:330-360](../../src/state/task_state.rs#L330-L360) | 获取任务信息 |
| `remove_task()` | [task_state.rs:390-420](../../src/state/task_state.rs#L390-L420) | 移除任务 |

---

## 11. API接口层

### 11.1 HTTP API

**主文件**: [src/api/handlers.rs](../../src/api/handlers.rs)

#### 关键路由映射

| 路由 | 代码位置 | 功能说明 |
|------|---------|---------|
| `POST /api/v1/tasks` | [handlers.rs:85-250](../../src/api/handlers.rs#L85-L250) | 创建任务 |
| `GET /api/v1/tasks/:id` | [handlers.rs:320-420](../../src/api/handlers.rs#L320-L420) | 查询任务状态 |
| `GET /api/v1/tasks/:id/result` | [handlers.rs:480-620](../../src/api/handlers.rs#L480-L620) | 获取任务结果 |
| `GET /health` | [src/api/health.rs:20-45](../../src/api/health.rs#L20-L45) | 健康检查 |

#### 请求/响应数据结构

**主文件**: [src/api/models.rs](../../src/api/models.rs)

**代码位置**: [models.rs:1-350](../../src/api/models.rs#L1-L350)

```rust
// 创建任务请求
pub struct CreateTaskRequest {
    pub task_description: String,
    pub metadata: Option<HashMap<String, String>>,
    pub context: Option<TaskContext>,
}

// 创建任务响应
pub struct CreateTaskResponse {
    pub task_id: String,
    pub status: String,
}

// 任务状态响应
pub struct TaskStatusResponse {
    pub task_id: String,
    pub status: String,
    pub current_round: Option<u32>,
    pub current_step: Option<usize>,
    pub total_steps: Option<usize>,
}

// 任务结果响应
pub struct TaskResultResponse {
    pub task_id: String,
    pub is_success: bool,
    pub final_score: Option<f32>,
    pub total_rounds: u32,
    pub final_output: String,
    pub total_duration_secs: u64,
}
```

### 11.2 gRPC API

**主文件**: [src/grpc/server.rs](../../src/grpc/server.rs)

#### 关键RPC方法映射

| RPC方法 | 代码位置 | 功能说明 |
|---------|---------|---------|
| `ExecuteTask` | [server.rs:150-420](../../src/grpc/server.rs#L150-L420) | 执行任务（流式响应） |
| `GetTaskStatus` | [server.rs:480-580](../../src/grpc/server.rs#L480-L580) | 查询任务状态 |
| `GetTaskResult` | [server.rs:650-780](../../src/grpc/server.rs#L650-L780) | 获取任务结果 |

#### 流式事件处理

**代码位置**: [server.rs:220-380](../../src/grpc/server.rs#L220-L380)

**事件类型映射**:
```rust
// 任务开始 (Line ~230)
// 计划生成 (Line ~250)
// 步骤开始 (Line ~280)
// 步骤完成 (Line ~310)
// 评估完成 (Line ~340)
// 任务完成 (Line ~370)
```

#### Proto定义文件

**文件路径**: [proto/orchestrator.proto](../../proto/orchestrator.proto)

**主要消息定义**:
- `ExecuteTaskRequest`
- `ExecuteTaskResponse`
- `TaskStarted`
- `PlanGenerated`
- `StepStarted`
- `StepCompleted`
- `TaskCompleted`

---

## 12. 工具类与辅助模块

### 12.1 错误处理

**主文件**: [src/utils/errors.rs](../../src/utils/errors.rs)

#### 错误类型定义

**代码位置**: [errors.rs:1-280](../../src/utils/errors.rs#L1-L280)

```rust
#[derive(Debug, thiserror::Error)]
pub enum ServiceError {
    #[error("配置错误: {0}")]
    ConfigError(String),

    #[error("LLM调用失败: {0}")]
    LlmCallError(String),

    #[error("工具执行失败: {0}")]
    ToolExecutionError(String),

    #[error("步骤执行失败: {0}")]
    StepExecutionFailed(String),

    #[error("计划解析失败: {0}")]
    PlanParsingError(String),

    #[error("评估失败: {0}")]
    EvaluationError(String),

    #[error("反思失败: {0}")]
    ReflectionError(String),

    #[error("需要重新规划")]
    ReplanRequired,

    #[error("执行已停止")]
    ExecutionStopped,

    #[error("超时: {0}")]
    Timeout(String),

    #[error("服务发现失败: {0}")]
    ServiceDiscoveryError(String),

    // ... 更多错误类型
}
```

### 12.2 调试日志记录器

**主文件**: [src/utils/debug_logger.rs](../../src/utils/debug_logger.rs)

#### 核心结构定义

```rust
// 位置: src/utils/debug_logger.rs:35-55
pub struct DebugLogger {
    file_path: String,
    enabled: bool,
    file_handle: Arc<Mutex<Option<File>>>,
}
```

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [debug_logger.rs:75-105](../../src/utils/debug_logger.rs#L75-L105) | 创建调试日志记录器 |
| `log_llm_call()` | [debug_logger.rs:150-250](../../src/utils/debug_logger.rs#L150-L250) | 记录LLM调用详情 |
| `log_tool_call()` | [debug_logger.rs:320-420](../../src/utils/debug_logger.rs#L320-L420) | 记录工具调用详情 |
| `log_parallel_decision()` | [debug_logger.rs:480-580](../../src/utils/debug_logger.rs#L480-L580) | 记录并行执行决策 |

#### 日志格式

**代码位置**: [debug_logger.rs:650-850](../../src/utils/debug_logger.rs#L650-L850)

**记录内容包括**:
- 时间戳
- 调用类型（LLM/Tool/Parallel）
- 输入参数
- 原始输出
- 执行耗时
- 错误信息（如果有）

### 12.3 字符串工具

**主文件**: [src/utils/string_utils.rs](../../src/utils/string_utils.rs)

#### 关键函数映射

| 函数名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `clean_json_string()` | [string_utils.rs:25-120](../../src/utils/string_utils.rs#L25-L120) | 清理JSON字符串（去除Markdown标记） |
| `extract_json_block()` | [string_utils.rs:180-280](../../src/utils/string_utils.rs#L180-L280) | 提取JSON代码块 |
| `sanitize_parameter_value()` | [string_utils.rs:340-420](../../src/utils/string_utils.rs#L340-L420) | 清理参数值 |

### 12.4 消息格式化器

**主文件**: [src/message_formatter.rs](../../src/message_formatter.rs)

#### 核心功能

**代码位置**: [message_formatter.rs:1-650](../../src/message_formatter.rs#L1-L650)

**功能说明**:
- 根据响应模式（user/developer）格式化消息
- 提供友好的用户提示
- 开发模式显示详细技术信息

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `format_round_started()` | [message_formatter.rs:85-120](../../src/message_formatter.rs#L85-L120) | 格式化轮次开始消息 |
| `format_plan_generated()` | [message_formatter.rs:180-280](../../src/message_formatter.rs#L180-L280) | 格式化计划生成消息 |
| `format_step_started()` | [message_formatter.rs:350-420](../../src/message_formatter.rs#L350-L420) | 格式化步骤开始消息 |
| `format_evaluation()` | [message_formatter.rs:520-620](../../src/message_formatter.rs#L520-L620) | 格式化评估结果消息 |

### 12.5 日志系统

**主文件**: [src/logging/mod.rs](../../src/logging/mod.rs)

#### 日志初始化

**代码位置**: [logging/mod.rs:35-180](../../src/logging/mod.rs#L35-L180)

```rust
pub fn init_logging(config: &LoggingConfig) -> Result<()> {
    // 1. 配置控制台日志 (Line ~55-85)
    // 2. 配置文件日志 (Line ~95-125)
    // 3. 配置Kafka日志 (Line ~135-165)
    // 4. 初始化全局logger (Line ~170-175)
}
```

#### Kafka日志集成

**主文件**: [src/logging/kafka_logger.rs](../../src/logging/kafka_logger.rs)

**代码位置**: [kafka_logger.rs:1-420](../../src/logging/kafka_logger.rs#L1-L420)

**关键方法**:
- `log_task_event()`: Line ~85-150 - 记录任务事件
- `log_step_event()`: Line ~210-280 - 记录步骤事件
- `log_evaluation()`: Line ~340-400 - 记录评估结果

### 12.6 AI报告生成器

**主文件**: [src/ai_reporter.rs](../../src/ai_reporter.rs)

#### 核心功能

**代码位置**: [ai_reporter.rs:1-850](../../src/ai_reporter.rs#L1-L850)

**功能说明**:
- 基于执行结果生成结构化报告
- 支持多种报告格式（Markdown/JSON/HTML）
- 智能摘要生成

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `generate_task_report()` | [ai_reporter.rs:120-320](../../src/ai_reporter.rs#L120-L320) | 生成任务执行报告 |
| `summarize_execution()` | [ai_reporter.rs:420-580](../../src/ai_reporter.rs#L420-L580) | 生成执行摘要 |
| `format_as_markdown()` | [ai_reporter.rs:680-780](../../src/ai_reporter.rs#L680-L780) | 格式化为Markdown |

---

## 13. 数据库集成

### 13.1 数据库服务客户端

**主文件**: [src/database/client.rs](../../src/database/client.rs)

#### 核心结构定义

```rust
// 位置: src/database/client.rs:35-55
pub struct DatabaseClient {
    grpc_client: Option<Arc<GrpcDatabaseClient>>,
    config: Arc<DatabaseServiceConfig>,
}
```

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [client.rs:75-105](../../src/database/client.rs#L75-L105) | 创建数据库客户端 |
| `query()` | [client.rs:150-280](../../src/database/client.rs#L150-L280) | 执行查询 |
| `execute()` | [client.rs:340-470](../../src/database/client.rs#L340-L470) | 执行更新/插入 |

---

## 14. Kafka集成

### 14.1 Kafka生产者

**主文件**: [src/kafka/producer.rs](../../src/kafka/producer.rs)

#### 关键方法映射

| 方法名 | 代码位置 | 功能说明 |
|--------|---------|---------|
| `new()` | [producer.rs:55-95](../../src/kafka/producer.rs#L55-L95) | 创建Kafka生产者 |
| `send_message()` | [producer.rs:150-280](../../src/kafka/producer.rs#L150-L280) | 发送消息 |
| `send_audit_log()` | [producer.rs:340-480](../../src/kafka/producer.rs#L340-L480) | 发送审计日志 |

### 14.2 Kafka审计日志

**主文件**: [src/kafka/audit.rs](../../src/kafka/audit.rs)

#### 审计日志结构

**代码位置**: [audit.rs:35-120](../../src/kafka/audit.rs#L35-L120)

```rust
pub struct AuditLog {
    pub timestamp: DateTime<Utc>,
    pub service: String,
    pub module: String,
    pub level: String,
    pub message: String,
    pub task_id: Option<String>,
    pub fields: HashMap<String, serde_json::Value>,
}
```

---

## 15. 工作流模板

**主文件**: [src/workflow/mod.rs](../../src/workflow/mod.rs)

#### 内置工作流定义

**代码位置**: [workflow/mod.rs:1-650](../../src/workflow/mod.rs#L1-L650)

**内置模板**:
- 数据处理工作流 (Line ~85-180)
- 机器学习工作流 (Line ~220-320)
- API集成工作流 (Line ~360-450)
- 批处理工作流 (Line ~490-580)

#### 工作流匹配逻辑

**代码位置**: [workflow/mod.rs:680-850](../../src/workflow/mod.rs#L680-L850)

```rust
pub fn match_workflow(
    task_description: &str,
    templates: &[WorkflowTemplate],
) -> Option<&WorkflowTemplate> {
    // 基于关键词和相似度匹配
}
```

---

## 16. 主程序入口

### 16.1 HTTP服务入口

**主文件**: [src/main.rs](../../src/main.rs)

#### 启动流程

**代码位置**: [main.rs:1-350](../../src/main.rs#L1-L350)

```rust
#[tokio::main]
async fn main() -> Result<()> {
    // 1. 加载配置 (Line ~25-45)
    // 2. 初始化日志 (Line ~55-75)
    // 3. 创建核心组件 (Line ~85-180)
    // 4. 启动HTTP服务器 (Line ~220-280)
    // 5. 注册Consul（可选） (Line ~295-330)
    // 6. 优雅关闭处理 (Line ~335-345)
}
```

### 16.2 gRPC服务入口

**主文件**: [src/main_grpc.rs](../../src/main_grpc.rs)

#### 启动流程

**代码位置**: [main_grpc.rs:1-280](../../src/main_grpc.rs#L1-L280)

```rust
#[tokio::main]
async fn main() -> Result<()> {
    // 1. 加载配置 (Line ~25-45)
    // 2. 初始化日志 (Line ~55-75)
    // 3. 创建核心组件 (Line ~85-150)
    // 4. 启动gRPC服务器 (Line ~180-220)
    // 5. 优雅关闭处理 (Line ~235-270)
}
```

---

## 17. 构建脚本

**主文件**: [build.rs](../../build.rs)

#### Proto文件编译

**代码位置**: [build.rs:1-120](../../build.rs#L1-L120)

**编译的Proto文件**:
- `proto/orchestrator.proto` - 编排器gRPC接口
- `proto/tool_service.proto` - 工具服务gRPC接口
- `proto/common_service.proto` - 通用服务定义
- `proto/database.proto` - 数据库服务接口
- `proto/kafka_service.proto` - Kafka服务接口

**生成的Rust代码位置**: `target/[debug|release]/build/task-orchestration-service-*/out/`

---

## 18. 测试与示例

### 18.1 示例程序

| 示例文件 | 代码位置 | 功能说明 |
|---------|---------|---------|
| `client_test.rs` | [examples/client_test.rs](../../examples/client_test.rs) | 客户端基本使用示例 |
| `parallel_calculation_test.rs` | [examples/parallel_calculation_test.rs](../../examples/parallel_calculation_test.rs) | 并行计算测试 |
| `dag_parallel_test.rs` | [examples/dag_parallel_test.rs](../../examples/dag_parallel_test.rs) | DAG并行执行测试 |
| `auto_modeling_test.rs` | [examples/auto_modeling_test.rs](../../examples/auto_modeling_test.rs) | 自动建模测试 |
| `llm_streaming_test.rs` | [examples/llm_streaming_test.rs](../../examples/llm_streaming_test.rs) | LLM流式输出测试 |

---

## 附录：快速索引表

### A. 核心流程入口

| 功能 | 文件 | 行号 |
|------|------|------|
| 完整编排流程 | [orchestrator.rs](../../src/core/orchestrator.rs) | 291-850 |
| 两阶段规划 | [planner.rs](../../src/core/planner.rs) | 150-680 |
| 并行执行 | [parallel_executor.rs](../../src/core/parallel_executor.rs) | 180-480 |
| 步骤级反思 | [reflector.rs](../../src/core/reflector.rs) | 380-680 |

### B. 关键算法

| 算法 | 文件 | 行号 |
|------|------|------|
| 拓扑排序分批 | [parallel_executor.rs](../../src/core/parallel_executor.rs) | 750-920 |
| 参数占位符替换 | [parameter_resolver.rs](../../src/core/parameter_resolver.rs) | 220-350 |
| 依赖图构建 | [parallel_executor.rs](../../src/core/parallel_executor.rs) | 550-680 |

### C. 配置项

| 配置模块 | 文件 | 行号 |
|---------|------|------|
| 编排器配置 | [config/mod.rs](../../src/config/mod.rs) | 450-580 |
| 并行执行配置 | [config/mod.rs](../../src/config/mod.rs) | 520-560 |
| LLM配置 | [config/mod.rs](../../src/config/mod.rs) | 280-380 |

---

## 文档维护

**更新频率**: 每次重大版本发布
**维护人员**: 架构组
**最后更新**: 2025-12-29
**对应分支**: parallel_execution_version

**反馈渠道**: GitHub Issues

---

**提示**: 所有文件路径均相对于项目根目录 `d:\code\task-orchestration-service\`
