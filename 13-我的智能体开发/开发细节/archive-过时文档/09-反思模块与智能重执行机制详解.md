# åæ€æ¨¡å—ä¸æ™ºèƒ½é‡æ‰§è¡Œæœºåˆ¶è¯¦è§£

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç» Task Orchestration Service ä¸­çš„**åæ€æ¨¡å—ï¼ˆReflectorï¼‰**åŠ**æ™ºèƒ½é‡æ‰§è¡Œæœºåˆ¶**çš„å®Œæ•´å®ç°ç»†èŠ‚ï¼ŒåŒ…æ‹¬ï¼š
- å•æ­¥åæ€çš„ LLM åˆ†ææµç¨‹
- å‚æ•°è°ƒæ•´ä¸å·¥å…·åˆ‡æ¢ç­–ç•¥
- ä¸‰å±‚æ¸è¿›å¼ä¿®å¤æœºåˆ¶
- å®Œæ•´çš„é‡æ‰§è¡Œé€»è¾‘
- å®é™…ä»£ç å®ç°ä¸æ•°æ®æµè½¬

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

### ä¸ºä»€ä¹ˆéœ€è¦åæ€æœºåˆ¶ï¼Ÿ

åœ¨å¤æ‚çš„å¤šæ­¥éª¤ä»»åŠ¡æ‰§è¡Œä¸­ï¼Œæ­¥éª¤å¤±è´¥æ˜¯ä¸å¯é¿å…çš„ã€‚ä¼ ç»Ÿçš„ç®€å•é‡è¯•æœºåˆ¶å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

âŒ **ä¼ ç»Ÿé‡è¯•çš„é—®é¢˜ï¼š**
- ç›²ç›®é‡è¯•ï¼Œä¸åˆ†æå¤±è´¥åŸå› 
- ä½¿ç”¨ç›¸åŒå‚æ•°åå¤æ‰§è¡Œï¼Œé™·å…¥æ­»å¾ªç¯
- æ— æ³•é€‚åº”åŠ¨æ€å˜åŒ–çš„æ‰§è¡Œç¯å¢ƒ
- æµªè´¹èµ„æºï¼Œæ•ˆç‡ä½ä¸‹

âœ… **åæ€æœºåˆ¶çš„ä¼˜åŠ¿ï¼š**
- ğŸ§  **æ™ºèƒ½åˆ†æ**ï¼šé€šè¿‡ LLM æ·±åº¦åˆ†æå¤±è´¥æ ¹æœ¬åŸå› 
- ğŸ¯ **ç²¾å‡†ä¿®å¤**ï¼šé’ˆå¯¹é—®é¢˜ç±»å‹é€‰æ‹©æœ€ä¼˜ä¿®å¤ç­–ç•¥
- ğŸ”„ **è‡ªé€‚åº”è°ƒæ•´**ï¼šæ ¹æ®åæ€ç»“æœåŠ¨æ€è°ƒæ•´å‚æ•°å’Œå·¥å…·
- âš¡ **æ•ˆç‡ä¼˜å…ˆ**ï¼šä»æœ€è½»é‡çš„ä¿®å¤é€æ­¥å‡çº§
- ğŸ“Š **ç»éªŒç§¯ç´¯**ï¼šæ¯æ¬¡åæ€å½¢æˆå¯å¤ç”¨çš„çŸ¥è¯†

---

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

### ä¸‰å±‚æ¸è¿›å¼ä¿®å¤ç­–ç•¥

```mermaid
graph TB
    Fail[æ­¥éª¤æ‰§è¡Œå¤±è´¥] --> Layer1{ç¬¬ä¸€å±‚<br/>æ­¥éª¤çº§é‡è¯•}

    Layer1 --> |è°ƒæ•´å‚æ•°| Retry1[RetryWithAdjustedParams<br/>âœ… ä»£ä»·æœ€å°ï¼Œä¼˜å…ˆå°è¯•]
    Layer1 --> |åˆ‡æ¢å·¥å…·| Retry2[RetryWithAlternativeTool<br/>âœ… ä»£ä»·è¾ƒå°ï¼Œæ¬¡ä¼˜å…ˆ]

    Retry1 --> Check1{é‡è¯•æˆåŠŸ?}
    Retry2 --> Check1

    Check1 --> |æ˜¯| Success[âœ… ç»§ç»­æ‰§è¡Œ]
    Check1 --> |å¦,è¾¾åˆ°é‡è¯•ä¸Šé™| Layer2{ç¬¬äºŒå±‚<br/>å•æ­¥ä¿®å¤}

    Layer2 --> |å¯æ¢å¤| SingleRepair[å•æ­¥é‡æ–°è§„åˆ’<br/>âš¡ åªä¿®å¤å¤±è´¥æ­¥éª¤]

    SingleRepair --> Check2{ä¿®å¤æˆåŠŸ?}
    Check2 --> |æ˜¯| ReExecute1[ä»è¯¥æ­¥éª¤é‡æ–°æ‰§è¡Œ]
    Check2 --> |å¦| Layer3

    ReExecute1 --> Success

    Layer2 --> |ä¸å¯æ¢å¤| Layer3{ç¬¬ä¸‰å±‚<br/>å…¨å±€é‡è§„åˆ’}

    Layer3 --> GlobalReplan[å…¨ä»»åŠ¡é‡æ–°è§„åˆ’<br/>ğŸ”„ ç”Ÿæˆå…¨æ–°è®¡åˆ’]
    GlobalReplan --> Check3{é‡è§„åˆ’æˆåŠŸ?}

    Check3 --> |æ˜¯| ReExecute2[ä»ç¬¬ä¸€æ­¥é‡æ–°æ‰§è¡Œ]
    Check3 --> |å¦| Failed[âŒ ä»»åŠ¡å¤±è´¥]

    ReExecute2 --> Success

    style Layer1 fill:#26de81
    style Layer2 fill:#45b7d1
    style Layer3 fill:#ff6b6b
    style Success fill:#4ecdc4
```

---

## ğŸ” ç¬¬ä¸€å±‚ï¼šæ­¥éª¤çº§é‡è¯•

### 1.1 è§¦å‘æ¡ä»¶

å½“æ­¥éª¤æ‰§è¡Œå¤±è´¥æ—¶ï¼Œç«‹å³è§¦å‘å•æ­¥åæ€ã€‚

ğŸ“ **ä»£ç ä½ç½®**: [orchestrator.rs:1358-1378](d:\code\task-orchestration-service\src\core\orchestrator.rs#L1358-L1378)

```rust
// âŒ å¤±è´¥ - è¿›è¡Œå•æ­¥åæ€
step_retry_count += 1;

info!(
    step = step_index + 1,
    step_id = %step_info.step_id,
    step_retry_count = step_retry_count,
    max_step_retries = max_step_retries,
    "âŒ æ­¥éª¤æ‰§è¡Œå¤±è´¥ï¼Œå‡†å¤‡é‡è¯•"
);

// Phase 7.3: è¿›è¡Œå•æ­¥åæ€
let selected_tools = self.planner.get_selected_tools_formatted();

let step_reflection = match self.reflector.reflect_on_step_with_events(
    &step_info.step_id,
    &step_info.tool,
    step_result.error_message.as_deref().unwrap_or("æœªçŸ¥é”™è¯¯"),
    &step_info.description,
    metadata,
    selected_tools.as_deref(),
    Some(&event_sender),
).await {
    Ok(reflection) => reflection,
    Err(e) => {
        // åæ€å¤±è´¥ï¼Œåˆ›å»ºé»˜è®¤åæ€ç»“æœ
        StepReflection {
            reflection_id: format!("step_reflect_{}", uuid::Uuid::new_v4()),
            step_id: step_info.step_id.clone(),
            root_cause: "å•æ­¥åæ€å¤±è´¥".to_string(),
            root_cause_category: "reflection_error".to_string(),
            suggested_action: StepAction::ReplanEntireTask,
            confidence: 0.0,
            analysis: e.to_string(),
            alternative_solutions: vec![],
            is_recoverable: false,
        }
    }
};
```

---

### 1.2 å•æ­¥åæ€æµç¨‹

#### TD æµç¨‹å›¾

```mermaid
graph TD
    Start([æ­¥éª¤å¤±è´¥è§¦å‘åæ€]) --> GetInfo[æ”¶é›†å¤±è´¥ä¿¡æ¯]

    GetInfo --> Info[â€¢ æ­¥éª¤ID<br/>â€¢ å·¥å…·ID<br/>â€¢ é”™è¯¯ä¿¡æ¯<br/>â€¢ æ­¥éª¤æè¿°<br/>â€¢ å½“å‰metadata<br/>â€¢ å¯ç”¨å·¥å…·åˆ—è¡¨]

    Info --> BuildPrompt[æ„å»ºåæ€æç¤ºè¯]

    BuildPrompt --> PromptContent[ç³»ç»Ÿæç¤º:<br/>â€¢ é—®é¢˜è¯Šæ–­ä¸“å®¶è§’è‰²<br/>â€¢ 5å¤§åˆ†æç»´åº¦<br/>â€¢ çº¦æŸæ¡ä»¶<br/>---<br/>ç”¨æˆ·æç¤º:<br/>â€¢ å¤±è´¥è¯¦æƒ…<br/>â€¢ å¯ç”¨å·¥å…·åˆ—è¡¨<br/>â€¢ è¦æ±‚è¿”å›JSON]

    PromptContent --> CallLLM[è°ƒç”¨LLMåˆ†æ]

    CallLLM --> |æµå¼/éæµå¼| LLMResponse[LLMè¿”å›JSONå“åº”]

    LLMResponse --> ParseJSON[è§£æJSONå“åº”]

    ParseJSON --> Extract[æå–å­—æ®µ]

    Extract --> Fields[â€¢ root_cause_category<br/>â€¢ root_cause<br/>â€¢ is_recoverable<br/>â€¢ confidence<br/>â€¢ analysis<br/>â€¢ suggested_action<br/>â€¢ alternative_solutions]

    Fields --> BuildAction[æ„å»ºStepAction]

    BuildAction --> ActionType{action.type?}

    ActionType --> |retry_with_params| Action1[RetryWithAdjustedParams<br/>æå–è°ƒæ•´å‚æ•°]
    ActionType --> |retry_with_tool| Action2[RetryWithAlternativeTool<br/>æå–å¤‡é€‰å·¥å…·ID]
    ActionType --> |replan| Action3[ReplanEntireTask]
    ActionType --> |stop| Action4[StopExecution]

    Action1 --> Result
    Action2 --> Result
    Action3 --> Result
    Action4 --> Result

    Result[è¿”å›StepReflection] --> End([åæ€å®Œæˆ])

    style CallLLM fill:#f9ca24
    style ParseJSON fill:#4ecdc4
    style BuildAction fill:#45b7d1
```

---

#### ä»£ç å®ç°

ğŸ“ **ä»£ç ä½ç½®**: [reflector.rs:761-866](d:\code\task-orchestration-service\src\core\reflector.rs#L761-L866)

**å…³é”®æ•°æ®ç»“æ„:**

```rust
/// å•æ­¥åæ€ç»“æœ
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct StepReflection {
    /// åæ€ ID
    pub reflection_id: String,
    /// æ­¥éª¤ ID
    pub step_id: String,
    /// æ ¹æœ¬åŸå›  (æœ€ä¸»è¦çš„å¤±è´¥åŸå› )
    pub root_cause: String,
    /// æ ¹æœ¬åŸå› åˆ†ç±»
    pub root_cause_category: String, // parameter_error, tool_error, dependency_error, etc.
    /// å»ºè®®çš„æ‰§è¡Œè¡ŒåŠ¨
    pub suggested_action: StepAction,
    /// å¯ä¿¡åº¦è¯„åˆ† (0-100)
    pub confidence: f32,
    /// è¯¦ç»†åˆ†æ
    pub analysis: String,
    /// å¤‡é€‰æ–¹æ¡ˆåˆ—è¡¨
    pub alternative_solutions: Vec<String>,
    /// æ˜¯å¦å¯æ¢å¤
    pub is_recoverable: bool,
}

/// å•æ­¥æ‰§è¡Œå†³ç­–
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]
pub enum StepAction {
    /// ä½¿ç”¨è°ƒæ•´åçš„å‚æ•°é‡æ–°æ‰§è¡Œæœ¬æ­¥
    RetryWithAdjustedParams(HashMap<String, String>),
    /// ä½¿ç”¨å¤‡é€‰å·¥å…·é‡æ–°æ‰§è¡Œæœ¬æ­¥
    RetryWithAlternativeTool(String),
    /// é‡æ–°è§„åˆ’æ•´ä¸ªä»»åŠ¡
    ReplanEntireTask,
    /// åœæ­¢æ‰§è¡Œ
    StopExecution,
}
```

**LLM æç¤ºè¯:**

```rust
let system_prompt = format!(
    "ä½ æ˜¯ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œé—®é¢˜è¯Šæ–­ä¸“å®¶ã€‚\n\
    åˆ†æä¸‹é¢çš„æ­¥éª¤æ‰§è¡Œå¤±è´¥ï¼Œå¹¶ç»™å‡ºæ ¹æœ¬åŸå› åˆ†æå’Œå…·ä½“ä¿®å¤å»ºè®®ã€‚\n\
    \n\
    ä½ å¿…é¡»è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š\n\
    1. **å‚æ•°é”™è¯¯**: è¾“å…¥å‚æ•°æ˜¯å¦ä¸ç¬¦åˆå·¥å…·è¦æ±‚?\n\
    2. **å·¥å…·é—®é¢˜**: å·¥å…·æœ¬èº«æ˜¯å¦æœ‰é—®é¢˜æˆ–çŠ¶æ€å¼‚å¸¸?\n\
    3. **å‰ç½®ä¾èµ–**: å‰ç½®æ­¥éª¤çš„è¾“å‡ºæ˜¯å¦æ»¡è¶³æœ¬æ­¥éœ€æ±‚?\n\
    4. **ä»»åŠ¡åˆ†è§£é—®é¢˜**: æ˜¯å¦æ˜¯ä»»åŠ¡åˆ†è§£ä¸å½“å¯¼è‡´çš„?\n\
    5. **å¤–éƒ¨é—®é¢˜**: æ˜¯å¦æ˜¯å¤–éƒ¨æœåŠ¡/èµ„æºé—®é¢˜?\n\
    \n\
    âš ï¸ **é‡è¦æç¤ºï¼šé€‰æ‹©å¤‡é€‰å·¥å…·æ—¶çš„çº¦æŸ**\n\
    - å¦‚æœæä¾›äº†å¯ç”¨å·¥å…·åˆ—è¡¨ï¼Œä½ **å¿…é¡»**åªä»è¯¥åˆ—è¡¨ä¸­é€‰æ‹©å¤‡é€‰å·¥å…·\n\
    - ä¸è¦æ¨èåˆ—è¡¨ä¹‹å¤–çš„å·¥å…·ï¼Œå³ä½¿å®ƒä»¬å¯èƒ½æ›´åˆé€‚\n\
    - å¦‚æœå¯ç”¨å·¥å…·åˆ—è¡¨ä¸­æ²¡æœ‰åˆé€‚çš„å¤‡é€‰å·¥å…·ï¼Œåº”è¯¥å»ºè®®é‡æ–°è§„åˆ’è€Œéæ¨èä¸å­˜åœ¨çš„å·¥å…·\n\
    \n\
    å¯¹äºæ¯ä¸ªé—®é¢˜ï¼Œç»™å‡ºï¼š\n\
    - æ ¹æœ¬åŸå› åˆ†ç±» (parameter_error/tool_error/dependency_error/decomposition_error/external_error)\n\
    - å…·ä½“çš„æ ¹æœ¬åŸå› \n\
    - æ˜¯å¦å¯æ¢å¤ (é€šè¿‡è°ƒæ•´å‚æ•°æˆ–é€‰æ‹©å¤‡é€‰å·¥å…·)\n\
    - å»ºè®®çš„ä¿®å¤æ–¹æ¡ˆ\n\
    - å¤‡é€‰æ–¹æ¡ˆï¼ˆå¦‚éœ€æ¨èå¤‡é€‰å·¥å…·ï¼Œå¿…é¡»ä»å¯ç”¨å·¥å…·åˆ—è¡¨ä¸­é€‰æ‹©ï¼‰\n\
    - å¯ä¿¡åº¦ (0-100)"
);

let user_prompt = format!(
    "**æ­¥éª¤ä¿¡æ¯**\n\
    - æ­¥éª¤ ID: {}\n\
    - å·¥å…· ID: {}\n\
    - æ­¥éª¤æè¿°: {}\n\
    \n\
    **æ‰§è¡Œé”™è¯¯**\n\
    {}\n\
    \n\
    **å½“å‰å…ƒæ•°æ®**\n\
    {:?}\n\
    {}\
    è¯·è¿›è¡Œè¯¦ç»†çš„é—®é¢˜è¯Šæ–­ï¼Œå¹¶è¿”å›ä»¥ä¸‹ JSON æ ¼å¼çš„åˆ†æç»“æœï¼š\n\
    {{\n  \
      \"root_cause_category\": \"åˆ†ç±»\",\n  \
      \"root_cause\": \"å…·ä½“æ ¹æœ¬åŸå› \",\n  \
      \"is_recoverable\": boolean,\n  \
      \"confidence\": 0-100,\n  \
      \"analysis\": \"è¯¦ç»†åˆ†æè¯´æ˜\",\n  \
      \"suggested_action\": {{\n    \
        \"type\": \"retry_with_params/retry_with_tool/replan/stop\",\n    \
        \"data\": {{}} // æ ¹æ® type ä¸åŒè€Œä¸åŒ\n  \
      }},\n  \
      \"alternative_solutions\": [\"æ–¹æ¡ˆ1\", \"æ–¹æ¡ˆ2\", ...]\n\
    }}",
    step_id, tool_id, step_description, error_message, metadata, tools_section
);
```

**LLM å“åº”ç¤ºä¾‹:**

```json
{
  "root_cause_category": "parameter_error",
  "root_cause": "ç¼ºå°‘å¿…éœ€å‚æ•° project_idï¼Œå·¥å…·æ— æ³•å®šä½æ•°æ®æº",
  "is_recoverable": true,
  "confidence": 90.0,
  "analysis": "æ­¥éª¤ step_2 è°ƒç”¨ data_loader å·¥å…·æ—¶ï¼Œparameters ä¸­æœªæä¾› project_id å‚æ•°ã€‚æ ¹æ®å·¥å…·å®šä¹‰ï¼Œproject_id æ˜¯å¿…éœ€å‚æ•°ï¼Œç”¨äºæ ‡è¯†æ•°æ®æ‰€å±é¡¹ç›®ã€‚æ£€æŸ¥ metadata å‘ç°ç”¨æˆ·åœ¨åˆå§‹è¯·æ±‚ä¸­å·²æä¾› project_id=123ï¼Œä½†æ­¥éª¤å®šä¹‰ä¸­æœªå¼•ç”¨è¯¥ metadataã€‚",
  "suggested_action": {
    "type": "retry_with_params",
    "data": {
      "project_id": "123",
      "file_path": "/data/load_history.csv"
    }
  },
  "alternative_solutions": [
    "åœ¨æ­¥éª¤å®šä¹‰ä¸­ä½¿ç”¨å ä½ç¬¦ {{metadata.project_id}} å¼•ç”¨ metadata",
    "ä¿®æ”¹å·¥å…·ä½¿ project_id å‚æ•°å˜ä¸ºå¯é€‰ï¼Œä»ä¸Šä¸‹æ–‡è‡ªåŠ¨æ¨æ–­",
    "åœ¨å‰ç½®æ­¥éª¤ä¸­è¾“å‡º project_idï¼Œä¾›åç»­æ­¥éª¤å¼•ç”¨"
  ]
}
```

---

### 1.3 æ‰§è¡Œç­–ç•¥åˆ†å‘

æ ¹æ® LLM è¿”å›çš„ `suggested_action` ç±»å‹ï¼Œåˆ†å‘åˆ°ä¸åŒçš„æ‰§è¡Œç­–ç•¥ã€‚

ğŸ“ **ä»£ç ä½ç½®**: [orchestrator.rs:1469-1653](d:\code\task-orchestration-service\src\core\orchestrator.rs#L1469-L1653)

```rust
// Phase 7.3: æ ¹æ®å•æ­¥åæ€ç»“æœå†³ç­–ï¼ˆä»…åœ¨æœªè¾¾åˆ°é‡è¯•ä¸Šé™æ—¶ï¼‰
match &step_reflection.suggested_action {
    StepAction::RetryWithAdjustedParams(adjusted_params) => {
        // ç­–ç•¥A: å‚æ•°è°ƒæ•´é‡è¯•
    },

    StepAction::RetryWithAlternativeTool(alternative_tool_id) => {
        // ç­–ç•¥B: åˆ‡æ¢å¤‡é€‰å·¥å…·
    },

    StepAction::ReplanEntireTask => {
        // ç­–ç•¥C: ç›´æ¥è¿›å…¥é‡æ–°è§„åˆ’
    },

    StepAction::StopExecution => {
        // ç­–ç•¥D: åœæ­¢æ‰§è¡Œ
    }
}
```

---

### 1.4 ç­–ç•¥A: å‚æ•°è°ƒæ•´é‡è¯•

#### æµç¨‹å›¾

```mermaid
graph TD
    Start([æ¥æ”¶è°ƒæ•´å‚æ•°å»ºè®®]) --> Check{å‚æ•°éç©º?}

    Check --> |å¦| Skip[è·³è¿‡ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡é‡è¯•]
    Check --> |æ˜¯| Log[è®°å½•å‚æ•°è¦†ç›–ä¿¡æ¯]

    Log --> Call[è°ƒç”¨execute_single_step_with_overrides]

    Call --> Override[ä¼ å…¥å‚æ•°è¦†ç›–]
    Override --> Merge[å‚æ•°åˆå¹¶é€»è¾‘<br/>executor.rs:987-1002]

    Merge --> MergeDetail[åŸå§‹å‚æ•° = resolve_parameters<br/>+<br/>è°ƒæ•´å‚æ•° = adjusted_params<br/>â†“<br/>æœ€ç»ˆå‚æ•° = åˆå¹¶ç»“æœ]

    MergeDetail --> Execute[é‡æ–°æ‰§è¡Œæ­¥éª¤]

    Execute --> Result{æ‰§è¡Œç»“æœ?}

    Result --> |æˆåŠŸ| SaveResult[ä¿å­˜æ­¥éª¤ç»“æœ<br/>åŒæ­¥è¾“å‡ºåˆ°metadata]
    Result --> |å¤±è´¥| RetryAgain[ç»§ç»­é‡è¯•å¾ªç¯]

    SaveResult --> NextStep[step_index += 1<br/>ç»§ç»­ä¸‹ä¸€æ­¥]
    RetryAgain --> CheckLimit{è¾¾åˆ°é‡è¯•ä¸Šé™?}

    CheckLimit --> |æ˜¯| UpgradeStrategy[å‡çº§åˆ°å•æ­¥ä¿®å¤]
    CheckLimit --> |å¦| Start

    NextStep --> End([æˆåŠŸ])

    style Merge fill:#26de81
    style Execute fill:#4ecdc4
    style SaveResult fill:#45b7d1
```

#### ä»£ç å®ç°

ğŸ“ **ä»£ç ä½ç½®**: [orchestrator.rs:1470-1549](d:\code\task-orchestration-service\src\core\orchestrator.rs#L1470-L1549)

```rust
StepAction::RetryWithAdjustedParams(adjusted_params) => {
    info!(
        step_id = %step_info.step_id,
        step_retry_count = step_retry_count,
        max_step_retries = max_step_retries,
        param_count = adjusted_params.len(),
        "ğŸ”„ å°è¯•ä½¿ç”¨è°ƒæ•´åçš„å‚æ•°é‡æ–°æ‰§è¡Œæ­¥éª¤ (é‡è¯• {}/{})",
        step_retry_count,
        max_step_retries
    );

    // âœ… ä½¿ç”¨è°ƒæ•´åçš„å‚æ•°é‡æ–°æ‰§è¡Œæœ¬æ­¥
    if !adjusted_params.is_empty() {
        // ä½¿ç”¨è¦†ç›–å‚æ•°é‡è¯•
        match self.executor.execute_single_step_with_overrides(
            &current_plan,
            step_index,
            &execution_context,
            &available_tools,
            Some(adjusted_params.clone()),  // âœ… å…³é”®ï¼šä¼ å…¥è°ƒæ•´å‚æ•°
            None,
            Some(&event_sender),
        ).await {
            Ok(retry_result) if retry_result.is_success => {
                info!(step_id = %step_info.step_id, "âœ… å‚æ•°è°ƒæ•´é‡è¯•æˆåŠŸ");

                // å‘é€æ­¥éª¤å®Œæˆäº‹ä»¶
                event_sender.send_step_completed(&retry_result);

                // ä¿å­˜ç»“æœ
                step_results.push(retry_result.clone());
                execution_context.set_step_result(/*...*/);

                // ğŸ”‘ ã€å…³é”®ä¿®å¤ã€‘åŒæ­¥æ­¥éª¤è¾“å‡ºåˆ° runtime_metadata
                self.sync_step_output_to_metadata(
                    &retry_result.step_id,
                    &retry_result.tool_id,
                    &retry_result.output,
                    &execution_context,
                    &available_tools,
                ).await;

                step_index += 1;  // âœ… æˆåŠŸï¼Œç»§ç»­ä¸‹ä¸€æ­¥
                continue;
            }
            _ => {
                warn!(step_id = %step_info.step_id, "âš ï¸ å‚æ•°è°ƒæ•´é‡è¯•ä»ç„¶å¤±è´¥");
                continue;  // ç»§ç»­å¾ªç¯ï¼Œè®© step_retry_count å¢åŠ 
            }
        }
    }
}
```

#### å‚æ•°è¦†ç›–æ ¸å¿ƒé€»è¾‘

ğŸ“ **ä»£ç ä½ç½®**: [executor.rs:979-1002](d:\code\task-orchestration-service\src\core\executor.rs#L979-L1002)

```rust
// è°ƒç”¨å‚æ•°è§£æå™¨è·å–åŸå§‹å‚æ•°
let mut parameters = ParameterResolver::resolve_parameters(
    step,
    tool_info,
    execution_context,
);

// âœ… åº”ç”¨å‚æ•°è¦†ç›–ï¼ˆå¦‚æœæœ‰ï¼‰
if let Some(overrides) = param_overrides {
    info!(
        step_id = %step.step_id,
        override_count = overrides.len(),
        "ğŸ”§ åº”ç”¨å‚æ•°è¦†ç›–"
    );
    for (key, value) in overrides {
        info!(
            step_id = %step.step_id,
            param_key = %key,
            param_value = %value,
            "  â”œâ”€ è¦†ç›–å‚æ•°"
        );
        parameters.insert(key, value);  // âœ… ç›´æ¥æ’å…¥/è¦†ç›–å‚æ•°
    }
}
```

**å‚æ•°åˆå¹¶è§„åˆ™:**

```
æœ€ç»ˆå‚æ•° = åŸå§‹å‚æ•° âˆª è°ƒæ•´å‚æ•°

å…¶ä¸­ï¼š
- åŸå§‹å‚æ•°æ¥è‡ª: ParameterResolver (æ­¥éª¤å®šä¹‰ + metadata + å‰ç½®è¾“å‡º)
- è°ƒæ•´å‚æ•°æ¥è‡ª: LLM åæ€å»ºè®®
- åˆå¹¶ç­–ç•¥: HashMap.insert() - åæ’å…¥çš„è¦†ç›–å…ˆæ’å…¥çš„
```

---

### 1.5 ç­–ç•¥B: åˆ‡æ¢å¤‡é€‰å·¥å…·

#### æµç¨‹å›¾

```mermaid
graph TD
    Start([æ¥æ”¶å¤‡é€‰å·¥å…·å»ºè®®]) --> Log[è®°å½•å·¥å…·åˆ‡æ¢ä¿¡æ¯]

    Log --> Call[è°ƒç”¨execute_single_step_with_overrides]

    Call --> Override[ä¼ å…¥å·¥å…·è¦†ç›–]
    Override --> Switch[å·¥å…·åˆ‡æ¢é€»è¾‘<br/>executor.rs:951-978]

    Switch --> SwitchDetail[åŸå§‹å·¥å…·: step.tool<br/>â†“<br/>è¦†ç›–å·¥å…·: alternative_tool_id<br/>â†“<br/>å®é™…ä½¿ç”¨: effective_tool_id]

    SwitchDetail --> FindTool[ä»available_toolsæŸ¥æ‰¾æ–°å·¥å…·]
    FindTool --> ResolveParams[ä½¿ç”¨æ–°å·¥å…·çš„å‚æ•°å®šä¹‰<br/>é‡æ–°è§£æå‚æ•°]

    ResolveParams --> Execute[ä½¿ç”¨æ–°å·¥å…·æ‰§è¡Œæ­¥éª¤]

    Execute --> Result{æ‰§è¡Œç»“æœ?}

    Result --> |æˆåŠŸ| SaveResult[ä¿å­˜æ­¥éª¤ç»“æœ<br/>åŒæ­¥è¾“å‡ºåˆ°metadata]
    Result --> |å¤±è´¥| RetryAgain[ç»§ç»­é‡è¯•å¾ªç¯]

    SaveResult --> NextStep[step_index += 1<br/>ç»§ç»­ä¸‹ä¸€æ­¥]
    RetryAgain --> CheckLimit{è¾¾åˆ°é‡è¯•ä¸Šé™?}

    CheckLimit --> |æ˜¯| UpgradeStrategy[å‡çº§åˆ°å•æ­¥ä¿®å¤]
    CheckLimit --> |å¦| Start

    NextStep --> End([æˆåŠŸ])

    style Switch fill:#26de81
    style Execute fill:#4ecdc4
    style SaveResult fill:#45b7d1
```

#### ä»£ç å®ç°

ğŸ“ **ä»£ç ä½ç½®**: [orchestrator.rs:1552-1622](d:\code\task-orchestration-service\src\core\orchestrator.rs#L1552-L1622)

```rust
StepAction::RetryWithAlternativeTool(alternative_tool_id) => {
    info!(
        step_id = %step_info.step_id,
        alternative_tool = %alternative_tool_id,
        step_retry_count = step_retry_count,
        max_step_retries = max_step_retries,
        "ğŸ”„ å°è¯•ä½¿ç”¨å¤‡é€‰å·¥å…·é‡æ–°æ‰§è¡Œæ­¥éª¤ (é‡è¯• {}/{})",
        step_retry_count,
        max_step_retries
    );

    // âœ… ä½¿ç”¨å¤‡é€‰å·¥å…·é‡æ–°æ‰§è¡Œæœ¬æ­¥
    match self.executor.execute_single_step_with_overrides(
        &current_plan,
        step_index,
        &execution_context,
        &available_tools,
        None,
        Some(alternative_tool_id.clone()),  // âœ… å…³é”®ï¼šä¼ å…¥å¤‡é€‰å·¥å…·ID
        Some(&event_sender),
    ).await {
        Ok(retry_result) if retry_result.is_success => {
            info!(step_id = %step_info.step_id, "âœ… å¤‡é€‰å·¥å…·é‡è¯•æˆåŠŸ");

            // å‘é€æ­¥éª¤å®Œæˆäº‹ä»¶
            event_sender.send_step_completed(&retry_result);

            // ä¿å­˜ç»“æœ
            step_results.push(retry_result.clone());
            execution_context.set_step_result(/*...*/);

            // åŒæ­¥è¾“å‡ºåˆ° metadata
            self.sync_step_output_to_metadata(/*...*/).await;

            step_index += 1;  // âœ… æˆåŠŸï¼Œç»§ç»­ä¸‹ä¸€æ­¥
            continue;
        }
        _ => {
            warn!(step_id = %step_info.step_id, "âš ï¸ å¤‡é€‰å·¥å…·é‡è¯•ä»ç„¶å¤±è´¥");
            continue;
        }
    }
}
```

#### å·¥å…·åˆ‡æ¢æ ¸å¿ƒé€»è¾‘

ğŸ“ **ä»£ç ä½ç½®**: [executor.rs:950-978](d:\code\task-orchestration-service\src\core\executor.rs#L950-L978)

```rust
// å…¼å®¹æ—§ç‰ˆ:ä½¿ç”¨tool+parametersæ ¼å¼
// ç¡®å®šä½¿ç”¨çš„å·¥å…·IDï¼ˆä¼˜å…ˆä½¿ç”¨è¦†ç›–çš„å·¥å…·ï¼‰
let effective_tool_id = tool_override.as_ref().unwrap_or(&step.tool);

// ä»å·¥å…·åˆ—è¡¨ä¸­æ‰¾åˆ°è¯¥å·¥å…·çš„ä¿¡æ¯
let tool_info = available_tools
    .iter()
    .find(|t| t.id == *effective_tool_id)
    .ok_or_else(|| {
        crate::utils::ServiceError::PlanningFailed(
            format!("å·¥å…· {} æœªæ‰¾åˆ°", effective_tool_id)
        )
    })?;

if tool_override.is_some() {
    info!(
        step_index = step_index,
        step_id = %step.step_id,
        original_tool = %step.tool,
        override_tool = %effective_tool_id,
        "ğŸ”„ æ‰§è¡Œå•ä¸ªæ­¥éª¤ï¼ˆä½¿ç”¨å¤‡é€‰å·¥å…·ï¼‰"
    );
}

// ä½¿ç”¨æ–°å·¥å…·çš„å‚æ•°å®šä¹‰é‡æ–°è§£æå‚æ•°
let parameters = ParameterResolver::resolve_parameters(
    step,
    tool_info,  // âœ… ä½¿ç”¨æ–°å·¥å…·çš„ ToolInfo
    execution_context,
);

// åˆ›å»ºä¸´æ—¶æ­¥éª¤å‰¯æœ¬ï¼ˆå·¥å…·IDå·²æ›¿æ¢ï¼‰
let mut modified_step = step.clone();
modified_step.tool = override_tool;

// ä½¿ç”¨ä¿®æ”¹åçš„æ­¥éª¤æ‰§è¡Œ
self.execute_step_with_event_sender(
    &plan.plan_id,
    &modified_step,  // âœ… å·¥å…·å·²åˆ‡æ¢
    &parameters,
    Some(execution_context),
    event_sender
).await
```

---

## âš¡ ç¬¬äºŒå±‚ï¼šå•æ­¥ä¿®å¤

### 2.1 è§¦å‘æ¡ä»¶

å½“æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ï¼Œè¿›å…¥å•æ­¥ä¿®å¤ï¼š

1. âœ… æ­¥éª¤é‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™ (`step_retry_count >= max_step_retries`)
2. âœ… åæ€åˆ¤æ–­é—®é¢˜å¯æ¢å¤ (`step_reflection.is_recoverable == true`)
3. âœ… å•æ­¥ä¿®å¤æ¬¡æ•°æœªè¶…é™ (`single_step_repair_count < max_single_step_repairs`)

---

### 2.2 å•æ­¥ä¿®å¤æµç¨‹

#### TD æµç¨‹å›¾

```mermaid
graph TD
    Start([æ­¥éª¤é‡è¯•å¤±è´¥]) --> Check{é—®é¢˜å¯æ¢å¤?}

    Check --> |å¦| GlobalReplan[è·³åˆ°å…¨å±€é‡è§„åˆ’]
    Check --> |æ˜¯| CheckCount{å•æ­¥ä¿®å¤æ¬¡æ•°<br/>< max_single_step_repairs?}

    CheckCount --> |å¦| GlobalReplan
    CheckCount --> |æ˜¯| GetTools[è·å–ç­›é€‰åçš„å·¥å…·åˆ—è¡¨]

    GetTools --> CallPlanner[è°ƒç”¨Planner.replan_single_step]

    CallPlanner --> BuildPrompt[æ„å»ºå•æ­¥ä¿®å¤æç¤ºè¯]

    BuildPrompt --> PromptContent[åŒ…å«:<br/>â€¢ å¤±è´¥æ­¥éª¤ä¿¡æ¯<br/>â€¢ é”™è¯¯ä¿¡æ¯<br/>â€¢ å½“å‰metadata<br/>â€¢ å¯ç”¨å·¥å…·<br/>â€¢ è¦æ±‚åªä¿®å¤è¯¥æ­¥éª¤]

    PromptContent --> CallLLM[è°ƒç”¨LLMé‡æ–°è§„åˆ’å•æ­¥]

    CallLLM --> ParsePlan[è§£ææ–°çš„æ­¥éª¤å®šä¹‰]

    ParsePlan --> Validate{æ­¥éª¤æœ‰æ•ˆ?}

    Validate --> |å¦| Failed[ä¿®å¤å¤±è´¥]
    Validate --> |æ˜¯| ReplaceStep[æ›¿æ¢è®¡åˆ’ä¸­çš„è¯¥æ­¥éª¤]

    ReplaceStep --> Reset[é‡ç½®çŠ¶æ€:<br/>â€¢ last_step_index = usize::MAX<br/>â€¢ step_retry_count = 0<br/>â€¢ step_index ä¿æŒä¸å˜]

    Reset --> SendEvent[å‘é€å•æ­¥ä¿®å¤å®Œæˆäº‹ä»¶]
    SendEvent --> Continue[ç»§ç»­å¾ªç¯<br/>é‡æ–°æ‰§è¡Œè¯¥æ­¥éª¤]

    Continue --> Success([ä¿®å¤å®Œæˆ])
    Failed --> GlobalReplan

    style CallLLM fill:#f9ca24
    style ReplaceStep fill:#26de81
    style Continue fill:#4ecdc4
```

#### ä»£ç å®ç°

ğŸ“ **ä»£ç ä½ç½®**: [orchestrator.rs:1719-1841](d:\code\task-orchestration-service\src\core\orchestrator.rs#L1719-L1841)

```rust
// âœ¨ ä¼˜åŒ–ç­–ç•¥ï¼šä¼˜å…ˆå°è¯•å•æ­¥é‡æ–°è§„åˆ’
if step_reflection.is_recoverable && single_step_repair_count < max_single_step_repairs {
    info!(step_id = %step_info.step_id, "ğŸ”§ å°è¯•å•æ­¥ä¿®å¤ï¼ˆåªä¿®å¤å¤±è´¥çš„æ­¥éª¤ï¼‰");

    // ä½¿ç”¨ç­›é€‰åçš„å·¥å…·åˆ—è¡¨ï¼ˆè€Œéå…¨éƒ¨å·¥å…·ï¼‰
    let selected_tools = self.planner.get_selected_tools();
    let tools_to_use = if selected_tools.is_empty() {
        warn!("ç­›é€‰åçš„å·¥å…·åˆ—è¡¨ä¸ºç©ºï¼Œå›é€€åˆ°ä½¿ç”¨å…¨éƒ¨å·¥å…·");
        self.planner.query_available_tools_public().await?
    } else {
        info!("ä½¿ç”¨ç­›é€‰åçš„ {} ä¸ªå·¥å…·è¿›è¡Œå•æ­¥ä¿®å¤", selected_tools.len());
        selected_tools
    };

    match self.planner.replan_single_step(
        &step_info.step_id,
        &step_info,
        step_result.error_message.as_deref().unwrap_or("æœªçŸ¥é”™è¯¯"),
        &tools_to_use,
    ).await {
        Ok(repaired_step) => {
            info!(
                step_id = %step_info.step_id,
                old_tool = %step_info.tool,
                new_tool = %repaired_step.tool,
                "âœ… å•æ­¥ä¿®å¤æˆåŠŸ"
            );

            // æ›¿æ¢å½“å‰è®¡åˆ’ä¸­çš„è¿™ä¸ªæ­¥éª¤
            if let Some(idx) = current_plan.steps.iter().position(|s| s.step_id == step_info.step_id) {
                current_plan.steps[idx] = repaired_step.clone();
            }

            // é‡æ–°æ‰§è¡Œä¿®å¤åçš„æ­¥éª¤
            info!(step_id = %step_info.step_id, "ğŸ”„ å•æ­¥ä¿®å¤æˆåŠŸï¼Œå°†é‡æ–°æ‰§è¡Œå½“å‰æ­¥éª¤");

            // âœ… å…³é”®ï¼šstep_index ä¿æŒä¸å˜ï¼Œé‡æ–°æ‰§è¡Œå½“å‰æ­¥éª¤
            last_step_index = usize::MAX;  // é‡ç½®æ­¥éª¤ç´¢å¼•è¿½è¸ª
            step_retry_count = 0;          // é‡ç½®é‡è¯•è®¡æ•°
            single_step_repair_count += 1; // å¢åŠ å•æ­¥ä¿®å¤è®¡æ•°

            // å‘é€å•æ­¥ä¿®å¤å®Œæˆäº‹ä»¶
            event_sender.send_reflection_completed(&ReflectionResult {
                reflection_id: format!("repair_single_step_{}", step_info.step_id),
                root_causes: vec![
                    format!("æ­¥éª¤ {} æ‰§è¡Œå¤±è´¥", step_info.step_id),
                    "å·²è¿›è¡Œå•æ­¥ä¿®å¤".to_string(),
                ],
                alternative_approaches: vec![
                    "âœ… æ­¥éª¤å·²ä¿®å¤".to_string(),
                    format!("ä¿®å¤åçš„æ­¥éª¤: {}", repaired_step.name),
                ],
                lessons_learned: vec![
                    "å•æ­¥ä¿®å¤å·²å®Œæˆï¼Œå°†é‡æ–°æ‰§è¡Œè¯¥æ­¥éª¤".to_string(),
                ],
                should_replan: false,
            });

            // ç»§ç»­å¾ªç¯ï¼ˆé‡æ–°æ‰§è¡Œå½“å‰æ­¥éª¤ï¼‰
            continue;
        }
        Err(e) => {
            warn!(step_id = %step_info.step_id, error = %e, "âš ï¸ å•æ­¥ä¿®å¤å¤±è´¥");
            single_step_repair_count += 1;
            // ç»§ç»­æ‰§è¡Œå…¨ä»»åŠ¡é‡æ–°è§„åˆ’çš„é€»è¾‘
        }
    }
}
```

---

### 2.3 å•æ­¥ä¿®å¤ vs å…¨å±€é‡è§„åˆ’å¯¹æ¯”

| ç»´åº¦ | å•æ­¥ä¿®å¤ | å…¨å±€é‡è§„åˆ’ |
|------|---------|-----------|
| **ä¿®å¤èŒƒå›´** | åªä¿®å¤å¤±è´¥çš„æ­¥éª¤ | é‡æ–°è§„åˆ’æ‰€æœ‰æ­¥éª¤ |
| **LLM Tokenæ¶ˆè€—** | ä½ï¼ˆåªåˆ†æä¸€ä¸ªæ­¥éª¤ï¼‰ | é«˜ï¼ˆåˆ†ææ•´ä¸ªä»»åŠ¡ï¼‰ |
| **æ‰§è¡Œæ•ˆç‡** | é«˜ï¼ˆä»å¤±è´¥æ­¥éª¤ç»§ç»­ï¼‰ | ä½ï¼ˆä»å¤´é‡æ–°æ‰§è¡Œï¼‰ |
| **æˆåŠŸç‡** | ä¸­ï¼ˆå±€éƒ¨ä¼˜åŒ–ï¼‰ | é«˜ï¼ˆå…¨å±€ä¼˜åŒ–ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | å‚æ•°é”™è¯¯ã€å·¥å…·é€‰æ‹©é—®é¢˜ | ä»»åŠ¡åˆ†è§£é”™è¯¯ã€ä¾èµ–å…³ç³»é”™è¯¯ |
| **ä»£ä»·** | âš¡ å° | ğŸ”„ å¤§ |

---

## ğŸ”„ ç¬¬ä¸‰å±‚ï¼šå…¨å±€é‡è§„åˆ’

### 3.1 è§¦å‘æ¡ä»¶

å½“æ»¡è¶³ä»¥ä¸‹ä»»ä¸€æ¡ä»¶æ—¶ï¼Œè¿›å…¥å…¨å±€é‡è§„åˆ’ï¼š

1. âœ… å•æ­¥ä¿®å¤å¤±è´¥æˆ–ä¸é€‚ç”¨
2. âœ… åæ€åˆ¤æ–­é—®é¢˜ä¸å¯æ¢å¤ (`is_recoverable == false`)
3. âœ… LLM å»ºè®®ç›´æ¥é‡è§„åˆ’ (`StepAction::ReplanEntireTask`)
4. âœ… å•æ­¥ä¿®å¤æ¬¡æ•°å·²è¾¾ä¸Šé™

---

### 3.2 å…¨å±€é‡è§„åˆ’æµç¨‹

#### TD æµç¨‹å›¾

```mermaid
graph TD
    Start([è¿›å…¥å…¨å±€é‡è§„åˆ’]) --> CheckCount{ä»»åŠ¡é‡è§„åˆ’æ¬¡æ•°<br/>< max_task_replans?}

    CheckCount --> |å¦| Failed[ä»»åŠ¡å¤±è´¥<br/>åœæ­¢æ‰§è¡Œ]
    CheckCount --> |æ˜¯| BuildPrompt[æ„å»ºé‡è§„åˆ’æç¤ºè¯]

    BuildPrompt --> PromptContent[åŒ…å«:<br/>â€¢ åŸä»»åŠ¡æè¿°<br/>â€¢ å¤±è´¥æ­¥éª¤ä¿¡æ¯<br/>â€¢ é”™è¯¯æ ¹æœ¬åŸå› <br/>â€¢ åæ€åˆ†æ<br/>â€¢ å¤‡é€‰æ–¹æ¡ˆ<br/>â€¢ å½“å‰metadata]

    PromptContent --> CallPlanner[è°ƒç”¨Planner.replan_task]

    CallPlanner --> CallLLM[è°ƒç”¨LLMé‡æ–°è§„åˆ’æ•´ä¸ªä»»åŠ¡]

    CallLLM --> ParsePlan[è§£ææ–°çš„ExecutionPlan]

    ParsePlan --> Validate{è®¡åˆ’æœ‰æ•ˆ?}

    Validate --> |å¦| ReplanFailed[é‡è§„åˆ’å¤±è´¥<br/>ä»»åŠ¡ç»ˆæ­¢]
    Validate --> |æ˜¯| ReplacePlan[ä½¿ç”¨æ–°è®¡åˆ’æ›¿æ¢å½“å‰è®¡åˆ’]

    ReplacePlan --> Reset[é‡ç½®æ‰§è¡ŒçŠ¶æ€]

    Reset --> ResetDetail[â€¢ current_plan = new_plan<br/>â€¢ step_index = 0<br/>â€¢ step_results.clear()<br/>â€¢ step_retry_count = 0<br/>â€¢ execution_context.clear()]

    ResetDetail --> Reinit[é‡æ–°åˆå§‹åŒ–ExecutionContext]
    Reinit --> SendEvents[å‘é€äº‹ä»¶]

    SendEvents --> Event1[â€¢ åæ€å®Œæˆäº‹ä»¶<br/>â€¢ æ–°è®¡åˆ’ç”Ÿæˆäº‹ä»¶]

    Event1 --> IncCount[task_replan_count += 1]

    IncCount --> Continue[ç»§ç»­å¾ªç¯<br/>ä»ç¬¬ä¸€æ­¥é‡æ–°æ‰§è¡Œ]

    Continue --> Success([é‡è§„åˆ’å®Œæˆ])

    style CallLLM fill:#f9ca24
    style ReplacePlan fill:#ff6b6b
    style Reset fill:#45b7d1
    style Continue fill:#26de81
```

#### ä»£ç å®ç°

ğŸ“ **ä»£ç ä½ç½®**: [orchestrator.rs:1843-1983](d:\code\task-orchestration-service\src\core\orchestrator.rs#L1843-L1983)

```rust
// å¦‚æœå•æ­¥ä¿®å¤ä¸é€‚ç”¨æˆ–å¤±è´¥ï¼Œåˆ™è¿›è¡Œå…¨ä»»åŠ¡é‡æ–°è§„åˆ’
let replanning_prompt = if !step_reflection.is_recoverable {
    format!(
        "æ­¥éª¤ {} æ‰§è¡Œå¤±è´¥ï¼ŒåŸå› : {}\n\
        æ ¹æœ¬åŸå› åˆ†ç±»: {}\n\
        é”™è¯¯åˆ†æ: {}\n\
        å¤‡é€‰æ–¹æ¡ˆ: {:?}\n\
        è¯·é‡æ–°è§„åˆ’æ•´ä¸ªä»»åŠ¡ï¼Œé¿å…ç±»ä¼¼çš„å¤±è´¥ã€‚",
        step_info.step_id,
        step_reflection.root_cause,
        step_reflection.root_cause_category,
        step_reflection.analysis,
        step_reflection.alternative_solutions
    )
} else {
    format!(
        "æ­¥éª¤ {} å•æ­¥ä¿®å¤å¤±è´¥ï¼Œéœ€è¦é‡æ–°è§„åˆ’æ•´ä¸ªä»»åŠ¡ã€‚\n\
        é”™è¯¯ä¿¡æ¯: {}\n\
        æ ¹æœ¬åŸå› : {}\n\
        é”™è¯¯åˆ†æ: {}\n\
        è¯·æå‡ºæ”¹è¿›çš„æ•´ä½“æ–¹æ¡ˆã€‚",
        step_info.step_id,
        step_result.error_message.as_deref().unwrap_or("æœªçŸ¥é”™è¯¯"),
        step_reflection.root_cause,
        step_reflection.analysis
    )
};

info!(step_id = %step_info.step_id, "ğŸ”„ è¿›è¡Œå…¨ä»»åŠ¡é‡æ–°è§„åˆ’");

// 5. æ‰§è¡Œé‡æ–°è§„åˆ’ï¼ˆPhase 6 å®Œæ•´å®ç°ï¼‰
match self.planner.replan_task(
    task_description,
    &replanning_prompt,
    metadata.clone(),
    Some(event_sender.clone())
).await {
    Ok(new_plan) => {
        info!(
            old_plan_id = %current_plan.plan_id,
            new_plan_id = %new_plan.plan_id,
            old_steps = current_plan.steps.len(),
            new_steps = new_plan.steps.len(),
            "ğŸ”„ é‡æ–°è§„åˆ’æˆåŠŸï¼Œå·²è·å¾—æ–°è®¡åˆ’"
        );

        // âœ… ä½¿ç”¨æ–°è®¡åˆ’æ›¿æ¢å½“å‰è®¡åˆ’
        current_plan = new_plan;

        // âœ… é‡ç½®æ‰§è¡ŒçŠ¶æ€
        step_index = 0;                    // ä»å¤´å¼€å§‹
        last_step_index = usize::MAX;      // é‡ç½®æ­¥éª¤ç´¢å¼•è¿½è¸ª
        step_results.clear();              // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
        step_retry_count = 0;              // é‡ç½®æ­¥éª¤é‡è¯•è®¡æ•°

        // âœ… é‡æ–°åˆå§‹åŒ–æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆä½¿ç”¨æ–°çš„è®¡åˆ’ IDï¼‰
        execution_context.clear();
        execution_context.set_plan_id(current_plan.plan_id.clone());
        execution_context.init_metadata(metadata.clone());

        info!(new_plan_id = %current_plan.plan_id, "ğŸ”„ æ‰§è¡Œä¸Šä¸‹æ–‡å·²é‡æ–°åˆå§‹åŒ–");

        // ğŸš€ å®æ—¶å‘å®¢æˆ·ç«¯å‘é€é‡è§„åˆ’å®Œæˆä¿¡æ¯
        let reflection_result = ReflectionResult {
            reflection_id: format!("reflect_{}", task_replan_count),
            root_causes: vec![
                format!("æ­¥éª¤ {} æ‰§è¡Œå¤±è´¥", step_info.step_id),
                "å·²è¿›è¡Œæ·±åº¦åˆ†æå¹¶é‡æ–°è§„åˆ’".to_string(),
            ],
            alternative_approaches: vec![
                "âœ… æ–°è®¡åˆ’å·²ç”Ÿæˆ".to_string(),
                format!("æ–°è®¡åˆ’ID: {}", current_plan.plan_id),
                format!("æ–°è®¡åˆ’æ­¥éª¤æ•°: {}", current_plan.steps.len()),
            ],
            optimization_suggestions: vec![
                crate::core::reflector::OptimizationSuggestion {
                    aspect: "ä»»åŠ¡é‡è§„åˆ’".to_string(),
                    current_issue: format!("æ­¥éª¤ {} æ‰§è¡Œå¤±è´¥", step_info.step_id),
                    proposed_solution: "å·²æ ¹æ®å¤±è´¥åŸå› é‡æ–°ç”Ÿæˆæ‰§è¡Œè®¡åˆ’".to_string(),
                    expected_improvement: "æ–°è®¡åˆ’åº”é¿å…å¯¼è‡´å¤±è´¥çš„åŒæ ·é—®é¢˜".to_string(),
                },
            ],
            lessons_learned: vec![
                "è®°å½•å¤±è´¥åŸå› ä»¥ä¾¿æ”¹è¿›".to_string(),
                "æ–°è®¡åˆ’å·²ä¼˜åŒ–ä»»åŠ¡åˆ†è§£".to_string(),
                "å°†ä»ç¬¬ä¸€æ­¥å¼€å§‹æ‰§è¡Œæ–°è®¡åˆ’".to_string(),
            ],
            should_replan: false, // é‡è§„åˆ’å·²å®Œæˆ
        };
        event_sender.send_reflection_completed(&reflection_result);
        event_sender.send_plan_generated(&current_plan);

        // å¢åŠ ä»»åŠ¡é‡æ–°è§„åˆ’è®¡æ•°
        task_replan_count += 1;

        // âœ… ç»§ç»­å¾ªç¯æ‰§è¡Œæ–°è®¡åˆ’
        continue;
    }
    Err(e) => {
        error!(step_id = %step_info.step_id, error = %e, "âŒ é‡æ–°è§„åˆ’å¤±è´¥");
        return Err(crate::utils::ServiceError::TaskExecutionFailed(
            format!("æ­¥éª¤ {} æ‰§è¡Œå¤±è´¥ï¼Œé‡æ–°è§„åˆ’ä¹Ÿå¤±è´¥: {}", step_info.step_id, e)
        ).into());
    }
}
```

---

## ğŸ“Š é‡æ‰§è¡ŒçŠ¶æ€ç®¡ç†

### æ‰§è¡Œä¸Šä¸‹æ–‡é‡ç½®ç­–ç•¥

ä¸åŒä¿®å¤å±‚çº§å¯¹æ‰§è¡ŒçŠ¶æ€çš„å½±å“ï¼š

| ä¿®å¤å±‚çº§ | step_index | execution_context | step_results | current_plan |
|---------|-----------|-------------------|--------------|--------------|
| **å‚æ•°è°ƒæ•´é‡è¯•** | ä¿æŒä¸å˜ | ä¿æŒä¸å˜ | è¿½åŠ æˆåŠŸç»“æœ | ä¸å˜ |
| **åˆ‡æ¢å·¥å…·é‡è¯•** | ä¿æŒä¸å˜ | ä¿æŒä¸å˜ | è¿½åŠ æˆåŠŸç»“æœ | ä¸å˜ |
| **å•æ­¥ä¿®å¤** | ä¿æŒä¸å˜ | ä¿æŒä¸å˜ | ä¿ç•™å†å² | æ›¿æ¢å•ä¸ªæ­¥éª¤ |
| **å…¨å±€é‡è§„åˆ’** | é‡ç½®ä¸º0 | æ¸…ç©ºé‡å»º | æ¸…ç©º | å®Œå…¨æ›¿æ¢ |

---

### å…³é”®çŠ¶æ€å˜é‡

ğŸ“ **ä»£ç ä½ç½®**: [orchestrator.rs:1100-1110](d:\code\task-orchestration-service\src\core\orchestrator.rs#L1100-L1110)

```rust
let mut step_index = 0;                      // å½“å‰æ‰§è¡Œæ­¥éª¤ç´¢å¼•
let mut last_step_index = usize::MAX;        // ä¸Šä¸€æ¬¡æ‰§è¡Œçš„æ­¥éª¤ç´¢å¼•ï¼ˆæ£€æµ‹æ­¥éª¤åˆ‡æ¢ï¼‰
let mut step_retry_count = 0;                // å½“å‰æ­¥éª¤çš„é‡è¯•æ¬¡æ•°
let mut step_results: Vec<StepResult> = vec![]; // æ­¥éª¤æ‰§è¡Œç»“æœåˆ—è¡¨
let mut task_replan_count = 0;               // ä»»åŠ¡é‡æ–°è§„åˆ’æ¬¡æ•°
let mut single_step_repair_count = 0;        // å•æ­¥ä¿®å¤æ¬¡æ•°

let max_step_retries = 3;                    // å•æ­¥æœ€å¤§é‡è¯•æ¬¡æ•°
let max_task_replans = 2;                    // æœ€å¤§ä»»åŠ¡é‡è§„åˆ’æ¬¡æ•°
let max_single_step_repairs = 2;             // æœ€å¤§å•æ­¥ä¿®å¤æ¬¡æ•°
```

---

## ğŸ”— æ•°æ®æµè½¬è¯¦è§£

### ä»å¤±è´¥åˆ°é‡æ‰§è¡Œçš„å®Œæ•´æ•°æ®æµ

```mermaid
sequenceDiagram
    participant Step as æ­¥éª¤æ‰§è¡Œ
    participant Reflector as åæ€å™¨
    participant LLM as LLMæœåŠ¡
    participant Orchestrator as ç¼–æ’å™¨
    participant Executor as æ‰§è¡Œå™¨
    participant Context as æ‰§è¡Œä¸Šä¸‹æ–‡

    Step->>Step: æ‰§è¡Œå¤±è´¥
    Step->>Orchestrator: è¿”å›å¤±è´¥ç»“æœ

    Orchestrator->>Reflector: reflect_on_step()
    Note over Reflector: æ”¶é›†å¤±è´¥ä¿¡æ¯

    Reflector->>LLM: å‘é€åæ€æç¤ºè¯
    Note over LLM: åˆ†æå¤±è´¥åŸå› <br/>ç”Ÿæˆä¿®å¤å»ºè®®

    LLM->>Reflector: è¿”å›StepReflection
    Reflector->>Orchestrator: è¿”å›åæ€ç»“æœ

    Orchestrator->>Orchestrator: åˆ†å‘æ‰§è¡Œç­–ç•¥

    alt å‚æ•°è°ƒæ•´é‡è¯•
        Orchestrator->>Executor: execute_single_step_with_overrides<br/>(param_overrides)
        Executor->>Executor: åˆå¹¶å‚æ•°
        Executor->>Context: è·å–åŸå§‹å‚æ•°
        Context->>Executor: è¿”å›å‚æ•°
        Executor->>Executor: åº”ç”¨è¦†ç›–å‚æ•°
        Executor->>Step: é‡æ–°æ‰§è¡Œ
        Step->>Executor: è¿”å›ç»“æœ
        Executor->>Context: ä¿å­˜ç»“æœ
        Executor->>Orchestrator: è¿”å›æˆåŠŸ
    else åˆ‡æ¢å·¥å…·é‡è¯•
        Orchestrator->>Executor: execute_single_step_with_overrides<br/>(tool_override)
        Executor->>Executor: åˆ‡æ¢å·¥å…·
        Executor->>Executor: ä½¿ç”¨æ–°å·¥å…·å‚æ•°å®šä¹‰
        Executor->>Step: ä½¿ç”¨æ–°å·¥å…·æ‰§è¡Œ
        Step->>Executor: è¿”å›ç»“æœ
        Executor->>Orchestrator: è¿”å›æˆåŠŸ
    else å•æ­¥ä¿®å¤
        Orchestrator->>Orchestrator: replan_single_step()
        Orchestrator->>LLM: é‡æ–°è§„åˆ’å•æ­¥
        LLM->>Orchestrator: è¿”å›æ–°æ­¥éª¤å®šä¹‰
        Orchestrator->>Orchestrator: æ›¿æ¢è®¡åˆ’ä¸­çš„æ­¥éª¤
        Orchestrator->>Executor: æ‰§è¡Œä¿®å¤åçš„æ­¥éª¤
        Executor->>Step: æ‰§è¡Œ
        Step->>Executor: è¿”å›ç»“æœ
        Executor->>Orchestrator: è¿”å›æˆåŠŸ
    else å…¨å±€é‡è§„åˆ’
        Orchestrator->>Orchestrator: replan_task()
        Orchestrator->>LLM: é‡æ–°è§„åˆ’æ•´ä¸ªä»»åŠ¡
        LLM->>Orchestrator: è¿”å›æ–°ExecutionPlan
        Orchestrator->>Orchestrator: æ›¿æ¢æ•´ä¸ªè®¡åˆ’
        Orchestrator->>Context: æ¸…ç©ºé‡å»ºä¸Šä¸‹æ–‡
        Orchestrator->>Executor: ä»å¤´æ‰§è¡Œæ–°è®¡åˆ’
        Executor->>Step: æ‰§è¡Œæ‰€æœ‰æ­¥éª¤
        Step->>Executor: è¿”å›ç»“æœ
        Executor->>Orchestrator: è¿”å›æˆåŠŸ
    end
```

---

## ğŸ¯ å®é™…æ¡ˆä¾‹åˆ†æ

### æ¡ˆä¾‹1: å‚æ•°ç¼ºå¤± â†’ å‚æ•°è°ƒæ•´é‡è¯•æˆåŠŸ

**åœºæ™¯:**
ç”¨æˆ·æäº¤ä»»åŠ¡ï¼š"åŠ è½½é¡¹ç›®123çš„æ•°æ®å¹¶è¿›è¡Œåˆ†æ"

**æ‰§è¡Œè¿‡ç¨‹:**

```yaml
# ç¬¬1è½®æ‰§è¡Œ
Step 1: data_loader
  å‚æ•°: {file_path: "/data/load.csv"}
  ç»“æœ: âŒ å¤±è´¥
  é”™è¯¯: "Missing required parameter: project_id"

# å•æ­¥åæ€
LLMåˆ†æ:
  root_cause_category: "parameter_error"
  root_cause: "ç¼ºå°‘å¿…éœ€å‚æ•° project_id"
  is_recoverable: true
  suggested_action:
    type: "retry_with_params"
    data:
      project_id: "123"

# å‚æ•°è°ƒæ•´é‡è¯•
Step 1: data_loader (é‡è¯• 1/3)
  åŸå§‹å‚æ•°: {file_path: "/data/load.csv"}
  è°ƒæ•´å‚æ•°: {project_id: "123"}
  æœ€ç»ˆå‚æ•°: {file_path: "/data/load.csv", project_id: "123"}
  ç»“æœ: âœ… æˆåŠŸ
  è¾“å‡º: {data_source_id: "456", record_count: 1000}

# ç»§ç»­æ‰§è¡Œ
Step 2: data_analysis
  å‚æ•°: {data_source_id: "{{step_1.data_source_id}}"}
  ç»“æœ: âœ… æˆåŠŸ
```

**æ—¥å¿—è¾“å‡º:**

```
âŒ æ­¥éª¤æ‰§è¡Œå¤±è´¥ï¼Œå‡†å¤‡é‡è¯•
ğŸ” å¼€å§‹å•æ­¥åæ€åˆ†æ
ğŸ“¤ å‘é€å•æ­¥åæ€äº‹ä»¶åˆ°å®¢æˆ·ç«¯
ğŸ”„ å°è¯•ä½¿ç”¨è°ƒæ•´åçš„å‚æ•°é‡æ–°æ‰§è¡Œæ­¥éª¤ (é‡è¯• 1/3)
ğŸ”§ åº”ç”¨å‚æ•°è¦†ç›–
  â”œâ”€ è¦†ç›–å‚æ•°: project_id = 123
âœ… å‚æ•°è°ƒæ•´é‡è¯•æˆåŠŸ
```

---

### æ¡ˆä¾‹2: å·¥å…·é€‰æ‹©é”™è¯¯ â†’ åˆ‡æ¢å¤‡é€‰å·¥å…·æˆåŠŸ

**åœºæ™¯:**
è´Ÿè·é¢„æµ‹ä»»åŠ¡ï¼ŒLLM é”™è¯¯é€‰æ‹©äº†ä¸æ”¯æŒæ—¶é—´åºåˆ—çš„æ¨¡å‹è®­ç»ƒå·¥å…·

**æ‰§è¡Œè¿‡ç¨‹:**

```yaml
# ç¬¬1è½®æ‰§è¡Œ
Step 3: model_training
  å·¥å…·: simple_linear_trainer  # âŒ ä¸æ”¯æŒæ—¶é—´åºåˆ—
  å‚æ•°: {model_type: "lstm", data_source_id: "456"}
  ç»“æœ: âŒ å¤±è´¥
  é”™è¯¯: "Tool 'simple_linear_trainer' does not support time series models"

# å•æ­¥åæ€
LLMåˆ†æ:
  root_cause_category: "tool_error"
  root_cause: "æ‰€é€‰å·¥å…·ä¸æ”¯æŒæ—¶é—´åºåˆ—æ¨¡å‹"
  is_recoverable: true
  suggested_action:
    type: "retry_with_tool"
    data: "timeseries_model_trainer"  # ä»å¯ç”¨å·¥å…·åˆ—è¡¨ä¸­é€‰æ‹©

# åˆ‡æ¢å·¥å…·é‡è¯•
Step 3: model_training (é‡è¯• 1/3)
  åŸå§‹å·¥å…·: simple_linear_trainer
  å¤‡é€‰å·¥å…·: timeseries_model_trainer
  å‚æ•°: {model_type: "lstm", data_source_id: "456"}
  ç»“æœ: âœ… æˆåŠŸ
  è¾“å‡º: {model_id: "model_789", accuracy: 0.92}

# ç»§ç»­æ‰§è¡Œ
Step 4: prediction
  å‚æ•°: {model_id: "{{step_3.model_id}}"}
  ç»“æœ: âœ… æˆåŠŸ
```

**æ—¥å¿—è¾“å‡º:**

```
âŒ æ­¥éª¤æ‰§è¡Œå¤±è´¥ï¼Œå‡†å¤‡é‡è¯•
ğŸ” å¼€å§‹å•æ­¥åæ€åˆ†æ
ğŸ”„ å°è¯•ä½¿ç”¨å¤‡é€‰å·¥å…·é‡æ–°æ‰§è¡Œæ­¥éª¤ (é‡è¯• 1/3)
ğŸ”„ æ‰§è¡Œå•ä¸ªæ­¥éª¤ï¼ˆä½¿ç”¨å¤‡é€‰å·¥å…·ï¼‰
  original_tool: simple_linear_trainer
  override_tool: timeseries_model_trainer
âœ… å¤‡é€‰å·¥å…·é‡è¯•æˆåŠŸ
```

---

### æ¡ˆä¾‹3: å‚æ•°å€¼é”™è¯¯ â†’ å•æ­¥ä¿®å¤æˆåŠŸ

**åœºæ™¯:**
æ¨¡å‹è®­ç»ƒå­¦ä¹ ç‡è®¾ç½®è¿‡å¤§å¯¼è‡´å‘æ•£

**æ‰§è¡Œè¿‡ç¨‹:**

```yaml
# ç¬¬1è½®æ‰§è¡Œ
Step 2: model_training
  å·¥å…·: neural_network_trainer
  å‚æ•°: {learning_rate: "0.5", epochs: "100"}
  ç»“æœ: âŒ å¤±è´¥
  é”™è¯¯: "Training diverged: loss became NaN at epoch 3"

# å•æ­¥åæ€ï¼ˆé‡è¯•1ï¼‰
LLMå»ºè®®: è°ƒæ•´å­¦ä¹ ç‡ä¸º0.01
Step 2: model_training (é‡è¯• 1/3)
  å‚æ•°: {learning_rate: "0.01", epochs: "100"}
  ç»“æœ: âŒ å¤±è´¥
  é”™è¯¯: "Training too slow: loss not decreasing after 50 epochs"

# å•æ­¥åæ€ï¼ˆé‡è¯•2ï¼‰
LLMå»ºè®®: è°ƒæ•´å­¦ä¹ ç‡ä¸º0.001ï¼Œå‡å°‘epochs
Step 2: model_training (é‡è¯• 2/3)
  å‚æ•°: {learning_rate: "0.001", epochs: "50"}
  ç»“æœ: âŒ å¤±è´¥
  é”™è¯¯: "Insufficient training: validation loss still high"

# å•æ­¥åæ€ï¼ˆé‡è¯•3ï¼‰
LLMå»ºè®®: éœ€è¦æ›´å¤æ‚çš„è°ƒæ•´
Step 2: model_training (é‡è¯• 3/3)
  ç»“æœ: âŒ å¤±è´¥

# è¾¾åˆ°é‡è¯•ä¸Šé™ï¼Œè§¦å‘å•æ­¥ä¿®å¤
LLMå•æ­¥ä¿®å¤:
  åˆ†æ: "å­¦ä¹ ç‡è°ƒæ•´ä»æ— æ³•è§£å†³é—®é¢˜ï¼Œéœ€è¦åŒæ—¶è°ƒæ•´ä¼˜åŒ–å™¨å’Œå­¦ä¹ ç‡è¡°å‡ç­–ç•¥"
  æ–°æ­¥éª¤å®šä¹‰:
    å·¥å…·: neural_network_trainer
    å‚æ•°: {
      learning_rate: "0.001",
      epochs: "100",
      optimizer: "adam",
      lr_scheduler: "cosine_annealing",
      early_stopping: "true"
    }

# å•æ­¥ä¿®å¤åé‡æ–°æ‰§è¡Œ
Step 2: model_training (å•æ­¥ä¿®å¤å)
  å·¥å…·: neural_network_trainer
  å‚æ•°: {å®Œæ•´çš„ä¼˜åŒ–å‚æ•°}
  ç»“æœ: âœ… æˆåŠŸ
  è¾“å‡º: {model_id: "model_999", final_loss: 0.03}

# ç»§ç»­æ‰§è¡Œ
Step 3: model_evaluation
  ç»“æœ: âœ… æˆåŠŸ
```

**æ—¥å¿—è¾“å‡º:**

```
âŒ æ­¥éª¤é‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œå‡†å¤‡è§¦å‘ä»»åŠ¡é‡æ–°è§„åˆ’
ğŸ”§ å°è¯•å•æ­¥ä¿®å¤ï¼ˆåªä¿®å¤å¤±è´¥çš„æ­¥éª¤ï¼‰
ä½¿ç”¨ç­›é€‰åçš„ 15 ä¸ªå·¥å…·è¿›è¡Œå•æ­¥ä¿®å¤
âœ… å•æ­¥ä¿®å¤æˆåŠŸ
  old_tool: neural_network_trainer
  new_tool: neural_network_trainer
ğŸ”„ å•æ­¥ä¿®å¤æˆåŠŸï¼Œå°†é‡æ–°æ‰§è¡Œå½“å‰æ­¥éª¤
ğŸ“Š å•æ­¥ä¿®å¤è¿›åº¦: 1/2
```

---

### æ¡ˆä¾‹4: ä»»åŠ¡åˆ†è§£é”™è¯¯ â†’ å…¨å±€é‡è§„åˆ’æˆåŠŸ

**åœºæ™¯:**
è‡ªåŠ¨å»ºæ¨¡ä»»åŠ¡ï¼ŒLLM é—æ¼äº†å…³é”®çš„æ•°æ®é¢„å¤„ç†æ­¥éª¤

**æ‰§è¡Œè¿‡ç¨‹:**

```yaml
# ç¬¬1è½®æ‰§è¡Œï¼ˆåŸè®¡åˆ’ï¼‰
Plan ID: plan_001
Steps:
  1. data_loader       âœ… æˆåŠŸ
  2. model_training    âŒ å¤±è´¥
  é”™è¯¯: "Input data contains NaN values, preprocessing required"

# å•æ­¥åæ€
LLMåˆ†æ:
  root_cause_category: "decomposition_error"
  root_cause: "ä»»åŠ¡åˆ†è§£ç¼ºå°‘æ•°æ®æ¸…æ´—æ­¥éª¤"
  is_recoverable: false  # éœ€è¦å…¨å±€é‡è§„åˆ’
  suggested_action:
    type: "replan"

# å…¨å±€é‡è§„åˆ’
LLMé‡æ–°è§„åˆ’:
  åˆ†æ: "åŸè®¡åˆ’ç¼ºå°‘æ•°æ®é¢„å¤„ç†æ­¥éª¤ï¼Œæ•°æ®ä¸­å¯èƒ½å­˜åœ¨ç¼ºå¤±å€¼ã€å¼‚å¸¸å€¼ç­‰"
  æ–°è®¡åˆ’:
    Plan ID: plan_002
    Steps:
      1. data_loader          # ä¿ç•™
      2. data_quality_check   # âœ… æ–°å¢
      3. data_cleaning        # âœ… æ–°å¢
      4. feature_engineering  # âœ… æ–°å¢
      5. model_training       # ä¿®æ”¹å‚æ•°
      6. model_evaluation     # âœ… æ–°å¢

# ä»å¤´é‡æ–°æ‰§è¡Œæ–°è®¡åˆ’
æ‰§è¡Œä¸Šä¸‹æ–‡å·²é‡æ–°åˆå§‹åŒ–
å°†ä»ç¬¬ä¸€æ­¥å¼€å§‹æ‰§è¡Œæ–°è®¡åˆ’

Step 1: data_loader
  ç»“æœ: âœ… æˆåŠŸ

Step 2: data_quality_check
  ç»“æœ: âœ… æˆåŠŸ
  è¾“å‡º: {missing_ratio: 0.05, outlier_count: 23}

Step 3: data_cleaning
  ç»“æœ: âœ… æˆåŠŸ
  è¾“å‡º: {cleaned_data_id: "cleaned_456"}

Step 4: feature_engineering
  ç»“æœ: âœ… æˆåŠŸ

Step 5: model_training
  ç»“æœ: âœ… æˆåŠŸ

Step 6: model_evaluation
  ç»“æœ: âœ… æˆåŠŸ

ä»»åŠ¡å®Œæˆï¼
```

**æ—¥å¿—è¾“å‡º:**

```
âš ï¸ æ­¥éª¤é‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™
ğŸ”§ å°è¯•å•æ­¥ä¿®å¤
âš ï¸ å•æ­¥ä¿®å¤å¤±è´¥ï¼Œå°†å°è¯•å…¨ä»»åŠ¡é‡æ–°è§„åˆ’
ğŸ”„ è¿›è¡Œå…¨ä»»åŠ¡é‡æ–°è§„åˆ’
ğŸ”„ é‡æ–°è§„åˆ’æˆåŠŸï¼Œå·²è·å¾—æ–°è®¡åˆ’
  old_plan_id: plan_001
  new_plan_id: plan_002
  old_steps: 2
  new_steps: 6
ğŸ”„ æ‰§è¡Œä¸Šä¸‹æ–‡å·²é‡æ–°åˆå§‹åŒ–
ğŸ“¤ å‘é€é‡è§„åˆ’å®Œæˆäº‹ä»¶åˆ°å®¢æˆ·ç«¯
ğŸ“¤ å‘é€æ–°è®¡åˆ’ä¿¡æ¯åˆ°å®¢æˆ·ç«¯
ğŸ“Š é‡è§„åˆ’è¿›åº¦: 1/2
âœ… æ‰€æœ‰æ­¥éª¤æ‰§è¡Œå®Œæˆ
```

---

## ğŸ“ˆ æ€§èƒ½ä¸æ•ˆç‡åˆ†æ

### å„å±‚çº§ä¿®å¤çš„èµ„æºæ¶ˆè€—å¯¹æ¯”

| ä¿®å¤å±‚çº§ | LLMè°ƒç”¨æ¬¡æ•° | Tokenæ¶ˆè€— | æ‰§è¡Œæ—¶é—´ | æˆåŠŸç‡ |
|---------|------------|----------|---------|--------|
| **å‚æ•°è°ƒæ•´é‡è¯•** | 1æ¬¡ï¼ˆåæ€ï¼‰ | ~1K | 5-10ç§’ | 60% |
| **åˆ‡æ¢å·¥å…·é‡è¯•** | 1æ¬¡ï¼ˆåæ€ï¼‰ | ~1K | 5-10ç§’ | 50% |
| **å•æ­¥ä¿®å¤** | 2æ¬¡ï¼ˆåæ€+ä¿®å¤ï¼‰ | ~3K | 10-20ç§’ | 75% |
| **å…¨å±€é‡è§„åˆ’** | 2æ¬¡ï¼ˆåæ€+é‡è§„åˆ’ï¼‰ | ~10K | 20-40ç§’ | 90% |

---

### æ¸è¿›å¼ç­–ç•¥çš„ä¼˜åŠ¿

```mermaid
graph LR
    A[100ä¸ªå¤±è´¥åœºæ™¯] --> B[å°è¯•å‚æ•°è°ƒæ•´]
    B --> |60ä¸ªæˆåŠŸ| C1[èŠ‚çœ40æ¬¡å•æ­¥ä¿®å¤]
    B --> |40ä¸ªå¤±è´¥| D[å°è¯•åˆ‡æ¢å·¥å…·]
    D --> |20ä¸ªæˆåŠŸ| C2[èŠ‚çœ20æ¬¡å•æ­¥ä¿®å¤]
    D --> |20ä¸ªå¤±è´¥| E[å°è¯•å•æ­¥ä¿®å¤]
    E --> |15ä¸ªæˆåŠŸ| C3[èŠ‚çœ15æ¬¡å…¨å±€é‡è§„åˆ’]
    E --> |5ä¸ªå¤±è´¥| F[å…¨å±€é‡è§„åˆ’]
    F --> |4ä¸ªæˆåŠŸ| C4[æœ€ç»ˆ4ä¸ªå¤±è´¥]

    C1 --> Total[æ€»æˆåŠŸç‡: 96%]
    C2 --> Total
    C3 --> Total
    C4 --> Total

    style Total fill:#26de81
```

**æ•ˆç‡æå‡:**
- æ€»Tokenæ¶ˆè€—: ~180Kï¼ˆæ¸è¿›å¼ï¼‰ vs ~1000Kï¼ˆå…¨éƒ¨é‡è§„åˆ’ï¼‰
- æ€»æ‰§è¡Œæ—¶é—´: ~800ç§’ vs ~3000ç§’
- èµ„æºèŠ‚çœ: **82%**

---

## ğŸ”§ é…ç½®ä¸è°ƒä¼˜

### ç›¸å…³é…ç½®é¡¹

ğŸ“ **é…ç½®æ–‡ä»¶**: `config.toml`

```toml
[orchestrator]
# æœ€å¤§åæ€è½®æ¬¡ï¼ˆå…¨å±€è¯„ä¼°-åæ€å¾ªç¯ï¼‰
max_reflection_rounds = 3

# å•æ­¥æœ€å¤§é‡è¯•æ¬¡æ•°
max_step_retries = 3

# æœ€å¤§å•æ­¥ä¿®å¤æ¬¡æ•°
max_single_step_repairs = 2

# æœ€å¤§ä»»åŠ¡é‡è§„åˆ’æ¬¡æ•°
max_task_replans = 2

# æˆåŠŸé˜ˆå€¼ï¼ˆè¯„ä¼°åˆ†æ•°ï¼‰
success_threshold = 70.0

[llm]
# å¯ç”¨æµå¼å“åº”ï¼ˆåæ€é˜¶æ®µï¼‰
enable_streaming = true

# LLMæ¸©åº¦ï¼ˆå½±å“åæ€çš„åˆ›é€ æ€§ï¼‰
temperature = 0.7
```

---

### è°ƒä¼˜å»ºè®®

| åœºæ™¯ | è°ƒæ•´é…ç½® | åŸå›  |
|------|---------|------|
| **å¿«é€Ÿå¤±è´¥ï¼Œé™ä½æˆæœ¬** | max_step_retries = 2<br/>max_task_replans = 1 | å‡å°‘é‡è¯•æ¬¡æ•° |
| **æé«˜æˆåŠŸç‡** | max_step_retries = 5<br/>max_single_step_repairs = 3 | å¢åŠ ä¿®å¤æœºä¼š |
| **ç¨³å®šä»»åŠ¡** | max_step_retries = 1<br/>ç›´æ¥å•æ­¥ä¿®å¤ | å‡å°‘ç›²ç›®é‡è¯• |
| **å¤æ‚ä»»åŠ¡** | max_task_replans = 3 | å…è®¸å¤šæ¬¡å…¨å±€ä¼˜åŒ– |

---

## ğŸš€ æœ€ä½³å®è·µ

### 1. å·¥å…·å®šä¹‰æ¸…æ™°

ç¡®ä¿å·¥å…·çš„ `input_params` å’Œ `output_params` å®šä¹‰å®Œæ•´ï¼Œå¸®åŠ© LLM å‡†ç¡®åˆ†æå‚æ•°é—®é¢˜ã€‚

```json
{
  "id": "data_loader",
  "input_params": [
    {
      "name": "project_id",
      "data_type": "string",
      "required": true,
      "description": "é¡¹ç›®IDï¼Œç”¨äºå®šä½æ•°æ®æº"
    }
  ]
}
```

---

### 2. metadata æä¾›å……åˆ†ä¿¡æ¯

åœ¨ä»»åŠ¡æäº¤æ—¶ï¼Œé€šè¿‡ metadata æä¾›å°½å¯èƒ½å¤šçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå‡å°‘å‚æ•°ç¼ºå¤±é—®é¢˜ã€‚

```json
{
  "metadata": {
    "project_id": "123",
    "user_id": "user_456",
    "data_path": "/data",
    "environment": "production"
  }
}
```

---

### 3. ç›‘æ§åæ€è´¨é‡

é€šè¿‡ Kafka æ—¥å¿—ç›‘æ§åæ€çš„å‡†ç¡®æ€§å’Œä¿®å¤æˆåŠŸç‡ï¼ŒæŒç»­ä¼˜åŒ–æç¤ºè¯ã€‚

```bash
# æŸ¥è¯¢å•æ­¥åæ€çš„æˆåŠŸç‡
grep "å‚æ•°è°ƒæ•´é‡è¯•æˆåŠŸ" kafka.log | wc -l
grep "å¤‡é€‰å·¥å…·é‡è¯•æˆåŠŸ" kafka.log | wc -l
```

---

### 4. åˆ©ç”¨æ ‡å‡†å·¥ä½œæµ

å¯¹äºå¸¸è§ä»»åŠ¡ç±»å‹ï¼Œå®šä¹‰æ ‡å‡†å·¥ä½œæµå¯ä»¥å‡å°‘ä»»åŠ¡åˆ†è§£é”™è¯¯ï¼Œé™ä½å…¨å±€é‡è§„åˆ’çš„éœ€æ±‚ã€‚

---

## ğŸ“š æ€»ç»“

### æ ¸å¿ƒèƒ½åŠ›

1. âœ… **æ™ºèƒ½åˆ†æ**: LLM æ·±åº¦åˆ†æå¤±è´¥åŸå› ï¼Œè¯†åˆ«5å¤§ç±»é—®é¢˜
2. âœ… **ç²¾å‡†ä¿®å¤**: æ ¹æ®é—®é¢˜ç±»å‹é€‰æ‹©æœ€ä¼˜ä¿®å¤ç­–ç•¥
3. âœ… **æ¸è¿›å¼ä¼˜åŒ–**: ä»è½»é‡åˆ°é‡é‡ï¼Œæœ€å¤§åŒ–æ•ˆç‡
4. âœ… **è‡ªé€‚åº”è°ƒæ•´**: åŠ¨æ€è°ƒæ•´å‚æ•°å’Œå·¥å…·
5. âœ… **å®Œæ•´ä¸Šä¸‹æ–‡**: ä¿æŒæ‰§è¡ŒçŠ¶æ€å’Œæ•°æ®æµè½¬çš„ä¸€è‡´æ€§

---

### æŠ€æœ¯äº®ç‚¹

- ğŸ§  **LLMé©±åŠ¨çš„é—®é¢˜è¯Šæ–­**ï¼šä¸æ˜¯ç®€å•çš„é”™è¯¯åŒ¹é…ï¼Œè€Œæ˜¯ç†è§£é—®é¢˜æœ¬è´¨
- ğŸ¯ **ä¸‰å±‚ä¿®å¤ç­–ç•¥**ï¼šå¹³è¡¡æ•ˆç‡å’ŒæˆåŠŸç‡
- ğŸ”„ **çŠ¶æ€ç²¾ç¡®ç®¡ç†**ï¼šä¸åŒå±‚çº§çš„çŠ¶æ€é‡ç½®ç­–ç•¥
- ğŸ“Š **å®Œæ•´å¯è¿½æº¯**ï¼šKafkaæ—¥å¿—è®°å½•æ¯æ¬¡åæ€å’Œä¿®å¤
- ğŸš€ **å®æ—¶åé¦ˆ**ï¼šé€šè¿‡äº‹ä»¶æ¨é€è®©ç”¨æˆ·äº†è§£ä¿®å¤è¿›åº¦

---

### é€‚ç”¨åœºæ™¯

âœ… **å¼ºçƒˆæ¨èä½¿ç”¨åœºæ™¯:**
- å¤æ‚çš„å¤šæ­¥éª¤ä»»åŠ¡
- ä¾èµ–å¤–éƒ¨æœåŠ¡å’Œæ•°æ®æº
- å‚æ•°é…ç½®å¤æ‚
- éœ€è¦é«˜æˆåŠŸç‡

âš ï¸ **è°¨æ…ä½¿ç”¨åœºæ™¯:**
- ç®€å•çš„å•æ­¥ä»»åŠ¡
- æˆæœ¬æ•æ„Ÿçš„åœºæ™¯
- å®æ—¶æ€§è¦æ±‚æé«˜çš„ä»»åŠ¡

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®æ¶æ„è§£æ.md](../é¡¹ç›®æ¶æ„è§£æ.md) - æ€»ä½“æ¶æ„æ¦‚è§ˆ
- [å‚æ•°è§£æä¸å ä½ç¬¦å¤„ç†.md](å‚æ•°è§£æä¸å ä½ç¬¦å¤„ç†.md) - å‚æ•°æµè½¬è¯¦è§£
- [å¹¶è¡Œæ‰§è¡Œæœºåˆ¶è¯¦è§£.md](å¹¶è¡Œæ‰§è¡Œæœºåˆ¶è¯¦è§£.md) - DAGè°ƒåº¦åŸç†

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-01-01
**ç»´æŠ¤è€…**: Task Orchestration Service Team
