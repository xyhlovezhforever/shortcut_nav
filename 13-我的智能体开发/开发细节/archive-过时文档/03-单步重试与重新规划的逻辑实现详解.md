# å•æ­¥é‡è¯•ä¸é‡æ–°è§„åˆ’çš„é€»è¾‘å®ç°è¯¦è§£

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ä»»åŠ¡ç¼–æ’æœåŠ¡ä¸­å•æ­¥é‡è¯•ä¸é‡æ–°è§„åˆ’çš„å®Œæ•´å®ç°é€»è¾‘ï¼ŒåŒ…æ‹¬å¤±è´¥æ£€æµ‹ã€æ™ºèƒ½åæ€ã€åˆ†å±‚æ¢å¤ç­–ç•¥å’Œä»£ç å®ç°ç»†èŠ‚ã€‚

## ç›®å½•

1. [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
2. [å®Œæ•´æ‰§è¡Œæµç¨‹](#å®Œæ•´æ‰§è¡Œæµç¨‹)
3. [æ ¸å¿ƒç»„ä»¶è¯¦è§£](#æ ¸å¿ƒç»„ä»¶è¯¦è§£)
4. [åˆ†å±‚æ¢å¤ç­–ç•¥](#åˆ†å±‚æ¢å¤ç­–ç•¥)
5. [å…³é”®ä»£ç å®ç°](#å…³é”®ä»£ç å®ç°)
6. [å®æˆ˜ç¤ºä¾‹](#å®æˆ˜ç¤ºä¾‹)
7. [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)

---

## æ ¸å¿ƒæ¶æ„

### ç³»ç»Ÿç»„ä»¶å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Orchestrator                          â”‚
â”‚  (ä»»åŠ¡ç¼–æ’å™¨ - ä¸»æ§åˆ¶æµç¨‹)                                      â”‚
â”‚  ğŸ“ src/core/orchestrator.rs                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â–º â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    â”‚        Executor                      â”‚
         â”‚    â”‚   (æ­¥éª¤æ‰§è¡Œå™¨)                        â”‚
         â”‚    â”‚   ğŸ“ src/core/executor.rs            â”‚
         â”‚    â”‚   ğŸ”§ execute_single_step (742è¡Œ)     â”‚
         â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â–º â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    â”‚        Reflector                     â”‚
         â”‚    â”‚   (åæ€åˆ†æå™¨)                        â”‚
         â”‚    â”‚   ğŸ“ src/core/reflector.rs           â”‚
         â”‚    â”‚   ğŸ” reflect_on_step (587è¡Œ)         â”‚
         â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â””â”€â”€â–º â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚        Planner                       â”‚
              â”‚   (ä»»åŠ¡è§„åˆ’å™¨)                        â”‚
              â”‚   ğŸ“ src/core/planner.rs             â”‚
              â”‚   ğŸ”„ replan_single_step (577è¡Œ)      â”‚
              â”‚   ğŸ”„ replan_task (453è¡Œ)             â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æ•°æ®ç»“æ„

#### StepReflectionï¼ˆå•æ­¥åæ€ç»“æœï¼‰

**æ–‡ä»¶**: `src/core/reflector.rs` (78-98è¡Œ)

```rust
pub struct StepReflection {
    pub reflection_id: String,         // åæ€ID
    pub step_id: String,               // æ­¥éª¤ID
    pub root_cause: String,            // æ ¹æœ¬åŸå› æè¿°
    pub root_cause_category: String,   // æ ¹å› åˆ†ç±»
    pub suggested_action: StepAction,  // å»ºè®®çš„æ¢å¤è¡ŒåŠ¨
    pub confidence: f32,               // å¯ä¿¡åº¦(0-100)
    pub analysis: String,              // è¯¦ç»†åˆ†æ
    pub alternative_solutions: Vec<String>, // å¤‡é€‰æ–¹æ¡ˆ
    pub is_recoverable: bool,          // æ˜¯å¦å¯æ¢å¤
}
```

#### StepActionï¼ˆæ¢å¤è¡ŒåŠ¨ç±»å‹ï¼‰

```rust
pub enum StepAction {
    RetryWithAdjustedParams(HashMap<String, String>), // è°ƒæ•´å‚æ•°é‡è¯•
    RetryWithAlternativeTool(String),                 // ä½¿ç”¨å¤‡é€‰å·¥å…·
    ReplanEntireTask,                                 // é‡æ–°è§„åˆ’æ•´ä¸ªä»»åŠ¡
    StopExecution,                                    // åœæ­¢æ‰§è¡Œ
}
```

---

## å®Œæ•´æ‰§è¡Œæµç¨‹

### æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant O as Orchestrator<br/>(ç¼–æ’å™¨)
    participant E as Executor<br/>(æ‰§è¡Œå™¨)
    participant R as Reflector<br/>(åæ€å™¨)
    participant P as Planner<br/>(è§„åˆ’å™¨)
    participant L as LLM<br/>(å¤§æ¨¡å‹)

    Note over O: æ­¥éª¤çº§åæ€æ¨¡å¼å¯åŠ¨
    O->>E: execute_single_step(step_index)
    E->>E: è§£æå‚æ•°<br/>(ParameterResolver)
    E->>E: è°ƒç”¨å·¥å…·æ‰§è¡Œ
    
    alt æ‰§è¡ŒæˆåŠŸ
        E-->>O: StepResult(success=true)
        O->>O: ä¿å­˜ç»“æœåˆ°ExecutionContext
        O->>O: step_index += 1
        Note over O: âœ… ç»§ç»­ä¸‹ä¸€æ­¥
    else æ‰§è¡Œå¤±è´¥
        E-->>O: StepResult(success=false)
        O->>R: reflect_on_step(step_id, error)
        R->>L: è°ƒç”¨LLMåˆ†æå¤±è´¥åŸå› 
        L-->>R: JSONæ ¼å¼çš„åˆ†æç»“æœ
        R->>R: è§£æä¸ºStepReflection
        R-->>O: StepReflection
        
        Note over O: å†³ç­–æ¢å¤ç­–ç•¥
        O->>O: step_retry_count += 1
        
        alt step_retry_count < max_retries
            alt suggested_action=RetryWithParams
                Note over O: ğŸ”„ ç¬¬1å±‚: å‚æ•°è°ƒæ•´é‡è¯•
                O->>E: execute_with_overrides(adjusted_params)
                E-->>O: StepResult
                alt é‡è¯•æˆåŠŸ
                    Note over O: âœ… ç»§ç»­ä¸‹ä¸€æ­¥
                else é‡è¯•å¤±è´¥
                    Note over O: ğŸ” å¾ªç¯é‡è¯•æˆ–è¿›å…¥ä¸‹ä¸€ç­–ç•¥
                end
            else suggested_action=RetryWithTool
                Note over O: ğŸ”„ ç¬¬1å±‚: å¤‡é€‰å·¥å…·é‡è¯•
                O->>E: execute_with_overrides(alternative_tool)
                E-->>O: StepResult
            end
        else step_retry_count >= max_retries
            alt is_recoverable && single_repair < max
                Note over O: ğŸ”§ ç¬¬2å±‚: å•æ­¥ä¿®å¤
                O->>P: replan_single_step(failed_step)
                P->>L: è¯·æ±‚ä¿®å¤å•ä¸ªæ­¥éª¤
                L-->>P: ä¿®å¤åçš„æ­¥éª¤å®šä¹‰
                P-->>O: æ–°çš„PlanStep
                O->>O: æ›¿æ¢æ­¥éª¤å®šä¹‰<br/>step_indexä¸å˜
                O->>O: single_step_repair_count += 1
                Note over O: ğŸ” é‡æ–°æ‰§è¡Œä¿®å¤åçš„æ­¥éª¤
            else task_replan < max_replans
                Note over O: ğŸ”„ ç¬¬3å±‚: ä»»åŠ¡é‡æ–°è§„åˆ’
                O->>P: replan_task(error_context)
                P->>L: è¯·æ±‚é‡æ–°è§„åˆ’æ•´ä¸ªä»»åŠ¡
                L-->>P: å…¨æ–°çš„ExecutionPlan
                P-->>O: æ–°çš„è®¡åˆ’
                O->>O: current_plan = new_plan<br/>step_index = 0<br/>æ¸…ç©ºå·²æ‰§è¡Œç»“æœ
                O->>O: task_replan_count += 1
                Note over O: ğŸ” ä»å¤´å¼€å§‹æ‰§è¡Œæ–°è®¡åˆ’
            else è¾¾åˆ°é‡è§„åˆ’ä¸Šé™
                Note over O: âŒ ä»»åŠ¡å¤±è´¥
                O-->>O: è¿”å›å¤±è´¥
            end
        end
    end
```

## æ ¸å¿ƒç»„ä»¶è¯¦è§£

### Orchestratorï¼ˆä»»åŠ¡ç¼–æ’å™¨ï¼‰

- **æ–‡ä»¶**: `src/core/orchestrator.rs`
- **æ ¸å¿ƒæ–¹æ³•**: `execute_execution_phase_with_metadata()`ï¼ˆçº¦ 663-1559 è¡Œï¼‰
- **èŒè´£**:
  - è´Ÿè´£æ‰§è¡Œé˜¶æ®µä¸»å¾ªç¯ï¼ˆé¡ºåºéå† `current_plan.steps`ï¼‰ã€‚
  - ç»´æŠ¤ä¸‰ç±»è®¡æ•°ï¼š`step_retry_count`ã€`single_step_repair_count`ã€`task_replan_count`ã€‚
  - è°ƒç”¨ `Executor` æ‰§è¡Œå•æ­¥ï¼›å¤±è´¥æ—¶è§¦å‘ `Reflector` åšå•æ­¥åæ€ï¼›å¿…è¦æ—¶è°ƒç”¨ `Planner` åšå•æ­¥ä¿®å¤æˆ–ä»»åŠ¡çº§é‡è§„åˆ’ã€‚
  - å‘å®¢æˆ·ç«¯å‘é€æ­¥éª¤æ‰§è¡Œã€è¯„ä¼°ã€åæ€ã€é‡è§„åˆ’ç­‰äº‹ä»¶ã€‚

### Reflectorï¼ˆåæ€åˆ†æå™¨ï¼‰

- **æ–‡ä»¶**: `src/core/reflector.rs`
- **å…³é”®ç»“æ„**: `StepReflection`ï¼ˆ78-98 è¡Œï¼‰
- **å…³é”®æ–¹æ³•**: `reflect_on_step()`ï¼ˆ587-669 è¡Œï¼‰
- **èŒè´£**:
  - åŸºäºæ­¥éª¤ IDã€å·¥å…· IDã€é”™è¯¯ä¿¡æ¯ã€æ­¥éª¤æè¿°å’Œå½“å‰ metadata æ„é€  promptã€‚
  - è°ƒç”¨ LLM è¿”å›ç»“æ„åŒ– JSONï¼Œè§£æä¸º `StepReflection`ï¼šåŒ…æ‹¬æ ¹å› åˆ†ç±»ã€æ˜¯å¦å¯æ¢å¤ã€å»ºè®®è¡ŒåŠ¨ `StepAction` ç­‰ã€‚
  - è§£æå¤±è´¥æ—¶é™çº§ä¸ºé»˜è®¤ `StepReflection`ï¼Œé¿å…é˜»å¡æ•´ä½“æµç¨‹ã€‚

### Plannerï¼ˆä»»åŠ¡è§„åˆ’å™¨ï¼‰

- **æ–‡ä»¶**: `src/core/planner.rs`
- **æ•´ä½“é‡è§„åˆ’**: `replan_task()`ï¼ˆ452-571 è¡Œï¼‰
  - æ ¹æ®å¤±è´¥åŸå› ä¸å…ƒæ•°æ®æ„é€  promptï¼Œè¯·æ±‚ LLM é‡æ–°ç”Ÿæˆå®Œæ•´ `ExecutionPlan`ã€‚
  - è§£æ LLM å“åº”ä¸ºæ–°è®¡åˆ’ï¼Œå¹¶è®°å½•åˆ° Kafkaã€‚
- **å•æ­¥ä¿®å¤**: `replan_single_step()`ï¼ˆ573-650 è¡Œï¼‰
  - åªä¿®å¤æŒ‡å®šå¤±è´¥æ­¥éª¤ï¼Œä¿æŒ `step_id` ä¸å˜ã€‚
  - è®© LLM åœ¨å¯ç”¨å·¥å…·åˆ—è¡¨ä¸­é€‰æ‹©æ›´åˆé€‚çš„å·¥å…· / å‚æ•°ï¼Œç”Ÿæˆæ–°çš„ `PlanStep`ã€‚

### Executorï¼ˆæ­¥éª¤æ‰§è¡Œå™¨ï¼‰

- **æ–‡ä»¶**: `src/core/executor.rs`
- **ç›¸å…³æ–¹æ³•**:
  - `execute_single_step()`ï¼ˆ741-755 è¡Œï¼‰
  - `execute_single_step_with_overrides()`ï¼ˆ759-865 è¡Œï¼‰
- **èŒè´£**:
  - æ ¹æ® `ExecutionPlan` å’Œ `ExecutionContext` è§£æå‚æ•°ï¼ˆæ”¯æŒå‚æ•°è¦†ç›– `param_overrides`ï¼‰ã€‚
  - æ”¯æŒå·¥å…·è¦†ç›– `tool_override`ï¼Œç”¨äºå¤‡é€‰å·¥å…·é‡è¯•åœºæ™¯ã€‚
  - è°ƒç”¨åº•å±‚å·¥å…·å¹¶è¿”å› `StepResult`ï¼Œä¾› Orchestrator åšåç»­å¤„ç†ã€‚

## åˆ†å±‚æ¢å¤ç­–ç•¥

ç³»ç»Ÿé‡‡ç”¨ä¸‰å±‚æ¢å¤ç­–ç•¥ï¼Œç”± Orchestrator åœ¨å•æ­¥å¤±è´¥æ—¶ç»Ÿä¸€è°ƒåº¦ï¼š

1. **ç¬¬ 1 å±‚ï¼šæ­¥éª¤çº§é‡è¯•**ï¼ˆå‚æ•°é‡è¯• / å¤‡é€‰å·¥å…·é‡è¯•ï¼‰
2. **ç¬¬ 2 å±‚ï¼šå•æ­¥ä¿®å¤**ï¼ˆåªé‡å†™å½“å‰å¤±è´¥æ­¥éª¤ï¼‰
3. **ç¬¬ 3 å±‚ï¼šä»»åŠ¡çº§é‡æ–°è§„åˆ’**ï¼ˆé‡æ–°ç”Ÿæˆæ•´ä¸ªæ‰§è¡Œè®¡åˆ’ï¼‰

### ç¬¬ 1 å±‚ï¼šæ­¥éª¤çº§é‡è¯•

- **è§¦å‘æ¡ä»¶**ï¼š
  - å½“å‰æ­¥éª¤æ‰§è¡Œå¤±è´¥ï¼Œ`StepResult.is_success = false`ï¼›
  - `step_retry_count < max_step_retries`ï¼›
  - å•æ­¥åæ€ `StepReflection.suggested_action` ä¸ºï¼š
    - `RetryWithAdjustedParams(...)`ï¼Œæˆ–
    - `RetryWithAlternativeTool(...)`ã€‚
- **å®ç°è¦ç‚¹ï¼ˆorchestrator.rs 1056-1205 è¡Œé™„è¿‘ï¼‰**ï¼š
  - å‚æ•°é‡è¯•ï¼šè°ƒç”¨ `execute_single_step_with_overrides(..., Some(adjusted_params), None)`ã€‚
  - å·¥å…·é‡è¯•ï¼šè°ƒç”¨ `execute_single_step_with_overrides(..., None, Some(alternative_tool_id))`ã€‚
  - æˆåŠŸåˆ™è§†ä¸ºæ­£å¸¸æˆåŠŸè·¯å¾„ï¼Œæ¨è¿›åˆ°ä¸‹ä¸€æ­¥ï¼›å¤±è´¥åˆ™å¢åŠ  `step_retry_count`ï¼Œåœ¨ä¸Šé™å†…ç»§ç»­å¾ªç¯å°è¯•æˆ–å‡çº§åˆ°ä¸‹ä¸€å±‚ã€‚

### ç¬¬ 2 å±‚ï¼šå•æ­¥ä¿®å¤ï¼ˆSingle-Step Repairï¼‰

- **è§¦å‘æ¡ä»¶**ï¼š
  - å·²ç»è¾¾åˆ°æ­¥éª¤é‡è¯•ä¸Šé™ï¼Œæˆ–åæ€å»ºè®®ç›´æ¥ä»»åŠ¡é‡è§„åˆ’ï¼›
  - åæ€ç»“æœ `is_recoverable = true`ï¼›
  - `single_step_repair_count < max_single_step_repairs`ã€‚
- **å®ç°è¦ç‚¹ï¼ˆorchestrator.rs 1303-1416 è¡Œï¼‰**ï¼š
  - Orchestrator è°ƒç”¨ `planner.replan_single_step(...)` è¯·æ±‚ LLM ç”Ÿæˆæ–°çš„ `PlanStep`ã€‚
  - æ›¿æ¢ `current_plan.steps` ä¸­å¯¹åº”çš„æ­¥éª¤å®šä¹‰ï¼Œä¿æŒ `step_id` ä¸å˜ã€‚
  - é‡ç½®å½“å‰æ­¥éª¤çš„é‡è¯•è®¡æ•°ï¼Œå¹¶ä»å½“å‰ `step_index` å†æ¬¡æ‰§è¡Œï¼ˆç›¸å½“äºâ€œä¿®å¥½è¿™ä¸€æ­¥å†è·‘ä¸€éâ€ï¼‰ã€‚

### ç¬¬ 3 å±‚ï¼šä»»åŠ¡çº§é‡æ–°è§„åˆ’ï¼ˆTask-Level Replanningï¼‰

- **è§¦å‘æ¡ä»¶**ï¼š
  - å•æ­¥ä¿®å¤å¤±è´¥æˆ–ä¸é€‚ç”¨ï¼Œæˆ–åæ€ç»“æœ `is_recoverable = false`ï¼›
  - `task_replan_count < max_task_replans`ã€‚
- **å®ç°è¦ç‚¹ï¼ˆorchestrator.rs 1418-1559 è¡Œ + planner.rs 452-571 è¡Œï¼‰**ï¼š
  - æ„é€  `replanning_prompt`ï¼Œæ•´åˆå¤±è´¥æ­¥éª¤ã€æ ¹å› åˆ†ç±»ã€åˆ†æå’Œå¤‡é€‰æ–¹æ¡ˆç­‰ä¿¡æ¯ã€‚
  - è°ƒç”¨ `replan_task(...)` ç”Ÿæˆæ–°çš„ `ExecutionPlan`ã€‚
  - å°† `current_plan` æ›¿æ¢ä¸ºæ–°è®¡åˆ’ï¼Œ`step_index` ç½® 0ï¼Œå¹¶é‡ç½®æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œä»å¤´é‡æ–°æ‰§è¡Œã€‚

### ç»ˆæ­¢æ¡ä»¶

- `task_replan_count >= max_task_replans`ï¼šç›´æ¥è¿”å› `TaskExecutionFailed`ï¼Œä»»åŠ¡ç»ˆæ­¢ï¼›
- åæ€å»ºè®® `StepAction::StopExecution`ï¼šç«‹å³ç»ˆæ­¢æ‰§è¡Œå¹¶è¿”å›é”™è¯¯ã€‚

## ä»£ç æ‰§è¡Œè·¯å¾„è¯¦è§£ï¼ˆæŒ‰åˆ†æ”¯ï¼‰

æœ¬èŠ‚ä»â€œä»£ç æ‰§è¡Œè·¯å¾„â€çš„è§’åº¦ï¼Œåˆ†åˆ«è¯´æ˜å‡ ç§å…¸å‹åˆ†æ”¯ä¸‹çš„è°ƒç”¨é¡ºåºä¸å…³é”®å˜é‡å˜åŒ–ï¼Œæ–¹ä¾¿ä»æ—¥å¿—æˆ–è°ƒç”¨æ ˆåå‘å®šä½é€»è¾‘ã€‚

ä¸ºç®€åŒ–æè¿°ï¼Œç»Ÿä¸€å‡è®¾å·²è¿›å…¥æ­¥éª¤çº§åæ€æ¨¡å¼ï¼ˆå³ `reflection.enable_step_level_reflection = true`ï¼‰ï¼Œä¸”æ­£åœ¨ `execute_execution_phase_with_metadata()` çš„ä¸»å¾ªç¯ä¸­ã€‚

### 1. æ­£å¸¸æˆåŠŸè·¯å¾„

**å¯¹åº”ä»£ç **ï¼š
- `orchestrator.rs`ï¼š877-951 è¡Œ
- `executor.rs`ï¼š741-755, 759-865 è¡Œ

**æ‰§è¡Œæ­¥éª¤**ï¼š

1. Orchestrator å–å‡ºå½“å‰ `step_info`ï¼š
   - æ¥è‡ª `current_plan.steps[step_index]`ï¼ŒåŒæ—¶ç»´æŠ¤ `last_step_index`ã€`step_retry_count` ç­‰å˜é‡ã€‚
2. è°ƒç”¨æ‰§è¡Œå™¨ï¼š
   - `self.executor.execute_single_step(&current_plan, step_index, &execution_context, &available_tools)`ã€‚
   - å†…éƒ¨ä¼šè§£æå‚æ•°ï¼ˆ`ParameterResolver::resolve_parameters`ï¼‰ï¼Œå¹¶è°ƒç”¨åº•å±‚å·¥å…·ï¼Œè¿”å› `StepResult`ã€‚
3. å°† `StepResult` é€‚é…ä¸º `StepExecutionResult`ï¼š
   - å­—æ®µåŒ…æ‹¬ `step_id`ã€`step_name`ã€`tool_id`ã€`output`ã€`is_success`ã€`error_message`ã€‚
4. è°ƒç”¨ `StepLevelReflector::evaluate_step_result(...)` åšè½»é‡çº§è¯„ä¼°ï¼ˆé LLMï¼‰ï¼š
   - è‹¥ `evaluation.success == true`ï¼Œè¿›å…¥æˆåŠŸåˆ†æ”¯ã€‚
5. æˆåŠŸåˆ†æ”¯ä¸­ï¼š
   - `send_step_completed(&step_result)`ï¼šå‘å®¢æˆ·ç«¯å‘é€â€œæ­¥éª¤å®Œæˆâ€äº‹ä»¶ã€‚
   - æ„é€  `EvaluationResult`ï¼ˆå››ä¸ªç»´åº¦å‡ 100 åˆ†ï¼‰å¹¶ `send_evaluation_completed(...)`ã€‚
   - å°†å½“å‰æ­¥çš„ `StepExecutionResult` å†™å…¥ `ExecutionContext`ï¼Œå¹¶é€šè¿‡ `sync_step_output_to_metadata(...)` åŒæ­¥åˆ°è¿è¡Œæ—¶å…ƒæ•°æ®ã€‚
   - `step_results.push(step_result)`ï¼Œ`step_index += 1`ï¼Œå¾ªç¯è¿›å…¥ä¸‹ä¸€æ­¥ã€‚

### 2. å¤±è´¥ + å‚æ•°é‡è¯•åˆ†æ”¯ï¼ˆ`RetryWithAdjustedParams`ï¼‰

**å¯¹åº”ä»£ç **ï¼š
- `orchestrator.rs`ï¼š952-1134 è¡Œ
- `reflector.rs`ï¼š587-669, 672-723+ è¡Œ
- `executor.rs`ï¼š759-865 è¡Œ

**æ‰§è¡Œæ­¥éª¤**ï¼š

1. åˆæ¬¡æ‰§è¡Œå¤±è´¥ï¼š
   - `StepResult.is_success = false`ï¼Œè¿›å…¥ 952 è¡Œåçš„å¤±è´¥åˆ†æ”¯ï¼›
   - `step_retry_count += 1`ï¼›
   - `send_step_failed(...)` å°†å¤±è´¥ç»“æœæ¨åˆ°å‰ç«¯ï¼›
   - æ„é€ å¤±è´¥çš„ `EvaluationResult`ï¼ˆå››ç»´åº¦ä¸º 0ï¼‰ï¼Œå¹¶ `send_evaluation_completed(...)`ã€‚
2. è°ƒç”¨å•æ­¥åæ€ï¼š
   - `self.reflector.reflect_on_step(step_id, tool_id, error_message, description, metadata)`ï¼›
   - `reflect_on_step()` å†…éƒ¨è°ƒç”¨ LLMï¼Œè¦æ±‚è¾“å‡º JSONï¼›
   - `parse_step_reflection_response()` å°† JSON è§£æä¸º `StepReflection`ï¼ŒåŒ…å« `root_cause_category` å’Œ `suggested_action`ã€‚
3. Orchestrator ä¾æ® `StepReflection` åšå†³ç­–ï¼š
   - åœ¨æœªè¾¾åˆ°é‡è¯•ä¸Šé™çš„æƒ…å†µä¸‹ï¼ˆ`step_retry_count < max_step_retries`ï¼‰ï¼Œè¿›å…¥ `match &step_reflection.suggested_action` åˆ†æ”¯ï¼›
   - å½“åˆ†æ”¯ä¸º `StepAction::RetryWithAdjustedParams(adjusted_params)` æ—¶ï¼š
     - è®°å½• Kafka æ—¥å¿—ï¼ˆç†ç”±ä¸ºâ€œå‚æ•°è°ƒæ•´é‡è¯•â€ï¼‰ã€‚
4. è°ƒç”¨å¸¦è¦†ç›–å‚æ•°çš„æ‰§è¡Œï¼š
   - `execute_single_step_with_overrides(&current_plan, step_index, &execution_context, &available_tools, Some(adjusted_params.clone()), None)`ï¼›
   - å†…éƒ¨å°† `adjusted_params` ä¸åŸè§£æå‡ºçš„å‚æ•°åˆå¹¶ï¼Œç”Ÿæˆæœ€ç»ˆè°ƒç”¨å‚æ•°ã€‚
5. äºŒæ¬¡æ‰§è¡Œç»“æœï¼š
   - è‹¥ `retry_result.is_success == true`ï¼š
     - æµç¨‹ä¸â€œæ­£å¸¸æˆåŠŸè·¯å¾„â€ä¸€è‡´ï¼šå‘é€å®Œæˆäº‹ä»¶ã€è¯„ä¼°å®Œæˆäº‹ä»¶ã€æ›´æ–° `ExecutionContext` ä¸ metadataï¼Œå¹¶ `step_index += 1`ã€‚
   - è‹¥ä»å¤±è´¥ï¼š
     - æ‰“å°å‘Šè­¦â€œå‚æ•°è°ƒæ•´é‡è¯•ä»ç„¶å¤±è´¥â€ï¼Œä¸æ”¹å˜ `step_index`ï¼Œæœ¬è½® while ç»“æŸåé‡æ–°ä»å½“å‰æ­¥éª¤å¼€å§‹ä¸‹ä¸€è½®å¾ªç¯ï¼›
     - æ­¤æ—¶ `step_retry_count` å·²å¢åŠ ï¼Œåç»­å¯èƒ½å†æ¬¡è§¦å‘åæ€æˆ–å‡çº§åˆ°å•æ­¥ä¿®å¤ / ä»»åŠ¡é‡è§„åˆ’ã€‚

### 3. å¤±è´¥ + å¤‡é€‰å·¥å…·é‡è¯•åˆ†æ”¯ï¼ˆ`RetryWithAlternativeTool`ï¼‰

**å¯¹åº”ä»£ç **ï¼š
- `orchestrator.rs`ï¼š1137-1205 è¡Œ
- `executor.rs`ï¼š759-865 è¡Œ

**æ‰§è¡Œæ­¥éª¤**ï¼š

1. ä¸å‚æ•°é‡è¯•ç›¸åŒï¼Œå…ˆç»å†ï¼š
   - åˆæ¬¡å¤±è´¥ â†’ `send_step_failed` + å¤±è´¥è¯„ä¼°ï¼›
   - `reflect_on_step` + `StepReflection`ï¼Œå¾—åˆ° `suggested_action = RetryWithAlternativeTool(tool_id)`ã€‚
2. Orchestrator è¿›å…¥ `RetryWithAlternativeTool` åˆ†æ”¯ï¼š
   - è®°å½• Kafka æ—¥å¿—ï¼Œæ³¨æ˜ `alternative_tool` ä¸ `retry_count`ï¼›
   - è°ƒç”¨ `execute_single_step_with_overrides(..., None, Some(alternative_tool_id.clone()))`ï¼š
     - åœ¨æ‰§è¡Œå™¨å†…éƒ¨ï¼Œä¼šå°† `tool_override` å†™å…¥ä¸´æ—¶ `modified_step.tool`ï¼Œå…¶ä»–å­—æ®µä¿æŒä¸å˜ã€‚
3. äºŒæ¬¡æ‰§è¡Œç»“æœï¼š
   - è‹¥æˆåŠŸï¼š
     - æ¨é€æ­¥éª¤å®Œæˆäº‹ä»¶ï¼Œæ›´æ–° `ExecutionContext` ä¸ metadataï¼Œ`step_index += 1`ï¼›
   - è‹¥ä»å¤±è´¥ï¼š
     - æ‰“å°â€œå¤‡é€‰å·¥å…·é‡è¯•ä»ç„¶å¤±è´¥â€ï¼Œç»“æŸæœ¬è½® whileï¼›
     - ç”±äº `step_retry_count` å·²ç»ç´¯ç§¯ï¼Œä¸‹è½®å¾ªç¯å¯èƒ½ç›´æ¥è¿›å…¥å•æ­¥ä¿®å¤æˆ–ä»»åŠ¡é‡è§„åˆ’ã€‚

### 4. å•æ­¥ä¿®å¤è·¯å¾„ï¼ˆ`replan_single_step`ï¼‰

**å¯¹åº”ä»£ç **ï¼š
- `orchestrator.rs`ï¼š1303-1416 è¡Œ
- `planner.rs`ï¼š573-650 è¡Œ

**å…¸å‹è§¦å‘åœºæ™¯**ï¼š

1. å½“å‰æ­¥éª¤å¤šæ¬¡é‡è¯•ï¼ˆå‚æ•°æˆ–å·¥å…·ï¼‰ä»å¤±è´¥ï¼Œ`step_retry_count >= max_step_retries`ï¼›
2. æˆ–è€…åæ€å»ºè®®ç›´æ¥æ•´ä½“é‡è§„åˆ’ï¼Œä½†ç³»ç»Ÿå…ˆå°è¯•æ›´è½»é‡çš„â€œå•æ­¥ä¿®å¤â€ï¼Œä¸” `step_reflection.is_recoverable = true`ï¼›
3. åŒæ—¶ `single_step_repair_count < max_single_step_repairs`ã€‚

**æ‰§è¡Œæ­¥éª¤**ï¼š

1. Orchestrator è°ƒç”¨ï¼š
   - `self.planner.replan_single_step(&step_info.step_id, &step_info, error_message, &available_tools)`ã€‚
2. Planner æ„é€  promptï¼š
   - æä¾›åŸå§‹å¤±è´¥æ­¥éª¤å®šä¹‰ï¼ˆID / åç§° / å·¥å…· / å‚æ•° / é”™è¯¯ä¿¡æ¯ï¼‰ï¼›
   - è¦æ±‚ LLM è¾“å‡ºæ–°çš„æ­¥éª¤ JSONï¼Œéµå®ˆ schemaï¼Œ`step_id` ä¸å˜ä½†å·¥å…· / å‚æ•°å¯è°ƒæ•´ã€‚
3. LLM å“åº”è§£æä¸º `PlanStep`ï¼š
   - è‹¥æˆåŠŸï¼Œè¿”å› `repaired_step`ï¼›
4. Orchestrator æ›´æ–°è®¡åˆ’ä¸çŠ¶æ€ï¼š
   - åœ¨ `current_plan.steps` ä¸­æ‰¾åˆ°åŒ `step_id` çš„ç´¢å¼•å¹¶æ›¿æ¢ä¸º `repaired_step`ï¼›
   - å°† `last_step_index = usize::MAX`ï¼Œä½¿ä¸‹ä¸€è½®å¾ªç¯è¢«è§†ä¸ºâ€œåˆ‡æ¢åˆ°æ–°æ­¥éª¤â€ï¼Œä»è€Œé‡ç½®é‡è¯•è®¡æ•°é€»è¾‘ï¼›
   - å°† `step_retry_count = 0`ï¼›
   - `single_step_repair_count += 1`ï¼›
   - å‘é€ä¸€æ¡ `ReflectionResult` ç±»å‹çš„â€œå•æ­¥ä¿®å¤å®Œæˆâ€äº‹ä»¶ç»™å®¢æˆ·ç«¯ã€‚
5. å¾ªç¯ç»§ç»­ï¼š
   - ä¸æ”¹å˜ `step_index`ï¼Œä¸‹ä¸€è½® while å°†åœ¨åŒä¸€ç´¢å¼•ä½ç½®æ‰§è¡Œ**ä¿®å¤åçš„æ­¥éª¤**ã€‚

è‹¥ `replan_single_step` æœ¬èº«å¤±è´¥ï¼ˆLLM è§£æå¤±è´¥æˆ–è¿”å›éæ³•è®¡åˆ’ï¼‰ï¼š

- è®°å½•â€œå•æ­¥ä¿®å¤å¤±è´¥ï¼Œå°†å°è¯•å…¨ä»»åŠ¡é‡æ–°è§„åˆ’â€çš„æ—¥å¿—ä¸ Kafka äº‹ä»¶ï¼›
- `single_step_repair_count` ä»ç„¶è‡ªå¢ï¼›
- åç»­ç›´æ¥è¿›å…¥ä»»åŠ¡çº§é‡è§„åˆ’é€»è¾‘ï¼ˆè§ä¸‹ä¸€èŠ‚ï¼‰ã€‚

### 5. ä»»åŠ¡çº§é‡æ–°è§„åˆ’è·¯å¾„ï¼ˆ`replan_task`ï¼‰

**å¯¹åº”ä»£ç **ï¼š
- `orchestrator.rs`ï¼š1418-1559 è¡Œ
- `planner.rs`ï¼š452-571 è¡Œ

**å…¸å‹è§¦å‘åœºæ™¯**ï¼š

1. `step_reflection.is_recoverable == false`ï¼ˆä¾‹å¦‚ä»»åŠ¡åˆ†è§£é”™è¯¯ã€å‰ç½®æ•°æ®ç¼ºå¤±ä¸¥é‡ï¼‰ï¼›
2. æˆ–å•æ­¥ä¿®å¤å¤±è´¥ / è¶…è¿‡æ¬¡æ•°ï¼›
3. ä¸” `task_replan_count < max_task_replans`ã€‚

**æ‰§è¡Œæ­¥éª¤**ï¼š

1. æ„å»º `replanning_prompt`ï¼š
   - åŒ…å«å¤±è´¥æ­¥éª¤ IDã€æ ¹å› åˆ†ç±»ã€é”™è¯¯åˆ†æä»¥åŠå¯é€‰çš„å¤‡é€‰æ–¹æ¡ˆåˆ—è¡¨ï¼›
   - è‹¥ç»å†è¿‡å•æ­¥ä¿®å¤å¤±è´¥ï¼Œä¼šåœ¨ prompt ä¸­è¡¥å……â€œå•æ­¥ä¿®å¤å¤±è´¥â€çš„ä¸Šä¸‹æ–‡ã€‚
2. è°ƒç”¨ Planner çš„ `replan_task(&replanning_prompt, metadata.clone())`ï¼š
   - Planner æŸ¥è¯¢å¯ç”¨å·¥å…·ã€æ ¼å¼åŒ–ä¸ºæ–‡æœ¬ï¼›
   - æ„é€  system + user promptï¼Œè¦æ±‚è¾“å‡ºå®Œæ•´è®¡åˆ’ JSONï¼›
   - è°ƒç”¨ LLMï¼Œè§£æä¸º `ExecutionPlan`ï¼›
   - è®°å½•é‡è§„åˆ’ç›¸å…³æ—¥å¿—ä¸ Kafka äº‹ä»¶ã€‚
3. Orchestrator æ¥æ”¶æ–°è®¡åˆ’ï¼š
   - `current_plan = new_plan`ï¼›
   - `step_index = 0`ï¼Œ`last_step_index = usize::MAX`ï¼›
   - `step_results.clear()`ï¼Œ`step_retry_count = 0`ï¼›
   - é‡ç½® `ExecutionContext`ï¼ˆæ¸…ç©ºå†…éƒ¨çŠ¶æ€ï¼Œé‡æ–°è®¾ç½® `plan_id` ä¸ metadataï¼‰ã€‚
4. å‘å®¢æˆ·ç«¯æ¨é€ï¼š
   - `send_reflection_completed(&ReflectionResult{...})`ï¼šè¯´æ˜å·²å®Œæˆæ·±åº¦åˆ†æä¸é‡è§„åˆ’ï¼›
   - `send_plan_generated(&current_plan)`ï¼šæ¨é€æ–°è®¡åˆ’ï¼›
   - å¹¶é€’å¢ `task_replan_count`ï¼Œæ‰“å°â€œé‡è§„åˆ’è¿›åº¦: {}/{}â€æ—¥å¿—ã€‚
5. while å¾ªç¯ç»§ç»­ï¼š
   - ä»æ–°çš„ `current_plan` ç¬¬ä¸€æ­¥å¼€å§‹é‡æ–°æ‰§è¡Œå®Œæ•´ä»»åŠ¡ã€‚

### 6. StopExecution è·¯å¾„ï¼ˆç›´æ¥åœæ­¢æ‰§è¡Œï¼‰

**å¯¹åº”ä»£ç **ï¼š
- `orchestrator.rs`ï¼š1218-1234 è¡Œ

**è§¦å‘åœºæ™¯**ï¼š

- å•æ­¥åæ€ç»“æœ `suggested_action = StepAction::StopExecution`ï¼Œé€šå¸¸æ„å‘³ç€ï¼š
  - é”™è¯¯ä¸ºä¸å¯æ¢å¤çš„ä¸šåŠ¡é”™è¯¯ï¼ˆå¦‚æƒé™ã€åˆè§„é™åˆ¶ç­‰ï¼‰ï¼›
  - æˆ–è¿›ä¸€æ­¥é‡è¯• / é‡è§„åˆ’æ„ä¹‰ä¸å¤§ï¼Œåè€Œå¯èƒ½å¸¦æ¥å‰¯ä½œç”¨ã€‚

**æ‰§è¡Œæ­¥éª¤**ï¼š

1. Orchestrator å‘½ä¸­ `StepAction::StopExecution` åˆ†æ”¯ï¼š
   - è®°å½•ä¸€æ¡é”™è¯¯çº§åˆ«çš„æ—¥å¿— â€œå•æ­¥åæ€å»ºè®®åœæ­¢æ‰§è¡Œâ€ï¼›
   - å‘é€ Kafka äº‹ä»¶ï¼ŒåŒ…å«å¤±è´¥æ­¥éª¤ ID ä¸æ ¹å› è¯´æ˜ã€‚
2. è¿”å›é”™è¯¯ï¼š
   - æ„é€  `ServiceError::TaskExecutionFailed`ï¼Œæºå¸¦â€œæ— æ³•æ¢å¤â€çš„åŸå› è¯´æ˜ï¼›
   - æ•´ä¸ª `execute_execution_phase_with_metadata()` æå‰è¿”å› `Err(...)`ï¼Œä»»åŠ¡ç«‹å³ç»“æŸã€‚

### 7. å•æ­¥åæ€å¤±è´¥æ—¶çš„é™çº§ç­–ç•¥

**å¯¹åº”ä»£ç **ï¼š
- `orchestrator.rs`ï¼š974-1001 è¡Œ
- `reflector.rs`ï¼š672-681 è¡Œï¼ˆJSON è§£æå¤±è´¥åˆ†æ”¯ï¼‰

**ä¸¤ç±»å¤±è´¥åœºæ™¯**ï¼š

1. LLM è°ƒç”¨æ­£å¸¸ï¼Œä½†è¾“å‡ºä¸æ˜¯åˆæ³• JSONï¼š
   - `parse_step_reflection_response` ä¸­ JSON è§£ææŠ¥é”™ï¼›
   - è®°å½• debug æ—¥å¿—â€œå•æ­¥åæ€ JSON è§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼â€ï¼›
   - è¿”å›ä¸€ä¸ª fallback çš„ `StepReflection`ï¼Œé€šå¸¸å°† `root_cause_category` è®¾ä¸º `unknown_error` æˆ–ç±»ä¼¼å€¼ã€‚
2. Orchestrator è°ƒç”¨ `reflect_on_step` ç›´æ¥è¿”å›é”™è¯¯ï¼š
   - åœ¨ orchestrator çš„ 974-1001 è¡Œï¼Œä¼šæ•è· `Err(e)`ï¼›
   - æ‰“å° warn æ—¥å¿—â€œå•æ­¥åæ€å¤±è´¥ï¼Œè·³è¿‡å†³ç­–ç›´æ¥è¿›è¡Œé‡è§„åˆ’â€ï¼›
   - æ„é€ ä¸€ä¸ªä¿å®ˆçš„ `StepReflection`ï¼š
     - `root_cause_category = "reflection_error"`ï¼›
     - `suggested_action = StepAction::ReplanEntireTask`ï¼›
     - `is_recoverable = false`ã€‚

åç»­è¡Œä¸ºï¼š

- å› ä¸º `suggested_action` è¢«å¼ºåˆ¶è®¾ç½®ä¸º `ReplanEntireTask`ï¼Œä¸” `is_recoverable = false`ï¼Œ
  - æ­¥éª¤ä¸ä¼šå†åšå‚æ•°/å·¥å…·çº§é‡è¯•ï¼›
  - ä¼šæŒ‰ç…§â€œä»»åŠ¡çº§é‡æ–°è§„åˆ’è·¯å¾„â€ç›´æ¥è¿›å…¥ `replan_task` åˆ†æ”¯ï¼›
- è¿™æ ·ä¿è¯å³ä½¿åæ€é€»è¾‘æœ¬èº«å‡ºé—®é¢˜ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´æ— é™å¾ªç¯ï¼Œè€Œæ˜¯å°½å¿«é€šè¿‡é‡è§„åˆ’æˆ–ç»ˆæ­¢æ¥â€œæ”¶æ•›â€ã€‚

## çŠ¶æ€å˜é‡å˜åŒ–æ€»è§ˆ

ä¸‹è¡¨ä»â€œçŠ¶æ€æœºâ€çš„è§’åº¦ï¼Œæ€»ç»“äº†å„ç±»åˆ†æ”¯ä¸‹æ ¸å¿ƒçŠ¶æ€å˜é‡çš„å˜åŒ–æƒ…å†µã€‚ä»…åˆ—å‡ºå¯¹æ’æŸ¥é—®é¢˜æœ€å…³é”®çš„å‡ ä¸ªå˜é‡ï¼š

- `step_index`ï¼šå½“å‰æ­£åœ¨æ‰§è¡Œçš„æ­¥éª¤ä¸‹æ ‡
- `step_retry_count`ï¼šå½“å‰æ­¥éª¤å·²é‡è¯•æ¬¡æ•°
- `single_step_repair_count`ï¼šå·²æ‰§è¡Œçš„å•æ­¥ä¿®å¤æ¬¡æ•°
- `task_replan_count`ï¼šå·²æ‰§è¡Œçš„ä»»åŠ¡çº§é‡è§„åˆ’æ¬¡æ•°
- `current_plan`ï¼šå½“å‰æ‰§è¡Œè®¡åˆ’ï¼ˆåŒ…å« plan_id ä¸ stepsï¼‰
- `ExecutionContext`ï¼šæ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆè®°å½•æ¯æ­¥è¾“å‡ºï¼‰
- `runtime_metadata`ï¼šé€šè¿‡ `sync_step_output_to_metadata` åŒæ­¥åçš„è¿è¡Œæ—¶å…ƒæ•°æ®

| åˆ†æ”¯ | æ¡ä»¶æ¦‚è¿° | step_index | step_retry_count | single_step_repair_count | task_replan_count | current_plan | ExecutionContext | runtime_metadata | ä¸‹ä¸€è½®å¾ªç¯èµ·ç‚¹ |
|------|----------|-----------|------------------|--------------------------|-------------------|-------------|------------------|------------------|----------------|
| æ­£å¸¸æˆåŠŸ | å½“å‰æ­¥æ‰§è¡ŒæˆåŠŸä¸”è¯„ä¼°é€šè¿‡ | `+1` | ä¸å˜ï¼ˆé€šå¸¸ä¸º 0ï¼‰ | ä¸å˜ | ä¸å˜ | ä¸å˜ | è¿½åŠ å½“å‰æ­¥ç»“æœ | è¿½åŠ å½“å‰æ­¥è¾“å‡º | ä¸‹ä¸€æ­¥ï¼ˆindex+1ï¼‰ |
| åˆæ¬¡å¤±è´¥ï¼ˆå°šæœªé‡è¯•ï¼‰ | ç¬¬ä¸€æ¬¡æ‰§è¡Œå¤±è´¥ | ä¸å˜ | `+1` | ä¸å˜ | ä¸å˜ | ä¸å˜ | ä¸è¿½åŠ è¯¥æ­¥ï¼ˆå¤±è´¥ç»“æœä»…é€šè¿‡äº‹ä»¶å‘å‡ºï¼‰ | ä¸å˜ | æœ¬æ­¥å†æ¬¡æ‰§è¡Œæˆ–è¿›å…¥é‡è¯•/é‡è§„åˆ’å†³ç­– |
| å‚æ•°é‡è¯•æˆåŠŸ | åæ€å»ºè®®å‚æ•°é‡è¯•ï¼Œé‡è¯•åæˆåŠŸ | `+1` | ä¿æŒå½“å‰å€¼ï¼ˆ>0ï¼‰ | ä¸å˜ | ä¸å˜ | ä¸å˜ | è¿½åŠ å½“å‰æ­¥æˆåŠŸç»“æœ | è¿½åŠ å½“å‰æ­¥è¾“å‡º | ä¸‹ä¸€æ­¥ï¼ˆindex+1ï¼‰ |
| å‚æ•°é‡è¯•ä»å¤±è´¥ | åæ€å»ºè®®å‚æ•°é‡è¯•ï¼Œé‡è¯•ä»å¤±è´¥ | ä¸å˜ | `+1` | ä¸å˜ | ä¸å˜ | ä¸å˜ | ä¸è¿½åŠ ï¼ˆå¤±è´¥ç»“æœä»…äº‹ä»¶ï¼‰ | ä¸å˜ | æœ¬æ­¥å†æ¬¡è¿›å…¥å¤±è´¥å¤„ç†/åæ€æˆ–å‡çº§åˆ°ä¸‹ä¸€å±‚ |
| å¤‡é€‰å·¥å…·é‡è¯•æˆåŠŸ | åæ€å»ºè®®ä½¿ç”¨å¤‡é€‰å·¥å…·ï¼Œé‡è¯•æˆåŠŸ | `+1` | ä¿æŒå½“å‰å€¼ï¼ˆ>0ï¼‰ | ä¸å˜ | ä¸å˜ | ä¸å˜ï¼ˆä½†å½“å‰æ­¥å·¥å…·å®é™…æ‰§è¡Œä¸º override å·¥å…·ï¼‰ | è¿½åŠ å½“å‰æ­¥æˆåŠŸç»“æœ | è¿½åŠ å½“å‰æ­¥è¾“å‡º | ä¸‹ä¸€æ­¥ï¼ˆindex+1ï¼‰ |
| å¤‡é€‰å·¥å…·é‡è¯•ä»å¤±è´¥ | åæ€å»ºè®®ä½¿ç”¨å¤‡é€‰å·¥å…·ï¼Œé‡è¯•ä»å¤±è´¥ | ä¸å˜ | `+1` | ä¸å˜ | ä¸å˜ | ä¸å˜ | ä¸è¿½åŠ  | ä¸å˜ | æœ¬æ­¥å†æ¬¡è¿›å…¥å¤±è´¥å¤„ç†/åæ€æˆ–å‡çº§åˆ°ä¸‹ä¸€å±‚ |
| å•æ­¥ä¿®å¤æˆåŠŸ | è¾¾åˆ°é‡è¯•ä¸Šé™æˆ–ç­–ç•¥è¦æ±‚ï¼Œè°ƒç”¨ `replan_single_step` æˆåŠŸ | ä¸å˜ | é‡ç½®ä¸º 0 | `+1` | ä¸å˜ | åŒä¸€ `plan_id` ä¸‹æ›¿æ¢å½“å‰ `step_id` å¯¹åº”çš„æ­¥éª¤ | ä¸å˜ï¼ˆæ—§ç»“æœä»ä¿ç•™ï¼‰ | ä¸å˜ | ä¸‹ä¸€è½®åœ¨åŒä¸€ `step_index` æ‰§è¡Œâ€œä¿®å¤åçš„æ­¥éª¤â€ |
| å•æ­¥ä¿®å¤å¤±è´¥ | `replan_single_step` è‡ªèº«å¤±è´¥ | ä¸å˜ | ä¿æŒå½“å‰å€¼ | `+1` | ä¸å˜ | è®¡åˆ’ç»“æ„ä¸å˜ | ä¸å˜ | ä¸å˜ | ç›´æ¥è¿›å…¥ä»»åŠ¡çº§é‡è§„åˆ’å†³ç­– |
| ä»»åŠ¡çº§é‡è§„åˆ’æˆåŠŸ | è§¦å‘ `replan_task` å¹¶æˆåŠŸç”Ÿæˆæ–°è®¡åˆ’ | ç½® 0 | é‡ç½®ä¸º 0 | ä¸å˜ï¼ˆæˆ–ä¿æŒå‰å€¼ï¼‰ | `+1` | æ›¿æ¢ä¸ºæ–° `ExecutionPlan`ï¼ˆæ–° plan_id / æ–° stepsï¼‰ | æ¸…ç©ºå†…éƒ¨çŠ¶æ€å¹¶é‡æ–°ç»‘å®šåˆ°æ–° plan_id | é‡ç½®ä¸ºåˆå§‹ metadataï¼ˆä¸å«æ–°è¾“å‡ºï¼‰ | ä¸‹ä¸€è½®ä»æ–°è®¡åˆ’ç¬¬ 1 æ­¥å¼€å§‹æ‰§è¡Œ |
| ä»»åŠ¡çº§é‡è§„åˆ’å¤±è´¥ | `replan_task` è‡ªèº«å¤±è´¥ | ä¸å˜ | ä¸å˜ | ä¸å˜ | ä¿æŒå½“å‰å€¼ | ä¸å˜ | ä¸å˜ | ä¸å˜ | ç›´æ¥è¿”å› `TaskExecutionFailed`ï¼Œä¸å†è¿›å…¥ä¸‹ä¸€è½® |
| StopExecution | åæ€å»ºè®® `StopExecution` | ä¸å˜ | ä¸å˜ | ä¸å˜ | ä¸å˜ | ä¸å˜ | ä¸å˜ | ä¸å˜ | ç«‹åˆ»è¿”å›é”™è¯¯ï¼Œä»»åŠ¡ç»“æŸ |
| åæ€å¤±è´¥é™çº§ | `reflect_on_step` æˆ– JSON è§£æå¤±è´¥ï¼Œå¼ºåˆ¶ `ReplanEntireTask` | ä¸å˜ | ä¿æŒå½“å‰å€¼ | ä¸å˜ | ä¸å˜ï¼ˆç›´åˆ°çœŸæ­£æ‰§è¡Œ `replan_task` æ—¶æ‰ `+1`ï¼‰ | ä¸å˜ | ä¸å˜ | ä¸å˜ | åç»­ç›´æ¥è¿›å…¥ä»»åŠ¡çº§é‡è§„åˆ’è·¯å¾„ |

> æç¤ºï¼šæ’æŸ¥é—®é¢˜æ—¶ï¼Œé…åˆæ—¥å¿—ä¸­æ‰“å°çš„ `step_index`ã€`step_retry_count`ã€`single_step_repair_count`ã€`task_replan_count` ä»¥åŠ Kafka äº‹ä»¶ï¼Œå¯ä»¥å¾ˆå¿«å®šä½å½“å‰æ‰§è¡Œæ­£å¤„äºå“ªä¸€è¡Œé€»è¾‘ã€å“ªä¸€å±‚æ¢å¤ç­–ç•¥ã€‚

## å¤æ‚åœºæ™¯ Walk-through ç¤ºä¾‹

ä¸‹é¢ä»¥ä¸€ä¸ªâ€œ**å‚æ•°å¤šæ¬¡é‡è¯• â†’ å•æ­¥ä¿®å¤ â†’ å•æ­¥ä¿®å¤ä»å¤±è´¥ â†’ æ•´ä½“é‡è§„åˆ’**â€çš„å¤æ‚åœºæ™¯ï¼ŒæŒ‰æ—¶é—´é¡ºåºè¯¦ç»†è¯´æ˜ä¸€æ¬¡å®Œæ•´æ‰§è¡Œä¸­å„å˜é‡å’Œä¸»è¦å‡½æ•°è°ƒç”¨çš„æ¼”å˜ã€‚

### åœºæ™¯è®¾å®š

- åŸå§‹è®¡åˆ’ `Plan P1`ï¼šåŒ…å« 4 ä¸ªæ­¥éª¤ `S1, S2, S3, S4`ï¼›
- å½“å‰æ‰§è¡Œåˆ°æ­¥éª¤ `S3`ï¼š
  - å·¥å…· IDï¼š`tool_extract_features`
  - åˆå§‹å‚æ•°ä¸­å¼•ç”¨äº†å‰ç½®æ­¥éª¤ `S2` çš„è¾“å‡ºï¼›
- å®é™…è¿è¡Œä¸­ï¼š
  - ç¬¬ä¸€æ¬¡æ‰§è¡Œ `S3` æ—¶ï¼Œç”±äºä¸Šæ¸¸æ•°æ®ä¸å®Œæ•´å¯¼è‡´å¤±è´¥ï¼›
  - LLM å…ˆå¤šæ¬¡ç»™å‡ºâ€œå‚æ•°è°ƒæ•´é‡è¯•â€çš„å»ºè®®ï¼›
  - è¾¾åˆ°é‡è¯•ä¸Šé™åï¼ŒLLM è®¤ä¸ºé—®é¢˜å¯æ¢å¤ï¼Œå»ºè®®å•æ­¥ä¿®å¤ï¼›
  - å•æ­¥ä¿®å¤åæ–°çš„ `S3'` ä¾ç„¶å¤±è´¥ï¼›
  - æœ€ç»ˆè§¦å‘ä»»åŠ¡çº§é‡è§„åˆ’ï¼Œç”Ÿæˆæ–°è®¡åˆ’ `P2`ã€‚

### é˜¶æ®µä¸€ï¼šé¦–æ¬¡æ‰§è¡Œ S3 å¤±è´¥

1. Orchestrator æ­£åœ¨å¾ªç¯æ‰§è¡Œ `P1`ï¼š
   - `step_index = 2`ï¼ˆå‡è®¾ä» 0 å¼€å§‹ï¼Œå¯¹åº” S3ï¼‰ï¼›
   - `step_retry_count = 0`ï¼Œ`single_step_repair_count = 0`ï¼Œ`task_replan_count = 0`ï¼›
2. è°ƒç”¨æ‰§è¡Œå™¨ï¼š
   - `execute_single_step(P1, step_index=2, &execution_context, &available_tools)`ï¼›
   - åº•å±‚å·¥å…·æŠ¥é”™ï¼š`"ç¼ºå°‘å¿…éœ€çš„ç‰¹å¾åˆ—"`ï¼›
   - è¿”å› `StepResult{ is_success = false, error_message = Some(...) }`ï¼›
3. Orchestrator è¿›å…¥å¤±è´¥åˆ†æ”¯ï¼š
   - `step_retry_count` ä» 0 å¢åŠ åˆ° 1ï¼›
   - `send_step_failed` + å‘é€å¤±è´¥è¯„ä¼°ï¼ˆè¯„åˆ†ä¸º 0ï¼‰ï¼›
4. è°ƒç”¨ `reflect_on_step(...)`ï¼š
   - LLM åˆ¤æ–­æ ¹å› ï¼š`root_cause_category = "parameter_error"`ï¼›
   - ç»™å‡º `suggested_action = RetryWithAdjustedParams({...})`ï¼›
5. ç”±äº `step_retry_count < max_step_retries`ï¼Œç³»ç»Ÿè¿›å…¥â€œå‚æ•°é‡è¯•â€è·¯å¾„ã€‚

### é˜¶æ®µäºŒï¼šå¤šæ¬¡å‚æ•°é‡è¯•ä»ç„¶å¤±è´¥

1. ç¬¬ 2 æ¬¡æ‰§è¡Œ S3ï¼š
   - Orchestrator è°ƒç”¨ `execute_single_step_with_overrides(..., Some(adjusted_params1), None)`ï¼›
   - å·¥å…·ä»å› ä¸Šæ¸¸æ•°æ®é—®é¢˜å¤±è´¥ï¼›
   - `step_retry_count` ä» 1 å¢åŠ åˆ° 2ï¼›
   - å†æ¬¡å‘é€å¤±è´¥äº‹ä»¶ + å¤±è´¥è¯„ä¼°ï¼›
   - å†æ¬¡è°ƒç”¨ `reflect_on_step`ï¼ŒLLM ä¾ç„¶å»ºè®®å‚æ•°é‡è¯•ã€‚
2. ç¬¬ 3 æ¬¡æ‰§è¡Œ S3ï¼š
   - å†æ¬¡å¸¦æ–°çš„ `adjusted_params2` è°ƒç”¨ `execute_single_step_with_overrides`ï¼›
   - ä¾æ—§å¤±è´¥ï¼›
   - `step_retry_count` ä» 2 å¢åŠ åˆ° 3ï¼Œè¾¾åˆ° `max_step_retries = 3`ï¼›
3. åœ¨æœ¬è½®å¤±è´¥å¤„ç†ç»“å°¾ï¼š
   - åˆ¤æ–­ `step_retry_count >= max_step_retries`ï¼Œä¸å†æ‰§è¡Œå‚æ•°/å·¥å…·é‡è¯•ï¼›
   - è½¬å…¥â€œå•æ­¥ä¿®å¤ / ä»»åŠ¡é‡è§„åˆ’â€å†³ç­–é€»è¾‘ï¼ˆå³ 1303 è¡Œåçš„é‚£æ®µï¼‰ã€‚

### é˜¶æ®µä¸‰ï¼šå•æ­¥ä¿®å¤ S3 â†’ å¾—åˆ°æ–°æ­¥éª¤ S3'

1. åæ€ç»“æœè®¤ä¸ºé—®é¢˜å¯æ¢å¤ï¼š
   - `is_recoverable = true`ï¼›
2. åŒæ—¶ `single_step_repair_count = 0 < max_single_step_repairs = 1`ï¼š
   - Orchestrator é€‰æ‹©å…ˆå°è¯• **å•æ­¥ä¿®å¤** è€Œä¸æ˜¯ç›´æ¥é‡è§„åˆ’ï¼›
3. è°ƒç”¨ Plannerï¼š
   - `replan_single_step("S3", &S3, error_message, &available_tools)`ï¼›
   - LLM è¿”å›æ–°çš„æ­¥éª¤å®šä¹‰ `S3'`ï¼šå¯èƒ½æ›´æ¢äº†å·¥å…·æˆ–æ˜¾å¼å¢åŠ äº†å‰ç½®ä¾èµ–ç­‰ï¼›
4. Orchestrator æ›´æ–°çŠ¶æ€ï¼š
   - åœ¨ `current_plan.steps` ä¸­ç”¨ `S3'` æ›¿æ¢åŸæ¥çš„ `S3`ï¼›
   - `last_step_index = usize::MAX`ï¼ˆä¸‹ä¸€è½®è§†ä¸ºæ–°æ­¥éª¤ï¼‰ï¼›
   - `step_retry_count` é‡ç½®ä¸º 0ï¼›
   - `single_step_repair_count` ä» 0 å¢åŠ åˆ° 1ï¼›
   - å‘é€â€œå•æ­¥ä¿®å¤å®Œæˆâ€çš„ `ReflectionResult` ç»™å‰ç«¯ï¼›
5. while å¾ªç¯ç»§ç»­ï¼š
   - `step_index` ä»ä¸º 2ï¼Œä½†ä¸‹ä¸€è½®ä¼šæ‰§è¡Œå·²ç»ä¿®å¤è¿‡çš„ `S3'`ã€‚

### é˜¶æ®µå››ï¼šS3' ä»ç„¶å¤±è´¥ â†’ è§¦å‘ä»»åŠ¡çº§é‡è§„åˆ’

1. æ‰§è¡Œä¿®å¤åçš„ S3'ï¼š
   - è°ƒç”¨ `execute_single_step(P1', step_index=2, ...)`ï¼ˆP1' è¡¨ç¤ºåŒ…å« S3' çš„è®¡åˆ’ï¼‰ï¼›
   - ç”±äºæ ¹æœ¬æ€§ä»»åŠ¡åˆ†è§£é—®é¢˜ï¼ŒS3' ä»ç„¶å¤±è´¥ï¼›
   - `step_retry_count` ä» 0 å¢åŠ åˆ° 1ï¼›
   - å†æ¬¡å‘é€å¤±è´¥äº‹ä»¶ + å¤±è´¥è¯„ä¼°ï¼›
2. å†æ¬¡åæ€ï¼š
   - è¿™æ¬¡ LLM è®¤ä¸ºé—®é¢˜å±äº `decomposition_error`ï¼Œç”šè‡³å¯èƒ½å°† `is_recoverable` ç½®ä¸º `false`ï¼›
3. åœ¨å¤±è´¥å¤„ç†çš„ååŠæ®µï¼š
   - å³ä½¿æ­¤æ—¶ `step_retry_count` è¿˜æœªå†æ¬¡è¾¾åˆ°é‡è¯•ä¸Šé™ï¼Œç”±äº `is_recoverable = false` æˆ–å·²æ— æ„ä¹‰ç»§ç»­ä¿®å¤ï¼Œç³»ç»Ÿä¼šèµ°å‘ **ä»»åŠ¡çº§é‡è§„åˆ’** åˆ†æ”¯ï¼›
4. è°ƒç”¨ `replan_task(...)`ï¼š
   - Planner åŸºäºâ€œä¸Šæ¸¸ç¼ºå°‘å¿…è¦ç‰¹å¾æ­¥éª¤â€ç­‰ä¿¡æ¯ï¼Œç”Ÿæˆæ–°è®¡åˆ’ `P2`ï¼š
     - åœ¨ `S2` ä¸ `S3` ä¹‹é—´æ–°å¢è‹¥å¹²å‰ç½®æ­¥éª¤ï¼ˆå¦‚è¡¥æ•°ã€ç‰¹å¾æ„é€ ç­‰ï¼‰ï¼›
5. Orchestrator åˆ‡æ¢åˆ°æ–°è®¡åˆ’ï¼š
   - `current_plan = P2`ï¼›
   - `step_index = 0`ï¼Œ`last_step_index = usize::MAX`ï¼›
   - `step_results.clear()`ï¼Œ`step_retry_count = 0`ï¼›
   - é‡æ–°åˆå§‹åŒ– `ExecutionContext`ï¼Œä»…æºå¸¦åˆå§‹ metadataï¼Œä¸å†å¸¦å¤±è´¥é“¾è·¯ä¸­çš„ä¸­é—´ç»“æœï¼›
   - `task_replan_count` ä» 0 å¢åŠ åˆ° 1ï¼›
   - æ¨é€â€œé‡è§„åˆ’å®Œæˆâ€ä»¥åŠâ€œæ–°è®¡åˆ’ç”Ÿæˆâ€çš„äº‹ä»¶ç»™å®¢æˆ·ç«¯ã€‚

### é˜¶æ®µäº”ï¼šåœ¨æ–°è®¡åˆ’ P2 ä¸Šé‡æ–°æ‰§è¡Œ

1. while å¾ªç¯é‡æ–°ä» `step_index = 0` å¼€å§‹ï¼š
   - ä¾æ¬¡æ‰§è¡Œ P2 çš„å„ä¸ªæ­¥éª¤ï¼ŒåŒ…å«æ–°æ’å…¥çš„å‰ç½®ä¿®å¤æ­¥éª¤ï¼›
2. å¦‚æœ P2 æ­£å¸¸æ‰§è¡Œå®Œæˆï¼š
   - æ•´ä½“æ‰§è¡ŒæˆåŠŸï¼›
   - ä»å¤–éƒ¨çœ‹ï¼Œè¿™ä¸ªä»»åŠ¡ç»å†äº†ï¼š
     - å¤šæ¬¡å‚æ•°é‡è¯• â†’ å•æ­¥ä¿®å¤ â†’ æ•´ä½“é‡è§„åˆ’ â†’ æ–°è®¡åˆ’æˆåŠŸã€‚
3. å¦‚æœ P2 ä»ç„¶åœ¨æŸä¸€æ­¥å‘ç”Ÿä¸¥é‡å¤±è´¥ï¼Œä¸” `task_replan_count` å·²è¾¾åˆ°ä¸Šé™ï¼š
   - ä¼šè§¦å‘â€œç»ˆæ­¢æ¡ä»¶â€ä¸­æ‰€è¿°çš„ä»»åŠ¡å¤±è´¥è¿”å›é€»è¾‘ã€‚

## å…³é”®ä»£ç å®ç°ï¼ˆè¡Œå·ç´¢å¼•ï¼‰

| æ¨¡å— | æ–‡ä»¶ | æ–¹æ³• / ç»“æ„ | è¡Œå·ï¼ˆçº¦ï¼‰ | è¯´æ˜ |
|------|------|-------------|-----------|------|
| Orchestrator | `src/core/orchestrator.rs` | `execute_execution_phase_with_metadata` | 663-1559 | æ‰§è¡Œä¸»å¾ªç¯ä¸ä¸‰å±‚æ¢å¤æ ¸å¿ƒé€»è¾‘ |
| Reflector | `src/core/reflector.rs` | `StepReflection` | 78-98 | å•æ­¥åæ€ç»“æœç»“æ„ä½“ |
| Reflector | `src/core/reflector.rs` | `reflect_on_step` | 587-669 | è°ƒç”¨ LLM åšå•æ­¥è¯Šæ–­ |
| Reflector | `src/core/reflector.rs` | `parse_step_reflection_response` | 672-723+ | è§£æ LLM JSON å“åº”ä¸º `StepReflection` / `StepAction` |
| Planner | `src/core/planner.rs` | `replan_task` | 452-571 | æ•´ä½“ä»»åŠ¡é‡è§„åˆ’å®ç° |
| Planner | `src/core/planner.rs` | `replan_single_step` | 573-650 | å•æ­¥ä¿®å¤å®ç° |
| Executor | `src/core/executor.rs` | `execute_single_step` | 741-755 | æä¾›æ— è¦†ç›–ç‰ˆæœ¬å•æ­¥æ‰§è¡Œ |
| Executor | `src/core/executor.rs` | `execute_single_step_with_overrides` | 759-865 | æ”¯æŒå‚æ•°/å·¥å…·è¦†ç›–çš„å•æ­¥æ‰§è¡Œ |

> è¡Œå·ä¸ºå½“å‰ä»“åº“ç‰ˆæœ¬çš„å¤§è‡´èŒƒå›´ï¼Œå¦‚æœ‰é‡æ„è¯·ä»¥å®é™…æ–‡ä»¶ä¸ºå‡†ã€‚

## å®æˆ˜ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šå‚æ•°é”™è¯¯ â†’ è°ƒæ•´å‚æ•°é‡è¯•æˆåŠŸ

- æ­¥éª¤ï¼š`data_upload`
- é”™è¯¯ï¼š`"æ•°æ®æºä¸å­˜åœ¨: ds_invalid"`
- å•æ­¥åæ€ï¼š
  - `root_cause_category = "parameter_error"`
  - `is_recoverable = true`
  - `suggested_action = RetryWithAdjustedParams({"datasource_id": "ds_001"})`
- å®é™…è¡Œä¸ºï¼š
  - Orchestrator è¿›å…¥å‚æ•°é‡è¯•åˆ†æ”¯ï¼Œä½¿ç”¨æ–°çš„ `datasource_id` è°ƒç”¨ `execute_single_step_with_overrides`ã€‚
  - æ­¥éª¤æˆåŠŸåï¼Œæ‰§è¡Œç»§ç»­å‘åæ¨è¿›ï¼Œè®¡åˆ’æ•´ä½“ä¿æŒä¸å˜ã€‚

### ç¤ºä¾‹ 2ï¼šå·¥å…·é”™è¯¯ â†’ å¤‡é€‰å·¥å…·é‡è¯•

- æ­¥éª¤ï¼š`process_data`
- é”™è¯¯ï¼š`"å·¥å…·æœåŠ¡è¿æ¥è¶…æ—¶"`
- å•æ­¥åæ€ï¼š
  - `root_cause_category = "tool_error"`
  - `is_recoverable = true`
  - `suggested_action = RetryWithAlternativeTool("alternative_processor")`
- å®é™…è¡Œä¸ºï¼š
  - Orchestrator ä½¿ç”¨ `alternative_processor` ä½œä¸º `tool_override` é‡è¯•æ‰§è¡Œã€‚
  - è‹¥é‡è¯•æˆåŠŸï¼Œåˆ™æ¥ä¸‹æ¥çš„æ­¥éª¤åœ¨æ–°å·¥å…·çš„è¾“å‡ºåŸºç¡€ä¸Šç»§ç»­æ‰§è¡Œã€‚

### ç¤ºä¾‹ 3ï¼šä»»åŠ¡åˆ†è§£é”™è¯¯ â†’ å•æ­¥ä¿®å¤å¤±è´¥åæ•´ä½“é‡è§„åˆ’

- æ­¥éª¤ï¼š`feature_engineering`
- é”™è¯¯ï¼š`"ç¼ºå°‘å¿…è¦çš„å‰ç½®æ•°æ®"`
- å•æ­¥åæ€ï¼š
  - `root_cause_category = "decomposition_error"`
  - `is_recoverable = true`
- å®é™…è¡Œä¸ºï¼š
  1. åœ¨æ­¥éª¤é‡è¯•å·²è¾¾ä¸Šé™åï¼ŒOrchestrator å…ˆå°è¯• `replan_single_step`ï¼Œè®© LLM ä¿®å¤è¯¥æ­¥éª¤å®šä¹‰ï¼›
  2. è‹¥ä¿®å¤åçš„æ­¥éª¤ä»å¤±è´¥ï¼Œåˆ™è¿›å…¥ `replan_task` åˆ†æ”¯ï¼Œç”ŸæˆåŒ…å«æ–°å¢å‰ç½®æ­¥éª¤çš„æ–°è®¡åˆ’ï¼›
  3. ä½¿ç”¨æ–°è®¡åˆ’ä»å¤´å¼€å§‹æ‰§è¡Œï¼ŒåŸå¤±è´¥æ­¥éª¤å¯¹åº”çš„é€»è¾‘å·²è¢«æ–°æ­¥éª¤é“¾æ›¿ä»£ã€‚

### ç¤ºä¾‹ 4ï¼šä¸å¯æ¢å¤çš„å¤–éƒ¨é”™è¯¯ â†’ ç›´æ¥åœæ­¢

- åœºæ™¯ï¼šå¤–éƒ¨è´¦å·è¢«å°ç¦ã€é¢åº¦è€—å°½ç­‰æ— æ³•é é‡è¯•è§£å†³çš„é—®é¢˜ï¼›
- å•æ­¥åæ€ï¼š
  - `root_cause_category = "external_error"`
  - `is_recoverable = false`
  - `suggested_action = StopExecution`
- å®é™…è¡Œä¸ºï¼š
  - Orchestrator å‘½ä¸­ `StopExecution` åˆ†æ”¯ï¼Œç›´æ¥è¿”å› `TaskExecutionFailed`ï¼Œå¹¶è®°å½•æ—¥å¿—ä¸ Kafka äº‹ä»¶ï¼Œæé†’è¿ç»´/ä¸šåŠ¡äººå·¥ä»‹å…¥ã€‚

## é…ç½®è¯´æ˜

### åæ€ä¸é‡è¯•ç›¸å…³é…ç½®

- **æ–‡ä»¶**ï¼š`config.toml` / `config.dev.toml` / `config.local.toml`

```toml
[reflection]
enable_step_level_reflection = true          # æ˜¯å¦å¯ç”¨æ­¥éª¤çº§åæ€
max_step_retries = 3                         # å•ä¸ªæ­¥éª¤æœ€å¤§é‡è¯•æ¬¡æ•°
max_task_replanning_attempts = 1             # ä»»åŠ¡çº§é‡æ–°è§„åˆ’æœ€å¤§æ¬¡æ•°
```

- **è¯»å–ä½ç½®**ï¼š`src/core/orchestrator.rs`ï¼ˆ690-773 è¡Œé™„è¿‘ï¼‰
  - `AppConfig::load().map(|cfg| cfg.reflection)` è¯»å–ä¸Šè¿°é…ç½®ï¼›
  - `enable_step_level_reflection = false` æ—¶ï¼Œå°†èµ°æ—§ç‰ˆæ— åæ€æ‰§è¡Œé€»è¾‘ï¼Œä¸è§¦å‘æœ¬æ–‡æè¿°çš„å•æ­¥é‡è¯•/é‡è§„åˆ’ã€‚

### å»ºè®®é…ç½®ç­–ç•¥

- **å¼€å‘ / æµ‹è¯•ç¯å¢ƒ**ï¼š
  - å»ºè®®å¼€å¯æ­¥éª¤çº§åæ€ï¼Œå¹¶é€‚åº¦æé«˜ `max_step_retries` ä¸ `max_task_replanning_attempts` ä»¥è§‚å¯Ÿè‡ªæ„ˆè¡Œä¸ºï¼›
- **ç”Ÿäº§ç¯å¢ƒ**ï¼š
  - å»ºè®®æ§åˆ¶é‡è¯•ä¸é‡è§„åˆ’æ¬¡æ•°ï¼ˆå¦‚ `max_step_retries = 2~3`ï¼Œ`max_task_replanning_attempts = 1`ï¼‰ï¼Œé˜²æ­¢é•¿æ—¶é—´æ— æ•ˆè‡ªæ—‹ã€‚

## å°ç»“

å•æ­¥é‡è¯•ä¸é‡æ–°è§„åˆ’æœºåˆ¶ç”± Orchestrator ç»Ÿä¸€åè°ƒ Reflectorã€Planner ä¸ Executorï¼š

- **Reflector** è´Ÿè´£â€œæƒ³æ¸…æ¥šä¸ºä»€ä¹ˆå¤±è´¥ã€æ˜¯å¦è¿˜èƒ½æ•‘â€ï¼›
- **Executor** è´Ÿè´£â€œæŒ‰åŸæ ·æˆ–è°ƒæ•´åçš„æ–¹å¼å†è·‘ä¸€æ¬¡â€ï¼›
- **Planner** è´Ÿè´£â€œä¿®æŸä¸€æ­¥â€æˆ–â€œé‡å†™æ•´å¥—è®¡åˆ’â€ï¼›
- **Orchestrator** æŠŠå®ƒä»¬ä¸²æˆä¸€ä¸ªå¯æ§çš„ä¸‰å±‚è‡ªæ„ˆé—­ç¯ã€‚

ç»“åˆåˆç†çš„é…ç½®ï¼Œè¿™å¥—æœºåˆ¶èƒ½åœ¨ç»å¤§å¤šæ•°å¯æ¢å¤é”™è¯¯ä¸‹è‡ªåŠ¨å®Œæˆè¯Šæ–­ä¸ä¿®å¤ï¼Œåªåœ¨çœŸæ­£ä¸å¯æ¢å¤æ—¶æ‰ä¸­æ­¢ä»»åŠ¡å¹¶æš´éœ²ç»™äººå·¥å¤„ç†ã€‚

