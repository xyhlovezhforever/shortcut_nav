# å¹¶è¡Œæ‰§è¡ŒåŠŸèƒ½ä»£ç ä¿®æ”¹è¯¦ç»†è®°å½•

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

**ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025-12-19
**ä½œè€…**: Task Orchestration Service Team
**ç›®çš„**: è¯¦ç»†è®°å½•å®ç°å¹¶è¡Œæ‰§è¡ŒåŠŸèƒ½æ—¶å¯¹é¡¹ç›®ä»£ç çš„æ‰€æœ‰å¢åˆ æ”¹æ“ä½œ

---

## ğŸ¯ å¹¶è¡Œæ‰§è¡Œå®ç°æ–¹æ¡ˆæ¦‚è¿°

### ä»£ç ç‰ˆæœ¬ä¿¡æ¯
- **åˆ†æ”¯**: `parallel_execution_version`
- **åŸºç¡€ç‰ˆæœ¬**: `serial_execution_version` (ä¸²è¡Œæ‰§è¡Œç‰ˆæœ¬)
- **å®ç°æ—¶é—´**: 2025-12-19

### æ–¹æ¡ˆæ¶æ„

æœ¬é¡¹ç›®å®ç°äº†**ä¸¤å±‚å¹¶è¡Œæ‰§è¡Œæ¶æ„**,æ”¯æŒä»»åŠ¡ç¼–æ’çš„é«˜æ•ˆå¹¶è¡Œå¤„ç†:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä»»åŠ¡ç¼–æ’æœåŠ¡ (Orchestrator)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç¬¬ä¸€å±‚: æ­¥éª¤é—´å¹¶è¡Œ (Step-Level Parallel)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Step 1   â”‚ â†’  â”‚ Step 2   â”‚ â†’  â”‚ Step 4   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ Step 3   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚  è¯´æ˜: Step 2 å’Œ Step 3 æ— ä¾èµ–å…³ç³»,å¯å¹¶è¡Œæ‰§è¡Œ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç¬¬äºŒå±‚: æ­¥éª¤å†…å¹¶è¡Œ (Action-Level Parallel)          â”‚
â”‚  Step 2 å†…éƒ¨:                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ Action_2_1   â”‚    â”‚ Action_2_2   â”‚  â† å¹¶è¡Œæ‰§è¡Œ            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚         â†“                    â†“                               â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                  â†“                                           â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚         â”‚ Action_2_3   â”‚  â† ä¾èµ–å‰ä¸¤ä¸ªaction                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæŠ€æœ¯ç‰¹æ€§

#### 1. æ­¥éª¤é—´å¹¶è¡Œæ‰§è¡Œ (Inter-Step Parallelism)
**å®ç°æ–‡ä»¶**: `src/core/parallel_executor.rs`

**æ ¸å¿ƒæœºåˆ¶**:
- **DAGä¾èµ–å›¾**: åŸºäºæœ‰å‘æ— ç¯å›¾æ„å»ºæ­¥éª¤ä¾èµ–å…³ç³»
- **Kahnæ‹“æ‰‘æ’åº**: è‡ªåŠ¨è®¡ç®—æ‰§è¡Œæ‰¹æ¬¡,åŒæ‰¹æ¬¡æ­¥éª¤å¯å¹¶è¡Œ
- **æ‰¹æ¬¡è°ƒåº¦**: æŒ‰æ‰¹æ¬¡é¡ºåºæ‰§è¡Œ,æ‰¹æ¬¡å†…å¹¶è¡Œ,æ‰¹æ¬¡é—´ä¸²è¡Œ
- **ä¿¡å·é‡æ§åˆ¶**: ä½¿ç”¨`tokio::sync::Semaphore`é™åˆ¶æœ€å¤§å¹¶å‘æ•°

**ç®—æ³•æµç¨‹**:
```rust
1. æ„å»ºDAG â†’ 2. è®¡ç®—æ‹“æ‰‘æ‰¹æ¬¡ â†’ 3. æ‰¹æ¬¡é¡ºåºæ‰§è¡Œ
   â”œâ”€ ExecutionNode        â”œâ”€ Kahnç®—æ³•           â”œâ”€ æ‰¹æ¬¡å†…å¹¶è¡Œ
   â”œâ”€ ä¾èµ–å…³ç³»æ˜ å°„         â”œâ”€ å…¥åº¦è®¡ç®—           â”œâ”€ ä¿¡å·é‡é™æµ
   â””â”€ çŠ¶æ€ç®¡ç†             â””â”€ ç¯æ£€æµ‹             â””â”€ æ—©æœŸå¤±è´¥ç»ˆæ­¢
```

**ç¤ºä¾‹**:
```
è¾“å…¥è®¡åˆ’:
  step_1: deps=[]
  step_2: deps=[step_1]
  step_3: deps=[step_1]
  step_4: deps=[step_2, step_3]

æ‰§è¡Œæ‰¹æ¬¡:
  Batch 1: [step_1]           â† ä¸²è¡Œ
  Batch 2: [step_2, step_3]   â† å¹¶è¡Œ (2ä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œ)
  Batch 3: [step_4]           â† ä¸²è¡Œ
```

#### 2. æ­¥éª¤å†…å¹¶è¡Œæ‰§è¡Œ (Intra-Step Parallelism)
**å®ç°æ–‡ä»¶**: `src/core/executor.rs` (æ–¹æ³•: `execute_step_with_actions`)

**æ ¸å¿ƒæœºåˆ¶**:
- **Actionsæ ¼å¼**: å•ä¸ªæ­¥éª¤åŒ…å«å¤šä¸ª`PlanAction`,æ¯ä¸ªactionæ˜¯ç‹¬ç«‹æ“ä½œ
- **Actionçº§DAG**: æ­¥éª¤å†…actionsä¹Ÿæ”¯æŒä¾èµ–å…³ç³»
- **å¹¶å‘æ‰§è¡Œ**: ä½¿ç”¨`tokio::join_all`å¹¶è¡Œæ‰§è¡Œæ— ä¾èµ–çš„actions
- **ç»“æœèšåˆ**: å°†æ‰€æœ‰actionè¾“å‡ºåˆå¹¶ä¸ºæ­¥éª¤è¾“å‡º

**åè®®æ”¯æŒ**:
```protobuf
message PlanStep {
    string step_id = 1;
    repeated PlanAction actions = 7;  // æ–°å¢å­—æ®µ,æ”¯æŒæ­¥éª¤å†…å¤šæ“ä½œ
}

message PlanAction {
    string action_id = 1;              // å”¯ä¸€æ ‡è¯†
    string tool = 3;                   // å·¥å…·åç§°
    string parameters = 4;             // å·¥å…·å‚æ•°
    repeated string dependencies = 5;  // ä¾èµ–çš„action_idåˆ—è¡¨
}
```

**ç¤ºä¾‹**:
```json
{
  "step_id": "step_1",
  "actions": [
    {"action_id": "action_1_1", "tool": "python", "parameters": "{\"code\":\"5**2\"}"},
    {"action_id": "action_1_2", "tool": "python", "parameters": "{\"code\":\"8**2\"}"},
    {"action_id": "action_1_3", "tool": "python", "parameters": "{\"code\":\"12**2\"}"}
  ]
}
// æ‰§è¡Œ: 3ä¸ªactionåŒæ—¶å¹¶è¡Œæ‰§è¡Œ
```

#### 3. å ä½ç¬¦è§£æå¢å¼º
**å®ç°æ–‡ä»¶**: `src/core/parameter_resolver.rs`

**æ ¸å¿ƒæ”¹è¿›**:
- **å¤šå ä½ç¬¦æ”¯æŒ**: å•ä¸ªå‚æ•°å¯åŒ…å«å¤šä¸ªå ä½ç¬¦
  - æ—§ç‰ˆ: åªèƒ½`{{step_1.output}}`
  - æ–°ç‰ˆ: æ”¯æŒ`{{action_1_1.output}} + {{action_1_2.output}}`
- **Actionå¼•ç”¨**: æ”¯æŒå¼•ç”¨æ­¥éª¤å†…actionçš„è¾“å‡º
  - æ ¼å¼: `{{action_id.output}}`
  - ç¤ºä¾‹: `{{action_2_1.output}}`
- **æ­£åˆ™è¡¨è¾¾å¼è§£æ**: ä½¿ç”¨`Regex`æå–æ‰€æœ‰å ä½ç¬¦å¹¶é€ä¸ªæ›¿æ¢

**æŠ€æœ¯å®ç°**:
```rust
// æ­£åˆ™åŒ¹é…æ‰€æœ‰ {{...}} æˆ– {{{...}}} å ä½ç¬¦
lazy_static! {
    static ref PLACEHOLDER_REGEX: Regex =
        Regex::new(r"\{\{\{([^}]+)\}\}\}|\{\{([^}]+)\}\}").unwrap();
}

// è¿­ä»£æ›¿æ¢æ‰€æœ‰å ä½ç¬¦
for cap in PLACEHOLDER_REGEX.captures_iter(value) {
    let resolved = resolve_single_placeholder(placeholder_content, context);
    result = result.replace(full_match, &resolved);
}
```

#### 4. æ­¥éª¤IDé‡ç¼–å·æœºåˆ¶
**å®ç°æ–‡ä»¶**: `src/core/planner.rs`

**é—®é¢˜**: LLMé‡æ–°è§„åˆ’æ—¶,ç”Ÿæˆçš„step_idå¯èƒ½ä»`step_4`å¼€å§‹,å¯¼è‡´ä¾èµ–å…³ç³»æ··ä¹±

**è§£å†³æ–¹æ¡ˆ**:
```rust
// 1. å»ºç«‹æ˜ å°„è¡¨: LLMç”Ÿæˆçš„ID â†’ æ–°çš„è¿ç»­ID
let mut llm_to_new_id_map: HashMap<String, String> = HashMap::new();
for (idx, step) in steps.iter().enumerate() {
    let new_id = format!("step_{}", idx + 1);  // å¼ºåˆ¶ä»1å¼€å§‹
    llm_to_new_id_map.insert(llm_step_id, new_id);
}

// 2. é‡æ˜ å°„ä¾èµ–å…³ç³»
let new_deps = deps.map(|dep| llm_to_new_id_map.get(dep).cloned());
```

**æ•ˆæœ**:
```
LLMè¾“å‡º              é‡ç¼–å·å
step_4 (deps=[])  â†’  step_1 (deps=[])
step_5 (deps=[4]) â†’  step_2 (deps=[1])
step_6 (deps=[5]) â†’  step_3 (deps=[2])
```

### é…ç½®é¡¹è¯´æ˜

**é…ç½®æ–‡ä»¶**: `config.dev.toml`

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `enable_parallel_execution` | bool | true | æ˜¯å¦å¯ç”¨æ­¥éª¤é—´å¹¶è¡Œæ‰§è¡Œ |
| `parallel_max_concurrent` | usize | 8 | æœ€å¤§å¹¶å‘æ­¥éª¤æ•°(ä¿¡å·é‡ä¸Šé™) |
| `parallel_min_steps` | usize | 1 | å¯ç”¨å¹¶è¡Œçš„æœ€å°æ­¥éª¤æ•°é˜ˆå€¼ |
| `enable_step_level_reflection` | bool | true | æ˜¯å¦å¯ç”¨æ­¥éª¤çº§åæ€ |
| `max_consecutive_failures` | usize | 3 | å•æ­¥éª¤æœ€å¤§å¤±è´¥é‡è¯•æ¬¡æ•° |
| `max_replanning_attempts` | usize | 3 | æœ€å¤§é‡æ–°è§„åˆ’æ¬¡æ•° |

**æ€§èƒ½è°ƒä¼˜å»ºè®®**:
- IOå¯†é›†å‹ä»»åŠ¡: `parallel_max_concurrent = CPUæ ¸å¿ƒæ•° * 2~4`
- CPUå¯†é›†å‹ä»»åŠ¡: `parallel_max_concurrent = CPUæ ¸å¿ƒæ•°`
- æ··åˆå‹ä»»åŠ¡: `parallel_max_concurrent = CPUæ ¸å¿ƒæ•° * 2`

### å…¼å®¹æ€§è®¾è®¡

#### å‘åå…¼å®¹
- âœ… **åè®®å…¼å®¹**: æ—§ç‰ˆtool+parametersæ ¼å¼ç»§ç»­æœ‰æ•ˆ
- âœ… **å¯é€‰å¯ç”¨**: `enable_parallel_execution=false`æ—¶å¼ºåˆ¶ä¸²è¡Œæ‰§è¡Œ
- âœ… **æ··åˆä½¿ç”¨**: åŒä¸€è®¡åˆ’å¯æ··ç”¨æ–°æ—§æ ¼å¼

```rust
// æ‰§è¡Œå™¨è‡ªåŠ¨æ£€æµ‹æ ¼å¼
if !step.actions.is_empty() {
    // æ–°æ ¼å¼: å¹¶è¡Œæ‰§è¡Œactions
    execute_step_with_actions(step).await
} else {
    // æ—§æ ¼å¼: å•å·¥å…·è°ƒç”¨
    execute_single_tool(step.tool, step.parameters).await
}
```

#### æ¸è¿›å¼å‡çº§è·¯å¾„
```
Phase 1: ä¸²è¡Œæ‰§è¡Œ (serial_execution_version)
    â†“
Phase 2: æ­¥éª¤é—´å¹¶è¡Œ (å¯ç”¨parallel_executor)
    â†“
Phase 3: æ­¥éª¤å†…å¹¶è¡Œ (ä½¿ç”¨actionsæ ¼å¼)
    â†“
Phase 4: ä¸¤å±‚å¹¶è¡Œ (åŒæ—¶å¯ç”¨ä¸¤ç§å¹¶è¡Œæ¨¡å¼)
```

### å…³é”®æ–‡ä»¶ä¾èµ–å…³ç³»

```
proto/task_orchestrator_service.proto  â† åè®®å®šä¹‰
    â†“ (å®šä¹‰PlanAction/PlanStep)
src/core/planner.rs  â† è§„åˆ’å™¨(ç”Ÿæˆæ‰§è¡Œè®¡åˆ’)
    â†“ (è§£æLLMè¾“å‡ºä¸ºExecutionPlan)
src/core/orchestrator.rs  â† ç¼–æ’å™¨(è°ƒåº¦æ‰§è¡Œ)
    â”œâ†’ src/core/parallel_executor.rs  â† æ­¥éª¤é—´å¹¶è¡Œæ‰§è¡Œ
    â””â†’ src/core/executor.rs  â† æ­¥éª¤å†…å¹¶è¡Œæ‰§è¡Œ
           â†“ (è°ƒç”¨å‚æ•°è§£æ)
       src/core/parameter_resolver.rs  â† å ä½ç¬¦è§£æ
           â†“ (è·å–ä¸Šä¸‹æ–‡)
       src/core/mod.rs (ExecutionContext)  â† æ‰§è¡Œä¸Šä¸‹æ–‡
```

### æ€§èƒ½ä¼˜åŠ¿

| åœºæ™¯ | ä¸²è¡Œç‰ˆæœ¬è€—æ—¶ | å¹¶è¡Œç‰ˆæœ¬è€—æ—¶ | åŠ é€Ÿæ¯” |
|------|-------------|-------------|--------|
| 3ä¸ªç‹¬ç«‹æ­¥éª¤(æ¯ä¸ª2ç§’) | 6ç§’ | ~2ç§’ | 3x |
| æ­¥éª¤å†…3ä¸ªç‹¬ç«‹æ“ä½œ(æ¯ä¸ª1ç§’) | 3ç§’ | ~1ç§’ | 3x |
| æ··åˆåœºæ™¯(6ä¸ªæ­¥éª¤,éƒ¨åˆ†å¹¶è¡Œ) | 12ç§’ | ~4ç§’ | 3x |

**å®é™…æµ‹è¯•æ¡ˆä¾‹**: `examples/parallel_calculation_test.rs`
- ä»»åŠ¡: ä¸‰å±‚è®¡ç®—(3ä¸ªå¹³æ–¹æ•° â†’ 2ç»„æ±‚å’Œ â†’ æœ€ç»ˆæ±‡æ€»)
- ä¸²è¡Œè€—æ—¶: ~6ç§’
- å¹¶è¡Œè€—æ—¶: ~2ç§’
- åŠ é€Ÿæ¯”: **3x**

### å®ç°äº®ç‚¹

1. âœ… **é›¶ä¾µå…¥å¼å‡çº§**: æ—§ä»£ç æ— éœ€ä¿®æ”¹å³å¯è¿è¡Œ
2. âœ… **è‡ªåŠ¨ä¾èµ–åˆ†æ**: æ— éœ€æ‰‹åŠ¨æŒ‡å®šå¹¶è¡Œæ‰¹æ¬¡
3. âœ… **å®‰å…¨å¹¶å‘æ§åˆ¶**: ä¿¡å·é‡é˜²æ­¢èµ„æºè€—å°½
4. âœ… **æ—©æœŸå¤±è´¥ç»ˆæ­¢**: æ‰¹æ¬¡å¤±è´¥ç«‹å³åœæ­¢åç»­æ‰¹æ¬¡
5. âœ… **ç¯æ£€æµ‹**: Kahnç®—æ³•è‡ªåŠ¨æ£€æµ‹ä¾èµ–ç¯
6. âœ… **å®Œæ•´æ—¥å¿—**: è¯¦ç»†çš„æ‰§è¡Œè¿‡ç¨‹æ—¥å¿—
7. âœ… **æ”¯æŒåæ€æ¨¡å¼**: å¹¶è¡Œæ‰§è¡Œä¸æ­¥éª¤çº§åæ€å…¼å®¹

---

### å¹¶è¡Œæ‰§è¡Œä¸åæ€æœºåˆ¶çš„é›†æˆ

#### è®¾è®¡åŸåˆ™
å¹¶è¡Œæ‰§è¡ŒåŠŸèƒ½åœ¨è®¾è®¡æ—¶å……åˆ†è€ƒè™‘äº†ä¸ç°æœ‰åæ€æœºåˆ¶çš„å…¼å®¹æ€§,ç¡®ä¿ä¸¤è€…æ— ç¼é›†æˆã€‚

#### æ­¥éª¤å†…å¹¶è¡Œæ‰§è¡Œå¤±è´¥çš„å¤„ç†

å½“ä¸€ä¸ªæ­¥éª¤åŒ…å«å¤šä¸ªå¹¶è¡Œactionsæ—¶,å¤±è´¥å¤„ç†éµå¾ªä»¥ä¸‹è§„åˆ™:

##### 1. **å¤±è´¥åˆ¤å®šç­–ç•¥** ([executor.rs:2139-2174](src/core/executor.rs#L2139-L2174))

**ä»£ç å®ç°**:
```rust
// å¤„ç†å¹¶è¡Œæ‰§è¡Œç»“æœ
let mut has_failure = false;
let mut error_messages = Vec::new();

for result in results {
    match result {
        Ok(Ok((action_id, is_success, output, error_msg, _))) => {
            if !is_success {
                has_failure = true;  // â† ä»»æ„ä¸€ä¸ªactionå¤±è´¥,æ•´ä½“æ ‡è®°å¤±è´¥
                if let Some(err) = error_msg {
                    error_messages.push(format!("{}: {}", action_id, err));
                }
            }
            // ä¿å­˜æ¯ä¸ªactionçš„ç»“æœåˆ°ä¸Šä¸‹æ–‡
            context.set_step_result(action_result);
        }
        Ok(Err(e)) => {
            has_failure = true;
            error_messages.push(e.to_string());
        }
        Err(e) => {
            has_failure = true;
            error_messages.push(format!("ä»»åŠ¡panic: {}", e));
        }
    }
}
```

**å…³é”®ç‰¹æ€§**:
- âœ… **ä»»æ„å¤±è´¥åŸåˆ™**: åªè¦æœ‰ä»»ä½•ä¸€ä¸ªactionå¤±è´¥,æ•´ä¸ªæ­¥éª¤æ ‡è®°ä¸º`is_success=false`
- âœ… **ç»“æœèšåˆ**: æ‰€æœ‰actionçš„è¾“å‡ºå’Œé”™è¯¯ä¿¡æ¯èšåˆä¸ºå•ä¸ª`StepResult`
- âœ… **ä¸æå‰ç»ˆæ­¢**: å³ä½¿æŸä¸ªactionå¤±è´¥,å…¶ä»–actionä»ä¼šæ‰§è¡Œå®Œæˆ(ç­‰å¾…`join_all`å®Œæˆ)
- âœ… **å®Œæ•´ä¿¡æ¯**: æ¯ä¸ªactionçš„ç»“æœéƒ½ä¿å­˜åˆ°æ‰§è¡Œä¸Šä¸‹æ–‡,ä¾¿äºåç»­å¼•ç”¨

##### 2. **åæ€æœºåˆ¶çš„è§†è§’** ([executor.rs:2199-2222](src/core/executor.rs#L2199-L2222))

**èšåˆåçš„æ­¥éª¤ç»“æœ**:
```rust
let step_result = StepResult {
    step_id: step.step_id.clone(),
    step_name: step.name.clone(),
    tool_id: format!("parallel_actions({} ops)", step.actions.len()),
    is_success: !has_failure,  // â† èšåˆçš„æˆåŠŸçŠ¶æ€
    output: aggregated_output,  // â† æ ¼å¼: "[action_id] âœ…/âŒ output"
    error_message: aggregated_error,  // â† æ‰€æœ‰é”™è¯¯çš„åˆé›†
    execution_time_ms: total_time,
    ...
};
```

æ­¥éª¤çº§åæ€å™¨æ”¶åˆ°çš„æ˜¯**èšåˆåçš„ç»“æœ**,åŒ…å«:
- `is_success: false` (æ•´ä½“å¤±è´¥æ ‡è®°)
- `output`: æ‰€æœ‰actionçš„è¾“å‡º,æ ¼å¼ä¸º`[action_id] âœ…/âŒ output`
- `error_message`: æ‰€æœ‰å¤±è´¥actionçš„é”™è¯¯ä¿¡æ¯åˆé›†

**åæ€å™¨å¯¹å¹¶è¡Œæ‰§è¡Œé€æ˜**:
- âŒ åæ€å™¨**ä¸çŸ¥é“**è¿™æ˜¯å¹¶è¡Œæ‰§è¡Œçš„æ­¥éª¤
- âœ… åæ€å™¨åªçŸ¥é“æ­¥éª¤å¤±è´¥äº†
- âœ… é€šè¿‡`output`å¯ä»¥çœ‹åˆ°æ¯ä¸ªactionçš„æ‰§è¡Œæƒ…å†µ(æˆåŠŸ/å¤±è´¥æ ‡è®°)
- âœ… å¯ä»¥åŸºäºè¯¦ç»†è¾“å‡ºè¿›è¡ŒåŸå› åˆ†æå’Œé‡æ–°è§„åˆ’

##### 3. **ç¤ºä¾‹åœºæ™¯**

**å¹¶è¡Œæ‰§è¡Œ**:
```
step_1 åŒ…å«3ä¸ªå¹¶è¡Œactions:
  action_1_1: è®¡ç®— 5**2 = 25 âœ…
  action_1_2: è®¡ç®— 8**0 = é™¤é›¶é”™è¯¯ âŒ
  action_1_3: è®¡ç®— 12**2 = 144 âœ…
```

**èšåˆç»“æœ** (ä¼ é€’ç»™åæ€å™¨):
```rust
StepResult {
    step_id: "step_1",
    step_name: "å¹¶è¡Œè®¡ç®—å¹³æ–¹æ•°",
    tool_id: "parallel_actions(3 ops)",
    is_success: false,  // â† å› ä¸ºaction_1_2å¤±è´¥
    output: "[action_1_1] âœ… 25\n[action_1_2] âŒ é™¤é›¶é”™è¯¯\n[action_1_3] âœ… 144",
    error_message: Some("action_1_2: é™¤é›¶é”™è¯¯"),
    execution_time_ms: 156,
}
```

**åæ€å™¨å¤„ç†æµç¨‹**:
```
1. æ£€æµ‹åˆ°æ­¥éª¤å¤±è´¥ (is_success=false)
   â†“
2. åˆ†æoutput,è¯†åˆ«å‡º:
   - action_1_1: æˆåŠŸ
   - action_1_2: å¤±è´¥ (é™¤é›¶é”™è¯¯)
   - action_1_3: æˆåŠŸ
   â†“
3. å¯èƒ½çš„åæ€ç­–ç•¥:
   â”œâ”€ ç­–ç•¥A: é‡æ–°è§„åˆ’,ä¿®å¤action_1_2çš„å‚æ•°
   â”œâ”€ ç­–ç•¥B: ä½¿ç”¨å¤‡é€‰å·¥å…·æ›¿æ¢å¤±è´¥çš„action
   â”œâ”€ ç­–ç•¥C: ç§»é™¤å¤±è´¥çš„action,ç»§ç»­åç»­æ­¥éª¤
   â””â”€ ç­–ç•¥D: è°ƒæ•´å‚æ•°è¦†ç›–,é‡è¯•æ•´ä¸ªæ­¥éª¤
```

##### 4. **è¾“å‡ºæ ¼å¼è®¾è®¡** ([executor.rs:2176-2187](src/core/executor.rs#L2176-L2187))

```rust
// æŒ‰ç…§åŸå§‹actionsé¡ºåºé‡æ–°æ’åˆ—ç»“æœ
let mut ordered_outputs = Vec::new();
for action in &step.actions {
    if let Some((is_success, output)) = action_results_map.get(&action.action_id) {
        ordered_outputs.push(format!(
            "[{}] {} {}",
            action.action_id,           // actionæ ‡è¯†
            if *is_success { "âœ…" } else { "âŒ" },  // æˆåŠŸ/å¤±è´¥æ ‡è®°
            output                      // å®é™…è¾“å‡º
        ));
    }
}
let aggregated_output = ordered_outputs.join("\n");
```

**è¾“å‡ºç¤ºä¾‹**:
```
[action_1_1] âœ… 25
[action_1_2] âŒ division by zero
[action_1_3] âœ… 144
```

**ä¼˜åŠ¿**:
- âœ… **ç»“æ„åŒ–**: æ¯è¡Œå¯¹åº”ä¸€ä¸ªaction,ä¾¿äºè§£æ
- âœ… **å¯è§†åŒ–**: ä½¿ç”¨emojiå¿«é€Ÿè¯†åˆ«æˆåŠŸ/å¤±è´¥
- âœ… **å¯è¿½æº¯**: åŒ…å«action_id,å¯å®šä½å…·ä½“å¤±è´¥çš„æ“ä½œ
- âœ… **LLMå‹å¥½**: æ ¼å¼æ¸…æ™°,é€‚åˆLLMåˆ†æå’Œç”Ÿæˆä¿®å¤æ–¹æ¡ˆ

##### 5. **ä¸ä¸²è¡Œæ‰§è¡Œçš„ä¸€è‡´æ€§**

| ç»´åº¦ | ä¸²è¡Œæ‰§è¡Œ(æ—§æ ¼å¼) | å¹¶è¡Œæ‰§è¡Œ(actionsæ ¼å¼) | ä¸€è‡´æ€§ |
|------|-----------------|---------------------|--------|
| **å¤±è´¥æ ‡è®°** | `is_success=false` | `is_success=false` | âœ… ä¸€è‡´ |
| **é”™è¯¯ä¿¡æ¯** | `error_message: Some(...)` | `error_message: Some(...)` | âœ… ä¸€è‡´ |
| **è¾“å‡ºæ ¼å¼** | å•ä¸ªå·¥å…·è¾“å‡º | èšåˆçš„å¤šä¸ªactionè¾“å‡º | âš ï¸ æ ¼å¼ä¸åŒ,ä½†è¯­ä¹‰ä¸€è‡´ |
| **åæ€æ¥å£** | `StepResult` | `StepResult` | âœ… å®Œå…¨ä¸€è‡´ |
| **ä¸Šä¸‹æ–‡ä¿å­˜** | `context.set_step_result()` | `context.set_step_result()` | âœ… ä¸€è‡´ |

**å…³é”®ç‚¹**:
- âœ… **æ¥å£å…¼å®¹**: åæ€å™¨è°ƒç”¨çš„APIå®Œå…¨ä¸€è‡´
- âœ… **è¯­ä¹‰ä¿æŒ**: å¤±è´¥å°±æ˜¯å¤±è´¥,æˆåŠŸå°±æ˜¯æˆåŠŸ
- âœ… **ä¿¡æ¯å¢å¼º**: å¹¶è¡Œæ‰§è¡Œæä¾›äº†æ›´è¯¦ç»†çš„æ‰§è¡Œä¿¡æ¯(æ¯ä¸ªactionçš„çŠ¶æ€)

##### 6. **è®¾è®¡ä¼˜åŠ¿**

1. âœ… **ç®€åŒ–åæ€é€»è¾‘**: åæ€å™¨æ— éœ€ç†è§£å¹¶è¡Œç»“æ„,åªéœ€å¤„ç†èšåˆåçš„`StepResult`
2. âœ… **å‘åå…¼å®¹**: ä¸ä¸²è¡Œæ‰§è¡Œçš„åæ€æœºåˆ¶å®Œå…¨ä¸€è‡´,æ— éœ€ä¿®æ”¹åæ€å™¨ä»£ç 
3. âœ… **ä¿¡æ¯å®Œæ•´**: é€šè¿‡èšåˆè¾“å‡º,åæ€å™¨èƒ½çœ‹åˆ°æ‰€æœ‰æ‰§è¡Œç»†èŠ‚
4. âœ… **çµæ´»å¤„ç†**: åæ€å™¨å¯ä»¥é€‰æ‹©:
   - ä¿®å¤éƒ¨åˆ†å¤±è´¥çš„action
   - é‡æ–°è§„åˆ’æ•´ä¸ªæ­¥éª¤
   - ä½¿ç”¨å¤‡é€‰å·¥å…·
   - è°ƒæ•´å‚æ•°é‡è¯•
5. âœ… **ä¸å½±å“å…¶ä»–æ­¥éª¤**: æ¯ä¸ªactionçš„ç»“æœå•ç‹¬ä¿å­˜(`action_id`ä½œä¸ºkey),åç»­æ­¥éª¤å¯ä»¥å¼•ç”¨å•ä¸ªactionçš„è¾“å‡º

##### 7. **å®é™…æµ‹è¯•éªŒè¯**

**æµ‹è¯•æ–‡ä»¶**: `examples/parallel_calculation_test.rs`

**åœºæ™¯**: æ­¥éª¤å†…å¹¶è¡Œæ‰§è¡Œ,æŸä¸ªactionå¤±è´¥

```rust
// step_1: 3ä¸ªå¹¶è¡Œè®¡ç®—
actions: [
    action_1_1: 5**2,    // æˆåŠŸ
    action_1_2: invalid, // å¤±è´¥
    action_1_3: 12**2,   // æˆåŠŸ
]

// åæ€å™¨æ”¶åˆ°çš„ç»“æœ
StepResult {
    is_success: false,
    output: "[action_1_1] âœ… 25\n[action_1_2] âŒ error\n[action_1_3] âœ… 144",
}

// åæ€å™¨è¡Œä¸º
1. è¯†åˆ«å¤±è´¥
2. åˆ†æoutput
3. é‡æ–°è§„åˆ’:ä¿®å¤action_1_2
4. é‡è¯•æ‰§è¡Œ
```

**éªŒè¯ç»“æœ**: âœ… åæ€æœºåˆ¶æ­£å¸¸å·¥ä½œ,æ— éœ€ç‰¹æ®Šå¤„ç†

---

## ğŸ”§ æ­¥éª¤å†…Actionså¹¶è¡Œæ‰§è¡Œè¯¦ç»†æœºåˆ¶

### ğŸ“‹ ç« èŠ‚æ¦‚è¿°

æœ¬ç« èŠ‚è¯¦ç»†è¯´æ˜**ä¸€ä¸ªStepå†…åŒ…å«å¤šä¸ªActionæ—¶çš„å¹¶è¡Œæ‰§è¡Œæœºåˆ¶**ï¼ŒåŒ…æ‹¬æ‰§è¡Œæµç¨‹ã€å¹¶å‘æ§åˆ¶ã€ç»“æœèšåˆã€é”™è¯¯å¤„ç†ç­‰æ ¸å¿ƒå®ç°ç»†èŠ‚ã€‚

### æ ¸å¿ƒå®ç°æ–‡ä»¶
- **æ–‡ä»¶ä½ç½®**: [src/core/executor.rs:1992-2222](../../../src/core/executor.rs#L1992-L2222)
- **ä¸»è¦æ–¹æ³•**: `execute_step_with_actions`
- **è§¦å‘æ¡ä»¶**: `!step.actions.is_empty()` (æ­¥éª¤åŒ…å«actionså­—æ®µä¸”éç©º)

---

### 1ï¸âƒ£ æ‰§è¡Œè§¦å‘æœºåˆ¶

#### æ ¼å¼æ£€æµ‹é€»è¾‘
```rust
// æ–‡ä»¶: src/core/executor.rs:923-947
pub async fn execute_single_step_with_overrides(...) -> Result<StepResult> {
    let step = &plan.steps[step_index];

    // ğŸ” æ£€æŸ¥æ˜¯å¦ä½¿ç”¨actionsæ ¼å¼
    if !step.actions.is_empty() {
        info!(
            step_id = %step.step_id,
            actions_count = step.actions.len(),
            "ğŸ”„ æ­¥éª¤åŒ…å«{}ä¸ªæ“ä½œ,å‡†å¤‡å¹¶è¡Œæ‰§è¡Œï¼ˆæ­¥éª¤çº§åæ€æ¨¡å¼ï¼‰",
            step.actions.len()
        );

        // æ„å»ºtool_map
        let tool_map: HashMap<String, ToolInfo> = available_tools
            .iter()
            .map(|t| (t.id.clone(), t.clone()))
            .collect();

        // âœ… è°ƒç”¨actionså¹¶è¡Œæ‰§è¡Œæ–¹æ³•
        return self.execute_step_with_actions(
            step,
            execution_context,
            &tool_map,
            step_index,
            plan.steps.len(),
        ).await;
    }

    // å¦åˆ™ä½¿ç”¨æ—§æ ¼å¼(tool + parameters)
    // ...
}
```

**å…³é”®ç‚¹**:
- âœ… **è‡ªåŠ¨æ£€æµ‹**: æ ¹æ®`step.actions`æ˜¯å¦ä¸ºç©ºè‡ªåŠ¨é€‰æ‹©æ‰§è¡Œè·¯å¾„
- âœ… **å‘åå…¼å®¹**: ç©ºactionsæ—¶ä½¿ç”¨æ—§ç‰ˆå•å·¥å…·æ‰§è¡Œ
- âœ… **tool_mapæ„å»º**: æå‰æ„å»ºå·¥å…·æ˜ å°„è¡¨,åŠ é€Ÿåç»­æŸ¥æ‰¾

---

### 2ï¸âƒ£ å¹¶è¡Œæ‰§è¡Œæ ¸å¿ƒæµç¨‹

#### æ–¹æ³•ç­¾å
```rust
// æ–‡ä»¶: src/core/executor.rs:1992-1999
async fn execute_step_with_actions(
    &self,
    step: &PlanStep,               // åŒ…å«å¤šä¸ªactionsçš„æ­¥éª¤
    context: &ExecutionContext,    // æ‰§è¡Œä¸Šä¸‹æ–‡(å­˜å‚¨ç»“æœå’Œmetadata)
    tool_map: &HashMap<String, ToolInfo>,  // å·¥å…·ä¿¡æ¯æ˜ å°„
    step_index: usize,             // æ­¥éª¤ç´¢å¼•(ç”¨äºæ—¥å¿—)
    total_steps: usize,            // æ€»æ­¥éª¤æ•°(ç”¨äºæ—¥å¿—)
) -> Result<StepResult>
```

#### æ‰§è¡Œæµç¨‹å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. åˆ›å»ºä¿¡å·é‡ (max_concurrentä¸ªè®¸å¯)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ä¸ºæ¯ä¸ªactionåˆ›å»ºå¼‚æ­¥ä»»åŠ¡ (tokio::spawn)                â”‚
â”‚     - è·å–ä¿¡å·é‡è®¸å¯ (_permit)                             â”‚
â”‚     - è§£æå‚æ•° (å¤„ç†å ä½ç¬¦{{action_id.output}})            â”‚
â”‚     - è°ƒç”¨å·¥å…·æ‰§è¡Œ                                         â”‚
â”‚     - é‡Šæ”¾è®¸å¯ (è‡ªåŠ¨drop)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. å¹¶å‘æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡ (join_all)                            â”‚
â”‚     - å¤šä¸ªactionåŒæ—¶æ‰§è¡Œ                                   â”‚
â”‚     - å—ä¿¡å·é‡é™æµ (æœ€å¤šmax_concurrentä¸ªåŒæ—¶æ‰§è¡Œ)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. æ”¶é›†å’Œå¤„ç†ç»“æœ                                         â”‚
â”‚     - å¤„ç†æˆåŠŸ/å¤±è´¥/panic                                  â”‚
â”‚     - ä¿å­˜æ¯ä¸ªactionç»“æœåˆ°ExecutionContext                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. èšåˆç»“æœ                                               â”‚
â”‚     - åˆ¤å®šæ•´ä½“æˆåŠŸ/å¤±è´¥                                     â”‚
â”‚     - æ„å»ºèšåˆè¾“å‡º "[action_id] âœ…/âŒ output"               â”‚
â”‚     - è¿”å›StepResult                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3ï¸âƒ£ å¹¶å‘æ§åˆ¶ - ä¿¡å·é‡æœºåˆ¶

#### ä¿¡å·é‡åˆ›å»º
```rust
// Lines 2015-2016
let semaphore = Arc::new(Semaphore::new(self.parallel_max_concurrent));
```

**é…ç½®æ¥æº**: `config.dev.toml` â†’ `parallel_max_concurrent = 8`

#### å¹¶å‘é™æµé€»è¾‘
```rust
// Lines 2030-2033 (åœ¨tokio::spawnå†…éƒ¨)
tokio::spawn(async move {
    // ğŸ”’ è·å–ä¿¡å·é‡è®¸å¯ (é˜»å¡ç›´åˆ°æœ‰è®¸å¯å¯ç”¨)
    let _permit = semaphore_clone.acquire().await.unwrap();

    info!(
        action_id = %action_clone.action_id,
        "  â–¶ï¸  å¼€å§‹æ‰§è¡Œæ“ä½œ"
    );

    // ... æ‰§è¡Œå·¥å…·è°ƒç”¨

    // ğŸ“¤ è®¸å¯åœ¨_permit dropæ—¶è‡ªåŠ¨é‡Šæ”¾
})
```

**å·¥ä½œåŸç†**:
1. **ä¿¡å·é‡åˆå§‹åŒ–**: åˆ›å»ºåŒ…å«`max_concurrent`ä¸ªè®¸å¯çš„ä¿¡å·é‡
2. **è®¸å¯è·å–**: æ¯ä¸ªactionæ‰§è¡Œå‰è·å–ä¸€ä¸ªè®¸å¯
3. **é˜»å¡ç­‰å¾…**: å¦‚æœæ— å¯ç”¨è®¸å¯,ä»»åŠ¡æŒ‚èµ·ç­‰å¾…
4. **è‡ªåŠ¨é‡Šæ”¾**: `_permit`è¶…å‡ºä½œç”¨åŸŸæ—¶è‡ªåŠ¨é‡Šæ”¾è®¸å¯
5. **å¹¶å‘ä¸Šé™**: ç¡®ä¿åŒæ—¶æ‰§è¡Œçš„actionæ•°é‡ â‰¤ `parallel_max_concurrent`

**ç¤ºä¾‹åœºæ™¯**:
```
é…ç½®: parallel_max_concurrent = 3
ä»»åŠ¡: stepåŒ…å«5ä¸ªactions [A1, A2, A3, A4, A5]

æ—¶é—´çº¿:
t0: [A1 A2 A3] å¼€å§‹æ‰§è¡Œ (3ä¸ªè®¸å¯å…¨éƒ¨å ç”¨)
    [A4 A5]    ç­‰å¾…è®¸å¯
t1: A1å®Œæˆ,é‡Šæ”¾è®¸å¯
    [A2 A3 A4] æ‰§è¡Œä¸­ (A4è·å¾—è®¸å¯)
    [A5]       ç­‰å¾…è®¸å¯
t2: A2å®Œæˆ,é‡Šæ”¾è®¸å¯
    [A3 A4 A5] æ‰§è¡Œä¸­ (A5è·å¾—è®¸å¯)
t3: A3, A4, A5 é™†ç»­å®Œæˆ
```

---

### 4ï¸âƒ£ å‚æ•°è§£æ - å ä½ç¬¦å¤„ç†

#### å ä½ç¬¦æ”¯æŒç±»å‹
```rust
// Lines 2042-2075
// è§£æå‚æ•°å¹¶å¤„ç†å ä½ç¬¦
let parameters = if action_clone.parameters.is_empty() {
    HashMap::new()
} else {
    match serde_json::from_str::<HashMap<String, serde_json::Value>>(&action_clone.parameters) {
        Ok(params_obj) => {
            params_obj
                .into_iter()
                .map(|(k, v)| {
                    let value_str = match v {
                        serde_json::Value::String(s) => s,
                        serde_json::Value::Number(n) => n.to_string(),
                        serde_json::Value::Bool(b) => b.to_string(),
                        serde_json::Value::Null => "null".to_string(),
                        _ => serde_json::to_string(&v).unwrap_or_default(),
                    };

                    // ğŸ”‘ ã€å…³é”®ã€‘å¤„ç†å ä½ç¬¦ï¼ˆå¦‚ {{action_1_1.output}}ï¼‰
                    let resolved_value = ParameterResolver::process_parameter_value(
                        &value_str,
                        &context_clone
                    );

                    (k, resolved_value)
                })
                .collect()
        }
        Err(e) => {
            warn!("âš ï¸  å‚æ•°è§£æå¤±è´¥ï¼Œä½¿ç”¨ç©ºå‚æ•°");
            HashMap::new()
        }
    }
}
```

**æ”¯æŒçš„å ä½ç¬¦æ ¼å¼**:
| æ ¼å¼ | ç¤ºä¾‹ | è§£æç»“æœ |
|------|------|---------|
| `{{action_id.output}}` | `{{action_1_1.output}}` | å¼•ç”¨åŒæ­¥éª¤å†…å…¶ä»–actionçš„è¾“å‡º |
| `{{step_id.output}}` | `{{step_1.output}}` | å¼•ç”¨å…¶ä»–æ­¥éª¤çš„è¾“å‡º |
| å¤šå ä½ç¬¦è¡¨è¾¾å¼ | `{{action_1_1.output}} + {{action_1_2.output}}` | `"25 + 64"` |

**ç¤ºä¾‹**:
```json
{
  "action_id": "action_2_1",
  "parameters": {
    "code": "{{action_1_1.output}} + {{action_1_2.output}}"
  }
}

// è§£æå:
{
  "code": "25 + 64"  // action_1_1.output=25, action_1_2.output=64
}
```

---

### 5ï¸âƒ£ å·¥å…·è°ƒç”¨æ‰§è¡Œ

```rust
// Lines 2077-2118
// è°ƒç”¨å·¥å…·
let tool_result = match timeout(
    timeout_duration,
    tool_client.call_tool(&action_clone.tool, parameters_clone)
).await {
    Ok(Ok(output)) => {
        info!(
            action_id = %action_clone.action_id,
            "  âœ… æ“ä½œæ‰§è¡ŒæˆåŠŸ"
        );
        (
            action_clone.action_id.clone(),
            true,                    // is_success
            output,                  // å·¥å…·è¾“å‡º
            None,                    // error_message
            execution_time,
        )
    }
    Ok(Err(e)) => {
        error!(
            action_id = %action_clone.action_id,
            error = %e,
            "  âŒ æ“ä½œæ‰§è¡Œå¤±è´¥"
        );
        (
            action_clone.action_id.clone(),
            false,                   // is_success
            String::new(),
            Some(e.to_string()),     // error_message
            execution_time,
        )
    }
    Err(_) => {
        // è¶…æ—¶
        (
            action_clone.action_id.clone(),
            false,
            String::new(),
            Some(format!("æ“ä½œè¶…æ—¶({:.1}ç§’)", timeout_duration.as_secs_f32())),
            timeout_duration.as_millis() as u64,
        )
    }
};
```

**å…³é”®æœºåˆ¶**:
- âœ… **è¶…æ—¶æ§åˆ¶**: ä½¿ç”¨`tokio::timeout`é˜²æ­¢actionæ— é™æ‰§è¡Œ
- âœ… **é”™è¯¯æ•è·**: åŒºåˆ†æ‰§è¡Œå¤±è´¥vsè¶…æ—¶
- âœ… **ç»Ÿä¸€è¿”å›**: æ‰€æœ‰åˆ†æ”¯è¿”å›ç›¸åŒæ ¼å¼çš„å…ƒç»„
- âœ… **è¯¦ç»†æ—¥å¿—**: è®°å½•æ¯ä¸ªactionçš„æ‰§è¡ŒçŠ¶æ€

---

### 6ï¸âƒ£ ç»“æœæ”¶é›†ä¸å¤„ç†

#### ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
```rust
// Lines 2121-2122
let results = join_all(tasks).await;
```

**`join_all`ç‰¹æ€§**:
- âœ… **å…¨éƒ¨ç­‰å¾…**: ç­‰å¾…æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡å®Œæˆ(ä¸ä¼šæå‰ç»ˆæ­¢)
- âœ… **å¹¶å‘æ‰§è¡Œ**: ä»»åŠ¡çœŸæ­£å¹¶å‘è¿è¡Œ
- âœ… **é¡ºåºä¿æŒ**: è¿”å›ç»“æœé¡ºåºä¸è¾“å…¥ä»»åŠ¡é¡ºåºä¸€è‡´

#### ç»“æœå¤„ç†é€»è¾‘
```rust
// Lines 2139-2174
let mut action_results_map: HashMap<String, (bool, String)> = HashMap::new();
let mut has_failure = false;
let mut error_messages = Vec::new();

for (idx, result) in results.into_iter().enumerate() {
    let action_id = &step.actions[idx].action_id;

    match result {
        // ä»»åŠ¡æˆåŠŸæ‰§è¡Œ
        Ok(Ok((action_id, is_success, output, error_msg, exec_time))) => {
            if !is_success {
                has_failure = true;  // â† ä»»æ„å¤±è´¥æ ‡è®°æ•´ä½“å¤±è´¥
                if let Some(err) = error_msg {
                    error_messages.push(format!("{}: {}", action_id, err));
                }
            }

            // ä¿å­˜ç»“æœåˆ°map
            action_results_map.insert(action_id.clone(), (is_success, output.clone()));

            // ğŸ”‘ ä¿å­˜åˆ°ExecutionContext (ä¾›åç»­æ­¥éª¤å¼•ç”¨)
            context.set_step_result(StepExecutionResult {
                step_id: action_id.clone(),  // ä½¿ç”¨action_idä½œä¸ºkey
                step_name: step.actions[idx].name.clone(),
                tool_id: step.actions[idx].tool.clone(),
                output,
                is_success,
                error_message: error_msg,
            });
        }

        // ä»»åŠ¡è¿”å›é”™è¯¯
        Ok(Err(e)) => {
            has_failure = true;
            error_messages.push(format!("{}: {}", action_id, e));
            action_results_map.insert(action_id.clone(), (false, String::new()));
        }

        // ä»»åŠ¡panic
        Err(e) => {
            has_failure = true;
            error_messages.push(format!("{}: ä»»åŠ¡panic: {}", action_id, e));
            action_results_map.insert(action_id.clone(), (false, String::new()));
        }
    }
}
```

**å…³é”®è®¾è®¡**:
1. **ä»»æ„å¤±è´¥åŸåˆ™**: åªè¦æœ‰ä¸€ä¸ªactionå¤±è´¥,`has_failure = true`
2. **å®Œæ•´æ”¶é›†**: å³ä½¿æŸä¸ªactionå¤±è´¥,å…¶ä»–actionä»ä¼šæ‰§è¡Œå®Œ
3. **ç»“æœä¿å­˜**: æ¯ä¸ªactionç»“æœéƒ½ä¿å­˜åˆ°`ExecutionContext`,keyä¸º`action_id`
4. **é”™è¯¯èšåˆ**: æ”¶é›†æ‰€æœ‰å¤±è´¥actionçš„é”™è¯¯ä¿¡æ¯

---

### 7ï¸âƒ£ ç»“æœèšåˆ - æ„å»ºStepResult

#### è¾“å‡ºæ ¼å¼åŒ–
```rust
// Lines 2176-2187
// æŒ‰ç…§åŸå§‹actionsé¡ºåºé‡æ–°æ’åˆ—ç»“æœ
let mut ordered_outputs = Vec::new();
for action in &step.actions {
    if let Some((is_success, output)) = action_results_map.get(&action.action_id) {
        ordered_outputs.push(format!(
            "[{}] {} {}",
            action.action_id,                        // actionæ ‡è¯†
            if *is_success { "âœ…" } else { "âŒ" },   // æˆåŠŸ/å¤±è´¥æ ‡è®°
            output                                   // å®é™…è¾“å‡º
        ));
    }
}
let aggregated_output = ordered_outputs.join("\n");
```

**è¾“å‡ºç¤ºä¾‹**:
```
[action_1_1] âœ… 25
[action_1_2] âŒ division by zero
[action_1_3] âœ… 144
```

**è®¾è®¡ä¼˜åŠ¿**:
- âœ… **ç»“æ„åŒ–**: æ¯è¡Œå¯¹åº”ä¸€ä¸ªaction
- âœ… **å¯è§†åŒ–**: ä½¿ç”¨emojiå¿«é€Ÿè¯†åˆ«æˆåŠŸ/å¤±è´¥
- âœ… **å¯è¿½æº¯**: åŒ…å«action_id,å¯å®šä½å…·ä½“æ“ä½œ
- âœ… **LLMå‹å¥½**: æ¸…æ™°æ ¼å¼ä¾¿äºåæ€å™¨åˆ†æ

#### æ„å»ºæœ€ç»ˆStepResult
```rust
// Lines 2199-2222
let step_result = StepResult {
    step_id: step.step_id.clone(),
    step_name: step.name.clone(),

    // ğŸ”‘ tool_idæ˜¾ç¤ºä¸º"parallel_actions(N ops)"
    tool_id: format!("parallel_actions({} ops)", step.actions.len()),

    // ğŸ”‘ æ•´ä½“æˆåŠŸçŠ¶æ€: æ‰€æœ‰actionéƒ½æˆåŠŸæ‰ä¸ºtrue
    is_success: !has_failure,

    // ğŸ”‘ èšåˆè¾“å‡º: æ ¼å¼åŒ–çš„å¤šè¡Œè¾“å‡º
    output: aggregated_output,

    // ğŸ”‘ èšåˆé”™è¯¯: æ‰€æœ‰é”™è¯¯ä¿¡æ¯åˆé›†
    error_message: if error_messages.is_empty() {
        None
    } else {
        Some(error_messages.join("; "))
    },

    execution_time_ms: total_time,

    // å·¥å…·å‚æ•°å­—æ®µä¸ºç©º(actionsæ ¼å¼ä¸ä½¿ç”¨)
    tool_parameters: None,
};

Ok(step_result)
```

**å…³é”®å­—æ®µè¯´æ˜**:
| å­—æ®µ | å€¼ | è¯´æ˜ |
|------|---|------|
| `tool_id` | `"parallel_actions(3 ops)"` | è¡¨æ˜è¿™æ˜¯å¹¶è¡Œæ‰§è¡Œ,åŒ…å«Nä¸ªæ“ä½œ |
| `is_success` | `!has_failure` | ä»»æ„actionå¤±è´¥åˆ™æ•´ä½“å¤±è´¥ |
| `output` | èšåˆçš„å¤šè¡Œè¾“å‡º | åŒ…å«æ¯ä¸ªactionçš„æ‰§è¡Œç»“æœ |
| `error_message` | èšåˆçš„é”™è¯¯ä¿¡æ¯ | åªåŒ…å«å¤±è´¥actionçš„é”™è¯¯ |

---

### 8ï¸âƒ£ ä¸æ­¥éª¤çº§åæ€çš„é›†æˆ

#### åæ€å™¨è§†è§’
ä»æ­¥éª¤çº§åæ€å™¨ï¼ˆReflectorï¼‰çš„è§’åº¦çœ‹,å®ƒæ¥æ”¶åˆ°çš„æ˜¯**èšåˆåçš„StepResult**:

```rust
StepResult {
    step_id: "step_1",
    step_name: "å¹¶è¡Œè®¡ç®—å¹³æ–¹æ•°",
    tool_id: "parallel_actions(3 ops)",  // â† åæ€å™¨çŸ¥é“è¿™æ˜¯å¹¶è¡Œæ‰§è¡Œ
    is_success: false,                    // â† å› ä¸ºæœ‰actionå¤±è´¥
    output: "[action_1_1] âœ… 25\n[action_1_2] âŒ error\n[action_1_3] âœ… 144",
    error_message: Some("action_1_2: division by zero"),
}
```

**åæ€å™¨å¯ä»¥**:
1. âœ… è¯†åˆ«è¿™æ˜¯å¹¶è¡Œæ‰§è¡Œæ­¥éª¤ï¼ˆé€šè¿‡`tool_id`å‰ç¼€ï¼‰
2. âœ… è§£æoutput,å¾—çŸ¥æ¯ä¸ªactionçš„æ‰§è¡ŒçŠ¶æ€
3. âœ… å®šä½å…·ä½“å¤±è´¥çš„actionï¼ˆå¦‚`action_1_2`ï¼‰
4. âœ… æå‡ºé’ˆå¯¹æ€§ä¿®å¤æ–¹æ¡ˆ:
   - ä¿®å¤å¤±è´¥çš„actionå‚æ•°
   - ä½¿ç”¨å¤‡é€‰å·¥å…·æ›¿æ¢å¤±è´¥çš„action
   - ç§»é™¤å¤±è´¥çš„action
   - é‡æ–°è§„åˆ’æ•´ä¸ªæ­¥éª¤

**è®¾è®¡ä¼˜åŠ¿**:
- âœ… **é€æ˜é›†æˆ**: åæ€å™¨æ— éœ€ä¿®æ”¹,å¯ç›´æ¥å¤„ç†å¹¶è¡Œæ‰§è¡Œç»“æœ
- âœ… **ä¿¡æ¯å®Œæ•´**: é€šè¿‡èšåˆè¾“å‡ºå¯ä»¥çœ‹åˆ°æ‰€æœ‰æ‰§è¡Œç»†èŠ‚
- âœ… **çµæ´»å¤„ç†**: åæ€å™¨å¯ä»¥é€‰æ‹©å¤šç§ä¿®å¤ç­–ç•¥

---

### 9ï¸âƒ£ æ‰§è¡Œæ—¶é—´çº¿ç¤ºä¾‹

**åœºæ™¯**: ä¸€ä¸ªæ­¥éª¤åŒ…å«3ä¸ªactions,å¹¶å‘é™åˆ¶ä¸º2

```
Step: "å¹¶è¡Œè®¡ç®—å¹³æ–¹æ•°"
Actions:
  - action_1_1: è®¡ç®—5**2 (è€—æ—¶100ms)
  - action_1_2: è®¡ç®—8**2 (è€—æ—¶150ms)
  - action_1_3: è®¡ç®—12**2 (è€—æ—¶120ms)

é…ç½®: parallel_max_concurrent = 2

æ—¶é—´çº¿:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
t=0ms:   åˆ›å»ºä¿¡å·é‡(2ä¸ªè®¸å¯)
         åˆ›å»º3ä¸ªå¼‚æ­¥ä»»åŠ¡

t=1ms:   [action_1_1] è·å–è®¸å¯1,å¼€å§‹æ‰§è¡Œ
         [action_1_2] è·å–è®¸å¯2,å¼€å§‹æ‰§è¡Œ
         [action_1_3] ç­‰å¾…è®¸å¯ (é˜»å¡)

t=101ms: [action_1_1] å®Œæˆ,è¾“å‡º"25",é‡Šæ”¾è®¸å¯1
         [action_1_3] è·å–è®¸å¯1,å¼€å§‹æ‰§è¡Œ
         [action_1_2] ç»§ç»­æ‰§è¡Œä¸­...

t=151ms: [action_1_2] å®Œæˆ,è¾“å‡º"64",é‡Šæ”¾è®¸å¯2
         [action_1_3] ç»§ç»­æ‰§è¡Œä¸­...

t=221ms: [action_1_3] å®Œæˆ,è¾“å‡º"144",é‡Šæ”¾è®¸å¯1

t=222ms: join_allè¿”å›,æ‰€æœ‰ä»»åŠ¡å®Œæˆ

èšåˆç»“æœ:
  output: "[action_1_1] âœ… 25\n[action_1_2] âœ… 64\n[action_1_3] âœ… 144"
  is_success: true
  total_time: 222ms
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å¯¹æ¯”ä¸²è¡Œæ‰§è¡Œ:
  time = 100 + 150 + 120 = 370ms

å¹¶è¡ŒåŠ é€Ÿæ¯”: 370ms / 222ms â‰ˆ 1.67x
```

---

### ğŸ”Ÿ é”™è¯¯å¤„ç†ç­–ç•¥

#### åœºæ™¯1: å•ä¸ªActionå¤±è´¥
```
è¾“å…¥:
  actions: [A1(æˆåŠŸ), A2(å¤±è´¥), A3(æˆåŠŸ)]

è¾“å‡º:
  is_success: false
  output: "[A1] âœ… result1\n[A2] âŒ error\n[A3] âœ… result3"
  error_message: "A2: error detail"
```

**è¡Œä¸º**: å…¶ä»–actionç»§ç»­æ‰§è¡Œ,æœ€ç»ˆæ•´ä½“æ ‡è®°ä¸ºå¤±è´¥

#### åœºæ™¯2: Actionè¶…æ—¶
```
è¾“å…¥:
  action_1_2 æ‰§è¡Œè¶…è¿‡ execution_timeout (é»˜è®¤600ç§’)

è¾“å‡º:
  is_success: false
  error_message: "action_1_2: æ“ä½œè¶…æ—¶(600.0ç§’)"
```

**è¡Œä¸º**: è¶…æ—¶actionè¢«å–æ¶ˆ,å…¶ä»–actionç»§ç»­

#### åœºæ™¯3: Action Panic
```
è¾“å…¥:
  action_1_2 å†…éƒ¨panic (ä¾‹å¦‚unwrapç©ºå€¼)

è¾“å‡º:
  is_success: false
  error_message: "action_1_2: ä»»åŠ¡panic: ..."
```

**è¡Œä¸º**: panicè¢«`tokio::spawn`æ•è·,ä¸å½±å“å…¶ä»–action

---

### 1ï¸âƒ£1ï¸âƒ£ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹

#### 1. ä¿¡å·é‡å¤§å°è°ƒä¼˜
```toml
# config.dev.toml
[orchestrator]
parallel_max_concurrent = 8  # æ ¹æ®ç¡¬ä»¶å’Œä»»åŠ¡ç±»å‹è°ƒæ•´

å»ºè®®å€¼:
- IOå¯†é›†å‹: CPUæ ¸å¿ƒæ•° * 2~4
- CPUå¯†é›†å‹: CPUæ ¸å¿ƒæ•°
- æ··åˆå‹: CPUæ ¸å¿ƒæ•° * 2
```

#### 2. é¿å…è¿‡åº¦å¹¶è¡Œ
```json
// âŒ ä¸æ¨è: 5ä¸ªç®€å•åŠ æ³•å¹¶è¡Œæ‰§è¡Œ
{
  "actions": [
    {"action_id": "a1", "parameters": {"code": "1+1"}},
    {"action_id": "a2", "parameters": {"code": "2+2"}},
    {"action_id": "a3", "parameters": {"code": "3+3"}},
    {"action_id": "a4", "parameters": {"code": "4+4"}},
    {"action_id": "a5", "parameters": {"code": "5+5"}}
  ]
}

// âœ… æ¨è: åˆå¹¶ä¸ºå•ä¸ªæ“ä½œ
{
  "tool_id": "js_engine",
  "parameters": {"code": "const results = [1+1, 2+2, 3+3, 4+4, 5+5]; results"}
}
```

**åŸå› **: å¹¶è¡Œæ‰§è¡Œæœ‰å¼€é”€(åˆ›å»ºä»»åŠ¡ã€ä¿¡å·é‡ç®¡ç†),ç®€å•æ“ä½œä¸²è¡Œæ›´å¿«

#### 3. åˆç†è®¾ç½®è¶…æ—¶
```rust
// src/core/executor.rs
execution_timeout: Duration  // ä»config.dev.tomlè¯»å–

// æ ¹æ®actionç±»å‹è®¾ç½®:
// - å¿«é€ŸAPIè°ƒç”¨: 5-10ç§’
// - æ•°æ®åº“æŸ¥è¯¢: 30-60ç§’
// - å¤§æ¨¡å‹è°ƒç”¨: 120-600ç§’
```

---

### 1ï¸âƒ£2ï¸âƒ£ æœ€ä½³å®è·µ

#### âœ… é€‚åˆä½¿ç”¨Actionså¹¶è¡Œçš„åœºæ™¯
1. **æ‰¹é‡æ•°æ®å¤„ç†**: å¤„ç†å¤šä¸ªç‹¬ç«‹æ•°æ®æº
2. **å¤šä¸ªç›¸åŒæ“ä½œ**: æ·»åŠ å¤šä¸ªè§’è‰²ã€åˆ›å»ºå¤šä¸ªå¯¹è±¡
3. **ç‹¬ç«‹è®¡ç®—**: å¤šä¸ªæ•°å€¼è®¡ç®—ã€å¤šä¸ªAPIè°ƒç”¨
4. **èšåˆåœºæ™¯**: å¤šä¸ªæ¥æºæ•°æ®æ±‡æ€»

#### âŒ ä¸é€‚åˆä½¿ç”¨Actionså¹¶è¡Œçš„åœºæ™¯
1. **å¼ºä¾èµ–å…³ç³»**: action_2å¿…é¡»ç­‰action_1å®Œæˆ
2. **é¡ºåºæ•æ„Ÿ**: æ“ä½œé¡ºåºå½±å“ç»“æœ
3. **å•ä¸ªæ“ä½œ**: åªæœ‰ä¸€ä¸ªactionæ—¶æ— éœ€å¹¶è¡Œ
4. **èµ„æºç«äº‰**: å¤šä¸ªactionæ“ä½œåŒä¸€å…±äº«èµ„æº

#### ç¤ºä¾‹å¯¹æ¯”

**åœºæ™¯: æ·»åŠ 3ä¸ªè§’è‰²**

```json
// âœ… æ¨è: ä½¿ç”¨actionså¹¶è¡Œ
{
  "step_id": "step_1",
  "step_name": "æ‰¹é‡æ·»åŠ è§’è‰²",
  "actions": [
    {"action_id": "action_1_1", "tool_id": "add_role", "parameters": {"role": "admin"}},
    {"action_id": "action_1_2", "tool_id": "add_role", "parameters": {"role": "user"}},
    {"action_id": "action_1_3", "tool_id": "add_role", "parameters": {"role": "guest"}}
  ]
}
// æ‰§è¡Œæ—¶é—´: ~1ç§’ (3ä¸ªå¹¶è¡Œ)

// âŒ ä¸æ¨è: åˆ†3ä¸ªæ­¥éª¤
{
  "steps": [
    {"step_id": "step_1", "tool_id": "add_role", "parameters": {"role": "admin"}},
    {"step_id": "step_2", "tool_id": "add_role", "parameters": {"role": "user"}},
    {"step_id": "step_3", "tool_id": "add_role", "parameters": {"role": "guest"}}
  ]
}
// æ‰§è¡Œæ—¶é—´: ~3ç§’ (3ä¸ªä¸²è¡Œ)
```

---

### 1ï¸âƒ£3ï¸âƒ£ è°ƒè¯•æŠ€å·§

#### 1. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
```bash
# è®¾ç½®æ—¥å¿—çº§åˆ«ä¸ºdebug
[logging]
level = "debug"

# å…³é”®æ—¥å¿—å…³é”®å­—:
# - "ğŸ”„ æ­¥éª¤åŒ…å«Nä¸ªæ“ä½œ,å‡†å¤‡å¹¶è¡Œæ‰§è¡Œ"  â† æ£€æµ‹åˆ°actionsæ ¼å¼
# - "â–¶ï¸  å¼€å§‹æ‰§è¡Œæ“ä½œ"                 â† actionå¼€å§‹æ‰§è¡Œ
# - "âœ… æ“ä½œæ‰§è¡ŒæˆåŠŸ"                  â† actionæˆåŠŸ
# - "âŒ æ“ä½œæ‰§è¡Œå¤±è´¥"                  â† actionå¤±è´¥
```

#### 2. æ£€æŸ¥ExecutionContext
```rust
// éªŒè¯actionè¾“å‡ºæ˜¯å¦æ­£ç¡®ä¿å­˜
let output = context.get_step_output("action_1_1");
assert!(output.is_some());
```

#### 3. éªŒè¯å ä½ç¬¦è§£æ
```rust
// æ£€æŸ¥å‚æ•°è§£ææ—¥å¿—
"ğŸ” æ£€æµ‹åˆ° action å¼•ç”¨æ ¼å¼"  â† æˆåŠŸè¯†åˆ«actionå¼•ç”¨
"âœ… æˆåŠŸè§£æ action è¾“å‡ºå¼•ç”¨" â† è§£ææˆåŠŸ
"âš ï¸  å¼•ç”¨çš„ action è¾“å‡ºä¸å­˜åœ¨" â† è§£æå¤±è´¥(æ£€æŸ¥ä¾èµ–é¡ºåº)
```

---

### 1ï¸âƒ£4ï¸âƒ£ å®é™…æµ‹è¯•ç”¨ä¾‹

**æ–‡ä»¶**: `examples/parallel_calculation_test.rs`

**æµ‹è¯•åœºæ™¯**:
```json
{
  "step_1": {
    "actions": [
      {"action_id": "action_1_1", "code": "5**2"},   // å¹¶è¡Œ
      {"action_id": "action_1_2", "code": "8**2"},   // å¹¶è¡Œ
      {"action_id": "action_1_3", "code": "12**2"}   // å¹¶è¡Œ
    ]
  },
  "step_2": {
    "actions": [
      {"action_id": "action_2_1", "code": "{{action_1_1.output}} + {{action_1_2.output}}"}, // å¹¶è¡Œ
      {"action_id": "action_2_2", "code": "{{action_1_2.output}} + {{action_1_3.output}}"}  // å¹¶è¡Œ
    ]
  },
  "step_3": {
    "code": "{{action_2_1.output}} + {{action_2_2.output}}"  // ä¸²è¡Œ
  }
}
```

**é¢„æœŸè¾“å‡º**:
```
step_1.output:
[action_1_1] âœ… 25
[action_1_2] âœ… 64
[action_1_3] âœ… 144

step_2.output:
[action_2_1] âœ… 89
[action_2_2] âœ… 208

step_3.output:
297
```

**æ€§èƒ½å¯¹æ¯”**:
- ä¸²è¡Œæ‰§è¡Œ: ~6ç§’ (6ä¸ªæ“ä½œä¾æ¬¡æ‰§è¡Œ)
- å¹¶è¡Œæ‰§è¡Œ: ~2ç§’ (æ‰¹æ¬¡1: 3ä¸ªå¹¶è¡Œ, æ‰¹æ¬¡2: 2ä¸ªå¹¶è¡Œ, æ‰¹æ¬¡3: 1ä¸ª)
- **åŠ é€Ÿæ¯”**: 3x

---

### 1ï¸âƒ£5ï¸âƒ£ å…³é”®ä»£ç ç‰‡æ®µç´¢å¼•

| åŠŸèƒ½ | æ–‡ä»¶ä½ç½® | è¡Œå· | è¯´æ˜ |
|------|---------|------|------|
| Actionsæ ¼å¼æ£€æµ‹ | executor.rs | 923-947 | åˆ¤æ–­æ˜¯å¦ä½¿ç”¨actionsæ ¼å¼ |
| å¹¶è¡Œæ‰§è¡Œå…¥å£ | executor.rs | 1992-1999 | `execute_step_with_actions`æ–¹æ³•ç­¾å |
| ä¿¡å·é‡åˆ›å»º | executor.rs | 2015-2016 | åˆ›å»ºå¹¶å‘æ§åˆ¶ä¿¡å·é‡ |
| ä»»åŠ¡åˆ›å»º | executor.rs | 2018-2120 | ä¸ºæ¯ä¸ªactionåˆ›å»ºå¼‚æ­¥ä»»åŠ¡ |
| å ä½ç¬¦è§£æ | executor.rs | 2042-2075 | è§£æactionå‚æ•°ä¸­çš„å ä½ç¬¦ |
| å·¥å…·è°ƒç”¨ | executor.rs | 2077-2118 | è°ƒç”¨å®é™…å·¥å…·å¹¶å¤„ç†è¶…æ—¶ |
| ç»“æœæ”¶é›† | executor.rs | 2121-2174 | å¤„ç†æ‰€æœ‰ä»»åŠ¡ç»“æœ |
| è¾“å‡ºèšåˆ | executor.rs | 2176-2187 | æ ¼å¼åŒ–è¾“å‡ºä¸ºå¤šè¡Œæ ¼å¼ |
| æ„å»ºStepResult | executor.rs | 2199-2222 | åˆ›å»ºæœ€ç»ˆæ­¥éª¤ç»“æœ |

---

### 1ï¸âƒ£6ï¸âƒ£ æ€»ç»“

#### æ ¸å¿ƒç‰¹æ€§
1. âœ… **çœŸæ­£å¹¶å‘**: ä½¿ç”¨`tokio::spawn`å®ç°çœŸæ­£çš„å¼‚æ­¥å¹¶å‘
2. âœ… **å¹¶å‘é™æµ**: ä¿¡å·é‡æœºåˆ¶é˜²æ­¢èµ„æºè€—å°½
3. âœ… **æ™ºèƒ½èšåˆ**: å°†å¤šä¸ªactionç»“æœèšåˆä¸ºå•ä¸ªStepResult
4. âœ… **å ä½ç¬¦æ”¯æŒ**: æ”¯æŒå¼•ç”¨å…¶ä»–actionçš„è¾“å‡º
5. âœ… **é”™è¯¯å¤„ç†**: ä»»æ„å¤±è´¥æ ‡è®°æ•´ä½“å¤±è´¥,ä½†ä¸é˜»æ­¢å…¶ä»–actionæ‰§è¡Œ
6. âœ… **åæ€å…¼å®¹**: ä¸æ­¥éª¤çº§åæ€æ— ç¼é›†æˆ
7. âœ… **å‘åå…¼å®¹**: æ—§æ ¼å¼(tool+parameters)ç»§ç»­å·¥ä½œ

#### è®¾è®¡ä¼˜åŠ¿
- **ç®€å•**: å¯¹åæ€å™¨é€æ˜,æ— éœ€ä¿®æ”¹ç°æœ‰é€»è¾‘
- **é«˜æ•ˆ**: æ˜¾è‘—ç¼©çŸ­æ‰§è¡Œæ—¶é—´(ç†è®ºåŠ é€Ÿæ¯”=actionæ•°é‡)
- **çµæ´»**: æ”¯æŒactioné—´ä¾èµ–å…³ç³»(future enhancement)
- **å¯é **: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œè¶…æ—¶æœºåˆ¶
- **å¯è§‚æµ‹**: è¯¦ç»†çš„æ—¥å¿—å’Œç»“æ„åŒ–è¾“å‡º

---

## ğŸ“‚ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒä¿®æ”¹æ–‡ä»¶
1. **proto/task_orchestrator_service.proto** - æ·»åŠ PlanActionæ¶ˆæ¯å’Œactionså­—æ®µ(åè®®å±‚æ”¯æŒ)
2. **src/core/executor.rs** - æ·»åŠ actionsæ ¼å¼æ”¯æŒ
3. **src/core/parameter_resolver.rs** - é‡æ„å ä½ç¬¦è§£æé€»è¾‘
4. **src/core/planner.rs** - æ·»åŠ æ­¥éª¤IDå¼ºåˆ¶é‡ç¼–å·
5. **config.dev.toml** - æ·»åŠ å¹¶è¡Œæ‰§è¡Œé…ç½®é¡¹
6. **src/core/parallel_executor.rs** - æ–°å¢æ–‡ä»¶(æ ¸å¿ƒå¹¶è¡Œæ‰§è¡Œé€»è¾‘)
7. **src/llm/prompts.rs** - æ›´æ–°LLMæç¤ºè¯,å¼•å¯¼ç”Ÿæˆå¹¶è¡Œæ‰§è¡Œè®¡åˆ’

### ç›¸å…³æ–‡æ¡£
8. **é¡¹ç›®å®ç°ç»†èŠ‚ç›¸å…³çš„æ–‡æ¡£/å¹¶è¡Œæ‰§è¡Œæ¶æ„è®¾è®¡æ–‡æ¡£.md** - æ–°å¢æ¶æ„è®¾è®¡æ–‡æ¡£

---

## 1ï¸âƒ£ proto/task_orchestrator_service.proto çš„ä¿®æ”¹

### ğŸ“ ä¿®æ”¹ä½ç½®: Lines 287-334

### âœ… æ–°å¢æ¶ˆæ¯å®šä¹‰å’Œå­—æ®µ

**ä¿®æ”¹åŸå› **: éœ€è¦åœ¨åè®®å±‚æ”¯æŒæ­¥éª¤å†…å¹¶è¡Œæ‰§è¡Œ,å…è®¸ä¸€ä¸ªæ­¥éª¤åŒ…å«å¤šä¸ªå¯å¹¶è¡Œçš„æ“ä½œ(actions)

**æ–°å¢å†…å®¹**:

#### æ–°å¢æ¶ˆæ¯: `PlanAction` (Lines 290-309)
```protobuf
// æ­¥éª¤ä¸­çš„å•ä¸ªæ“ä½œ(ç”¨äºæ­¥éª¤å†…å¹¶è¡Œæ‰§è¡Œ)
message PlanAction {
    // æ“ä½œID (å”¯ä¸€æ ‡è¯†,ç”¨äºä¾èµ–å¼•ç”¨)
    string action_id = 1;

    // æ“ä½œåç§°
    string name = 2;

    // å·¥å…·åç§°
    string tool = 3;

    // å·¥å…·å‚æ•°ï¼ˆJSONæ ¼å¼ï¼‰
    string parameters = 4;

    // ä¾èµ–çš„æ“ä½œIDåˆ—è¡¨ (action_idå¼•ç”¨)
    repeated string dependencies = 5;

    // æ“ä½œæè¿°/æœŸæœ›è¾“å‡º
    string description = 6;
}
```

**å­—æ®µè¯´æ˜**:
| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `action_id` | string | æ“ä½œçš„å”¯ä¸€æ ‡è¯†ç¬¦,ç”¨äºä¾èµ–å¼•ç”¨å’Œç»“æœæŸ¥æ‰¾ | `"action_1_1"`, `"action_2_3"` |
| `name` | string | æ“ä½œçš„æè¿°æ€§åç§° | `"è®¡ç®—5çš„å¹³æ–¹"`, `"æŸ¥è¯¢æ•°æ®åº“"` |
| `tool` | string | è¦è°ƒç”¨çš„å·¥å…·åç§° | `"python_interpreter"`, `"http_request"` |
| `parameters` | string | å·¥å…·å‚æ•°(JSONæ ¼å¼å­—ç¬¦ä¸²) | `"{\"code\": \"5**2\"}"` |
| `dependencies` | repeated string | ä¾èµ–çš„å…¶ä»–actionçš„IDåˆ—è¡¨(ç©ºè¡¨ç¤ºæ— ä¾èµ–) | `["action_1_1", "action_1_2"]` |
| `description` | string | æ“ä½œæè¿°æˆ–æœŸæœ›è¾“å‡ºè¯´æ˜ | `"è®¡ç®—ç»“æœåº”ä¸º25"` |

---

#### ä¿®æ”¹æ¶ˆæ¯: `PlanStep` (Lines 311-334)
```protobuf
message PlanStep {
    // æ­¥éª¤ID
    string step_id = 1;

    // æ­¥éª¤åç§°
    string name = 2;

    // ã€å…¼å®¹æ—§ç‰ˆã€‘å·¥å…·åç§° (å½“actionsä¸ºç©ºæ—¶ä½¿ç”¨)
    string tool = 3;

    // ã€å…¼å®¹æ—§ç‰ˆã€‘å·¥å…·å‚æ•°ï¼ˆJSONæ ¼å¼ï¼‰(å½“actionsä¸ºç©ºæ—¶ä½¿ç”¨)
    string parameters = 4;

    // ä¾èµ–æ­¥éª¤IDåˆ—è¡¨
    repeated string dependencies = 5;

    // æ­¥éª¤æè¿°
    string description = 6;

    // ã€æ–°å¢ã€‘æ­¥éª¤å†…çš„å¹¶è¡Œæ“ä½œåˆ—è¡¨
    // - å¦‚æœä¸ºç©º,åˆ™ä½¿ç”¨tool+parameters(å…¼å®¹æ—§ç‰ˆ)
    // - å¦‚æœåªæœ‰1ä¸ªaction,åˆ™ä¸²è¡Œæ‰§è¡Œ
    // - å¦‚æœæœ‰å¤šä¸ªactions,åˆ™å¹¶è¡Œæ‰§è¡Œ
    repeated PlanAction actions = 7;
}
```

**å…³é”®æ”¹åŠ¨**:
1. **æ–°å¢å­—æ®µ7**: `repeated PlanAction actions` - æ”¯æŒæ­¥éª¤å†…åŒ…å«å¤šä¸ªæ“ä½œ
2. **å‘åå…¼å®¹**: ä¿ç•™åŸæœ‰çš„`tool`å’Œ`parameters`å­—æ®µ,æ³¨é‡Šæ ‡æ˜ä¸ºå…¼å®¹æ—§ç‰ˆä½¿ç”¨
3. **æ‰§è¡Œé€»è¾‘**:
   - `actions`ä¸ºç©º â†’ ä½¿ç”¨`tool` + `parameters`(æ—§ç‰ˆå•æ“ä½œæ¨¡å¼)
   - `actions`æœ‰1ä¸ªå…ƒç´  â†’ ä¸²è¡Œæ‰§è¡Œè¯¥æ“ä½œ
   - `actions`æœ‰å¤šä¸ªå…ƒç´  â†’ å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰æ“ä½œ

---

### ğŸ” åè®®è®¾è®¡è¦ç‚¹

#### 1. å‘åå…¼å®¹æ€§
```protobuf
// æ—§ç‰ˆå®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ (ä¸åŒ…å«actionså­—æ®µ)
PlanStep {
    step_id: "step_1"
    tool: "python_interpreter"
    parameters: "{\"code\": \"print('hello')\"}"
    dependencies: []
}

// æ–°ç‰ˆå®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ (åŒ…å«actionså­—æ®µ)
PlanStep {
    step_id: "step_1"
    actions: [
        PlanAction {
            action_id: "action_1_1"
            tool: "python_interpreter"
            parameters: "{\"code\": \"5**2\"}"
        },
        PlanAction {
            action_id: "action_1_2"
            tool: "python_interpreter"
            parameters: "{\"code\": \"8**2\"}"
        }
    ]
}
```

#### 2. ä¸¤å±‚ä¾èµ–å…³ç³»
```
æ­¥éª¤é—´ä¾èµ– (PlanStep.dependencies):
  step_2.dependencies = ["step_1"]  â†’ step_2å¿…é¡»ç­‰step_1å®Œæˆ

æ“ä½œé—´ä¾èµ– (PlanAction.dependencies):
  action_2_3.dependencies = ["action_2_1", "action_2_2"]
  â†’ action_2_3å¿…é¡»ç­‰åŒä¸€æ­¥éª¤å†…çš„action_2_1å’Œaction_2_2å®Œæˆ
```

**ä¾èµ–å±‚çº§**:
```
æ­¥éª¤çº§: step_1 â†’ step_2 â†’ step_3
           â†“        â†“        â†“
æ“ä½œçº§: [a1,a2] [a3,a4] [a5,a6]  (æ­¥éª¤å†…å¹¶è¡Œ)
                   â†“
               a3 â†’ a4 (æ“ä½œé—´ä¾èµ–)
```

#### 3. å­—æ®µå¤ç”¨ç­–ç•¥
```rust
// æœåŠ¡ç«¯å¤„ç†é€»è¾‘ (ä¼ªä»£ç )
if !step.actions.is_empty() {
    // ä½¿ç”¨æ–°æ ¼å¼: å¹¶è¡Œæ‰§è¡Œactions
    execute_actions_parallel(step.actions)
} else {
    // ä½¿ç”¨æ—§æ ¼å¼: å•ä¸ªå·¥å…·è°ƒç”¨
    execute_single_tool(step.tool, step.parameters)
}
```

---

### ğŸ“Š åè®®å˜æ›´å½±å“

| å½±å“èŒƒå›´ | å˜æ›´ç±»å‹ | å½±å“è¯´æ˜ |
|---------|---------|---------|
| **æ—§ç‰ˆå®¢æˆ·ç«¯** | æ— å½±å“ | ç»§ç»­ä½¿ç”¨`tool` + `parameters`å­—æ®µ,æœåŠ¡ç«¯å…¼å®¹å¤„ç† |
| **æ–°ç‰ˆå®¢æˆ·ç«¯** | æ‰©å±•åŠŸèƒ½ | å¯ä½¿ç”¨`actions`å­—æ®µå®ç°æ­¥éª¤å†…å¹¶è¡Œ,å‘åå…¼å®¹æ—§æ ¼å¼ |
| **æœåŠ¡ç«¯** | éœ€è¦é€‚é… | éœ€åœ¨executorä¸­æ·»åŠ `actions`æ ¼å¼æ£€æŸ¥å’Œå¤„ç†é€»è¾‘ |
| **LLMè§„åˆ’** | å¯é€‰å‡çº§ | LLMå¯ä»¥é€‰æ‹©ç”Ÿæˆæ—§æ ¼å¼æˆ–æ–°æ ¼å¼,æœåŠ¡ç«¯å‡æ”¯æŒ |

---

### âœ… åè®®è®¾è®¡ä¼˜åŠ¿

1. **æ¸è¿›å¼å‡çº§**: æ—§ä»£ç æ— éœ€æ”¹åŠ¨å³å¯ç»§ç»­å·¥ä½œ
2. **çµæ´»æ€§**: åŒä¸€ä¸ªè®¡åˆ’å¯ä»¥æ··ç”¨æ–°æ—§æ ¼å¼(æŸäº›æ­¥éª¤ç”¨actions,æŸäº›ç”¨tool)
3. **å¯æ‰©å±•æ€§**: æœªæ¥å¯ç»§ç»­åœ¨`PlanAction`ä¸­æ·»åŠ æ–°å­—æ®µ(å¦‚è¶…æ—¶ã€é‡è¯•ç­–ç•¥ç­‰)
4. **æ¸…æ™°è¯­ä¹‰**:
   - `PlanStep.dependencies` â†’ æ­¥éª¤é—´ä¾èµ–
   - `PlanAction.dependencies` â†’ æ“ä½œé—´ä¾èµ–
   - ä¸¤å±‚ä¾èµ–å…³ç³»èŒè´£åˆ†æ˜

---

### ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

#### ç¤ºä¾‹1: ç®€å•è®¡ç®—(å•æ­¥éª¤å†…å¹¶è¡Œ)
```json
{
  "step_id": "step_1",
  "name": "å¹¶è¡Œè®¡ç®—å¹³æ–¹æ•°",
  "actions": [
    {
      "action_id": "action_1_1",
      "name": "è®¡ç®—5çš„å¹³æ–¹",
      "tool": "python_interpreter",
      "parameters": "{\"code\": \"5**2\"}",
      "dependencies": []
    },
    {
      "action_id": "action_1_2",
      "name": "è®¡ç®—8çš„å¹³æ–¹",
      "tool": "python_interpreter",
      "parameters": "{\"code\": \"8**2\"}",
      "dependencies": []
    }
  ]
}
```
**æ‰§è¡Œ**: action_1_1 å’Œ action_1_2 å¹¶è¡Œæ‰§è¡Œ

---

#### ç¤ºä¾‹2: æœ‰ä¾èµ–çš„æ“ä½œ(åŒä¸€æ­¥éª¤å†…)
```json
{
  "step_id": "step_2",
  "name": "å…ˆæŸ¥è¯¢å†å¤„ç†",
  "actions": [
    {
      "action_id": "action_2_1",
      "name": "æŸ¥è¯¢æ•°æ®åº“",
      "tool": "database_query",
      "parameters": "{\"sql\": \"SELECT * FROM users\"}",
      "dependencies": []
    },
    {
      "action_id": "action_2_2",
      "name": "å¤„ç†æŸ¥è¯¢ç»“æœ",
      "tool": "data_processor",
      "parameters": "{\"input\": \"{{action_2_1.output}}\"}",
      "dependencies": ["action_2_1"]  // ä¾èµ–åŒæ­¥éª¤å†…çš„action_2_1
    }
  ]
}
```
**æ‰§è¡Œ**: action_2_1 å…ˆæ‰§è¡Œ â†’ action_2_2 åæ‰§è¡Œ(ä¸²è¡Œ)

---

#### ç¤ºä¾‹3: æ··åˆæ–°æ—§æ ¼å¼
```json
{
  "steps": [
    {
      "step_id": "step_1",
      "tool": "http_request",         // æ—§æ ¼å¼
      "parameters": "{\"url\": \"...\"}",
      "dependencies": []
    },
    {
      "step_id": "step_2",
      "actions": [                     // æ–°æ ¼å¼
        {"action_id": "action_2_1", ...},
        {"action_id": "action_2_2", ...}
      ],
      "dependencies": ["step_1"]
    }
  ]
}
```
**æ‰§è¡Œ**:
- step_1ä½¿ç”¨æ—§æ ¼å¼æ‰§è¡Œ
- step_2ä½¿ç”¨æ–°æ ¼å¼å¹¶è¡Œæ‰§è¡Œactions

---

## 2ï¸âƒ£ src/core/executor.rs çš„ä¿®æ”¹

### ğŸ“ ä¿®æ”¹ä½ç½®: Lines 923-947

### âœ… æ–°å¢ä»£ç 

**ä¿®æ”¹åŸå› **: æ­¥éª¤çº§åæ€æ¨¡å¼ä¸‹,æ—§ä»£ç æœªæ£€æŸ¥actionsæ ¼å¼,å¯¼è‡´actionså¹¶è¡Œæ‰§è¡Œå¤±è´¥,æŠ¥é”™"å·¥å…·æœªæ‰¾åˆ°"

**æ–°å¢å†…å®¹**:
```rust
pub async fn execute_single_step_with_overrides(...) -> Result<StepResult> {
    let step = &plan.steps[step_index];

    // ğŸš€ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦ä½¿ç”¨æ–°çš„actionsæ ¼å¼
    if !step.actions.is_empty() {
        info!(
            step_id = %step.step_id,
            actions_count = step.actions.len(),
            "ğŸ”„ æ­¥éª¤åŒ…å«{}ä¸ªæ“ä½œ,å‡†å¤‡å¹¶è¡Œæ‰§è¡Œï¼ˆæ­¥éª¤çº§åæ€æ¨¡å¼ï¼‰",
            step.actions.len()
        );

        // æ„å»ºtool_map
        let tool_map: HashMap<String, ToolInfo> = available_tools
            .iter()
            .map(|t| (t.id.clone(), t.clone()))
            .collect();

        // è°ƒç”¨actionså¹¶è¡Œæ‰§è¡Œæ–¹æ³•
        return self.execute_step_with_actions(
            step,
            execution_context,
            &tool_map,
            step_index,
            plan.steps.len(),
        ).await;
    }

    // å…¼å®¹æ—§ç‰ˆ:ä½¿ç”¨tool+parametersæ ¼å¼
    // ... åŸæœ‰é€»è¾‘ä¿æŒä¸å˜
}
```

**åŠŸèƒ½è¯´æ˜**:
- åœ¨æ‰§è¡Œæ­¥éª¤å‰æ£€æŸ¥`step.actions`æ˜¯å¦éç©º
- å¦‚æœåŒ…å«actions,è°ƒç”¨`execute_step_with_actions`è¿›è¡Œå¹¶è¡Œæ‰§è¡Œ
- ç¡®ä¿æ­¥éª¤çº§åæ€æ¨¡å¼æ”¯æŒactionså¹¶è¡Œæ‰§è¡Œ
- å‘åå…¼å®¹æ—§æ ¼å¼(tool+parameters)

**å½±å“èŒƒå›´**:
- âœ… æ­¥éª¤çº§åæ€æ¨¡å¼ç°åœ¨æ”¯æŒactionså¹¶è¡Œ
- âœ… å·¥å…·æŸ¥æ‰¾æ­£ç¡®(tool_mapæ­£ç¡®æ„å»ºå¹¶ä¼ é€’)
- âœ… å ä½ç¬¦è§£ææ­£å¸¸å·¥ä½œ
- âœ… å‘åå…¼å®¹æ€§ä¿æŒ

---

## 2ï¸âƒ£ src/core/parameter_resolver.rs çš„é‡å¤§é‡æ„

### ğŸ“ ä¿®æ”¹ä½ç½®1: Lines 528-552 (æ ¸å¿ƒé‡æ„)

### â™»ï¸ é‡æ„ä»£ç : `process_parameter_value` æ–¹æ³•

**ä¿®æ”¹åŸå› **: æ—§ç‰ˆåªèƒ½å¤„ç†å•ä¸ªå ä½ç¬¦,æ— æ³•æ”¯æŒ`{{action_1_1.output}} + {{action_1_2.output}}`è¿™ç§å¤šå ä½ç¬¦è¡¨è¾¾å¼

**ä¿®æ”¹å‰(æ—§é€»è¾‘æ¨æµ‹)**:
```rust
// æ—§ç‰ˆå¯èƒ½åªå¤„ç†ç¬¬ä¸€ä¸ªå ä½ç¬¦æˆ–ä½¿ç”¨å­—ç¬¦ä¸²æ›¿æ¢
pub fn process_parameter_value(value: &str, context: &ExecutionContext) -> String {
    // ç®€å•çš„å­—ç¬¦ä¸²æ›¿æ¢,åªæ”¯æŒå•ä¸ªå ä½ç¬¦
    if value.starts_with("{{") && value.ends_with("}}") {
        let placeholder = &value[2..value.len()-2];
        return resolve_placeholder(placeholder, context);
    }
    value.to_string()
}
```

**ä¿®æ”¹å(æ–°é€»è¾‘)**:
```rust
pub fn process_parameter_value(value: &str, context: &ExecutionContext) -> String {
    // ğŸ”‘ ã€å…³é”®æ”¹è¿›ã€‘æ”¯æŒåœ¨å­—ç¬¦ä¸²ä¸­æ›¿æ¢å¤šä¸ªå ä½ç¬¦
    // ä¾‹å¦‚ï¼š{{action_2_1.output}} + {{action_2_2.output}} â†’ 89 + 208
    use regex::Regex;

    // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ‰¾åˆ°æ‰€æœ‰ {{...}} æˆ– {{{...}}} å ä½ç¬¦
    lazy_static::lazy_static! {
        static ref PLACEHOLDER_REGEX: Regex =
            Regex::new(r"\{\{\{([^}]+)\}\}\}|\{\{([^}]+)\}\}").unwrap();
    }

    let mut result = value.to_string();

    // æ›¿æ¢æ‰€æœ‰æ‰¾åˆ°çš„å ä½ç¬¦
    for cap in PLACEHOLDER_REGEX.captures_iter(value) {
        let full_match = cap.get(0).unwrap().as_str();
        let placeholder_content = cap.get(1).or_else(|| cap.get(2)).unwrap().as_str();

        // è§£æè¿™ä¸ªå•ç‹¬çš„å ä½ç¬¦
        let resolved_value = Self::resolve_single_placeholder(placeholder_content, context);

        // æ›¿æ¢åŸå§‹å ä½ç¬¦
        result = result.replace(full_match, &resolved_value);
    }

    result
}
```

**å…³é”®æ”¹è¿›ç‚¹**:
1. **ä»å•å ä½ç¬¦ â†’ å¤šå ä½ç¬¦æ”¯æŒ**: ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼`PLACEHOLDER_REGEX`æ•è·æ‰€æœ‰å ä½ç¬¦
2. **è¿­ä»£æ›¿æ¢**: ä½¿ç”¨`captures_iter`éå†æ‰€æœ‰åŒ¹é…é¡¹
3. **æ”¯æŒä¸¤ç§æ ¼å¼**:
   - åŒå¤§æ‹¬å·: `{{placeholder}}`
   - ä¸‰å¤§æ‹¬å·: `{{{placeholder}}}`
4. **ä¿æŒåŸæœ‰å­—ç¬¦ä¸²ç»“æ„**: åªæ›¿æ¢å ä½ç¬¦éƒ¨åˆ†,å…¶ä»–å†…å®¹ä¿ç•™

**ç¤ºä¾‹è½¬æ¢**:
```
è¾“å…¥: "{{action_1_1.output}} + {{action_1_2.output}}"
     â†“ PLACEHOLDER_REGEXæ‰¾åˆ°2ä¸ªå ä½ç¬¦
     â†“ action_1_1.output = "25"
     â†“ action_1_2.output = "64"
è¾“å‡º: "25 + 64"
```

---

### ğŸ“ ä¿®æ”¹ä½ç½®2: Lines 563-591 (æ–°å¢actionè¾“å‡ºå¼•ç”¨)

### âœ… æ–°å¢ä»£ç : `resolve_single_placeholder` ä¸­çš„actionå¼•ç”¨å¤„ç†

**ä¿®æ”¹åŸå› **: éœ€è¦æ”¯æŒstepså†…actionså¹¶è¡Œæ‰§è¡Œå,åç»­æ­¥éª¤å¼•ç”¨actionè¾“å‡º

**æ–°å¢å†…å®¹**:
```rust
fn resolve_single_placeholder(placeholder_content: &str, context: &ExecutionContext) -> String {
    // ğŸ”‘ ã€å…³é”®ã€‘å¤„ç† action_id.output æ ¼å¼ï¼ˆç”¨äºæ­¥éª¤å†…actionså¹¶è¡Œæ‰§è¡Œçš„ç»“æœå¼•ç”¨ï¼‰
    // ä¾‹å¦‚ï¼šaction_1_1.output â†’ è·å– action_1_1 çš„è¾“å‡º
    if placeholder_content.starts_with("action_") && placeholder_content.ends_with(".output") {
        let action_id = &placeholder_content[..placeholder_content.len() - 7]; // å»æ‰ ".output"

        debug!(
            action_id = %action_id,
            "ğŸ” æ£€æµ‹åˆ° action å¼•ç”¨æ ¼å¼"
        );

        // ä»ä¸Šä¸‹æ–‡ä¸­è·å– action çš„è¾“å‡º
        // action çš„ç»“æœå­˜å‚¨æ—¶ä½¿ç”¨ action_id ä½œä¸º step_id
        if let Some(action_output) = context.get_step_output(action_id) {
            info!(
                placeholder = %placeholder_content,
                action_id = %action_id,
                "âœ… æˆåŠŸè§£æ action è¾“å‡ºå¼•ç”¨"
            );
            return action_output;
        } else {
            warn!(
                action_id = %action_id,
                placeholder = %placeholder_content,
                "âš ï¸  å¼•ç”¨çš„ action è¾“å‡ºä¸å­˜åœ¨"
            );
            return placeholder_content.to_string();
        }
    }

    // åç»­æ˜¯åŸæœ‰çš„å…¶ä»–å ä½ç¬¦è§£æé€»è¾‘...
}
```

**åŠŸèƒ½è¯´æ˜**:
- æ£€æµ‹`action_xxx.output`æ ¼å¼çš„å ä½ç¬¦
- ä»`ExecutionContext`ä¸­æŸ¥æ‰¾å¯¹åº”actionçš„è¾“å‡º
- actionè¾“å‡ºå­˜å‚¨é”®ä¸º`action_id`(ä¾‹å¦‚`action_1_1`)
- æ—¥å¿—è®°å½•è§£æè¿‡ç¨‹å’Œç»“æœ

**æ”¯æŒçš„å ä½ç¬¦æ ¼å¼æ€»è§ˆ**(ä¿®æ”¹å):
| æ ¼å¼ | ç¤ºä¾‹ | ç”¨é€” |
|------|------|------|
| `{{action_id.output}}` | `{{action_1_1.output}}` | å¼•ç”¨æ­¥éª¤å†…actionçš„è¾“å‡º(æ–°å¢) |
| `{{step_id.outputs.field}}` | `{{step_2.outputs.datasource}}` | ä»æ­¥éª¤è¾“å‡ºJSONæå–å­—æ®µ |
| `{{step_id.output.field}}` | `{{step_2.output.datasource}}` | åŒä¸Š(å…¼å®¹æ ¼å¼) |
| `{{{placeholder}}}` | `{{{step_1.output}}}` | Handlebarsé£æ ¼ä¸‰é‡å¤§æ‹¬å· |
| `{{metadata_key}}` | `{{project_id}}` | ä»metadataæŸ¥æ‰¾ |

---

## 3ï¸âƒ£ src/core/planner.rs çš„ä¿®æ”¹

### ğŸ“ ä¿®æ”¹ä½ç½®: Lines 1076-1224 (`parse_plan_from_llm_response`æ–¹æ³•)

### âœ… æ–°å¢åŠŸèƒ½: æ­¥éª¤IDå¼ºåˆ¶é‡ç¼–å·

**ä¿®æ”¹åŸå› **: LLMé‡æ–°è§„åˆ’æ—¶,ç”Ÿæˆçš„step_idå¯èƒ½ä»step_4ã€step_5å¼€å§‹,è€Œä¸æ˜¯ä»step_1å¼€å§‹,å¯¼è‡´ä¾èµ–å…³ç³»æ··ä¹±

**æ–°å¢é€»è¾‘**:
```rust
// 1. å»ºç«‹æ˜ å°„è¡¨: LLMçš„step_id â†’ æ–°çš„step_id
let mut llm_to_new_id_map: HashMap<String, String> = HashMap::new();

for (idx, step_value) in steps_array.iter().enumerate() {
    let llm_step_id = step_value.get("step_id")
        .and_then(|v| v.as_str())
        .unwrap_or(&format!("default_step_{}", idx + 1))
        .to_string();

    let new_step_id = format!("step_{}", idx + 1);  // ğŸ”‘ å¼ºåˆ¶ä»1å¼€å§‹
    llm_to_new_id_map.insert(llm_step_id, new_step_id);
}

// 2. é‡æ˜ å°„ä¾èµ–å…³ç³»
let deps: Vec<String> = deps_array
    .iter()
    .filter_map(|v| v.as_str())
    .map(|llm_dep_id| {
        // ğŸ”‘ ä½¿ç”¨æ˜ å°„è¡¨è½¬æ¢ä¾èµ–ID
        llm_to_new_id_map.get(llm_dep_id).cloned().unwrap_or_else(|| {
            warn!("âš ï¸  LLMè¿”å›çš„ä¾èµ–step_idä¸åœ¨æ˜ å°„è¡¨ä¸­: {}", llm_dep_id);
            llm_dep_id.to_string()
        })
    })
    .collect();
```

**ç¤ºä¾‹è½¬æ¢**:
```
LLMè¾“å‡º:              é‡ç¼–å·å:
step_4 (deps=[])  â†’  step_1 (deps=[])
step_5 (deps=[4]) â†’  step_2 (deps=[1])
step_6 (deps=[5]) â†’  step_3 (deps=[2])
```

**åŠŸèƒ½è¯´æ˜**:
1. **å»ºç«‹æ˜ å°„è¡¨**: éå†æ‰€æœ‰æ­¥éª¤,ä¸ºæ¯ä¸ªLLMç”Ÿæˆçš„step_idåˆ†é…æ–°ID(ä»1å¼€å§‹)
2. **é‡æ˜ å°„step_id**: å°†æ­¥éª¤æœ¬èº«çš„IDæ›¿æ¢ä¸ºæ–°ID
3. **é‡æ˜ å°„ä¾èµ–**: å°†dependenciesæ•°ç»„ä¸­çš„IDä¹Ÿæ›¿æ¢ä¸ºæ–°ID
4. **ä¿æŒæ‹“æ‰‘é¡ºåº**: é‡ç¼–å·ä¸æ”¹å˜æ­¥éª¤é—´çš„ä¾èµ–å…³ç³»

**å½±å“èŒƒå›´**:
- âœ… è§£å†³é‡æ–°è§„åˆ’åstep_idä¸ä»1å¼€å§‹çš„é—®é¢˜
- âœ… ç¡®ä¿ä¾èµ–å…³ç³»æ­£ç¡®æ˜ å°„
- âœ… æ—¥å¿—æ¸…æ™°,ä¾¿äºè°ƒè¯•

---

## 4ï¸âƒ£ config.dev.toml çš„é…ç½®æ–°å¢

### ğŸ“ ä¿®æ”¹ä½ç½®: Lines 106-140

### âœ… æ–°å¢é…ç½®é¡¹

**æ–°å¢å†…å®¹**:
```toml
# ==================== å¹¶è¡Œæ‰§è¡Œé…ç½® ====================
# æ˜¯å¦å¯ç”¨å¹¶è¡Œæ‰§è¡Œ
# - true: è‡ªåŠ¨æ£€æµ‹æ— ä¾èµ–æ­¥éª¤å¹¶å¹¶è¡Œæ‰§è¡Œï¼ˆæ¨èï¼‰
# - false: å¼ºåˆ¶ä¸²è¡Œæ‰§è¡Œï¼ˆå‘åå…¼å®¹æ¨¡å¼ï¼‰
# ã€ç”Ÿäº§çº§ç‰¹æ€§ã€‘æ”¯æŒåŠ¨æ€å¼€å¯/å…³é—­ï¼Œå¯ç”¨äºç´§æ€¥å›æ»š
enable_parallel_execution = true

# å¹¶è¡Œæ‰§è¡Œçš„æœ€å¤§å¹¶å‘æ•°
# æ§åˆ¶åŒæ—¶æ‰§è¡Œçš„æœ€å¤§æ­¥éª¤æ•°é‡ï¼Œé¿å…èµ„æºè€—å°½
# å»ºè®®å€¼ï¼š
# - IOå¯†é›†å‹ä»»åŠ¡: CPUæ ¸å¿ƒæ•° * 2~4
# - CPUå¯†é›†å‹ä»»åŠ¡: CPUæ ¸å¿ƒæ•°
# - æ··åˆå‹ä»»åŠ¡: CPUæ ¸å¿ƒæ•° * 2
# é»˜è®¤å€¼: 8ï¼ˆé€‚åˆ4æ ¸CPUçš„IOå¯†é›†å‹ä»»åŠ¡ï¼‰
parallel_max_concurrent = 8

# å¹¶è¡Œæ‰§è¡Œçš„æœ€å°æ­¥éª¤æ•°é˜ˆå€¼
# åªæœ‰å½“è®¡åˆ’æ­¥éª¤æ•°é‡ >= æ­¤é˜ˆå€¼æ—¶ï¼Œæ‰ä¼šå¯ç”¨å¹¶è¡Œæ‰§è¡Œ
# å¯¹äºæ­¥éª¤æ•°è¾ƒå°‘çš„ç®€å•ä»»åŠ¡ï¼Œä¸²è¡Œæ‰§è¡Œå¼€é”€æ›´å°
# é»˜è®¤å€¼: 2
parallel_min_steps = 1


[reflection]
# æ˜¯å¦å¯ç”¨æ­¥éª¤çº§åæ€
enable_step_level_reflection = true

# æœ€å¤§è¿ç»­å¤±è´¥æ¬¡æ•°ï¼ˆå•ä¸ªæ­¥éª¤å¤±è´¥å¤šå°‘æ¬¡ååœæ­¢ä»»åŠ¡ï¼‰
# é»˜è®¤å€¼: 3
max_consecutive_failures = 3

# æœ€å¤§é‡æ–°è§„åˆ’æ¬¡æ•°ï¼ˆæ•´ä¸ªä»»åŠ¡æœ€å¤šé‡æ–°è§„åˆ’å¤šå°‘æ¬¡ï¼‰
# é»˜è®¤å€¼: 3
max_replanning_attempts = 3
```

**é…ç½®è¯´æ˜**:

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `enable_parallel_execution` | bool | true | æ˜¯å¦å¯ç”¨å¹¶è¡Œæ‰§è¡Œ |
| `parallel_max_concurrent` | usize | 8 | æœ€å¤§å¹¶å‘ä»»åŠ¡æ•° |
| `parallel_min_steps` | usize | 1 | å¯ç”¨å¹¶è¡Œçš„æœ€å°æ­¥éª¤æ•° |
| `enable_step_level_reflection` | bool | true | æ˜¯å¦å¯ç”¨æ­¥éª¤çº§åæ€ |
| `max_consecutive_failures` | usize | 3 | å•æ­¥éª¤æœ€å¤§å¤±è´¥æ¬¡æ•° |
| `max_replanning_attempts` | usize | 3 | æœ€å¤§é‡æ–°è§„åˆ’æ¬¡æ•° |

**å…³é”®æ”¹è¿›**:
- âœ… **enable_step_level_reflectionä¸å†å½±å“å¹¶è¡Œæ‰§è¡Œ**: ä¸¤ä¸ªç‰¹æ€§å®Œå…¨ç‹¬ç«‹
- âœ… **å¯åŠ¨æ€è°ƒæ•´**: ä¿®æ”¹é…ç½®åé‡å¯æœåŠ¡å³å¯ç”Ÿæ•ˆ
- âœ… **æ€§èƒ½è°ƒä¼˜**: æ ¹æ®ä»»åŠ¡ç±»å‹è°ƒæ•´`parallel_max_concurrent`

---

## 5ï¸âƒ£ src/core/parallel_executor.rs (æ–°å¢æ–‡ä»¶)

### ğŸ“ æ–‡ä»¶åˆ›å»º

**ä¿®æ”¹ç±»å‹**: **æ–°å¢å®Œæ•´æ–‡ä»¶** (çº¦900è¡Œä»£ç )

**æ–‡ä»¶èŒè´£**: å®ç°åŸºäºDAGçš„æ­¥éª¤é—´å¹¶è¡Œæ‰§è¡Œ

### âœ… æ–°å¢çš„æ ¸å¿ƒç»“æ„ä½“

#### 1. DependencyGraph (Lines 58-296)
```rust
pub struct DependencyGraph {
    /// æ‰€æœ‰èŠ‚ç‚¹çš„æ˜ å°„è¡¨: step_id -> ExecutionNode
    pub nodes: HashMap<String, ExecutionNode>,

    /// æ‰§è¡Œæ‰¹æ¬¡é¡ºåº: Vec<æ‰¹æ¬¡> where æ‰¹æ¬¡ = Vec<step_id>
    /// åŒä¸€æ‰¹æ¬¡å†…çš„æ­¥éª¤å¯ä»¥å¹¶è¡Œæ‰§è¡Œ
    pub execution_order: Vec<Vec<String>>,

    /// æ€»æ‰¹æ¬¡æ•°
    pub total_batches: usize,
}
```

**åŠŸèƒ½**: ç®¡ç†æ­¥éª¤é—´çš„ä¾èµ–å…³ç³»,è®¡ç®—æ‰§è¡Œæ‰¹æ¬¡

**æ ¸å¿ƒæ–¹æ³•**:
- `from_execution_plan`: ä»æ‰§è¡Œè®¡åˆ’æ„å»ºDAG
- `compute_execution_batches`: ä½¿ç”¨Kahnç®—æ³•è®¡ç®—æ‰§è¡Œæ‰¹æ¬¡
- `update_node_state`: æ›´æ–°èŠ‚ç‚¹çŠ¶æ€(çº¿ç¨‹å®‰å…¨)
- `get_batch`: è·å–æŒ‡å®šæ‰¹æ¬¡çš„èŠ‚ç‚¹

#### 2. ExecutionNode (Lines 43-56)
```rust
pub struct ExecutionNode {
    /// è®¡åˆ’æ­¥éª¤
    pub step: PlanStep,

    /// ä¾èµ–çš„æ­¥éª¤IDåˆ—è¡¨ (å‰é©±èŠ‚ç‚¹)
    pub dependencies: Vec<String>,

    /// è¢«ä¾èµ–çš„æ­¥éª¤IDåˆ—è¡¨ (åç»§èŠ‚ç‚¹)
    pub dependents: Vec<String>,

    /// èŠ‚ç‚¹æ‰§è¡ŒçŠ¶æ€ (çº¿ç¨‹å®‰å…¨)
    pub state: Arc<RwLock<NodeState>>,
}
```

**åŠŸèƒ½**: è¡¨ç¤ºDAGä¸­çš„å•ä¸ªèŠ‚ç‚¹,åŒ…å«æ­¥éª¤ä¿¡æ¯å’ŒçŠ¶æ€

#### 3. NodeState (æšä¸¾)
```rust
pub enum NodeState {
    /// ç­‰å¾…ä¾èµ–
    Pending,
    /// å°±ç»ª
    Ready,
    /// æ­£åœ¨æ‰§è¡Œ
    Running,
    /// æ‰§è¡ŒæˆåŠŸ
    Success { output: String },
    /// æ‰§è¡Œå¤±è´¥
    Failed { error: String },
    /// è·³è¿‡æ‰§è¡Œ
    Skipped,
}
```

**çŠ¶æ€è½¬æ¢**:
```
Pending â†’ Ready â†’ Running â†’ Success
                         â””â†’ Failed
                         â””â†’ Skipped (ä¾èµ–å¤±è´¥)
```

#### 4. ParallelExecutor (Lines 298-691)
```rust
pub struct ParallelExecutor {
    /// Tool Service å®¢æˆ·ç«¯
    tool_client: Arc<UnifiedToolServiceClient>,

    /// Kafka æ—¥å¿—è®°å½•å™¨
    kafka_logger: Arc<KafkaLogger>,

    /// æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°
    max_concurrent_tasks: usize,

    /// å•æ­¥éª¤æ‰§è¡Œè¶…æ—¶æ—¶é—´
    execution_timeout: Duration,

    /// å¹¶å‘æ§åˆ¶ä¿¡å·é‡
    semaphore: Arc<Semaphore>,
}
```

**åŠŸèƒ½**: å®é™…æ‰§è¡Œå¹¶è¡Œä»»åŠ¡çš„æ‰§è¡Œå™¨

**æ ¸å¿ƒæ–¹æ³•**:
- `execute_plan_parallel`: å¹¶è¡Œæ‰§è¡Œæ•´ä¸ªè®¡åˆ’
- `execute_batch_parallel`: æ‰¹æ¬¡å†…å¹¶è¡Œæ‰§è¡Œ
- `execute_single_step`: æ‰§è¡Œå•ä¸ªæ­¥éª¤

---

### âœ… å…³é”®ç®—æ³•å®ç°: Kahnæ‹“æ‰‘æ’åº

**ä½ç½®**: `compute_execution_batches` (Lines 150-230)

```rust
fn compute_execution_batches(
    nodes: &HashMap<String, ExecutionNode>
) -> Result<Vec<Vec<String>>> {
    // 1. è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„å…¥åº¦
    let mut in_degree: HashMap<String, usize> = HashMap::new();
    for (step_id, node) in nodes {
        in_degree.insert(step_id.clone(), node.dependencies.len());
    }

    let mut batches = Vec::new();
    let mut processed = HashSet::new();

    // 2. å¾ªç¯ç›´åˆ°æ‰€æœ‰èŠ‚ç‚¹éƒ½å¤„ç†å®Œ
    while processed.len() < nodes.len() {
        // 3. æ‰¾å‡ºæ‰€æœ‰å…¥åº¦ä¸º0çš„èŠ‚ç‚¹ â†’ å½“å‰æ‰¹æ¬¡
        let current_batch: Vec<String> = in_degree
            .iter()
            .filter(|(step_id, &degree)| degree == 0 && !processed.contains(*step_id))
            .map(|(step_id, _)| step_id.clone())
            .collect();

        // 4. å¦‚æœæ²¡æœ‰å…¥åº¦ä¸º0çš„èŠ‚ç‚¹ â†’ å­˜åœ¨ç¯
        if current_batch.is_empty() {
            return Err(anyhow!("âŒ æ£€æµ‹åˆ°ä¾èµ–ç¯ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ"));
        }

        // 5. è®°å½•å½“å‰æ‰¹æ¬¡
        batches.push(current_batch.clone());

        // 6. å°†å½“å‰æ‰¹æ¬¡çš„èŠ‚ç‚¹ä»å›¾ä¸­ç§»é™¤
        for step_id in &current_batch {
            processed.insert(step_id.clone());

            // æ›´æ–°åç»­èŠ‚ç‚¹çš„å…¥åº¦
            if let Some(node) = nodes.get(step_id) {
                for dependent_id in &node.dependents {
                    if let Some(degree) = in_degree.get_mut(dependent_id) {
                        *degree -= 1;
                    }
                }
            }
        }
    }

    Ok(batches)
}
```

**ç®—æ³•å¤æ‚åº¦**: O(V + E), V=èŠ‚ç‚¹æ•°, E=è¾¹æ•°

**ç¤ºä¾‹**:
```
è¾“å…¥:
  step_1: dependencies=[]
  step_2: dependencies=["step_1"]
  step_3: dependencies=["step_1"]
  step_4: dependencies=["step_2", "step_3"]

è¾“å‡º:
  Batch 1: [step_1]
  Batch 2: [step_2, step_3]  â† å¯å¹¶è¡Œ
  Batch 3: [step_4]
```

---

### âœ… å¹¶å‘æ§åˆ¶: ä¿¡å·é‡æœºåˆ¶

**ä½ç½®**: `execute_batch_parallel` (Lines 450-571)

```rust
async fn execute_batch_parallel(...) -> Result<Vec<StepResult>> {
    let tasks = batch.iter().map(|node| {
        let node_clone = node.clone();
        let semaphore = self.semaphore.clone();

        tokio::spawn(async move {
            // ğŸ”’ è·å–ä¿¡å·é‡è®¸å¯
            let _permit = semaphore.acquire().await.unwrap();

            // æ›´æ–°çŠ¶æ€: Pending â†’ Running
            dag.update_node_state(&node_clone.step.step_id, NodeState::Running).await;

            // æ‰§è¡Œæ­¥éª¤
            let result = self.execute_single_step(&node_clone.step, ...).await;

            // æ›´æ–°çŠ¶æ€: Running â†’ Success/Failed
            match &result {
                Ok(step_result) => {
                    if step_result.is_success {
                        dag.update_node_state(
                            &node_clone.step.step_id,
                            NodeState::Success { output: step_result.output.clone() }
                        ).await;
                    } else {
                        dag.update_node_state(
                            &node_clone.step.step_id,
                            NodeState::Failed { error: step_result.error_message.clone().unwrap_or_default() }
                        ).await;
                    }
                }
                Err(e) => {
                    dag.update_node_state(
                        &node_clone.step.step_id,
                        NodeState::Failed { error: e.to_string() }
                    ).await;
                }
            }

            result
        })
    }).collect::<Vec<_>>();

    // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    let results = join_all(tasks).await;

    // æŒ‰åŸå§‹é¡ºåºé‡æ–°æ’åˆ—ç»“æœ
    reorder_results(results, batch)
}
```

**å…³é”®æœºåˆ¶**:
1. **ä¿¡å·é‡é™æµ**: `semaphore.acquire()`ç¡®ä¿æœ€å¤šåŒæ—¶æ‰§è¡Œ`parallel_max_concurrent`ä¸ªä»»åŠ¡
2. **å¼‚æ­¥å¹¶å‘**: ä½¿ç”¨`tokio::spawn`åˆ›å»ºç‹¬ç«‹ä»»åŠ¡
3. **çŠ¶æ€ç®¡ç†**: å®æ—¶æ›´æ–°DAGèŠ‚ç‚¹çŠ¶æ€
4. **ç»“æœæ”¶é›†**: `join_all`ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
5. **é¡ºåºä¿æŒ**: æŒ‰åŸå§‹æ‰¹æ¬¡é¡ºåºé‡æ–°æ’åˆ—ç»“æœ

---

## 5ï¸âƒ£ src/llm/prompts.rs çš„ä¿®æ”¹

### ğŸ“ ä¿®æ”¹ä½ç½®: PLANNING_SYSTEM_PROMPT å’Œ PLANNING_USER_TEMPLATE

### âœ… æ–°å¢å†…å®¹

**ä¿®æ”¹åŸå› **: éœ€è¦å¼•å¯¼LLMç”Ÿæˆæ”¯æŒå¹¶è¡Œæ‰§è¡Œçš„è®¡åˆ’,åŒ…æ‹¬åˆç†è®¾ç½®dependencieså’Œä½¿ç”¨actionsæ ¼å¼

**æ€»æ”¹åŠ¨**: çº¦200è¡Œ(æ–°å¢æç¤ºè¯è¯´æ˜å’Œç¤ºä¾‹,åŒ…æ‹¬é‡æ–°è§„åˆ’æç¤ºè¯)

---

### æ–°å¢æç¤ºè¯æ®µè½1: å¹¶è¡Œæ‰§è¡Œè§„åˆ’æŒ‡å¯¼ (Lines 235-241)

**æ–°å¢å†…å®¹**:
```markdown
ã€âš ï¸ å¹¶è¡Œæ‰§è¡Œè§„åˆ’ - é‡è¦ã€‘
ç³»ç»Ÿæ”¯æŒåŸºäºDAGçš„å¹¶è¡Œæ‰§è¡Œï¼Œè¯·åˆç†åˆ©ç”¨dependencieså­—æ®µå®ç°å¹¶è¡Œä¼˜åŒ–ï¼š
âœ“ **æ— ä¾èµ–æ­¥éª¤å¯å¹¶è¡Œ**: å¦‚æœå¤šä¸ªæ­¥éª¤ä¹‹é—´æ— æ•°æ®ä¾èµ–ï¼Œå°†dependenciesè®¾ä¸º[]ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¹¶è¡Œæ‰§è¡Œ
âœ“ **æ˜ç¡®ä¾èµ–å…³ç³»**: å¦‚æœstep_3éœ€è¦step_1å’Œstep_2çš„è¾“å‡ºï¼Œè®¾ç½®"dependencies": ["step_1", "step_2"]
âœ“ **ä¼˜åŒ–æ‰§è¡Œæ•ˆç‡**: ä¼˜å…ˆå°†ç‹¬ç«‹ä»»åŠ¡è®¾è®¡ä¸ºå¹¶è¡Œæ‰§è¡Œï¼Œå‡å°‘æ€»æ‰§è¡Œæ—¶é—´
âœ— **é¿å…è¿‡åº¦ä¾èµ–**: ä¸è¦æ·»åŠ ä¸å¿…è¦çš„ä¾èµ–å…³ç³»ï¼Œä»¥å…é™ä½å¹¶è¡Œåº¦
```

**ç›®çš„**:
- å‘ŠçŸ¥LLMç³»ç»Ÿæ”¯æŒå¹¶è¡Œæ‰§è¡Œ
- å¼•å¯¼LLMæ­£ç¡®è®¾ç½®dependencieså­—æ®µ
- å¼ºè°ƒå‡å°‘ä¸å¿…è¦ä¾èµ–ä»¥æé«˜å¹¶è¡Œåº¦

---

### æ–°å¢æç¤ºè¯æ®µè½2: Actionsæ ¼å¼è¯´æ˜ (Lines 243-280)

**æ–°å¢å†…å®¹**:
```markdown
ã€ğŸš€ æ­¥éª¤å†…å¹¶è¡Œæ‰§è¡Œ - Actionsæ ¼å¼ã€‘
**æ–°ç‰¹æ€§**: æ”¯æŒåœ¨å•ä¸ªæ­¥éª¤å†…å¹¶è¡Œæ‰§è¡Œå¤šä¸ªæ“ä½œ
âœ“ **ä½•æ—¶ä½¿ç”¨actionsæ ¼å¼**: å½“ä¸€ä¸ªæ­¥éª¤éœ€è¦æ‰§è¡Œå¤šä¸ªç›¸äº’ç‹¬ç«‹çš„æ“ä½œæ—¶
âœ“ **å…¼å®¹æ€§**: å¦‚æœæ­¥éª¤åªæœ‰å•ä¸ªæ“ä½œï¼Œç»§ç»­ä½¿ç”¨æ—§æ ¼å¼(tool + parameters)
âœ“ **ä¾èµ–å¼•ç”¨**: åç»­æ­¥éª¤å¯é€šè¿‡{{action_id.output}}å¼•ç”¨actionçš„è¾“å‡º

Actionsæ ¼å¼ç¤ºä¾‹ï¼š
{
  "step_id": "step_1",
  "step_name": "å¹¶è¡Œè®¡ç®—ä¸‰ä¸ªæ•°çš„å¹³æ–¹",
  "actions": [
    {
      "action_id": "action_1_1",
      "name": "è®¡ç®—5çš„å¹³æ–¹",
      "tool_id": "js_engine",
      "parameters": {"code": "5**2"},
      "dependencies": [],
      "expected_output": "25"
    },
    {
      "action_id": "action_1_2",
      "name": "è®¡ç®—8çš„å¹³æ–¹",
      "tool_id": "js_engine",
      "parameters": {"code": "8**2"},
      "dependencies": [],
      "expected_output": "64"
    },
    {
      "action_id": "action_1_3",
      "name": "è®¡ç®—12çš„å¹³æ–¹",
      "tool_id": "js_engine",
      "parameters": {"code": "12**2"},
      "dependencies": [],
      "expected_output": "144"
    }
  ],
  "dependencies": []
}
```

**ç›®çš„**:
- æ•™ä¼šLLMä½•æ—¶ä½¿ç”¨actionsæ ¼å¼
- æä¾›å®Œæ•´çš„actionsæ ¼å¼ç¤ºä¾‹
- è¯´æ˜å‘åå…¼å®¹æ€§

---

### æ–°å¢æç¤ºè¯æ®µè½3: Actionè¾“å‡ºå¼•ç”¨ç¤ºä¾‹ (Lines 282-297)

**æ–°å¢å†…å®¹**:
```markdown
åç»­æ­¥éª¤å¼•ç”¨actionè¾“å‡ºç¤ºä¾‹ï¼š
{
  "step_id": "step_2",
  "step_name": "è®¡ç®—å‰ä¸¤ä¸ªç»“æœçš„å’Œ",
  "tool_id": "js_engine",
  "parameters": {
    "code": "{{action_1_1.output}} + {{action_1_2.output}}"
  },
  "dependencies": ["step_1"]
}

ç¤ºä¾‹å¹¶è¡Œåœºæ™¯ï¼š
- å¤šä¸ªç‹¬ç«‹è®¡ç®—(åŠ æ³•ã€ä¹˜æ³•) â†’ dependencieså‡ä¸º[]ï¼Œå¯å¹¶è¡Œ
- æ•°æ®æ”¶é›†+æ•°æ®éªŒè¯ â†’ å¯å¹¶è¡Œæ‰§è¡Œï¼Œdependencieså‡ä¸º[]
- ç»“æœæ±‡æ€» â†’ ä¾èµ–å‰é¢æ‰€æœ‰æ­¥éª¤ï¼Œdependencies: ["step_1", "step_2", ...]
```

**ç›®çš„**:
- æ¼”ç¤ºå¦‚ä½•å¼•ç”¨actionè¾“å‡º(`{{action_id.output}}`)
- æä¾›å…¸å‹å¹¶è¡Œåœºæ™¯ç¤ºä¾‹
- æ˜ç¡®dependenciesçš„è®¾ç½®è§„åˆ™

---

### æ›´æ–°ç¤ºä¾‹: å¹¶è¡Œæ‰§è¡Œè®¡åˆ’ç¤ºä¾‹ (Lines 369-412)

**ä¿®æ”¹å†…å®¹**: å°†åŸæœ‰çš„å•æ­¥éª¤ç¤ºä¾‹æ›¿æ¢ä¸ºå¹¶è¡Œæ‰§è¡Œç¤ºä¾‹

**æ–°ç¤ºä¾‹**:
```json
{
  "plan_id": "plan_001",
  "description": "å¹¶è¡Œè®¡ç®—å¤šä¸ªæ•°æ®æºçš„ç»Ÿè®¡ä¿¡æ¯",
  "task_type": "æ•°æ®åˆ†æ",
  "context_understanding": "éœ€è¦ä»å¤šä¸ªæ•°æ®æºè·å–ç»Ÿè®¡ä¿¡æ¯,æ•°æ®æºä¹‹é—´æ— ä¾èµ–,å¯å¹¶è¡Œæ‰§è¡Œ",
  "total_steps": 3,
  "estimated_duration_secs": 45,
  "steps": [
    {
      "step_id": "step_1",
      "step_name": "å¹¶è¡Œè®¡ç®—å¹³æ–¹æ•°",
      "actions": [
        {
          "action_id": "action_1_1",
          "name": "è®¡ç®—5çš„å¹³æ–¹",
          "tool_id": "js_engine",
          "parameters": {"code": "5**2"},
          "dependencies": [],
          "expected_output": "25"
        },
        {
          "action_id": "action_1_2",
          "name": "è®¡ç®—8çš„å¹³æ–¹",
          "tool_id": "js_engine",
          "parameters": {"code": "8**2"},
          "dependencies": [],
          "expected_output": "64"
        }
      ],
      "dependencies": [],
      "expected_output": "ä¸¤ä¸ªå¹³æ–¹æ•°çš„ç»“æœ",
      "data_input_source": "ä»»åŠ¡æè¿°",
      "data_output_usage": "ä¾›æ­¥éª¤2ä½¿ç”¨"
    },
    {
      "step_id": "step_2",
      "step_name": "è®¡ç®—ä¸¤æ•°ä¹‹å’Œ",
      "tool_id": "js_engine",
      "parameters": {
        "code": "{{action_1_1.output}} + {{action_1_2.output}}"
      },
      "dependencies": ["step_1"],
      "expected_output": "ä¸¤æ•°ä¹‹å’Œ(89)",
      "data_input_source": "æ­¥éª¤1çš„actionè¾“å‡º",
      "data_output_usage": "æœ€ç»ˆç»“æœ"
    }
  ]
}
```

**æ”¹è¿›ç‚¹**:
- âœ… å±•ç¤ºäº†actionsæ ¼å¼çš„ä½¿ç”¨
- âœ… å±•ç¤ºäº†actionè¾“å‡ºå¼•ç”¨(`{{action_1_1.output}}`)
- âœ… å±•ç¤ºäº†dependenciesçš„æ­£ç¡®è®¾ç½®
- âœ… æä¾›äº†å®Œæ•´çš„ç«¯åˆ°ç«¯ç¤ºä¾‹

---

### å…³é”®æ”¹è¿›æ€»ç»“

| æ”¹è¿›é¡¹ | ä¿®æ”¹å‰ | ä¿®æ”¹å | å½±å“ |
|--------|--------|--------|------|
| **å¹¶è¡Œæ‰§è¡Œæ„è¯†** | æœªæåŠå¹¶è¡Œæ‰§è¡Œ | æ˜ç¡®è¯´æ˜ç³»ç»Ÿæ”¯æŒå¹¶è¡Œæ‰§è¡Œ | LLMä¼šä¸»åŠ¨ä¼˜åŒ–å¹¶è¡Œåº¦ |
| **Dependenciesè®¾ç½®** | æ— æ˜ç¡®æŒ‡å¯¼ | è¯¦ç»†è¯´æ˜ä½•æ—¶è®¾ç½®dependencies | å‡å°‘ä¸å¿…è¦ä¾èµ– |
| **Actionsæ ¼å¼** | ä¸å­˜åœ¨ | æ–°å¢actionsæ ¼å¼è¯´æ˜å’Œç¤ºä¾‹ | LLMå¯ç”Ÿæˆæ­¥éª¤å†…å¹¶è¡Œè®¡åˆ’ |
| **å ä½ç¬¦å¼•ç”¨** | ä»…æœ‰stepå¼•ç”¨ | æ–°å¢actionå¼•ç”¨è¯­æ³• | æ”¯æŒå¼•ç”¨actionè¾“å‡º |
| **ç¤ºä¾‹è´¨é‡** | ç®€å•å•æ­¥ç¤ºä¾‹ | å®Œæ•´å¹¶è¡Œæ‰§è¡Œç¤ºä¾‹ | LLMæ›´å¥½ç†è§£å¹¶è¡Œåœºæ™¯ |

---

### æç¤ºè¯è®¾è®¡åŸåˆ™

#### 1. **æ¸è¿›å¼å¼•å¯¼**
```
åŸºç¡€æ¦‚å¿µ â†’ æ ¼å¼è¯´æ˜ â†’ ç¤ºä¾‹æ¼”ç¤º â†’ ä½¿ç”¨åœºæ™¯
```

#### 2. **æ­£åå¯¹æ¯”**
```
âœ“ æ¨èåšæ³•: æ— ä¾èµ–æ­¥éª¤è®¾ç½®dependencies=[]
âœ— é¿å…åšæ³•: ä¸è¦æ·»åŠ ä¸å¿…è¦çš„ä¾èµ–å…³ç³»
```

#### 3. **å®Œæ•´ç¤ºä¾‹**
æä¾›å®Œæ•´çš„JSONç¤ºä¾‹,åŒ…æ‹¬:
- Actionsæ ¼å¼çš„å®Œæ•´ç»“æ„
- Actionè¾“å‡ºå¼•ç”¨è¯­æ³•
- Dependenciesçš„æ­£ç¡®è®¾ç½®
- ç«¯åˆ°ç«¯çš„å¹¶è¡Œæ‰§è¡Œåœºæ™¯

#### 4. **å‘åå…¼å®¹å¼ºè°ƒ**
```
âœ“ **å…¼å®¹æ€§**: å¦‚æœæ­¥éª¤åªæœ‰å•ä¸ªæ“ä½œï¼Œç»§ç»­ä½¿ç”¨æ—§æ ¼å¼(tool + parameters)
```

---

### é¢„æœŸæ•ˆæœ

é€šè¿‡è¿™äº›æç¤ºè¯æ”¹è¿›,LLMå°†èƒ½å¤Ÿ:

1. âœ… **è¯†åˆ«å¹¶è¡Œæœºä¼š**: è‡ªåŠ¨è¯†åˆ«ä»»åŠ¡ä¸­çš„å¹¶è¡Œæ‰§è¡Œæœºä¼š
2. âœ… **æ­£ç¡®è®¾ç½®ä¾èµ–**: åªåœ¨å¿…è¦æ—¶æ·»åŠ dependencies
3. âœ… **ä½¿ç”¨actionsæ ¼å¼**: åœ¨åˆé€‚åœºæ™¯ä½¿ç”¨actionså®ç°æ­¥éª¤å†…å¹¶è¡Œ
4. âœ… **å¼•ç”¨actionè¾“å‡º**: æ­£ç¡®ä½¿ç”¨`{{action_id.output}}`è¯­æ³•
5. âœ… **ä¼˜åŒ–æ‰§è¡Œæ•ˆç‡**: ç”Ÿæˆçš„è®¡åˆ’å…·æœ‰æ›´é«˜çš„å¹¶è¡Œåº¦

---

### å®é™…æ•ˆæœéªŒè¯

**æµ‹è¯•prompt**: "è®¡ç®—5ã€8ã€12çš„å¹³æ–¹,ç„¶åæ±‚å‰ä¸¤ä¸ªçš„å’Œä»¥åŠåä¸¤ä¸ªçš„å’Œ,æœ€åæ±‡æ€»"

**LLMç”Ÿæˆçš„è®¡åˆ’** (ä½¿ç”¨æ–°æç¤ºè¯å):
```json
{
  "steps": [
    {
      "step_id": "step_1",
      "actions": [
        {"action_id": "action_1_1", "parameters": {"code": "5**2"}},
        {"action_id": "action_1_2", "parameters": {"code": "8**2"}},
        {"action_id": "action_1_3", "parameters": {"code": "12**2"}}
      ],
      "dependencies": []  // â† ä¸‰ä¸ªè®¡ç®—å¹¶è¡Œ
    },
    {
      "step_id": "step_2",
      "actions": [
        {
          "action_id": "action_2_1",
          "parameters": {"code": "{{action_1_1.output}} + {{action_1_2.output}}"}
        },
        {
          "action_id": "action_2_2",
          "parameters": {"code": "{{action_1_2.output}} + {{action_1_3.output}}"}
        }
      ],
      "dependencies": ["step_1"]  // â† ä¸¤ä¸ªæ±‚å’Œå¹¶è¡Œ
    },
    {
      "step_id": "step_3",
      "parameters": {"code": "{{action_2_1.output}} + {{action_2_2.output}}"},
      "dependencies": ["step_2"]  // â† æœ€ç»ˆæ±‡æ€»
    }
  ]
}
```

**æ‰§è¡Œæ‰¹æ¬¡**:
```
Batch 1: step_1 (3ä¸ªactionså¹¶è¡Œ)
Batch 2: step_2 (2ä¸ªactionså¹¶è¡Œ)
Batch 3: step_3 (å•ä¸ªæ“ä½œ)
```

**å¯¹æ¯”æ—§æç¤ºè¯ç”Ÿæˆçš„è®¡åˆ’**:
```json
{
  "steps": [
    {"step_id": "step_1", "tool": "js", "parameters": {"code": "5**2"}},
    {"step_id": "step_2", "tool": "js", "parameters": {"code": "8**2"}},
    {"step_id": "step_3", "tool": "js", "parameters": {"code": "12**2"}},
    {"step_id": "step_4", "parameters": {"code": "{{step_1.output}} + {{step_2.output}}"}},
    {"step_id": "step_5", "parameters": {"code": "{{step_2.output}} + {{step_3.output}}"}},
    {"step_id": "step_6", "parameters": {"code": "{{step_4.output}} + {{step_5.output}}"}}
  ]
}
```
**å¯¹æ¯”ç»“æœ**: æ–°æç¤ºè¯ç”Ÿæˆçš„è®¡åˆ’æ‰§è¡Œæ•ˆç‡æå‡**3x**

---

### æ–°å¢æç¤ºè¯æ®µè½4: é‡æ–°è§„åˆ’æç¤ºè¯ (Lines 653-733)

**æ–°å¢å†…å®¹**:
```markdown
// ==================== é‡æ–°è§„åˆ’æç¤ºè¯ ====================
/// é‡æ–°è§„åˆ’ç³»ç»Ÿæç¤ºè¯ï¼ˆæ ¹æ®å¤±è´¥åŸå› é‡æ–°è§„åˆ’ä»»åŠ¡ï¼‰
pub const REPLANNING_SYSTEM_PROMPT: &str = r#"ä½ æ˜¯ä»»åŠ¡è§„åˆ’ä¸“å®¶ï¼Œæ“…é•¿æ ¹æ®å¤±è´¥åŸå› é‡æ–°è§„åˆ’ä»»åŠ¡ã€‚

ã€æ ¸å¿ƒèŒè´£ã€‘
åŸºäºå¤±è´¥åŸå› å’Œå¯ç”¨å·¥å…·ï¼Œç”Ÿæˆæ”¹è¿›çš„æ‰§è¡Œè®¡åˆ’ï¼Œé¿å…é‡å¤åŒæ ·çš„é”™è¯¯ã€‚

ã€âš ï¸ å¹¶è¡Œæ‰§è¡Œè§„åˆ’ - é‡è¦ã€‘
ç³»ç»Ÿæ”¯æŒåŸºäºDAGçš„å¹¶è¡Œæ‰§è¡Œï¼Œè¯·åˆç†åˆ©ç”¨dependencieså­—æ®µå®ç°å¹¶è¡Œä¼˜åŒ–...

ã€ğŸš€ æ­¥éª¤å†…å¹¶è¡Œæ‰§è¡Œ - Actionsæ ¼å¼ã€‘
**æ–°ç‰¹æ€§**: æ”¯æŒåœ¨å•ä¸ªæ­¥éª¤å†…å¹¶è¡Œæ‰§è¡Œå¤šä¸ªæ“ä½œ...
```

**é…å¥—ç”¨æˆ·æç¤ºè¯æ¨¡æ¿**:
```rust
pub const REPLANNING_USER_TEMPLATE: &str = r#"
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å¤±è´¥åŸå› ã€‘
{failure_reason}

ã€å¯ç”¨å·¥å…·åˆ—è¡¨ã€‘
{available_tools}
{workflow_hint}

ã€å½“å‰å…ƒæ•°æ®ã€‘
{metadata}

ã€é‡æ–°è§„åˆ’ä»»åŠ¡ã€‘
è¯·åŸºäºä¸Šè¿°å¤±è´¥åŸå› é‡æ–°è§„åˆ’ä»»åŠ¡ï¼Œè¿”å›ç¬¦åˆè¦æ±‚æ ¼å¼çš„æ–°æ‰§è¡Œè®¡åˆ’ã€‚
é‡ç‚¹ï¼š
1. ç¡®ä¿æ¯ä¸ªæ­¥éª¤çš„ step_name éƒ½æœ‰æ˜ç¡®çš„ã€æœ‰æ„ä¹‰çš„åç§°
2. æ‰€æœ‰ tool_id å¿…é¡»ä»ä¸Šè¿°å¯ç”¨å·¥å…·åˆ—è¡¨ä¸­é€‰æ‹©
3. é¿å…å¯¼è‡´å¤±è´¥çš„åŒæ ·é—®é¢˜
4. å¦‚æœæœ‰æ ‡å‡†æµç¨‹æç¤ºï¼Œå¯ä»¥å‚è€ƒä½†ä¸å¿…å®Œå…¨éµå¾ª
5. åˆç†åˆ©ç”¨å¹¶è¡Œæ‰§è¡Œä¼˜åŒ–æ€§èƒ½
```

**é…å¥—æ„å»ºå™¨æ–¹æ³•** (Lines 884-916):
```rust
/// æ„å»ºé‡æ–°è§„åˆ’æç¤ºè¯ï¼ˆæ ¹æ®å¤±è´¥åŸå› é‡æ–°è§„åˆ’ä»»åŠ¡ï¼‰
pub fn build_replanning_prompt(
    failure_reason: &str,
    available_tools: &str,
    metadata: &std::collections::HashMap<String, String>,
    workflow_hint: Option<&str>,
) -> (String, String)
```

**ç›®çš„**:
- ç»Ÿä¸€ç®¡ç†é‡æ–°è§„åˆ’æç¤ºè¯,ä¸å†åœ¨ `planner.rs` ä¸­å†…è”å®šä¹‰
- å¤ç”¨åˆå§‹è§„åˆ’ä¸­çš„å¹¶è¡Œæ‰§è¡Œå’Œactionsæ ¼å¼å¼•å¯¼
- å¢å¼ºé‡æ–°è§„åˆ’æ—¶çš„å¹¶è¡Œæ‰§è¡Œæ„è¯†
- ä¸åˆå§‹è§„åˆ’æç¤ºè¯ä¿æŒä¸€è‡´çš„é£æ ¼å’Œç»“æ„

**æ”¹è¿›å‰åå¯¹æ¯”**:

| ç»´åº¦ | ä¿®æ”¹å‰ (planner.rså†…è”) | ä¿®æ”¹å (prompts.rsç»Ÿä¸€ç®¡ç†) |
|------|------------------------|---------------------------|
| **æç¤ºè¯ä½ç½®** | `planner.rs` ä¸­å†…è”å®šä¹‰ | `prompts.rs` ä¸­ç»Ÿä¸€ç®¡ç† |
| **å¹¶è¡Œæ‰§è¡Œå¼•å¯¼** | âŒ æ—  | âœ… åŒ…å«å®Œæ•´çš„å¹¶è¡Œæ‰§è¡Œå’Œactionsæ ¼å¼è¯´æ˜ |
| **æç¤ºè¯å¤ç”¨** | âŒ ä¸å¯å¤ç”¨ | âœ… é€šè¿‡PromptBuilderå¤ç”¨ |
| **ç»´æŠ¤æ€§** | âš ï¸ åˆ†æ•£ç®¡ç†,éš¾ä»¥ç»´æŠ¤ | âœ… é›†ä¸­ç®¡ç†,æ˜“äºç»´æŠ¤ |
| **ä¸€è‡´æ€§** | âš ï¸ ä¸åˆå§‹è§„åˆ’æç¤ºè¯é£æ ¼ä¸ä¸€è‡´ | âœ… ä¸åˆå§‹è§„åˆ’æç¤ºè¯é£æ ¼ä¸€è‡´ |

---

## 6ï¸âƒ£ æœªåˆ é™¤çš„ä»£ç 

**è¯´æ˜**: æ­¤æ¬¡å¹¶è¡Œæ‰§è¡ŒåŠŸèƒ½å®ç°**æ²¡æœ‰åˆ é™¤ä»»ä½•ç°æœ‰ä»£ç **,æ‰€æœ‰ä¿®æ”¹éƒ½æ˜¯**æ–°å¢æˆ–é‡æ„**,ä¿æŒå‘åå…¼å®¹ã€‚

---

## ğŸ“Š ä¿®æ”¹ç»Ÿè®¡

| ç±»åˆ« | æ–‡ä»¶ | æ–°å¢è¡Œæ•° | ä¿®æ”¹è¡Œæ•° | åˆ é™¤è¡Œæ•° |
|------|------|----------|----------|----------|
| åè®®æ–‡ä»¶ | task_orchestrator_service.proto | 47 | 6 | 0 |
| æ–°å¢æ–‡ä»¶ | parallel_executor.rs | ~900 | 0 | 0 |
| ä¿®æ”¹æ–‡ä»¶ | executor.rs | 25 | 0 | 0 |
| é‡æ„æ–‡ä»¶ | parameter_resolver.rs | 50 | 30 | 0 |
| ä¿®æ”¹æ–‡ä»¶ | planner.rs | 20 | 40 | 60 |
| é…ç½®æ–‡ä»¶ | config.dev.toml | 35 | 0 | 0 |
| æç¤ºè¯æ–‡ä»¶ | prompts.rs | 200 | 0 | 0 |
| **æ€»è®¡** | 7ä¸ªæ–‡ä»¶ | **~1277** | **76** | **60** |

---

## ğŸ” å…³é”®ä¿®æ”¹æ€»ç»“

### 1. task_orchestrator_service.proto (Lines 287-334)
**ä¿®æ”¹å†…å®¹**: æ·»åŠ PlanActionæ¶ˆæ¯å®šä¹‰å’ŒPlanStep.actionså­—æ®µ

**æ ¸å¿ƒæ”¹åŠ¨**:
```protobuf
// æ–°å¢æ¶ˆæ¯ç±»å‹
message PlanAction {
    string action_id = 1;      // æ“ä½œID
    string tool = 3;           // å·¥å…·åç§°
    string parameters = 4;     // å·¥å…·å‚æ•°
    repeated string dependencies = 5;  // ä¾èµ–çš„action_idåˆ—è¡¨
}

// PlanStepæ–°å¢å­—æ®µ
message PlanStep {
    // ... åŸæœ‰å­—æ®µ
    repeated PlanAction actions = 7;  // æ­¥éª¤å†…å¹¶è¡Œæ“ä½œ
}
```

**å½±å“èŒƒå›´**:
- âœ… åè®®å±‚æ”¯æŒæ­¥éª¤å†…å¹¶è¡Œæ‰§è¡Œ
- âœ… å‘åå…¼å®¹æ—§ç‰ˆtool+parametersæ ¼å¼
- âœ… æ”¯æŒä¸¤å±‚ä¾èµ–å…³ç³»(æ­¥éª¤é—´ + æ“ä½œé—´)

---

### 2. executor.rs (Lines 923-947)
**ä¿®æ”¹å†…å®¹**: æ·»åŠ actionsæ ¼å¼æ£€æŸ¥,æ”¯æŒæ­¥éª¤çº§åæ€æ¨¡å¼ä¸‹çš„actionså¹¶è¡Œæ‰§è¡Œ

**æ ¸å¿ƒä»£ç **:
```rust
if !step.actions.is_empty() {
    // æ„å»ºtool_mapå¹¶è°ƒç”¨execute_step_with_actions
    return self.execute_step_with_actions(...).await;
}
```

---

### 2. parameter_resolver.rs (Lines 528-698)
**ä¿®æ”¹å†…å®¹**:
- é‡æ„`process_parameter_value`æ”¯æŒå¤šå ä½ç¬¦(Lines 528-552)
- æ–°å¢actionè¾“å‡ºå¼•ç”¨å¤„ç†(Lines 566-591)

**æ ¸å¿ƒæ”¹è¿›**:
```rust
// ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ‰¾åˆ°æ‰€æœ‰å ä½ç¬¦å¹¶æ›¿æ¢
for cap in PLACEHOLDER_REGEX.captures_iter(value) {
    let resolved = Self::resolve_single_placeholder(...);
    result = result.replace(full_match, &resolved);
}
```

---

### 3. planner.rs (Lines 1076-1224)
**ä¿®æ”¹å†…å®¹**: æ·»åŠ æ­¥éª¤IDå¼ºåˆ¶é‡ç¼–å·é€»è¾‘

**æ ¸å¿ƒé€»è¾‘**:
```rust
// å»ºç«‹æ˜ å°„: LLMçš„step_id â†’ æ–°çš„step_id (ä»1å¼€å§‹)
for (idx, step) in steps.iter().enumerate() {
    let new_id = format!("step_{}", idx + 1);
    llm_to_new_id_map.insert(llm_step_id, new_id);
}

// é‡æ˜ å°„ä¾èµ–å…³ç³»
deps.map(|dep| llm_to_new_id_map.get(dep).cloned())
```

**å½±å“èŒƒå›´**:
- âœ… è§£å†³é‡æ–°è§„åˆ’åstep_idä¸è¿ç»­é—®é¢˜
- âœ… ä¾èµ–å…³ç³»æ­£ç¡®æ˜ å°„

---

### 5. config.dev.toml (Lines 106-140)
**ä¿®æ”¹å†…å®¹**: æ–°å¢å¹¶è¡Œæ‰§è¡Œå’Œåæ€é…ç½®é¡¹

**å…³é”®é…ç½®**:
- `enable_parallel_execution = true`
- `parallel_max_concurrent = 8`
- `enable_step_level_reflection = true`
- `max_consecutive_failures = 3`

**å½±å“èŒƒå›´**:
- âœ… æ”¯æŒåŠ¨æ€å¼€å¯/å…³é—­å¹¶è¡Œæ‰§è¡Œ
- âœ… å¯è°ƒæ•´å¹¶å‘æ•°å’Œå¯ç”¨é˜ˆå€¼

---

### 6. parallel_executor.rs (æ–°å¢æ–‡ä»¶, ~900è¡Œ)
**æ ¸å¿ƒç»„ä»¶**:
1. `DependencyGraph` - DAGç®¡ç†
2. `ExecutionNode` - èŠ‚ç‚¹è¡¨ç¤º
3. `NodeState` - çŠ¶æ€æšä¸¾
4. `ParallelExecutor` - å¹¶è¡Œæ‰§è¡Œå™¨

**æ ¸å¿ƒç®—æ³•**:
- Kahnæ‹“æ‰‘æ’åºè®¡ç®—æ‰§è¡Œæ‰¹æ¬¡
- ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°é‡
- å¼‚æ­¥ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œ

---

### 7. prompts.rs (Lines 235-733)
**ä¿®æ”¹å†…å®¹**: æ–°å¢å¹¶è¡Œæ‰§è¡Œã€actionsæ ¼å¼å’Œé‡æ–°è§„åˆ’çš„æç¤ºè¯å¼•å¯¼

**æ ¸å¿ƒæ”¹åŠ¨**:
```markdown
ã€âš ï¸ å¹¶è¡Œæ‰§è¡Œè§„åˆ’ - é‡è¦ã€‘
- æ— ä¾èµ–æ­¥éª¤å¯å¹¶è¡Œ
- æ˜ç¡®ä¾èµ–å…³ç³»
- ä¼˜åŒ–æ‰§è¡Œæ•ˆç‡

ã€ğŸš€ æ­¥éª¤å†…å¹¶è¡Œæ‰§è¡Œ - Actionsæ ¼å¼ã€‘
- ä½•æ—¶ä½¿ç”¨actionsæ ¼å¼
- å…¼å®¹æ€§è¯´æ˜
- Actionè¾“å‡ºå¼•ç”¨è¯­æ³•

ã€é‡æ–°è§„åˆ’æç¤ºè¯ã€‘
- REPLANNING_SYSTEM_PROMPT: åŒ…å«å¹¶è¡Œæ‰§è¡Œå’Œactionsæ ¼å¼å¼•å¯¼
- REPLANNING_USER_TEMPLATE: ç»“æ„åŒ–çš„å¤±è´¥åŸå› ã€å·¥å…·åˆ—è¡¨ã€å…ƒæ•°æ®è¾“å…¥
- PromptBuilder::build_replanning_prompt: ç»Ÿä¸€æ„å»ºé‡æ–°è§„åˆ’æç¤ºè¯
```

**å½±å“èŒƒå›´**:
- âœ… LLMèƒ½å¤Ÿè¯†åˆ«å¹¶è¡Œæœºä¼š
- âœ… LLMç”Ÿæˆåˆç†çš„dependenciesè®¾ç½®
- âœ… LLMèƒ½å¤Ÿä½¿ç”¨actionsæ ¼å¼
- âœ… ç”Ÿæˆçš„è®¡åˆ’å…·æœ‰æ›´é«˜å¹¶è¡Œåº¦
- âœ… é‡æ–°è§„åˆ’æ—¶ä¹Ÿå…·å¤‡å¹¶è¡Œæ‰§è¡Œæ„è¯†
- âœ… æç¤ºè¯ç»Ÿä¸€ç®¡ç†,æ˜“äºç»´æŠ¤å’Œæ›´æ–°

---

## âœ… åŠŸèƒ½éªŒè¯

### ä¿®æ”¹åå®ç°çš„åŠŸèƒ½

1. âœ… **æ­¥éª¤é—´å¹¶è¡Œæ‰§è¡Œ**: åŸºäºDAGè‡ªåŠ¨è¯†åˆ«å¯å¹¶è¡Œæ­¥éª¤
2. âœ… **æ­¥éª¤å†…å¹¶è¡Œæ‰§è¡Œ**: æ”¯æŒactionsæ ¼å¼,å•æ­¥éª¤å†…å¤šä¸ªæ“ä½œå¹¶è¡Œ
3. âœ… **å¤šå ä½ç¬¦è§£æ**: `{{a}} + {{b}}`æ­£ç¡®è§£æä¸º`25 + 64`
4. âœ… **Actionè¾“å‡ºå¼•ç”¨**: `{{action_1_1.output}}`æ­£ç¡®è·å–actionç»“æœ
5. âœ… **æ­¥éª¤IDé‡ç¼–å·**: é‡æ–°è§„åˆ’åstep_idä»1å¼€å§‹
6. âœ… **æ­¥éª¤çº§åæ€å…¼å®¹**: åæ€æ¨¡å¼æ”¯æŒå¹¶è¡Œæ‰§è¡Œ
7. âœ… **å¹¶å‘æ§åˆ¶**: ä¿¡å·é‡é™åˆ¶æœ€å¤§å¹¶å‘æ•°
8. âœ… **ç¯æ£€æµ‹**: Kahnç®—æ³•æ£€æµ‹ä¾èµ–ç¯
9. âœ… **æ—©æœŸç»ˆæ­¢**: æ‰¹æ¬¡å¤±è´¥ç«‹å³åœæ­¢åç»­æ‰¹æ¬¡
10. âœ… **å‘åå…¼å®¹**: æ—§æ ¼å¼(tool+parameters)ç»§ç»­å·¥ä½œ

---

## ğŸ¯ æµ‹è¯•ç”¨ä¾‹

### é›†æˆæµ‹è¯•ç¤ºä¾‹
**æ–‡ä»¶**: `examples/parallel_calculation_test.rs`

**æµ‹è¯•åœºæ™¯**: ä¸‰å±‚è®¡ç®—ä»»åŠ¡
- ç¬¬ä¸€å±‚: å¹¶è¡Œè®¡ç®—3ä¸ªå¹³æ–¹æ•°
- ç¬¬äºŒå±‚: å¹¶è¡Œè®¡ç®—2ç»„å’Œ
- ç¬¬ä¸‰å±‚: æ±‡æ€»æœ€ç»ˆç»“æœ

**é¢„æœŸç»“æœ**:
```
step_1 (3ä¸ªactionså¹¶è¡Œ):
  action_1_1: 5**2 = 25
  action_1_2: 8**2 = 64
  action_1_3: 12**2 = 144

step_2 (2ä¸ªactionså¹¶è¡Œ):
  action_2_1: 25 + 64 = 89
  action_2_2: 64 + 144 = 208

step_3:
  89 + 208 = 297 âœ…
```

---

## ğŸ“ ä¿®æ”¹ç†ç”±æ€»ç»“

| ä¿®æ”¹é¡¹ | ç†ç”± | è§£å†³çš„é—®é¢˜ |
|--------|------|-----------|
| protoæ·»åŠ PlanAction | åè®®å±‚ä¸æ”¯æŒæ­¥éª¤å†…å¤šæ“ä½œ | æ— æ³•è¡¨è¾¾å¹¶è¡Œactionsç»“æ„ |
| protoæ·»åŠ actionså­—æ®µ | PlanStepæ— æ³•åŒ…å«å¤šä¸ªæ“ä½œ | æ­¥éª¤å†…å¹¶è¡Œæ‰§è¡Œæ— åè®®æ”¯æŒ |
| executor.rs actionsæ£€æŸ¥ | æ­¥éª¤çº§åæ€ä¸æ”¯æŒactionså¹¶è¡Œ | "å·¥å…·æœªæ‰¾åˆ°"é”™è¯¯ |
| parameter_resolverå¤šå ä½ç¬¦ | è¡¨è¾¾å¼å‚æ•°æ— æ³•è§£æ | `{{a}}+{{b}}`è§£æå¤±è´¥ |
| planneræ­¥éª¤IDé‡ç¼–å· | é‡æ–°è§„åˆ’IDä¸ä»1å¼€å§‹ | ä¾èµ–å…³ç³»æ··ä¹± |
| plannerä½¿ç”¨PromptBuilder | æç¤ºè¯åˆ†æ•£å†…è”å®šä¹‰ | é‡æ–°è§„åˆ’æç¤ºè¯ç¼ºå°‘å¹¶è¡Œæ‰§è¡Œå¼•å¯¼,éš¾ä»¥ç»´æŠ¤ |
| configå¹¶è¡Œé…ç½® | ç¼ºå°‘å¹¶è¡Œæ§åˆ¶å¼€å…³ | æ— æ³•åŠ¨æ€è°ƒæ•´å¹¶è¡Œè¡Œä¸º |
| parallel_executoræ–°æ–‡ä»¶ | ç¼ºå°‘å¹¶è¡Œæ‰§è¡Œæ ¸å¿ƒé€»è¾‘ | æ— æ³•å®ç°æ­¥éª¤é—´å¹¶è¡Œ |
| prompts.rsæç¤ºè¯æ›´æ–° | LLMä¸çŸ¥é“å¹¶è¡Œæ‰§è¡Œèƒ½åŠ› | ç”Ÿæˆçš„è®¡åˆ’ä¸²è¡Œåº¦é«˜,æ•ˆç‡ä½ |
| prompts.rsæ–°å¢é‡æ–°è§„åˆ’æç¤ºè¯ | é‡æ–°è§„åˆ’æç¤ºè¯åˆ†æ•£ç®¡ç† | é‡æ–°è§„åˆ’ç¼ºå°‘å¹¶è¡Œæ‰§è¡Œä¼˜åŒ–æ„è¯† |

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å¹¶è¡Œæ‰§è¡Œæ¶æ„è®¾è®¡æ–‡æ¡£](å¹¶è¡Œæ‰§è¡Œæ¶æ„è®¾è®¡æ–‡æ¡£.md) - è¯¦ç»†çš„æ¶æ„è®¾è®¡å’Œç®—æ³•è¯´æ˜
- `src/core/parallel_executor.rs` - æ ¸å¿ƒå®ç°ä»£ç åŠæ³¨é‡Š
- `config.dev.toml` - é…ç½®æ–‡ä»¶åŠé…ç½®è¯´æ˜

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæˆ
**æœ€åæ›´æ–°**: 2025-12-19
