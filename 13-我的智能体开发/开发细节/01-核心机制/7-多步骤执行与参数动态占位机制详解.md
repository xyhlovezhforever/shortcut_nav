# å¤šæ­¥éª¤æ‰§è¡Œã€ä¾èµ–å…³ç³»ä¸å‚æ•°åŠ¨æ€å ä½æœºåˆ¶è¯¦è§£

> æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æå½“è¿ç»­æ‰§è¡Œå¤šä¸ªæ­¥éª¤æ—¶ï¼Œå¦‚ä½•é€šè¿‡ä¾èµ–å…³ç³»å’Œå‚æ•°åŠ¨æ€å ä½å®ç°æ­¥éª¤é—´çš„æ•°æ®æµè½¬ï¼Œä»æç¤ºè¯è®¾è®¡åˆ°å…·ä½“æ‰§è¡Œå…¨æµç¨‹å‰–æã€‚

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [é˜¶æ®µä¸€ï¼šæç¤ºè¯è®¾è®¡å±‚é¢](#é˜¶æ®µä¸€æç¤ºè¯è®¾è®¡å±‚é¢)
  - [1. ä¾èµ–å…³ç³»çš„å®šä¹‰](#1-ä¾èµ–å…³ç³»çš„å®šä¹‰)
  - [2. å‚æ•°åŠ¨æ€å ä½çš„çº¦å®š](#2-å‚æ•°åŠ¨æ€å ä½çš„çº¦å®š)
  - [3. æ•°æ®æµæ ‡æ³¨](#3-æ•°æ®æµæ ‡æ³¨)
- [é˜¶æ®µäºŒï¼šLLMç”Ÿæˆæ‰§è¡Œè®¡åˆ’](#é˜¶æ®µäºŒllmç”Ÿæˆæ‰§è¡Œè®¡åˆ’)
  - [1. è®¡åˆ’ç»“æ„](#1-è®¡åˆ’ç»“æ„)
  - [2. å‚æ•°å ä½ç¬¦æ ¼å¼](#2-å‚æ•°å ä½ç¬¦æ ¼å¼)
- [é˜¶æ®µä¸‰ï¼šæ‰§è¡Œä¸Šä¸‹æ–‡ç®¡ç†](#é˜¶æ®µä¸‰æ‰§è¡Œä¸Šä¸‹æ–‡ç®¡ç†)
  - [1. ExecutionContext æ¶æ„](#1-executioncontext-æ¶æ„)
  - [2. å…ƒæ•°æ®çš„ä¸‰å±‚ç»“æ„](#2-å…ƒæ•°æ®çš„ä¸‰å±‚ç»“æ„)
  - [3. æ­¥éª¤ç»“æœç¼“å­˜](#3-æ­¥éª¤ç»“æœç¼“å­˜)
- [é˜¶æ®µå››ï¼šå‚æ•°è§£æä¸å ä½ç¬¦æ›¿æ¢](#é˜¶æ®µå››å‚æ•°è§£æä¸å ä½ç¬¦æ›¿æ¢)
  - [1. ParameterResolver æ ¸å¿ƒé€»è¾‘](#1-parameterresolver-æ ¸å¿ƒé€»è¾‘)
  - [2. å ä½ç¬¦è¯†åˆ«ä¸å¤„ç†](#2-å ä½ç¬¦è¯†åˆ«ä¸å¤„ç†)
  - [3. å¤šç§å ä½ç¬¦æ ¼å¼æ”¯æŒ](#3-å¤šç§å ä½ç¬¦æ ¼å¼æ”¯æŒ)
- [é˜¶æ®µäº”ï¼šæ­¥éª¤é—´æ•°æ®æµè½¬](#é˜¶æ®µäº”æ­¥éª¤é—´æ•°æ®æµè½¬)
  - [1. æ­¥éª¤è¾“å‡ºä¿å­˜](#1-æ­¥éª¤è¾“å‡ºä¿å­˜)
  - [2. åŠ¨æ€å‚æ•°åŒæ­¥](#2-åŠ¨æ€å‚æ•°åŒæ­¥)
  - [3. å‚æ•°è·å–ä¼˜å…ˆçº§](#3-å‚æ•°è·å–ä¼˜å…ˆçº§)
- [å®Œæ•´æ‰§è¡Œæµç¨‹ç¤ºä¾‹](#å®Œæ•´æ‰§è¡Œæµç¨‹ç¤ºä¾‹)
- [ä»£ç å®ç°ç´¢å¼•](#ä»£ç å®ç°ç´¢å¼•)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ¦‚è¿°

å½“ä»»åŠ¡éœ€è¦å¤šä¸ªæ­¥éª¤ååŒå®Œæˆæ—¶ï¼Œé¡¹ç›®é€šè¿‡ä»¥ä¸‹æœºåˆ¶å®ç°æ­¥éª¤é—´çš„æ•°æ®æµè½¬ï¼š

1. **ä¾èµ–å…³ç³»ï¼ˆDependenciesï¼‰**ï¼šå®šä¹‰æ­¥éª¤çš„æ‰§è¡Œé¡ºåº
2. **å‚æ•°å ä½ç¬¦ï¼ˆParameter Placeholdersï¼‰**ï¼šå¼•ç”¨å‰ç½®æ­¥éª¤çš„è¾“å‡º
3. **æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆExecutionContextï¼‰**ï¼šç»´æŠ¤å…¨å±€å…ƒæ•°æ®å’Œæ­¥éª¤ç»“æœ
4. **å‚æ•°è§£æå™¨ï¼ˆParameterResolverï¼‰**ï¼šåŠ¨æ€è§£æå ä½ç¬¦å¹¶å¡«å……å‚æ•°

**æ ¸å¿ƒæ€æƒ³ï¼š** å°†æ­¥éª¤è¾“å‡ºçš„ç‰¹å®šå­—æ®µåŠ¨æ€æå–åˆ°è¿è¡Œæ—¶å…ƒæ•°æ®ä¸­ï¼Œä¾›åç»­æ­¥éª¤é€šè¿‡å ä½ç¬¦å¼•ç”¨ã€‚

---

## é˜¶æ®µä¸€ï¼šæç¤ºè¯è®¾è®¡å±‚é¢

### 1. ä¾èµ–å…³ç³»çš„å®šä¹‰

**æç¤ºè¯ä½ç½®ï¼š** [src/llm/prompts.rs:245-246](../../src/llm/prompts.rs#L245-L246)

```
ã€å…³é”®çº¦æŸã€‘
- dependencieså¼•ç”¨å·²å®šä¹‰æ­¥éª¤
- æ•°æ®æµä¸€è‡´ï¼šè¾“å…¥æ¥æºä¸è¾“å‡ºç”¨é€”å¯¹åº”
```

**JSON Schema å®šä¹‰ï¼š** [src/llm/prompts.rs:261](../../src/llm/prompts.rs#L261)

```json
"dependencies": ["step_id1", "step_id2"]
```

**è®¾è®¡æ„å›¾ï¼š**
- âœ… æ˜ç¡®æ­¥éª¤æ‰§è¡Œé¡ºåºï¼Œç¡®ä¿æ•°æ®ç”Ÿäº§è€…åœ¨æ¶ˆè´¹è€…ä¹‹å‰æ‰§è¡Œ
- âœ… æ”¯æŒå¹¶è¡Œæ‰§è¡Œï¼šæ— ä¾èµ–å…³ç³»çš„æ­¥éª¤å¯ä»¥å¹¶å‘
- âœ… é˜²æ­¢å¾ªç¯ä¾èµ–ï¼šLLMç”Ÿæˆæ—¶è¦æ±‚å¼•ç”¨"å·²å®šä¹‰"çš„æ­¥éª¤

**ç¤ºä¾‹ï¼š**
```json
{
  "step_id": "step_3",
  "step_name": "é…ç½®é€šä¿¡",
  "dependencies": ["step_1", "step_2"],  // ä¾èµ–step_1å’Œstep_2çš„è¾“å‡º
  ...
}
```

---

### 2. å‚æ•°åŠ¨æ€å ä½çš„çº¦å®š

**æç¤ºè¯ä½ç½®ï¼š** [src/llm/prompts.rs:341-342](../../src/llm/prompts.rs#L341-L342)

```json
"parameters": {
  "device_ids": ["step_1è¾“å‡º", "step_2è¾“å‡º"],
  "timeout_ms": 5000
}
```

**çº¦å®šæ ¼å¼ï¼š**
LLMåœ¨ç”Ÿæˆå‚æ•°æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å¼•ç”¨å‰ç½®æ­¥éª¤è¾“å‡ºï¼š
- æè¿°æ€§å¼•ç”¨ï¼š`"step_1è¾“å‡º"`, `"step_2çš„device_id"`
- å ä½ç¬¦å¼•ç”¨ï¼š`"{{step_1.device_id}}"`, `"${step_2.output}"`

**æç¤ºè¯å¼•å¯¼ï¼š** [src/llm/prompts.rs:344-345](../../src/llm/prompts.rs#L344-L345)
```
"data_input_source": "step_1è¾“å‡ºå’Œstep_2è¾“å‡º",
"data_output_usage": "æœ€ç»ˆç»“æœ"
```

è¿™ä¸¤ä¸ªå­—æ®µå¸®åŠ©LLMç†è§£ï¼š
- **data_input_source**ï¼šå½“å‰æ­¥éª¤çš„è¾“å…¥æ•°æ®æ¥æºï¼ˆç”¨æˆ·è¾“å…¥/å‰ç½®æ­¥éª¤/å…ƒæ•°æ®ï¼‰
- **data_output_usage**ï¼šå½“å‰æ­¥éª¤çš„è¾“å‡ºå°†è¢«å“ªä¸ªæ­¥éª¤ä½¿ç”¨

---

### 3. æ•°æ®æµæ ‡æ³¨

**æç¤ºè¯ä½ç½®ï¼š** [src/llm/prompts.rs:263-264](../../src/llm/prompts.rs#L263-L264)

```json
"data_input_source": "ç”¨æˆ·è¾“å…¥|step_Xè¾“å‡º|å…ƒæ•°æ®|ä¸Šä¸‹æ–‡",
"data_output_usage": "ä¾›step_Xä½¿ç”¨|æœ€ç»ˆç»“æœ|ä¸­é—´çŠ¶æ€"
```

**ä½œç”¨ï¼š**
1. **å¸®åŠ©LLMç†è§£æ•°æ®æµ**ï¼šç”Ÿæˆè®¡åˆ’æ—¶è€ƒè™‘æ•°æ®æ¥æºå’Œå»å‘
2. **æ–‡æ¡£åŒ–**ï¼šæ¸…æ™°æ ‡æ³¨æ¯ä¸ªæ­¥éª¤åœ¨æ•°æ®æµä¸­çš„ä½ç½®
3. **å¯è¿½æº¯æ€§**ï¼šä¾¿äºè°ƒè¯•å’Œä¼˜åŒ–æ‰§è¡Œæµç¨‹

**å®Œæ•´ç¤ºä¾‹ï¼š** [src/llm/prompts.rs:317-347](../../src/llm/prompts.rs#L317-L347)

```json
{
  "steps": [
    {
      "step_id": "step_1",
      "step_name": "æ·»åŠ PLC",
      "tool_id": "add_device",
      "parameters": {"device_name": "è®¾å¤‡A", "device_type": "PLC"},
      "dependencies": [],
      "expected_output": "è®¾å¤‡Açš„ID",
      "data_input_source": "ç”¨æˆ·è¾“å…¥",
      "data_output_usage": "ä¾›step_3ä½¿ç”¨"  // æ˜ç¡®æ ‡æ³¨è¾“å‡ºç”¨é€”
    },
    {
      "step_id": "step_2",
      "step_name": "æ·»åŠ ä¼ æ„Ÿå™¨",
      "tool_id": "add_device",
      "parameters": {"device_name": "è®¾å¤‡B", "device_type": "ä¼ æ„Ÿå™¨"},
      "dependencies": ["step_1"],  // ä¾èµ–step_1ï¼ˆé¡ºåºæ‰§è¡Œï¼‰
      "expected_output": "è®¾å¤‡Bçš„ID",
      "data_input_source": "ç”¨æˆ·è¾“å…¥",
      "data_output_usage": "ä¾›step_3ä½¿ç”¨"
    },
    {
      "step_id": "step_3",
      "step_name": "é…ç½®é€šä¿¡",
      "tool_id": "configure_comm",
      "parameters": {
        "device_ids": ["step_1è¾“å‡º", "step_2è¾“å‡º"],  // å¼•ç”¨å‰ç½®æ­¥éª¤
        "timeout_ms": 5000
      },
      "dependencies": ["step_1", "step_2"],  // ä¾èµ–ä¸¤ä¸ªå‰ç½®æ­¥éª¤
      "expected_output": "é…ç½®ç»“æœ",
      "data_input_source": "step_1è¾“å‡ºå’Œstep_2è¾“å‡º",
      "data_output_usage": "æœ€ç»ˆç»“æœ"
    }
  ]
}
```

---

## é˜¶æ®µäºŒï¼šLLMç”Ÿæˆæ‰§è¡Œè®¡åˆ’

### 1. è®¡åˆ’ç»“æ„

LLMæ ¹æ®æç¤ºè¯ç”Ÿæˆçš„æ‰§è¡Œè®¡åˆ’åŒ…å«ï¼š

**æ ¸å¿ƒå­—æ®µï¼š**
- `plan_id`: è®¡åˆ’å”¯ä¸€æ ‡è¯†
- `description`: ä»»åŠ¡æè¿°
- `steps`: æ­¥éª¤åˆ—è¡¨ï¼ˆæ•°ç»„ï¼‰

**æ¯ä¸ªæ­¥éª¤åŒ…å«ï¼š**
- `step_id`: æ­¥éª¤IDï¼ˆå¦‚ `step_1`, `step_2`ï¼‰
- `step_name`: æ­¥éª¤åç§°
- `tool_id`: ä½¿ç”¨çš„å·¥å…·ID
- `parameters`: å‚æ•°å¯¹è±¡ï¼ˆå¯èƒ½åŒ…å«å ä½ç¬¦ï¼‰
- `dependencies`: ä¾èµ–çš„æ­¥éª¤IDåˆ—è¡¨
- `expected_output`: é¢„æœŸè¾“å‡ºæè¿°
- `data_input_source`: æ•°æ®æ¥æºæ ‡æ³¨
- `data_output_usage`: æ•°æ®ç”¨é€”æ ‡æ³¨

---

### 2. å‚æ•°å ä½ç¬¦æ ¼å¼

LLMåœ¨ç”Ÿæˆ `parameters` å­—æ®µæ—¶ï¼Œå¯èƒ½ä½¿ç”¨ä»¥ä¸‹æ ¼å¼å¼•ç”¨å‰ç½®æ­¥éª¤è¾“å‡ºï¼š

#### æ ¼å¼1ï¼šåŒå¤§æ‹¬å· `{{...}}`

```json
{
  "parameters": {
    "datasource_id": "{{step_1.datasource_id}}",
    "project_id": "{{metadata.project_id}}"
  }
}
```

#### æ ¼å¼2ï¼šä¸‰é‡å¤§æ‹¬å· `{{{...}}}`ï¼ˆHandlebarsé£æ ¼ï¼‰

```json
{
  "parameters": {
    "model_info": "{{{step_2.outputs.model_info}}}"
  }
}
```

#### æ ¼å¼3ï¼šç¾å…ƒç¬¦å· `${...}`

```json
{
  "parameters": {
    "data_source": "${step_1.output.datasource}"
  }
}
```

#### æ ¼å¼4ï¼šç‚¹å·å¼•ç”¨ `step_X.output`

```json
{
  "parameters": {
    "previous_result": "step_1.output"
  }
}
```

#### æ ¼å¼5ï¼šæè¿°æ€§å¼•ç”¨ï¼ˆè‡ªç„¶è¯­è¨€ï¼‰

```json
{
  "parameters": {
    "device_ids": ["step_1è¾“å‡º", "step_2è¾“å‡º"]
  }
}
```

**è¯´æ˜ï¼š** æ‰€æœ‰è¿™äº›æ ¼å¼éƒ½ä¼šåœ¨æ‰§è¡Œæ—¶è¢« `ParameterResolver` è¯†åˆ«å¹¶è§£æã€‚

---

## é˜¶æ®µä¸‰ï¼šæ‰§è¡Œä¸Šä¸‹æ–‡ç®¡ç†

### 1. ExecutionContext æ¶æ„

**ä»£ç ä½ç½®ï¼š** [src/core/execution_context.rs:29-50](../../src/core/execution_context.rs#L29-L50)

```rust
pub struct ExecutionContext {
    /// åˆå§‹å…ƒæ•°æ®ï¼ˆä»»åŠ¡æäº¤æ—¶çš„å…¨å±€æ•°æ®ï¼Œä¿æŒä¸å˜ï¼‰
    initial_metadata: Arc<RwLock<HashMap<String, String>>>,

    /// è¿è¡Œæ—¶å…ƒæ•°æ®ï¼ˆåŠ¨æ€æµè½¬ï¼Œä»æ­¥éª¤è¾“å‡ºä¸­æå–çš„å…³é”®å‚æ•°ï¼‰
    /// è¿™ä¸ªå­—æ®µç”¨äºå­˜å‚¨éœ€è¦ä¼ é€’ç»™åç»­æ­¥éª¤çš„å‚æ•°
    runtime_metadata: Arc<RwLock<HashMap<String, String>>>,

    /// æ­¥éª¤æ‰§è¡Œç»“æœç¼“å­˜ï¼ˆåˆ†ç¦»å­˜å‚¨ï¼‰
    /// é”®ï¼šstep_idï¼Œå€¼ï¼šæ‰§è¡Œç»“æœ
    step_results: Arc<RwLock<HashMap<String, StepExecutionResult>>>,

    /// è®¡åˆ’ ID
    plan_id: Arc<RwLock<String>>,
}
```

**è®¾è®¡æ€æƒ³ï¼š**
- âœ… **åˆ†ç¦»å­˜å‚¨**ï¼šåˆå§‹å…ƒæ•°æ®ã€è¿è¡Œæ—¶å…ƒæ•°æ®ã€æ­¥éª¤ç»“æœä¸‰è€…åˆ†å¼€ç®¡ç†
- âœ… **ä¸å¯å˜åˆå§‹æ•°æ®**ï¼š`initial_metadata` åªåœ¨å¼€å§‹æ—¶åˆå§‹åŒ–ä¸€æ¬¡ï¼Œåç»­ä¸ä¿®æ”¹
- âœ… **åŠ¨æ€æµè½¬**ï¼š`runtime_metadata` åŠ¨æ€ç´¯ç§¯æ­¥éª¤è¾“å‡ºçš„å…³é”®å‚æ•°
- âœ… **å®Œæ•´ä¿ç•™**ï¼š`step_results` å®Œæ•´ä¿ç•™æ¯ä¸ªæ­¥éª¤çš„æ‰§è¡Œç»“æœ

---

### 2. å…ƒæ•°æ®çš„ä¸‰å±‚ç»“æ„

#### ç¬¬ä¸€å±‚ï¼šInitial Metadataï¼ˆåˆå§‹å…ƒæ•°æ®ï¼‰

**æ¥æºï¼š** ä»»åŠ¡æäº¤æ—¶ç”¨æˆ·æä¾›çš„å…¨å±€å‚æ•°

**ç¤ºä¾‹ï¼š**
```rust
{
  "project_id": "123",
  "file_path": "/data/file.csv",
  "city_name": "æ·±åœ³"
}
```

**ç‰¹ç‚¹ï¼š**
- åªè¯»ï¼Œä¸ä¿®æ”¹
- é€‚ç”¨äºæ‰€æœ‰æ­¥éª¤çš„å…¨å±€å‚æ•°
- é€šè¿‡ `context.get_metadata(key)` è·å–

---

#### ç¬¬äºŒå±‚ï¼šRuntime Metadataï¼ˆè¿è¡Œæ—¶å…ƒæ•°æ®ï¼‰

**æ¥æºï¼š** ä»æ­¥éª¤è¾“å‡ºä¸­åŠ¨æ€æå–çš„å‚æ•°

**ä»£ç ä½ç½®ï¼š** [src/core/execution_context.rs:183-309](../../src/core/execution_context.rs#L183-L309)

**æ ¸å¿ƒæ–¹æ³•ï¼š**
```rust
pub fn sync_step_output_to_runtime_metadata(
    &self,
    step_id: &str,
    output_param_names: &[String],
) -> Result<usize, String>
```

**å·¥ä½œæµç¨‹ï¼š**
1. ä» `step_results` ä¸­è·å–æ­¥éª¤çš„è¾“å‡ºï¼ˆJSONæ ¼å¼ï¼‰
2. è§£æJSONï¼Œæå–æŒ‡å®šå­—æ®µï¼ˆ`output_param_names`ï¼‰
3. å°†æå–çš„å­—æ®µæ”¾å…¥ `runtime_metadata`
4. åŒæ—¶ä¿å­˜ä¸¤ä»½ï¼š
   - `param_name`: åŸå§‹å­—æ®µå
   - `step_id_param_name`: å¸¦æ­¥éª¤IDå‰ç¼€çš„å­—æ®µå

**ç¤ºä¾‹ï¼š**
```rust
// æ­¥éª¤1è¾“å‡º: {"datasource_id": "ds_001", "datasource_name": "my_ds"}
context.sync_step_output_to_runtime_metadata(
    "step_1",
    &["datasource_id".to_string(), "datasource_name".to_string()]
)?;

// runtime_metadataç°åœ¨åŒ…å«:
// {
//   "datasource_id": "ds_001",
//   "step_1_datasource_id": "ds_001",
//   "datasource_name": "my_ds",
//   "step_1_datasource_name": "my_ds"
// }
```

**ä½œç”¨ï¼š**
- âœ… å°†æ­¥éª¤è¾“å‡ºçš„ç‰¹å®šå­—æ®µæå‡ä¸ºå…¨å±€å¯ç”¨
- âœ… åç»­æ­¥éª¤å¯ä»¥é€šè¿‡å­—æ®µåç›´æ¥å¼•ç”¨
- âœ… æ”¯æŒé€šè¿‡æ­¥éª¤IDå‰ç¼€åŒºåˆ†åŒåå­—æ®µ

---

#### ç¬¬ä¸‰å±‚ï¼šStep Resultsï¼ˆæ­¥éª¤ç»“æœç¼“å­˜ï¼‰

**æ¥æºï¼š** æ¯ä¸ªæ­¥éª¤æ‰§è¡Œåçš„å®Œæ•´è¾“å‡º

**ç»“æ„ï¼š** [src/core/execution_context.rs:12-27](../../src/core/execution_context.rs#L12-L27)

```rust
pub struct StepExecutionResult {
    pub step_id: String,
    pub step_name: String,
    pub tool_id: String,
    pub output: String,  // JSONå­—ç¬¦ä¸²
    pub is_success: bool,
    pub error_message: Option<String>,
}
```

**å­˜å‚¨ä½ç½®ï¼š**
```rust
step_results: Arc<RwLock<HashMap<String, StepExecutionResult>>>
```

**ç‰¹ç‚¹ï¼š**
- å®Œæ•´ä¿ç•™æ¯ä¸ªæ­¥éª¤çš„è¾“å‡ºJSON
- é€šè¿‡ `context.get_step_output(step_id)` è·å–
- æ”¯æŒåµŒå¥—å­—æ®µæå–ï¼ˆå¦‚ `step_1.output.result.data`ï¼‰

---

### 3. æ­¥éª¤ç»“æœç¼“å­˜

**ä¿å­˜æ­¥éª¤ç»“æœï¼š** [src/core/execution_context.rs:132-152](../../src/core/execution_context.rs#L132-L152)

```rust
pub fn set_step_result(&self, result: StepExecutionResult) {
    let step_id = result.step_id.clone();
    let mut results = self.step_results.write().unwrap();
    results.insert(step_id.clone(), result);

    info!(
        step_id = %step_id,
        "âœ… æ­¥éª¤æ‰§è¡Œç»“æœå·²ä¿å­˜ï¼ˆåˆ†ç¦»å­˜å‚¨ï¼Œä¸æ··å…¥metadataï¼‰"
    );
}
```

**è·å–æ­¥éª¤ç»“æœï¼š**
```rust
// è·å–å®Œæ•´ç»“æœ
pub fn get_step_result(&self, step_id: &str) -> Option<StepExecutionResult>

// è·å–è¾“å‡ºJSON
pub fn get_step_output(&self, step_id: &str) -> Option<String>

// æ£€æŸ¥æ­¥éª¤æ˜¯å¦æˆåŠŸ
pub fn is_step_success(&self, step_id: &str) -> bool
```

---

## é˜¶æ®µå››ï¼šå‚æ•°è§£æä¸å ä½ç¬¦æ›¿æ¢

### 1. ParameterResolver æ ¸å¿ƒé€»è¾‘

**ä»£ç ä½ç½®ï¼š** [src/core/parameter_resolver.rs:312-437](../../src/core/parameter_resolver.rs#L312-L437)

**æ ¸å¿ƒæ–¹æ³•ï¼š**
```rust
pub fn resolve_parameters(
    step: &PlanStep,
    _tool_info: &ToolInfo,
    context: &ExecutionContext,
) -> HashMap<String, String>
```

**å·¥ä½œæµç¨‹ï¼š**

#### æ­¥éª¤1ï¼šè§£ææ­¥éª¤å®šä¹‰ä¸­çš„å‚æ•°

```rust
// ä» step.parametersï¼ˆJSONå­—ç¬¦ä¸²ï¼‰ä¸­æå–å‚æ•°
match serde_json::from_str::<serde_json::Value>(&step.parameters) {
    Ok(serde_json::Value::Object(params_obj)) => {
        for (key, json_value) in params_obj {
            // å°†JSONå€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²
            let value_str = Self::json_value_to_string(&json_value);

            // å¤„ç†å ä½ç¬¦
            let processed_value = Self::process_parameter_value(&value_str, context);

            parameters.insert(key, processed_value);
        }
    }
}
```

**æ”¯æŒçš„JSONå€¼ç±»å‹ï¼š** [src/core/parameter_resolver.rs:99-124](../../src/core/parameter_resolver.rs#L99-L124)
- String: ç›´æ¥è¿”å›
- Number: è½¬æ¢ä¸ºå­—ç¬¦ä¸²
- Boolean: è½¬æ¢ä¸º "true" / "false"
- Null: è½¬æ¢ä¸º "null"
- Array/Object: è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²

---

#### æ­¥éª¤2ï¼šå¤„ç†å‚æ•°å€¼ä¸­çš„å ä½ç¬¦

**ä»£ç ä½ç½®ï¼š** [src/core/parameter_resolver.rs:516-900](../../src/core/parameter_resolver.rs#L516-L900)

```rust
fn process_parameter_value(value: &str, context: &ExecutionContext) -> String
```

è¿™æ˜¯å ä½ç¬¦è§£æçš„æ ¸å¿ƒå‡½æ•°ï¼Œæ”¯æŒå¤šç§æ ¼å¼ã€‚

---

### 2. å ä½ç¬¦è¯†åˆ«ä¸å¤„ç†

#### å¤„ç†æµç¨‹å›¾

```
è¾“å…¥å‚æ•°å€¼
    â†“
æ£€æŸ¥æ˜¯å¦ä¸ºå ä½ç¬¦æ ¼å¼ï¼Ÿ
    â”œâ”€ æ˜¯ {{{...}}} â†’ æå–å†…å®¹ â†’ è§£ææ­¥éª¤è¾“å‡º
    â”œâ”€ æ˜¯ {{...}} â†’ æå–å†…å®¹ â†’ è§£ææ­¥éª¤è¾“å‡ºæˆ–metadata
    â”œâ”€ æ˜¯ ${...} â†’ æå–å†…å®¹ â†’ è§£ææ­¥éª¤è¾“å‡ºæˆ–metadata
    â”œâ”€ æ˜¯ step_X.output â†’ è·å–æ­¥éª¤Xçš„å®Œæ•´è¾“å‡º
    â”œâ”€ æ˜¯ metadata.key â†’ ä»initial_metadataè·å–
    â””â”€ å¦ â†’ ç›´æ¥è¿”å›åŸå€¼
```

---

### 3. å¤šç§å ä½ç¬¦æ ¼å¼æ”¯æŒ

#### æ ¼å¼1ï¼šä¸‰é‡å¤§æ‹¬å· `{{{step_id.outputs.field}}}`

**ä»£ç ä½ç½®ï¼š** [src/core/parameter_resolver.rs:528-640](../../src/core/parameter_resolver.rs#L528-L640)

**ç¤ºä¾‹ï¼š**
```json
{
  "model_info": "{{{step_02_get_model_info.outputs.model_info}}}"
}
```

**è§£æè¿‡ç¨‹ï¼š**
1. è¯†åˆ« `{{{...}}}` æ ¼å¼
2. æå–å†…å®¹ï¼š`step_02_get_model_info.outputs.model_info`
3. æ£€æŸ¥æ˜¯å¦åŒ…å« `.outputs.` æˆ– `.output.`
4. åˆ†ç¦»æ­¥éª¤IDå’Œå­—æ®µè·¯å¾„ï¼š
   - æ­¥éª¤IDï¼š`step_02_get_model_info`
   - å­—æ®µè·¯å¾„ï¼š`model_info`
5. ä» `context.get_step_output("step_02_get_model_info")` è·å–JSON
6. è§£æJSONï¼Œæå– `model_info` å­—æ®µ
7. è¿”å›å­—æ®µå€¼

---

#### æ ¼å¼2ï¼šåŒå¤§æ‹¬å· `{{step_id.field}}`

**ä»£ç ä½ç½®ï¼š** [src/core/parameter_resolver.rs:642-758](../../src/core/parameter_resolver.rs#L642-L758)

**ç¤ºä¾‹ï¼š**
```json
{
  "datasource_id": "{{step_1.datasource_id}}",
  "project_id": "{{metadata.project_id}}"
}
```

**è§£æè¿‡ç¨‹ï¼š**
1. è¯†åˆ« `{{...}}` æ ¼å¼
2. æå–å†…å®¹ï¼š`step_1.datasource_id`
3. **ä¼˜å…ˆçº§1**ï¼šæ£€æŸ¥æ˜¯å¦åŒ…å« `.outputs.` æˆ– `.output.`
   - å¦‚æœæ˜¯ï¼Œä»æ­¥éª¤è¾“å‡ºJSONä¸­æå–å­—æ®µ
4. **ä¼˜å…ˆçº§2**ï¼šå°è¯•é€šè¿‡æ­¥éª¤IDç›´æ¥æŸ¥æ‰¾
   - å¦‚æœåŒ…å« `.`ï¼Œåˆ†ç¦»æ­¥éª¤IDå’Œå­—æ®µå
   - ä» `context.get_step_output(step_id)` è·å–JSON
   - æå–æŒ‡å®šå­—æ®µ
5. **ä¼˜å…ˆçº§3**ï¼šä» `get_all_metadata()` ä¸­ç›´æ¥æŸ¥æ‰¾
   - å…ˆæŸ¥æ‰¾åŸå§‹é”®ï¼š`step_1.datasource_id`
   - å¦‚æœå¤±è´¥ï¼ŒæŸ¥æ‰¾åµŒå¥—é”®ï¼š`step_1_*_datasource_id`
6. è¿”å›æ‰¾åˆ°çš„å€¼

---

#### æ ¼å¼3ï¼šç¾å…ƒç¬¦å· `${step_id.output.field}`

**ä»£ç ä½ç½®ï¼š** [src/core/parameter_resolver.rs:760-862](../../src/core/parameter_resolver.rs#L760-L862)

**ç¤ºä¾‹ï¼š**
```json
{
  "data_source": "${step_1.output.datasource}"
}
```

**è§£æè¿‡ç¨‹ï¼š**
ä¸åŒå¤§æ‹¬å·ç±»ä¼¼ï¼Œæ”¯æŒï¼š
- `${step_id.output.field}` - ä»æ­¥éª¤è¾“å‡ºJSONæå–å­—æ®µ
- `${metadata_key}` - ä»metadataè·å–

---

#### æ ¼å¼4ï¼šç‚¹å·å¼•ç”¨ `step_X.output`

**ä»£ç ä½ç½®ï¼š** [src/core/parameter_resolver.rs:864-885](../../src/core/parameter_resolver.rs#L864-L885)

**ç¤ºä¾‹ï¼š**
```json
{
  "previous_data": "step_1.output"
}
```

**è§£æè¿‡ç¨‹ï¼š**
1. æ£€æŸ¥æ ¼å¼ï¼š`step_` å¼€å¤´ + `.output` ç»“å°¾
2. æå–æ­¥éª¤IDï¼š`step_1`
3. è°ƒç”¨ `context.get_step_output("step_1")`
4. è¿”å›å®Œæ•´çš„JSONå­—ç¬¦ä¸²

---

#### æ ¼å¼5ï¼šmetadata å¼•ç”¨ `metadata.key`

**ä»£ç ä½ç½®ï¼š** [src/core/parameter_resolver.rs:887-896](../../src/core/parameter_resolver.rs#L887-L896)

**ç¤ºä¾‹ï¼š**
```json
{
  "project_id": "metadata.project_id"
}
```

**è§£æè¿‡ç¨‹ï¼š**
1. è¯†åˆ« `metadata.` å‰ç¼€
2. æå–é”®åï¼š`project_id`
3. è°ƒç”¨ `context.get_metadata("project_id")`
4. è¿”å›å€¼

---

## é˜¶æ®µäº”ï¼šæ­¥éª¤é—´æ•°æ®æµè½¬

### 1. æ­¥éª¤è¾“å‡ºä¿å­˜

**æ‰§è¡Œä½ç½®ï¼š** Executor æ‰§è¡Œå®Œæ­¥éª¤å

**ä»£ç ä½ç½®ï¼š** [src/core/executor.rs](../../src/core/executor.rs)

```rust
// æ­¥éª¤æ‰§è¡Œå®Œæˆå
let step_result = StepResult {
    step_id: step.step_id.clone(),
    step_name: step.name.clone(),
    tool_id: tool_id.clone(),
    output: response.result,  // å·¥å…·è¿”å›çš„JSONå­—ç¬¦ä¸²
    is_success: true,
    ...
};

// ä¿å­˜åˆ°æ‰§è¡Œä¸Šä¸‹æ–‡
context.set_step_result(StepExecutionResult {
    step_id: step_result.step_id,
    step_name: step_result.step_name,
    tool_id: step_result.tool_id,
    output: step_result.output,
    is_success: step_result.is_success,
    error_message: step_result.error_message,
});
```

---

### 2. åŠ¨æ€å‚æ•°åŒæ­¥

**åº”ç”¨åœºæ™¯ï¼š** å½“å·¥å…·å®šä¹‰äº† `output_params` æ—¶ï¼Œè‡ªåŠ¨å°†è¾“å‡ºå­—æ®µåŒæ­¥åˆ° runtime_metadata

**æ ¸å¿ƒæ–¹æ³•ï¼š** [src/core/execution_context.rs:196-309](../../src/core/execution_context.rs#L196-L309)

```rust
context.sync_step_output_to_runtime_metadata(
    "step_1",
    &["datasource_id", "datasource_name"]
)?;
```

**å®ç°é€»è¾‘ï¼š**
1. ä» `step_results` è·å–æ­¥éª¤è¾“å‡ºJSON
2. è§£æJSONä¸º `serde_json::Value`
3. éå† `output_param_names`ï¼Œæå–å­—æ®µå€¼
4. å°†å­—æ®µå€¼å­˜å…¥ `runtime_metadata`ï¼š
   - `param_name`: åŸå§‹å­—æ®µå
   - `step_id_param_name`: å¸¦æ­¥éª¤IDå‰ç¼€

**æ—¥å¿—è¾“å‡ºï¼š**
```
âœ¨ å°†æ­¥éª¤è¾“å‡ºå‚æ•°åŠ¨æ€æ”¾å…¥runtime_metadata
   â”œâ”€ datasource_id â† "ds_001"
   â”œâ”€ step_1_datasource_id â† "ds_001"
   â”œâ”€ datasource_name â† "my_datasource"
   â””â”€ step_1_datasource_name â† "my_datasource"
âœ… æˆåŠŸåŒæ­¥ 2 ä¸ªå‚æ•°åˆ°è¿è¡Œæ—¶metadata
```

---

### 3. å‚æ•°è·å–ä¼˜å…ˆçº§

**ä»£ç ä½ç½®ï¼š** [src/core/execution_context.rs:93-130](../../src/core/execution_context.rs#L93-L130)

```rust
pub fn get_all_metadata(&self) -> HashMap<String, String> {
    // ä¼˜å…ˆçº§ï¼šruntime_metadata > initial_metadata > step_results

    let mut all_meta = self.initial_metadata.read().unwrap().clone();

    // æ·»åŠ è¿è¡Œæ—¶å…ƒæ•°æ®ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
    all_meta.extend(self.runtime_metadata.read().unwrap().clone());

    // æ·»åŠ æ‰€æœ‰æ­¥éª¤ç»“æœçš„é¡¶çº§å­—æ®µ
    for (step_id, result) in self.step_results.read().unwrap().iter() {
        if let Ok(output_json) = serde_json::from_str::<serde_json::Value>(&result.output) {
            if let Some(obj) = output_json.as_object() {
                for (key, value) in obj.iter() {
                    // ä¿å­˜ä¸º step_id_key æ ¼å¼
                    all_meta.insert(format!("{}_{}", step_id, key), value_str);
                    // åŒæ—¶ä¿å­˜åŸå§‹é”®åï¼ˆä¸è¦†ç›–runtime_metadataï¼‰
                    if !all_meta.contains_key(key) {
                        all_meta.insert(key.clone(), value_str);
                    }
                }
            }
        }
    }

    all_meta
}
```

**ä¼˜å…ˆçº§è¯´æ˜ï¼š**
1. **runtime_metadata**ï¼ˆæœ€é«˜ï¼‰ï¼šåŠ¨æ€åŒæ­¥çš„æ­¥éª¤è¾“å‡ºå‚æ•°
2. **initial_metadata**ï¼šä»»åŠ¡æäº¤æ—¶çš„åˆå§‹å‚æ•°
3. **step_results**ï¼ˆæœ€ä½ï¼‰ï¼šä»æ‰€æœ‰æ­¥éª¤è¾“å‡ºJSONè‡ªåŠ¨æå–çš„å­—æ®µ

---

## å®Œæ•´æ‰§è¡Œæµç¨‹ç¤ºä¾‹

### åœºæ™¯ï¼šå¤šæ­¥éª¤æ•°æ®å¤„ç†ä»»åŠ¡

**ä»»åŠ¡æè¿°ï¼š** æ·»åŠ æ•°æ®æº â†’ ä¸Šä¼ æ•°æ® â†’ æ•°æ®éªŒè¯

---

### æ­¥éª¤1ï¼šLLMç”Ÿæˆæ‰§è¡Œè®¡åˆ’

```json
{
  "plan_id": "plan_001",
  "description": "æ·»åŠ æ•°æ®æºå¹¶ä¸Šä¼ æ•°æ®è¿›è¡ŒéªŒè¯",
  "steps": [
    {
      "step_id": "step_1",
      "step_name": "æ·»åŠ æ•°æ®æº",
      "tool_id": "add_datasource",
      "parameters": {
        "project_id": "{{metadata.project_id}}",
        "datasource_name": "my_datasource"
      },
      "dependencies": [],
      "expected_output": "datasource_id",
      "data_input_source": "å…ƒæ•°æ®",
      "data_output_usage": "ä¾›step_2ä½¿ç”¨"
    },
    {
      "step_id": "step_2",
      "step_name": "ä¸Šä¼ æ•°æ®",
      "tool_id": "data_upload",
      "parameters": {
        "project_id": "{{metadata.project_id}}",
        "datasource_id": "{{step_1.datasource_id}}",
        "file_path": "{{metadata.file_path}}"
      },
      "dependencies": ["step_1"],
      "expected_output": "upload_status",
      "data_input_source": "å…ƒæ•°æ®å’Œstep_1è¾“å‡º",
      "data_output_usage": "ä¾›step_3ä½¿ç”¨"
    },
    {
      "step_id": "step_3",
      "step_name": "æ•°æ®éªŒè¯",
      "tool_id": "data_validation",
      "parameters": {
        "datasource_id": "{{step_1.datasource_id}}"
      },
      "dependencies": ["step_2"],
      "expected_output": "validation_result",
      "data_input_source": "step_1è¾“å‡º",
      "data_output_usage": "æœ€ç»ˆç»“æœ"
    }
  ]
}
```

---

### æ­¥éª¤2ï¼šåˆå§‹åŒ–æ‰§è¡Œä¸Šä¸‹æ–‡

```rust
let context = ExecutionContext::new("plan_001");

// åˆå§‹åŒ– initial_metadata
let mut metadata = HashMap::new();
metadata.insert("project_id".to_string(), "proj_123".to_string());
metadata.insert("file_path".to_string(), "/data/file.csv".to_string());
context.init_metadata(metadata);

// æ­¤æ—¶ï¼š
// initial_metadata = {
//   "project_id": "proj_123",
//   "file_path": "/data/file.csv"
// }
// runtime_metadata = {}
// step_results = {}
```

---

### æ­¥éª¤3ï¼šæ‰§è¡Œ step_1ï¼ˆæ·»åŠ æ•°æ®æºï¼‰

#### 3.1 å‚æ•°è§£æ

```rust
// step_1.parameters = {
//   "project_id": "{{metadata.project_id}}",
//   "datasource_name": "my_datasource"
// }

let parameters = ParameterResolver::resolve_parameters(step_1, tool_info, &context);

// è§£æè¿‡ç¨‹ï¼š
// 1. "project_id": "{{metadata.project_id}}"
//    â†’ è¯†åˆ«åŒå¤§æ‹¬å·å ä½ç¬¦
//    â†’ ä» get_all_metadata() æŸ¥æ‰¾ "metadata.project_id"
//    â†’ æœªæ‰¾åˆ°ï¼Œå°è¯•æŸ¥æ‰¾ "project_id"
//    â†’ ä» initial_metadata æ‰¾åˆ° "proj_123"
//    â†’ æ›¿æ¢ä¸º "proj_123"
//
// 2. "datasource_name": "my_datasource"
//    â†’ æ— å ä½ç¬¦ï¼Œç›´æ¥ä½¿ç”¨

// æœ€ç»ˆå‚æ•°ï¼š
// parameters = {
//   "project_id": "proj_123",
//   "datasource_name": "my_datasource"
// }
```

#### 3.2 æ‰§è¡Œå·¥å…·

```rust
let response = tool_client.execute_tool("add_datasource", parameters).await?;

// å·¥å…·è¿”å›ï¼š
// {
//   "success": true,
//   "datasource_id": "ds_001",
//   "datasource_name": "my_datasource",
//   "msg": "æ•°æ®æºæ·»åŠ æˆåŠŸ"
// }
```

#### 3.3 ä¿å­˜æ­¥éª¤ç»“æœ

```rust
context.set_step_result(StepExecutionResult {
    step_id: "step_1".to_string(),
    step_name: "æ·»åŠ æ•°æ®æº".to_string(),
    tool_id: "add_datasource".to_string(),
    output: r#"{"success": true, "datasource_id": "ds_001", "datasource_name": "my_datasource", "msg": "æ•°æ®æºæ·»åŠ æˆåŠŸ"}"#.to_string(),
    is_success: true,
    error_message: None,
});

// æ­¤æ—¶ï¼š
// step_results = {
//   "step_1": StepExecutionResult { output: "{...}" }
// }
```

#### 3.4 åŠ¨æ€åŒæ­¥å‚æ•°ï¼ˆå¯é€‰ï¼‰

```rust
// å¦‚æœå·¥å…·å®šä¹‰äº† output_params = ["datasource_id"]
context.sync_step_output_to_runtime_metadata(
    "step_1",
    &["datasource_id".to_string()]
)?;

// æ­¤æ—¶ï¼š
// runtime_metadata = {
//   "datasource_id": "ds_001",
//   "step_1_datasource_id": "ds_001"
// }
```

---

### æ­¥éª¤4ï¼šæ‰§è¡Œ step_2ï¼ˆä¸Šä¼ æ•°æ®ï¼‰

#### 4.1 å‚æ•°è§£æ

```rust
// step_2.parameters = {
//   "project_id": "{{metadata.project_id}}",
//   "datasource_id": "{{step_1.datasource_id}}",
//   "file_path": "{{metadata.file_path}}"
// }

let parameters = ParameterResolver::resolve_parameters(step_2, tool_info, &context);

// è§£æè¿‡ç¨‹ï¼š
// 1. "project_id": "{{metadata.project_id}}"
//    â†’ ä» initial_metadata è·å– "proj_123"
//
// 2. "datasource_id": "{{step_1.datasource_id}}"
//    â†’ è¯†åˆ«åŒå¤§æ‹¬å·å ä½ç¬¦
//    â†’ æå–ï¼šstep_id="step_1", field="datasource_id"
//    â†’ æ–¹å¼1ï¼šä» runtime_metadata æŸ¥æ‰¾ "datasource_id" â†’ æ‰¾åˆ° "ds_001"
//    â†’ æˆ–æ–¹å¼2ï¼šä» step_results["step_1"] çš„è¾“å‡ºJSONæå– "datasource_id"
//    â†’ æ›¿æ¢ä¸º "ds_001"
//
// 3. "file_path": "{{metadata.file_path}}"
//    â†’ ä» initial_metadata è·å– "/data/file.csv"

// æœ€ç»ˆå‚æ•°ï¼š
// parameters = {
//   "project_id": "proj_123",
//   "datasource_id": "ds_001",
//   "file_path": "/data/file.csv"
// }
```

#### 4.2 æ‰§è¡Œå·¥å…·å¹¶ä¿å­˜ç»“æœ

```rust
let response = tool_client.execute_tool("data_upload", parameters).await?;

// å·¥å…·è¿”å›ï¼š
// {
//   "success": true,
//   "upload_id": "upload_001",
//   "record_count": 1000,
//   "msg": "æ•°æ®ä¸Šä¼ æˆåŠŸ"
// }

context.set_step_result(StepExecutionResult {
    step_id: "step_2".to_string(),
    output: r#"{"success": true, "upload_id": "upload_001", "record_count": 1000}"#.to_string(),
    is_success: true,
    ...
});
```

---

### æ­¥éª¤5ï¼šæ‰§è¡Œ step_3ï¼ˆæ•°æ®éªŒè¯ï¼‰

#### 5.1 å‚æ•°è§£æ

```rust
// step_3.parameters = {
//   "datasource_id": "{{step_1.datasource_id}}"
// }

let parameters = ParameterResolver::resolve_parameters(step_3, tool_info, &context);

// è§£æè¿‡ç¨‹ï¼š
// "datasource_id": "{{step_1.datasource_id}}"
// â†’ ä» runtime_metadata æŸ¥æ‰¾ "datasource_id" â†’ æ‰¾åˆ° "ds_001"
// â†’ æ›¿æ¢ä¸º "ds_001"

// æœ€ç»ˆå‚æ•°ï¼š
// parameters = {
//   "datasource_id": "ds_001"
// }
```

#### 5.2 æ‰§è¡Œå·¥å…·å¹¶ä¿å­˜ç»“æœ

```rust
let response = tool_client.execute_tool("data_validation", parameters).await?;

// å·¥å…·è¿”å›ï¼š
// {
//   "success": true,
//   "validation_status": "passed",
//   "error_count": 0,
//   "msg": "æ•°æ®éªŒè¯é€šè¿‡"
// }

context.set_step_result(StepExecutionResult {
    step_id: "step_3".to_string(),
    output: r#"{"success": true, "validation_status": "passed", "error_count": 0}"#.to_string(),
    is_success: true,
    ...
});
```

---

### æœ€ç»ˆçŠ¶æ€

```rust
// ExecutionContext æœ€ç»ˆçŠ¶æ€ï¼š

// initial_metadataï¼ˆä¸å˜ï¼‰
{
  "project_id": "proj_123",
  "file_path": "/data/file.csv"
}

// runtime_metadataï¼ˆåŠ¨æ€ç´¯ç§¯ï¼‰
{
  "datasource_id": "ds_001",
  "step_1_datasource_id": "ds_001"
}

// step_resultsï¼ˆå®Œæ•´ä¿ç•™ï¼‰
{
  "step_1": StepExecutionResult {
    output: r#"{"success": true, "datasource_id": "ds_001", ...}"#
  },
  "step_2": StepExecutionResult {
    output: r#"{"success": true, "upload_id": "upload_001", ...}"#
  },
  "step_3": StepExecutionResult {
    output: r#"{"success": true, "validation_status": "passed", ...}"#
  }
}
```

---

## ä»£ç å®ç°ç´¢å¼•

### æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶ | åŠŸèƒ½ | å…³é”®ä»£ç è¡Œ |
|------|------|----------|
| [src/llm/prompts.rs](../../src/llm/prompts.rs) | æç¤ºè¯å®šä¹‰ | 210-351ï¼ˆè§„åˆ’æç¤ºè¯ï¼‰<br>263-264ï¼ˆæ•°æ®æµæ ‡æ³¨ï¼‰ |
| [src/core/execution_context.rs](../../src/core/execution_context.rs) | æ‰§è¡Œä¸Šä¸‹æ–‡ | 29-50ï¼ˆç»“æ„å®šä¹‰ï¼‰<br>196-309ï¼ˆåŠ¨æ€å‚æ•°åŒæ­¥ï¼‰<br>93-130ï¼ˆå‚æ•°è·å–ä¼˜å…ˆçº§ï¼‰ |
| [src/core/parameter_resolver.rs](../../src/core/parameter_resolver.rs) | å‚æ•°è§£æå™¨ | 312-437ï¼ˆresolve_parametersï¼‰<br>516-900ï¼ˆprocess_parameter_valueï¼‰<br>99-124ï¼ˆJSONå€¼è½¬æ¢ï¼‰ |
| [src/core/executor.rs](../../src/core/executor.rs) | æ­¥éª¤æ‰§è¡Œå™¨ | 760-870ï¼ˆexecute_single_step_with_overridesï¼‰<br>812-816ï¼ˆè°ƒç”¨å‚æ•°è§£æå™¨ï¼‰ |
| [src/core/orchestrator.rs](../../src/core/orchestrator.rs) | ä»»åŠ¡ç¼–æ’å™¨ | 1179ï¼ˆå‘é€æ­¥éª¤å¼€å§‹äº‹ä»¶ï¼‰<br>1182-1190ï¼ˆæ‰§è¡Œæ­¥éª¤ï¼‰ |

### å…³é”®æ–¹æ³•

| æ–¹æ³• | ä½ç½® | åŠŸèƒ½ |
|------|------|------|
| `ExecutionContext::new()` | execution_context.rs:54-62 | åˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡ |
| `init_metadata()` | execution_context.rs:64-81 | åˆå§‹åŒ–åˆå§‹å…ƒæ•°æ® |
| `set_step_result()` | execution_context.rs:132-152 | ä¿å­˜æ­¥éª¤ç»“æœ |
| `sync_step_output_to_runtime_metadata()` | execution_context.rs:196-309 | åŠ¨æ€åŒæ­¥å‚æ•° |
| `get_all_metadata()` | execution_context.rs:93-130 | è·å–æ‰€æœ‰å…ƒæ•°æ® |
| `ParameterResolver::resolve_parameters()` | parameter_resolver.rs:312-437 | è§£ææ­¥éª¤å‚æ•° |
| `process_parameter_value()` | parameter_resolver.rs:516-900 | å¤„ç†å ä½ç¬¦ |
| `json_value_to_string()` | parameter_resolver.rs:113-124 | JSONå€¼è½¬å­—ç¬¦ä¸² |

---

## æœ€ä½³å®è·µ

### 1. æç¤ºè¯è®¾è®¡

âœ… **æ˜ç¡®æ ‡æ³¨æ•°æ®æµ**
```json
{
  "data_input_source": "step_1è¾“å‡º",
  "data_output_usage": "ä¾›step_2ä½¿ç”¨"
}
```

âœ… **ä½¿ç”¨æ¸…æ™°çš„ä¾èµ–å…³ç³»**
```json
{
  "dependencies": ["step_1", "step_2"]  // æ˜ç¡®ä¾èµ–
}
```

âœ… **å‚æ•°å ä½ç¬¦ä½¿ç”¨ç»Ÿä¸€æ ¼å¼**
```json
{
  "datasource_id": "{{step_1.datasource_id}}"  // æ¨èæ ¼å¼
}
```

âŒ **é¿å…æ¨¡ç³Šå¼•ç”¨**
```json
{
  "data": "å‰é¢æ­¥éª¤çš„è¾“å‡º"  // ä¸æ˜ç¡®ï¼Œéš¾ä»¥è§£æ
}
```

---

### 2. æ‰§è¡Œä¸Šä¸‹æ–‡ç®¡ç†

âœ… **åŠæ—¶åŒæ­¥å…³é”®å‚æ•°**
```rust
// æ­¥éª¤æ‰§è¡ŒæˆåŠŸå
context.sync_step_output_to_runtime_metadata(
    &step_id,
    &["datasource_id", "model_id"]  // æ˜ç¡®éœ€è¦æµè½¬çš„å­—æ®µ
)?;
```

âœ… **æ£€æŸ¥æ­¥éª¤æ‰§è¡ŒçŠ¶æ€**
```rust
if context.is_step_success(&step_id) {
    // åªæœ‰æˆåŠŸæ‰åŒæ­¥å‚æ•°
    context.sync_step_output_to_runtime_metadata(...)?;
}
```

âŒ **é¿å…æ±¡æŸ“åˆå§‹å…ƒæ•°æ®**
```rust
// é”™è¯¯ï¼šä¿®æ”¹initial_metadata
// initial_metadataæ˜¯åªè¯»çš„ï¼Œåº”è¯¥ä½¿ç”¨runtime_metadata
```

---

### 3. å‚æ•°å ä½ç¬¦

âœ… **ä½¿ç”¨åµŒå¥—è·¯å¾„æå–**
```json
{
  "model_info": "{{step_2.output.result.model_info}}"
}
```

âœ… **åŒºåˆ†ä¸åŒæ¥æº**
```json
{
  "project_id": "{{metadata.project_id}}",  // åˆå§‹å…ƒæ•°æ®
  "datasource_id": "{{step_1.datasource_id}}"  // æ­¥éª¤è¾“å‡º
}
```

âœ… **å¤„ç†å¤æ‚ç±»å‹**
```json
{
  "device_list": "{{step_1.output}}"  // æ•´ä¸ªè¾“å‡ºå¯¹è±¡
}
```

---

### 4. ä¾èµ–å…³ç³»è®¾è®¡

âœ… **æ­£ç¡®è®¾ç½®ä¾èµ–**
```json
{
  "step_id": "step_3",
  "dependencies": ["step_1", "step_2"],  // step_3ä¾èµ–1å’Œ2
  "parameters": {
    "data_a": "{{step_1.result}}",
    "data_b": "{{step_2.result}}"
  }
}
```

âœ… **æ”¯æŒå¹¶è¡Œæ‰§è¡Œ**
```json
// step_2 å’Œ step_3 éƒ½åªä¾èµ– step_1ï¼Œå¯ä»¥å¹¶è¡Œ
[
  {"step_id": "step_1", "dependencies": []},
  {"step_id": "step_2", "dependencies": ["step_1"]},
  {"step_id": "step_3", "dependencies": ["step_1"]}
]
```

âŒ **é¿å…å¾ªç¯ä¾èµ–**
```json
// é”™è¯¯ç¤ºä¾‹
[
  {"step_id": "step_1", "dependencies": ["step_2"]},
  {"step_id": "step_2", "dependencies": ["step_1"]}  // å¾ªç¯ä¾èµ–ï¼
]
```

---

## å¸¸è§é—®é¢˜

### Q1: å‚æ•°å ä½ç¬¦æ²¡æœ‰è¢«è§£ææ€ä¹ˆåŠï¼Ÿ

**å¯èƒ½åŸå› ï¼š**
1. å‰ç½®æ­¥éª¤æœªæˆåŠŸæ‰§è¡Œ
2. å ä½ç¬¦æ ¼å¼é”™è¯¯
3. å­—æ®µåæ‹¼å†™é”™è¯¯
4. å‰ç½®æ­¥éª¤è¾“å‡ºJSONç»“æ„ä¸åŒ¹é…

**è§£å†³æ–¹æ³•ï¼š**
```rust
// 1. æ£€æŸ¥å‰ç½®æ­¥éª¤æ˜¯å¦æˆåŠŸ
if !context.is_step_success("step_1") {
    warn!("å‰ç½®æ­¥éª¤step_1æœªæˆåŠŸï¼Œæ— æ³•è·å–è¾“å‡º");
}

// 2. æŸ¥çœ‹æ—¥å¿—ä¸­çš„å ä½ç¬¦è§£æè¿‡ç¨‹
// æ—¥å¿—å…³é”®å­—ï¼š
// - "ğŸ” æ£€æµ‹åˆ°åŒå¤§æ‹¬å·å ä½ç¬¦"
// - "âœ… ä»æ­¥éª¤è¾“å‡ºJSONç›´æ¥æå–å­—æ®µå€¼"
// - "âš ï¸  åŒå¤§æ‹¬å·å ä½ç¬¦åœ¨metadataä¸­æ‰¾ä¸åˆ°å¯¹åº”å€¼"

// 3. æ‰‹åŠ¨éªŒè¯æ­¥éª¤è¾“å‡º
let output = context.get_step_output("step_1");
println!("step_1è¾“å‡º: {:?}", output);
```

---

### Q2: å¦‚ä½•è°ƒè¯•å‚æ•°è§£æè¿‡ç¨‹ï¼Ÿ

**æ–¹æ³•1ï¼šæŸ¥çœ‹æ—¥å¿—**
```bash
# å¯ç”¨debugæ—¥å¿—
RUST_LOG=debug cargo run

# å…³é”®æ—¥å¿—æ ‡è¯†ï¼š
# - "ğŸ” å¼€å§‹è§£æå‚æ•°"
# - "ğŸ“ æ­¥éª¤å®šä¹‰ä¸­çš„å‚æ•°æ•°é‡"
# - "âœ… å‚æ•°å·²è§£æ"
# - "ğŸ“‹ æœ€ç»ˆä¼ é€’ç»™å·¥å…·çš„å‚æ•°åˆ—è¡¨"
```

**æ–¹æ³•2ï¼šæŸ¥çœ‹å‚æ•°æ–‡ä»¶**ï¼ˆå¦‚æœå¯ç”¨ï¼‰
```bash
# å‚æ•°ä¼šä¿å­˜åˆ°æ–‡ä»¶ï¼ˆå¦‚æœå¯ç”¨äº†å‚æ•°ä¿å­˜åŠŸèƒ½ï¼‰
cat /tmp/executor_params/step_1_parameters.json
```

**æ–¹æ³•3ï¼šä½¿ç”¨ get_all_metadata()**
```rust
let all_meta = context.get_all_metadata();
for (key, value) in all_meta.iter() {
    println!("{} = {}", key, value);
}
```

---

### Q3: å¦‚ä½•å¤„ç†åµŒå¥—JSONå­—æ®µï¼Ÿ

**ä½¿ç”¨ç‚¹å·åˆ†éš”çš„è·¯å¾„ï¼š**
```json
{
  "nested_field": "{{step_1.output.result.data.field_name}}"
}
```

**ä»£ç å®ç°æ”¯æŒï¼š** [parameter_resolver.rs:464-513](../../src/core/parameter_resolver.rs#L464-L513)

```rust
// æ”¯æŒåµŒå¥—è·¯å¾„ï¼Œå¦‚ "result.data.field_name"
let mut current = &json_value;
for key in field_path.split('.') {
    if let Some(next) = current.get(key) {
        current = next;
    } else {
        return None;
    }
}
```

---

### Q4: æ­¥éª¤è¾“å‡ºçš„å­—æ®µå¦‚ä½•è‡ªåŠ¨æµè½¬ï¼Ÿ

**ä½¿ç”¨ `sync_step_output_to_runtime_metadata()`ï¼š**

```rust
// æ­¥éª¤æ‰§è¡ŒæˆåŠŸå
context.sync_step_output_to_runtime_metadata(
    "step_1",
    &["datasource_id".to_string(), "model_id".to_string()]
)?;

// åç»­æ­¥éª¤å¯ä»¥ç›´æ¥é€šè¿‡å­—æ®µåå¼•ç”¨
// "datasource_id": "{{datasource_id}}"
// è€Œä¸éœ€è¦ï¼š
// "datasource_id": "{{step_1.datasource_id}}"
```

**ä¼˜åŠ¿ï¼š**
- âœ… ç®€åŒ–åç»­æ­¥éª¤çš„å‚æ•°å®šä¹‰
- âœ… è‡ªåŠ¨å¤„ç†å­—æ®µåå†²çªï¼ˆé€šè¿‡step_idå‰ç¼€ï¼‰
- âœ… æ”¯æŒå‚æ•°è¦†ç›–ï¼ˆruntime_metadataä¼˜å…ˆçº§æœ€é«˜ï¼‰

---

### Q5: å¦‚ä½•å¤„ç†æ­¥éª¤æ‰§è¡Œå¤±è´¥çš„æƒ…å†µï¼Ÿ

**æ£€æŸ¥æœºåˆ¶ï¼š**
```rust
// 1. æ£€æŸ¥æ­¥éª¤æ˜¯å¦æˆåŠŸ
if !context.is_step_success("step_1") {
    // æ­¥éª¤å¤±è´¥ï¼Œä¸è¿›è¡Œå‚æ•°åŒæ­¥
    return Err("å‰ç½®æ­¥éª¤å¤±è´¥".to_string());
}

// 2. åœ¨sync_step_output_to_runtime_metadataä¸­è‡ªåŠ¨æ£€æŸ¥
// å¦‚æœæ­¥éª¤å¤±è´¥ï¼Œä¼šè¿”å›é”™è¯¯
if !step_result.is_success {
    return Err(format!("æ­¥éª¤æ‰§è¡Œå¤±è´¥ï¼Œæ— æ³•åŒæ­¥è¾“å‡ºå‚æ•°: {}", step_id));
}
```

**å¤„ç†ç­–ç•¥ï¼š**
- âŒ æ­¥éª¤å¤±è´¥ â†’ ä¸åŒæ­¥å‚æ•°åˆ°runtime_metadata
- âŒ æ­¥éª¤å¤±è´¥ â†’ ä¾èµ–è¯¥æ­¥éª¤çš„åç»­æ­¥éª¤ä¼šå› ç¼ºå°‘å‚æ•°è€Œå¤±è´¥
- âœ… é€šè¿‡åæ€æœºåˆ¶é‡æ–°è§„åˆ’æˆ–é‡è¯•å¤±è´¥æ­¥éª¤

---

## æ€»ç»“

é¡¹ç›®é€šè¿‡**æç¤ºè¯å¼•å¯¼ + æ‰§è¡Œä¸Šä¸‹æ–‡ + å‚æ•°è§£æå™¨**ä¸‰å±‚æ¶æ„ï¼Œå®ç°äº†çµæ´»å¼ºå¤§çš„å¤šæ­¥éª¤æ•°æ®æµè½¬æœºåˆ¶ï¼š

1. **æç¤ºè¯å±‚**ï¼šå®šä¹‰ä¾èµ–å…³ç³»å’Œå ä½ç¬¦çº¦å®š
2. **ä¸Šä¸‹æ–‡å±‚**ï¼šç»´æŠ¤ä¸‰å±‚å…ƒæ•°æ®ç»“æ„ï¼Œæ”¯æŒåŠ¨æ€å‚æ•°æµè½¬
3. **è§£æå™¨å±‚**ï¼šè¯†åˆ«å¤šç§å ä½ç¬¦æ ¼å¼ï¼Œè‡ªåŠ¨æ›¿æ¢ä¸ºå®é™…å€¼

**æ ¸å¿ƒä¼˜åŠ¿ï¼š**
- âœ… æ”¯æŒå¤æ‚çš„å¤šæ­¥éª¤ä»»åŠ¡
- âœ… çµæ´»çš„å‚æ•°å¼•ç”¨æ–¹å¼
- âœ… æ¸…æ™°çš„æ•°æ®æµè¿½æº¯
- âœ… è‡ªåŠ¨åŒ–çš„å‚æ•°ä¼ é€’
- âœ… ä¼˜é›…çš„é”™è¯¯å¤„ç†

---

**æ–‡æ¡£ç»´æŠ¤ï¼š** è¯·åœ¨ä¿®æ”¹ç›¸å…³å®ç°æ—¶åŒæ­¥æ›´æ–°æœ¬æ–‡æ¡£ã€‚

**ç›¸å…³æ–‡æ¡£ï¼š**
- [Useræ¨¡å¼ä¸‹æœåŠ¡ç«¯äº‹ä»¶æ¨é€æœºåˆ¶è¯¦è§£](./Useræ¨¡å¼ä¸‹æœåŠ¡ç«¯äº‹ä»¶æ¨é€æœºåˆ¶è¯¦è§£.md)
- [æ‰§è¡Œä¸Šä¸‹æ–‡æºç ](../../src/core/execution_context.rs)
- [å‚æ•°è§£æå™¨æºç ](../../src/core/parameter_resolver.rs)
- [æç¤ºè¯å®šä¹‰](../../src/llm/prompts.rs)
