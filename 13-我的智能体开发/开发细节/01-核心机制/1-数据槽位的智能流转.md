# æ•°æ®æ§½ä½çš„æ™ºèƒ½æµè½¬

## æ¦‚è¿°

æ•°æ®æ§½ä½çš„æ™ºèƒ½æµè½¬æ˜¯ä»»åŠ¡ç¼–æ’æœåŠ¡çš„æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€ï¼Œè´Ÿè´£åœ¨å¤šæ­¥éª¤æ‰§è¡Œè¿‡ç¨‹ä¸­è‡ªåŠ¨ç®¡ç†å’Œä¼ é€’æ•°æ®ã€‚è¯¥æœºåˆ¶ç¡®ä¿å‰ç½®æ­¥éª¤çš„è¾“å‡ºèƒ½å¤Ÿæ­£ç¡®åœ°æµè½¬åˆ°åç»­æ­¥éª¤çš„è¾“å…¥ï¼Œå®ç°æ­¥éª¤é—´çš„æ•°æ®ä¾èµ–å’Œå‚æ•°ä¼ é€’ã€‚

## æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 1. ä¸‰å±‚æ•°æ®å­˜å‚¨æ¶æ„

ç³»ç»Ÿé‡‡ç”¨ä¸‰å±‚æ•°æ®å­˜å‚¨æ¶æ„ï¼Œå®ç°æ•°æ®çš„åˆ†ç¦»å­˜å‚¨å’Œæ™ºèƒ½æµè½¬ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ExecutionContext (æ‰§è¡Œä¸Šä¸‹æ–‡)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ 1. initial_metadata (åˆå§‹å…ƒæ•°æ®)               â”‚    â”‚
â”‚  â”‚    - ä»»åŠ¡æäº¤æ—¶çš„å…¨å±€æ•°æ®                      â”‚    â”‚
â”‚  â”‚    - åªè¯»ï¼Œä¸ä¿®æ”¹                              â”‚    â”‚
â”‚  â”‚    - ç¤ºä¾‹: project_id, file_path, city_name   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ 2. runtime_metadata (è¿è¡Œæ—¶å…ƒæ•°æ®)             â”‚    â”‚
â”‚  â”‚    - åŠ¨æ€æµè½¬ï¼Œä»æ­¥éª¤è¾“å‡ºä¸­æå–çš„å…³é”®å‚æ•°      â”‚    â”‚
â”‚  â”‚    - ç”¨äºä¼ é€’ç»™åç»­æ­¥éª¤                        â”‚    â”‚
â”‚  â”‚    - ç¤ºä¾‹: datasource_id, model_id            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ 3. step_results (æ­¥éª¤æ‰§è¡Œç»“æœ)                 â”‚    â”‚
â”‚  â”‚    - åˆ†ç¦»å­˜å‚¨ï¼Œå®Œæ•´ä¿ç•™æ¯ä¸ªæ­¥éª¤çš„è¾“å‡º          â”‚    â”‚
â”‚  â”‚    - é”®: step_id, å€¼: StepExecutionResult     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ•°æ®æµè½¬ä¼˜å…ˆçº§

å‚æ•°è§£ææ—¶çš„ä¼˜å…ˆçº§é¡ºåºï¼š

```
runtime_metadata > initial_metadata > step_results
```

## æ ¸å¿ƒæµç¨‹

### æµç¨‹å›¾

```mermaid
graph TD
    A[ä»»åŠ¡å¼€å§‹] --> B[åˆå§‹åŒ– ExecutionContext]
    B --> C[åŠ è½½ initial_metadata]
    C --> D{éå†æ‰§è¡Œæ­¥éª¤}
    
    D --> E[æ­¥éª¤ N å¼€å§‹æ‰§è¡Œ]
    E --> F[å‚æ•°è§£æå™¨è§£æå‚æ•°]
    
    F --> G{å‚æ•°æ¥æºåˆ¤æ–­}
    G -->|æ­¥éª¤å®šä¹‰| H[ä» step.parameters æå–]
    G -->|å‰ç½®æ­¥éª¤è¾“å‡º| I[ä» step_results æå–]
    G -->|å…¨å±€å…ƒæ•°æ®| J[ä» initial_metadata æå–]
    G -->|è¿è¡Œæ—¶å…ƒæ•°æ®| K[ä» runtime_metadata æå–]
    
    H --> L[å¤„ç†å ä½ç¬¦]
    I --> L
    J --> L
    K --> L
    
    L --> M[æ‰§è¡Œå·¥å…·è°ƒç”¨]
    M --> N{æ‰§è¡ŒæˆåŠŸ?}
    
    N -->|æ˜¯| O[ä¿å­˜åˆ° step_results]
    O --> P[æ ¹æ® output_params å®šä¹‰æå–å…³é”®å­—æ®µ]
    P --> Q[åŒæ­¥åˆ° runtime_metadata]
    Q --> R{è¿˜æœ‰åç»­æ­¥éª¤?}
    
    N -->|å¦| S[è®°å½•é”™è¯¯ä¿¡æ¯]
    S --> R
    
    R -->|æ˜¯| D
    R -->|å¦| T[ä»»åŠ¡å®Œæˆ]
    
    style B fill:#e1f5ff
    style P fill:#fff4e1
    style Q fill:#e8f5e9
    style M fill:#f3e5f5
```

### è¯¦ç»†æ­¥éª¤è¯´æ˜

#### æ­¥éª¤1: åˆå§‹åŒ–æ‰§è¡Œä¸Šä¸‹æ–‡

**æ–‡ä»¶ä½ç½®**: `src/core/execution_context.rs`

**ä»£ç ä½ç½®**: `ExecutionContext::new()` å’Œ `init_metadata()`

```rust
// ç¬¬ 54-81 è¡Œ
pub fn new(plan_id: String) -> Self {
    Self {
        initial_metadata: Arc::new(RwLock::new(HashMap::new())),
        runtime_metadata: Arc::new(RwLock::new(HashMap::new())),
        step_results: Arc::new(RwLock::new(HashMap::new())),
        plan_id: Arc::new(RwLock::new(plan_id)),
    }
}

pub fn init_metadata(&self, metadata: HashMap<String, String>) {
    let mut meta = self.initial_metadata.write().unwrap();
    meta.clear();
    meta.extend(metadata);
}
```

**åŠŸèƒ½**: åˆ›å»ºä¸‰å±‚æ•°æ®å­˜å‚¨ç»“æ„ï¼Œåˆå§‹åŒ–å…¨å±€å…ƒæ•°æ®ã€‚

#### æ­¥éª¤2: å‚æ•°è§£æ

**æ–‡ä»¶ä½ç½®**: `src/core/parameter_resolver.rs`

**ä»£ç ä½ç½®**: `ParameterResolver::resolve_parameters()` (ç¬¬ 312-437 è¡Œ)

**æ ¸å¿ƒé€»è¾‘**:
1. ä»æ­¥éª¤å®šä¹‰çš„ `parameters` å­—æ®µè§£æ JSON
2. å¤„ç†å ä½ç¬¦å¼•ç”¨ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
3. ä»æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­æå–å®é™…å€¼

**æ”¯æŒçš„å ä½ç¬¦æ ¼å¼**:
- `{{{step_id.outputs.field}}}` - ä¸‰é‡å¤§æ‹¬å·ï¼ˆHandlebarsé£æ ¼ï¼ŒLLMå¸¸ç”¨ï¼‰
- `{{step_id.outputs.field}}` - ä»æ­¥éª¤è¾“å‡ºJSONæå–å­—æ®µ
- `{{step_id.output.field}}` - åŒä¸Šï¼ˆå…¼å®¹æ ¼å¼ï¼‰
- `{{step_id.field}}` - ä»metadataæˆ–æ­¥éª¤è¾“å‡ºæå–
- `${step_id.output.field}` - æ¨¡æ¿å ä½ç¬¦æ ¼å¼

**ä»£ç ç¤ºä¾‹**:
```rust
// ç¬¬ 312-437 è¡Œ
pub fn resolve_parameters(
    step: &PlanStep,
    _tool_info: &ToolInfo,
    context: &ExecutionContext,
) -> HashMap<String, String> {
    let mut parameters = HashMap::new();
    
    // è§£ææ­¥éª¤å®šä¹‰ä¸­çš„å‚æ•°
    match serde_json::from_str::<serde_json::Value>(&step.parameters) {
        Ok(serde_json::Value::Object(params_obj)) => {
            for (key, json_value) in params_obj {
                let value_str = Self::json_value_to_string(&json_value);
                let processed_value = Self::process_parameter_value(&value_str, context);
                parameters.insert(key, processed_value);
            }
        }
        // ...
    }
    
    parameters
}
```

#### æ­¥éª¤3: å ä½ç¬¦å¤„ç†

**æ–‡ä»¶ä½ç½®**: `src/core/parameter_resolver.rs`

**ä»£ç ä½ç½®**: `process_parameter_value()` (ç¬¬ 526-722 è¡Œ)

**å¤„ç†é€»è¾‘**:
```rust
// ç¬¬ 527-785 è¡Œ
fn process_parameter_value(value: &str, context: &ExecutionContext) -> String {
    // ğŸ”‘ å¤„ç† {{{...}}} ä¸‰é‡å¤§æ‹¬å·å ä½ç¬¦ï¼ˆHandlebarsé£æ ¼ï¼ŒLLMå¸¸ç”¨ï¼‰
    if let Some(placeholder_content) = value.strip_prefix("{{{").and_then(|s| s.strip_suffix("}}}")) {
        // ä½¿ç”¨ä¸åŒå¤§æ‹¬å·ç›¸åŒçš„å¤„ç†é€»è¾‘
        // å°è¯•ä»æ­¥éª¤è¾“å‡ºä¸­æå–
        if placeholder_content.contains(".outputs.") {
            // æå– step_id.outputs.field_path
            // ...
        }
        
        // å°è¯•ä»metadataä¸­æŸ¥æ‰¾
        if let Some(meta_value) = context.get_all_metadata().get(placeholder_content) {
            return meta_value.clone();
        }
    }
    
    // å¤„ç† {{...}} åŒå¤§æ‹¬å·å ä½ç¬¦
    if let Some(placeholder_content) = value.strip_prefix("{{").and_then(|s| s.strip_suffix("}}")) {
        // å°è¯•ä»æ­¥éª¤è¾“å‡ºä¸­æå–
        if placeholder_content.contains(".outputs.") {
            // æå– step_id.outputs.field_path
            // ...
        }
        
        // å°è¯•ä»metadataä¸­æŸ¥æ‰¾
        if let Some(meta_value) = context.get_all_metadata().get(placeholder_content) {
            return meta_value.clone();
        }
    }
    
    // å¤„ç† ${...} æ¨¡æ¿å ä½ç¬¦
    // ...
    
    // æ™®é€šå€¼ç›´æ¥è¿”å›
    value.to_string()
}
```

#### æ­¥éª¤4: æ‰§è¡Œå·¥å…·å¹¶ä¿å­˜ç»“æœ

**æ–‡ä»¶ä½ç½®**: `src/core/executor.rs`

**ä»£ç ä½ç½®**: `execute_plan_with_context()` (ç¬¬ 102-537 è¡Œ)

**æ ¸å¿ƒä»£ç **:
```rust
// ç¬¬ 318-389 è¡Œ
match self.execute_step(&plan.plan_id, step, &parameters, Some(&context)).await {
    Ok(result) => {
        if result.is_success {
            // å°†ç»“æœä¿å­˜åˆ°æ‰§è¡Œä¸Šä¸‹æ–‡
            let context_result = ExecutionContextStepResult {
                step_id: result.step_id.clone(),
                step_name: result.step_name.clone(),
                tool_id: result.tool_id.clone(),
                output: result.output.clone(),
                is_success: result.is_success,
                error_message: result.error_message.clone(),
            };
            context.set_step_result(context_result);
            
            // æµè½¬metadataï¼ˆè§æ­¥éª¤5ï¼‰
            // ...
        }
    }
    // ...
}
```

#### æ­¥éª¤5: æ™ºèƒ½æµè½¬åˆ°runtime_metadataï¼ˆæ ¸å¿ƒæœºåˆ¶ï¼‰

**æ–‡ä»¶ä½ç½®**: `src/core/executor.rs`

**ä»£ç ä½ç½®**: ç¬¬ 390-485 è¡Œ

**æµè½¬ç­–ç•¥**:

```rust
// ç¬¬ 392-484 è¡Œ
if result.is_success {
    let mut param_names_to_sync: Vec<String> = Vec::new();
    
    // ç­–ç•¥1: ä»å·¥å…·çš„ output_params å®šä¹‰ä¸­è·å–å‚æ•°å
    if let Some(tool_info) = available_tools.iter().find(|t| t.id == step.tool) {
        if let Some(output_params_json) = &tool_info.output_params {
            match serde_json::from_str::<serde_json::Value>(output_params_json) {
                Ok(serde_json::Value::Object(output_map)) => {
                    param_names_to_sync = output_map.keys().cloned().collect();
                }
                // ...
            }
        }
    }
    
    // ç­–ç•¥2: å¦‚æœæ²¡æœ‰ output_params å®šä¹‰ï¼Œä»å®é™…è¾“å‡ºä¸­è‡ªåŠ¨æå–æ‰€æœ‰JSONé”®
    if param_names_to_sync.is_empty() {
        if let Ok(output_json) = serde_json::from_str::<serde_json::Value>(&result.output) {
            if let serde_json::Value::Object(output_map) = output_json {
                param_names_to_sync = output_map.keys().cloned().collect();
            }
        }
    }
    
    // æ‰§è¡Œæµè½¬
    if !param_names_to_sync.is_empty() {
        match context.sync_step_output_to_runtime_metadata(
            &step.step_id,
            &param_names_to_sync,
        ) {
            Ok(sync_count) => {
                info!("âœ… æˆåŠŸåŒæ­¥ {} ä¸ªè¾“å‡ºå‚æ•°åˆ°è¿è¡Œæ—¶metadata", sync_count);
            }
            // ...
        }
    }
}
```

#### æ­¥éª¤6: åŒæ­¥åˆ°runtime_metadataçš„å®ç°

**æ–‡ä»¶ä½ç½®**: `src/core/execution_context.rs`

**ä»£ç ä½ç½®**: `sync_step_output_to_runtime_metadata()` (ç¬¬ 196-309 è¡Œ)

**æ ¸å¿ƒå®ç°**:
```rust
// ç¬¬ 196-309 è¡Œ
pub fn sync_step_output_to_runtime_metadata(
    &self,
    step_id: &str,
    output_param_names: &[String],
) -> std::result::Result<usize, String> {
    // 1. è·å–æ­¥éª¤ç»“æœ
    let step_result = self.step_results
        .read()
        .unwrap()
        .get(step_id)
        .cloned()
        .ok_or_else(|| format!("æ­¥éª¤ç»“æœä¸å­˜åœ¨: {}", step_id))?;
    
    // 2. è§£ææ­¥éª¤è¾“å‡ºä¸ºJSON
    let output_json = serde_json::from_str::<serde_json::Value>(&step_result.output)?;
    
    let mut sync_count = 0;
    let mut runtime_meta = self.runtime_metadata.write().unwrap();
    
    // 3. æå–æŒ‡å®šå­—æ®µå¹¶æ”¾å…¥runtime_metadata
    if let Some(obj) = output_json.as_object() {
        for field_name in output_param_names {
            if let Some(value) = obj.get(field_name) {
                let value_str = match value {
                    serde_json::Value::String(s) => s.clone(),
                    serde_json::Value::Number(n) => n.to_string(),
                    serde_json::Value::Bool(b) => b.to_string(),
                    _ => serde_json::to_string(value)?,
                };
                
                // åŒæ—¶ç”¨step_idä½œå‰ç¼€å­˜å‚¨ï¼Œæ–¹ä¾¿è¿½è¸ª
                runtime_meta.insert(field_name.clone(), value_str.clone());
                runtime_meta.insert(format!("{}_{}", step_id, field_name), value_str.clone());
                
                sync_count += 1;
            }
        }
    }
    
    Ok(sync_count)
}
```

## å®é™…åº”ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: è´Ÿè·é¢„æµ‹æµç¨‹ä¸­çš„æ•°æ®æµè½¬

```
æ­¥éª¤1: add_datasource
  è¾“å…¥: project_id (æ¥è‡ª initial_metadata)
  è¾“å‡º: {"datasource_id": "ds_001", "datasource_name": "my_datasource"}
  æµè½¬: datasource_id â†’ runtime_metadata

æ­¥éª¤2: data_upload
  è¾“å…¥: 
    - project_id (æ¥è‡ª initial_metadata)
    - datasource_id (æ¥è‡ª runtime_metadataï¼Œç”±æ­¥éª¤1æµè½¬)
  è¾“å‡º: {"upload_status": "success"}

æ­¥éª¤3: get_data
  è¾“å…¥:
    - datasource_id (æ¥è‡ª runtime_metadata)
  è¾“å‡º: {"data_json": "[...]", "record_count": 1000}
  æµè½¬: data_json, record_count â†’ runtime_metadata
```

### ç¤ºä¾‹2: å ä½ç¬¦å¼•ç”¨æ–¹å¼

åœ¨è§„åˆ’é˜¶æ®µï¼ŒLLMå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å¼•ç”¨å‰ç½®æ­¥éª¤çš„è¾“å‡ºï¼š

```json
{
  "step_id": "step_3_get_data",
  "tool_id": "get_data",
  "parameters": {
    "datasource": "{{step_2_add_datasource.outputs.datasource_id}}"
  }
}
```

æ‰§è¡Œæ—¶ï¼Œå‚æ•°è§£æå™¨ä¼šï¼š
1. è¯†åˆ«å ä½ç¬¦ `{{step_2_add_datasource.outputs.datasource_id}}`
2. ä» `step_2_add_datasource` çš„è¾“å‡ºJSONä¸­æå– `datasource_id` å­—æ®µ
3. æ›¿æ¢ä¸ºå®é™…å€¼ï¼ˆå¦‚ `"ds_001"`ï¼‰

## å…³é”®ä»£ç æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | æ ¸å¿ƒåŠŸèƒ½ | å…³é”®æ–¹æ³•/è¡Œå· |
|---------|---------|--------------|
| `src/core/execution_context.rs` | æ‰§è¡Œä¸Šä¸‹æ–‡ç®¡ç† | `ExecutionContext::new()` (54-62è¡Œ)<br>`init_metadata()` (65-81è¡Œ)<br>`sync_step_output_to_runtime_metadata()` (196-309è¡Œ)<br>`get_all_metadata()` (97-130è¡Œ)<br>`clear()` (322-344è¡Œ) - **ä¿ç•™å†å²æ•°æ®** |
| `src/core/parameter_resolver.rs` | å‚æ•°è§£æä¸å ä½ç¬¦å¤„ç† | `resolve_parameters()` (312-437è¡Œ)<br>`process_parameter_value()` (516-785è¡Œ) - **æ”¯æŒä¸‰é‡å¤§æ‹¬å·**<br>`extract_from_step_output()` (449-514è¡Œ) |
| `src/core/executor.rs` | æ­¥éª¤æ‰§è¡Œä¸æ•°æ®æµè½¬ | `execute_plan_with_context()` (102-537è¡Œ)<br>æ•°æ®æµè½¬é€»è¾‘ (406-501è¡Œ) |
| `src/core/orchestrator.rs` | ç¼–æ’å™¨ä¸é‡è¯•é€»è¾‘ | `sync_step_output_to_metadata()` (1575-1679è¡Œ) - **è¾…åŠ©å‡½æ•°**<br>æ­£å¸¸æ‰§è¡ŒåŒæ­¥ (942-949è¡Œ)<br>å‚æ•°è°ƒæ•´é‡è¯•åŒæ­¥ (1097-1104è¡Œ)<br>å¤‡é€‰å·¥å…·é‡è¯•åŒæ­¥ (1176-1183è¡Œ) |

## è®¾è®¡ä¼˜åŠ¿

### 1. æ•°æ®åˆ†ç¦»å­˜å‚¨
- **initial_metadata**: ä¿æŒä»»åŠ¡åˆå§‹çŠ¶æ€ä¸å˜ï¼Œä¾¿äºè¿½æº¯
- **runtime_metadata**: åªåŒ…å«å¿…è¦çš„æµè½¬å‚æ•°ï¼Œä¿æŒæ¸…æ´
- **step_results**: å®Œæ•´ä¿ç•™æ‰€æœ‰æ­¥éª¤è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•å’Œå®¡è®¡

### 2. æ™ºèƒ½è‡ªåŠ¨æµè½¬
- ä¼˜å…ˆä½¿ç”¨å·¥å…·çš„ `output_params` å®šä¹‰ï¼ˆæ˜ç¡®çš„å¥‘çº¦ï¼‰
- è‡ªåŠ¨å›é€€åˆ°å®é™…è¾“å‡ºæå–ï¼ˆçµæ´»æ€§ï¼‰
- é¿å…æ‰‹åŠ¨é…ç½®ï¼Œå‡å°‘å‡ºé”™

### 3. å¤šç§å¼•ç”¨æ–¹å¼
- æ”¯æŒå¤šç§å ä½ç¬¦æ ¼å¼ï¼Œé€‚åº”ä¸åŒåœºæ™¯
- åµŒå¥—è·¯å¾„æ”¯æŒï¼ˆå¦‚ `a.b.c`ï¼‰
- å…¼å®¹æ€§å¼ºï¼Œæ˜“äºæ‰©å±•

### 4. å¯è¿½æº¯æ€§
- æ¯ä¸ªå‚æ•°éƒ½æœ‰æ˜ç¡®æ¥æº
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- ä¾¿äºé—®é¢˜è¯Šæ–­

## é…ç½®ä¸æ‰©å±•

### å·¥å…·çš„output_paramså®šä¹‰ç¤ºä¾‹

```json
{
  "id": "add_datasource",
  "name": "æ·»åŠ æ•°æ®æº",
  "output_params": {
    "datasource_id": {
      "type": "string",
      "description": "æ•°æ®æºå”¯ä¸€æ ‡è¯†"
    },
    "datasource_name": {
      "type": "string",
      "description": "æ•°æ®æºåç§°"
    }
  }
}
```

### è‡ªå®šä¹‰æµè½¬è§„åˆ™

å¦‚éœ€è‡ªå®šä¹‰æµè½¬è§„åˆ™ï¼Œå¯ä»¥ä¿®æ”¹ `src/core/executor.rs` ä¸­çš„æµè½¬é€»è¾‘ï¼ˆç¬¬390-485è¡Œï¼‰ï¼Œä¾‹å¦‚ï¼š
- æ·»åŠ å­—æ®µè¿‡æ»¤è§„åˆ™
- å®ç°æ¡ä»¶æµè½¬
- æ·»åŠ æ•°æ®è½¬æ¢é€»è¾‘

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### Q1: å‚æ•°æ²¡æœ‰æ­£ç¡®ä¼ é€’åˆ°åç»­æ­¥éª¤ï¼Ÿ

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥å‰ç½®æ­¥éª¤æ˜¯å¦æˆåŠŸæ‰§è¡Œ
2. æŸ¥çœ‹å·¥å…·çš„ `output_params` å®šä¹‰æ˜¯å¦åŒ…å«è¯¥å­—æ®µ
3. æ£€æŸ¥æ­¥éª¤è¾“å‡ºJSONæ˜¯å¦åŒ…å«è¯¥å­—æ®µ
4. æŸ¥çœ‹æ—¥å¿—ä¸­çš„æµè½¬è®°å½•

### Q2: å ä½ç¬¦æ²¡æœ‰è¢«æ­£ç¡®è§£æï¼Ÿ

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥å ä½ç¬¦æ ¼å¼æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤å¼•ç”¨çš„æ­¥éª¤IDæ˜¯å¦å­˜åœ¨
3. æŸ¥çœ‹å‚æ•°è§£æå™¨çš„æ—¥å¿—è¾“å‡º

### Q3: å¦‚ä½•è°ƒè¯•æ•°æ®æµè½¬ï¼Ÿ

**æ–¹æ³•**:
1. æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—ï¼Œæœç´¢ "åŒæ­¥åˆ°runtime_metadata"
2. åœ¨ `ExecutionContext` ä¸­æ·»åŠ æ–­ç‚¹
3. ä½¿ç”¨ `get_all_metadata()` æŸ¥çœ‹å½“å‰æ‰€æœ‰å¯ç”¨å‚æ•°

## ç‰¹æ®Šåœºæ™¯ï¼šé‡è¯•ä¸é‡æ–°è§„åˆ’

### åœºæ™¯è¯´æ˜

åœ¨å•æ­¥é‡è¯•ï¼ˆ`replan_single_step`ï¼‰å’Œä»»åŠ¡é‡æ–°è§„åˆ’ï¼ˆ`replan_task`ï¼‰æ—¶ï¼Œæ•°æ®æµè½¬æœºåˆ¶éœ€è¦ç‰¹æ®Šå¤„ç†ä»¥ç¡®ä¿ï¼š
1. å·²æˆåŠŸæ‰§è¡Œçš„æ­¥éª¤è¾“å‡ºä¸ä¼šä¸¢å¤±
2. é‡è¯•æˆåŠŸåçš„è¾“å‡ºèƒ½å¤Ÿæ­£ç¡®åŒæ­¥åˆ° `runtime_metadata`
3. æ–°è®¡åˆ’ä¸­çš„æ­¥éª¤èƒ½å¤Ÿå¼•ç”¨æ—§è®¡åˆ’ä¸­æˆåŠŸæ­¥éª¤çš„è¾“å‡º

### å…³é”®ä¿®å¤ç‚¹

#### 1. ä¿ç•™æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆä¸æ¸…ç©ºå†å²æ•°æ®ï¼‰

**æ–‡ä»¶ä½ç½®**: `src/core/execution_context.rs`

**ä»£ç ä½ç½®**: `clear()` æ–¹æ³•ï¼ˆç¬¬322-344è¡Œï¼‰

```rust
pub fn clear(&self) {
    // ğŸ”‘ æ”¹è¿›ï¼šä¸å†æ¸…é™¤ step_results å’Œ runtime_metadata
    // ä¿ç•™å·²æˆåŠŸæ‰§è¡Œçš„æ­¥éª¤è¾“å‡ºï¼Œä¾›é‡æ–°è§„åˆ’åçš„æ–°æ­¥éª¤ä½¿ç”¨
    
    info!(
        plan_id = %self.plan_id.read().unwrap(),
        step_results_count = self.step_results.read().unwrap().len(),
        runtime_metadata_count = self.runtime_metadata.read().unwrap().len(),
        "ğŸ”„ æ‰§è¡Œä¸Šä¸‹æ–‡é‡ç½®ï¼šä¿ç•™å·²æœ‰çš„æ­¥éª¤ç»“æœå’Œè¿è¡Œæ—¶å…ƒæ•°æ®ï¼ˆä¾›é‡æ–°è§„åˆ’åä½¿ç”¨ï¼‰"
    );
}
```

**åŸå› **: é‡æ–°è§„åˆ’åï¼Œæ–°è®¡åˆ’ä¸­çš„æ­¥éª¤å¯èƒ½éœ€è¦å¼•ç”¨ä¹‹å‰æˆåŠŸæ‰§è¡Œçš„æ­¥éª¤è¾“å‡ºã€‚ä¾‹å¦‚ï¼š
- `step_2` æˆåŠŸåˆ›å»ºäº†æ•°æ®æº
- `step_3` å¤±è´¥åé‡æ–°è§„åˆ’
- æ–°çš„ `step_3` ä»éœ€è¦å¼•ç”¨ `step_2` çš„è¾“å‡º

#### 2. é‡è¯•æˆåŠŸååŒæ­¥è¾“å‡ºåˆ° metadata

**æ–‡ä»¶ä½ç½®**: `src/core/orchestrator.rs`

**ä»£ç ä½ç½®**: 
- æ­£å¸¸æ‰§è¡ŒæˆåŠŸï¼ˆç¬¬942-949è¡Œï¼‰
- å‚æ•°è°ƒæ•´é‡è¯•æˆåŠŸï¼ˆç¬¬1097-1104è¡Œï¼‰
- å¤‡é€‰å·¥å…·é‡è¯•æˆåŠŸï¼ˆç¬¬1176-1183è¡Œï¼‰

```rust
// ğŸ”‘ ã€å…³é”®ä¿®å¤ã€‘åŒæ­¥æ­¥éª¤è¾“å‡ºåˆ° runtime_metadata
self.sync_step_output_to_metadata(
    &retry_result.step_id,
    &retry_result.tool_id,
    &retry_result.output,
    &execution_context,
    &available_tools,
).await;
```

**åŸå› **: åœ¨æ­¥éª¤çº§åæ€æ¨¡å¼ä¸‹ï¼Œorchestrator é€æ­¥æ‰§è¡Œæ¯ä¸ªæ­¥éª¤ï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨åŒæ­¥é€»è¾‘ã€‚ä¿®å¤å‰çš„é—®é¢˜ï¼š
- æ­¥éª¤è¾“å‡ºä¿å­˜åˆ° `step_results` âœ…
- ä½†**æ²¡æœ‰**åŒæ­¥åˆ° `runtime_metadata` âŒ
- åç»­æ­¥éª¤æ— æ³•é€šè¿‡ç®€å•é”®åå¼•ç”¨

#### 3. è¾…åŠ©å‡½æ•°ï¼šsync_step_output_to_metadata

**æ–‡ä»¶ä½ç½®**: `src/core/orchestrator.rs`

**ä»£ç ä½ç½®**: ç¬¬1575-1679è¡Œ

```rust
async fn sync_step_output_to_metadata(
    &self,
    step_id: &str,
    tool_id: &str,
    step_output: &str,
    execution_context: &ExecutionContext,
    available_tools: &[ToolInfo],
) {
    // 1. ä»å·¥å…·å®šä¹‰çš„ output_params è·å–å‚æ•°å
    // 2. å¦‚æœæ²¡æœ‰å®šä¹‰ï¼Œä»å®é™…è¾“å‡ºä¸­è‡ªåŠ¨æå–
    // 3. è°ƒç”¨ execution_context.sync_step_output_to_runtime_metadata()
}
```

**åŠŸèƒ½**: å°è£…åŒæ­¥é€»è¾‘ï¼Œåœ¨æ‰€æœ‰æ­¥éª¤æˆåŠŸçš„åœ°æ–¹ç»Ÿä¸€è°ƒç”¨ï¼Œç¡®ä¿æ•°æ®æµè½¬çš„ä¸€è‡´æ€§ã€‚

### æ•°æ®æµè½¬å¯¹æ¯”

#### ä¿®å¤å‰ï¼ˆâŒ é—®é¢˜ï¼‰

```
é‡è¯•æˆåŠŸ 
  â†’ set_step_result() [ä¿å­˜åˆ° step_results]
  â†’ âŒ ç¼ºå°‘åŒæ­¥åˆ° runtime_metadata
  â†’ åç»­æ­¥éª¤æ‰¾ä¸åˆ°è¾“å‡º âŒ
```

#### ä¿®å¤åï¼ˆâœ… æ­£ç¡®ï¼‰

```
é‡è¯•æˆåŠŸ 
  â†’ set_step_result() [ä¿å­˜åˆ° step_results]
  â†’ sync_step_output_to_metadata() [åŒæ­¥åˆ° runtime_metadata] âœ…
  â†’ åç»­æ­¥éª¤å¯ä»¥å¼•ç”¨ âœ…
```

### å®é™…æ¡ˆä¾‹

**åœºæ™¯**: è´Ÿè·é¢„æµ‹ä»»åŠ¡ä¸­çš„ç‰¹å¾å·¥ç¨‹æ­¥éª¤å¤±è´¥

```
æ­¥éª¤9: feature_engineering (æˆåŠŸ)
  è¾“å‡º: {"train_data": "[...]", "test_data": "[...]", "feature_data": "[...]"}
  æµè½¬: train_data, test_data, feature_data â†’ runtime_metadata âœ…

æ­¥éª¤10: multi_model_training (å¤±è´¥)
  â†’ è§¦å‘å•æ­¥é‡è¯•
  â†’ é‡è¯•æˆåŠŸ âœ…
  â†’ åŒæ­¥è¾“å‡ºåˆ° runtime_metadata âœ…

æ­¥éª¤11: model_evaluation
  è¾“å…¥: {{step_10_multi_model_training.model_id}} âœ… æ­£ç¡®è§£æ
```

## æ€»ç»“

æ•°æ®æ§½ä½çš„æ™ºèƒ½æµè½¬æœºåˆ¶æ˜¯ä»»åŠ¡ç¼–æ’æœåŠ¡çš„æ ¸å¿ƒèƒ½åŠ›ï¼Œé€šè¿‡ä¸‰å±‚æ•°æ®å­˜å‚¨æ¶æ„å’Œæ™ºèƒ½å‚æ•°è§£æï¼Œå®ç°äº†ï¼š
- **è‡ªåŠ¨åŒ–**: æ— éœ€æ‰‹åŠ¨é…ç½®å‚æ•°ä¼ é€’
- **çµæ´»æ€§**: æ”¯æŒå¤šç§å¼•ç”¨æ–¹å¼å’Œæ•°æ®æ¥æºï¼ˆåŒ…æ‹¬ä¸‰é‡å¤§æ‹¬å·ï¼‰
- **å¯é æ€§**: å®Œæ•´çš„æ•°æ®è¿½æº¯å’Œé”™è¯¯å¤„ç†
- **å®¹é”™æ€§**: é‡è¯•å’Œé‡æ–°è§„åˆ’åœºæ™¯ä¸‹çš„æ•°æ®ä¿ç•™å’ŒåŒæ­¥
- **å¯æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°çš„æµè½¬è§„åˆ™å’Œæ•°æ®æº

è¯¥æœºåˆ¶ç¡®ä¿äº†å¤æ‚å¤šæ­¥éª¤ä»»åŠ¡çš„æ•°æ®ä¾èµ–èƒ½å¤Ÿæ­£ç¡®å¤„ç†ï¼Œå³ä½¿åœ¨å¤±è´¥é‡è¯•å’Œé‡æ–°è§„åˆ’çš„åœºæ™¯ä¸‹ä¹Ÿèƒ½ä¿æŒæ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ï¼Œæ˜¯å®ç°ç«¯åˆ°ç«¯ä»»åŠ¡è‡ªåŠ¨åŒ–çš„åŸºç¡€ã€‚
