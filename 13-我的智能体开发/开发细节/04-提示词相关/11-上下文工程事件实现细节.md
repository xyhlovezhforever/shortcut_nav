# ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶(Context Engineering Event) - å®Œæ•´å¼€å‘æ–‡æ¡£

## ä¸€ã€æ¦‚è¿°

ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶æ˜¯ä»»åŠ¡ç¼–æ’æœåŠ¡åœ¨ä»»åŠ¡æ‰§è¡Œå®Œæˆæ—¶ç”Ÿæˆçš„å®Œæ•´æ‰§è¡Œè®°å½•ï¼ŒåŒ…å«ä»»åŠ¡æè¿°ã€æ‰€æœ‰æˆåŠŸæ‰§è¡Œçš„æ­¥éª¤ä¿¡æ¯å’Œæ‰€æœ‰å¤±è´¥æ­¥éª¤çš„è¯¦ç»†ä¿¡æ¯ï¼ˆå«åæ€åˆ†æï¼‰ã€‚è¯¥äº‹ä»¶é€šè¿‡gRPCæµå¼æ¨é€ç»™å®¢æˆ·ç«¯ï¼Œç”¨äºä¸Šä¸‹æ–‡è¿½è¸ªå’Œè°ƒè¯•åˆ†æã€‚

### 1.1 æ ¸å¿ƒéœ€æ±‚

1. **å‘é€æ—¶æœº**: åœ¨ä»»åŠ¡æ‰§è¡Œç»“æŸæ—¶å‘é€ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶æ¶ˆæ¯
2. **æ¶ˆæ¯å†…å®¹**:
   - ä»»åŠ¡æè¿°
   - æˆåŠŸæ­¥éª¤è¯¦ç»†ä¿¡æ¯(æ­¥éª¤åç§°ã€å·¥å…·IDã€å·¥å…·æ‰§è¡Œå‚æ•°ã€å·¥å…·è¿”å›ç»“æœ)
   - å¤±è´¥æ­¥éª¤è¯¦ç»†ä¿¡æ¯(æ­¥éª¤åç§°ã€å·¥å…·IDã€å·¥å…·æ‰§è¡Œå‚æ•°ã€å·¥å…·æŠ¥é”™ä¿¡æ¯ã€æ¯æ¬¡å¤±è´¥çš„åæ€)
3. **åŠ¨æ€æ‹¼æ¥**: åœ¨æ­¥éª¤æ‰§è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€æ‹¼æ¥æ¶ˆæ¯å†…å®¹
4. **è‡ªæˆ‘éªŒè¯**: å‘é€å‰å°†æœ€ç»ˆå†…å®¹å†™å…¥æ–‡ä»¶,è¯¥åŠŸèƒ½ç”±é…ç½®æ–‡ä»¶æ§åˆ¶

---

## äºŒã€æ•°æ®ç»“æ„å®šä¹‰

### 2.1 Protoæ¶ˆæ¯å®šä¹‰

**æ–‡ä»¶**: `proto/task_orchestrator_service.proto`

```protobuf
// äº‹ä»¶ç±»å‹æšä¸¾ (ç¬¬159è¡Œ)
enum EventType {
    // ... å…¶ä»–ç±»å‹ ...
    EVENT_TYPE_CONTEXT_ENGINEERING = 14;
}

// TaskExecutionEvent.event_data oneofä¸­ (ç¬¬140è¡Œ)
oneof event_data {
    // ... å…¶ä»–äº‹ä»¶ ...
    ContextEngineeringEvent context_engineering = 17;
}

// ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶ (ç¬¬416-430è¡Œ)
message ContextEngineeringEvent {
    string task_description = 1;
    repeated SuccessfulStepInfo successful_steps = 2;
    repeated FailedStepInfo failed_steps = 3;
}

// æˆåŠŸæ­¥éª¤ä¿¡æ¯ (ç¬¬432-458è¡Œ)
message SuccessfulStepInfo {
    string step_id = 1;
    string step_name = 2;
    string step_description = 3;
    string tool_id = 4;
    string tool_parameters = 5;        // JSONæ ¼å¼
    string tool_output = 6;
    repeated string dependencies = 7;
    map<string, string> extracted_fields = 8;
}

// å¤±è´¥æ­¥éª¤ä¿¡æ¯ (ç¬¬460-486è¡Œ)
message FailedStepInfo {
    string step_id = 1;
    string step_name = 2;
    string step_description = 3;
    string tool_id = 4;
    string tool_parameters = 5;        // JSONæ ¼å¼
    string error_message = 6;
    string reflection_and_action = 7;  // åæ€ä¿¡æ¯
    repeated string dependencies = 8;
}
```

### 2.2 Rustå†…éƒ¨æ•°æ®ç»“æ„

**æ–‡ä»¶**: `src/core/orchestrator.rs` (ç¬¬44-92è¡Œ)

```rust
/// ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶æ„å»ºå™¨
pub struct ContextEngineeringEventBuilder {
    task_description: String,
    successful_steps: Vec<SuccessfulStepData>,
    failed_steps: Vec<FailedStepData>,
}

/// æˆåŠŸæ­¥éª¤æ•°æ®
struct SuccessfulStepData {
    step_id: String,
    step_name: String,
    step_description: String,
    tool_id: String,
    tool_parameters: String,      // JSONå­—ç¬¦ä¸²
    tool_output: String,
    dependencies: Vec<String>,
    extracted_fields: HashMap<String, String>,
}

/// å¤±è´¥æ­¥éª¤æ•°æ®
struct FailedStepData {
    step_id: String,
    step_name: String,
    step_description: String,
    tool_id: String,
    tool_parameters: String,      // JSONå­—ç¬¦ä¸²
    error_message: String,
    reflection_and_action: String,
    dependencies: Vec<String>,
}
```

---

## ä¸‰ã€æ ¸å¿ƒä»£ç æ˜ å°„

### 3.1 æ–‡ä»¶ä½ç½®æ±‡æ€»

| åŠŸèƒ½æ¨¡å— | æ–‡ä»¶è·¯å¾„ | è¡Œå·èŒƒå›´ | å…³é”®ç±»/å‡½æ•° |
|---------|---------|---------|-----------|
| Protoå®šä¹‰ | `proto/task_orchestrator_service.proto` | 416-486 | ContextEngineeringEvent, SuccessfulStepInfo, FailedStepInfo |
| æ„å»ºå™¨å®ç° | `src/core/orchestrator.rs` | 44-341 | ContextEngineeringEventBuilder |
| äº‹ä»¶åˆå§‹åŒ– | `src/core/orchestrator.rs` | 695-703 | orchestrate_with_id_and_metadata() |
| æˆåŠŸæ­¥éª¤è®°å½•(ç®€å•æ¨¡å¼) | `src/core/orchestrator.rs` | 1474-1493 | add_successful_step() |
| æˆåŠŸæ­¥éª¤è®°å½•(åæ€æ¨¡å¼) | `src/core/orchestrator.rs` | 1778-1812 | add_successful_step() |
| å¤±è´¥æ­¥éª¤è®°å½•(ç®€å•æ¨¡å¼) | `src/core/orchestrator.rs` | 1504-1526 | add_failed_step() |
| å¤±è´¥æ­¥éª¤è®°å½•(åæ€æ¨¡å¼) | `src/core/orchestrator.rs` | 2015-2047 | add_failed_step() |
| äº‹ä»¶å‘é€é€»è¾‘ | `src/core/orchestrator.rs` | 576-609 | send_context_engineering_event() |
| äº‹ä»¶å‘é€è§¦å‘(æˆåŠŸ) | `src/core/orchestrator.rs` | 740-744 | orchestrate_with_id_and_metadata() |
| äº‹ä»¶å‘é€è§¦å‘(å¤±è´¥) | `src/core/orchestrator.rs` | 770-774 | orchestrate_with_id_and_metadata() |
| EventSender Trait | `src/core/orchestrator.rs` | 379-470 | trait EventSender |
| gRPCå®ç° | `src/grpc/server.rs` | 1332-1354 | StreamEventSender::send_context_engineering_event() |
| é…ç½®å®šä¹‰ | `src/config/mod.rs` | 555-597 | DebugConfig |
| ä»»åŠ¡çŠ¶æ€ | `src/state/task_state.rs` | 36-58 | StepExecution |
| æµ‹è¯•ç¤ºä¾‹ | `examples/context_engineering_test.rs` | å…¨æ–‡ | å®Œæ•´æµ‹è¯•ç”¨ä¾‹ |

---

## å››ã€äº‹ä»¶ç”Ÿå‘½å‘¨æœŸ

### 4.1 æ•´ä½“æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä»»åŠ¡å¼€å§‹æ‰§è¡Œ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åˆ›å»º ContextEngineeringEventBuilder               â”‚
â”‚           å­˜å‚¨åœ¨ task_id å¯¹åº”çš„ DashMap ä¸­                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ­¥éª¤æ‰§è¡Œå¾ªç¯                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                           â”‚
                â–¼                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æ­¥éª¤æ‰§è¡ŒæˆåŠŸ      â”‚       â”‚  æ­¥éª¤æ‰§è¡Œå¤±è´¥     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                           â”‚
                â–¼                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æ”¶é›†æˆåŠŸæ­¥éª¤ä¿¡æ¯   â”‚       â”‚  æ”¶é›†å¤±è´¥æ­¥éª¤ä¿¡æ¯ â”‚
    â”‚ - æ­¥éª¤åç§°         â”‚       â”‚  - æ­¥éª¤åç§°       â”‚
    â”‚ - å·¥å…·ID          â”‚       â”‚  - å·¥å…·ID        â”‚
    â”‚ - å·¥å…·å‚æ•°         â”‚       â”‚  - å·¥å…·å‚æ•°       â”‚
    â”‚ - å·¥å…·è¾“å‡º         â”‚       â”‚  - é”™è¯¯ä¿¡æ¯       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  - åæ€å†…å®¹       â”‚
                â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                           â”‚
                â–¼                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æ·»åŠ åˆ° ContextEngineeringEventBuilder    â”‚
    â”‚  çš„ successful_steps æˆ– failed_steps     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä»»åŠ¡æ‰§è¡Œå®Œæˆ                              â”‚
â”‚              (æˆåŠŸã€å¤±è´¥æˆ–å–æ¶ˆ)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ä» Builder æ„å»ºæœ€ç»ˆçš„äº‹ä»¶æ¶ˆæ¯                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ£€æŸ¥é…ç½®: save_context_engineering_event                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                           â”‚
           true â”‚                           â”‚ false
                â–¼                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å†™å…¥éªŒè¯æ–‡ä»¶       â”‚       â”‚   è·³è¿‡æ–‡ä»¶å†™å…¥    â”‚
    â”‚ (æ ¼å¼åŒ–è¾“å‡º)       â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
                â”‚                           â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        è°ƒç”¨ send_context_engineering_event()                â”‚
â”‚         å‘é€ gRPC æµå¼äº‹ä»¶ç»™å®¢æˆ·ç«¯                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                          å®Œæˆæµç¨‹
```

### 4.2 åŠ¨æ€æ”¶é›†æ—¶æœº

| æ—¶æœºç‚¹ | ä½ç½® | æ”¶é›†åŠ¨ä½œ |
|--------|------|----------|
| æ­¥éª¤æ‰§è¡ŒæˆåŠŸ | `execute_step_with_retry()` | è°ƒç”¨ `builder.add_successful_step()` |
| æ­¥éª¤æ‰§è¡Œå¤±è´¥(åæ€å) | `execute_step_with_retry()` | è°ƒç”¨ `builder.add_failed_step()` |
| ä»»åŠ¡å®Œæˆ | `run_single_round()` ç»“æŸæ—¶ | æ„å»ºäº‹ä»¶å¹¶å‘é€ |
| ä»»åŠ¡å¤±è´¥ | `execute_task()` çš„ error å¤„ç† | æ„å»ºäº‹ä»¶å¹¶å‘é€ |

### 4.3 åˆ›å»º(åˆå§‹åŒ–)

**ä½ç½®**: `src/core/orchestrator.rs` (ç¬¬695-703è¡Œ)

```rust
// åœ¨ orchestrate_with_id_and_metadata æ–¹æ³•ä¸­
{
    let builder = ContextEngineeringEventBuilder::new(task_description.clone());
    self.context_engineering_builders.insert(
        task.task_id.clone(),
        RwLock::new(builder),
    );
    info!("ğŸ“ å·²åˆ›å»ºä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶æ„å»ºå™¨: {}", task.task_id);
}
```

**å…³é”®ç‚¹**:
- ä¸ºæ¯ä¸ªæ–°ä»»åŠ¡åˆ›å»ºä¸€ä¸ª `ContextEngineeringEventBuilder` å®ä¾‹
- ä½¿ç”¨ä»»åŠ¡IDä½œä¸ºkeyå­˜å‚¨åœ¨ `Arc<DashMap<String, RwLock<ContextEngineeringEventBuilder>>>` ä¸­
- æ”¯æŒå¹¶å‘ä»»åŠ¡çš„éš”ç¦»ç®¡ç†

### 4.4 è®°å½•æˆåŠŸæ­¥éª¤

#### ç®€å•æ‰§è¡Œæ¨¡å¼
**ä½ç½®**: `src/core/orchestrator.rs` (ç¬¬1474-1493è¡Œ)

```rust
if let Some(builder_lock) = self.context_engineering_builders.get(task_id) {
    let mut builder = builder_lock.write().await;

    let tool_parameters = serde_json::to_string(&result.tool_parameters)
        .unwrap_or_else(|_| "{}".to_string());

    builder.add_successful_step(
        result.step_id.clone(),
        result.step_name.clone(),
        step_description,
        result.tool_id.clone(),
        tool_parameters,
        result.output.clone(),
        dependencies,
        HashMap::new(),  // TODO: å®ç°å­—æ®µæå–
    );

    info!("âœ… å·²è®°å½•æˆåŠŸæ­¥éª¤åˆ°ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶: {}", result.step_name);
}
```

#### æ­¥éª¤çº§åæ€æ¨¡å¼
**ä½ç½®**: `src/core/orchestrator.rs` (ç¬¬1778-1812è¡Œ)

```rust
if let Some(builder_lock) = self.context_engineering_builders.get(task_id) {
    info!("ğŸ” æˆåŠŸè·å–åˆ°æ„å»ºå™¨");
    let mut builder = builder_lock.write().await;

    // æå–æ­¥éª¤ç›¸å…³ä¿¡æ¯
    let step_description = current_plan.steps.get(step_index)
        .map(|s| s.description.clone())
        .unwrap_or_default();
    let dependencies = current_plan.steps.get(step_index)
        .map(|s| extract_dependencies(s))
        .unwrap_or_default();

    let tool_parameters = serde_json::to_string(&step_result.tool_parameters)
        .unwrap_or_else(|_| "{}".to_string());

    builder.add_successful_step(
        step_result.step_id.clone(),
        step_result.step_name.clone(),
        step_description,
        step_result.tool_id.clone(),
        tool_parameters,
        step_result.output.clone(),
        dependencies,
        HashMap::new(),
    );

    info!("âœ… å·²è®°å½•æˆåŠŸæ­¥éª¤åˆ°ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶: {}", step_result.step_name);
}
```

### 4.5 è®°å½•å¤±è´¥æ­¥éª¤

#### ç®€å•æ‰§è¡Œæ¨¡å¼
**ä½ç½®**: `src/core/orchestrator.rs` (ç¬¬1504-1526è¡Œ)

```rust
if let Some(builder_lock) = self.context_engineering_builders.get(task_id) {
    let mut builder = builder_lock.write().await;

    let tool_parameters = serde_json::to_string(&result.tool_parameters)
        .unwrap_or_else(|_| "{}".to_string());

    let error_message = result.error_message.clone()
        .unwrap_or_else(|| "æœªçŸ¥é”™è¯¯".to_string());

    builder.add_failed_step(
        result.step_id.clone(),
        result.step_name.clone(),
        step_description,
        result.tool_id.clone(),
        tool_parameters,
        error_message,
        "æ— åæ€ä¿¡æ¯(éæ­¥éª¤çº§åæ€è·¯å¾„)".to_string(),
        dependencies,
    );

    info!("âŒ å·²è®°å½•å¤±è´¥æ­¥éª¤åˆ°ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶: {}", result.step_name);
}
```

#### æ­¥éª¤çº§åæ€æ¨¡å¼(å«åæ€ä¿¡æ¯)
**ä½ç½®**: `src/core/orchestrator.rs` (ç¬¬2015-2047è¡Œ)

```rust
if let Some(builder_lock) = self.context_engineering_builders.get(task_id) {
    info!("ğŸ” [å¤±è´¥è·¯å¾„] æˆåŠŸè·å–åˆ°æ„å»ºå™¨");
    let mut builder = builder_lock.write().await;

    let step_description = current_plan.steps.get(step_index)
        .map(|s| s.description.clone())
        .unwrap_or_default();

    let dependencies = current_plan.steps.get(step_index)
        .map(|s| extract_dependencies(s))
        .unwrap_or_default();

    let tool_parameters = serde_json::to_string(&step_result.tool_parameters)
        .unwrap_or_else(|_| "{}".to_string());

    let error_message = step_result.error_message.clone()
        .unwrap_or_else(|| "æœªçŸ¥é”™è¯¯".to_string());

    builder.add_failed_step(
        failed_step_id,
        step_info.name.clone(),
        step_description,
        step_info.tool.clone(),
        tool_parameters,
        error_message,
        reflection_text.clone(),  // åŒ…å«åæ€ä¿¡æ¯
        dependencies,
    );

    info!("âŒ å·²è®°å½•å¤±è´¥æ­¥éª¤åˆ°ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶: {} (é‡è¯• {})",
          step_info.name, step_retry_count);
}
```

### 4.6 å‘é€äº‹ä»¶

**ä½ç½®**: `src/core/orchestrator.rs` (ç¬¬576-609è¡Œ)

```rust
async fn send_context_engineering_event(
    &self,
    task_id: &str,
    event_sender: &Arc<dyn EventSender>,
) -> Result<()> {
    // 1. ä»DashMapä¸­ç§»é™¤å¹¶è·å–Builder
    let builder = match self.context_engineering_builders.remove(task_id) {
        Some((_, builder_lock)) => builder_lock.into_inner(),
        None => {
            warn!("âš ï¸  æœªæ‰¾åˆ°ä»»åŠ¡çš„ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶æ„å»ºå™¨: {}", task_id);
            return Ok(());
        }
    };

    // 2. æ£€æŸ¥é…ç½®,å†³å®šæ˜¯å¦å†™æ–‡ä»¶
    if self.app_config.debug.save_context_engineering_event {
        let formatted = builder.format_to_file();
        let file_path = &self.app_config.debug.context_engineering_file;

        if let Err(e) = tokio::fs::write(file_path, formatted).await {
            warn!("âš ï¸  ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶æ–‡ä»¶å†™å…¥å¤±è´¥: {}", e);
        } else {
            info!("âœ… ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶å·²å†™å…¥æ–‡ä»¶: {}", file_path);
        }
    }

    // 3. æ„å»ºå¹¶å‘é€äº‹ä»¶
    let event = builder.build();
    event_sender.send_context_engineering_event(&event);
    info!("ğŸ“¤ å·²å‘é€ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶åˆ°å®¢æˆ·ç«¯");

    Ok(())
}
```

**è§¦å‘æ—¶æœº**:

æˆåŠŸå®Œæˆæ—¶ (ç¬¬740-744è¡Œ):
```rust
if let Some(event_sender) = self.task_event_senders.get(&task.task_id) {
    if let Err(e) = self.send_context_engineering_event(&task.task_id, &event_sender).await {
        error!("å‘é€ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶å¤±è´¥: {:?}", e);
    }
}
```

å¤±è´¥æ—¶ (ç¬¬770-774è¡Œ):
```rust
if let Some(event_sender) = self.task_event_senders.get(&task.task_id) {
    if let Err(e) = self.send_context_engineering_event(&task.task_id, &event_sender).await {
        error!("å‘é€ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶å¤±è´¥: {:?}", e);
    }
}
```

---

## äº”ã€æ¨¡å—äº¤äº’å…³ç³»

### 5.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Orchestrator (ç¼–æ’å™¨)                       â”‚
â”‚  - åˆ›å»º ContextEngineeringEventBuilder                       â”‚
â”‚  - ç®¡ç† context_engineering_builders DashMap                â”‚
â”‚  - è°ƒç”¨ build() æ„å»ºäº‹ä»¶                                     â”‚
â”‚  - è°ƒç”¨ format_to_file() æ ¼å¼åŒ–è¾“å‡º                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                    â”‚                    â”‚
             â–¼                    â–¼                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Executor   â”‚    â”‚  EventSender â”‚    â”‚   Config     â”‚
    â”‚  (æ‰§è¡Œå™¨)     â”‚    â”‚  (äº‹ä»¶å‘é€)   â”‚    â”‚  (é…ç½®)      â”‚
    â”‚              â”‚    â”‚              â”‚    â”‚              â”‚
    â”‚ - è°ƒç”¨        â”‚    â”‚ - å‘é€äº‹ä»¶    â”‚    â”‚ - æ§åˆ¶æ–‡ä»¶   â”‚
    â”‚   add_*      â”‚    â”‚ - Streamäº‹ä»¶ â”‚    â”‚   å†™å…¥å¼€å…³   â”‚
    â”‚   æ–¹æ³•       â”‚    â”‚              â”‚    â”‚ - æŒ‡å®šæ–‡ä»¶   â”‚
    â”‚              â”‚    â”‚              â”‚    â”‚   è·¯å¾„       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                    â”‚                    â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          Task State Manager             â”‚
    â”‚  (ä»»åŠ¡çŠ¶æ€ç®¡ç†å™¨)                        â”‚
    â”‚                                         â”‚
    â”‚ - StepExecution                        â”‚
    â”‚   - reflection_and_actionå­—æ®µ          â”‚
    â”‚   - error_messageå­—æ®µ                  â”‚
    â”‚   - resultå­—æ®µ                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 EventSender Traitå®šä¹‰

**ä½ç½®**: `src/core/orchestrator.rs` (ç¬¬379-470è¡Œ)

```rust
pub trait EventSender: Send + Sync {
    // ... å…¶ä»–æ–¹æ³• ...

    /// å‘é€ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶ï¼ˆä»»åŠ¡å®Œæˆæ—¶æ¨é€ï¼‰
    #[allow(unused_variables)]
    fn send_context_engineering_event(&self, event: &crate::grpc::orchestrator::ContextEngineeringEvent) {}
}
```

**å®ç°ç±»**:
- `NoOpEventSender`: ç©ºå®ç°ï¼Œç”¨äºéæµå¼åœºæ™¯ (ç¬¬475-500è¡Œ)
- `StreamEventSender`: gRPCæµå¼å®ç° (src/grpc/server.rs ç¬¬1332-1354è¡Œ)

### 5.3 StreamEventSenderå…·ä½“å®ç°

**ä½ç½®**: `src/grpc/server.rs` (ç¬¬1332-1354è¡Œ)

```rust
fn send_context_engineering_event(&self, event: &crate::grpc::orchestrator::ContextEngineeringEvent) {
    let self_clone = Arc::new(Self {
        tx: self.tx.clone(),
        task_id: self.task_id.clone(),
        state_manager: self.state_manager.clone(),
        message_formatter: self.message_formatter.clone(),
        ai_reporter: self.ai_reporter.clone(),
        response_mode: self.response_mode,
        debug_config: self.debug_config.clone(),
    });
    let context_event = event.clone();

    tokio::spawn(async move {
        let event = TaskExecutionEvent {
            task_id: self_clone.task_id.clone(),
            event_type: EventType::ContextEngineering as i32,
            timestamp: Utc::now().to_rfc3339(),
            event_data: Some(EventData::ContextEngineering(context_event)),
        };

        self_clone.send_event(event).await;
    });
}
```

---

## å…­ã€é…ç½®ç®¡ç†

### 6.1 é…ç½®ç»“æ„å®šä¹‰

**ä½ç½®**: `src/config/mod.rs` (ç¬¬555-597è¡Œ)

```rust
#[derive(Debug, Clone, Deserialize, Serialize)]
pub struct DebugConfig {
    /// æ˜¯å¦å°†LLMå“åº”å’Œå·¥å…·æŸ¥è¯¢ä¿¡æ¯å†™å…¥è°ƒè¯•æ–‡ä»¶
    #[serde(default = "default_save_debug_log")]
    pub save_debug_log: bool,
    /// è°ƒè¯•æ—¥å¿—æ–‡ä»¶è·¯å¾„
    #[serde(default = "default_debug_log_file")]
    pub debug_log_file: String,
    /// æ˜¯å¦å°†ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶å†™å…¥æ–‡ä»¶è¿›è¡Œè‡ªæˆ‘éªŒè¯
    #[serde(default = "default_save_context_engineering")]
    pub save_context_engineering_event: bool,
    /// ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶æ–‡ä»¶è·¯å¾„
    #[serde(default = "default_context_engineering_file")]
    pub context_engineering_file: String,
}

fn default_save_context_engineering() -> bool {
    false
}

fn default_context_engineering_file() -> String {
    "context_engineering_events.txt".to_string()
}
```

### 6.2 é…ç½®æ–‡ä»¶ç¤ºä¾‹

**æ–‡ä»¶**: `config.dev.toml`

```toml
[debug]
# æ˜¯å¦å°†LLMå“åº”å’Œå·¥å…·æŸ¥è¯¢ä¿¡æ¯å†™å…¥è°ƒè¯•æ–‡ä»¶
save_debug_log = true
# è°ƒè¯•æ—¥å¿—æ–‡ä»¶è·¯å¾„
debug_log_file = "test_log.txt"

# æ˜¯å¦å°†ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶å†™å…¥æ–‡ä»¶è¿›è¡Œè‡ªæˆ‘éªŒè¯
# true: åœ¨ä»»åŠ¡å®Œæˆæ—¶å°†äº‹ä»¶å†…å®¹å†™å…¥æ–‡ä»¶
# false: ä¸å†™å…¥æ–‡ä»¶,ä»…é€šè¿‡gRPCå‘é€
save_context_engineering_event = true

# ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶æ–‡ä»¶è·¯å¾„
context_engineering_file = "context_engineering_events.txt"
```

---

## ä¸ƒã€ContextEngineeringEventBuilderæ ¸å¿ƒæ–¹æ³•

**ä½ç½®**: `src/core/orchestrator.rs` (ç¬¬94-341è¡Œ)

### 7.1 æ„é€ å‡½æ•°

```rust
impl ContextEngineeringEventBuilder {
    /// åˆ›å»ºæ–°çš„æ„å»ºå™¨
    pub fn new(task_description: String) -> Self {
        Self {
            task_description,
            successful_steps: Vec::new(),
            failed_steps: Vec::new(),
        }
    }
}
```

### 7.2 æ·»åŠ æˆåŠŸæ­¥éª¤

```rust
/// æ·»åŠ æˆåŠŸæ‰§è¡Œçš„æ­¥éª¤
pub fn add_successful_step(
    &mut self,
    step_id: String,
    step_name: String,
    step_description: String,
    tool_id: String,
    tool_parameters: String,
    tool_output: String,
    dependencies: Vec<String>,
    extracted_fields: HashMap<String, String>,
) {
    self.successful_steps.push(SuccessfulStepData {
        step_id,
        step_name,
        step_description,
        tool_id,
        tool_parameters,
        tool_output,
        dependencies,
        extracted_fields,
    });
}
```

### 7.3 æ·»åŠ å¤±è´¥æ­¥éª¤

```rust
/// æ·»åŠ å¤±è´¥çš„æ­¥éª¤
pub fn add_failed_step(
    &mut self,
    step_id: String,
    step_name: String,
    step_description: String,
    tool_id: String,
    tool_parameters: String,
    error_message: String,
    reflection_and_action: String,
    dependencies: Vec<String>,
) {
    self.failed_steps.push(FailedStepData {
        step_id,
        step_name,
        step_description,
        tool_id,
        tool_parameters,
        error_message,
        reflection_and_action,
        dependencies,
    });
}
```

### 7.4 æ„å»ºProtoäº‹ä»¶

```rust
/// æ„å»ºæœ€ç»ˆçš„ContextEngineeringEvent
pub fn build(self) -> ContextEngineeringEvent {
    ContextEngineeringEvent {
        task_description: self.task_description,
        successful_steps: self.successful_steps
            .into_iter()
            .map(|s| SuccessfulStepInfo {
                step_id: s.step_id,
                step_name: s.step_name,
                step_description: s.step_description,
                tool_id: s.tool_id,
                tool_parameters: s.tool_parameters,
                tool_output: s.tool_output,
                dependencies: s.dependencies,
                extracted_fields: s.extracted_fields,
            })
            .collect(),
        failed_steps: self.failed_steps
            .into_iter()
            .map(|s| FailedStepInfo {
                step_id: s.step_id,
                step_name: s.step_name,
                step_description: s.step_description,
                tool_id: s.tool_id,
                tool_parameters: s.tool_parameters,
                error_message: s.error_message,
                reflection_and_action: s.reflection_and_action,
                dependencies: s.dependencies,
            })
            .collect(),
    }
}
```

### 7.5 æ ¼å¼åŒ–è¾“å‡ºåˆ°æ–‡ä»¶

```rust
/// æ ¼å¼åŒ–ä¸ºå¯è¯»æ–‡æœ¬(ç”¨äºè°ƒè¯•æ–‡ä»¶)
pub fn format_to_file(&self) -> String {
    let mut output = String::new();

    output.push_str("=== ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶ ===\n\n");
    output.push_str(&format!("ä»»åŠ¡æè¿°: {}\n\n", self.task_description));

    output.push_str("--- æˆåŠŸæ­¥éª¤ ---\n");
    for (i, step) in self.successful_steps.iter().enumerate() {
        output.push_str(&format!("\n[æ­¥éª¤ {}] {}\n", i + 1, step.step_name));
        output.push_str(&format!("  ID: {}\n", step.step_id));
        output.push_str(&format!("  æè¿°: {}\n", step.step_description));
        output.push_str(&format!("  å·¥å…·: {}\n", step.tool_id));
        output.push_str(&format!("  å‚æ•°: {}\n", step.tool_parameters));
        output.push_str(&format!("  è¾“å‡º: {}\n", step.tool_output));
        if !step.dependencies.is_empty() {
            output.push_str(&format!("  ä¾èµ–: {:?}\n", step.dependencies));
        }
        if !step.extracted_fields.is_empty() {
            output.push_str(&format!("  æå–å­—æ®µ: {:?}\n", step.extracted_fields));
        }
    }

    output.push_str("\n--- å¤±è´¥æ­¥éª¤ ---\n");
    for (i, step) in self.failed_steps.iter().enumerate() {
        output.push_str(&format!("\n[å¤±è´¥æ­¥éª¤ {}] {}\n", i + 1, step.step_name));
        output.push_str(&format!("  ID: {}\n", step.step_id));
        output.push_str(&format!("  æè¿°: {}\n", step.step_description));
        output.push_str(&format!("  å·¥å…·: {}\n", step.tool_id));
        output.push_str(&format!("  å‚æ•°: {}\n", step.tool_parameters));
        output.push_str(&format!("  é”™è¯¯: {}\n", step.error_message));
        output.push_str(&format!("  åæ€ä¸è¡ŒåŠ¨: {}\n", step.reflection_and_action));
        if !step.dependencies.is_empty() {
            output.push_str(&format!("  ä¾èµ–: {:?}\n", step.dependencies));
        }
    }

    output
}
```

---

## å…«ã€æ•°æ®æµå®Œæ•´é“¾è·¯

```
1. ä»»åŠ¡æäº¤
   â†“
2. Orchestrator.orchestrate_with_id_and_metadata()
   â”œâ”€ åˆ›å»º ContextEngineeringEventBuilder
   â””â”€ å­˜å…¥ context_engineering_builders DashMap
   â†“
3. æ‰§è¡Œæ­¥éª¤å¾ªç¯
   â”œâ”€ æ­¥éª¤æ‰§è¡ŒæˆåŠŸ
   â”‚  â””â”€ builder.add_successful_step()
   â”‚     â”œâ”€ step_id, step_name, step_description
   â”‚     â”œâ”€ tool_id, tool_parameters (JSON)
   â”‚     â”œâ”€ tool_output
   â”‚     â”œâ”€ dependencies
   â”‚     â””â”€ extracted_fields (å¯é€‰)
   â”‚
   â””â”€ æ­¥éª¤æ‰§è¡Œå¤±è´¥
      â””â”€ builder.add_failed_step()
         â”œâ”€ step_id, step_name, step_description
         â”œâ”€ tool_id, tool_parameters (JSON)
         â”œâ”€ error_message
         â”œâ”€ reflection_and_action (åŒ…å«åˆ†æ)
         â””â”€ dependencies
   â†“
4. ä»»åŠ¡å®Œæˆ (æˆåŠŸæˆ–å¤±è´¥)
   â†“
5. send_context_engineering_event()
   â”œâ”€ æ£€æŸ¥ config.debug.save_context_engineering_event
   â”‚  â”œâ”€ true: è°ƒç”¨ format_to_file() å†™å…¥æ–‡ä»¶
   â”‚  â””â”€ false: è·³è¿‡æ–‡ä»¶å†™å…¥
   â”‚
   â”œâ”€ builder.build() â†’ ContextEngineeringEvent
   â”‚
   â””â”€ event_sender.send_context_engineering_event(event)
      â””â”€ StreamEventSender (gRPC)
         â””â”€ å‘é€ TaskExecutionEvent
            â””â”€â”€ event_type: EVENT_TYPE_CONTEXT_ENGINEERING
            â””â”€â”€ event_data: ContextEngineeringEvent
   â†“
6. å®¢æˆ·ç«¯æ¥æ”¶äº‹ä»¶
```

---

## ä¹ã€å®ç°è¦ç‚¹

### 9.1 çº¿ç¨‹å®‰å…¨

ä½¿ç”¨ `Arc<DashMap<String, RwLock<ContextEngineeringEventBuilder>>>` å­˜å‚¨æ¯ä¸ªä»»åŠ¡çš„ Builder:
```rust
pub struct Orchestrator {
    // ... ç°æœ‰å­—æ®µ

    /// ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶æ„å»ºå™¨æ˜ å°„ (task_id -> Builder)
    context_engineering_builders: Arc<DashMap<String, RwLock<ContextEngineeringEventBuilder>>>,
}
```

### 9.2 ä¾èµ–å…³ç³»æå–

ä» `PlanStep` ä¸­æå–ä¾èµ–å…³ç³»:
```rust
fn extract_dependencies(step: &PlanStep) -> Vec<String> {
    step.actions
        .iter()
        .flat_map(|action| action.depends_on.clone())
        .collect::<HashSet<_>>()
        .into_iter()
        .collect()
}
```

### 9.3 å‚æ•°å’Œè¾“å‡ºæ ¼å¼åŒ–

- **å·¥å…·å‚æ•°**: å°† HashMap åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²
- **å·¥å…·è¾“å‡º**: ç›´æ¥ä½¿ç”¨åŸå§‹å­—ç¬¦ä¸²,å¦‚éœ€æˆªæ–­åœ¨å‰ç«¯å¤„ç†
- **é”™è¯¯ä¿¡æ¯**: ä¿ç•™å®Œæ•´çš„é”™è¯¯å †æ ˆ

---

## åã€å…³é”®ç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| å¹¶å‘æ”¯æŒ | ä½¿ç”¨ `Arc<DashMap<String, RwLock<...>>>` æ”¯æŒå¤šä¸ªå¹¶å‘ä»»åŠ¡ |
| å¼‚æ­¥å‘é€ | ä½¿ç”¨ `tokio::spawn()` å¼‚æ­¥å‘é€äº‹ä»¶ï¼Œä¸é˜»å¡ä¸»æµç¨‹ |
| é…ç½®æ§åˆ¶ | é€šè¿‡ `DebugConfig` æ§åˆ¶æ˜¯å¦å†™å…¥éªŒè¯æ–‡ä»¶ |
| å®Œæ•´è¿½è¸ª | è®°å½•æˆåŠŸå’Œå¤±è´¥æ­¥éª¤çš„å®Œæ•´ä¿¡æ¯ï¼ŒåŒ…å«åæ€åˆ†æ |
| æµå¼ä¼ è¾“ | é€šè¿‡ gRPC æµå¼äº‹ä»¶æœºåˆ¶å‘é€ç»™å®¢æˆ·ç«¯ |
| è‡ªåŠ¨æ¸…ç† | ä»»åŠ¡å®Œæˆåä» DashMap ä¸­ç§»é™¤ Builderï¼Œé¿å…å†…å­˜æ³„æ¼ |

---

## åä¸€ã€StepExecutionä¸­çš„ç›¸å…³å­—æ®µ

**æ–‡ä»¶**: `src/state/task_state.rs` (ç¬¬36-58è¡Œ)

```rust
pub struct StepExecution {
    pub step_id: String,
    pub step_name: String,
    pub tool_id: String,
    pub parameters: HashMap<String, String>,
    pub started_at: Option<DateTime<Utc>>,
    pub completed_at: Option<DateTime<Utc>>,
    pub result: Option<String>,
    pub is_success: bool,
    pub error_message: Option<String>,
    pub reflection_and_action: Option<String>,  // å…³é”®å­—æ®µï¼šåæ€ä¿¡æ¯
}
```

---

## åäºŒã€æµ‹è¯•æ–¹æ¡ˆ

### 12.1 å•å…ƒæµ‹è¯•

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_builder_successful_step() {
        let mut builder = ContextEngineeringEventBuilder::new("æµ‹è¯•ä»»åŠ¡".to_string());

        builder.add_successful_step(
            "step1".to_string(),
            "æŸ¥è¯¢æ•°æ®".to_string(),
            "æŸ¥è¯¢ç”¨æˆ·æ•°æ®".to_string(),
            "db_query".to_string(),
            r#"{"query": "SELECT * FROM users"}"#.to_string(),
            "è¿”å›100æ¡è®°å½•".to_string(),
            vec![],
            HashMap::new(),
        );

        assert_eq!(builder.successful_steps.len(), 1);
    }

    #[test]
    fn test_builder_failed_step() {
        let mut builder = ContextEngineeringEventBuilder::new("æµ‹è¯•ä»»åŠ¡".to_string());

        builder.add_failed_step(
            "step2".to_string(),
            "æ–‡ä»¶å†™å…¥".to_string(),
            "å†™å…¥ç»“æœåˆ°æ–‡ä»¶".to_string(),
            "file_write".to_string(),
            r#"{"path": "/tmp/test.txt"}"#.to_string(),
            "æƒé™ä¸è¶³".to_string(),
            "éœ€è¦æ£€æŸ¥æ–‡ä»¶æƒé™".to_string(),
            vec!["step1".to_string()],
        );

        assert_eq!(builder.failed_steps.len(), 1);
    }

    #[test]
    fn test_format_to_file() {
        let mut builder = ContextEngineeringEventBuilder::new("æ ¼å¼åŒ–æµ‹è¯•".to_string());
        builder.add_successful_step(/* ... */);

        let formatted = builder.format_to_file();
        assert!(formatted.contains("ä»»åŠ¡æè¿°: æ ¼å¼åŒ–æµ‹è¯•"));
        assert!(formatted.contains("æˆåŠŸæ­¥éª¤"));
    }
}
```

### 12.2 é›†æˆæµ‹è¯•

ä½¿ç”¨ `examples/context_engineering_test.rs` è¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•:

1. æäº¤åŒ…å«å¤šæ­¥éª¤çš„ä»»åŠ¡
2. ç›‘å¬æµå¼äº‹ä»¶
3. éªŒè¯æ”¶åˆ° `ContextEngineeringEvent`
4. æ£€æŸ¥æˆåŠŸå’Œå¤±è´¥æ­¥éª¤çš„å®Œæ•´æ€§
5. éªŒè¯æ–‡ä»¶å†™å…¥å†…å®¹

### 12.3 è¿è¡Œæµ‹è¯•

```bash
cargo run --release --example context_engineering_test
```

---

## åä¸‰ã€è¾“å‡ºç¤ºä¾‹

`context_engineering_events.txt` æ–‡ä»¶å†…å®¹ç¤ºä¾‹:

```
=== ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶ ===

ä»»åŠ¡æè¿°: æŸ¥è¯¢åŒ—äº¬å¤©æ°”

--- æˆåŠŸæ­¥éª¤ ---

[æ­¥éª¤ 1] è·å–åŸå¸‚ä¿¡æ¯
  ID: step_1_exec_1
  æè¿°: è·å–åŒ—äº¬çš„åŸå¸‚ä»£ç 
  å·¥å…·: city_lookup
  å‚æ•°: {"city": "åŒ—äº¬"}
  è¾“å‡º: {"code": "101010100", "name": "åŒ—äº¬"}
  ä¾èµ–: []

[æ­¥éª¤ 2] æŸ¥è¯¢å¤©æ°”
  ID: step_2_exec_1
  æè¿°: æ ¹æ®åŸå¸‚ä»£ç æŸ¥è¯¢å¤©æ°”
  å·¥å…·: weather_query
  å‚æ•°: {"city_code": "101010100"}
  è¾“å‡º: {"temp": "25Â°C", "weather": "æ™´"}
  ä¾èµ–: ["step_1"]

--- å¤±è´¥æ­¥éª¤ ---

(æ— å¤±è´¥æ­¥éª¤)
```

---

## åå››ã€æ½œåœ¨é£é™©å’Œè§£å†³æ–¹æ¡ˆ

| é£é™© | å½±å“ | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| Proto ç”Ÿæˆä»£ç å†²çª | ç¼–è¯‘å¤±è´¥ | ä»”ç»†é€‰æ‹©å­—æ®µç¼–å·,é¿å…ä¸ç°æœ‰å­—æ®µå†²çª |
| å¹¶è¡Œæ­¥éª¤æ”¶é›†é¡ºåºæ··ä¹± | æ­¥éª¤é¡ºåºä¸æ­£ç¡® | ä½¿ç”¨ Mutex ä¿æŠ¤ Builder,æˆ–åœ¨æ”¶é›†æ—¶è®°å½•æ—¶é—´æˆ³æ’åº |
| å¤§é‡æ­¥éª¤å¯¼è‡´æ¶ˆæ¯è¿‡å¤§ | gRPC ä¼ è¾“å¤±è´¥ | è®¾ç½®åˆç†çš„æ¶ˆæ¯å¤§å°é™åˆ¶,å¿…è¦æ—¶åˆ†æ‰¹å‘é€ |
| æ–‡ä»¶å†™å…¥å¤±è´¥ | å½±å“äº‹ä»¶å‘é€ | æ–‡ä»¶å†™å…¥å¤±è´¥ä¸åº”é˜»æ­¢äº‹ä»¶å‘é€,ä»…è®°å½•é”™è¯¯æ—¥å¿— |
| Builder å†…å­˜æ³„æ¼ | é•¿æœŸè¿è¡Œå†…å­˜å¢é•¿ | ç¡®ä¿ä»»åŠ¡å®Œæˆåä» DashMap æ¸…ç† Builder |

---

## åäº”ã€åç»­ä¼˜åŒ–æ–¹å‘

1. **å­—æ®µæå–æ™ºèƒ½åŒ–**: ä½¿ç”¨ LLM è‡ªåŠ¨æå–æ­¥éª¤è¾“å‡ºä¸­çš„å…³é”®å­—æ®µ
2. **äº‹ä»¶å‹ç¼©**: å¯¹äºå¤§é‡æ­¥éª¤çš„ä»»åŠ¡,æ”¯æŒå‹ç¼©ä¼ è¾“
3. **å†å²æŸ¥è¯¢**: æ”¯æŒæŸ¥è¯¢å†å²ä»»åŠ¡çš„ä¸Šä¸‹æ–‡å·¥ç¨‹äº‹ä»¶
4. **å¯è§†åŒ–**: å¼€å‘å‰ç«¯ç•Œé¢å±•ç¤ºæ­¥éª¤ä¾èµ–å…³ç³»å›¾
5. **ç»Ÿè®¡åˆ†æ**: åˆ†ææ­¥éª¤æˆåŠŸç‡ã€å¸¸è§å¤±è´¥åŸå› ç­‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0 (åˆå¹¶ç‰ˆ)
**æ›´æ–°æ—¥æœŸ**: 2026-01-05
