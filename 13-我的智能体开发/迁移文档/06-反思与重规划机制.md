# 06 - åæ€ä¸é‡è§„åˆ’æœºåˆ¶

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.2
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-05
> **æ›´æ–°æ—¥æœŸ**: 2026-01-14
> **è¿ç§»ä¼˜å…ˆçº§**: â­â­â­â­ (é«˜)

---

## 1. æœºåˆ¶æ¦‚è¿°

åæ€ä¸é‡è§„åˆ’æœºåˆ¶æ˜¯ä»»åŠ¡ç¼–æ’æœåŠ¡çš„è‡ªæ„ˆèƒ½åŠ›æ ¸å¿ƒï¼Œå®ç°äº†å¤šå±‚æ¬¡çš„æ™ºèƒ½é”™è¯¯å¤„ç†å’Œè‡ªåŠ¨æ¢å¤ã€‚

### 1.1 æ ¸å¿ƒèƒ½åŠ›

- **å¤±è´¥æ£€æµ‹**: å®æ—¶æ£€æµ‹æ­¥éª¤æ‰§è¡Œå¤±è´¥
- **åŸå› åˆ†æ**: LLMåˆ†æå¤±è´¥æ ¹æœ¬åŸå› 
- **åˆ†å±‚æ¢å¤**: ä»ç®€å•åˆ°å¤æ‚çš„æ¢å¤ç­–ç•¥
- **æ™ºèƒ½é‡è§„åˆ’**: åŸºäºåæ€ç»“æœç”Ÿæˆæ–°è®¡åˆ’
- **ğŸ†• æ™ºèƒ½è½®æ•°ç®¡ç†**: ç”±å¤§æ¨¡å‹å†³å®šä½•æ—¶åœæ­¢åæ€ï¼ˆv1.1 æ–°å¢ï¼‰
- **ğŸ†• å•æ­¥åæ€è§¦å‘æ•´ä½“åæ€**: å•æ­¥åæ€ä¸å†ç›´æ¥åœæ­¢ä»»åŠ¡ï¼Œè€Œæ˜¯è§¦å‘æ•´ä½“åæ€å†³ç­–ï¼ˆv1.2 æ–°å¢ï¼‰
- **ğŸ†• ç»†ç²’åº¦é‡è§„åˆ’ç­–ç•¥**: æ•´ä½“åæ€å¯å»ºè®®å…·ä½“çš„é‡è§„åˆ’ç­–ç•¥ï¼ˆv1.2 æ–°å¢ï¼‰

---

## 2. ä¸‰å±‚æ¢å¤ç­–ç•¥

### 2.1 ç­–ç•¥å±‚æ¬¡å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¸‰å±‚æ¢å¤ç­–ç•¥                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ç¬¬1å±‚: æ­¥éª¤çº§é‡è¯• (Step-Level Retry)                         â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚ è§¦å‘æ¡ä»¶: æ­¥éª¤æ‰§è¡Œå¤±è´¥                                       â”‚   â”‚
â”‚  â”‚ é‡è¯•ä¸Šé™: 3æ¬¡ (å¯é…ç½®)                                       â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚ é‡è¯•ç­–ç•¥:                                                    â”‚   â”‚
â”‚  â”‚ â”œâ”€ è°ƒæ•´å‚æ•°é‡è¯• (RetryWithAdjustedParams)                   â”‚   â”‚
â”‚  â”‚ â”‚   - æ ¹æ®åæ€ç»“æœè°ƒæ•´å‚æ•°å€¼                                  â”‚   â”‚
â”‚  â”‚ â”‚   - é€‚ç”¨äº: å‚æ•°é”™è¯¯ã€æ ¼å¼é”™è¯¯                              â”‚   â”‚
â”‚  â”‚ â”‚                                                           â”‚   â”‚
â”‚  â”‚ â””â”€ å¤‡é€‰å·¥å…·é‡è¯• (RetryWithAlternativeTool)                  â”‚   â”‚
â”‚  â”‚     - ä½¿ç”¨åŠŸèƒ½ç›¸åŒçš„å¤‡é€‰å·¥å…·                                  â”‚   â”‚
â”‚  â”‚     - é€‚ç”¨äº: å·¥å…·ä¸å¯ç”¨ã€å·¥å…·é”™è¯¯                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                       â”‚
â”‚                            â–¼ é‡è¯•å¤±è´¥                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ç¬¬2å±‚: å•æ­¥ä¿®å¤ (Single-Step Repair)                         â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚ è§¦å‘æ¡ä»¶: ç¬¬1å±‚é‡è¯•è¾¾åˆ°ä¸Šé™                                   â”‚   â”‚
â”‚  â”‚ ä¿®å¤ä¸Šé™: 1æ¬¡ (å¯é…ç½®)                                       â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚ ä¿®å¤æ–¹å¼:                                                    â”‚   â”‚
â”‚  â”‚ â”œâ”€ è°ƒç”¨ Planner.replan_single_step()                        â”‚   â”‚
â”‚  â”‚ â”œâ”€ é‡æ–°è§„åˆ’å¤±è´¥çš„å•ä¸ªæ­¥éª¤                                    â”‚   â”‚
â”‚  â”‚ â”œâ”€ ä¿æŒå…¶ä»–æ­¥éª¤ä¸å˜                                         â”‚   â”‚
â”‚  â”‚ â””â”€ å¤ç”¨åŸè®¡åˆ’ä¸­å·²ç­›é€‰çš„å·¥å…·é›†                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                       â”‚
â”‚                            â–¼ ä¿®å¤å¤±è´¥                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ç¬¬3å±‚: ä»»åŠ¡çº§é‡è§„åˆ’ (Task-Level Replanning)                   â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚ è§¦å‘æ¡ä»¶: ç¬¬2å±‚ä¿®å¤è¾¾åˆ°ä¸Šé™                                   â”‚   â”‚
â”‚  â”‚ é‡è§„åˆ’ä¸Šé™: 1æ¬¡ (å¯é…ç½®)                                     â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚ é‡è§„åˆ’æ–¹å¼:                                                  â”‚   â”‚
â”‚  â”‚ â”œâ”€ è°ƒç”¨ Planner.replan_task()                               â”‚   â”‚
â”‚  â”‚ â”œâ”€ é‡æ–°æ‰§è¡Œä¸¤é˜¶æ®µè§„åˆ’ (å·¥å…·ç­›é€‰ + ä»»åŠ¡åˆ†è§£)                   â”‚   â”‚
â”‚  â”‚ â”œâ”€ ç”Ÿæˆå…¨æ–°æ‰§è¡Œè®¡åˆ’                                         â”‚   â”‚
â”‚  â”‚ â””â”€ å¯ä»¥å¼•ç”¨ä¹‹å‰æˆåŠŸæ­¥éª¤çš„è¾“å‡º                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                       â”‚
â”‚                            â–¼ é‡è§„åˆ’å¤±è´¥                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ä»»åŠ¡å¤±è´¥                                                     â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚ - è¿”å›è¯¦ç»†çš„å¤±è´¥åŸå›                                          â”‚   â”‚
â”‚  â”‚ - ä¿å­˜æ‰§è¡Œå†å²ä¾›åˆ†æ                                         â”‚   â”‚
â”‚  â”‚ - å‘é€å¤±è´¥äº‹ä»¶é€šçŸ¥                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å¤±è´¥è®¡æ•°å™¨

> **âš ï¸ é‡è¦æ›´æ–°ï¼ˆv1.1ï¼‰**: è½®æ•°é™åˆ¶å·²ç§»é™¤ï¼Œæ‰€æœ‰è®¡æ•°å™¨ä»…ç”¨äºç»Ÿè®¡å’Œå¤§æ¨¡å‹å‚è€ƒï¼Œä¸å†å¼ºåˆ¶é™åˆ¶æ‰§è¡Œã€‚

| è®¡æ•°å™¨ | ä½œç”¨ | é»˜è®¤ä¸Šé™ | é…ç½®é¡¹ | çŠ¶æ€ |
|--------|------|---------|--------|------|
| `step_retry_count` | å½“å‰æ­¥éª¤é‡è¯•æ¬¡æ•° | ~~3~~ `usize::MAX` | `reflection.max_step_retries` | âš ï¸ å·²å¼ƒç”¨ |
| `single_step_repair_count` | å•æ­¥ä¿®å¤æ¬¡æ•° | ~~1~~ `usize::MAX` | `reflection.max_single_step_repairs` | âš ï¸ å·²å¼ƒç”¨ |
| `task_replan_count` | ä»»åŠ¡é‡è§„åˆ’æ¬¡æ•° | ~~1~~ `usize::MAX` | `reflection.max_task_replanning_attempts` | âš ï¸ å·²å¼ƒç”¨ |
| `consecutive_failures` | è¿ç»­å¤±è´¥æ¬¡æ•° | ~~3~~ æ— é™åˆ¶ | - | âš ï¸ å·²å¼ƒç”¨ |
| `current_round` | å½“å‰åæ€è½®æ¬¡ | æ— é™åˆ¶ | - | âœ… ç”¨äºç»Ÿè®¡ |
| `total_step_retries` | ç´¯è®¡æ­¥éª¤é‡è¯• | æ— é™åˆ¶ | - | âœ… ç”¨äºç»Ÿè®¡ |
| `total_task_replans` | ç´¯è®¡ä»»åŠ¡é‡è§„åˆ’ | æ— é™åˆ¶ | - | âœ… ç”¨äºç»Ÿè®¡ |

---

## 3. Reflector (åæ€å™¨) å®ç°

### 3.1 æ ¸å¿ƒç»“æ„

```rust
pub struct Reflector {
    llm_client: UnifiedLlmClient,
    kafka_logger: Arc<KafkaLogger>,
}
```

### 3.2 å•æ­¥åæ€æ–¹æ³•

```rust
impl Reflector {
    /// å¯¹å•ä¸ªæ­¥éª¤è¿›è¡Œåæ€åˆ†æ
    pub async fn reflect_on_step(
        &self,
        step: &PlanStep,
        result: &StepExecutionResult,
        context: &ReflectionContext,
        task_type: Option<&str>,
    ) -> Result<StepReflection> {
        // 1. è·å–åœºæ™¯æŒ‡å¯¼
        let scene_guidance = SceneManager::new()
            .get_reflection_guidance(task_type);

        // 2. æ„å»ºåæ€æç¤ºè¯
        let (system_prompt, user_prompt) = ReflectionPromptBuilder::new()
            .build_reflection_prompt(
                &context.task_description,
                step,
                result,
                &context.successful_steps,
                task_type,
            );

        // 3. è°ƒç”¨LLMè¿›è¡Œåæ€
        let llm_response = self.llm_client
            .call(&system_prompt, &user_prompt)
            .await?;

        // 4. è§£æåæ€ç»“æœ
        let reflection = self.parse_reflection_response(&llm_response)?;

        // 5. è®°å½•æ—¥å¿—
        self.kafka_logger.log_reflection(&reflection).await;

        Ok(reflection)
    }

    /// è§£æLLMåæ€å“åº”
    fn parse_reflection_response(&self, response: &str) -> Result<StepReflection> {
        // æå–JSONéƒ¨åˆ†
        let json_str = self.extract_json(response)?;

        // è§£æä¸ºç»“æ„ä½“
        let raw: RawReflectionResponse = serde_json::from_str(&json_str)?;

        // è½¬æ¢ä¸ºStepReflection
        Ok(StepReflection {
            root_cause_category: self.parse_category(&raw.root_cause_category),
            root_cause: raw.root_cause,
            is_recoverable: raw.is_recoverable,
            confidence: raw.confidence,
            suggested_action: self.parse_action(&raw.suggested_action),
            adjusted_parameters: raw.adjusted_parameters,
            alternative_tool_id: raw.alternative_tool_id,
            improvement_suggestions: raw.improvement_suggestions,
        })
    }
}
```

### 3.3 åæ€ç»“æœç»“æ„

```rust
/// æ­¥éª¤åæ€ç»“æœ
pub struct StepReflection {
    /// æ ¹æœ¬åŸå› åˆ†ç±»
    pub root_cause_category: RootCauseCategory,

    /// å…·ä½“æ ¹æœ¬åŸå› æè¿°
    pub root_cause: String,

    /// æ˜¯å¦å¯æ¢å¤
    pub is_recoverable: bool,

    /// åˆ†æç½®ä¿¡åº¦ (0.0 - 1.0)
    pub confidence: f32,

    /// å»ºè®®çš„åç»­åŠ¨ä½œ
    pub suggested_action: ReflectionAction,

    /// è°ƒæ•´åçš„å‚æ•° (ç”¨äºå‚æ•°è°ƒæ•´é‡è¯•)
    pub adjusted_parameters: Option<HashMap<String, String>>,

    /// å¤‡é€‰å·¥å…·ID (ç”¨äºå·¥å…·æ›¿æ¢é‡è¯•)
    pub alternative_tool_id: Option<String>,

    /// æ”¹è¿›å»ºè®®åˆ—è¡¨
    pub improvement_suggestions: Vec<String>,
}

/// æ ¹æœ¬åŸå› åˆ†ç±»
#[derive(Debug, Clone, PartialEq)]
pub enum RootCauseCategory {
    ParameterError,      // å‚æ•°é”™è¯¯
    ToolError,           // å·¥å…·é”™è¯¯
    DependencyError,     // ä¾èµ–é”™è¯¯
    DecompositionError,  // åˆ†è§£é”™è¯¯
    ExternalError,       // å¤–éƒ¨é”™è¯¯
    Unknown,             // æœªçŸ¥é”™è¯¯
}

/// åæ€å»ºè®®åŠ¨ä½œ
#[derive(Debug, Clone, PartialEq)]
pub enum ReflectionAction {
    RetryWithAdjustedParams,  // è°ƒæ•´å‚æ•°é‡è¯•
    RetryWithAlternativeTool, // ä½¿ç”¨å¤‡é€‰å·¥å…·
    RepairSingleStep,         // ä¿®å¤å•ä¸ªæ­¥éª¤
    ReplanTask,               // é‡æ–°è§„åˆ’ä»»åŠ¡
    Abort,                    // ä¸­æ­¢ä»»åŠ¡
}
```

---

## 4. Orchestrator ä¸­çš„åæ€æµç¨‹

### 4.1 æ­¥éª¤çº§åæ€å¤„ç†

```rust
impl Orchestrator {
    /// å¤„ç†æ­¥éª¤æ‰§è¡Œå¤±è´¥
    async fn handle_step_failure(
        &self,
        step: &PlanStep,
        result: &StepExecutionResult,
        context: &mut ExecutionContext,
        counters: &mut FailureCounters,
        available_tools: &[ToolInfo],
        task_type: Option<&str>,
    ) -> Result<StepHandleResult> {
        // 1. è°ƒç”¨åæ€å™¨åˆ†æå¤±è´¥åŸå› 
        let reflection = self.reflector
            .reflect_on_step(step, result, &self.build_reflection_context(context), task_type)
            .await?;

        // 2. æ ¹æ®åæ€ç»“æœå†³å®šåŠ¨ä½œ
        match reflection.suggested_action {
            // è°ƒæ•´å‚æ•°é‡è¯•
            ReflectionAction::RetryWithAdjustedParams => {
                if counters.step_retry_count < self.max_step_retries {
                    counters.step_retry_count += 1;

                    // ä½¿ç”¨è°ƒæ•´åçš„å‚æ•°é‡è¯•
                    let retry_result = self.executor
                        .execute_single_step_with_overrides(
                            step,
                            reflection.adjusted_parameters.as_ref(),
                            context,
                            available_tools,
                        )
                        .await?;

                    if retry_result.is_success {
                        // åŒæ­¥è¾“å‡ºåˆ°metadata
                        self.sync_step_output_to_metadata(
                            &retry_result, context, available_tools
                        );
                        return Ok(StepHandleResult::Success(retry_result));
                    }
                }

                // é‡è¯•å¤±è´¥ï¼Œå°è¯•å•æ­¥ä¿®å¤
                self.try_single_step_repair(step, result, context, counters, available_tools, task_type).await
            }

            // å¤‡é€‰å·¥å…·é‡è¯•
            ReflectionAction::RetryWithAlternativeTool => {
                if counters.step_retry_count < self.max_step_retries {
                    if let Some(alt_tool_id) = &reflection.alternative_tool_id {
                        counters.step_retry_count += 1;

                        // ä½¿ç”¨å¤‡é€‰å·¥å…·é‡è¯•
                        let mut alt_step = step.clone();
                        alt_step.tool = alt_tool_id.clone();

                        let retry_result = self.executor
                            .execute_single_step(&alt_step, context, available_tools)
                            .await?;

                        if retry_result.is_success {
                            self.sync_step_output_to_metadata(
                                &retry_result, context, available_tools
                            );
                            return Ok(StepHandleResult::Success(retry_result));
                        }
                    }
                }

                self.try_single_step_repair(step, result, context, counters, available_tools, task_type).await
            }

            // ç›´æ¥è¿›å…¥å•æ­¥ä¿®å¤
            ReflectionAction::RepairSingleStep => {
                self.try_single_step_repair(step, result, context, counters, available_tools, task_type).await
            }

            // ç›´æ¥è¿›å…¥ä»»åŠ¡é‡è§„åˆ’
            ReflectionAction::ReplanTask => {
                self.try_task_replan(context, counters, task_type).await
            }

            // ä¸­æ­¢ä»»åŠ¡
            ReflectionAction::Abort => {
                Ok(StepHandleResult::Abort(reflection.root_cause))
            }
        }
    }
}
```

### 4.2 å•æ­¥ä¿®å¤å¤„ç†

```rust
impl Orchestrator {
    /// å°è¯•å•æ­¥ä¿®å¤
    async fn try_single_step_repair(
        &self,
        failed_step: &PlanStep,
        failed_result: &StepExecutionResult,
        context: &mut ExecutionContext,
        counters: &mut FailureCounters,
        available_tools: &[ToolInfo],
        task_type: Option<&str>,
    ) -> Result<StepHandleResult> {
        // æ£€æŸ¥ä¿®å¤æ¬¡æ•°é™åˆ¶
        if counters.single_step_repair_count >= self.max_single_step_repairs {
            return self.try_task_replan(context, counters, task_type).await;
        }

        counters.single_step_repair_count += 1;

        // è°ƒç”¨Plannerè¿›è¡Œå•æ­¥é‡æ–°è§„åˆ’
        let repaired_step = self.planner
            .replan_single_step(
                &failed_step.step_id,
                failed_step,
                &failed_result.error_message.as_deref().unwrap_or("unknown error"),
                available_tools,  // å¤ç”¨åŸå·¥å…·é›†
            )
            .await?;

        // æ‰§è¡Œä¿®å¤åçš„æ­¥éª¤
        let repair_result = self.executor
            .execute_single_step(&repaired_step, context, available_tools)
            .await?;

        if repair_result.is_success {
            self.sync_step_output_to_metadata(&repair_result, context, available_tools);
            Ok(StepHandleResult::Success(repair_result))
        } else {
            // ä¿®å¤å¤±è´¥ï¼Œå°è¯•ä»»åŠ¡é‡è§„åˆ’
            self.try_task_replan(context, counters, task_type).await
        }
    }
}
```

### 4.3 ä»»åŠ¡é‡è§„åˆ’å¤„ç†

```rust
impl Orchestrator {
    /// å°è¯•ä»»åŠ¡çº§é‡è§„åˆ’
    async fn try_task_replan(
        &self,
        context: &mut ExecutionContext,
        counters: &mut FailureCounters,
        task_type: Option<&str>,
    ) -> Result<StepHandleResult> {
        // æ£€æŸ¥é‡è§„åˆ’æ¬¡æ•°é™åˆ¶
        if counters.task_replan_count >= self.max_task_replanning_attempts {
            return Ok(StepHandleResult::Abort("è¾¾åˆ°æœ€å¤§é‡è§„åˆ’æ¬¡æ•°".to_string()));
        }

        counters.task_replan_count += 1;

        // æ„å»ºé‡è§„åˆ’ä¸Šä¸‹æ–‡
        let replanning_context = self.build_replanning_context(context);

        // è°ƒç”¨Plannerè¿›è¡Œä»»åŠ¡é‡è§„åˆ’
        let new_plan = self.planner
            .replan_task(
                &replanning_context.failure_summary,
                replanning_context.metadata,
            )
            .await?;

        // æ³¨æ„: ä¸æ¸…é™¤ExecutionContextï¼Œä¿ç•™å·²æˆåŠŸæ­¥éª¤çš„è¾“å‡º
        // context.clear() æ–¹æ³•å·²ä¿®æ”¹ä¸ºä¸æ¸…é™¤æ•°æ®

        Ok(StepHandleResult::Replan(new_plan))
    }
}
```

---

## 5. å•æ­¥ä¿®å¤ vs ä»»åŠ¡é‡è§„åˆ’

### 5.1 å¯¹æ¯”è¡¨

| ç‰¹æ€§ | å•æ­¥ä¿®å¤ | ä»»åŠ¡é‡è§„åˆ’ |
|------|---------|-----------|
| **è§¦å‘æ¡ä»¶** | ç¬¬1å±‚é‡è¯•å¤±è´¥ | å•æ­¥ä¿®å¤å¤±è´¥ |
| **ä¿®æ”¹èŒƒå›´** | åªä¿®æ”¹å¤±è´¥æ­¥éª¤ | ç”Ÿæˆå…¨æ–°è®¡åˆ’ |
| **å·¥å…·ç­›é€‰** | ä¸æ‰§è¡Œï¼Œå¤ç”¨åŸå·¥å…·é›† | é‡æ–°æ‰§è¡Œä¸¤é˜¶æ®µè§„åˆ’ |
| **ä¿ç•™æ•°æ®** | ä¿ç•™æ‰€æœ‰å†å²æ•°æ® | ä¿ç•™æ‰€æœ‰å†å²æ•°æ® |
| **é€‚ç”¨åœºæ™¯** | æ­¥éª¤è®¾è®¡é—®é¢˜ | æ•´ä½“è§„åˆ’é—®é¢˜ |
| **å¼€é”€** | è¾ƒå° | è¾ƒå¤§ |

### 5.2 å†³ç­–æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å•æ­¥ä¿®å¤ vs ä»»åŠ¡é‡è§„åˆ’ å†³ç­–                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  æ­¥éª¤å¤±è´¥                                                            â”‚
â”‚       â”‚                                                             â”‚
â”‚       â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ LLMåæ€åˆ†æ                                  â”‚                    â”‚
â”‚  â”‚ - è¯†åˆ«æ ¹æœ¬åŸå› ç±»å‹                           â”‚                    â”‚
â”‚  â”‚ - åˆ¤æ–­æ˜¯å¦å¯æ¢å¤                             â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                    â”‚                                                â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚       â”‚                         â”‚                                  â”‚
â”‚       â–¼                         â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ å±€éƒ¨é—®é¢˜    â”‚          â”‚ å…¨å±€é—®é¢˜    â”‚                          â”‚
â”‚  â”‚             â”‚          â”‚             â”‚                          â”‚
â”‚  â”‚ - å‚æ•°é”™è¯¯  â”‚          â”‚ - æ­¥éª¤ç¼ºå¤±  â”‚                          â”‚
â”‚  â”‚ - å·¥å…·é”™è¯¯  â”‚          â”‚ - é¡ºåºé”™è¯¯  â”‚                          â”‚
â”‚  â”‚ - å•ç‚¹å¤±è´¥  â”‚          â”‚ - ä¾èµ–æ–­è£‚  â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚         â”‚                        â”‚                                  â”‚
â”‚         â–¼                        â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ å•æ­¥ä¿®å¤    â”‚          â”‚ ä»»åŠ¡é‡è§„åˆ’  â”‚                          â”‚
â”‚  â”‚             â”‚          â”‚             â”‚                          â”‚
â”‚  â”‚ - ä¿®æ”¹å¤±è´¥  â”‚          â”‚ - é‡æ–°ç­›é€‰  â”‚                          â”‚
â”‚  â”‚   æ­¥éª¤      â”‚          â”‚   å·¥å…·      â”‚                          â”‚
â”‚  â”‚ - ä¿ç•™å…¶ä»–  â”‚          â”‚ - ç”Ÿæˆæ–°    â”‚                          â”‚
â”‚  â”‚   æ­¥éª¤      â”‚          â”‚   è®¡åˆ’      â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. æ•°æ®ä¿æŒæœºåˆ¶

### 6.1 é‡è§„åˆ’æ—¶çš„æ•°æ®å¤„ç†

```rust
// ExecutionContext::clear() çš„å…³é”®è®¾è®¡
pub fn clear(&self) {
    // é‡è¦: ä¸æ¸…é™¤ step_results å’Œ runtime_metadata
    // è¿™æ ·é‡è§„åˆ’åçš„æ–°æ­¥éª¤å¯ä»¥å¼•ç”¨ä¹‹å‰æˆåŠŸæ­¥éª¤çš„è¾“å‡º

    info!(
        "æ‰§è¡Œä¸Šä¸‹æ–‡é‡ç½®ï¼šä¿ç•™å·²æœ‰çš„æ­¥éª¤ç»“æœå’Œè¿è¡Œæ—¶å…ƒæ•°æ®"
    );

    // ä¸æ‰§è¡Œä»¥ä¸‹æ“ä½œ:
    // self.step_results.write().unwrap().clear();
    // self.runtime_metadata.write().unwrap().clear();
}
```

### 6.2 æ•°æ®å¼•ç”¨ç¤ºä¾‹

```
åŸè®¡åˆ’:
  step_1 (æˆåŠŸ) â†’ output: {data_id: "d1"}
  step_2 (æˆåŠŸ) â†’ output: {datasource_id: "ds1"}
  step_3 (å¤±è´¥) â†’ error: "å¤„ç†å¤±è´¥"
  step_4 (æœªæ‰§è¡Œ)

é‡è§„åˆ’å:
  step_3_new â†’ input: {{step_2.outputs.datasource_id}}  âœ… å¯ä»¥å¼•ç”¨
  step_4_new â†’ input: {{step_3_new.outputs.result}}
  step_5_new â†’ input: {{step_1.outputs.data_id}}        âœ… å¯ä»¥å¼•ç”¨
```

---

## 7. é…ç½®è¯´æ˜

### 7.1 é…ç½®æ–‡ä»¶

```toml
# config.toml

[reflection]
# æ˜¯å¦å¯ç”¨æ­¥éª¤çº§åæ€
enable_step_level_reflection = true

# æ¯ä¸ªæ­¥éª¤çš„æœ€å¤§é‡è¯•æ¬¡æ•°
max_step_retries = 3

# å•æ­¥ä¿®å¤çš„æœ€å¤§æ¬¡æ•°
max_single_step_repairs = 1

# ä»»åŠ¡é‡è§„åˆ’çš„æœ€å¤§æ¬¡æ•°
max_task_replanning_attempts = 1

# è¿ç»­å¤±è´¥é˜ˆå€¼ (è¾¾åˆ°åå¼ºåˆ¶è¿›å…¥é‡è§„åˆ’)
consecutive_failure_threshold = 3
```

### 7.2 é…ç½®åŠ è½½

```rust
#[derive(Debug, Clone, Deserialize)]
pub struct ReflectionConfig {
    #[serde(default = "default_enable_reflection")]
    pub enable_step_level_reflection: bool,

    #[serde(default = "default_max_step_retries")]
    pub max_step_retries: u32,

    #[serde(default = "default_max_single_step_repairs")]
    pub max_single_step_repairs: u32,

    #[serde(default = "default_max_task_replanning")]
    pub max_task_replanning_attempts: u32,
}

fn default_enable_reflection() -> bool { true }
fn default_max_step_retries() -> u32 { 3 }
fn default_max_single_step_repairs() -> u32 { 1 }
fn default_max_task_replanning() -> u32 { 1 }
```

---

## 8. æ™ºèƒ½è½®æ•°ç®¡ç† (v1.1 æ–°å¢)

### 8.1 è®¾è®¡ç†å¿µ

ä»äººä¸ºé™åˆ¶è½¬å‘æ™ºèƒ½å†³ç­–ï¼š

**ä¿®æ”¹å‰ï¼ˆv1.0ï¼‰**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åæ€å¾ªç¯ï¼ˆäººä¸ºé™åˆ¶ï¼‰                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æ£€æŸ¥è½®æ¬¡ â‰¥ max_rounds? â†’ å¼ºåˆ¶åœæ­¢ â”‚
â”‚ 2. æ£€æŸ¥è¿ç»­å¤±è´¥ â‰¥ 3? â†’ å¼ºåˆ¶åœæ­¢      â”‚
â”‚ 3. æ‰§è¡Œåæ€ â†’ è·å– should_replan     â”‚
â”‚ 4. should_replan && !è¾¾é™ â†’ ç»§ç»­     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¿®æ”¹åï¼ˆv1.1ï¼‰**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åæ€å¾ªç¯ï¼ˆæ™ºèƒ½å†³ç­–ï¼‰                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æ‰§è¡Œåæ€ â†’ è·å– should_replan     â”‚
â”‚ 2. should_replan = true â†’ ç»§ç»­       â”‚
â”‚ 3. should_replan = false â†’ åœæ­¢      â”‚
â”‚ 4. å¤§æ¨¡å‹åŸºäºç»Ÿè®¡ä¿¡æ¯è‡ªä¸»åˆ¤æ–­        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 æç¤ºè¯è½¯æ€§å¼•å¯¼

ä¸ºé¿å…å¤§æ¨¡å‹æ— é™åæ€ï¼Œæç¤ºè¯ä¸­åŠ å…¥**è½¯æ€§å¼•å¯¼**ï¼š

```
ğŸ“Š è½®æ¬¡å‚è€ƒæŒ‡å—ï¼ˆä»…ä¾›å‚è€ƒï¼Œæœ€ç»ˆç”±ä½ å†³å®šï¼‰ï¼š
   â€¢ 1-3 è½®ï¼šæ­£å¸¸èŒƒå›´ï¼Œå¯æ ¹æ®éœ€è¦ç»§ç»­ä¼˜åŒ–
   â€¢ 4-5 è½®ï¼šå»ºè®®å®¡è§†æ˜¯å¦æœ‰å®è´¨æ€§æ”¹è¿›ç©ºé—´
   â€¢ 6-10 è½®ï¼šâš ï¸ è¶…å‡ºå¸¸è§„èŒƒå›´ï¼Œè¯·è®¤çœŸè¯„ä¼°ç»§ç»­åæ€çš„ä»·å€¼
   â€¢ 10 è½®ä»¥ä¸Šï¼šğŸš¨ å¼ºçƒˆå»ºè®®åœæ­¢ï¼Œé™¤éæœ‰æ˜ç¡®çš„æ–°è§£å†³æ€è·¯

âš ï¸ é‡è¦æé†’ï¼š
   - æ˜¯å¦ç»§ç»­åæ€å®Œå…¨ç”±ä½ å†³å®šï¼Œæ²¡æœ‰å¼ºåˆ¶çš„è½®æ•°é™åˆ¶
   - ä½†è¯·æ³¨æ„ï¼šè¿ç»­å¤šè½®æœªèƒ½è§£å†³é—®é¢˜æ—¶ï¼Œç»§ç»­åæ€å¾€å¾€åªæ˜¯é‡å¤æ— æ•ˆå°è¯•
   - å½“ä½ å‘ç°æ— æ³•æä¾›æ–°è§è§£æ—¶ï¼Œåº”æœæ–­è®¾ç½® should_replan = false
```

### 8.3 æ‰§è¡Œç»Ÿè®¡æ‘˜è¦

æ‰§è¡Œå†å²æ–‡ä»¶ä¸­åŠ å…¥ç»Ÿè®¡æ‘˜è¦ï¼Œå¸®åŠ©å¤§æ¨¡å‹å†³ç­–ï¼š

```markdown
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š æ‰§è¡Œç»Ÿè®¡æ‘˜è¦
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  â€¢ å½“å‰åæ€è½®æ¬¡: ç¬¬ X è½®
  â€¢ ç´¯è®¡æ­¥éª¤é‡è¯•æ¬¡æ•°: X æ¬¡
  â€¢ ç´¯è®¡ä»»åŠ¡é‡è§„åˆ’æ¬¡æ•°: X æ¬¡
  â€¢ æˆåŠŸæ­¥éª¤æ•°: X
  â€¢ å¤±è´¥æ­¥éª¤æ•°: X
```

å¤§æ¨¡å‹å¯ä»¥æ ¹æ®è¿™äº›ç»Ÿè®¡ä¿¡æ¯åˆ¤æ–­ï¼š
- **é‡è¯•æ¬¡æ•°è¿‡å¤š** â†’ è€ƒè™‘æ›´æ¢æ–¹æ¡ˆ
- **é‡è§„åˆ’æ¬¡æ•°è¿‡å¤š** â†’ å¯èƒ½å­˜åœ¨æ ¹æœ¬æ€§é—®é¢˜
- **è½®æ¬¡è¿‡å¤šä½†æ— è¿›å±•** â†’ æœæ–­åœæ­¢

### 8.4 é…ç½®å˜æ›´

```rust
// src/config/mod.rs
pub struct ReflectionConfig {
    /// å·²å¼ƒç”¨ï¼Œä»…ä¿ç•™å‘åå…¼å®¹
    #[deprecated]
    pub max_step_retries: usize,  // é»˜è®¤: usize::MAX

    #[deprecated]
    pub max_task_replanning_attempts: usize,  // é»˜è®¤: usize::MAX

    /// æ˜¯å¦å¯ç”¨æ­¥éª¤çº§åæ€ï¼ˆä»ç„¶æœ‰æ•ˆï¼‰
    pub enable_step_level_reflection: bool,  // é»˜è®¤: true
}
```

---

## 9. è¿ç§»æ£€æŸ¥é¡¹

### 9.1 Reflector
- [ ] å®ç° `reflect_on_step()` æ–¹æ³•
- [ ] å®ç°åæ€æç¤ºè¯æ„å»º
- [ ] å®ç°å“åº”è§£æé€»è¾‘
- [ ] å®šä¹‰ `StepReflection` ç»“æ„
- [ ] å®šä¹‰ `RootCauseCategory` æšä¸¾
- [ ] å®šä¹‰ `ReflectionAction` æšä¸¾

### 9.2 Orchestratoråæ€æµç¨‹
- [ ] å®ç° `handle_step_failure()` æ–¹æ³•
- [ ] å®ç°å‚æ•°è°ƒæ•´é‡è¯•é€»è¾‘
- [ ] å®ç°å¤‡é€‰å·¥å…·é‡è¯•é€»è¾‘
- [ ] å®ç° `try_single_step_repair()` æ–¹æ³•
- [ ] å®ç° `try_task_replan()` æ–¹æ³•
- [ ] âš ï¸ ç§»é™¤å¤±è´¥è®¡æ•°å™¨ç¡¬é™åˆ¶ï¼ˆv1.1æ”¹åŠ¨ï¼‰
- [ ] âœ… å®ç°ç»Ÿè®¡ä¿¡æ¯æ”¶é›†ï¼ˆv1.1æ”¹åŠ¨ï¼‰

### 9.3 Planneré‡è§„åˆ’
- [ ] å®ç° `replan_single_step()` æ–¹æ³•
- [ ] å®ç° `replan_task()` æ–¹æ³•
- [ ] ç¡®ä¿å•æ­¥ä¿®å¤å¤ç”¨åŸå·¥å…·é›†
- [ ] ç¡®ä¿ä»»åŠ¡é‡è§„åˆ’æ‰§è¡Œä¸¤é˜¶æ®µæµç¨‹

### 9.4 æ™ºèƒ½è½®æ•°ç®¡ç†ï¼ˆv1.1æ–°å¢ï¼‰
- [ ] âœ… æ ‡è®°è½®æ•°é™åˆ¶é…ç½®ä¸ºdeprecated
- [ ] âœ… ç§»é™¤å¾ªç¯ä¸­çš„è½®æ•°æ£€æŸ¥
- [ ] âœ… åœ¨æç¤ºè¯ä¸­åŠ å…¥è½¯æ€§å¼•å¯¼
- [ ] âœ… å®ç°æ‰§è¡Œç»Ÿè®¡æ‘˜è¦
- [ ] âœ… æ›´æ–°ContextEngineeringEventBuilderç»“æ„

### 9.5 æ•°æ®ä¿æŒ
- [ ] ä¿®æ”¹ `ExecutionContext::clear()` ä¿ç•™å†å²æ•°æ®
- [ ] ç¡®ä¿é‡è¯•æˆåŠŸååŒæ­¥åˆ°metadata
- [ ] ç¡®ä¿é‡è§„åˆ’åå¯ä»¥å¼•ç”¨å†å²è¾“å‡º

---

## 10. å•æ­¥åæ€è§¦å‘æ•´ä½“åæ€ (v1.2 æ–°å¢)

### 10.1 è®¾è®¡å˜æ›´

**æ ¸å¿ƒç†å¿µ**ï¼šå•æ­¥åæ€ä¸å†ç›´æ¥åœæ­¢ä»»åŠ¡ï¼Œè€Œæ˜¯å°†å†³ç­–æƒäº¤ç»™æ•´ä½“åæ€ï¼Œè®©LLMåŸºäºå…¨å±€è§†è§’åšå‡ºæ›´æ˜æ™ºçš„å†³ç­–ã€‚

**ä¿®æ”¹å‰ï¼ˆv1.1ï¼‰**:
```
å•æ­¥åæ€å¤±è´¥ â†’ StopExecution â†’ ä»»åŠ¡ç›´æ¥åœæ­¢
```

**ä¿®æ”¹åï¼ˆv1.2ï¼‰**:
```
å•æ­¥åæ€è¾¾åˆ°é™åˆ¶ â†’ TriggerOverallReflection â†’ æ•´ä½“åæ€
                                                    â†“
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â†“                               â†“
                            should_replan=true              should_replan=false
                                    â†“                               â†“
                        é‡æ–°è§„åˆ’ï¼ˆå¸¦ç­–ç•¥å»ºè®®ï¼‰                   åœæ­¢ä»»åŠ¡
```

**æµç¨‹è¯¦è§£**ï¼š
1. å•æ­¥åæ€æ£€æµ‹åˆ°é—®é¢˜æ— æ³•é€šè¿‡ç®€å•é‡è¯•è§£å†³
2. è¿”å› `TriggerOverallReflection` åŠ¨ä½œï¼ˆæºå¸¦é—®é¢˜æ‘˜è¦ï¼‰
3. ç¼–æ’å™¨è§¦å‘æ•´ä½“åæ€ï¼Œåˆ†æå…¨å±€æ‰§è¡Œæƒ…å†µ
4. æ•´ä½“åæ€å†³å®šæ˜¯å¦å€¼å¾—é‡æ–°è§„åˆ’ï¼š
   - å¦‚æœæœ‰æ˜ç¡®æ”¹è¿›æ–¹æ¡ˆ â†’ `should_replan=true`ï¼Œè§¦å‘é‡æ–°è§„åˆ’
   - å¦‚æœé—®é¢˜æ— æ³•è§£å†³ â†’ `should_replan=false`ï¼Œåœæ­¢ä»»åŠ¡å¹¶è¿”å›ç”¨æˆ·

### 10.2 StepAction æšä¸¾å˜æ›´

```rust
// src/core/reflector.rs:52-63
pub enum StepAction {
    RetryWithAdjustedParams(HashMap<String, String>),
    RetryWithAlternativeTool(String),
    ReplanEntireTask,
    TriggerOverallReflection(String), // æ–°å¢ï¼šæºå¸¦æ‘˜è¦ä¿¡æ¯
    // StopExecution å·²ç§»é™¤
}
```

### 10.3 å¤„ç†æµç¨‹

å½“å•æ­¥åæ€è¿”å› `TriggerOverallReflection` æ—¶ï¼š

1. ç¼–æ’å™¨è®°å½•è§¦å‘äº‹ä»¶åˆ° Kafka
2. è°ƒç”¨æ•´ä½“åæ€è¿›è¡Œå…¨å±€åˆ†æ
3. æ ¹æ® `should_replan` å†³å®šï¼š
   - `true`: è§¦å‘é‡æ–°è§„åˆ’ï¼ˆå¯èƒ½å¸¦ç»†ç²’åº¦ç­–ç•¥ï¼‰
   - `false`: åœæ­¢ä»»åŠ¡å¹¶è¿”å›ç”¨æˆ·ä»‹å…¥é”™è¯¯

---

## 11. ç»†ç²’åº¦é‡è§„åˆ’ç­–ç•¥ (v1.2 æ–°å¢)

### 11.1 ReplanningStrategy æšä¸¾

```rust
// src/llm/replanning_prompts.rs:23-43
pub enum ReplanningStrategy {
    /// å®Œæ•´é‡æ–°è§„åˆ’æ•´ä¸ªä»»åŠ¡
    FullReplan,

    /// ä»æŒ‡å®šæ­¥éª¤å¼€å§‹é‡æ–°è§„åˆ’
    ReplanFromStep { step_id: String, reason: String },

    /// è·³è¿‡æŒ‡å®šçš„æ­¥éª¤
    SkipSteps { step_ids: Vec<String>, reason: String },

    /// æ·»åŠ è¡¥æ•‘æ­¥éª¤
    AddRemediationSteps { suggestions: Vec<String> },

    /// è°ƒæ•´æ­¥éª¤é—´ä¾èµ–å…³ç³»
    AdjustDependencies { adjustments: Vec<String> },
}
```

### 11.2 ç­–ç•¥è¯´æ˜

| ç­–ç•¥ | é€‚ç”¨åœºæ™¯ |
|------|---------|
| `FullReplan` | æ•´ä½“æ–¹æ¡ˆæœ‰æ ¹æœ¬æ€§é—®é¢˜ |
| `ReplanFromStep` | å‰é¢æ­¥éª¤æˆåŠŸï¼Œä»å¤±è´¥ç‚¹é‡æ–°è§„åˆ’ |
| `SkipSteps` | æŸäº›æ­¥éª¤è¢«è¯æ˜ä¸å¿…è¦ |
| `AddRemediationSteps` | éœ€è¦æ·»åŠ é¢å¤–æ­¥éª¤ä¿®å¤é—®é¢˜ |
| `AdjustDependencies` | æ­¥éª¤ä¾èµ–å…³ç³»éœ€è¦è°ƒæ•´ |

### 11.3 æ•´ä½“åæ€æŒ‡å¯¼ä¿¡æ¯ä¼ é€’

```rust
// src/llm/replanning_prompts.rs:45-57
pub struct OverallReflectionGuidance {
    pub root_causes: Vec<String>,
    pub incorrect_assumptions: Vec<String>,
    pub alternative_approaches: Vec<String>,
    pub lessons_learned: Vec<String>,
    pub replanning_strategy: Option<ReplanningStrategy>,
}
```

æ•´ä½“åæ€çš„æŒ‡å¯¼ä¿¡æ¯ä¼šä¼ é€’ç»™é‡æ–°è§„åˆ’é˜¶æ®µï¼Œé€šè¿‡ `format_overall_reflection_guidance()` æ–¹æ³•æ ¼å¼åŒ–ä¸ºæ–‡æœ¬ï¼Œæ’å…¥åˆ°é‡æ–°è§„åˆ’æç¤ºè¯ä¸­ã€‚

### 11.4 ä»£ç ä½ç½®æ˜ å°„

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œå· |
|------|------|------|
| StepAction æšä¸¾ | `src/core/reflector.rs` | 52-63 |
| ReplanningStrategy æšä¸¾ | `src/llm/replanning_prompts.rs` | 23-43 |
| OverallReflectionGuidance | `src/llm/replanning_prompts.rs` | 45-57 |
| ç­–ç•¥è§£æé€»è¾‘ | `src/core/reflector.rs` | 648-836 |
| ç¼–æ’å™¨å¤„ç† | `src/core/orchestrator.rs` | 2580-2673 |
| æŒ‡å¯¼ä¿¡æ¯ä¼ é€’ | `src/core/orchestrator.rs` | 2947-2958 |

---

## 12. è¿ç§»æ£€æŸ¥é¡¹ (v1.2 æ›´æ–°)

### 12.1 å•æ­¥åæ€è§¦å‘æ•´ä½“åæ€ï¼ˆv1.2æ–°å¢ï¼‰
- [ ] âœ… ç§»é™¤ `StepAction::StopExecution`
- [ ] âœ… æ–°å¢ `StepAction::TriggerOverallReflection`
- [ ] âœ… æ›´æ–°å•æ­¥åæ€æç¤ºè¯ï¼ˆstop â†’ trigger_overall_reflectionï¼‰
- [ ] âœ… ç¼–æ’å™¨å¤„ç† TriggerOverallReflection é€»è¾‘
- [ ] âœ… grpc/server.rs æ›´æ–°äº‹ä»¶å¤„ç†

### 12.2 ç»†ç²’åº¦é‡è§„åˆ’ç­–ç•¥ï¼ˆv1.2æ–°å¢ï¼‰
- [ ] âœ… å®šä¹‰ `ReplanningStrategy` æšä¸¾
- [ ] âœ… å®šä¹‰ `OverallReflectionGuidance` ç»“æ„
- [ ] âœ… ReflectionResult æ–°å¢ `replanning_strategy` å­—æ®µ
- [ ] âœ… å®ç°ç­–ç•¥è§£æé€»è¾‘ `parse_replanning_strategy()`
- [ ] âœ… æ•´ä½“åæ€æç¤ºè¯å¢åŠ ç­–ç•¥æŒ‡å¯¼
- [ ] âœ… å®ç° `format_overall_reflection_guidance()` æ–¹æ³•
- [ ] âœ… ç¼–æ’å™¨ä¼ é€’æŒ‡å¯¼ä¿¡æ¯åˆ°é‡æ–°è§„åˆ’

---

## ä¸‹ä¸€æ­¥

é˜…è¯» [07-å¹¶è¡Œæ‰§è¡Œæœºåˆ¶.md](./07-å¹¶è¡Œæ‰§è¡Œæœºåˆ¶.md) äº†è§£å¹¶è¡Œæ‰§è¡Œçš„è¯¦ç»†å®ç°ã€‚
