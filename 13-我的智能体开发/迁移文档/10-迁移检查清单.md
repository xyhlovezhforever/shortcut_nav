# 10-迁移检查清单

## 概述

本文档提供项目迁移的完整检查清单，确保在新环境中正确重建任务编排服务。

---

## 第一阶段：环境准备

### 1.1 开发工具安装

| 检查项 | 命令/操作 | 验证方式 |
|--------|----------|----------|
| Rust 工具链 | `curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs \| sh` | `rustc --version` |
| Cargo 包管理器 | 随 Rust 安装 | `cargo --version` |
| Protobuf 编译器 | `choco install protoc` (Windows) / `apt install protobuf-compiler` (Linux) | `protoc --version` |
| Git | 系统安装 | `git --version` |

### 1.2 项目目录结构创建

```
task-orchestration-service/
├── src/
│   ├── api/                    # REST API 处理器
│   │   ├── mod.rs
│   │   ├── handlers.rs
│   │   ├── models.rs
│   │   └── health.rs
│   ├── core/                   # 核心业务逻辑
│   │   ├── mod.rs
│   │   ├── orchestrator.rs     # 编排器
│   │   ├── planner.rs          # 规划器
│   │   ├── executor.rs         # 执行器
│   │   ├── evaluator.rs        # 评估器
│   │   ├── reflector.rs        # 反思器
│   │   ├── parallel_executor.rs # 并行执行器
│   │   └── parameter_resolver.rs # 参数解析器
│   ├── grpc/                   # gRPC 服务
│   │   ├── mod.rs
│   │   └── server.rs
│   ├── llm/                    # LLM 客户端
│   │   ├── mod.rs
│   │   ├── client.rs
│   │   └── prompts.rs
│   ├── tool/                   # 工具服务客户端
│   │   └── mod.rs
│   ├── config/                 # 配置模块
│   │   └── mod.rs
│   ├── state/                  # 状态管理
│   │   └── mod.rs
│   ├── consul/                 # Consul 集成
│   │   ├── mod.rs
│   │   ├── registry.rs
│   │   └── discovery.rs
│   ├── kafka/                  # Kafka 集成
│   │   └── mod.rs
│   ├── workflow/               # 工作流定义
│   │   └── mod.rs
│   ├── scene/                  # 场景管理
│   │   └── mod.rs
│   ├── utils/                  # 工具函数
│   │   └── mod.rs
│   ├── lib.rs                  # 库入口
│   ├── main.rs                 # HTTP 服务入口
│   └── main_grpc.rs            # gRPC 服务入口
├── proto/                      # Protocol Buffers 定义
│   ├── task_orchestrator_service.proto
│   ├── llm_service.proto
│   ├── tool_service.proto
│   ├── kafka_service.proto
│   └── database.proto
├── examples/                   # 示例代码
├── config.dev.toml            # 开发配置
├── config.prod.toml           # 生产配置
├── Cargo.toml                 # 项目依赖
└── build.rs                   # 构建脚本
```

---

## 第二阶段：依赖配置

### 2.1 Cargo.toml 配置检查

| 依赖类别 | 依赖项 | 版本 | 用途 |
|----------|--------|------|------|
| Web框架 | axum | 0.7 | HTTP 服务 |
| 异步运行时 | tokio | 1.35 (full) | 异步执行 |
| gRPC | tonic | 0.11 | gRPC 服务 |
| 序列化 | serde, serde_json | 1.0 | JSON 处理 |
| 配置 | config, toml | 0.14, 0.8 | 配置加载 |
| 日志 | tracing, tracing-subscriber | 0.1, 0.3 | 日志追踪 |
| 错误处理 | thiserror, anyhow | 1.0 | 错误类型 |
| 时间 | chrono | 0.4 | 时间处理 |
| UUID | uuid | 1.6 | ID 生成 |
| 并发 | dashmap, parking_lot | 5.5, 0.12 | 并发数据结构 |
| HTTP客户端 | reqwest | 0.11 | HTTP 请求 |
| Protobuf | prost, prost-types | 0.12 | Protobuf 支持 |
| 正则 | regex | 1.10 | 正则表达式 |
| Kafka (可选) | rdkafka | 0.36 | Kafka 客户端 |

### 2.2 build.rs 配置

```rust
fn main() -> Result<(), Box<dyn std::error::Error>> {
    tonic_build::configure()
        .build_server(true)
        .build_client(true)
        .compile(
            &[
                "proto/task_orchestrator_service.proto",
                "proto/llm_service.proto",
                "proto/tool_service.proto",
            ],
            &["proto"],
        )?;
    Ok(())
}
```

---

## 第三阶段：核心模块实现

### 3.1 核心模块检查清单

| 模块 | 文件 | 关键实现 | 状态 |
|------|------|----------|------|
| Orchestrator | `core/orchestrator.rs` | orchestrate_with_reflection, 事件发送 | [ ] |
| Planner | `core/planner.rs` | 两阶段规划, 步骤ID重编号 | [ ] |
| Executor | `core/executor.rs` | 步骤执行, actions并行, 超时控制 | [ ] |
| Evaluator | `core/evaluator.rs` | 多维度评估, 分数计算 | [ ] |
| Reflector | `core/reflector.rs` | 失败分析, 重规划建议 | [ ] |
| ParallelExecutor | `core/parallel_executor.rs` | DAG分析, 批次执行 | [ ] |
| ParameterResolver | `core/parameter_resolver.rs` | 占位符解析, 多格式支持 | [ ] |
| ExecutionContext | `core/mod.rs` | 三层数据存储 | [ ] |

### 3.2 关键 Trait 定义

```rust
// EventSender trait
#[async_trait]
pub trait EventSender: Send + Sync {
    async fn send_planning_started(&self) -> Result<()>;
    async fn send_plan_generated(&self, plan: &ExecutionPlan) -> Result<()>;
    async fn send_step_started(&self, step: &PlanStep) -> Result<()>;
    async fn send_step_completed(&self, result: &StepResult) -> Result<()>;
    async fn send_step_failed(&self, step: &PlanStep, error: &str) -> Result<()>;
    async fn send_evaluation_completed(&self, result: &EvaluationResult) -> Result<()>;
    async fn send_reflection_completed(&self, result: &ReflectionResult) -> Result<()>;
    async fn send_task_completed(&self, rounds: u32) -> Result<()>;
    async fn send_task_failed(&self, error: &str, rounds: u32) -> Result<()>;
    async fn send_llm_stream_chunk(&self, chunk: LlmStreamChunk) -> Result<()>;
    async fn send_task_wait(&self, phase: &str) -> Result<()>;
    async fn send_context_engineering_event(&self, event: ContextEngineeringEvent) -> Result<()>;
}
```

### 3.3 ExecutionContext 实现要点

```rust
pub struct ExecutionContext {
    // 三层数据存储
    pub initial_metadata: Arc<RwLock<HashMap<String, String>>>,   // 只读用户数据
    pub runtime_metadata: Arc<RwLock<HashMap<String, String>>>,   // 动态步骤输出
    pub step_results: Arc<RwLock<HashMap<String, StepExecutionResult>>>, // 完整步骤结果
}

impl ExecutionContext {
    // 关键方法
    pub fn sync_step_output_to_runtime_metadata(&self, step_id: &str);
    pub fn get_step_output(&self, step_id: &str) -> Option<String>;
    pub fn set_step_result(&self, result: StepExecutionResult);
    pub fn clear_step_results(&self);
}
```

---

## 第四阶段：提示词系统

### 4.1 提示词模块检查

| 阶段 | 提示词函数 | 关键内容 |
|------|-----------|----------|
| 工具筛选 | `build_tool_selection_prompt` | 任务描述 → 相关工具 |
| 任务规划 | `build_planning_prompt` | 工具列表 + 任务 → 执行计划 |
| 步骤级反思 | `build_step_reflection_prompt` | 失败步骤 → 修复方案 |
| 任务级反思 | `build_task_reflection_prompt` | 执行历史 → 重规划建议 |
| 评估 | `build_evaluation_prompt` | 执行结果 → 评分分析 |
| 意图提取 | `build_intent_extraction_prompt` | 任务描述 → 场景类型 |

### 4.2 场景管理实现

```rust
// SceneType 枚举
pub enum SceneType {
    DefaultTask,           // 默认任务
    ConfigManagement,      // 配置管理
    DigitalTwinCreation,   // 数字孪生创建
    DataQuery,             // 数据查询
    SystemMaintenance,     // 系统维护
}

// SceneGuidance 结构
pub struct SceneGuidance {
    pub scene_type: SceneType,
    pub tool_selection_guidance: String,
    pub planning_guidance: String,
    pub execution_guidance: String,
    pub evaluation_guidance: String,
    pub reflection_guidance: String,
    pub error_handling_guidance: String,
}
```

---

## 第五阶段：服务接口

### 5.1 gRPC 服务检查

| 服务方法 | Proto 定义 | 实现文件 |
|----------|-----------|----------|
| SubmitTask | `SubmitTaskRequest/Response` | `grpc/server.rs` |
| CancelTask | `CancelTaskRequest/Response` | `grpc/server.rs` |
| StreamTaskExecution | `StreamTaskExecutionRequest → stream TaskExecutionEvent` | `grpc/server.rs` |

### 5.2 REST API 检查

| 端点 | 方法 | Handler |
|------|------|---------|
| `/health` | GET | `health_check` |
| `/info` | GET | `service_info` |
| `/api/v1/tasks` | POST | `create_task` |
| `/api/v1/tasks/:task_id` | GET | `get_task_status` |
| `/api/v1/tasks/:task_id/result` | GET | `get_task_result` |

### 5.3 事件类型检查

| 事件类型 | Proto 消息 | 触发时机 |
|----------|-----------|----------|
| StatusUpdate | `TaskStatusUpdate` | 状态变更 |
| PlanGenerated | `PlanGenerated` | 规划完成 |
| StepStarted | `StepStarted` | 步骤开始 |
| StepCompleted | `StepCompleted` | 步骤完成 |
| StepFailed | `StepFailed` | 步骤失败 |
| EvaluationCompleted | `EvaluationCompleted` | 评估完成 |
| ReflectionCompleted | `ReflectionCompleted` | 反思完成 |
| TaskCompleted | `TaskCompleted` | 任务完成 |
| TaskFailed | `TaskFailed` | 任务失败 |
| LlmStreamChunk | `LlmStreamChunk` | LLM 流式响应 |
| ContextEngineeringEvent | `ContextEngineeringEvent` | 上下文工程事件 |

---

## 第六阶段：配置系统

### 6.1 配置文件检查

| 配置文件 | 用途 | 必需 |
|----------|------|------|
| `config.dev.toml` | 开发环境 | 是 |
| `config.prod.toml` | 生产环境 | 是 |
| `config.local.toml` | 本地测试 | 否 |

### 6.2 配置项检查清单

| 配置段 | 关键配置项 | 默认值 |
|--------|-----------|--------|
| `[server]` | host, port | 0.0.0.0, 8084 |
| `[llm]` | endpoint, default_model, timeout_secs | localhost:9000, qwen-plus, 120 |
| `[tool_service]` | endpoint, timeout_secs | localhost:8100, 60 |
| `[orchestrator]` | enable_parallel_execution, parallel_max_concurrent | true, 8 |
| `[reflection]` | enable_step_level_reflection, max_replanning_attempts | true, 3 |
| `[logging]` | level, format | info, text |
| `[consul]` | enabled, host, port | false, localhost, 8500 |
| `[kafka_service]` | enabled, brokers, topic | false, localhost:9092, task-audit-log |

---

## 第七阶段：并行执行

### 7.1 并行执行检查

| 功能点 | 实现位置 | 检查项 |
|--------|---------|--------|
| DAG 构建 | `parallel_executor.rs` | 依赖关系解析正确 |
| 拓扑排序 | `parallel_executor.rs` | Kahn 算法实现 |
| 批次执行 | `parallel_executor.rs` | 信号量控制并发 |
| Actions 并行 | `executor.rs` | 步骤内并行执行 |
| 占位符解析 | `parameter_resolver.rs` | 多占位符支持 |
| 步骤ID重编号 | `planner.rs` | 重规划时ID连续 |

### 7.2 并行配置验证

```toml
[orchestrator]
enable_parallel_execution = true
parallel_max_concurrent = 8
parallel_min_steps = 1
```

---

## 第八阶段：测试验证

### 8.1 单元测试

```bash
# 运行所有测试
cargo test

# 运行特定模块测试
cargo test core::
cargo test config::
```

### 8.2 集成测试

```bash
# 运行示例测试
cargo run --example universal_case_test
cargo run --example digital_twin_test
cargo run --example concurrent_batch_test
```

### 8.3 功能验证清单

| 功能 | 验证方法 | 预期结果 |
|------|---------|----------|
| 健康检查 | `GET /health` | 返回 healthy |
| 任务创建 | `POST /api/v1/tasks` | 返回 task_id |
| 任务查询 | `GET /api/v1/tasks/:id` | 返回任务状态 |
| 流式监控 | gRPC StreamTaskExecution | 收到执行事件流 |
| 并行执行 | 多步骤无依赖任务 | 并行执行日志 |
| 反思重规划 | 故意失败的任务 | 触发反思和重规划 |

---

## 第九阶段：部署上线

### 9.1 构建发布版本

```bash
# 发布构建
cargo build --release

# 启用 Kafka 的发布构建
cargo build --release --features kafka
```

### 9.2 部署检查

| 检查项 | 操作 |
|--------|------|
| 配置文件 | 确认 config.prod.toml 配置正确 |
| 环境变量 | 设置 APP_ENV=prod |
| 依赖服务 | 确认 LLM/Tool Service 可达 |
| Consul 注册 | 确认服务注册成功 |
| 健康检查 | 验证 /health 端点响应 |

### 9.3 启动命令

```bash
# 设置环境
export APP_ENV=prod

# 启动 HTTP 服务
./target/release/task-orchestration-service

# 启动 gRPC 服务
./target/release/task-orchestration-service-grpc
```

---

## 迁移完成确认

### 最终检查清单

- [ ] 项目目录结构完整
- [ ] Cargo.toml 依赖配置正确
- [ ] build.rs 正确生成 Protobuf 代码
- [ ] 核心模块全部实现
  - [ ] Orchestrator
  - [ ] Planner
  - [ ] Executor
  - [ ] Evaluator
  - [ ] Reflector
  - [ ] ParallelExecutor
  - [ ] ParameterResolver
  - [ ] ExecutionContext
- [ ] 提示词系统完整
- [ ] gRPC 服务正常
- [ ] REST API 正常
- [ ] 配置系统工作
- [ ] 并行执行功能正常
- [ ] 反思重规划功能正常
- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] 健康检查正常
- [ ] Consul 注册成功（如启用）
- [ ] Kafka 日志正常（如启用）

---

## 常见问题快速参考

| 问题 | 可能原因 | 解决方案 |
|------|---------|----------|
| 编译失败：protoc not found | Protobuf 未安装 | 安装 protoc |
| 运行时：LLM 调用超时 | timeout_secs 太小 | 增加 llm.timeout_secs |
| 运行时：工具调用失败 | Tool Service 不可达 | 检查 endpoint 配置 |
| 并行执行不工作 | 配置禁用 | 检查 enable_parallel_execution |
| 反思不触发 | 配置禁用 | 检查 enable_step_level_reflection |
| Consul 注册失败 | 网络问题 | 检查 consul.host 和 port |

---

## 文档索引

| 文档编号 | 文档名称 | 主要内容 |
|----------|---------|----------|
| 00 | 迁移文档索引 | 文档导航 |
| 01 | 项目概述与技术栈 | 项目定位、技术选型 |
| 02 | 核心架构设计 | 架构图、模块依赖 |
| 03 | 核心模块实现详解 | 各模块详细实现 |
| 04 | 数据流转与参数解析 | 三层数据、占位符解析 |
| 05 | LLM交互与提示词系统 | 提示词设计、场景管理 |
| 06 | 反思与重规划机制 | 三层恢复策略 |
| 07 | 并行执行机制 | DAG、批次执行、Actions并行 |
| 08 | API与服务接口 | REST API、gRPC 服务 |
| 09 | 配置与部署指南 | 配置说明、部署流程 |
| 10 | 迁移检查清单 | 本文档 |
